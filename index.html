<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=110 src="//music.163.com/outchain/player?type=0&id=120897804&auto=0&height=90"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-mac如何搭建Hexo博客" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/07/mac如何搭建Hexo博客/">mac如何搭建Hexo博客</a>
    </h1>
  

        
        <a href="/2019/10/07/mac如何搭建Hexo博客/" class="archive-article-date">
  	<time datetime="2019-10-06T17:11:35.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2019-10-07</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、Hexo搭建"><a href="#1、Hexo搭建" class="headerlink" title="1、Hexo搭建"></a>1、Hexo搭建</h2><p><img src="/pictures/2017_1_7/hexo_xmind.jpg" alt=""></p>
<p>####环境<br>一、环境安装</p>
<ol>
<li><p>node.js（在node.js官网中下载安装）node.js官网</p>
</li>
<li><p>git（OS系统中直接安装x-code就可以了）</p>
</li>
<li><p>hexo</p>
</li>
</ol>
<p>1）打开OS系统终端</p>
<p>2）输入安装hexo的代码(此处安装时有可能会提示输入系统管理员密码)</p>
<p>$ sudo npm install -g hexo<br>二、hexo创建静态博客</p>
<ol>
<li><p>新建blog文件夹</p>
</li>
<li><p>在终端进入该文件夹，初始化博客</p>
</li>
</ol>
<p>$ hexo init</p>
<ol>
<li>上述完成后，生成原始文件；blog文件夹就是博客的根目录</li>
</ol>
<ol>
<li>本地查看：启用本地服务命令(退出按ctrl+c)</li>
</ol>
<p>$ hexo s</p>
<ol>
<li>将出现的地址输入浏览器，即可可查看到本地效果</li>
</ol>
<p>三、github配置</p>
<ol>
<li><p>注册github账号并登陆</p>
</li>
<li><p>获取本机的SSH口令</p>
</li>
</ol>
<p>1）输入获取代码，回车直到出现图片所示图形为止</p>
<p>$ ssh-keygen</p>
<p>2）输入编译代码</p>
<p>$ vim ~/.ssh/id_rsa.pub<br>3）出现SSH口令后，将红框部分复制，并在下方输入:q，随后按下回车可以退出该窗口</p>
<p>4）进入到github页面设置SSH口令</p>
<p>点击用户下拉菜单中的settings（step1)</p>
<p>点击左侧的SHH and GPG keys（step2)</p>
<p>在Title中输入口令名称（随意）（step3)</p>
<p>在key中贴上SSH口令（step4)</p>
<ol>
<li>创建新的仓库</li>
</ol>
<p>1）创建新的仓库（repOSitory）</p>
<p>点击用户左侧的+号菜单中的New repOSitory（step1)</p>
<p>在repOSitory name中输入二级域名，格式请严格遵照username.github.io（step2)</p>
<p>ps：username填写github的登录用户名，否则上线的时候会报错</p>
<p>是否公开选项可以选取Public（step3)</p>
<p>勾选step4处，会自动生成一份可编辑的README.md文件（建议勾选）（step4)</p>
<p>点击create repOSitory生成仓库完毕（step5)</p>
<p>2）查看新建的仓库（repOSitory）</p>
<p>可以回到github个人首页点击右侧的仓库区</p>
<p>进入后在step1处选择并复制http地址，注意此时step2处应该是空的</p>
<p>四、发布博客</p>
<ol>
<li>设置blog配置文件</li>
</ol>
<p>1）打开blog文件夹下的_config.yml文件</p>
<p>2）找到最下方的type，输入git（注意冒号后面是带空格的）</p>
<p>3）repo行可能没有，需要自己输入，后面跟上github上仓库中复制的http地址（注意此时1、2两处应该是一样的username），不然上传时会报错</p>
<p>4）其他博客设置</p>
<p>title：博客名称</p>
<p>subtitle：博客副标题</p>
<p>description：博客描述</p>
<p>author：作者</p>
<p>language：语言（简体中文是zh-CN）</p>
<ol>
<li>在终端上传博客</li>
</ol>
<p>1）进入终端，输入git上传插件安装代码（安装时会提示输入github用户名及密码）</p>
<p>  $ npm install hexo-deployer-git –save<br>2）安装完毕后，输入获取代码</p>
<p>  $ hexo g<br>3）最后输入上传代码</p>
<p>  $ hexo d<br>4）重新在github仓库查看上传文件，此时在step2中会有之前bolg中生成的文件</p>
<p>5）step3处就是你的博客地址</p>
<p>五、新建与更新博客</p>
<ol>
<li>新建博客</li>
</ol>
<p>1）终端bolg文件下，输入新建博客代码</p>
<pre><code>$ hexo new &apos;filename&apos;
</code></pre><p>2）此时在bolg/source/_posts/下面会看到新建的博客</p>
<p>3）博客文件的后缀是.md文件，OS下推荐使用MOU编辑器mou下载地址</p>
<ol>
<li>更新博客</li>
</ol>
<p>1）完成编辑后，在终端上依次重复以下代码（此时必须先将编辑器关闭，否则会出现获取错误）</p>
<pre><code>$ hexo g
$ hexo d
</code></pre><p>2）完成后便能刷新博客网页看到新更新的内容了</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Hexo</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2019/10/07/mac如何搭建Hexo博客/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-怎么在Hexo搭建GithubPage中加入百度云音乐" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/10/怎么在Hexo搭建GithubPage中加入百度云音乐/">怎么在Hexo搭建GithubPage中加入百度云音乐</a>
    </h1>
  

        
        <a href="/2017/01/10/怎么在Hexo搭建GithubPage中加入百度云音乐/" class="archive-article-date">
  	<time datetime="2017-01-10T12:45:40.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-01-10</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>###Yilia主题（我使用的是这个主题就用这个来讲）<br>进入网易云音乐: <a href="http://music.163.com/" target="_blank" rel="external">官网</a></p>
<p>推荐：自己注册账号，这样子可以创建自己喜欢的歌单，在里边收藏自己喜欢的歌曲</p>
<p><img src="/pictures/2017_1_10/yunmusic.png" alt=""></p>
<p>然后进入到自己的歌单</p>
<p><img src="/pictures/2017_1_10/yunmusiclist.png" alt=""></p>
<p>点击生成外链，获取到云音乐播放器代码</p>
<p><img src="/pictures/2017_1_10/yunmusicurl.png" alt=""></p>
<p>选择生成自己喜欢的样式，然后复制代码</p>
<p><img src="/pictures/2017_1_10/yunmusicplayer.png" alt=""></p>
<p>最后打开（themes/yilia/layout/_partial/left-col.ejs）<br>把复制好的网易云音乐放到第二行里边(当然这个是我的样式，我选择放在左边，你喜欢放在那里自己选择)</p>
<p><img src="/pictures/2017_1_10/playerlocation.png" alt=""></p>
<p>最后的效果图如下</p>
<p><img src="/pictures/2017_1_10/style.png" alt=""></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Hexo</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/10/怎么在Hexo搭建GithubPage中加入百度云音乐/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-windows10 使用Markdown Pad2不能预览" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="windows10-使用Markdown-Pad2不能预览"><a href="#windows10-使用Markdown-Pad2不能预览" class="headerlink" title="windows10 使用Markdown Pad2不能预览"></a>windows10 使用Markdown Pad2不能预览</h1><p>标签（空格分隔）： Markdown</p>
<hr>
<p>电脑升级到了Win10之后，在使用Warkdown写文章的时候右边的不能正确预览</p>
<p><img src="http://i1.piimg.com/567571/c1fe5e692bf3b9c6.png" alt=""></p>
<p>官方的说法是从 Win 8 开始就有这个问题了，解决办法就是安装 <a href="http://markdownpad.com/download/awesomium_v1.6.6_sdk_win.exe" target="_blank" rel="external">Awesomium 1.6.6 SDK</a>.，如果还是不行就再安装 <a href="http://www.microsoft.com/en-us/download/details.aspx?id=8109" target="_blank" rel="external">Microsoft’s DirectX End-User Runtimes (June 2010)</a>，经我实际测试，只需要安装前者就可以了。下面是官方的原文：</p>
<p>LivePreview is not working - it displays an error message stating This view has crashed!<br>This issue has been specifically observed in Windows 8. You may see an error message as shown here, and no HTML will be rendered when you type in the Markdown Editor pane.</p>
<p>To fix this issue, please try installing the Awesomium 1.6.6 SDK.</p>
<p><img src="http://i1.piimg.com/567571/654675a4c1b805b9.png" alt=""></p>
<p>If you continue to experience issues, please install Microsoft’s DirectX End-User Runtimes (June 2010).</p>
<p>Referer:MarkdownPad - Frequently Asked Questions</p>
<p>完成之后效果如下：</p>
<p><img src="http://p1.bqimg.com/567571/76bc858b346f8e85.png" alt=""></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/10/windows10 使用Markdown Pad2不能预览/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-深入了解java接口和抽象类" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/01/深入了解java接口和抽象类/">深入了解Java接口和抽象类</a>
    </h1>
  

        
        <a href="/2017/01/01/深入了解java接口和抽象类/" class="archive-article-date">
  	<time datetime="2016-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、抽象类"><a href="#一、抽象类" class="headerlink" title="一、抽象类"></a>一、抽象类</h2><p>　　在了解抽象类之前，先来了解一下抽象方法。抽象方法是一种特殊的方法：它只有声明，而没有具体的实现。抽象方法的声明格式为：<br>　　<br>　　<br><code>abstract void fun();</code></p>
<p>　　抽象方法必须用abstract关键字进行修饰。如果一个类含有抽象方法，则称这个类为抽象类，抽象类必须在类前用abstract关键字修饰。因为抽象类中含有无具体实现的方法，所以不能用抽象类创建对象。</p>
<p>　　下面要注意一个问题：在《JAVA编程思想》一书中，将抽象类定义为“包含抽象方法的类”，但是后面发现如果一个类不包含抽象方法，只是用abstract修饰的话也是抽象类。也就是说抽象类不一定必须含有抽象方法。个人觉得这个属于钻牛角尖的问题吧，因为如果一个抽象类不包含任何抽象方法，为何还要设计为抽象类？所以暂且记住这个概念吧，不必去深究为什么。<br>　　<br>　　<br><code>[public] abstract class ClassName {
    abstract void fun();
}</code></p>
<p>　　从这里可以看出，抽象类就是为了继承而存在的，如果你定义了一个抽象类，却不去继承它，那么等于白白创建了这个抽象类，因为你不能用它来做任何事情。对于一个父类，如果它的某个方法在父类中实现出来没有任何意义，必须根据子类的实际需求来进行不同的实现，那么就可以将这个方法声明为abstract方法，此时这个类也就成为abstract类了。</p>
<p>　　包含抽象方法的类称为抽象类，但并不意味着抽象类中只能有抽象方法，它和普通类一样，同样可以拥有成员变量和普通的成员方法。注意，抽象类和普通类的主要有三点区别：</p>
<p>　　1.抽象方法必须为public或者protected（因为如果为private，则不能被子类继承，子类便无法实现该方法），缺省情况下默认为public。</p>
<p>　　2.抽象类不能用来创建对象；</p>
<p>　　3.如果一个类继承于一个抽象类，则子类必须实现父类的抽象方法。如果子类没有实现父类的抽象方法，则必须将子类也定义为为abstract类。<br>　　在其他方面，抽象类和普通的类并没有区别。
　　</p>
<h2 id="二、接口"><a href="#二、接口" class="headerlink" title="二、接口"></a>二、接口</h2><p>　　接口，英文称作interface，在软件工程中，接口泛指供别人调用的方法或者函数。从这里，我们可以体会到Java语言设计者的初衷，它是对行为的抽象。在Java中，定一个接口的形式如下：
　　</p>
<p><code>[public] interface InterfaceName {
 //
}</code></p>
<p>　　接口中可以含有 变量和方法。但是要注意，接口中的变量会被隐式地指定为public static final变量（并且只能是public static final变量，用private修饰会报编译错误），而方法会被隐式地指定为public abstract方法且只能是public abstract方法（用其他关键字，比如private、protected、static、 final等修饰会报编译错误），并且接口中所有的方法不能有具体的实现，也就是说，接口中的方法必须都是抽象方法。从这里可以隐约看出接口和抽象类的区别，接口是一种极度抽象的类型，它比抽象类更加“抽象”，并且一般情况下不在接口中定义变量。</p>
<p>　　要让一个类遵循某组特地的接口需要使用implements关键字，具体格式如下：<br>　　<br><code>class ClassName implements Interface1,Interface2,[....]{
}</code></p>
<p>　　可以看出，允许一个类遵循多个特定的接口。如果一个非抽象类遵循了某个接口，就必须实现该接口中的所有方法。对于遵循某个接口的抽象类，可以不实现该接口中的抽象方法。</p>
<p>##三、抽象类和接口的区别<br>1.语法层面上的区别</p>
<p>　　1）抽象类可以提供成员方法的实现细节，而接口中只能存在public abstract 方法；</p>
<p>　　2）抽象类中的成员变量可以是各种类型的，而接口中的成员变量只能是public static final类型的；</p>
<p>　　3）接口中不能含有静态代码块以及静态方法，而抽象类可以有静态代码块和静态方法；</p>
<p>　　4）一个类只能继承一个抽象类，而一个类却可以实现多个接口。</p>
<p>2.设计层面上的区别</p>
<p>　　1）抽象类是对一种事物的抽象，即对类抽象，而接口是对行为的抽象。抽象类是对整个类整体进行抽象，包括属性、行为，但是接口却是对类局部（行为）进行抽象。举个简单的例子，飞机和鸟是不同类的事物，但是它们都有一个共性，就是都会飞。那么在设计的时候，可以将飞机设计为一个类Airplane，将鸟设计为一个类Bird，但是不能将 飞行 这个特性也设计为类，因此它只是一个行为特性，并不是对一类事物的抽象描述。此时可以将 飞行 设计为一个接口Fly，包含方法fly( )，然后Airplane和Bird分别根据自己的需要实现Fly这个接口。然后至于有不同种类的飞机，比如战斗机、民用飞机等直接继承Airplane即可，对于鸟也是类似的，不同种类的鸟直接继承Bird类即可。从这里可以看出，继承是一个 “是不是”的关系，而 接口 实现则是 “有没有”的关系。如果一个类继承了某个抽象类，则子类必定是抽象类的种类，而接口实现则是有没有、具备不具备的关系，比如鸟是否能飞（或者是否具备飞行这个特点），能飞行则可以实现这个接口，不能飞行就不实现这个接口。</p>
<p>　　2）设计层面不同，抽象类作为很多子类的父类，它是一种模板式设计。而接口是一种行为规范，它是一种辐射式设计。什么是模板式设计？最简单例子，大家都用过ppt里面的模板，如果用模板A设计了ppt B和ppt C，ppt B和ppt C公共的部分就是模板A了，如果它们的公共部分需要改动，则只需要改动模板A就可以了，不需要重新对ppt B和ppt C进行改动。而辐射式设计，比如某个电梯都装了某种报警器，一旦要更新报警器，就必须全部更新。也就是说对于抽象类，如果需要添加新的方法，可以直接在抽象类中添加具体的实现，子类可以不进行变更；而对于接口则不行，如果接口进行了变更，则所有实现这个接口的类都必须进行相应的改动。</p>
<p>　　下面看一个网上流传最广泛的例子：门和警报的例子：门都有open( )和close( )两个动作，此时我们可以定义通过抽象类和接口来定义这个抽象概念：</p>
<p><code>abstract class Door {
    public abstract void open();
    public abstract void close();
}</code></p>
<p>或者：</p>
<p><code>interface Door {
    public abstract void open();
    public abstract void close();
}</code></p>
<p>但是现在如果我们需要门具有报警alarm( )的功能，那么该如何实现？下面提供两种思路：</p>
<p>　　1）将这三个功能都放在抽象类里面，但是这样一来所有继承于这个抽象类的子类都具备了报警功能，但是有的门并不一定具备报警功能；</p>
<p>　　2）将这三个功能都放在接口里面，需要用到报警功能的类就需要实现这个接口中的open( )和close( )，也许这个类根本就不具备open( )和close( )这两个功能，比如火灾报警器。</p>
<p>　　从这里可以看出， Door的open() 、close()和alarm()根本就属于两个不同范畴内的行为，open()和close()属于门本身固有的行为特性，而alarm()属于延伸的附加行为。因此最好的解决办法是单独将报警设计为一个接口，包含alarm()行为,Door设计为单独的一个抽象类，包含open和close两种行为。再设计一个报警门继承Door类和实现Alarm接口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">interface Alram &#123;</div><div class="line">    void alarm();</div><div class="line">&#125;</div><div class="line"> </div><div class="line">abstract class Door &#123;</div><div class="line">    void open();</div><div class="line">    void close();</div><div class="line">&#125;</div><div class="line"> </div><div class="line">class AlarmDoor extends Door implements Alarm &#123;</div><div class="line">    void oepn() &#123;</div><div class="line">      //....</div><div class="line">    &#125;</div><div class="line">    void close() &#123;</div><div class="line">      //....</div><div class="line">    &#125;</div><div class="line">    void alarm() &#123;</div><div class="line">      //....</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>　</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/01/深入了解java接口和抽象类/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(下)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(下)/">RxJava详解(下)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(下)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:03.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-下"><a href="#RxJava详解-下" class="headerlink" title="RxJava详解(下)"></a>RxJava详解(下)</h1><h2 id="变换的原理lift"><a href="#变换的原理lift" class="headerlink" title="变换的原理lift()"></a>变换的原理<code>lift()</code></h2><p>这些变换虽然功能各有不同，但实质上都是针对事件序列的处理和再发送。而在<code>RxJava</code>的内部，它们是基于同一个基础的变换方法：<code>lift()</code>。</p>
<p>首先看一下<code>lift()</code> 的内部实现（仅核心代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意：这不是 lift() 的源码，而是将源码中与性能、兼容性、扩展性有关的代码剔除后的核心代码。</span></div><div class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">lift</span><span class="params">(Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> OnSubscribe&lt;R&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber subscriber)</span> </span>&#123;</div><div class="line">            Subscriber newSubscriber = operator.call(subscriber);</div><div class="line">            newSubscriber.onStart();</div><div class="line">            onSubscribe.call(newSubscriber);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码很有意思：它生成了一个新的<code>Observable</code>并返回，而且创建新<code>Observable</code>所用的参数<code>OnSubscribe的回调方法</code>call()<code>中的实现竟然看起来和前面讲过的</code>Observable.subscribe()<code>一样！然而它们并不一样哟~不一样的地方关键就在于第二行</code>onSubscribe.call(subscriber)<code>中的</code>onSubscribe` 所指代的对象不同（高能预警：接下来的几句话可能会导致身体的严重不适）</p>
<ul>
<li><code>subscribe()</code>中这句话的<code>onSubscribe</code>指的是<code>Observable</code>中的<code>onSubscribe</code>对象，这个没有问题，但是<code>lift()</code>之后的情况就复杂了点。</li>
<li>当含有<code>lift()</code>时： <ul>
<li><code>lift()</code>创建了一个<code>Observable</code>后，加上之前的原始<code>Observable</code>，已经有两个<code>Observable</code>了； </li>
<li>而同样地，新<code>Observable</code>里的新<code>OnSubscribe</code>加上之前的原始<code>Observable</code>中的原始<code>OnSubscribe</code>，也就有了两个<code>OnSubscribe</code>； </li>
<li>当用户调用经过<code>lift()</code>后的<code>Observable</code>的<code>subscribe()</code>的时候，使用的是<code>lift()</code>所返回的新的<code>Observable</code>，于是它所触发的<code>onSubscribe.call(subscriber)</code>，也是用的新<code>Observable</code>中的新<code>OnSubscribe</code>，即在<code>lift()</code>中生成的那个<code>OnSubscribe</code>； </li>
<li>而这个新<code>OnSubscribe</code>的<code>call()</code>方法中的<code>onSubscribe</code>，就是指的原始<code>Observable</code>中的原始<code>OnSubscribe</code>，在这个<code>call()</code>方法里，新<code>OnSubscribe</code>利用<code>operator.call(subscriber)</code>生成了一个新的<code>Subscriber</code>(<code>Operator</code>就是在这里，通过自己的<code>call()</code>方法将新<code>Subscriber</code>和原始<code>Subscriber</code> 进行关联，并插入自己的『变换』代码以实现变换），然后利用这个新<code>Subscriber</code>向原始<code>Observable</code>进行订阅。<br>这样就实现了<code>lift()</code>过程，有点像一种代理机制，通过事件拦截和处理实现事件序列的变换。</li>
</ul>
</li>
</ul>
<p>精简掉细节的话，也可以这么说：在<code>Observable</code>执行了<code>lift(Operator)</code>方法之后，会返回一个新的<code>Observable</code>，这个新的<code>Observable</code>会像一个代理一样，负责接收原始的<code>Observable</code> 发出的事件，并在处理后发送给<code>Subscriber</code>。</p>
<p>如果你更喜欢具象思维，可以看图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_lift.gif?raw=true" alt="image"></p>
<p>举一个具体的<code>Operator</code>的实现。下面这是一个将事件中的<code>Integer</code>对象转换成<code>String</code>的例子，仅供参考：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">observable.lift(<span class="keyword">new</span> Observable.Operator&lt;String, Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> Integer&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber) &#123;</div><div class="line">        <span class="comment">// 将事件序列中的 Integer 对象转换为 String 对象</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                subscriber.onNext(<span class="string">""</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                subscriber.onCompleted();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                subscriber.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>讲述<code>lift()</code>的原理只是为了让你更好地了解<code>RxJava</code> ，从而可以更好地使用它。然而不管你是否理解了<code>lift()</code>的原理,<code>RxJava</code>都不建议开发者自定义<code>Operator</code>来直接使用<code>lift()</code>，而是建议尽量使用已有的<code>lift()</code>包装方法（如<code>map()、flatMap()</code>等）进行组合来实现需求，因为直接使用<code>lift()</code>非常容易发生一些难以发现的错误。</p>
</blockquote>
<h2 id="线程控制Scheduler"><a href="#线程控制Scheduler" class="headerlink" title="线程控制Scheduler"></a>线程控制<code>Scheduler</code></h2><p>在不指定线程的情况下，<code>RxJava</code>遵循的是线程不变的原则，即在哪个线程调用<code>subscribe()</code>方法就在哪个线程生产事件；在哪个线程生产事件，就在哪个线程消费事件。也就是说事件的发出和消费都是在同一个线程的。观察者模式本身的目的就是『后台处理，前台回调』的异步机制，因此异步对于<code>RxJava</code>是至关重要的。而要实现异步，则需要用到<code>RxJava</code>的另一个概念：<code>Scheduler</code>。   </p>
<p>####<code>Scheduler</code>简介</p>
<p>在<code>RxJava</code>中,<code>Scheduler</code>相当于线程控制器，<code>RxJava</code>通过它来指定每一段代码应该运行在什么样的线程。<code>RxJava</code>已经内置了几个<code>Scheduler</code>，它们已经适合大多数的使用场景：</p>
<ul>
<li><code>Schedulers.immediate()</code>: 直接在当前线程运行，相当于不指定线程。这是默认的<code>Scheduler</code>。</li>
<li><code>Schedulers.newThread()</code>: 总是启用新线程，并在新线程执行操作。</li>
<li><code>Schedulers.io()</code>: I/O 操作（读写文件、读写数据库、网络信息交互等）所使用的<code>Scheduler</code>。行为模式和<code>newThread()</code>差不多，区别在于<code>io()</code> 的内部实现是是用一个无数量上限的线程池，可以重用空闲的线程，因此多数情况下<code>io()</code>比<code>newThread()</code>更有效率。不要把计算工作放在<code>io()</code>中，可以避免创建不必要的线程。</li>
<li><code>Schedulers.computation()</code>: 计算所使用的<code>Scheduler</code>。这个计算指的是<code>CPU</code>密集型计算，即不会被<code>I/O</code>等操作限制性能的操作，例如图形的计算。这个<code>Scheduler</code> 使用的固定的线程池，大小为<code>CPU</code>核数。不要把<code>I/O</code>操作放在<code>computation()</code>中，否则<code>I/O</code>操作的等待时间会浪费<code>CPU</code>。</li>
<li>另外，<code>Android</code>还有一个专用的<code>AndroidSchedulers.mainThread()</code>，它指定的操作将在<code>Android</code>主线程运行。</li>
</ul>
<p>有了这几个<code>Scheduler</code>，就可以使用<code>subscribeOn()</code>和<code>observeOn()</code>两个方法来对线程进行控制了。<code>subscribeOn()</code>指定<code>subscribe()</code>所发生的线程，即<code>Observable.OnSubscribe()</code>被激活时所处的线程或者叫做事件产生的线程。<code>observeOn()</code>指定<code>Subscriber</code>所运行在的线程或者叫做事件消费的线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>)</div><div class="line">        .subscribeOn(Schedulers.io()) <span class="comment">// 指定 subscribe() 发生在 IO 线程，可以理解成数据的获取是在io线程</span></div><div class="line">        .observeOn(AndroidSchedulers.mainThread())<span class="comment">// 指定 Subscriber 的回调发生在主线程，可以理解成数据的消费时在主线程</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">                Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>上面这段代码中，<code>subscribeOn(Schedulers.io())</code>的指定会让创建的事件的内容<code>Hello</code>、<code>World !</code>将会在<code>IO</code>线程发出；而由于<code>observeOn(AndroidScheculers.mainThread())</code> 的指定，因此<code>subscriber()</code>方法设置后的回调中内容的打印将发生在主线程中。事实上，这种在<code>subscribe()</code>之前写上两句<code>subscribeOn(Scheduler.io())</code>和<code>observeOn(AndroidSchedulers.mainThread())</code>的使用方式非常常见，它适用于多数的<strong><em>后台线程取数据，主线程显示</em></strong>的程序策略。</p>
<p>####<code>Scheduler</code>的原理</p>
<p><code>RxJava</code>的<code>Scheduler API</code>很方便，也很神奇（加了一句话就把线程切换了，怎么做到的？而且 subscribe() 不是最外层直接调用的方法吗，它竟然也能被指定线程？）。然而 Scheduler 的原理需要放在后面讲，因为它的原理是以下一节《变换》的原理作为基础的。</p>
<p>好吧这一节其实我屁也没说，只是为了让你安心，让你知道我不是忘了讲原理，而是把它放在了更合适的地方。</p>
<p>能不能多切换几次线程？答案是：能。因为<code>observeOn()</code>指定的是<code>Subscriber</code>的线程，而这个<code>Subscriber</code>并不是（严格说应该为『不一定是』，但这里不妨理解为『不是』）<code>subscribe()</code> 参数中的<code>Subscriber</code>，而是<code>observeOn()</code>执行时的当前<code>Observable</code>所对应的<code>Subscriber</code>，即它的直接下级<code>Subscriber</code>。换句话说<code>observeOn()</code> 指定的是它之后的操作所在的线程。因此如果有多次切换线程的需求，只要在每个想要切换线程的位置调用一次<code>observeOn()</code>即可。</p>
<p>上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>) <span class="comment">// IO 线程，由 subscribeOn() 指定</span></div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(Schedulers.newThread())</div><div class="line">    .map(mapOperator) <span class="comment">// 新线程，由 observeOn() 指定</span></div><div class="line">    .observeOn(Schedulers.io())</div><div class="line">    .map(mapOperator2) <span class="comment">// IO 线程，由 observeOn() 指定</span></div><div class="line">    .observeOn(AndroidSchedulers.mainThread) </div><div class="line">    .subscribe(subscriber);  <span class="comment">// Android 主线程，由 observeOn() 指定</span></div></pre></td></tr></table></figure>
<p>如上，通过<code>observeOn()</code>的多次调用，程序实现了线程的多次切换。<br>不过，不同于<code>observeOn()</code>,<code>subscribeOn()</code>的位置放在哪里都可以，但它是只能调用一次的。</p>
<p>其实，<code>subscribeOn()</code>和<code>observeOn()</code>的内部实现，也是用的<code>lift()</code>。</p>
<p>具体看图（不同颜色的箭头表示不同的线程,<code>subscribeOn()</code>原理图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_subscribeon.jpg?raw=true" alt="image"></p>
<p><code>observeOn()</code>原理图: </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observeon.jpg?raw=true" alt="image"></p>
<p>从图中可以看出,<code>subscribeOn()</code>和<code>observeOn()</code>都做了线程切换的工作（图中的<code>schedule...</code>部位）。不同的是,<code>subscribeOn()</code>的线程切换发生在<code>OnSubscribe</code>中，即在它通知上一级 <code>OnSubscribe</code>时，这时事件还没有开始发送，因此<code>subscribeOn()</code>的线程控制可以从事件发出的开端就造成影响；而<code>observeOn()</code>的线程切换则发生在它内建的<code>Subscriber</code>中，即发生在它即将给下一级<code>Subscriber</code>发送事件时，因此<code>observeOn()</code>控制的是它后面的线程。</p>
<p>最后，我用一张图来解释当多个<code>subscribeOn()</code>和<code>observeOn()</code>混合使用时，线程调度是怎么发生的（由于图中对象较多，相对于上面的图对结构做了一些简化调整）：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observable_list.jpg?raw=true" alt="image"></p>
<p>图中共有5处含有对事件的操作。由图中可以看出，①和②两处受第一个<code>subscribeOn()</code>影响，运行在红色线程；③和④处受第一个<code>observeOn()</code>的影响，运行在绿色线程；⑤处受第二个 <code>onserveOn()</code>影响，运行在紫色线程；而第二个<code>subscribeOn()</code>，由于在通知过程中线程就被第一个<code>subscribeOn()</code> 截断，因此对整个流程并没有任何影响。这里也就回答了前面的问题：当使用了多个<code>subscribeOn()</code>的时候，只有第一个<code>subscribeOn()</code>起作用。</p>
<p>在前面讲<code>Subscriber</code>的时候，提到过<code>Subscriber</code>的<code>onStart()</code>可以用作流程开始前的初始化。然而<code>onStart()</code>由于在<code>subscribe()</code>发生时就被调用了，因此不能指定线程，而是只能执行在<code>subscribe()</code>被调用时的线程。这就导致如果<code>onStart()</code>中含有对线程有要求的代码（例如在界面上显示一个<code>ProgressBar</code>，这必须在主线程执行），将会有线程非法的风险，因为有时你无法预测<code>subscribe()</code>将会在什么线程执行。</p>
<p>而与<code>Subscriber.onStart()</code>相对应的，有一个方法<code>Observable.doOnSubscribe()</code>。它和<code>Subscriber.onStart()</code>同样是在<code>subscribe()</code>调用后而且在事件发送前执行，但区别在于它可以指定线程。默认情况下,<code>doOnSubscribe()</code>执行在<code>subscribe()</code>发生的线程；而如果在<code>doOnSubscribe()</code>之后有<code>subscribeOn()</code>的话，它将执行在离它最近的<code>subscribeOn()</code>所指定的线程。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Observable.create(onSubscribe)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">            progressBar.setVisibility(View.VISIBLE); <span class="comment">// 需要在主线程执行</span></div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribeOn(AndroidSchedulers.mainThread()) <span class="comment">// 指定主线程</span></div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>如上，在<code>doOnSubscribe()</code>的后面跟一个<code>subscribeOn()</code>，就能指定准备工作的线程了。</p>
<p>####总结</p>
<p><code>RxJava</code>辣么好，难道他就没有缺点吗？当然有那就是使用越来越多的订阅，内存开销也会变得很大，稍不留神就会出现内存溢出的情况。我们可以用<code>RxJava</code>实现基本任何功能，但是你并不能这么做，你要明白什么时候需要用它，而什么时候没必要用它，不要一味的把功能都有<code>RxJava</code>来实现。    </p>
<p>至于上面提到的<code>2.0</code>版本，有关它的区别请见:<br><a href="https://github.com/ReactiveX/RxJava/wiki/What&#39;s-different-in-2.0">What’s different in 2.0</a></p>
<h2 id="Agera"><a href="#Agera" class="headerlink" title="Agera"></a>Agera</h2><p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/agera.png?raw=true" alt="image"></p>
<p>之前<code>Google</code>发布<code>agera</code>，它在<code>Github</code>上的介绍是:<code>Reactive Programming for Android</code></p>
<p><a href="https://github.com/google/agera">agera</a></p>
<p>既然是响应式编程框架，其核心思想肯定和<code>RxJava</code>也是类似的。<br><code>Agera</code>中核心也是关于事件流（数据流）的处理，可以转换数据、可以指定数据操作函数在那个线程执行。<br>而<code>Agera</code>和<code>RxJava</code>不一样的地方在于，<code>Agera</code>提供了一个新的事件响应和数据请求的模型，被称之为<code>Push event, pull data</code>。也就是一个事件发生了，会通过回调来主动告诉你，你关心的事件发生了。然后你需要主动的去获取数据，根据获取到的数据做一些操作。而<code>RxJava</code>在事件发生的时候，已经带有数据了。为了支持 <code>Push event pull data</code>模型，<code>Agera</code>中有个新的概念 — <code>Repository</code>。<code>Repository</code>翻译过来也就是数据仓库,是用来提供数据的,当你收到事件的时候,通过<code>Repository</code>来获取需要的数据。 这样做的好处是，把事件分发和数据处理的逻辑给分开了，事件分发做的事情比较少，事件分发就比较高效，当你收到事件后，根据当前的状态如果发现这个时候，数据已经无效了，则你根本不用请求数据，这样数据也就不用去处理和转换了。这样可以避免无用的数据计算，而有用的数据计算也可以在你需要的时候才去计算。<br>同样，在多线程环境下，使用<code>push event pull data</code>模型，可能当你收到事件通知的时候，你只能获取到最新的数据，无法去获取历史数据了。设计就是这样考虑的，因为在<code>Android</code>开发中大部分的数据都是用来更新<code>UI</code>的，这个时候你根本不需要旧的数据了，只要最新的就够了。</p>
<p><code>Agera</code>相对比较简单，并且是一个专业为<code>Android</code>平台打造的响应式编程框架。但是如果你熟悉了<code>RxJava</code>你会发现其用起来会有点不舒服，特别是还要主动的获取数据略感不爽（虽然提高了事件分发的效率）。 </p>
<p>总之，现在看来<code>RxJava</code>支持的比较全面，但是会略显笨重，而<code>Agera</code>是一个专门为<code>Android</code>平台设计的响应式编程框架，比较轻巧，当然支持的并不是很全面。可以根据自己的喜好来选择.</p>
<p>但是从个人观点来看<code>Agera</code>比起来<code>RxJava</code>还是相差几个版本。当然这是我的片面之词，有关更多信息请看<a href="https://github.com/google/agera/issues/20">Question: what’s the relation to RxJava?</a></p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(下)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(中)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(中)/">RxJava详解(中)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(中)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:01.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-中"><a href="#RxJava详解-中" class="headerlink" title="RxJava详解(中)"></a>RxJava详解(中)</h1><h2 id="说好的简洁呢？"><a href="#说好的简洁呢？" class="headerlink" title="说好的简洁呢？"></a>说好的简洁呢？</h2><p>上面这一部分，又是介绍、又是<code>Hello World</code>、又是数据变换，但是你会发现然而并没有什么卵用。说好的简洁一点也木有体现出来。    </p>
<p>下面我们会通过一个简单的例子来进行说明。现在我们有这样一个需求:    </p>
<blockquote>
<p>有一个服务提供了一些<code>API</code>来搜索整个网络上的符合查询关键字的所有猫的图片。 每个图片包含一个可爱程度的参数(一个整数值表示其可爱程度)。 我们的任务就是下载所有猫的列表并选择最可爱的那个，把它的图片保存到本地。</p>
</blockquote>
<p>####<code>Model</code>和<code>API</code></p>
<p>下面是猫的数据结构<code>Cat</code>:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Cat</span>&gt;</span>&#123;</div><div class="line">    Bitmap image;</div><div class="line">    <span class="keyword">int</span> cuteness;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Cat another)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Integer.compare(cuteness, another.cuteness);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的<code>API</code>会调用<code>cat-sdk.jar</code>中堵塞式的接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="function">List&lt;Cat&gt; <span class="title">queryCats</span><span class="params">(String query)</span></span>;</div><div class="line">    <span class="function">Uri <span class="title">store</span><span class="params">(Cat cat)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看起来很清晰吧？当然了，我们继续写客户端的业务逻辑.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">saveTheCutestCat</span><span class="params">(String query)</span></span>&#123;</div><div class="line">        List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">        Cat cutest = findCutest(cats);</div><div class="line">        Uri savedUri = api.store(cutest);</div><div class="line">        <span class="keyword">return</span> savedUri;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通俗易懂、简单明了，非常酷的代码。主要的函数<code>saveTheCutestCat()</code>只包含了3个方法。使用这些方法然后等待方法执行完并接受返回值就可以了。</p>
<p>非常简单、有效。接下来我们看一下这种方式的其他优点。  </p>
<p>####组合</p>
<p>可以看到我们的<code>saveTheCutestCat</code>由其他三个函数调用所组成的。我们通过函数来把一个大功能分割为每个容易理解的小功能。通过函数调用来组合使用这些小功能。使用和理解起来都相当简单</p>
<p>####异常传递</p>
<p>另外一个使用函数的好处就是方便处理异常。每个函数都可以通过抛出异常来结束运行。该异常可以在抛出异常的函数里面处理，也可以在调用该函数的外面处理，所以我们无需每次都处理每个异常，我们可以在一个地方处理所有可能抛出的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">    Cat cutest = findCutest(cats);</div><div class="line">    Uri savedUri = api.store(cutest);</div><div class="line">    <span class="keyword">return</span> savedUri;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    e.printStackTrace()</div><div class="line">    <span class="keyword">return</span> someDefaultValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，我们就可以处理这三个函数中所抛出的任何异常了。如果没有<code>try catch</code>语句，我们也可以把异常继续传递下去。</p>
<h2 id="向异步粗发"><a href="#向异步粗发" class="headerlink" title="向异步粗发"></a>向异步粗发</h2><p>但是，现实世界中我们往往没法等待。有些时候你没法只使用阻塞调用。在<code>Android</code>中你需要处理各种异步操作。<br>就那<code>Android</code>的<code>OnClickListener</code>接口来说吧，如果你需要处理一个<code>View</code>的点击事件，你必须提供一个该<code>Listener</code> 的实现来处理用户的点击事件。下面来看看如何处理异步调用。</p>
<p>####异步网络调用</p>
<p>假设我们的<code>cats-sdk.jar</code>使用了异步调用的<code>API</code>来访问网络资源，<br>这样我们的新<code>API</code>接口就变为这样了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">CatsQueryCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, CatsQueryCallback catsQueryCallback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Uri <span class="title">store</span><span class="params">(Cat cat)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们查询猫的操作就变为异步的了， 通过<code>CatsQueryCallback</code>回调接口来结束查询的数据和处理异常情况。<br>我们的业务逻辑也需要跟着改变一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutestCatCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCutestCatSaved</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, CutestCatCallback cutestCatCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                Uri savedUri = api.store(cutest);</div><div class="line">                cutestCatCallback.onCutestCatSaved(savedUri);</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onQueryFailed(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们没法让<code>saveTheCutestCat</code>函数返回一个值了， 我们需要一个回调接口来异步的处理结果。<br>这里我们再进一步，使用两个异步操作来实现我们的功能,例如我们需要使用异步<code>IO</code>来写文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">CatsQueryCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">StoreCallback</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, CatsQueryCallback catsQueryCallback)</span></span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(Cat cat, StoreCallback storeCallback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的<code>helper</code>会变成:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutestCatCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCutestCatSaved</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, CutestCatCallback cutestCatCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                api.store(cutest, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onCutestCatSaved(uri);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们再来看看这部分代码？还是之前那样简单暴力？现在有太多的干扰代码、匿名类，这简直是太恐怖了，但是他们的业务逻辑其实是一样的，都是查询猫的列表数据，然后找出最可爱的猫并保存它的图片。    </p>
<p>上面说好的组合功能没有了，现在你没法像阻塞操作一样来组合调用每个功能了，异步操作中，每次你都必须通过回调接口来手工的处理结果。 </p>
<p>上面说好的异常处理也没有了，异步代码中的异常不会自动传递，我们需要手动的去重新传递。(<code>onStoreFailed()</code>和<code>onQueryFailed()</code>就是干这事的)</p>
<p>####结果？</p>
<p>然后呢？我们可以怎么做？我们能不能使用无回调的模式？我们试着修复一下。 </p>
<p>####奔向更好的世界     </p>
<p>####通用的回调</p>
<p>如果我们仔细的观察下回调接口，我们会发现它们的共性:   </p>
<ul>
<li>它们都有一个分发结果的方法(<code>onCutestCatSaved()</code>,<code>onCatListReceived()</code>,<code>onCatStored()</code>)</li>
<li>它们中的绝大部分都有一个处理操作过程中异常的方法(<code>onError()</code>, <code>onQueryFailed()</code>, <code>onStoreFailed()</code>)</li>
</ul>
<p>所以我们可以创建一个通用的回调来取代它们。但是我们无法修改<code>api</code>的调用结构，我们只能创建一个包裹层的调用。   </p>
<p>我们通用的回调如下:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们创建一个<code>ApiWrapper</code>类来改变我们调用的结构:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, Callback&lt;List&lt;Cat&gt;&gt; catsCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                catsCallback.onResult(cats);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                catsCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">store</span><span class="params">(Cat cat, Callback&lt;Uri&gt; uriCallback)</span></span>&#123;</div><div class="line">        api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                uriCallback.onResult(uri);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                uriCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样通过新的回调我们可以减少一次处理结果和异常的逻辑。<br>最终，我们的<code>CatsHelper</code>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span></span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, Callback&lt;Uri&gt; cutestCatCallback)</span></span>&#123;</div><div class="line">        apiWrapper.queryCats(query, <span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                apiWrapper.store(cutest, cutestCatCallback);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了，现在比之前的代码稍微简单点了。但是我们能不能做的更好？ 当然可以！</p>
<p>####保持参数和回调的分离性</p>
<p>看看这些新的异步操作(<code>queryCats</code>,<code>store</code>和<code>saveTheCutestCat</code>)。这些函数都有同样的模式。使用一些参数来调用这些函数<code>(query,cat)</code>，同时还有一个回调接口作为参数。甚至，所有的异步操作都带有一些常规参数和一个额外的回调接口参数。如果我们把他们分离开会如何，让每个异步操作只有一些常规参数而把返回一个临时的对象来操作回调接口。<br>下面来试试看看这种方式能否有效。<br>如果我们返回一个临时的对象作为异步操作的回调接口处理方式，我们需要先定义这个对象。由于对象遵守通用的行为(有一个回调接口参数)，我们定义一个能用于所有操作的对象。我们称之为<code>AsyncJob</code>。</p>
<blockquote>
<p>注意： 我非常想把这个名字称之为<code>AsyncTask</code>。但是由于<code>Android</code>系统已经有个<code>AsyncTask</code>类了， 为了避免混淆，所以就用<code>AsyncJob</code>了。</p>
</blockquote>
<p>该对象如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>start()</code>函数有个<code>Callback</code>回调接口参数，并开始执行该操作。<br><code>ApiWrapper</code>修改为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> AsyncJob&lt;List&lt;Cat&gt;&gt; queryCats(String query) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;List&lt;Cat&gt;&gt; catsCallback)</span> </span>&#123;</div><div class="line">                api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                        catsCallback.onResult(cats);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        catsCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">store</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; uriCallback)</span> </span>&#123;</div><div class="line">                api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        uriCallback.onResult(uri);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        uriCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>目前看起来还不错。现在可以使用<code>AsyncJob.start()</code>来启动每个操作了。接下来我们修改<code>CatsHelper</code>类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                apiWrapper.queryCats(query)</div><div class="line">                        .start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                                Cat cutest = findCutest(cats);</div><div class="line">                                apiWrapper.store(cutest)</div><div class="line">                                        .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                            <span class="meta">@Override</span></div><div class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                                cutestCatCallback.onResult(result);</div><div class="line">                                            &#125;</div><div class="line"> </div><div class="line">                                            <span class="meta">@Override</span></div><div class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                                cutestCatCallback.onError(e);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;);</div><div class="line">                            &#125;</div><div class="line"> </div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                cutestCatCallback.onError(e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来比前面一个版本更加复杂啊，这样有啥好处啊？<br>这里其实我们返回的是一个<code>AsyncJob</code>对象，该对象和客户端代码组合使用，这样在<code>Activity</code>或者<code>Fragment</code>客户端代码中就可以操作这个返回的对象了。<br>代码虽然目前看起来比较复杂，下面我们就来改进一下。</p>
<p>####分解</p>
<p>下面是流程图:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">         (async)                 (sync)           (async)</div><div class="line">query ===========&gt; List&lt;Cat&gt; -------------&gt; Cat ==========&gt; Uri</div><div class="line">       queryCats              findCutest           store</div></pre></td></tr></table></figure></p>
<p>为了让代码具有可读性，我们把这个流程分解为每个操作。同时我们再进一步假设，如果一个操作是异步的，则每个调用该异步操作的函数也是异步的。例如：如果查询猫是个异步操作，则找到最可爱的猫操作也是异步的。</p>
<p>因此，我们可以使用<code>AsyncJob</code>来把这些操作分解为一些小的操作中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Cat&gt; callback)</span> </span>&#123;</div><div class="line">                catsListAsyncJob.start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; result)</span> </span>&#123;</div><div class="line">                        callback.onResult(findCutest(result));</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                cutestCatAsyncJob.start(<span class="keyword">new</span> Callback&lt;Cat&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Cat cutest)</span> </span>&#123;</div><div class="line">                        apiWrapper.store(cutest)</div><div class="line">                                .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onResult(result);</div><div class="line">                                    &#125;</div><div class="line"> </div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onError(e);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然代码量多了，但是看起来更加清晰了。 嵌套的回调函数没那么多层级了，异步操作的名字也更容易理解了(<code>catsListAsyncJob</code>,<code>cutestCatAsyncJob</code>, <code>storedUriAsyncJob</code>)。<br>看起来还不错，但是还可以更好。</p>
<p>####简单的映射</p>
<p>先来看看我们创建 AsyncJob cutestCatAsyncJob 的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">AsyncJob&lt;Cat&gt; cutestCatAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Cat&gt; callback)</span> </span>&#123;</div><div class="line">                catsListAsyncJob.start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; result)</span> </span>&#123;</div><div class="line">                        callback.onResult(findCutest(result));</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>这 16 行代码中，只有一行代码是我们的业务逻辑代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">findCutest(result)</div></pre></td></tr></table></figure></p>
<p>其他的代码只是为了启动<code>AsyncJob</code>并接收结果和处理异常的干扰代码。 但是这些代码是通用的，我们可以把他们放到其他地方来让我们更加专注业务逻辑代码。<br>那么如何实现呢？需要做两件事情：</p>
<ul>
<li>通过<code>AsyncJob</code>获取需要转换的结果</li>
<li>转换的函数</li>
</ul>
<p>但是由于<code>Java</code>的限制，无法把函数作为参数，所以需要用一个接口（或者类）并在里面定义一个转换函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Func</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line">    <span class="function">R <span class="title">call</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>灰常简单。 有两个泛型类型定义，<code>T</code>代表参数的类型；<code>R</code>代表返回值的类型。</p>
<p>当我们把<code>AsyncJob</code>的结果转换为其他类型的时候，我们需要把一个结果值映射为另外一种类型，这个操作我们称之为<code>map</code>。 把该函数定义到<code>AsyncJob</code>类中比较方便，这样就可以通过<code>this</code>来访问<code>AsyncJob</code>对象了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">map</span><span class="params">(Func&lt;T, R&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        R mapped = func.call(result);</div><div class="line">                        callback.onResult(mapped);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来不错， 现在的<code>CatsHelper</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                cutestCatAsyncJob.start(<span class="keyword">new</span> Callback&lt;Cat&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Cat cutest)</span> </span>&#123;</div><div class="line">                        apiWrapper.store(cutest)</div><div class="line">                                .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onResult(result);</div><div class="line">                                    &#125;</div><div class="line"> </div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onError(e);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新创建的<code>AsyncJob cutestCatAsyncJob()</code>的代码只有6行，并且只有一层嵌套。</p>
<p>####高级映射</p>
<p>但是<code>AsyncJob storedUriAsyncJob()</code>看起来还是非常糟糕。 这里也能使用映射吗？ 下面就来试试吧！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.map(<span class="keyword">new</span> Func&lt;Cat, Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Uri <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">        <span class="comment">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ 将会导致无法编译</span></div><div class="line">        <span class="comment">//      Incompatible types:</span></div><div class="line">        <span class="comment">//      Required: Uri</span></div><div class="line">        <span class="comment">//      Found: AsyncJob&lt;Uri&gt;                </span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哎。。。 看起来没这么简单啊， 下面修复返回的类型再试一次：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt; storedUriAsyncJob = cutestCatAsyncJob.map(<span class="keyword">new</span> Func&lt;Cat, AsyncJob&lt;Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">        <span class="comment">//^^^^^^^^^^^^^^^^^^^^^^^ 将会导致无法编译</span></div><div class="line">        <span class="comment">//      Incompatible types:</span></div><div class="line">        <span class="comment">//      Required: AsyncJob&lt;Uri&gt;</span></div><div class="line">        <span class="comment">//      Found: AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt;</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们只能拿到<code>AsyncJob&lt;AsyncJob&gt;</code> 。看来还需要更进一步。我们需要压缩一层<code>AsyncJob</code>，把两个异步操作当做一个单一的异步操作来对待。<br>现在我们需要一个参数为<code>AsyncJob</code>的<code>map</code>转换操作而不是<code>R</code>。该操作类似于<code>map</code>，但是该操作会把嵌套的<code>AsyncJob</code>压缩为<code>flatten</code>一层<code>AsyncJob</code>. 我们称之为<code>flatMap</code>，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">map</span><span class="params">(Func&lt;T, R&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        R mapped = func.call(result);</div><div class="line">                        callback.onResult(mapped);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">flatMap</span><span class="params">(Func&lt;T, AsyncJob&lt;R&gt;&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        AsyncJob&lt;R&gt; mapped = func.call(result);</div><div class="line">                        mapped.start(<span class="keyword">new</span> Callback&lt;R&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(R result)</span> </span>&#123;</div><div class="line">                                callback.onResult(result);</div><div class="line">                            &#125;</div><div class="line"> </div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                callback.onError(e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来有很多干扰代码，但是还好这些代码在客户端代码中并不会出现。 现在我们的<code>CatsHelper</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.flatMap(<span class="keyword">new</span> Func&lt;Cat, AsyncJob&lt;Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果把匿名类修改为<code>Java 8</code>的<code>lambdas</code>表达式（逻辑是一样的，只是让代码看起来更清晰点）就很容易发现了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(cats -&gt; findCutest(cats));</div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.flatMap(cat -&gt; apiWrapper.store(cat));</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样看起来是不是就很清晰了。 这个代码和刚刚开头的阻塞式代码是不是非常相似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">saveTheCutestCat</span><span class="params">(String query)</span></span>&#123;</div><div class="line">        List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">        Cat cutest = findCutest(cats);</div><div class="line">        Uri savedUri = api.store(cutest);</div><div class="line">        <span class="keyword">return</span> savedUri;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在他们不仅逻辑是一样的，语义上也是一样的。 太棒了！<br>同时我们还可以使用组合操作，现在把两个异步操作组合一起并返还另外一个异步操作。<br>异常处理也会传递到最终的回调接口中。<br>下面来看看<code>RxJava</code>吧。<br>你没必要把上面代码应用到您的项目中去， 这些简单的、线程不安全的代码只是 <code>RxJava</code>的一部分。<br>只有一些名字上的不同：</p>
<ul>
<li><code>AsyncJob</code>等同于<code>Observable</code>，不仅仅可以返回一个结果，还可以返回一系列的结果，当然也可能没有结果返回。</li>
<li><code>Callback</code>等同于<code>Observer</code>，除了<code>onNext(T t)</code>, <code>onError(Throwable t)</code>以外，还有一个<code>onCompleted()</code>函数，该函数在结束继续返回结果的时候通知<code>Observable</code>。</li>
<li><code>abstract void start(Callback callback)</code>和<code>Subscription subscribe(final Observer observer)</code>类似，返回一个<code>Subscription</code>，如果你不再需要后面的结果了，可以取消该任务。</li>
</ul>
<p>下面是<code>RxJava</code>版本的代码:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> Observable&lt;List&lt;Cat&gt;&gt; queryCats(<span class="keyword">final</span> String query) &#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> List&lt;Cat&gt;&gt; subscriber)</span> </span>&#123;</div><div class="line">                api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                        subscriber.onNext(cats);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        subscriber.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Uri&gt; <span class="title">store</span><span class="params">(<span class="keyword">final</span> Cat cat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Uri&gt; subscriber)</span> </span>&#123;</div><div class="line">                api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        subscriber.onNext(uri);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        subscriber.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        Observable&lt;List&lt;Cat&gt;&gt; catsListObservable = apiWrapper.queryCats(query);</div><div class="line">        Observable&lt;Cat&gt; cutestCatObservable = catsListObservable.map(<span class="keyword">new</span> Func1&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> CatsHelper.<span class="keyword">this</span>.findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        Observable&lt;Uri&gt; storedUriObservable = cutestCatObservable.flatMap(<span class="keyword">new</span> Func1&lt;Cat, Observable&lt;? extends Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> Observable&lt;? extends Uri&gt; call(Cat cat) &#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriObservable;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把 Observable 替换为 AsyncJob 后 他们的代码是一样的。</p>
<p>####结论</p>
<p>通过简单的转换操作，我们可以把异步操作抽象出来。这种抽象的结果可以像操作简单的阻塞函数一样来操作异步操作并组合异步操作。这样我们就可以摆脱层层嵌套的回调接口了，并且不用手工的去处理每次异步操作的异常。</p>
<p>上面这个例子非常好，建议多看几遍，加深理解，可能把这个例子放在这里并不太好，把它放到开始讲之前可能更容易理解，但是我觉得，介绍完概念、使用方法和基本的操作符后，我们可能并不能理解操作符的原理和作用。之前看完操作符原理后迷迷糊糊的状态再来看这个例子会豁然开朗。    </p>
<p>这里也感谢牛逼的作者<a href="https://github.com/yarikx">Yaroslav</a>(也是<code>RxAndroid</code>项目的一个重要参与者)能用这么牛逼的例子，讲解的如此透彻。   </p>
<p>如果嫌上面的代码麻烦，可以通过下面的例子看:   </p>
<p>假设有这样一个需求：界面上有一个自定义的视图<code>imageCollectorView</code>，它的作用是显示多张图片，并能使用<code>addImage(Bitmap)</code> 方法来任意增加显示的图片。现在需要程序将一个给出的目录数组<code>File[] folders</code>中每个目录下的<code>png</code>图片都加载出来并显示在<code>imageCollectorView</code>中。需要注意的是，由于读取图片的这一过程较为耗时，需要放在后台执行，而图片的显示则必须在<code>UI</code>线程执行。常用的实现方式有多种，我这里贴出其中一种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Thread() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.run();</div><div class="line">        <span class="keyword">for</span> (File folder : folders) &#123;</div><div class="line">            File[] files = folder.listFiles();</div><div class="line">            <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">                <span class="keyword">if</span> (file.getName().endsWith(<span class="string">".png"</span>)) &#123;</div><div class="line">                    <span class="keyword">final</span> Bitmap bitmap = getBitmapFromFile(file);</div><div class="line">                    getActivity().runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            imageCollectorView.addImage(bitmap);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;.start();</div></pre></td></tr></table></figure>
<p>而如果使用 RxJava ，实现方式是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">Observable.from(folders)</div><div class="line">    .flatMap(<span class="keyword">new</span> Func1&lt;File, Observable&lt;File&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;File&gt; <span class="title">call</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Observable.from(file.listFiles());</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .filter(<span class="keyword">new</span> Func1&lt;File, Boolean&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> file.getName().endsWith(<span class="string">".png"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .map(<span class="keyword">new</span> Func1&lt;File, Bitmap&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Bitmap <span class="title">call</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getBitmapFromFile(file);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Action1&lt;Bitmap&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">            imageCollectorView.addImage(bitmap);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>那位说话了：『你这代码明明变多了啊！简洁个毛啊！』大兄弟你消消气，我说的是逻辑的简洁，不是单纯的代码量少（逻辑简洁才是提升读写代码速度的必杀技对不？）。观察一下你会发现， <code>RxJava</code>的这个实现，是一条从上到下的链式调用，没有任何嵌套，这在逻辑的简洁性上是具有优势的。当需求变得复杂时，这种优势将更加明显（试想如果还要求只选取前<code>10</code>张图片，常规方式要怎么办？如果有更多这样那样的要求呢？再试想，在这一大堆需求实现完两个月之后需要改功能，当你翻回这里看到自己当初写下的那一片迷之缩进，你能保证自己将迅速看懂，而不是对着代码重新捋一遍思路？）。</p>
<p>更多内容请看下一篇文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/RxJava%E8%AF%A6%E8%A7%A3(%E4%B8%8B">RxJava详解(下)</a>.md)</p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(中)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-HttpURLConnection详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/HttpURLConnection详解/">Android HttpURLConnection源码分析</a>
    </h1>
  

        
        <a href="/2015/01/01/HttpURLConnection详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Android-HttpURLConnection源码分析"><a href="#Android-HttpURLConnection源码分析" class="headerlink" title="Android HttpURLConnection源码分析"></a>Android HttpURLConnection源码分析</h2><p>之前写过HttpURLConnection与HttpClient的区别及选择。后来又分析了Volley的源码。<br>最近又遇到了问题，想在Volley中针对HttpURLConnection添加连接池的功能，开始有点懵了，不知道HttpURLConnection要怎么加连接池，<br>虽然感觉这是没必要的，但是心底确拿不出依据。所以研究下HttpURLConnection的源码进行分析。</p>
<p>在使用的时候都是通过URL.openConnection()来获取<code>HttpURLConnection</code>对象，然后调用其<code>connect</code>方法进行链接，所以先从<code>URL.penConnection()</code>入手:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns a new connection to the resource referred to by this URL.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IOException if an error occurs while opening the connection.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> URLConnection <span class="title">openConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> streamHandler.openConnection(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来就要看一下<code>streamHandler</code>究竟是何方神圣？我们搜一下他的赋值，实在<code>setupStreamHandler</code>方法中进行的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets the receiver's stream handler to one which is appropriate for its</div><div class="line"> * protocol.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this will overwrite any existing stream handler with the new</div><div class="line"> * one. Senders must check if the streamHandler is null before calling the</div><div class="line"> * method if they do not want this behavior (a speed optimization).</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> MalformedURLException if no reasonable handler is available.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupStreamHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Check for a cached (previously looked up) handler for</span></div><div class="line">    <span class="comment">// the requested protocol.</span></div><div class="line">    streamHandler = streamHandlers.get(protocol);</div><div class="line">    <span class="keyword">if</span> (streamHandler != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If there is a stream handler factory, then attempt to</span></div><div class="line">    <span class="comment">// use it to create the handler.</span></div><div class="line">    <span class="keyword">if</span> (streamHandlerFactory != <span class="keyword">null</span>) &#123;</div><div class="line">        streamHandler = streamHandlerFactory.createURLStreamHandler(protocol);</div><div class="line">        <span class="keyword">if</span> (streamHandler != <span class="keyword">null</span>) &#123;</div><div class="line">            streamHandlers.put(protocol, streamHandler);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if there is a list of packages which can provide handlers.</span></div><div class="line">    <span class="comment">// If so, then walk this list looking for an applicable one.</span></div><div class="line">    String packageList = System.getProperty(<span class="string">"java.protocol.handler.pkgs"</span>);</div><div class="line">    ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</div><div class="line">    <span class="keyword">if</span> (packageList != <span class="keyword">null</span> &amp;&amp; contextClassLoader != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (String packageName : packageList.split(<span class="string">"\\|"</span>)) &#123;</div><div class="line">            String className = packageName + <span class="string">"."</span> + protocol + <span class="string">".Handler"</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Class&lt;?&gt; c = contextClassLoader.loadClass(className);</div><div class="line">                streamHandler = (URLStreamHandler) c.newInstance();</div><div class="line">                <span class="keyword">if</span> (streamHandler != <span class="keyword">null</span>) &#123;</div><div class="line">                    streamHandlers.put(protocol, streamHandler);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ignored) &#123;</div><div class="line">            &#125; <span class="keyword">catch</span> (InstantiationException ignored) &#123;</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Fall back to a built-in stream handler if the user didn't supply one</span></div><div class="line">    <span class="keyword">if</span> (protocol.equals(<span class="string">"file"</span>)) &#123;</div><div class="line">        streamHandler = <span class="keyword">new</span> FileHandler();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol.equals(<span class="string">"ftp"</span>)) &#123;</div><div class="line">        streamHandler = <span class="keyword">new</span> FtpHandler();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol.equals(<span class="string">"http"</span>)) &#123;</div><div class="line">        <span class="comment">// 判断一下如果是HTTP协议，就会创建HtppHandler。看到这里明白了，原来使用的是okhttp.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String name = <span class="string">"com.android.okhttp.HttpHandler"</span>;</div><div class="line">            streamHandler = (URLStreamHandler) Class.forName(name).newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol.equals(<span class="string">"https"</span>)) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String name = <span class="string">"com.android.okhttp.HttpsHandler"</span>;</div><div class="line">            streamHandler = (URLStreamHandler) Class.forName(name).newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol.equals(<span class="string">"jar"</span>)) &#123;</div><div class="line">        streamHandler = <span class="keyword">new</span> JarHandler();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (streamHandler != <span class="keyword">null</span>) &#123;</div><div class="line">        streamHandlers.put(protocol, streamHandler);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们就以<code>HTTP</code>协议为例说一下所以找到<code>okhttp HttpHandler.openConnection()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> *  Licensed to the Apache Software Foundation (ASF) under one or more</div><div class="line"> *  contributor license agreements.  See the NOTICE file distributed with</div><div class="line"> *  this work for additional information regarding copyright ownership.</div><div class="line"> *  The ASF licenses this file to You under the Apache License, Version 2.0</div><div class="line"> *  (the "License"); you may not use this file except in compliance with</div><div class="line"> *  the License.  You may obtain a copy of the License at</div><div class="line"> *</div><div class="line"> *     http://www.apache.org/licenses/LICENSE-2.0</div><div class="line"> *</div><div class="line"> *  Unless required by applicable law or agreed to in writing, software</div><div class="line"> *  distributed under the License is distributed on an "AS IS" BASIS,</div><div class="line"> *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line"> *  See the License for the specific language governing permissions and</div><div class="line"> *  limitations under the License.</div><div class="line"> */</div><div class="line"><span class="keyword">package</span> com.squareup.okhttp;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.Proxy;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLConnection;</div><div class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL url)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// 调用了OKHttpClient()的方法</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient().open(url);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL url, Proxy proxy)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span> || proxy == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null || proxy == null"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient().setProxy(proxy).open(url);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">80</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来就悲剧了，因为我找不到OkHttpClient()类中有<code>open</code>方法。<br>仔细查看了文档后发现在<code>OKHttp</code>1.6.0的时候该方法就已经已经过时了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Deprecated</span></div><div class="line"><span class="function"><span class="keyword">public</span> HttpURLConnection <span class="title">open</span><span class="params">(URL url)</span></span></div><div class="line">Deprecated. moved to OkUrlFactory.open.</div></pre></td></tr></table></figure></p>
<p>那我们怎么往下分析呢？很显然<code>Android sdk</code>中使用的<code>OkHttp</code>不是最新版。所以我们可以使用<code>1.5.0</code>版本的<code>OKHttp</code>接着分析。<br>在项目<code>build.gradle</code>中进行配置 compile ‘com.squareup.okhttp:okhttp:1.5.0’ 然后开始愉快的查看源码。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.squareup.okhttp;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.Util;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.http.HttpAuthenticator;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.http.HttpURLConnectionImpl;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.http.HttpsURLConnectionImpl;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.http.ResponseCacheAdapter;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.okio.ByteString;</div><div class="line"><span class="keyword">import</span> com.squareup.okhttp.internal.tls.OkHostnameVerifier;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.CookieHandler;</div><div class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</div><div class="line"><span class="keyword">import</span> java.net.Proxy;</div><div class="line"><span class="keyword">import</span> java.net.ProxySelector;</div><div class="line"><span class="keyword">import</span> java.net.ResponseCache;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLConnection;</div><div class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</div><div class="line"><span class="keyword">import</span> java.net.URLStreamHandlerFactory;</div><div class="line"><span class="keyword">import</span> java.security.GeneralSecurityException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.HostnameVerifier;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</div><div class="line"></div><div class="line"><span class="comment">/** Configures and creates HTTP connections. */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpClient</span> <span class="keyword">implements</span> <span class="title">URLStreamHandlerFactory</span>, <span class="title">Cloneable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> RouteDatabase routeDatabase;</div><div class="line">  <span class="keyword">private</span> Proxy proxy;</div><div class="line">  <span class="keyword">private</span> List&lt;Protocol&gt; protocols;</div><div class="line">  <span class="keyword">private</span> ProxySelector proxySelector;</div><div class="line">  <span class="keyword">private</span> CookieHandler cookieHandler;</div><div class="line">  <span class="keyword">private</span> OkResponseCache responseCache;</div><div class="line">  <span class="keyword">private</span> SSLSocketFactory sslSocketFactory;</div><div class="line">  <span class="keyword">private</span> HostnameVerifier hostnameVerifier;</div><div class="line">  <span class="keyword">private</span> OkAuthenticator authenticator;</div><div class="line">  <span class="keyword">private</span> ConnectionPool connectionPool;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> followProtocolRedirects = <span class="keyword">true</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> connectTimeout;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> readTimeout;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OkHttpClient</span><span class="params">()</span> </span>&#123;</div><div class="line">    routeDatabase = <span class="keyword">new</span> RouteDatabase();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the default connect timeout for new connections. A value of 0 means no timeout.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@see</span> URLConnection#setConnectTimeout(int)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectTimeout</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout &lt; 0"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (unit == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unit == null"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> millis = unit.toMillis(timeout);</div><div class="line">    <span class="keyword">if</span> (millis &gt; Integer.MAX_VALUE) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Timeout too large."</span>);</div><div class="line">    &#125;</div><div class="line">    connectTimeout = (<span class="keyword">int</span>) millis;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Default connect timeout (in milliseconds). */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getConnectTimeout</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> connectTimeout;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the default read timeout for new connections. A value of 0 means no timeout.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@see</span> URLConnection#setReadTimeout(int)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadTimeout</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout &lt; 0"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (unit == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unit == null"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> millis = unit.toMillis(timeout);</div><div class="line">    <span class="keyword">if</span> (millis &gt; Integer.MAX_VALUE) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Timeout too large."</span>);</div><div class="line">    &#125;</div><div class="line">    readTimeout = (<span class="keyword">int</span>) millis;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Default read timeout (in milliseconds). */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getReadTimeout</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> readTimeout;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the HTTP proxy that will be used by connections created by this</div><div class="line">   * client. This takes precedence over &#123;<span class="doctag">@link</span> #setProxySelector&#125;, which is</div><div class="line">   * only honored when this proxy is null (which it is by default). To disable</div><div class="line">   * proxy use completely, call &#123;<span class="doctag">@code</span> setProxy(Proxy.NO_PROXY)&#125;.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setProxy</span><span class="params">(Proxy proxy)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.proxy = proxy;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Proxy <span class="title">getProxy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> proxy;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the proxy selection policy to be used if no &#123;<span class="doctag">@link</span> #setProxy proxy&#125;</div><div class="line">   * is specified explicitly. The proxy selector may return multiple proxies;</div><div class="line">   * in that case they will be tried in sequence until a successful connection</div><div class="line">   * is established.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, the &#123;<span class="doctag">@link</span> ProxySelector#getDefault() system-wide default&#125;</div><div class="line">   * proxy selector will be used.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setProxySelector</span><span class="params">(ProxySelector proxySelector)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.proxySelector = proxySelector;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> ProxySelector <span class="title">getProxySelector</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> proxySelector;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the cookie handler to be used to read outgoing cookies and write</div><div class="line">   * incoming cookies.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, the &#123;<span class="doctag">@link</span> CookieHandler#getDefault() system-wide default&#125;</div><div class="line">   * cookie handler will be used.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setCookieHandler</span><span class="params">(CookieHandler cookieHandler)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.cookieHandler = cookieHandler;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> CookieHandler <span class="title">getCookieHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> cookieHandler;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the response cache to be used to read and write cached responses.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setResponseCache</span><span class="params">(ResponseCache responseCache)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> setOkResponseCache(toOkResponseCache(responseCache));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> ResponseCache <span class="title">getResponseCache</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> responseCache <span class="keyword">instanceof</span> ResponseCacheAdapter</div><div class="line">        ? ((ResponseCacheAdapter) responseCache).getDelegate()</div><div class="line">        : <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setOkResponseCache</span><span class="params">(OkResponseCache responseCache)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.responseCache = responseCache;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> OkResponseCache <span class="title">getOkResponseCache</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> responseCache;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the socket factory used to secure HTTPS connections.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, a lazily created SSL socket factory will be used.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setSslSocketFactory</span><span class="params">(SSLSocketFactory sslSocketFactory)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.sslSocketFactory = sslSocketFactory;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> SSLSocketFactory <span class="title">getSslSocketFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sslSocketFactory;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the verifier used to confirm that response certificates apply to</div><div class="line">   * requested hostnames for HTTPS connections.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, the</div><div class="line">   * &#123;<span class="doctag">@link</span> javax.net.ssl.HttpsURLConnection#getDefaultHostnameVerifier()</div><div class="line">   * system-wide default&#125; hostname verifier will be used.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setHostnameVerifier</span><span class="params">(HostnameVerifier hostnameVerifier)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.hostnameVerifier = hostnameVerifier;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> HostnameVerifier <span class="title">getHostnameVerifier</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> hostnameVerifier;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the authenticator used to respond to challenges from the remote web</div><div class="line">   * server or proxy server.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, the &#123;<span class="doctag">@link</span> java.net.Authenticator#setDefault system-wide default&#125;</div><div class="line">   * authenticator will be used.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setAuthenticator</span><span class="params">(OkAuthenticator authenticator)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.authenticator = authenticator;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> OkAuthenticator <span class="title">getAuthenticator</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> authenticator;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Sets the connection pool used to recycle HTTP and HTTPS connections.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, the &#123;<span class="doctag">@link</span> ConnectionPool#getDefault() system-wide</div><div class="line">   * default&#125; connection pool will be used.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setConnectionPool</span><span class="params">(ConnectionPool connectionPool)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.connectionPool = connectionPool;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> ConnectionPool <span class="title">getConnectionPool</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> connectionPool;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Configure this client to follow redirects from HTTPS to HTTP and from HTTP</div><div class="line">   * to HTTPS.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If unset, protocol redirects will be followed. This is different than</div><div class="line">   * the built-in &#123;<span class="doctag">@code</span> HttpURLConnection&#125;'s default.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setFollowProtocolRedirects</span><span class="params">(<span class="keyword">boolean</span> followProtocolRedirects)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.followProtocolRedirects = followProtocolRedirects;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getFollowProtocolRedirects</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> followProtocolRedirects;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> RouteDatabase <span class="title">getRoutesDatabase</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> routeDatabase;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * <span class="doctag">@deprecated</span> OkHttp 1.5 enforces an enumeration of &#123;<span class="doctag">@link</span> Protocol protocols&#125;</div><div class="line">   * that can be selected. Please switch to &#123;<span class="doctag">@link</span> #setProtocols(java.util.List)&#125;.</div><div class="line">   */</div><div class="line">  <span class="meta">@Deprecated</span></div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setTransports</span><span class="params">(List&lt;String&gt; transports)</span> </span>&#123;</div><div class="line">    List&lt;Protocol&gt; protocols = <span class="keyword">new</span> ArrayList&lt;Protocol&gt;(transports.size());</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = transports.size(); i &lt; size; i++) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        Protocol protocol = Util.getProtocol(ByteString.encodeUtf8(transports.get(i)));</div><div class="line">        protocols.add(protocol);</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> setProtocols(protocols);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Configure the protocols used by this client to communicate with remote</div><div class="line">   * servers. By default this client will prefer the most efficient transport</div><div class="line">   * available, falling back to more ubiquitous protocols. Applications should</div><div class="line">   * only call this method to avoid specific compatibility problems, such as web</div><div class="line">   * servers that behave incorrectly when SPDY is enabled.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;The following protocols are currently supported:</div><div class="line">   * &lt;ul&gt;</div><div class="line">   *   &lt;li&gt;&lt;a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html"&gt;http/1.1&lt;/a&gt;</div><div class="line">   *   &lt;li&gt;&lt;a href="http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3-1"&gt;spdy/3.1&lt;/a&gt;</div><div class="line">   *   &lt;li&gt;&lt;a href="http://tools.ietf.org/html/draft-ietf-httpbis-http2-09"&gt;HTTP-draft-09/2.0&lt;/a&gt;</div><div class="line">   * &lt;/ul&gt;</div><div class="line">   *</div><div class="line">   * &lt;p&gt;&lt;strong&gt;This is an evolving set.&lt;/strong&gt; Future releases may drop</div><div class="line">   * support for transitional protocols (like spdy/3.1), in favor of their</div><div class="line">   * successors (spdy/4 or http/2.0). The http/1.1 transport will never be</div><div class="line">   * dropped.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If multiple protocols are specified, &lt;a</div><div class="line">   * href="https://technotes.googlecode.com/git/nextprotoneg.html"&gt;NPN&lt;/a&gt; will</div><div class="line">   * be used to negotiate a transport. Future releases may use another mechanism</div><div class="line">   * (such as &lt;a href="http://tools.ietf.org/html/draft-friedl-tls-applayerprotoneg-02"&gt;ALPN&lt;/a&gt;)</div><div class="line">   * to negotiate a transport.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> protocols the protocols to use, in order of preference. The list</div><div class="line">   *     must contain "http/1.1". It must not contain null.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">setProtocols</span><span class="params">(List&lt;Protocol&gt; protocols)</span> </span>&#123;</div><div class="line">    protocols = Util.immutableList(protocols);</div><div class="line">    <span class="keyword">if</span> (!protocols.contains(Protocol.HTTP_11)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"protocols doesn't contain http/1.1: "</span> + protocols);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (protocols.contains(<span class="keyword">null</span>)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"protocols must not contain null"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.protocols = Util.immutableList(protocols);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * <span class="doctag">@deprecated</span> OkHttp 1.5 enforces an enumeration of &#123;<span class="doctag">@link</span> Protocol</div><div class="line">   *     protocols&#125; that can be selected. Please switch to &#123;<span class="doctag">@link</span></div><div class="line">   *     #getProtocols()&#125;.</div><div class="line">   */</div><div class="line">  <span class="meta">@Deprecated</span></div><div class="line">  <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getTransports</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; transports = <span class="keyword">new</span> ArrayList&lt;String&gt;(protocols.size());</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = protocols.size(); i &lt; size; i++) &#123;</div><div class="line">      transports.add(protocols.get(i).name.utf8());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> transports;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> List&lt;Protocol&gt; <span class="title">getProtocols</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> protocols;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> HttpURLConnection <span class="title">open</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> open(url, proxy);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">HttpURLConnection <span class="title">open</span><span class="params">(URL url, Proxy proxy)</span> </span>&#123;</div><div class="line">    String protocol = url.getProtocol();</div><div class="line">	<span class="comment">// 将该对象clone后设置一些其他的属性返回，里面会设置一个默认的连接池。</span></div><div class="line">    OkHttpClient copy = copyWithDefaults();</div><div class="line">    copy.proxy = proxy;</div><div class="line">	<span class="comment">// 返回了HttpURLConnectionImpl，并且把clone后的OKHttpClient对象传递进去。</span></div><div class="line">    <span class="keyword">if</span> (protocol.equals(<span class="string">"http"</span>)) <span class="keyword">return</span> <span class="keyword">new</span> HttpURLConnectionImpl(url, copy);</div><div class="line">    <span class="keyword">if</span> (protocol.equals(<span class="string">"https"</span>)) <span class="keyword">return</span> <span class="keyword">new</span> HttpsURLConnectionImpl(url, copy);</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unexpected protocol: "</span> + protocol);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Returns a shallow copy of this OkHttpClient that uses the system-wide</div><div class="line">   * default for each field that hasn't been explicitly configured.</div><div class="line">   */</div><div class="line">  <span class="function">OkHttpClient <span class="title">copyWithDefaults</span><span class="params">()</span> </span>&#123;</div><div class="line">    OkHttpClient result = clone();</div><div class="line">    <span class="keyword">if</span> (result.proxySelector == <span class="keyword">null</span>) &#123;</div><div class="line">      result.proxySelector = ProxySelector.getDefault();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.cookieHandler == <span class="keyword">null</span>) &#123;</div><div class="line">      result.cookieHandler = CookieHandler.getDefault();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.responseCache == <span class="keyword">null</span>) &#123;</div><div class="line">      result.responseCache = toOkResponseCache(ResponseCache.getDefault());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.sslSocketFactory == <span class="keyword">null</span>) &#123;</div><div class="line">      result.sslSocketFactory = getDefaultSSLSocketFactory();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.hostnameVerifier == <span class="keyword">null</span>) &#123;</div><div class="line">      result.hostnameVerifier = OkHostnameVerifier.INSTANCE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.authenticator == <span class="keyword">null</span>) &#123;</div><div class="line">      result.authenticator = HttpAuthenticator.SYSTEM_DEFAULT;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.connectionPool == <span class="keyword">null</span>) &#123;</div><div class="line">	  <span class="comment">// 会给OkHttpClient设置一个默认的连接池</span></div><div class="line">      result.connectionPool = ConnectionPool.getDefault();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result.protocols == <span class="keyword">null</span>) &#123;</div><div class="line">      result.protocols = Util.HTTP2_SPDY3_AND_HTTP;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Java and Android programs default to using a single global SSL context,</div><div class="line">   * accessible to HTTP clients as &#123;<span class="doctag">@link</span> SSLSocketFactory#getDefault()&#125;. If we</div><div class="line">   * used the shared SSL context, when OkHttp enables NPN for its SPDY-related</div><div class="line">   * stuff, it would also enable NPN for other usages, which might crash them</div><div class="line">   * because NPN is enabled when it isn't expected to be.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * This code avoids that by defaulting to an OkHttp created SSL context. The</div><div class="line">   * significant drawback of this approach is that apps that customize the</div><div class="line">   * global SSL context will lose these customizations.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> SSLSocketFactory <span class="title">getDefaultSSLSocketFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sslSocketFactory == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        SSLContext sslContext = SSLContext.getInstance(<span class="string">"TLS"</span>);</div><div class="line">        sslContext.init(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        sslSocketFactory = sslContext.getSocketFactory();</div><div class="line">      &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(); <span class="comment">// The system has no TLS. Just give up.</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sslSocketFactory;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a shallow copy of this OkHttpClient. */</span></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">clone</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> (OkHttpClient) <span class="keyword">super</span>.clone();</div><div class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> OkResponseCache <span class="title">toOkResponseCache</span><span class="params">(ResponseCache responseCache)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> responseCache == <span class="keyword">null</span> || responseCache <span class="keyword">instanceof</span> OkResponseCache</div><div class="line">        ? (OkResponseCache) responseCache</div><div class="line">        : <span class="keyword">new</span> ResponseCacheAdapter(responseCache);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Creates a URLStreamHandler as a &#123;<span class="doctag">@link</span> URL#setURLStreamHandlerFactory&#125;.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;This code configures OkHttp to handle all HTTP and HTTPS connections</div><div class="line">   * created with &#123;<span class="doctag">@link</span> URL#openConnection()&#125;: &lt;pre&gt;   &#123;<span class="doctag">@code</span></div><div class="line">   *</div><div class="line">   *   OkHttpClient okHttpClient = new OkHttpClient();</div><div class="line">   *   URL.setURLStreamHandlerFactory(okHttpClient);</div><div class="line">   * &#125;&lt;/pre&gt;</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> URLStreamHandler <span class="title">createURLStreamHandler</span><span class="params">(<span class="keyword">final</span> String protocol)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!protocol.equals(<span class="string">"http"</span>) &amp;&amp; !protocol.equals(<span class="string">"https"</span>)) <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> URLStreamHandler() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> open(url);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL url, Proxy proxy)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> open(url, proxy);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (protocol.equals(<span class="string">"http"</span>)) <span class="keyword">return</span> <span class="number">80</span>;</div><div class="line">        <span class="keyword">if</span> (protocol.equals(<span class="string">"https"</span>)) <span class="keyword">return</span> <span class="number">443</span>;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着看一下<code>HttpURLConnectionImpl</code>类,它是<code>HttpURLConnection</code>的子类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpURLConnectionImpl</span> <span class="keyword">extends</span> <span class="title">HttpURLConnection</span> </span>&#123;</div><div class="line">    .....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里<code>new URL(url).openConnection()</code>方法已经分析完了，其实就是返回了一个HtppURLConnectionImpl对象。    </p>
<p>我们在使用<code>HttpURLConnection</code>都是这样使用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">String url = <span class="string">"http://www.baidu.com"</span></div><div class="line">URL url = <span class="keyword">new</span> URL(url);</div><div class="line">HttpURLConnection connection = (HttpURLConnection)url.openConnection();</div><div class="line"><span class="comment">// 设置一些请求头等参数</span></div><div class="line">...</div><div class="line">connection.connect();</div><div class="line"><span class="comment">// 然后调用一些其他的获取结果或者状态的方法。</span></div><div class="line">...</div><div class="line">connection.getResponseCode();</div><div class="line">connection.getOuoputStream();</div><div class="line">connection.getInputStream();</div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>上面分析了<code>new URL().openConnection()</code>那我们这里就接着分析第二步了，就是调用<code>connect()</code>方法的处理:<br>这里看一下<code>HttpURLConnectionImpl.connect()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">initHttpEngine();</div><div class="line"><span class="keyword">boolean</span> success;</div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">  success = execute(<span class="keyword">false</span>);</div><div class="line">&#125; <span class="keyword">while</span> (!success);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>initHttpEngine()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHttpEngine</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (httpEngineFailure != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> httpEngineFailure;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (httpEngine != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    connected = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (doOutput) &#123;</div><div class="line">        <span class="keyword">if</span> (method.equals(<span class="string">"GET"</span>)) &#123;</div><div class="line">          <span class="comment">// they are requesting a stream to write to. This implies a POST method</span></div><div class="line">          method = <span class="string">"POST"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!HttpMethod.hasRequestBody(method)) &#123;</div><div class="line">          <span class="comment">// If the request method is neither POST nor PUT nor PATCH, then you're not writing</span></div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(method + <span class="string">" does not support writing"</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 将newHttpEngine方法的返回值赋值给HttpEngine的成员变量。</span></div><div class="line">      httpEngine = newHttpEngine(method, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      httpEngineFailure = e;</div><div class="line">      <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> HttpEngine <span class="title">newHttpEngine</span><span class="params">(String method, Connection connection,</span></span></div><div class="line">      RetryableSink requestBody) &#123;</div><div class="line">    Request.Builder builder = <span class="keyword">new</span> Request.Builder()</div><div class="line">        .url(getURL())</div><div class="line">        .method(method, <span class="keyword">null</span> <span class="comment">/* No body; that's passed separately. */</span>);</div><div class="line">    Headers headers = requestHeaders.build();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; headers.size(); i++) &#123;</div><div class="line">      builder.addHeader(headers.name(i), headers.value(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> bufferRequestBody;</div><div class="line">    <span class="keyword">if</span> (fixedContentLength != -<span class="number">1</span>) &#123;</div><div class="line">      bufferRequestBody = <span class="keyword">false</span>;</div><div class="line">      builder.header(<span class="string">"Content-Length"</span>, Long.toString(fixedContentLength));</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chunkLength &gt; <span class="number">0</span>) &#123;</div><div class="line">      bufferRequestBody = <span class="keyword">false</span>;</div><div class="line">      builder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      bufferRequestBody = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request request = builder.build();</div><div class="line"></div><div class="line">    <span class="comment">// If we're currently not using caches, make sure the engine's client doesn't have one.</span></div><div class="line">    OkHttpClient engineClient = client;</div><div class="line">    <span class="keyword">if</span> (engineClient.getOkResponseCache() != <span class="keyword">null</span> &amp;&amp; !getUseCaches()) &#123;</div><div class="line">      engineClient = client.clone().setOkResponseCache(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 将之前通过构造函数传递进来的OkHttpClient对象clone一份后再传递给HttpEngine</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpEngine(engineClient, request, bufferRequestBody, connection, <span class="keyword">null</span>, requestBody);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>到这里我们知道他会创建一个<code>HttpEngine</code>类，我们先不管它，接着看一下<code>execute()</code>方法的内部实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Sends a request and optionally reads a response. Returns true if the</div><div class="line">* request was successfully executed, and false if the request can be</div><div class="line">* retried. Throws an exception if the request failed permanently.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">boolean</span> readResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="comment">// 调用了HttpEngine的sendRequest方法。</span></div><div class="line">  httpEngine.sendRequest();</div><div class="line">  route = httpEngine.getRoute();</div><div class="line">  handshake = httpEngine.getConnection() != <span class="keyword">null</span></div><div class="line">      ? httpEngine.getConnection().getHandshake()</div><div class="line">      : <span class="keyword">null</span>;</div><div class="line">  <span class="comment">// 读取结果，我们先不分析这里，等把sendRequest部分全部分析完成后再回来分析readResponse()部分。</span></div><div class="line">  <span class="keyword">if</span> (readResponse) &#123;</div><div class="line">    httpEngine.readResponse();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">  HttpEngine retryEngine = httpEngine.recover(e);</div><div class="line">  <span class="keyword">if</span> (retryEngine != <span class="keyword">null</span>) &#123;</div><div class="line">    httpEngine = retryEngine;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Give up; recovery is not possible.</span></div><div class="line">  httpEngineFailure = e;</div><div class="line">  <span class="keyword">throw</span> e;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里，可以大胆的猜测一下了<code>HttpEngine</code>应该就是实际在<code>Socket</code>链接上进行数据收发的类。 当然这只是猜测，接着看一下它的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Handles a single HTTP request/response pair. Each HTTP engine follows this</div><div class="line"> * lifecycle:</div><div class="line"> * &lt;ol&gt;</div><div class="line"> * &lt;li&gt;It is created.</div><div class="line"> * &lt;li&gt;The HTTP request message is sent with sendRequest(). Once the request</div><div class="line"> * is sent it is an error to modify the request headers. After</div><div class="line"> * sendRequest() has been called the request body can be written to if</div><div class="line"> * it exists.</div><div class="line"> * &lt;li&gt;The HTTP response message is read with readResponse(). After the</div><div class="line"> * response has been read the response headers and body can be read.</div><div class="line"> * All responses have a response body input stream, though in some</div><div class="line"> * instances this stream is empty.</div><div class="line"> * &lt;/ol&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;The request and response may be served by the HTTP response cache, by the</div><div class="line"> * network, or by both in the event of a conditional GET.</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>文档验证了我们的想法。因为它内部实现代码比较多，所以就不全部贴了，按照重要的一步步分析，既然上面调用了<code>sendRequest()</code>方法，这里就从他入手：　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Figures out what the response source will be, and opens a socket to that</div><div class="line">* source if necessary. Prepares the request headers and gets ready to start</div><div class="line">* writing the request body if it exists.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="keyword">if</span> (responseSource != <span class="keyword">null</span>) <span class="keyword">return</span>; <span class="comment">// Already sent.</span></div><div class="line">	<span class="keyword">if</span> (transport != <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line"></div><div class="line">	<span class="comment">// 设置一些请求头，正式这个方法内部默认设置了`Keep-Alive`的值，也就是在Android Level 9之前因为Bug，我们需要关闭它的具体处理位置。   </span></div><div class="line">	prepareRawRequestHeaders();</div><div class="line">	<span class="comment">// 处理cache</span></div><div class="line">	OkResponseCache responseCache = client.getOkResponseCache();</div><div class="line"></div><div class="line">	Response cacheResponse = responseCache != <span class="keyword">null</span></div><div class="line">		? responseCache.get(request)</div><div class="line">		: <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">	CacheStrategy cacheStrategy = <span class="keyword">new</span> CacheStrategy.Factory(now, request, cacheResponse).get();</div><div class="line">	responseSource = cacheStrategy.source;</div><div class="line">	request = cacheStrategy.request;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (responseCache != <span class="keyword">null</span>) &#123;</div><div class="line">	  <span class="comment">// 记录下当前的请求是来自网络请求还是来时缓存中的数据。</span></div><div class="line">	  responseCache.trackResponse(responseSource);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (responseSource != ResponseSource.NETWORK) &#123;</div><div class="line">	  validatingResponse = cacheStrategy.response;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (cacheResponse != <span class="keyword">null</span> &amp;&amp; !responseSource.usesCache()) &#123;</div><div class="line">	  closeQuietly(cacheResponse.body()); <span class="comment">// We don't need this cached response. Close it.</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (responseSource.requiresConnection()) &#123;</div><div class="line">	  <span class="comment">// Open a connection unless we inherited one from a redirect.</span></div><div class="line">	  <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 调用connect方法，内部会重新创建一个connection，连接到服务器、重定向或者通过代理。</span></div><div class="line">		connect();</div><div class="line">	  &#125;</div><div class="line">	  <span class="comment">// 通过Connection创建一个HttpTransport类。这个和后面的connection类一起看， Transport接口提供了一个用户写Request头和数据的输出流。</span></div><div class="line">	  transport = (Transport) connection.newTransport(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">	  <span class="comment">// Create a request body if we don't have one already. We'll already have</span></div><div class="line">	  <span class="comment">// one if we're retrying a failed POST.</span></div><div class="line">	  <span class="keyword">if</span> (hasRequestBody() &amp;&amp; requestBodyOut == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 通过transport创建一个请求体的输出流，requestBodyOut是Sink接口的实现类，其实就是将请求头和请求体发送给服务器。这部分跟下去内容比较多，就不往下跟了。</span></div><div class="line">	　　　　<span class="comment">// 到这里就已经完成了与服务器的连接功能，并且把请求内容发送给服务器。请求部分就执行完了，可以回去了，还知道开头是哪吗？哈哈。接下来的就是从服务器接口读取返回数据了。  </span></div><div class="line">		requestBodyOut = transport.createRequestBody(request);</div><div class="line">	  &#125;</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	  <span class="comment">// We're using a cached response. Recycle a connection we may have inherited from a redirect.</span></div><div class="line">	  <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 回收connection，这里就看到了连接池，这个client就是构造函数中传递进来的OKHttpClient</span></div><div class="line">		client.getConnectionPool().recycle(connection);</div><div class="line">		connection = <span class="keyword">null</span>;</div><div class="line">	  &#125;</div><div class="line"></div><div class="line">	  <span class="comment">// No need for the network! Promote the cached response immediately.</span></div><div class="line">	  <span class="keyword">this</span>.response = validatingResponse;</div><div class="line">	  <span class="keyword">if</span> (validatingResponse.body() != <span class="keyword">null</span>) &#123;</div><div class="line">		initContentStream(validatingResponse.body().source());</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>connect()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Connect to the origin server either directly or via a proxy. */</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="keyword">if</span> (connection != <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (routeSelector == <span class="keyword">null</span>) &#123;</div><div class="line">	  String uriHost = request.url().getHost();</div><div class="line">	  <span class="keyword">if</span> (uriHost == <span class="keyword">null</span> || uriHost.length() == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnknownHostException(request.url().toString());</div><div class="line">	  &#125;</div><div class="line">	  SSLSocketFactory sslSocketFactory = <span class="keyword">null</span>;</div><div class="line">	  HostnameVerifier hostnameVerifier = <span class="keyword">null</span>;</div><div class="line">	  <span class="keyword">if</span> (request.isHttps()) &#123;</div><div class="line">		sslSocketFactory = client.getSslSocketFactory();</div><div class="line">		hostnameVerifier = client.getHostnameVerifier();</div><div class="line">	  &#125;</div><div class="line">	  Address address = <span class="keyword">new</span> Address(uriHost, getEffectivePort(request.url()), sslSocketFactory,</div><div class="line">		  hostnameVerifier, client.getAuthenticator(), client.getProxy(), client.getProtocols());</div><div class="line">	  <span class="comment">// RoteSeclector类介绍. Selects routes to connect to an origin server. Each connection requires a</span></div><div class="line">	  <span class="comment">// choice of proxy server, IP address, and TLS mode. Connections may also be</span></div><div class="line">	  <span class="comment">// recycled.注意他把OkHttpClient中的connection pool传递进来了。</span></div><div class="line">	  routeSelector = <span class="keyword">new</span> RouteSelector(address, request.uri(), client.getProxySelector(),</div><div class="line">		  client.getConnectionPool(), Dns.DEFAULT, client.getRoutesDatabase());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// roteSeclecrot.next()方法的注释Returns the next route address to attempt.这一步非常重要。</span></div><div class="line">	connection = routeSelector.next(request.method());</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!connection.isConnected()) &#123;</div><div class="line">	  <span class="comment">// connection 进行连接了啊。他里面会用Socket开始连了。。后面我们再细看。简单的说Connection管理了Socket，后面我们要重点看这个类。</span></div><div class="line">	  connection.connect(client.getConnectTimeout(), client.getReadTimeout(), getTunnelConfig());</div><div class="line">	  <span class="keyword">if</span> (connection.isSpdy()) client.getConnectionPool().share(connection);</div><div class="line">	  client.getRoutesDatabase().connected(connection.getRoute());</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!connection.isSpdy()) &#123;</div><div class="line">	  connection.updateReadTimeout(client.getReadTimeout());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	route = connection.getRoute();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们要先看一下routeSelector.next()方法如何返回connection对象，然后在看Connection.connect()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Returns the next route address to attempt.</div><div class="line">*</div><div class="line">* <span class="doctag">@throws</span> NoSuchElementException if there are no more routes to attempt.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">next</span><span class="params">(String method)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// 使用连接池获取Connection的地方。pool就是OkHttpClient中的连接池。</span></div><div class="line">	<span class="comment">// Always prefer pooled connections over new connections.</span></div><div class="line">	<span class="keyword">for</span> (Connection pooled; (pooled = pool.get(address)) != <span class="keyword">null</span>; ) &#123;</div><div class="line">	  <span class="comment">// 匹配get方法，或者判断是否可读，http1.x是通过判断socket是否关闭来判断是否可读的。</span></div><div class="line">	  <span class="keyword">if</span> (method.equals(<span class="string">"GET"</span>) || pooled.isReadable()) <span class="keyword">return</span> pooled;</div><div class="line">	  <span class="comment">// 不满足重用，就关闭。</span></div><div class="line">	  pooled.close();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Compute the next route to attempt.</span></div><div class="line">	<span class="keyword">if</span> (!hasNextTlsMode()) &#123;</div><div class="line">	  <span class="keyword">if</span> (!hasNextInetSocketAddress()) &#123;</div><div class="line">		<span class="keyword">if</span> (!hasNextProxy()) &#123;</div><div class="line">		  <span class="keyword">if</span> (!hasNextPostponed()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line">		  &#125;</div><div class="line">		  <span class="keyword">return</span> <span class="keyword">new</span> Connection(pool, nextPostponed());</div><div class="line">		&#125;</div><div class="line">		lastProxy = nextProxy();</div><div class="line">		resetNextInetSocketAddress(lastProxy);</div><div class="line">	  &#125;</div><div class="line">	  lastInetSocketAddress = nextInetSocketAddress();</div><div class="line">	  resetNextTlsMode();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> modernTls = nextTlsMode() == TLS_MODE_MODERN;</div><div class="line">	Route route = <span class="keyword">new</span> Route(address, lastProxy, lastInetSocketAddress, modernTls);</div><div class="line">	<span class="keyword">if</span> (routeDatabase.shouldPostpone(route)) &#123;</div><div class="line">	  postponedRoutes.add(route);</div><div class="line">	  <span class="comment">// We will only recurse in order to skip previously failed routes. They will be</span></div><div class="line">	  <span class="comment">// tried last.</span></div><div class="line">	  <span class="keyword">return</span> next(method);</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// 没有的话也会去创建，并把OkHttpClient中的连接池传递进去。</span></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Connection(pool, route);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>Connection</code>类的实现以及其<code>connect()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Connection</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPool pool;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Route route;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Socket socket;</div><div class="line">  <span class="keyword">private</span> InputStream in;</div><div class="line">  <span class="keyword">private</span> OutputStream out;</div><div class="line">  <span class="keyword">private</span> BufferedSource source;</div><div class="line">  <span class="keyword">private</span> BufferedSink sink;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> connected = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">private</span> HttpConnection httpConnection;</div><div class="line">  <span class="keyword">private</span> SpdyConnection spdyConnection;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> httpMinorVersion = <span class="number">1</span>; <span class="comment">// Assume HTTP/1.1</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">long</span> idleStartTimeNs;</div><div class="line">  <span class="keyword">private</span> Handshake handshake;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> recycleCount;</div><div class="line">  <span class="comment">// 传递进来的连接池。</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Connection</span><span class="params">(ConnectionPool pool, Route route)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.pool = pool;</div><div class="line">    <span class="keyword">this</span>.route = route;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> connectTimeout, <span class="keyword">int</span> readTimeout, TunnelRequest tunnelRequest)</span></span></div><div class="line">      <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="keyword">if</span> (connected) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"already connected"</span>);</div><div class="line"></div><div class="line">    socket = (route.proxy.type() != Proxy.Type.HTTP) ? <span class="keyword">new</span> Socket(route.proxy) : <span class="keyword">new</span> Socket();</div><div class="line">    <span class="comment">// 连socket了，内部调用了socket.connect()方法。Connects this socket to the given remote host address and port specified</span></div><div class="line">    <span class="comment">// by the SocketAddress &#123;@code remoteAddr&#125; with the specified timeout. The</span></div><div class="line">    <span class="comment">// connecting method will block until the connection is established or an</span></div><div class="line">    <span class="comment">// error occurred.</span></div><div class="line">    Platform.get().connectSocket(socket, route.inetSocketAddress, connectTimeout);</div><div class="line">    socket.setSoTimeout(readTimeout);</div><div class="line">    in = socket.getInputStream();</div><div class="line">    out = socket.getOutputStream();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (route.address.sslSocketFactory != <span class="keyword">null</span>) &#123;</div><div class="line">	  <span class="comment">// 完成TLS握手和验证</span></div><div class="line">      upgradeToTls(tunnelRequest);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      initSourceAndSink();</div><div class="line">      <span class="comment">// 创建HttpConnection.A socket connection that can be used to send HTTP/1.1 messages. </span></div><div class="line">      <span class="comment">// 这个HttpConnection有什么用呢？就是下面的newTransport方法中会用。而且还要把连接池传递进去？</span></div><div class="line">      httpConnection = <span class="keyword">new</span> HttpConnection(pool, <span class="keyword">this</span>, source, sink);</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 这样就已经连接上了</span></div><div class="line">    connected = <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 该方法决定了使用的协议是SPDY还是HTTP</span></div><div class="line">  <span class="comment">/** Returns the transport appropriate for this connection. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newTransport</span><span class="params">(HttpEngine httpEngine)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> (spdyConnection != <span class="keyword">null</span>)</div><div class="line">        ? <span class="keyword">new</span> SpdyTransport(httpEngine, spdyConnection)</div><div class="line">        : <span class="keyword">new</span> HttpTransport(httpEngine, httpConnection);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里就已经把发送请求到服务器的部分全部分析完了，就想上面所说的我们应该回去了，回去分析发送完请求后的部分。<br>我们这个分析是在<code>HttpURLConnectionImpl.execute()</code>方法中的<code>HttpEngine.sendRequest()</code>方法开始一直分析下来的，<br>所以我们还是要回到<code>HttpURLConnectionImpl.execute()</code>方法中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">(<span class="keyword">boolean</span> readResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="comment">// 上面已经把sendRequest部分全部分析完了，该方法会与服务器通过Socket建立连接并把请求部分发送给服务器。</span></div><div class="line">  httpEngine.sendRequest();</div><div class="line">  route = httpEngine.getRoute();</div><div class="line">  handshake = httpEngine.getConnection() != <span class="keyword">null</span></div><div class="line">      ? httpEngine.getConnection().getHandshake()</div><div class="line">      : <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">if</span> (readResponse) &#123;</div><div class="line">    <span class="comment">// 发送完请求之后该干什么呢？ 当然是读取返回数据了。。。 没错就是它。但是不要忘了在connect()方法传递过来的时候这个值是false。</span></div><div class="line">    <span class="comment">// 所以这一步在这里是不执行的，但是我们也分析下，方便以后理解。那这个值什么时候是true呢？就是在getResponse()方法中。</span></div><div class="line">    httpEngine.readResponse();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">  HttpEngine retryEngine = httpEngine.recover(e);</div><div class="line">  <span class="keyword">if</span> (retryEngine != <span class="keyword">null</span>) &#123;</div><div class="line">    httpEngine = retryEngine;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Give up; recovery is not possible.</span></div><div class="line">  httpEngineFailure = e;</div><div class="line">  <span class="keyword">throw</span> e;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看<code>HttpEngine.readResponse()</code>方法吧。注释说的非常明白。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Flushes the remaining request header and body, parses the HTTP response</div><div class="line">* headers and starts reading the HTTP response body if it exists.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">readResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="keyword">if</span> (response != <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"><span class="keyword">if</span> (responseSource == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"call sendRequest() first!"</span>);</div><div class="line"><span class="keyword">if</span> (!responseSource.requiresConnection()) <span class="keyword">return</span>;</div><div class="line"></div><div class="line"><span class="comment">// Flush the request body if there's data outstanding.</span></div><div class="line"><span class="keyword">if</span> (bufferedRequestBody != <span class="keyword">null</span> &amp;&amp; bufferedRequestBody.buffer().size() &gt; <span class="number">0</span>) &#123;</div><div class="line">  bufferedRequestBody.flush();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (sentRequestMillis == -<span class="number">1</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (OkHeaders.contentLength(request) == -<span class="number">1</span> &amp;&amp; requestBodyOut <span class="keyword">instanceof</span> RetryableSink) &#123;</div><div class="line">    <span class="comment">// We might not learn the Content-Length until the request body has been buffered.</span></div><div class="line">    <span class="keyword">long</span> contentLength = ((RetryableSink) requestBodyOut).contentLength();</div><div class="line">    request = request.newBuilder()</div><div class="line">        .header(<span class="string">"Content-Length"</span>, Long.toString(contentLength))</div><div class="line">        .build();</div><div class="line">  &#125;</div><div class="line">  transport.writeRequestHeaders(request);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (requestBodyOut != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (bufferedRequestBody != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">// This also closes the wrapped requestBodyOut.</span></div><div class="line">    bufferedRequestBody.close();</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    requestBodyOut.close();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (requestBodyOut <span class="keyword">instanceof</span> RetryableSink) &#123;</div><div class="line">    transport.writeRequestBody((RetryableSink) requestBodyOut);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">transport.flushRequest();</div><div class="line"></div><div class="line">response = transport.readResponseHeaders()</div><div class="line">    .request(request)</div><div class="line">    .handshake(connection.getHandshake())</div><div class="line">    .header(OkHeaders.SENT_MILLIS, Long.toString(sentRequestMillis))</div><div class="line">    .header(OkHeaders.RECEIVED_MILLIS, Long.toString(System.currentTimeMillis()))</div><div class="line">    .setResponseSource(responseSource)</div><div class="line">    .build();</div><div class="line">connection.setHttpMinorVersion(response.httpMinorVersion());</div><div class="line">receiveHeaders(response.headers());</div><div class="line"></div><div class="line"><span class="keyword">if</span> (responseSource == ResponseSource.CONDITIONAL_CACHE) &#123;</div><div class="line">  <span class="comment">// 检查缓存是否可用，如果可用就用当前缓存的response。并且释放该连接。</span></div><div class="line">  <span class="keyword">if</span> (validatingResponse.validate(response)) &#123;</div><div class="line">    transport.emptyTransferStream();</div><div class="line">    releaseConnection();</div><div class="line">    response = combine(validatingResponse, response);</div><div class="line"></div><div class="line">    <span class="comment">// Update the cache after combining headers but before stripping the</span></div><div class="line">    <span class="comment">// Content-Encoding header (as performed by initContentStream()).</span></div><div class="line">    OkResponseCache responseCache = client.getOkResponseCache();</div><div class="line">    responseCache.trackConditionalCacheHit();</div><div class="line">    responseCache.update(validatingResponse, cacheableResponse());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (validatingResponse.body() != <span class="keyword">null</span>) &#123;</div><div class="line">      initContentStream(validatingResponse.body().source());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    closeQuietly(validatingResponse.body());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!hasResponseBody()) &#123;</div><div class="line">  <span class="comment">// Don't call initContentStream() when the response doesn't have any content.</span></div><div class="line">  responseTransferSource = transport.getTransferStream(cacheRequest);</div><div class="line">  responseBody = responseTransferSource;</div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 设置cacheRequest的值</span></div><div class="line">maybeCache();</div><div class="line"><span class="comment">// 设置返回数据了，transport这里也就是HttpTransport。他的getTransferStream返回的是一个Source接口的实现类。也就是返回的数据。</span></div><div class="line">initContentStream(transport.getTransferStream(cacheRequest));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先看一下maybeCache()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeCache</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">OkResponseCache responseCache = client.getOkResponseCache();</div><div class="line"><span class="keyword">if</span> (responseCache == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line"><span class="comment">// Should we cache this response for this request?</span></div><div class="line"><span class="keyword">if</span> (!CacheStrategy.isCacheable(response, request)) &#123;</div><div class="line">  responseCache.maybeRemove(request);</div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Offer this request to the cache.</span></div><div class="line">cacheRequest = responseCache.put(cacheableResponse());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>initContentStream()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Initialize the response content stream from the response transfer source.</div><div class="line">* These two sources are the same unless we're doing transparent gzip, in</div><div class="line">* which case the content source is decompressed.</div><div class="line">*</div><div class="line">* &lt;p&gt;Whenever we do transparent gzip we also strip the corresponding headers.</div><div class="line">* We strip the Content-Encoding header to prevent the application from</div><div class="line">* attempting to double decompress. We strip the Content-Length header because</div><div class="line">* it is the length of the compressed content, but the application is only</div><div class="line">* interested in the length of the uncompressed content.</div><div class="line">*</div><div class="line">* &lt;p&gt;This method should only be used for non-empty response bodies. Response</div><div class="line">* codes like "304 Not Modified" can include "Content-Encoding: gzip" without</div><div class="line">* a response body and we will crash if we attempt to decompress the zero-byte</div><div class="line">* source.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initContentStream</span><span class="params">(Source transferSource)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">responseTransferSource = transferSource;</div><div class="line"><span class="keyword">if</span> (transparentGzip &amp;&amp; <span class="string">"gzip"</span>.equalsIgnoreCase(response.header(<span class="string">"Content-Encoding"</span>))) &#123; </div><div class="line">  <span class="comment">// 没有结果时response为null，有结果了就会给他赋值。</span></div><div class="line">  response = response.newBuilder()</div><div class="line">      .removeHeader(<span class="string">"Content-Encoding"</span>)</div><div class="line">      .removeHeader(<span class="string">"Content-Length"</span>)</div><div class="line">      .build();</div><div class="line">  responseBody = <span class="keyword">new</span> GzipSource(transferSource);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  responseBody = transferSource;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里又执行完了，responseBody已经被赋值了，他是一个Source接口的实现类。也就是说到这里，这次网络请求就完成了，也收到了服务器返回的数据。</p>
<p>也就是说到这里我们已经分析了:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HttpURLConnection connection = (HttpURLConnection)<span class="keyword">new</span> URL(url).openConnection();</div><div class="line">connection.connect();</div></pre></td></tr></table></figure>
<p>接下来就是分析<code>connection.getResponseCode()</code>以及<code>connection.getOutputStream()</code>这两个方法了。<br>先看一下<code>getResponseCode()</code>方法：　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getResponseCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="comment">// 看到了吗？这里就是刚才我们说的execute()方法的参数什么时候会为true的地方。</span></div><div class="line"><span class="keyword">return</span> getResponse().getResponse().code();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那我们接着看一下<code>getResponse()</code>方法，其实就是直接读取响应头的响应值：　　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Aggressively tries to get the final HTTP response, potentially making</div><div class="line">* many HTTP requests in the process in order to cope with redirects and</div><div class="line">* authentication.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> HttpEngine <span class="title">getResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">initHttpEngine();</div><div class="line"></div><div class="line"><span class="comment">// 如果已经有返回数据了就直接返回</span></div><div class="line"><span class="keyword">if</span> (httpEngine.hasResponse()) &#123;</div><div class="line">  <span class="keyword">return</span> httpEngine;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">  <span class="comment">// 参数为true了。</span></div><div class="line">  <span class="keyword">if</span> (!execute(<span class="keyword">true</span>)) &#123;</div><div class="line">    <span class="keyword">continue</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Retry retry = processResponseHeaders();</div><div class="line">  <span class="keyword">if</span> (retry == Retry.NONE) &#123;</div><div class="line">    httpEngine.releaseConnection();</div><div class="line">    <span class="keyword">return</span> httpEngine;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// The first request was insufficient. Prepare for another...</span></div><div class="line">  String retryMethod = method;</div><div class="line">  Sink requestBody = httpEngine.getRequestBody();</div><div class="line"></div><div class="line">  <span class="comment">// Although RFC 2616 10.3.2 specifies that a HTTP_MOVED_PERM</span></div><div class="line">  <span class="comment">// redirect should keep the same method, Chrome, Firefox and the</span></div><div class="line">  <span class="comment">// RI all issue GETs when following any redirect.</span></div><div class="line">  <span class="keyword">int</span> responseCode = httpEngine.getResponse().code();</div><div class="line">  <span class="keyword">if</span> (responseCode == HTTP_MULT_CHOICE</div><div class="line">      || responseCode == HTTP_MOVED_PERM</div><div class="line">      || responseCode == HTTP_MOVED_TEMP</div><div class="line">      || responseCode == HTTP_SEE_OTHER) &#123;</div><div class="line">    retryMethod = <span class="string">"GET"</span>;</div><div class="line">    requestHeaders.removeAll(<span class="string">"Content-Length"</span>);</div><div class="line">    requestBody = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (requestBody != <span class="keyword">null</span> &amp;&amp; !(requestBody <span class="keyword">instanceof</span> RetryableSink)) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpRetryException(<span class="string">"Cannot retry streamed HTTP body"</span>, responseCode);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (retry == Retry.DIFFERENT_CONNECTION) &#123;</div><div class="line">    httpEngine.releaseConnection();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Connection connection = httpEngine.close();</div><div class="line">  httpEngine = newHttpEngine(retryMethod, connection, (RetryableSink) requestBody);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>getOutputStream()</code>的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> OutputStream <span class="title">getOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="comment">// 看到了吗？他内部会先去调用connect()方法</span></div><div class="line">connect();</div><div class="line"></div><div class="line">　  <span class="comment">// 这里可能有人会有说，getOutputStream和request body有什么关系，应该是response body才对啊。</span></div><div class="line"><span class="comment">// 不要弄混了啊，getOutputStream是要把post请求的数据输入给请求。</span></div><div class="line">BufferedSink sink = httpEngine.getBufferedRequestBody();</div><div class="line"><span class="keyword">if</span> (sink == <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"method does not support a request body: "</span> + method);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (httpEngine.hasResponse()) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"cannot write request body after response has been read"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> sink.outputStream();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>顺便再看一下<code>getInputStream()</code>方法：     　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="keyword">if</span> (!doInput) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"This protocol does not support input"</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 它也会直接调用getResponse()方法，这个比较好理解。</span></div><div class="line">HttpEngine response = getResponse();</div><div class="line"></div><div class="line"><span class="comment">// if the requested file does not exist, throw an exception formerly the</span></div><div class="line"><span class="comment">// Error page from the server was returned if the requested file was</span></div><div class="line"><span class="comment">// text/html this has changed to return FileNotFoundException for all</span></div><div class="line"><span class="comment">// file types</span></div><div class="line"><span class="keyword">if</span> (getResponseCode() &gt;= HTTP_BAD_REQUEST) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(url.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line">InputStream result = response.getResponseBodyBytes();</div><div class="line"><span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"No response body exists; responseCode="</span> + getResponseCode());</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再顺便看一下<code>HttpURLConnection.disconnect()</code>方法，因为这个方法可能很多人不清楚该不该调用他,不过注释说的很明白了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Releases this connection so that its resources may be either reused or</div><div class="line"> * closed.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Unlike other Java implementations, this will not necessarily close</div><div class="line"> * socket connections that can be reused. You can disable all connection</div><div class="line"> * reuse by setting the &#123;<span class="doctag">@code</span> http.keepAlive&#125; system property to &#123;<span class="doctag">@code</span></div><div class="line"> * false&#125; before issuing any HTTP requests.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="comment">// Calling disconnect() before a connection exists should have no effect.</span></div><div class="line"><span class="keyword">if</span> (httpEngine != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="comment">// 调用HttpEngine.close()方法</span></div><div class="line">  httpEngine.close();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看一下HttpEngine.close()方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Release any resources held by this engine. If a connection is still held by</div><div class="line">* this engine, it is returned.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Connection <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (bufferedRequestBody != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="comment">// This also closes the wrapped requestBodyOut.</span></div><div class="line">  closeQuietly(bufferedRequestBody);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestBodyOut != <span class="keyword">null</span>) &#123;</div><div class="line">  closeQuietly(requestBodyOut);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// If this engine never achieved a response body, its connection cannot be reused.</span></div><div class="line"><span class="keyword">if</span> (responseBody == <span class="keyword">null</span>) &#123;</div><div class="line">  closeQuietly(connection);</div><div class="line">  connection = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Close the response body. This will recycle the connection if it is eligible.</span></div><div class="line">closeQuietly(responseBody);</div><div class="line"></div><div class="line"><span class="comment">// Clear the buffer held by the response body input stream adapter.</span></div><div class="line">closeQuietly(responseBodyBytes);</div><div class="line"></div><div class="line"><span class="comment">// HttpTransport.canReuseConnection()用于判断该Connection是否可复用</span></div><div class="line"><span class="comment">// Close the connection if it cannot be reused.</span></div><div class="line"><span class="keyword">if</span> (transport != <span class="keyword">null</span> &amp;&amp; !transport.canReuseConnection()) &#123;</div><div class="line">  closeQuietly(connection);</div><div class="line">  connection = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Connection result = connection;</div><div class="line">connection = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下closeQuietly(connection)方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Closes &#123;<span class="doctag">@code</span> closeable&#125;, ignoring any checked exceptions. Does nothing</div><div class="line">* if &#123;<span class="doctag">@code</span> closeable&#125; is null.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeQuietly</span><span class="params">(Closeable closeable)</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (closeable != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 这里也就是Connection的close()方法</span></div><div class="line">    closeable.close();</div><div class="line">  &#125; <span class="keyword">catch</span> (RuntimeException rethrown) &#123;</div><div class="line">    <span class="keyword">throw</span> rethrown;</div><div class="line">  &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再接着看一下Connection.close()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"><span class="comment">// 直接调用了socket.close()方法。这些socket也关了。</span></div><div class="line">socket.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看Socket.close()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.squareup.okhttp;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Closes the socket. It is not possible to reconnect or rebind to this</div><div class="line"> * socket thereafter which means a new socket instance has to be created.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IOException</div><div class="line"> *             if an error occurs while closing the socket.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    isClosed = <span class="keyword">true</span>;</div><div class="line">    isConnected = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">// RI compatibility: the RI returns the any address (but the original local port) after</span></div><div class="line">    <span class="comment">// close.</span></div><div class="line">    localAddress = Inet4Address.ANY;</div><div class="line">    impl.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里就都看完了，最后我们再看一下上面用到的连接池，也就是<code>ConnectionPool</code>类:  因为在上面的分析中，我们发现此类贯穿了很多类。<br>它为<code>OkHttpClient</code>中的对象，后贯穿到<code>HttpEngine</code>、<code>Connection</code>、<code>HttpConnection</code>等。所以要分析下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Manages reuse of HTTP and SPDY connections for reduced network latency. HTTP</div><div class="line"> * requests that share the same &#123;<span class="doctag">@link</span> com.squareup.okhttp.Address&#125; may share a</div><div class="line"> * &#123;<span class="doctag">@link</span> com.squareup.okhttp.Connection&#125;. This class implements the policy of</div><div class="line"> * which connections to keep open for future use.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;The &#123;<span class="doctag">@link</span> #getDefault() system-wide default&#125; uses system properties for</div><div class="line"> * tuning parameters:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> *     &lt;li&gt;&#123;<span class="doctag">@code</span> http.keepAlive&#125; true if HTTP and SPDY connections should be</div><div class="line"> *         pooled at all. Default is true.</div><div class="line"> *     &lt;li&gt;&#123;<span class="doctag">@code</span> http.maxConnections&#125; maximum number of idle connections to</div><div class="line"> *         each to keep in the pool. Default is 5.</div><div class="line"> *     &lt;li&gt;&#123;<span class="doctag">@code</span> http.keepAliveDuration&#125; Time in milliseconds to keep the</div><div class="line"> *         connection alive in the pool before closing it. Default is 5 minutes.</div><div class="line"> *         This property isn't used by &#123;<span class="doctag">@code</span> HttpURLConnection&#125;.</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;The default instance &lt;i&gt;doesn't&lt;/i&gt; adjust its configuration as system</div><div class="line"> * properties are changed. This assumes that the applications that set these</div><div class="line"> * parameters do so before making HTTP connections, and that this class is</div><div class="line"> * initialized lazily.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionPool</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_CONNECTIONS_TO_CLEANUP = <span class="number">2</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_KEEP_ALIVE_DURATION_MS = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 5 min</span></div><div class="line"></div><div class="line">  <span class="comment">// 这个就是getDefault方法所返回的默认连接池。</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConnectionPool systemDefault;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> &#123;</div><div class="line">    String keepAlive = System.getProperty(<span class="string">"http.keepAlive"</span>);</div><div class="line">	<span class="comment">// 存活时间</span></div><div class="line">    String keepAliveDuration = System.getProperty(<span class="string">"http.keepAliveDuration"</span>);</div><div class="line">	<span class="comment">// 最大空闲连接数</span></div><div class="line">    String maxIdleConnections = System.getProperty(<span class="string">"http.maxConnections"</span>);</div><div class="line">    <span class="keyword">long</span> keepAliveDurationMs = keepAliveDuration != <span class="keyword">null</span> ? Long.parseLong(keepAliveDuration)</div><div class="line">        : DEFAULT_KEEP_ALIVE_DURATION_MS;</div><div class="line">    <span class="keyword">if</span> (keepAlive != <span class="keyword">null</span> &amp;&amp; !Boolean.parseBoolean(keepAlive)) &#123;</div><div class="line">      systemDefault = <span class="keyword">new</span> ConnectionPool(<span class="number">0</span>, keepAliveDurationMs);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxIdleConnections != <span class="keyword">null</span>) &#123;</div><div class="line">      systemDefault = <span class="keyword">new</span> ConnectionPool(Integer.parseInt(maxIdleConnections), keepAliveDurationMs);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      systemDefault = <span class="keyword">new</span> ConnectionPool(<span class="number">5</span>, keepAliveDurationMs);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** The maximum number of idle connections for each address. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxIdleConnections;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> keepAliveDurationNs;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;Connection&gt; connections = <span class="keyword">new</span> LinkedList&lt;Connection&gt;();</div><div class="line"></div><div class="line">  <span class="comment">// 连接的有效性检测是所有连接池都面临的一个通用问题，大部分HTTP服务器为了控制资源开销，并不会永久的维护一个长连接，而是一段时间就会关闭该连接。</span></div><div class="line">  <span class="comment">// 放回连接池的连接，如果在服务器端已经关闭，客户端是无法检测到这个状态变化而及时的关闭Socket的。这就造成了线程从连接池中获取的连接不一定是有效的。</span></div><div class="line">  <span class="comment">// 这个问题的一个解决方法就是在每次请求之前检查该连接是否已经存在了过长时间，可能已过期。但是这个方法会使得每次请求都增加额外的开销。</span></div><div class="line">  <span class="comment">// 所以通过下面的任务来执行清理过期的连接。</span></div><div class="line">  <span class="comment">/** We use a single background thread to cleanup expired connections. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, <span class="number">1</span>,</div><div class="line">      <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</div><div class="line">      Util.threadFactory(<span class="string">"OkHttp ConnectionPool"</span>, <span class="keyword">true</span>));</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Runnable connectionsCleanupRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      List&lt;Connection&gt; expiredConnections = <span class="keyword">new</span> ArrayList&lt;Connection&gt;(MAX_CONNECTIONS_TO_CLEANUP);</div><div class="line">      <span class="keyword">int</span> idleConnectionCount = <span class="number">0</span>;</div><div class="line">      <span class="keyword">synchronized</span> (ConnectionPool.<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (ListIterator&lt;Connection&gt; i = connections.listIterator(connections.size());</div><div class="line">            i.hasPrevious(); ) &#123;</div><div class="line">          Connection connection = i.previous();</div><div class="line">          <span class="keyword">if</span> (!connection.isAlive() || connection.isExpired(keepAliveDurationNs)) &#123;</div><div class="line">            i.remove();</div><div class="line">            expiredConnections.add(connection);</div><div class="line">            <span class="keyword">if</span> (expiredConnections.size() == MAX_CONNECTIONS_TO_CLEANUP) <span class="keyword">break</span>;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (connection.isIdle()) &#123;</div><div class="line">            idleConnectionCount++;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (ListIterator&lt;Connection&gt; i = connections.listIterator(connections.size());</div><div class="line">            i.hasPrevious() &amp;&amp; idleConnectionCount &gt; maxIdleConnections; ) &#123;</div><div class="line">          Connection connection = i.previous();</div><div class="line">          <span class="keyword">if</span> (connection.isIdle()) &#123;</div><div class="line">            expiredConnections.add(connection);</div><div class="line">            i.remove();</div><div class="line">            --idleConnectionCount;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (Connection expiredConnection : expiredConnections) &#123;</div><div class="line">        Util.closeQuietly(expiredConnection);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ConnectionPool</span><span class="params">(<span class="keyword">int</span> maxIdleConnections, <span class="keyword">long</span> keepAliveDurationMs)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.maxIdleConnections = maxIdleConnections;</div><div class="line">    <span class="keyword">this</span>.keepAliveDurationNs = keepAliveDurationMs * <span class="number">1000</span> * <span class="number">1000</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Returns a snapshot of the connections in this pool, ordered from newest to</div><div class="line">   * oldest. Waits for the cleanup callable to run if it is currently scheduled.</div><div class="line">   */</div><div class="line">  <span class="function">List&lt;Connection&gt; <span class="title">getConnections</span><span class="params">()</span> </span>&#123;</div><div class="line">    waitForCleanupCallableToRun();</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Connection&gt;(connections);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Blocks until the executor service has processed all currently enqueued</div><div class="line">   * jobs.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitForCleanupCallableToRun</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      executorService.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">      &#125;).get();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConnectionPool <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> systemDefault;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns total number of connections in the pool. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getConnectionCount</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> connections.size();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns total number of spdy connections in the pool. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getSpdyConnectionCount</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> total = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (Connection connection : connections) &#123;</div><div class="line">      <span class="keyword">if</span> (connection.isSpdy()) total++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> total;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns total number of http connections in the pool. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getHttpConnectionCount</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> total = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (Connection connection : connections) &#123;</div><div class="line">      <span class="keyword">if</span> (!connection.isSpdy()) total++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> total;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a recycled connection to &#123;<span class="doctag">@code</span> address&#125;, or null if no such connection exists. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Connection <span class="title">get</span><span class="params">(Address address)</span> </span>&#123;</div><div class="line">    Connection foundConnection = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">for</span> (ListIterator&lt;Connection&gt; i = connections.listIterator(connections.size());</div><div class="line">        i.hasPrevious(); ) &#123;</div><div class="line">      Connection connection = i.previous();</div><div class="line">      <span class="keyword">if</span> (!connection.getRoute().getAddress().equals(address)</div><div class="line">          || !connection.isAlive()</div><div class="line">          || System.nanoTime() - connection.getIdleStartTimeNs() &gt;= keepAliveDurationNs) &#123;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line">      i.remove();</div><div class="line">      <span class="keyword">if</span> (!connection.isSpdy()) &#123;</div><div class="line">	    <span class="comment">// 不是spdy连接</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">		  <span class="comment">// Platforml类对当前Android平台做了适配。</span></div><div class="line">          Platform.get().tagSocket(connection.getSocket());</div><div class="line">        &#125; <span class="keyword">catch</span> (SocketException e) &#123;</div><div class="line">          Util.closeQuietly(connection);</div><div class="line">          <span class="comment">// When unable to tag, skip recycling and close</span></div><div class="line">          Platform.get().logW(<span class="string">"Unable to tagSocket(): "</span> + e);</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">	  <span class="comment">// 找到可复用的Connection</span></div><div class="line">      foundConnection = connection;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">// 针对spdy连接，添加到连接池中</span></div><div class="line">    <span class="keyword">if</span> (foundConnection != <span class="keyword">null</span> &amp;&amp; foundConnection.isSpdy()) &#123;</div><div class="line">      connections.addFirst(foundConnection); <span class="comment">// Add it back after iteration.</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    executorService.execute(connectionsCleanupRunnable);</div><div class="line">    <span class="keyword">return</span> foundConnection;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Gives &#123;<span class="doctag">@code</span> connection&#125; to the pool. The pool may store the connection,</div><div class="line">   * or close it, as its policy describes.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;It is an error to use &#123;<span class="doctag">@code</span> connection&#125; after calling this method.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">(Connection connection)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (connection.isSpdy()) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!connection.isAlive()) &#123;</div><div class="line">      Util.closeQuietly(connection);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Platform.get().untagSocket(connection.getSocket());</div><div class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</div><div class="line">      <span class="comment">// When unable to remove tagging, skip recycling and close.</span></div><div class="line">      Platform.get().logW(<span class="string">"Unable to untagSocket(): "</span> + e);</div><div class="line">      Util.closeQuietly(connection);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      connections.addFirst(connection);</div><div class="line">      connection.incrementRecycleCount();</div><div class="line">      connection.resetIdleStartTime();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    executorService.execute(connectionsCleanupRunnable);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Shares the SPDY connection with the pool. Callers to this method may</div><div class="line">   * continue to use &#123;<span class="doctag">@code</span> connection&#125;.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">share</span><span class="params">(Connection connection)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!connection.isSpdy()) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">    executorService.execute(connectionsCleanupRunnable);</div><div class="line">    <span class="keyword">if</span> (connection.isAlive()) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        connections.addFirst(connection);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Close and remove all connections in the pool. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evictAll</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;Connection&gt; connections;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      connections = <span class="keyword">new</span> ArrayList&lt;Connection&gt;(<span class="keyword">this</span>.connections);</div><div class="line">      <span class="keyword">this</span>.connections.clear();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = connections.size(); i &lt; size; i++) &#123;</div><div class="line">      Util.closeQuietly(connections.get(i));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/HttpURLConnection详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android6.0权限系统" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android6.0权限系统/">Android6.0权限系统</a>
    </h1>
  

        
        <a href="/2015/01/01/Android6.0权限系统/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android6-0权限系统"><a href="#Android6-0权限系统" class="headerlink" title="Android6.0权限系统"></a>Android6.0权限系统</h1><p><code>Android</code>权限系统是一个非常重要的安全问题，因为它只有在安装时会询问一次。一旦软件本安装之后，应用程序可以在用户毫不知情的情况下使用这些权限来获取所有的内容。     </p>
<p>很多坏蛋会通过这个安全缺陷来收集用户的个人信息并使用它们来做坏事的情况就不足为奇了。    </p>
<p><code>Android</code>团队也意识到了这个问题。在经过了7年后，权限系统终于被重新设置了。从<code>Anroid 6.0(API Level 23)</code>开始，应用程序在安装时不会被授予任何权限，取而代之的是在运行时应用回去请求用户授予对应的权限。这样可以让用户能更好的去控制应用功能。例如，一个用户可能会同一个拍照应用使用摄像头的权限，但是不同授权它获取设备位置的权限。用户可以在任何时候通过去应用的设置页面来撤销授权。    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/runtimepermission.jpg?raw=true" alt="image">  </p>
<p><strong>注意:</strong>上面请求权限的对话框不会自动弹出。开发者需要手动的调用。如果开发者调用了一些需要权限的功能，但是用户又拒绝授权的话，应用就会<code>crash</code>。   </p>
<p>系统权限被分为两类，<code>normal</code>和<code>dangerous</code>:    </p>
<ul>
<li><code>Normal Permissions</code>不需要用户直接授权，如果你的应用在清单文件中声明了Normal Permissions`，系统会自动授权该权限。    </li>
<li><code>Dangerous Permissions</code>可以让应用获取用户的私人数据。如果你的应用在清单文件中申请了<code>Dangerous Permissions</code>，那就必须要用户来授权给应用。   </li>
</ul>
<p><code>Normal Permissions</code>:<br><code>Normal Permission</code>是当用户安装或更新应用时，系统将授予应用所请求的权限，又称为<code>PROTECTION_NORMAL</code>（安装时授权的一类基本权限）。该类权限只需要在<code>manifest</code>文件中声明即可，安装时就授权，不需要每次使用时进行检查，而且用户不能取消以上授权。   </p>
<ul>
<li>ACCESS_LOCATION_EXTRA_COMMANDS</li>
<li>ACCESS_NETWORK_STATE</li>
<li>ACCESS_NOTIFICATION_POLICY</li>
<li>ACCESS_WIFI_STATE</li>
<li>BLUETOOTH</li>
<li>BLUETOOTH_ADMIN</li>
<li>BROADCAST_STICKY</li>
<li>CHANGE_NETWORK_STATE</li>
<li>CHANGE_WIFI_MULTICAST_STATE</li>
<li>CHANGE_WIFI_STATE</li>
<li>DISABLE_KEYGUARD</li>
<li>EXPAND_STATUS_BAR</li>
<li>GET_PACKAGE_SIZE</li>
<li>INSTALL_SHORTCUT</li>
<li>INTERNET</li>
<li>KILL_BACKGROUND_PROCESSES</li>
<li>MODIFY_AUDIO_SETTINGS</li>
<li>NFC</li>
<li>READ_SYNC_SETTINGS</li>
<li>READ_SYNC_STATS</li>
<li>RECEIVE_BOOT_COMPLETED</li>
<li>REORDER_TASKS</li>
<li>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</li>
<li>REQUEST_INSTALL_PACKAGES</li>
<li>SET_ALARM</li>
<li>SET_TIME_ZONE</li>
<li>SET_WALLPAPER</li>
<li>SET_WALLPAPER_HINTS</li>
<li>TRANSMIT_IR</li>
<li>UNINSTALL_SHORTCUT</li>
<li>USE_FINGERPRINT</li>
<li>VIBRATE</li>
<li>WAKE_LOCK</li>
<li>WRITE_SYNC_SETTINGS</li>
</ul>
<p>下图为<code>Dangerous permissions and permission groups</code>:  </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/permgroup.png?raw=true" alt="image">     </p>
<p>在所有的<code>Android</code>版本中，你的应用都需要在<code>manifest</code>文件中声明<code>normal</code>和<code>dangerous</code>权限。然而声明所影响的效果会因系统版本和你应用的<code>target SDK lever</code>有关:     </p>
<ul>
<li>如果设备运行的是<code>Android 5.1</code>或者之前的系统，或者应用的<code>targetSdkVersion</code>是22或者之前版本：如果你在<code>manifest</code>中声明了<code>dangerous permission</code>，用户需要在安装应用时授权这些权限。如果用户不授权这些权限，系统就不会安装该应用。(我试了下发现即使<code>targetSdkVersion</code>是22及以下，在6.0的手机上时，如果你安装时你不同意一些权限，也仍然可以安装的)  </li>
<li>如果设备运行的是<code>Android 6.0</code>或者更高的系统，并且你应用的<code>targetSdkVersion</code>是23或者更高:应用必须在<code>manifest</code>文件中申请这些权限，而且必须要在运行时对所需要的<code>dangerous permission</code>申请授权。用户可以统一或者拒绝授权，并且及时用户拒绝了授权，应用在无法使用一些功能的情况下也要保证能继续运行。     </li>
</ul>
<p>也就是说新的运行时权限仅当我们设置<code>targetSdkVersion</code>是23及以上时才会起作用。<br>如果你的<code>targtSdkVersion</code>低于23，那将被认为该应用没有经过<code>android 6.0</code>的测试，当该应用被安装到了6.0的手机上时，仍然会使用之前的旧权限规则，在安装时会提示所有需要的权限(这样做是有道理的，不然对于之前开发的应用，我们都要立马去修改让它适应6.0，来不及的话就导致6.0的手机都无法使用了，显然Android开发团队不会考虑不到这种情况)，当然用户可以在安装的界面不允许一些权限，那当程序使用到了这些权限时，会崩溃吗？答案是在<code>Android 6.0</code>及以上的手机会直接<code>crash</code>，但是在<code>23</code>之前的手机上不会<code>crash</code>。     </p>
<p>所以如果你的应用没有支持运行时权限的功能，那千万不要讲<code>targetSdkVersion</code>设置为23，否则就麻烦了。  </p>
<blockquote>
<p><strong><em>注意:</em></strong>从<code>Android 6.0(API Level 23)</code>开始，即使应用的<code>targetSdkVersion</code>是比较低的版本，但是用户仍然可以在任何时候撤销对应用的授权。所以不管应用的<code>targetSdkVerison</code>是什么版本，你都要测试你的应用在不能获取权限时能不能正常运行。 </p>
</blockquote>
<p>下面介绍下如何使用<code>Android Support Library</code>来检查和请求权限。<code>Android</code>框架在<code>6.0</code>开始也提供了相同的方法。然而使用<code>support</code>包会比较简单，因为这样你就不需要在请求方法时判断当前的系统版本。(后面说的这几个类都是<code>android.support.v4</code>中的)    </p>
<p>###检查权限    </p>
<p>如果应用需要使用<code>dangerous permission</code>，在任何时候执行需要该权限的操作时你都需要检查是否已经授权。用户可能会经常取消授权，所以即使昨天应用已经使用了摄像头，这也不能保证今天仍然有使用摄像头的权限。    </p>
<p>为了检查是否可以使用该权限，调用<code>ContextCompat.checkSelfPermission()</code>。<br>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Assume thisActivity is the current activity</span></div><div class="line"><span class="keyword">int</span> permissionCheck = ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">        Manifest.permission.WRITE_CALENDAR);</div></pre></td></tr></table></figure></p>
<p>如果应用有该权限，该方法将返回<code>PackageManager.PERMISSION_GRANTED</code>，应用可以进行相关的操作。如果应用不能使用该权限，该方法将返回<code>PERMISSION_DENIED</code>，这是应用将必须要向用户申请该权限。    </p>
<p>###申请使用权限</p>
<p>如果应用需要使用清单文件中申明的<code>dangerous permission</code>，它必须要向用户申请来授权。<code>Android</code>提供了几种申请授权的方法。使用这些方法时将会弹出一个标准的系统对话框，该对话框不能自定义。     </p>
<p>#####说明为什么应用需要使用这些权限      </p>
<p>在一些情况下，你可能需要帮助用力理解为什么需要该权限。例如，一个用户使用了一个照相的应用，用户不会奇怪为什么应用申请使用摄像头的权限，但是用户可能会不理解为什么应用需要获取位置或者联系人的权限。在请求一个权限之前，你需要该用户一个说明。一定要切记不要通过说明来压倒用户。如果你提供了太多的说明，用户可能会感觉沮丧并且会卸载它。   </p>
<p>一个你需要提供说明的合适时机就是在用户之前已经不同意授权该权限的情况下。如果一个用户继续尝试使用需要权限的功能时，但是之前确禁止了该权限的请求，这就可能是因为用户不理解为什么该功能需要使用该权限。在这种情况下，提供一个说明是非常合适的。  </p>
<p>为了能找到用户可能需要说明的情况，<code>android</code>提供了一个工具类方法<code>ActivityCompat.shouldShowRequestPermissionRationale().</code>。如果应用之前申请了该权限但是用户拒绝授权后该方法会返回<code>true</code>。(在Android 6.0之前调用的时候会直接返回false)     </p>
<blockquote>
<p><strong><em>注意：</em></strong>如果用户之前拒绝了权限申请并且选择了请求权限对话框中的<code>Don’t ask again</code>选项，该方法就会返回<code>false</code>。如果设备策略禁止了该应用使用该权限，该方法也会返回<code>false</code>。(我测试的时候发现请求权限的对话框中并没有<code>Don’t asdk again</code>这一项)<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/request_permission_dialog.png?raw=true" alt="image">      </p>
</blockquote>
<p>#####申请需要的权限      </p>
<p>如果应用没有所需的权限时，应用必须调用<code>ActivityCompat.requestPermissions (Activity activity, 
                String[] permissions, 
                int requestCode)</code>方法来申请对用的权限。参数传递对应所需的权限以及一个整数型的<code>request code</code>来标记该权限申请。 该方法是异步的:该方法会立即返回，在用户响应了请求权限的对话框之后，系统会调用对用的回调方法来通知结果，并且会传递在<code>reqeustPermissions()</code>方法中的<code>request code</code>。(在Android 6.0之前调用的时候会直接去调用<code>onRequestPermissionsResult()</code>的回调方法)<br>如图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/requestpermission.jpg?raw=true" alt="image">  </p>
<p>下面是检查是否读取联系人权限，并且在必要时申请权限的代码:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Here, thisActivity is the current activity</span></div><div class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">                Manifest.permission.READ_CONTACTS)</div><div class="line">        != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Should we show an explanation?</span></div><div class="line">    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(thisActivity,</div><div class="line">            Manifest.permission.READ_CONTACTS)) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Show an expanation to the user *asynchronously* -- don't block</span></div><div class="line">        <span class="comment">// this thread waiting for the user's response! After the user</span></div><div class="line">        <span class="comment">// sees the explanation, try again to request the permission.</span></div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// No explanation needed, we can request the permission.</span></div><div class="line"></div><div class="line">        ActivityCompat.requestPermissions(thisActivity,</div><div class="line">                <span class="keyword">new</span> String[]&#123;Manifest.permission.READ_CONTACTS&#125;,</div><div class="line">                MY_PERMISSIONS_REQUEST_READ_CONTACTS);</div><div class="line"></div><div class="line">        <span class="comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span></div><div class="line">        <span class="comment">// app-defined int constant. The callback method gets the</span></div><div class="line">        <span class="comment">// result of the request.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong><em>注意：</em></strong>当调用<code>requestPermissions()</code>方法时，系统会显示一个标准的对话框。应用不能指定或者改变该对话框。如果你想提供一些信息或者说明给用户，你需要在调用<code>requestPermissions()</code>之前处理。    </p>
</blockquote>
<p>#####处理请求权限的的结果     </p>
<p>如果应用申请权限，系统会显示一个对话框。当用户相应后，系统会调用应用中的<code>onRequestPermissionsResult (int requestCode, 
                String[] permissions, 
                int[] grantResults)</code>方法并传递用户的操作结果。在应用中必须要重写该方法来查找授权了什么权限。该回调方法会传递你在<code>requestPermisssions()</code>方法中传递的<code>request code</code>。直接在<code>Activity</code>或者<code>Fragment</code>中重写<code>onRequestPermissionsResult()</code>方法即可。例如，申请<code>READ_CONTACTS</code>的权限可能会有下面的回到方法:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode,</span></span></div><div class="line">        String permissions[], <span class="keyword">int</span>[] grantResults) &#123;</div><div class="line">    <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">        <span class="keyword">case</span> MY_PERMISSIONS_REQUEST_READ_CONTACTS: &#123;</div><div class="line">            <span class="comment">// If request is cancelled, the result arrays are empty.</span></div><div class="line">            <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span></div><div class="line">                &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission was granted, yay! Do the</span></div><div class="line">                <span class="comment">// contacts-related task you need to do.</span></div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission denied, boo! Disable the</span></div><div class="line">                <span class="comment">// functionality that depends on this permission.</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// other 'case' lines to check for other</span></div><div class="line">        <span class="comment">// permissions this app might request</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>系统提示的对话框会描述应用所需的<code>permission groud</code>。它不会列出特定的权限。例如，如果你申请了<code>READ_CONTACTS</code>权限，系统的对话框只会说你的应用需要获取设备的联系人信息。用户只需要授权每个<code>permission group</code>一次。如果你应用需要申请其他任何一个在该<code>permission group</code>中的权限时，系统会自动授权。在申请这些授权时，系统会像用户明确通过系统对话框统一授权时一样去调用<code>onRequestPermissionsResult()</code>方法并且传递<code>PERMISSION_GRANTED</code>参数。    </p>
<blockquote>
<p><strong><em>注意：</em></strong>虽然用户已经授权了同一<code>permission group</code>中其他的任何权限，但是应用仍然需要明确申请每个需要的权限。例外，<code>permission group</code>中的权限在以后可能会发生变化。    </p>
</blockquote>
<p>例如，假设在应用的<code>manifest</code>文件中同时声明了<code>READ_CONTACTS</code>和<code>WRITE_CONTACTS</code>权限。如果你申请<code>READ_CONTACTS</code>权限而且用户同意了该权限，如果你想继续申请<code>WRITE_CONTACTS</code>权限，系统不会与用户有任何交互就会直接进行授权。     </p>
<p>如果用户拒绝了一个权限申请，你的应用进行合适的处理。例如，你的应用可能显示一个对话框来表明无法执行用户请求的需要该权限的操作。</p>
<p>如果系统向用户申请权限授权，用户选择了让系统以后不要再申请该权限。 在这种情况下，应用在任何时间调用<code>reqeustPermissions()</code>方法来再次申请权限时，系统都会直接拒绝该请求。系统会直接调用<code>onRequestPermissionResult()</code>回调方法并且传递<code>PERMISSION_DENIED</code>参数，和用户明确拒绝应用申请该权限时一样。 这就意味着在你调用<code>requestPermissions()</code>方法是，你无法确定是否会和用户有直接的交互操作。   </p>
<p>示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">int</span> REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS = <span class="number">124</span>;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertDummyContactWrapper</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; permissionsNeeded = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">  </div><div class="line">    <span class="keyword">final</span> List&lt;String&gt; permissionsList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.ACCESS_FINE_LOCATION))</div><div class="line">        permissionsNeeded.add(<span class="string">"GPS"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.READ_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Read Contacts"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.WRITE_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Write Contacts"</span>);</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (permissionsList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (permissionsNeeded.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Need Rationale</span></div><div class="line">            String message = <span class="string">"You need to grant access to "</span> + permissionsNeeded.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; permissionsNeeded.size(); i++)</div><div class="line">                message = message + <span class="string">", "</span> + permissionsNeeded.get(i);</div><div class="line">            showMessageOKCancel(message,</div><div class="line">                    <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                            requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                                    REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    insertDummyContact();</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addPermission</span><span class="params">(List&lt;String&gt; permissionsList, String permission)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (checkSelfPermission(permission) != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">        permissionsList.add(permission);</div><div class="line">        <span class="comment">// Check for Rationale Option</span></div><div class="line">        <span class="keyword">if</span> (!shouldShowRequestPermissionRationale(permission))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲到的都是<code>Activity</code>中的使用方法，那<code>Fragment</code>中怎么授权呢？<br>如果在<code>Fragment</code>中使用，用<code>v13</code>包中的<code>FragmentCompat.requestPermissions()</code>和<code>FragmentCompat.shouldShowRequestPermissionRationale()</code>。 </p>
<p>在<code>Fragment</code>中申请权限，不要使用<code>ActivityCompat.requestPermissions</code>, 直接使用<code>Fragment.requestPermissions</code>方法，<br>否则会回调到<code>Activity</code>的<code>onRequestPermissionsResult</code>。但是虽然你使用<code>Fragment.requestPermissions</code>方法，也照样回调不到<code>Fragment.onRequestPermissionsResult</code>中。这是<code>Android</code>的<code>Bug</code>,<a href="https://code.google.com/p/android/issues/detail?can=2&amp;start=0&amp;num=100&amp;q=&amp;colspec=ID%20Status%20Priority%20Owner%20Summary%20Stars%20Reporter%20Opened&amp;groupby=&amp;sort=&amp;id=189121" target="_blank" rel="external">详见</a>，<code>Google</code>已经在<code>23.3.0</code>修复了该问题，所以要尽快升级。</p>
<p>所以升级到<code>23.3.0</code>及以上就没问题了。如果不升级该怎么处理呢？就是在<code>Activity.onRequestPermissionsResult</code>方法中去手动调用每个<code>Fragment</code>的方法(当然你要判断下权限个数，不然申请一个权限的情况下会重复调用).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">    List&lt;Fragment&gt; fragments = getSupportFragmentManager().getFragments();</div><div class="line">    <span class="keyword">if</span> (fragments != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (Fragment fragment : fragments) &#123;</div><div class="line">            fragment.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我简单的写了一个工具类:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionUtil</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在调用需要权限的功能时使用该方法进行检查。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(activity, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在Actvitiy或者Fragment中重写onRequestPermissionsResult方法后调用该方法。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> grantResults</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(activity, requestCode, permissions, grantResults, iPermission);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String... permission)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String s : permission) &#123;</div><div class="line">            permissions.add(s);</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在检查权限后自己处理权限说明的逻辑后调用该方法，直接申请权限。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> t</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (permissions == <span class="keyword">null</span> || permissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSelfPermission</span><span class="params">(Context context, String permission)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || TextUtils.isEmpty(permission)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params: the params is null !"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        context = context.getApplicationContext();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            <span class="keyword">int</span> result = ContextCompat.checkSelfPermission(context, permission);</div><div class="line">            <span class="keyword">if</span> (PackageManager.PERMISSION_DENIED == result) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">handleRequestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            Activity activity = getActivity(t);</div><div class="line">            List&lt;String&gt; deniedPermissions = getDeniedPermissions(activity, permissions);</div><div class="line">            <span class="keyword">if</span> (deniedPermissions != <span class="keyword">null</span> &amp;&amp; deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                List&lt;String&gt; rationalPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                <span class="keyword">for</span> (String deniedPermission : deniedPermissions) &#123;</div><div class="line">                    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(activity,</div><div class="line">                            deniedPermission)) &#123;</div><div class="line">                        rationalPermissions.add(deniedPermission);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> showRational = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    showRational = iPermission.showRational(requestCode);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (rationalPermissions.size() &gt; <span class="number">0</span> &amp;&amp; showRational) &#123;</div><div class="line">                    <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                        iPermission.onRational(requestCode, deniedPermissions);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    requestPermissions(t, requestCode, deniedPermissions);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    iPermission.onGranted(requestCode);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Activity <span class="title">getActivity</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">        Activity activity = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            activity = (Activity) t;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            activity = ((Fragment) t).getActivity();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            activity = ((android.app.Fragment) t).getActivity();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> activity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.M)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; deniedPermissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions == <span class="keyword">null</span> || deniedPermissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// has denied permissions</span></div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            ((Activity) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            ((Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            ((android.app.Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getDeniedPermissions</span><span class="params">(Context context, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        List&lt;String&gt; denyPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String permission : permissions) &#123;</div><div class="line">            <span class="keyword">if</span> (!checkSelfPermission(context, permission)) &#123;</div><div class="line">                denyPermissions.add(permission);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> denyPermissions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestResult</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                          <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        List&lt;String&gt; deniedPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grantResults.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (grantResults[i] != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">                deniedPermissions.add(permissions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onDenied(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPermission</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否需要提示用户该权限的作用，提示后需要再调用requestPermission()方法来申请。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> true 为提示，false为不提示</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Button mReqCameraBt;</div><div class="line">    <span class="keyword">private</span> Button mReqContactsBt;</div><div class="line">    <span class="keyword">private</span> Button mReqMoreBt;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.fragment_main, container, <span class="keyword">false</span>);</div><div class="line">        findView(view);</div><div class="line">        initView();</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        mReqCameraBt = (Button) view.findViewById(R.id.bt_requestCamera);</div><div class="line">        mReqContactsBt = (Button) view.findViewById(R.id.bt_requestContacts);</div><div class="line">        mReqMoreBt = (Button) view.findViewById(R.id.bt_requestMore);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mReqCameraBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqContactsBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqMoreBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CAMERA = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CONTACTS = <span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_MORE = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        PermissionUtil.onRequestPermissionsResult(<span class="keyword">this</span>, requestCode, permissions, grantResults, mPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestCamera</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CAMERA, mPermission, Manifest.permission.CAMERA);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestReadContacts</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CONTACTS, mPermission, Manifest.permission.READ_CONTACTS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestMore</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_MORE, mPermission, Manifest.permission.READ_CONTACTS, Manifest.permission.READ_CALENDAR, Manifest.permission.CALL_PHONE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPermissionTipDialog</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity());</div><div class="line">        builder.setMessage(<span class="string">"I want you permissions"</span>);</div><div class="line">        builder.setTitle(<span class="string">"Hello Permission"</span>);</div><div class="line">        builder.setPositiveButton(<span class="string">"确认"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">                PermissionUtil.requestPermission(MainFragment.<span class="keyword">this</span>, requestCode, permissions);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.setNegativeButton(<span class="string">"取消"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.create().show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> IPermission mPermission = <span class="keyword">new</span> IPermission() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onGranted :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onDenied :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permission)</span> </span>&#123;</div><div class="line">            showPermissionTipDialog(requestCode, permission);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">                <span class="keyword">case</span> REQUEST_CODE_MORE:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> id = v.getId();</div><div class="line">        <span class="keyword">switch</span> (id) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestCamera:</div><div class="line">                requestCamera();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestContacts:</div><div class="line">                requestReadContacts();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestMore:</div><div class="line">                requestMore();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android6.0权限系统/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio提高Build速度" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio提高Build速度/">AndroidStudio提高Build速度</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio提高Build速度/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio提高Build速度"><a href="#AndroidStudio提高Build速度" class="headerlink" title="AndroidStudio提高Build速度"></a>AndroidStudio提高Build速度</h1><p><code>Android Studio</code>自动发布以来，凭借其强大的功能，很快让开发者都投入到它的阵营下。但是也问题，就是<code>Build</code>速度太慢了。</p>
<p>之前也根据网上的资料，修改了一些配置，但是一次二分多种有时候还是让人抓狂。今天索性记录一下。首先看一下<a href="https://plus.google.com/+AndroidDevelopers/posts/ECrb9VQW9XP" target="_blank" rel="external">Google+</a>关于该问题的讨论。</p>
<ul>
<li><p>使用<code>daemon</code>及<code>parallel</code>模式</p>
<p>  在下面的目录中创建一个名为<code>gradle.properties</code>的文件:     </p>
<ul>
<li><code>/home/&lt;username&gt;/.gradle/ (Linux)</code></li>
<li><code>/Users/&lt;username&gt;/.gradle/ (Mac)</code></li>
<li><p><code>C:\Users\&lt;username&gt;\.gradle (Windows)</code></p>
<p>文件的内容为: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.gradle.daemon=true</div><div class="line">org.gradle.parallel=true</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>经过上面的这一步修改是对所有工程都有效果的，如果你只想对某一个工程配置的话，那就在该工程目录下的`gralde.properties`中进行配置。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line"># Default value: -Xmx10248m -XX:MaxPermSize=256m</div><div class="line"># org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div></pre></td></tr></table></figure>

打开时默认如上。我们给加添加上面的配置就好。

当然你也可以通过`Studio`的设置中进行修改。        
![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_speed.png?raw=true)
</code></pre><ul>
<li><p>使用<code>offline</code>模式      </p>
<p>  下一步就是开始<code>offline</code>模式，因为我们经常会在<code>gradle</code>中使用一下依赖库时用<code>+</code>这样的话就能保证你的依赖库是最新的版本，但是这样在每次<code>build</code>的时候都会去检查是不是最新的版本，所以就会耗时。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_offline.png?raw=true" alt="image"></p>
<p>  在开发过程中是不建议使用动态版本的，在<code>Studio</code>中使用动态版本的<code>gradle</code>中间中使用<code>ALT+ENTER</code>键进行修复。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_daymaic_version_tip.png?raw=true" alt="image"><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_dymaic_version_fix.png?raw=true" alt="image"><br>  详细有关为什么不要使用动态版本的介绍，请参考<a href="http://blog.danlew.net/2015/09/09/dont-use-dynamic-versions-for-your-dependencies/" target="_blank" rel="external">Don’t use dynamic versions for your dependencies</a></p>
</li>
<li><p>增加内存使用<code>SSD</code><br>  首先是增大内存,    <code>Mac</code>中在<code>Applications</code>中找到<code>Sutio</code>然后右键显示包内容<code>Contents/bin/studio.vmoptions</code>。<br>  打开该文件后修改就可以了，我是的是:     </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># *DO NOT* modify this file directly. If there is a value that you would like to override,</div><div class="line"># please add it to your user specific configuration file.</div><div class="line">#</div><div class="line"># See http://tools.android.com/tech-docs/configuration</div><div class="line">#</div><div class="line">-Xms1024m</div><div class="line">-Xmx4096m</div><div class="line">-XX:MaxPermSize=768m</div><div class="line">-XX:ReservedCodeCacheSize=768m</div><div class="line">-XX:+UseCompressedOops</div></pre></td></tr></table></figure>
<p>  我没看见<code>DO NOT</code>的提示- -!</p>
<ul>
<li>Xms 是JVN启动起始时的堆内存，堆内存是分配给对象的内容。</li>
<li>Xmx 是能使用的最大堆内存。</li>
</ul>
</li>
</ul>
<ul>
<li><p>使用<code>Instant Run</code>   </p>
<p>  <code>Instantt Run</code>放在这里说可能不合适，但是用他确实能大大的减少运行时间。<br>  如果还不了解的话可以参考<a href="http://tools.android.com/tech-docs/instant-run" target="_blank" rel="external">Instant Run</a><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_instantrun.png?raw=true" alt="image"></p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio提高Build速度/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android卸载反馈" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android卸载反馈/">Android卸载反馈</a>
    </h1>
  

        
        <a href="/2015/01/01/Android卸载反馈/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android卸载反馈"><a href="#Android卸载反馈" class="headerlink" title="Android卸载反馈"></a>Android卸载反馈</h1><p>最初记得是在360安全卫士中出现的，在手机上卸载他的应用之后浏览器就会弹出一个反馈页面，让用户进行反馈，感觉这种功能对于产品改进特别有帮助。<br>但是仔细一想该怎么去实现却犯愁了，最开始想这也简单啊，不就是监听下自身被卸载就可以了，应该系统会有卸载的广播，可惜没有。甚至其他的一些<br>方法也是不行的，因为你程序都被卸载了，你的代码怎么会执行呢？皮之不存，毛将焉附。那360是怎样实现的呢？说句真心话360做的产品还是非常有创新<br>的，虽然有些时候他会损坏用户的利益，不过但从技术方面，着实让人信服。</p>
<p>既然<code>Java</code>实现不了，那就得考虑下其他的了，自然最先想到的就是<code>JNI</code>了，可惜<code>C</code>的部分不懂，上网搜了很多资料和介绍，找得到可以通过一下方式实现:   </p>
<ul>
<li><p>通过<code>c</code>中的<code>fork</code>方法来复制一个子进程。复制出来的子进程在父进程被销毁后，仍然可以存在。<br>  <code>pid_t fpid = fork()</code>被调用前，就一个进程执行该段代码，这条语句执行之后，就会有两个进程执行该代码，两个进程执行没有固定先后顺序，只要看<br>  系统调度策略，<code>fork()</code>函数的特别之处在于调用一次会返回两次结果：   </p>
<pre><code>- 返回值大于0，当前是父进程。
- 返回0，当前是子进程。
- 返回小于0的负值。(出错了，可能是内存不足或者是进程数已经达到系统最大值)
</code></pre></li>
<li><p><code>fork</code>出子进程后让子进程一直去监听<code>/data/data/packageName</code>是否存在，如果不存在了，那就说明程序被卸载了，但是这样一直去轮训判断肯定会浪费<br>  系统资源的，当然也会更加费电，对用户来讲肯定是有损害的。所以这种技术最好也不好用，不然大家的手机以后还能了得。万恶的产品。</p>
</li>
<li><p>得到程序被卸载之后弹出浏览器打开指定反馈页面。这就要用到<code>am</code>命令了，最早知道这个命令是在开发<code>TV</code>版的时候，遥控器找不到了，程序安装后无法<br> 打开了，用该命令就不怕了，哈哈。但是在<code>c</code>中怎么执行<code>am</code>命令呢？这就要用到<code>execlp()</code>函数，该函数就是<code>c</code>中执行系统命令的函数。</p>
</li>
</ul>
<p>好了，主要的内容上面都分析完了，下面上代码。</p>
<ul>
<li><p><code>Java</code>层定义<code>natvie</code>方法。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"@@@"</span>;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.activity_main);</div><div class="line">		String packageDir = <span class="string">"/data/data/"</span> + getPackageName();</div><div class="line">		initUninstallFeedback(packageDir, Build.VERSION.SDK_INT);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initUninstallFeedback</span><span class="params">(String packagePath, <span class="keyword">int</span> sdkVersion)</span></span>;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		System.loadLibrary(<span class="string">"uninstall_feedback"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建jni目录，增加<code>Android.mk</code>以及<code>uninstall_feedback.c</code>文件。<br><code>Android.mk</code>的内容:</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line"></div><div class="line">include $(CLEAR_VARS)</div><div class="line"></div><div class="line">LOCAL_MODULE    := uninstall_feedback</div><div class="line">LOCAL_SRC_FILES := uninstall_feedback.c</div><div class="line"></div><div class="line">LOCAL_C_INCLUDES := $(LOCAL_PATH)/include</div><div class="line">LOCAL_LDLIBS += -L$(SYSROOT)/usr/lib -llog</div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<p><code>uninstall_feedback.c</code>的实现: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 将Java中的String转换成c中的char字符串</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">Jstring2CStr</span><span class="params">(JNIEnv* env, jstring jstr)</span> </span>&#123;</div><div class="line">	<span class="keyword">char</span>* rtn = <span class="literal">NULL</span>;</div><div class="line">	jclass clsstring = (*env)-&gt;FindClass(env, <span class="string">"java/lang/String"</span>); <span class="comment">//String</span></div><div class="line">	jstring strencode = (*env)-&gt;NewStringUTF(env, <span class="string">"GB2312"</span>); <span class="comment">// 得到一个java字符串 "GB2312"</span></div><div class="line">	jmethodID mid = (*env)-&gt;GetMethodID(env, clsstring, <span class="string">"getBytes"</span>,</div><div class="line">			<span class="string">"(Ljava/lang/String;)[B"</span>); <span class="comment">//[ String.getBytes("gb2312");</span></div><div class="line">	jbyteArray barr = (jbyteArray)(*env)-&gt;CallObjectMethod(env, jstr, mid,</div><div class="line">			strencode); <span class="comment">// String .getByte("GB2312");</span></div><div class="line">	jsize alen = (*env)-&gt;GetArrayLength(env, barr); <span class="comment">// byte数组的长度</span></div><div class="line">	jbyte* ba = (*env)-&gt;GetByteArrayElements(env, barr, JNI_FALSE);</div><div class="line">	<span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</div><div class="line">		rtn = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(alen + <span class="number">1</span>); <span class="comment">//""</span></div><div class="line">		<span class="built_in">memcpy</span>(rtn, ba, alen);</div><div class="line">		rtn[alen] = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	(*env)-&gt;ReleaseByteArrayElements(env, barr, ba, <span class="number">0</span>); <span class="comment">//</span></div><div class="line">	<span class="keyword">return</span> rtn;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_charon_uninstallfeedback_MainActivity_initUninstallFeedback</span><span class="params">(</span></span></div><div class="line">		JNIEnv* env, jobject thiz, jstring packageDir, jint sdkVersion) &#123;</div><div class="line"></div><div class="line">	<span class="keyword">char</span> * pd = Jstring2CStr(env, packageDir);</div><div class="line"></div><div class="line">	<span class="comment">//fork子进程，以执行轮询任务</span></div><div class="line">	<span class="keyword">pid_t</span> pid = fork();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// fork失败了</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// 可以一直采用一直判断文件是否存在的方式去判断，但是这样效率稍低，下面使用监听的方式，死循环，每个一秒判断一次，这样太浪费资源了。</span></div><div class="line">		<span class="keyword">int</span> check = <span class="number">1</span>;</div><div class="line">		<span class="keyword">while</span> (check) &#123;</div><div class="line">			FILE* file = fopen(pd, <span class="string">"rt"</span>);</div><div class="line">			<span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (sdkVersion &gt;= <span class="number">17</span>) &#123;</div><div class="line">					<span class="comment">// Android4.2系统之后支持多用户操作，所以得指定用户</span></div><div class="line">					execlp(<span class="string">"am"</span>, <span class="string">"am"</span>, <span class="string">"start"</span>, <span class="string">"--user"</span>, <span class="string">"0"</span>, <span class="string">"-a"</span>,</div><div class="line">							<span class="string">"android.intent.action.VIEW"</span>, <span class="string">"-d"</span>,</div><div class="line">							<span class="string">"http://shouji.360.cn/web/uninstall/uninstall.html"</span>,</div><div class="line">							(<span class="keyword">char</span>*) <span class="literal">NULL</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Android4.2以前的版本无需指定用户</span></div><div class="line">					execlp(<span class="string">"am"</span>, <span class="string">"am"</span>, <span class="string">"start"</span>, <span class="string">"-a"</span>,</div><div class="line">						<span class="string">"android.intent.action.VIEW"</span>, <span class="string">"-d"</span>,</div><div class="line">							<span class="string">"http://shouji.360.cn/web/uninstall/uninstall.html"</span>,</div><div class="line">							(<span class="keyword">char</span>*) <span class="literal">NULL</span>);</div><div class="line">				&#125;</div><div class="line">				check = <span class="number">0</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			&#125;</div><div class="line">			sleep(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编译so文件。<code>Windows</code>下要用<code>cygwin</code>来操作。<br>上面的介绍是在<code>Eclipse</code>中进行的，用<code>ndk-build</code>命令来编译<code>so</code>。具体请看之前写的<code>JNI基础</code>这篇文章。</li>
</ul>
<p>有关如何在<code>Android Stuido</code>中进行<code>ndk</code>开发请看另一篇文章。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android卸载反馈/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>