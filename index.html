<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=110 src="//music.163.com/outchain/player?type=0&id=120897804&auto=0&height=90"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-mac如何搭建Hexo博客" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/07/mac如何搭建Hexo博客/">mac如何搭建Hexo博客</a>
    </h1>
  

        
        <a href="/2019/10/07/mac如何搭建Hexo博客/" class="archive-article-date">
  	<time datetime="2019-10-06T17:11:35.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2019-10-07</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、Hexo搭建"><a href="#1、Hexo搭建" class="headerlink" title="1、Hexo搭建"></a>1、Hexo搭建</h2><p><img src="/pictures/2017_1_7/hexo_xmind.jpg" alt=""></p>
<p>####环境<br>一、环境安装</p>
<ol>
<li><p>node.js（在node.js官网中下载安装）node.js官网</p>
</li>
<li><p>git（OS系统中直接安装x-code就可以了）</p>
</li>
<li><p>hexo</p>
</li>
</ol>
<p>1）打开OS系统终端</p>
<p>2）输入安装hexo的代码(此处安装时有可能会提示输入系统管理员密码)</p>
<p>$ sudo npm install -g hexo<br>二、hexo创建静态博客</p>
<ol>
<li><p>新建blog文件夹</p>
</li>
<li><p>在终端进入该文件夹，初始化博客</p>
</li>
</ol>
<p>$ hexo init</p>
<ol>
<li>上述完成后，生成原始文件；blog文件夹就是博客的根目录</li>
</ol>
<ol>
<li>本地查看：启用本地服务命令(退出按ctrl+c)</li>
</ol>
<p>$ hexo s</p>
<ol>
<li>将出现的地址输入浏览器，即可可查看到本地效果</li>
</ol>
<p>三、github配置</p>
<ol>
<li><p>注册github账号并登陆</p>
</li>
<li><p>获取本机的SSH口令</p>
</li>
</ol>
<p>1）输入获取代码，回车直到出现图片所示图形为止</p>
<p>$ ssh-keygen</p>
<p>2）输入编译代码</p>
<p>$ vim ~/.ssh/id_rsa.pub<br>3）出现SSH口令后，将红框部分复制，并在下方输入:q，随后按下回车可以退出该窗口</p>
<p>4）进入到github页面设置SSH口令</p>
<p>点击用户下拉菜单中的settings（step1)</p>
<p>点击左侧的SHH and GPG keys（step2)</p>
<p>在Title中输入口令名称（随意）（step3)</p>
<p>在key中贴上SSH口令（step4)</p>
<ol>
<li>创建新的仓库</li>
</ol>
<p>1）创建新的仓库（repOSitory）</p>
<p>点击用户左侧的+号菜单中的New repOSitory（step1)</p>
<p>在repOSitory name中输入二级域名，格式请严格遵照username.github.io（step2)</p>
<p>ps：username填写github的登录用户名，否则上线的时候会报错</p>
<p>是否公开选项可以选取Public（step3)</p>
<p>勾选step4处，会自动生成一份可编辑的README.md文件（建议勾选）（step4)</p>
<p>点击create repOSitory生成仓库完毕（step5)</p>
<p>2）查看新建的仓库（repOSitory）</p>
<p>可以回到github个人首页点击右侧的仓库区</p>
<p>进入后在step1处选择并复制http地址，注意此时step2处应该是空的</p>
<p>四、发布博客</p>
<ol>
<li>设置blog配置文件</li>
</ol>
<p>1）打开blog文件夹下的_config.yml文件</p>
<p>2）找到最下方的type，输入git（注意冒号后面是带空格的）</p>
<p>3）repo行可能没有，需要自己输入，后面跟上github上仓库中复制的http地址（注意此时1、2两处应该是一样的username），不然上传时会报错</p>
<p>4）其他博客设置</p>
<p>title：博客名称</p>
<p>subtitle：博客副标题</p>
<p>description：博客描述</p>
<p>author：作者</p>
<p>language：语言（简体中文是zh-CN）</p>
<ol>
<li>在终端上传博客</li>
</ol>
<p>1）进入终端，输入git上传插件安装代码（安装时会提示输入github用户名及密码）</p>
<p>  $ npm install hexo-deployer-git –save<br>2）安装完毕后，输入获取代码</p>
<p>  $ hexo g<br>3）最后输入上传代码</p>
<p>  $ hexo d<br>4）重新在github仓库查看上传文件，此时在step2中会有之前bolg中生成的文件</p>
<p>5）step3处就是你的博客地址</p>
<p>五、新建与更新博客</p>
<ol>
<li>新建博客</li>
</ol>
<p>1）终端bolg文件下，输入新建博客代码</p>
<pre><code>$ hexo new &apos;filename&apos;
</code></pre><p>2）此时在bolg/source/_posts/下面会看到新建的博客</p>
<p>3）博客文件的后缀是.md文件，OS下推荐使用MOU编辑器mou下载地址</p>
<ol>
<li>更新博客</li>
</ol>
<p>1）完成编辑后，在终端上依次重复以下代码（此时必须先将编辑器关闭，否则会出现获取错误）</p>
<pre><code>$ hexo g
$ hexo d
</code></pre><p>2）完成后便能刷新博客网页看到新更新的内容了</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Hexo</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2019/10/07/mac如何搭建Hexo博客/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-怎么在Hexo搭建GithubPage中加入网易云音乐" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/10/怎么在Hexo搭建GithubPage中加入网易云音乐/">怎么在Hexo搭建GithubPage中加入网易云音乐</a>
    </h1>
  

        
        <a href="/2017/01/10/怎么在Hexo搭建GithubPage中加入网易云音乐/" class="archive-article-date">
  	<time datetime="2017-01-10T12:45:40.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-01-10</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Yilia主题（我使用的是这个主题就用这个来讲）"><a href="#Yilia主题（我使用的是这个主题就用这个来讲）" class="headerlink" title="Yilia主题（我使用的是这个主题就用这个来讲）"></a>Yilia主题（我使用的是这个主题就用这个来讲）</h3><p>进入网易云音乐: <a href="http://music.163.com/" target="_blank" rel="external">官网</a></p>
<p>推荐：自己注册账号，这样子可以创建自己喜欢的歌单，在里边收藏自己喜欢的歌曲</p>
<p><img src="/pictures/2017_1_10/yunmusic.png" alt=""></p>
<p>然后进入到自己的歌单</p>
<p><img src="/pictures/2017_1_10/yunmusiclist.png" alt=""></p>
<p>点击生成外链，获取到云音乐播放器代码</p>
<p><img src="/pictures/2017_1_10/yunmusicurl.png" alt=""></p>
<p>选择生成自己喜欢的样式，然后复制代码</p>
<p><img src="/pictures/2017_1_10/yunmusicplayer.png" alt=""></p>
<p>最后打开（themes/yilia/layout/_partial/left-col.ejs）<br>把复制好的网易云音乐放到第二行里边(当然这个是我的样式，我选择放在左边，你喜欢放在那里自己选择)</p>
<p><img src="/pictures/2017_1_10/playerlocation.png" alt=""></p>
<p>最后的效果图如下</p>
<p><img src="/pictures/2017_1_10/style.png" alt=""></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Hexo</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/10/怎么在Hexo搭建GithubPage中加入网易云音乐/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-windows10 使用Markdown Pad2不能预览" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="windows10-使用Markdown-Pad2不能预览"><a href="#windows10-使用Markdown-Pad2不能预览" class="headerlink" title="windows10 使用Markdown Pad2不能预览"></a>windows10 使用Markdown Pad2不能预览</h1><p>标签（空格分隔）： Markdown</p>
<hr>
<p>电脑升级到了Win10之后，在使用Warkdown写文章的时候右边的不能正确预览</p>
<p><img src="http://i1.piimg.com/567571/c1fe5e692bf3b9c6.png" alt=""></p>
<p>官方的说法是从 Win 8 开始就有这个问题了，解决办法就是安装 <a href="http://markdownpad.com/download/awesomium_v1.6.6_sdk_win.exe" target="_blank" rel="external">Awesomium 1.6.6 SDK</a>.，如果还是不行就再安装 <a href="http://www.microsoft.com/en-us/download/details.aspx?id=8109" target="_blank" rel="external">Microsoft’s DirectX End-User Runtimes (June 2010)</a>，经我实际测试，只需要安装前者就可以了。下面是官方的原文：</p>
<p>LivePreview is not working - it displays an error message stating This view has crashed!<br>This issue has been specifically observed in Windows 8. You may see an error message as shown here, and no HTML will be rendered when you type in the Markdown Editor pane.</p>
<p>To fix this issue, please try installing the Awesomium 1.6.6 SDK.</p>
<p><img src="http://i1.piimg.com/567571/654675a4c1b805b9.png" alt=""></p>
<p>If you continue to experience issues, please install Microsoft’s DirectX End-User Runtimes (June 2010).</p>
<p>Referer:MarkdownPad - Frequently Asked Questions</p>
<p>完成之后效果如下：</p>
<p><img src="http://p1.bqimg.com/567571/76bc858b346f8e85.png" alt=""></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/10/windows10 使用Markdown Pad2不能预览/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-深入了解java接口和抽象类" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/01/深入了解java接口和抽象类/">深入了解Java接口和抽象类</a>
    </h1>
  

        
        <a href="/2017/01/01/深入了解java接口和抽象类/" class="archive-article-date">
  	<time datetime="2016-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、抽象类"><a href="#一、抽象类" class="headerlink" title="一、抽象类"></a>一、抽象类</h2><p>　　在了解抽象类之前，先来了解一下抽象方法。抽象方法是一种特殊的方法：它只有声明，而没有具体的实现。抽象方法的声明格式为：<br>　　<br>　　<br><code>abstract void fun();</code></p>
<p>　　抽象方法必须用abstract关键字进行修饰。如果一个类含有抽象方法，则称这个类为抽象类，抽象类必须在类前用abstract关键字修饰。因为抽象类中含有无具体实现的方法，所以不能用抽象类创建对象。</p>
<p>　　下面要注意一个问题：在《JAVA编程思想》一书中，将抽象类定义为“包含抽象方法的类”，但是后面发现如果一个类不包含抽象方法，只是用abstract修饰的话也是抽象类。也就是说抽象类不一定必须含有抽象方法。个人觉得这个属于钻牛角尖的问题吧，因为如果一个抽象类不包含任何抽象方法，为何还要设计为抽象类？所以暂且记住这个概念吧，不必去深究为什么。<br>　　<br>　　<br><code>[public] abstract class ClassName {
    abstract void fun();
}</code></p>
<p>　　从这里可以看出，抽象类就是为了继承而存在的，如果你定义了一个抽象类，却不去继承它，那么等于白白创建了这个抽象类，因为你不能用它来做任何事情。对于一个父类，如果它的某个方法在父类中实现出来没有任何意义，必须根据子类的实际需求来进行不同的实现，那么就可以将这个方法声明为abstract方法，此时这个类也就成为abstract类了。</p>
<p>　　包含抽象方法的类称为抽象类，但并不意味着抽象类中只能有抽象方法，它和普通类一样，同样可以拥有成员变量和普通的成员方法。注意，抽象类和普通类的主要有三点区别：</p>
<p>　　1.抽象方法必须为public或者protected（因为如果为private，则不能被子类继承，子类便无法实现该方法），缺省情况下默认为public。</p>
<p>　　2.抽象类不能用来创建对象；</p>
<p>　　3.如果一个类继承于一个抽象类，则子类必须实现父类的抽象方法。如果子类没有实现父类的抽象方法，则必须将子类也定义为为abstract类。<br>　　在其他方面，抽象类和普通的类并没有区别。
　　</p>
<h2 id="二、接口"><a href="#二、接口" class="headerlink" title="二、接口"></a>二、接口</h2><p>　　接口，英文称作interface，在软件工程中，接口泛指供别人调用的方法或者函数。从这里，我们可以体会到Java语言设计者的初衷，它是对行为的抽象。在Java中，定一个接口的形式如下：
　　</p>
<p><code>[public] interface InterfaceName {
 //
}</code></p>
<p>　　接口中可以含有 变量和方法。但是要注意，接口中的变量会被隐式地指定为public static final变量（并且只能是public static final变量，用private修饰会报编译错误），而方法会被隐式地指定为public abstract方法且只能是public abstract方法（用其他关键字，比如private、protected、static、 final等修饰会报编译错误），并且接口中所有的方法不能有具体的实现，也就是说，接口中的方法必须都是抽象方法。从这里可以隐约看出接口和抽象类的区别，接口是一种极度抽象的类型，它比抽象类更加“抽象”，并且一般情况下不在接口中定义变量。</p>
<p>　　要让一个类遵循某组特地的接口需要使用implements关键字，具体格式如下：<br>　　<br><code>class ClassName implements Interface1,Interface2,[....]{
}</code></p>
<p>　　可以看出，允许一个类遵循多个特定的接口。如果一个非抽象类遵循了某个接口，就必须实现该接口中的所有方法。对于遵循某个接口的抽象类，可以不实现该接口中的抽象方法。</p>
<p>##三、抽象类和接口的区别<br>1.语法层面上的区别</p>
<p>　　1）抽象类可以提供成员方法的实现细节，而接口中只能存在public abstract 方法；</p>
<p>　　2）抽象类中的成员变量可以是各种类型的，而接口中的成员变量只能是public static final类型的；</p>
<p>　　3）接口中不能含有静态代码块以及静态方法，而抽象类可以有静态代码块和静态方法；</p>
<p>　　4）一个类只能继承一个抽象类，而一个类却可以实现多个接口。</p>
<p>2.设计层面上的区别</p>
<p>　　1）抽象类是对一种事物的抽象，即对类抽象，而接口是对行为的抽象。抽象类是对整个类整体进行抽象，包括属性、行为，但是接口却是对类局部（行为）进行抽象。举个简单的例子，飞机和鸟是不同类的事物，但是它们都有一个共性，就是都会飞。那么在设计的时候，可以将飞机设计为一个类Airplane，将鸟设计为一个类Bird，但是不能将 飞行 这个特性也设计为类，因此它只是一个行为特性，并不是对一类事物的抽象描述。此时可以将 飞行 设计为一个接口Fly，包含方法fly( )，然后Airplane和Bird分别根据自己的需要实现Fly这个接口。然后至于有不同种类的飞机，比如战斗机、民用飞机等直接继承Airplane即可，对于鸟也是类似的，不同种类的鸟直接继承Bird类即可。从这里可以看出，继承是一个 “是不是”的关系，而 接口 实现则是 “有没有”的关系。如果一个类继承了某个抽象类，则子类必定是抽象类的种类，而接口实现则是有没有、具备不具备的关系，比如鸟是否能飞（或者是否具备飞行这个特点），能飞行则可以实现这个接口，不能飞行就不实现这个接口。</p>
<p>　　2）设计层面不同，抽象类作为很多子类的父类，它是一种模板式设计。而接口是一种行为规范，它是一种辐射式设计。什么是模板式设计？最简单例子，大家都用过ppt里面的模板，如果用模板A设计了ppt B和ppt C，ppt B和ppt C公共的部分就是模板A了，如果它们的公共部分需要改动，则只需要改动模板A就可以了，不需要重新对ppt B和ppt C进行改动。而辐射式设计，比如某个电梯都装了某种报警器，一旦要更新报警器，就必须全部更新。也就是说对于抽象类，如果需要添加新的方法，可以直接在抽象类中添加具体的实现，子类可以不进行变更；而对于接口则不行，如果接口进行了变更，则所有实现这个接口的类都必须进行相应的改动。</p>
<p>　　下面看一个网上流传最广泛的例子：门和警报的例子：门都有open( )和close( )两个动作，此时我们可以定义通过抽象类和接口来定义这个抽象概念：</p>
<p><code>abstract class Door {
    public abstract void open();
    public abstract void close();
}</code></p>
<p>或者：</p>
<p><code>interface Door {
    public abstract void open();
    public abstract void close();
}</code></p>
<p>但是现在如果我们需要门具有报警alarm( )的功能，那么该如何实现？下面提供两种思路：</p>
<p>　　1）将这三个功能都放在抽象类里面，但是这样一来所有继承于这个抽象类的子类都具备了报警功能，但是有的门并不一定具备报警功能；</p>
<p>　　2）将这三个功能都放在接口里面，需要用到报警功能的类就需要实现这个接口中的open( )和close( )，也许这个类根本就不具备open( )和close( )这两个功能，比如火灾报警器。</p>
<p>　　从这里可以看出， Door的open() 、close()和alarm()根本就属于两个不同范畴内的行为，open()和close()属于门本身固有的行为特性，而alarm()属于延伸的附加行为。因此最好的解决办法是单独将报警设计为一个接口，包含alarm()行为,Door设计为单独的一个抽象类，包含open和close两种行为。再设计一个报警门继承Door类和实现Alarm接口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">interface Alram &#123;</div><div class="line">    void alarm();</div><div class="line">&#125;</div><div class="line"> </div><div class="line">abstract class Door &#123;</div><div class="line">    void open();</div><div class="line">    void close();</div><div class="line">&#125;</div><div class="line"> </div><div class="line">class AlarmDoor extends Door implements Alarm &#123;</div><div class="line">    void oepn() &#123;</div><div class="line">      //....</div><div class="line">    &#125;</div><div class="line">    void close() &#123;</div><div class="line">      //....</div><div class="line">    &#125;</div><div class="line">    void alarm() &#123;</div><div class="line">      //....</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>　</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/01/深入了解java接口和抽象类/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(下)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(下)/">RxJava详解(下)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(下)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:03.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-下"><a href="#RxJava详解-下" class="headerlink" title="RxJava详解(下)"></a>RxJava详解(下)</h1><h2 id="变换的原理lift"><a href="#变换的原理lift" class="headerlink" title="变换的原理lift()"></a>变换的原理<code>lift()</code></h2><p>这些变换虽然功能各有不同，但实质上都是针对事件序列的处理和再发送。而在<code>RxJava</code>的内部，它们是基于同一个基础的变换方法：<code>lift()</code>。</p>
<p>首先看一下<code>lift()</code> 的内部实现（仅核心代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意：这不是 lift() 的源码，而是将源码中与性能、兼容性、扩展性有关的代码剔除后的核心代码。</span></div><div class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">lift</span><span class="params">(Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> OnSubscribe&lt;R&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber subscriber)</span> </span>&#123;</div><div class="line">            Subscriber newSubscriber = operator.call(subscriber);</div><div class="line">            newSubscriber.onStart();</div><div class="line">            onSubscribe.call(newSubscriber);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码很有意思：它生成了一个新的<code>Observable</code>并返回，而且创建新<code>Observable</code>所用的参数<code>OnSubscribe的回调方法</code>call()<code>中的实现竟然看起来和前面讲过的</code>Observable.subscribe()<code>一样！然而它们并不一样哟~不一样的地方关键就在于第二行</code>onSubscribe.call(subscriber)<code>中的</code>onSubscribe` 所指代的对象不同（高能预警：接下来的几句话可能会导致身体的严重不适）</p>
<ul>
<li><code>subscribe()</code>中这句话的<code>onSubscribe</code>指的是<code>Observable</code>中的<code>onSubscribe</code>对象，这个没有问题，但是<code>lift()</code>之后的情况就复杂了点。</li>
<li>当含有<code>lift()</code>时： <ul>
<li><code>lift()</code>创建了一个<code>Observable</code>后，加上之前的原始<code>Observable</code>，已经有两个<code>Observable</code>了； </li>
<li>而同样地，新<code>Observable</code>里的新<code>OnSubscribe</code>加上之前的原始<code>Observable</code>中的原始<code>OnSubscribe</code>，也就有了两个<code>OnSubscribe</code>； </li>
<li>当用户调用经过<code>lift()</code>后的<code>Observable</code>的<code>subscribe()</code>的时候，使用的是<code>lift()</code>所返回的新的<code>Observable</code>，于是它所触发的<code>onSubscribe.call(subscriber)</code>，也是用的新<code>Observable</code>中的新<code>OnSubscribe</code>，即在<code>lift()</code>中生成的那个<code>OnSubscribe</code>； </li>
<li>而这个新<code>OnSubscribe</code>的<code>call()</code>方法中的<code>onSubscribe</code>，就是指的原始<code>Observable</code>中的原始<code>OnSubscribe</code>，在这个<code>call()</code>方法里，新<code>OnSubscribe</code>利用<code>operator.call(subscriber)</code>生成了一个新的<code>Subscriber</code>(<code>Operator</code>就是在这里，通过自己的<code>call()</code>方法将新<code>Subscriber</code>和原始<code>Subscriber</code> 进行关联，并插入自己的『变换』代码以实现变换），然后利用这个新<code>Subscriber</code>向原始<code>Observable</code>进行订阅。<br>这样就实现了<code>lift()</code>过程，有点像一种代理机制，通过事件拦截和处理实现事件序列的变换。</li>
</ul>
</li>
</ul>
<p>精简掉细节的话，也可以这么说：在<code>Observable</code>执行了<code>lift(Operator)</code>方法之后，会返回一个新的<code>Observable</code>，这个新的<code>Observable</code>会像一个代理一样，负责接收原始的<code>Observable</code> 发出的事件，并在处理后发送给<code>Subscriber</code>。</p>
<p>如果你更喜欢具象思维，可以看图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_lift.gif?raw=true" alt="image"></p>
<p>举一个具体的<code>Operator</code>的实现。下面这是一个将事件中的<code>Integer</code>对象转换成<code>String</code>的例子，仅供参考：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">observable.lift(<span class="keyword">new</span> Observable.Operator&lt;String, Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> Integer&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber) &#123;</div><div class="line">        <span class="comment">// 将事件序列中的 Integer 对象转换为 String 对象</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                subscriber.onNext(<span class="string">""</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">                subscriber.onCompleted();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                subscriber.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>讲述<code>lift()</code>的原理只是为了让你更好地了解<code>RxJava</code> ，从而可以更好地使用它。然而不管你是否理解了<code>lift()</code>的原理,<code>RxJava</code>都不建议开发者自定义<code>Operator</code>来直接使用<code>lift()</code>，而是建议尽量使用已有的<code>lift()</code>包装方法（如<code>map()、flatMap()</code>等）进行组合来实现需求，因为直接使用<code>lift()</code>非常容易发生一些难以发现的错误。</p>
</blockquote>
<h2 id="线程控制Scheduler"><a href="#线程控制Scheduler" class="headerlink" title="线程控制Scheduler"></a>线程控制<code>Scheduler</code></h2><p>在不指定线程的情况下，<code>RxJava</code>遵循的是线程不变的原则，即在哪个线程调用<code>subscribe()</code>方法就在哪个线程生产事件；在哪个线程生产事件，就在哪个线程消费事件。也就是说事件的发出和消费都是在同一个线程的。观察者模式本身的目的就是『后台处理，前台回调』的异步机制，因此异步对于<code>RxJava</code>是至关重要的。而要实现异步，则需要用到<code>RxJava</code>的另一个概念：<code>Scheduler</code>。   </p>
<p>####<code>Scheduler</code>简介</p>
<p>在<code>RxJava</code>中,<code>Scheduler</code>相当于线程控制器，<code>RxJava</code>通过它来指定每一段代码应该运行在什么样的线程。<code>RxJava</code>已经内置了几个<code>Scheduler</code>，它们已经适合大多数的使用场景：</p>
<ul>
<li><code>Schedulers.immediate()</code>: 直接在当前线程运行，相当于不指定线程。这是默认的<code>Scheduler</code>。</li>
<li><code>Schedulers.newThread()</code>: 总是启用新线程，并在新线程执行操作。</li>
<li><code>Schedulers.io()</code>: I/O 操作（读写文件、读写数据库、网络信息交互等）所使用的<code>Scheduler</code>。行为模式和<code>newThread()</code>差不多，区别在于<code>io()</code> 的内部实现是是用一个无数量上限的线程池，可以重用空闲的线程，因此多数情况下<code>io()</code>比<code>newThread()</code>更有效率。不要把计算工作放在<code>io()</code>中，可以避免创建不必要的线程。</li>
<li><code>Schedulers.computation()</code>: 计算所使用的<code>Scheduler</code>。这个计算指的是<code>CPU</code>密集型计算，即不会被<code>I/O</code>等操作限制性能的操作，例如图形的计算。这个<code>Scheduler</code> 使用的固定的线程池，大小为<code>CPU</code>核数。不要把<code>I/O</code>操作放在<code>computation()</code>中，否则<code>I/O</code>操作的等待时间会浪费<code>CPU</code>。</li>
<li>另外，<code>Android</code>还有一个专用的<code>AndroidSchedulers.mainThread()</code>，它指定的操作将在<code>Android</code>主线程运行。</li>
</ul>
<p>有了这几个<code>Scheduler</code>，就可以使用<code>subscribeOn()</code>和<code>observeOn()</code>两个方法来对线程进行控制了。<code>subscribeOn()</code>指定<code>subscribe()</code>所发生的线程，即<code>Observable.OnSubscribe()</code>被激活时所处的线程或者叫做事件产生的线程。<code>observeOn()</code>指定<code>Subscriber</code>所运行在的线程或者叫做事件消费的线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>)</div><div class="line">        .subscribeOn(Schedulers.io()) <span class="comment">// 指定 subscribe() 发生在 IO 线程，可以理解成数据的获取是在io线程</span></div><div class="line">        .observeOn(AndroidSchedulers.mainThread())<span class="comment">// 指定 Subscriber 的回调发生在主线程，可以理解成数据的消费时在主线程</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">                Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>上面这段代码中，<code>subscribeOn(Schedulers.io())</code>的指定会让创建的事件的内容<code>Hello</code>、<code>World !</code>将会在<code>IO</code>线程发出；而由于<code>observeOn(AndroidScheculers.mainThread())</code> 的指定，因此<code>subscriber()</code>方法设置后的回调中内容的打印将发生在主线程中。事实上，这种在<code>subscribe()</code>之前写上两句<code>subscribeOn(Scheduler.io())</code>和<code>observeOn(AndroidSchedulers.mainThread())</code>的使用方式非常常见，它适用于多数的<strong><em>后台线程取数据，主线程显示</em></strong>的程序策略。</p>
<p>####<code>Scheduler</code>的原理</p>
<p><code>RxJava</code>的<code>Scheduler API</code>很方便，也很神奇（加了一句话就把线程切换了，怎么做到的？而且 subscribe() 不是最外层直接调用的方法吗，它竟然也能被指定线程？）。然而 Scheduler 的原理需要放在后面讲，因为它的原理是以下一节《变换》的原理作为基础的。</p>
<p>好吧这一节其实我屁也没说，只是为了让你安心，让你知道我不是忘了讲原理，而是把它放在了更合适的地方。</p>
<p>能不能多切换几次线程？答案是：能。因为<code>observeOn()</code>指定的是<code>Subscriber</code>的线程，而这个<code>Subscriber</code>并不是（严格说应该为『不一定是』，但这里不妨理解为『不是』）<code>subscribe()</code> 参数中的<code>Subscriber</code>，而是<code>observeOn()</code>执行时的当前<code>Observable</code>所对应的<code>Subscriber</code>，即它的直接下级<code>Subscriber</code>。换句话说<code>observeOn()</code> 指定的是它之后的操作所在的线程。因此如果有多次切换线程的需求，只要在每个想要切换线程的位置调用一次<code>observeOn()</code>即可。</p>
<p>上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>) <span class="comment">// IO 线程，由 subscribeOn() 指定</span></div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(Schedulers.newThread())</div><div class="line">    .map(mapOperator) <span class="comment">// 新线程，由 observeOn() 指定</span></div><div class="line">    .observeOn(Schedulers.io())</div><div class="line">    .map(mapOperator2) <span class="comment">// IO 线程，由 observeOn() 指定</span></div><div class="line">    .observeOn(AndroidSchedulers.mainThread) </div><div class="line">    .subscribe(subscriber);  <span class="comment">// Android 主线程，由 observeOn() 指定</span></div></pre></td></tr></table></figure>
<p>如上，通过<code>observeOn()</code>的多次调用，程序实现了线程的多次切换。<br>不过，不同于<code>observeOn()</code>,<code>subscribeOn()</code>的位置放在哪里都可以，但它是只能调用一次的。</p>
<p>其实，<code>subscribeOn()</code>和<code>observeOn()</code>的内部实现，也是用的<code>lift()</code>。</p>
<p>具体看图（不同颜色的箭头表示不同的线程,<code>subscribeOn()</code>原理图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_subscribeon.jpg?raw=true" alt="image"></p>
<p><code>observeOn()</code>原理图: </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observeon.jpg?raw=true" alt="image"></p>
<p>从图中可以看出,<code>subscribeOn()</code>和<code>observeOn()</code>都做了线程切换的工作（图中的<code>schedule...</code>部位）。不同的是,<code>subscribeOn()</code>的线程切换发生在<code>OnSubscribe</code>中，即在它通知上一级 <code>OnSubscribe</code>时，这时事件还没有开始发送，因此<code>subscribeOn()</code>的线程控制可以从事件发出的开端就造成影响；而<code>observeOn()</code>的线程切换则发生在它内建的<code>Subscriber</code>中，即发生在它即将给下一级<code>Subscriber</code>发送事件时，因此<code>observeOn()</code>控制的是它后面的线程。</p>
<p>最后，我用一张图来解释当多个<code>subscribeOn()</code>和<code>observeOn()</code>混合使用时，线程调度是怎么发生的（由于图中对象较多，相对于上面的图对结构做了一些简化调整）：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observable_list.jpg?raw=true" alt="image"></p>
<p>图中共有5处含有对事件的操作。由图中可以看出，①和②两处受第一个<code>subscribeOn()</code>影响，运行在红色线程；③和④处受第一个<code>observeOn()</code>的影响，运行在绿色线程；⑤处受第二个 <code>onserveOn()</code>影响，运行在紫色线程；而第二个<code>subscribeOn()</code>，由于在通知过程中线程就被第一个<code>subscribeOn()</code> 截断，因此对整个流程并没有任何影响。这里也就回答了前面的问题：当使用了多个<code>subscribeOn()</code>的时候，只有第一个<code>subscribeOn()</code>起作用。</p>
<p>在前面讲<code>Subscriber</code>的时候，提到过<code>Subscriber</code>的<code>onStart()</code>可以用作流程开始前的初始化。然而<code>onStart()</code>由于在<code>subscribe()</code>发生时就被调用了，因此不能指定线程，而是只能执行在<code>subscribe()</code>被调用时的线程。这就导致如果<code>onStart()</code>中含有对线程有要求的代码（例如在界面上显示一个<code>ProgressBar</code>，这必须在主线程执行），将会有线程非法的风险，因为有时你无法预测<code>subscribe()</code>将会在什么线程执行。</p>
<p>而与<code>Subscriber.onStart()</code>相对应的，有一个方法<code>Observable.doOnSubscribe()</code>。它和<code>Subscriber.onStart()</code>同样是在<code>subscribe()</code>调用后而且在事件发送前执行，但区别在于它可以指定线程。默认情况下,<code>doOnSubscribe()</code>执行在<code>subscribe()</code>发生的线程；而如果在<code>doOnSubscribe()</code>之后有<code>subscribeOn()</code>的话，它将执行在离它最近的<code>subscribeOn()</code>所指定的线程。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Observable.create(onSubscribe)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">            progressBar.setVisibility(View.VISIBLE); <span class="comment">// 需要在主线程执行</span></div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribeOn(AndroidSchedulers.mainThread()) <span class="comment">// 指定主线程</span></div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>如上，在<code>doOnSubscribe()</code>的后面跟一个<code>subscribeOn()</code>，就能指定准备工作的线程了。</p>
<p>####总结</p>
<p><code>RxJava</code>辣么好，难道他就没有缺点吗？当然有那就是使用越来越多的订阅，内存开销也会变得很大，稍不留神就会出现内存溢出的情况。我们可以用<code>RxJava</code>实现基本任何功能，但是你并不能这么做，你要明白什么时候需要用它，而什么时候没必要用它，不要一味的把功能都有<code>RxJava</code>来实现。    </p>
<p>至于上面提到的<code>2.0</code>版本，有关它的区别请见:<br><a href="https://github.com/ReactiveX/RxJava/wiki/What&#39;s-different-in-2.0">What’s different in 2.0</a></p>
<h2 id="Agera"><a href="#Agera" class="headerlink" title="Agera"></a>Agera</h2><p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/agera.png?raw=true" alt="image"></p>
<p>之前<code>Google</code>发布<code>agera</code>，它在<code>Github</code>上的介绍是:<code>Reactive Programming for Android</code></p>
<p><a href="https://github.com/google/agera">agera</a></p>
<p>既然是响应式编程框架，其核心思想肯定和<code>RxJava</code>也是类似的。<br><code>Agera</code>中核心也是关于事件流（数据流）的处理，可以转换数据、可以指定数据操作函数在那个线程执行。<br>而<code>Agera</code>和<code>RxJava</code>不一样的地方在于，<code>Agera</code>提供了一个新的事件响应和数据请求的模型，被称之为<code>Push event, pull data</code>。也就是一个事件发生了，会通过回调来主动告诉你，你关心的事件发生了。然后你需要主动的去获取数据，根据获取到的数据做一些操作。而<code>RxJava</code>在事件发生的时候，已经带有数据了。为了支持 <code>Push event pull data</code>模型，<code>Agera</code>中有个新的概念 — <code>Repository</code>。<code>Repository</code>翻译过来也就是数据仓库,是用来提供数据的,当你收到事件的时候,通过<code>Repository</code>来获取需要的数据。 这样做的好处是，把事件分发和数据处理的逻辑给分开了，事件分发做的事情比较少，事件分发就比较高效，当你收到事件后，根据当前的状态如果发现这个时候，数据已经无效了，则你根本不用请求数据，这样数据也就不用去处理和转换了。这样可以避免无用的数据计算，而有用的数据计算也可以在你需要的时候才去计算。<br>同样，在多线程环境下，使用<code>push event pull data</code>模型，可能当你收到事件通知的时候，你只能获取到最新的数据，无法去获取历史数据了。设计就是这样考虑的，因为在<code>Android</code>开发中大部分的数据都是用来更新<code>UI</code>的，这个时候你根本不需要旧的数据了，只要最新的就够了。</p>
<p><code>Agera</code>相对比较简单，并且是一个专业为<code>Android</code>平台打造的响应式编程框架。但是如果你熟悉了<code>RxJava</code>你会发现其用起来会有点不舒服，特别是还要主动的获取数据略感不爽（虽然提高了事件分发的效率）。 </p>
<p>总之，现在看来<code>RxJava</code>支持的比较全面，但是会略显笨重，而<code>Agera</code>是一个专门为<code>Android</code>平台设计的响应式编程框架，比较轻巧，当然支持的并不是很全面。可以根据自己的喜好来选择.</p>
<p>但是从个人观点来看<code>Agera</code>比起来<code>RxJava</code>还是相差几个版本。当然这是我的片面之词，有关更多信息请看<a href="https://github.com/google/agera/issues/20">Question: what’s the relation to RxJava?</a></p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(下)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(中)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(中)/">RxJava详解(中)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(中)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:01.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-中"><a href="#RxJava详解-中" class="headerlink" title="RxJava详解(中)"></a>RxJava详解(中)</h1><h2 id="说好的简洁呢？"><a href="#说好的简洁呢？" class="headerlink" title="说好的简洁呢？"></a>说好的简洁呢？</h2><p>上面这一部分，又是介绍、又是<code>Hello World</code>、又是数据变换，但是你会发现然而并没有什么卵用。说好的简洁一点也木有体现出来。    </p>
<p>下面我们会通过一个简单的例子来进行说明。现在我们有这样一个需求:    </p>
<blockquote>
<p>有一个服务提供了一些<code>API</code>来搜索整个网络上的符合查询关键字的所有猫的图片。 每个图片包含一个可爱程度的参数(一个整数值表示其可爱程度)。 我们的任务就是下载所有猫的列表并选择最可爱的那个，把它的图片保存到本地。</p>
</blockquote>
<p>####<code>Model</code>和<code>API</code></p>
<p>下面是猫的数据结构<code>Cat</code>:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Cat</span>&gt;</span>&#123;</div><div class="line">    Bitmap image;</div><div class="line">    <span class="keyword">int</span> cuteness;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Cat another)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Integer.compare(cuteness, another.cuteness);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的<code>API</code>会调用<code>cat-sdk.jar</code>中堵塞式的接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="function">List&lt;Cat&gt; <span class="title">queryCats</span><span class="params">(String query)</span></span>;</div><div class="line">    <span class="function">Uri <span class="title">store</span><span class="params">(Cat cat)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看起来很清晰吧？当然了，我们继续写客户端的业务逻辑.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">saveTheCutestCat</span><span class="params">(String query)</span></span>&#123;</div><div class="line">        List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">        Cat cutest = findCutest(cats);</div><div class="line">        Uri savedUri = api.store(cutest);</div><div class="line">        <span class="keyword">return</span> savedUri;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通俗易懂、简单明了，非常酷的代码。主要的函数<code>saveTheCutestCat()</code>只包含了3个方法。使用这些方法然后等待方法执行完并接受返回值就可以了。</p>
<p>非常简单、有效。接下来我们看一下这种方式的其他优点。  </p>
<p>####组合</p>
<p>可以看到我们的<code>saveTheCutestCat</code>由其他三个函数调用所组成的。我们通过函数来把一个大功能分割为每个容易理解的小功能。通过函数调用来组合使用这些小功能。使用和理解起来都相当简单</p>
<p>####异常传递</p>
<p>另外一个使用函数的好处就是方便处理异常。每个函数都可以通过抛出异常来结束运行。该异常可以在抛出异常的函数里面处理，也可以在调用该函数的外面处理，所以我们无需每次都处理每个异常，我们可以在一个地方处理所有可能抛出的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">    Cat cutest = findCutest(cats);</div><div class="line">    Uri savedUri = api.store(cutest);</div><div class="line">    <span class="keyword">return</span> savedUri;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    e.printStackTrace()</div><div class="line">    <span class="keyword">return</span> someDefaultValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，我们就可以处理这三个函数中所抛出的任何异常了。如果没有<code>try catch</code>语句，我们也可以把异常继续传递下去。</p>
<h2 id="向异步粗发"><a href="#向异步粗发" class="headerlink" title="向异步粗发"></a>向异步粗发</h2><p>但是，现实世界中我们往往没法等待。有些时候你没法只使用阻塞调用。在<code>Android</code>中你需要处理各种异步操作。<br>就那<code>Android</code>的<code>OnClickListener</code>接口来说吧，如果你需要处理一个<code>View</code>的点击事件，你必须提供一个该<code>Listener</code> 的实现来处理用户的点击事件。下面来看看如何处理异步调用。</p>
<p>####异步网络调用</p>
<p>假设我们的<code>cats-sdk.jar</code>使用了异步调用的<code>API</code>来访问网络资源，<br>这样我们的新<code>API</code>接口就变为这样了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">CatsQueryCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, CatsQueryCallback catsQueryCallback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Uri <span class="title">store</span><span class="params">(Cat cat)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们查询猫的操作就变为异步的了， 通过<code>CatsQueryCallback</code>回调接口来结束查询的数据和处理异常情况。<br>我们的业务逻辑也需要跟着改变一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutestCatCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCutestCatSaved</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, CutestCatCallback cutestCatCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                Uri savedUri = api.store(cutest);</div><div class="line">                cutestCatCallback.onCutestCatSaved(savedUri);</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onQueryFailed(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们没法让<code>saveTheCutestCat</code>函数返回一个值了， 我们需要一个回调接口来异步的处理结果。<br>这里我们再进一步，使用两个异步操作来实现我们的功能,例如我们需要使用异步<code>IO</code>来写文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">CatsQueryCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">StoreCallback</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, CatsQueryCallback catsQueryCallback)</span></span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(Cat cat, StoreCallback storeCallback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的<code>helper</code>会变成:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutestCatCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCutestCatSaved</span><span class="params">(Uri uri)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, CutestCatCallback cutestCatCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                api.store(cutest, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onCutestCatSaved(uri);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们再来看看这部分代码？还是之前那样简单暴力？现在有太多的干扰代码、匿名类，这简直是太恐怖了，但是他们的业务逻辑其实是一样的，都是查询猫的列表数据，然后找出最可爱的猫并保存它的图片。    </p>
<p>上面说好的组合功能没有了，现在你没法像阻塞操作一样来组合调用每个功能了，异步操作中，每次你都必须通过回调接口来手工的处理结果。 </p>
<p>上面说好的异常处理也没有了，异步代码中的异常不会自动传递，我们需要手动的去重新传递。(<code>onStoreFailed()</code>和<code>onQueryFailed()</code>就是干这事的)</p>
<p>####结果？</p>
<p>然后呢？我们可以怎么做？我们能不能使用无回调的模式？我们试着修复一下。 </p>
<p>####奔向更好的世界     </p>
<p>####通用的回调</p>
<p>如果我们仔细的观察下回调接口，我们会发现它们的共性:   </p>
<ul>
<li>它们都有一个分发结果的方法(<code>onCutestCatSaved()</code>,<code>onCatListReceived()</code>,<code>onCatStored()</code>)</li>
<li>它们中的绝大部分都有一个处理操作过程中异常的方法(<code>onError()</code>, <code>onQueryFailed()</code>, <code>onStoreFailed()</code>)</li>
</ul>
<p>所以我们可以创建一个通用的回调来取代它们。但是我们无法修改<code>api</code>的调用结构，我们只能创建一个包裹层的调用。   </p>
<p>我们通用的回调如下:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们创建一个<code>ApiWrapper</code>类来改变我们调用的结构:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryCats</span><span class="params">(String query, Callback&lt;List&lt;Cat&gt;&gt; catsCallback)</span></span>&#123;</div><div class="line">        api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                catsCallback.onResult(cats);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                catsCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">store</span><span class="params">(Cat cat, Callback&lt;Uri&gt; uriCallback)</span></span>&#123;</div><div class="line">        api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                uriCallback.onResult(uri);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                uriCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样通过新的回调我们可以减少一次处理结果和异常的逻辑。<br>最终，我们的<code>CatsHelper</code>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span></span>&#123;</div><div class="line"></div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTheCutestCat</span><span class="params">(String query, Callback&lt;Uri&gt; cutestCatCallback)</span></span>&#123;</div><div class="line">        apiWrapper.queryCats(query, <span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                Cat cutest = findCutest(cats);</div><div class="line">                apiWrapper.store(cutest, cutestCatCallback);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                cutestCatCallback.onError(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了，现在比之前的代码稍微简单点了。但是我们能不能做的更好？ 当然可以！</p>
<p>####保持参数和回调的分离性</p>
<p>看看这些新的异步操作(<code>queryCats</code>,<code>store</code>和<code>saveTheCutestCat</code>)。这些函数都有同样的模式。使用一些参数来调用这些函数<code>(query,cat)</code>，同时还有一个回调接口作为参数。甚至，所有的异步操作都带有一些常规参数和一个额外的回调接口参数。如果我们把他们分离开会如何，让每个异步操作只有一些常规参数而把返回一个临时的对象来操作回调接口。<br>下面来试试看看这种方式能否有效。<br>如果我们返回一个临时的对象作为异步操作的回调接口处理方式，我们需要先定义这个对象。由于对象遵守通用的行为(有一个回调接口参数)，我们定义一个能用于所有操作的对象。我们称之为<code>AsyncJob</code>。</p>
<blockquote>
<p>注意： 我非常想把这个名字称之为<code>AsyncTask</code>。但是由于<code>Android</code>系统已经有个<code>AsyncTask</code>类了， 为了避免混淆，所以就用<code>AsyncJob</code>了。</p>
</blockquote>
<p>该对象如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>start()</code>函数有个<code>Callback</code>回调接口参数，并开始执行该操作。<br><code>ApiWrapper</code>修改为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> AsyncJob&lt;List&lt;Cat&gt;&gt; queryCats(String query) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;List&lt;Cat&gt;&gt; catsCallback)</span> </span>&#123;</div><div class="line">                api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                        catsCallback.onResult(cats);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        catsCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">store</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; uriCallback)</span> </span>&#123;</div><div class="line">                api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        uriCallback.onResult(uri);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        uriCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>目前看起来还不错。现在可以使用<code>AsyncJob.start()</code>来启动每个操作了。接下来我们修改<code>CatsHelper</code>类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                apiWrapper.queryCats(query)</div><div class="line">                        .start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                                Cat cutest = findCutest(cats);</div><div class="line">                                apiWrapper.store(cutest)</div><div class="line">                                        .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                            <span class="meta">@Override</span></div><div class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                                cutestCatCallback.onResult(result);</div><div class="line">                                            &#125;</div><div class="line"> </div><div class="line">                                            <span class="meta">@Override</span></div><div class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                                cutestCatCallback.onError(e);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;);</div><div class="line">                            &#125;</div><div class="line"> </div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                cutestCatCallback.onError(e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来比前面一个版本更加复杂啊，这样有啥好处啊？<br>这里其实我们返回的是一个<code>AsyncJob</code>对象，该对象和客户端代码组合使用，这样在<code>Activity</code>或者<code>Fragment</code>客户端代码中就可以操作这个返回的对象了。<br>代码虽然目前看起来比较复杂，下面我们就来改进一下。</p>
<p>####分解</p>
<p>下面是流程图:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">         (async)                 (sync)           (async)</div><div class="line">query ===========&gt; List&lt;Cat&gt; -------------&gt; Cat ==========&gt; Uri</div><div class="line">       queryCats              findCutest           store</div></pre></td></tr></table></figure></p>
<p>为了让代码具有可读性，我们把这个流程分解为每个操作。同时我们再进一步假设，如果一个操作是异步的，则每个调用该异步操作的函数也是异步的。例如：如果查询猫是个异步操作，则找到最可爱的猫操作也是异步的。</p>
<p>因此，我们可以使用<code>AsyncJob</code>来把这些操作分解为一些小的操作中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Cat&gt; callback)</span> </span>&#123;</div><div class="line">                catsListAsyncJob.start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; result)</span> </span>&#123;</div><div class="line">                        callback.onResult(findCutest(result));</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                cutestCatAsyncJob.start(<span class="keyword">new</span> Callback&lt;Cat&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Cat cutest)</span> </span>&#123;</div><div class="line">                        apiWrapper.store(cutest)</div><div class="line">                                .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onResult(result);</div><div class="line">                                    &#125;</div><div class="line"> </div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onError(e);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然代码量多了，但是看起来更加清晰了。 嵌套的回调函数没那么多层级了，异步操作的名字也更容易理解了(<code>catsListAsyncJob</code>,<code>cutestCatAsyncJob</code>, <code>storedUriAsyncJob</code>)。<br>看起来还不错，但是还可以更好。</p>
<p>####简单的映射</p>
<p>先来看看我们创建 AsyncJob cutestCatAsyncJob 的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">AsyncJob&lt;Cat&gt; cutestCatAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Cat&gt; callback)</span> </span>&#123;</div><div class="line">                catsListAsyncJob.start(<span class="keyword">new</span> Callback&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(List&lt;Cat&gt; result)</span> </span>&#123;</div><div class="line">                        callback.onResult(findCutest(result));</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>这 16 行代码中，只有一行代码是我们的业务逻辑代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">findCutest(result)</div></pre></td></tr></table></figure></p>
<p>其他的代码只是为了启动<code>AsyncJob</code>并接收结果和处理异常的干扰代码。 但是这些代码是通用的，我们可以把他们放到其他地方来让我们更加专注业务逻辑代码。<br>那么如何实现呢？需要做两件事情：</p>
<ul>
<li>通过<code>AsyncJob</code>获取需要转换的结果</li>
<li>转换的函数</li>
</ul>
<p>但是由于<code>Java</code>的限制，无法把函数作为参数，所以需要用一个接口（或者类）并在里面定义一个转换函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Func</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line">    <span class="function">R <span class="title">call</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>灰常简单。 有两个泛型类型定义，<code>T</code>代表参数的类型；<code>R</code>代表返回值的类型。</p>
<p>当我们把<code>AsyncJob</code>的结果转换为其他类型的时候，我们需要把一个结果值映射为另外一种类型，这个操作我们称之为<code>map</code>。 把该函数定义到<code>AsyncJob</code>类中比较方便，这样就可以通过<code>this</code>来访问<code>AsyncJob</code>对象了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">map</span><span class="params">(Func&lt;T, R&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        R mapped = func.call(result);</div><div class="line">                        callback.onResult(mapped);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来不错， 现在的<code>CatsHelper</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = <span class="keyword">new</span> AsyncJob&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;Uri&gt; cutestCatCallback)</span> </span>&#123;</div><div class="line">                cutestCatAsyncJob.start(<span class="keyword">new</span> Callback&lt;Cat&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Cat cutest)</span> </span>&#123;</div><div class="line">                        apiWrapper.store(cutest)</div><div class="line">                                .start(<span class="keyword">new</span> Callback&lt;Uri&gt;() &#123;</div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Uri result)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onResult(result);</div><div class="line">                                    &#125;</div><div class="line"> </div><div class="line">                                    <span class="meta">@Override</span></div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                        cutestCatCallback.onError(e);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        cutestCatCallback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新创建的<code>AsyncJob cutestCatAsyncJob()</code>的代码只有6行，并且只有一层嵌套。</p>
<p>####高级映射</p>
<p>但是<code>AsyncJob storedUriAsyncJob()</code>看起来还是非常糟糕。 这里也能使用映射吗？ 下面就来试试吧！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.map(<span class="keyword">new</span> Func&lt;Cat, Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Uri <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">        <span class="comment">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ 将会导致无法编译</span></div><div class="line">        <span class="comment">//      Incompatible types:</span></div><div class="line">        <span class="comment">//      Required: Uri</span></div><div class="line">        <span class="comment">//      Found: AsyncJob&lt;Uri&gt;                </span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哎。。。 看起来没这么简单啊， 下面修复返回的类型再试一次：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt; storedUriAsyncJob = cutestCatAsyncJob.map(<span class="keyword">new</span> Func&lt;Cat, AsyncJob&lt;Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">        <span class="comment">//^^^^^^^^^^^^^^^^^^^^^^^ 将会导致无法编译</span></div><div class="line">        <span class="comment">//      Incompatible types:</span></div><div class="line">        <span class="comment">//      Required: AsyncJob&lt;Uri&gt;</span></div><div class="line">        <span class="comment">//      Found: AsyncJob&lt;AsyncJob&lt;Uri&gt;&gt;</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们只能拿到<code>AsyncJob&lt;AsyncJob&gt;</code> 。看来还需要更进一步。我们需要压缩一层<code>AsyncJob</code>，把两个异步操作当做一个单一的异步操作来对待。<br>现在我们需要一个参数为<code>AsyncJob</code>的<code>map</code>转换操作而不是<code>R</code>。该操作类似于<code>map</code>，但是该操作会把嵌套的<code>AsyncJob</code>压缩为<code>flatten</code>一层<code>AsyncJob</code>. 我们称之为<code>flatMap</code>，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncJob</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;T&gt; callback)</span></span>;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">map</span><span class="params">(Func&lt;T, R&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        R mapped = func.call(result);</div><div class="line">                        callback.onResult(mapped);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> &lt;R&gt; <span class="function">AsyncJob&lt;R&gt; <span class="title">flatMap</span><span class="params">(Func&lt;T, AsyncJob&lt;R&gt;&gt; func)</span></span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncJob&lt;T&gt; source = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncJob&lt;R&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Callback&lt;R&gt; callback)</span> </span>&#123;</div><div class="line">                source.start(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(T result)</span> </span>&#123;</div><div class="line">                        AsyncJob&lt;R&gt; mapped = func.call(result);</div><div class="line">                        mapped.start(<span class="keyword">new</span> Callback&lt;R&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(R result)</span> </span>&#123;</div><div class="line">                                callback.onResult(result);</div><div class="line">                            &#125;</div><div class="line"> </div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                                callback.onError(e);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        callback.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来有很多干扰代码，但是还好这些代码在客户端代码中并不会出现。 现在我们的<code>CatsHelper</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(<span class="keyword">new</span> Func&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"> </div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.flatMap(<span class="keyword">new</span> Func&lt;Cat, AsyncJob&lt;Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">call</span><span class="params">(Cat cat)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果把匿名类修改为<code>Java 8</code>的<code>lambdas</code>表达式（逻辑是一样的，只是让代码看起来更清晰点）就很容易发现了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> AsyncJob&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        AsyncJob&lt;List&lt;Cat&gt;&gt; catsListAsyncJob = apiWrapper.queryCats(query);</div><div class="line">        AsyncJob&lt;Cat&gt; cutestCatAsyncJob = catsListAsyncJob.map(cats -&gt; findCutest(cats));</div><div class="line">        AsyncJob&lt;Uri&gt; storedUriAsyncJob = cutestCatAsyncJob.flatMap(cat -&gt; apiWrapper.store(cat));</div><div class="line">        <span class="keyword">return</span> storedUriAsyncJob;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样看起来是不是就很清晰了。 这个代码和刚刚开头的阻塞式代码是不是非常相似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">saveTheCutestCat</span><span class="params">(String query)</span></span>&#123;</div><div class="line">        List&lt;Cat&gt; cats = api.queryCats(query);</div><div class="line">        Cat cutest = findCutest(cats);</div><div class="line">        Uri savedUri = api.store(cutest);</div><div class="line">        <span class="keyword">return</span> savedUri;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在他们不仅逻辑是一样的，语义上也是一样的。 太棒了！<br>同时我们还可以使用组合操作，现在把两个异步操作组合一起并返还另外一个异步操作。<br>异常处理也会传递到最终的回调接口中。<br>下面来看看<code>RxJava</code>吧。<br>你没必要把上面代码应用到您的项目中去， 这些简单的、线程不安全的代码只是 <code>RxJava</code>的一部分。<br>只有一些名字上的不同：</p>
<ul>
<li><code>AsyncJob</code>等同于<code>Observable</code>，不仅仅可以返回一个结果，还可以返回一系列的结果，当然也可能没有结果返回。</li>
<li><code>Callback</code>等同于<code>Observer</code>，除了<code>onNext(T t)</code>, <code>onError(Throwable t)</code>以外，还有一个<code>onCompleted()</code>函数，该函数在结束继续返回结果的时候通知<code>Observable</code>。</li>
<li><code>abstract void start(Callback callback)</code>和<code>Subscription subscribe(final Observer observer)</code>类似，返回一个<code>Subscription</code>，如果你不再需要后面的结果了，可以取消该任务。</li>
</ul>
<p>下面是<code>RxJava</code>版本的代码:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiWrapper</span> </span>&#123;</div><div class="line">    Api api;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> Observable&lt;List&lt;Cat&gt;&gt; queryCats(<span class="keyword">final</span> String query) &#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;List&lt;Cat&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> List&lt;Cat&gt;&gt; subscriber)</span> </span>&#123;</div><div class="line">                api.queryCats(query, <span class="keyword">new</span> Api.CatsQueryCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatListReceived</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                        subscriber.onNext(cats);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueryFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        subscriber.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Uri&gt; <span class="title">store</span><span class="params">(<span class="keyword">final</span> Cat cat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Uri&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Uri&gt; subscriber)</span> </span>&#123;</div><div class="line">                api.store(cat, <span class="keyword">new</span> Api.StoreCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCatStored</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">                        subscriber.onNext(uri);</div><div class="line">                    &#125;</div><div class="line"> </div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStoreFailed</span><span class="params">(Exception e)</span> </span>&#123;</div><div class="line">                        subscriber.onError(e);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsHelper</span> </span>&#123;</div><div class="line"> </div><div class="line">    ApiWrapper apiWrapper;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Uri&gt; <span class="title">saveTheCutestCat</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">        Observable&lt;List&lt;Cat&gt;&gt; catsListObservable = apiWrapper.queryCats(query);</div><div class="line">        Observable&lt;Cat&gt; cutestCatObservable = catsListObservable.map(<span class="keyword">new</span> Func1&lt;List&lt;Cat&gt;, Cat&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Cat <span class="title">call</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> CatsHelper.<span class="keyword">this</span>.findCutest(cats);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        Observable&lt;Uri&gt; storedUriObservable = cutestCatObservable.flatMap(<span class="keyword">new</span> Func1&lt;Cat, Observable&lt;? extends Uri&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> Observable&lt;? extends Uri&gt; call(Cat cat) &#123;</div><div class="line">                <span class="keyword">return</span> apiWrapper.store(cat);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> storedUriObservable;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> Cat <span class="title">findCutest</span><span class="params">(List&lt;Cat&gt; cats)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.max(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把 Observable 替换为 AsyncJob 后 他们的代码是一样的。</p>
<p>####结论</p>
<p>通过简单的转换操作，我们可以把异步操作抽象出来。这种抽象的结果可以像操作简单的阻塞函数一样来操作异步操作并组合异步操作。这样我们就可以摆脱层层嵌套的回调接口了，并且不用手工的去处理每次异步操作的异常。</p>
<p>上面这个例子非常好，建议多看几遍，加深理解，可能把这个例子放在这里并不太好，把它放到开始讲之前可能更容易理解，但是我觉得，介绍完概念、使用方法和基本的操作符后，我们可能并不能理解操作符的原理和作用。之前看完操作符原理后迷迷糊糊的状态再来看这个例子会豁然开朗。    </p>
<p>这里也感谢牛逼的作者<a href="https://github.com/yarikx">Yaroslav</a>(也是<code>RxAndroid</code>项目的一个重要参与者)能用这么牛逼的例子，讲解的如此透彻。   </p>
<p>如果嫌上面的代码麻烦，可以通过下面的例子看:   </p>
<p>假设有这样一个需求：界面上有一个自定义的视图<code>imageCollectorView</code>，它的作用是显示多张图片，并能使用<code>addImage(Bitmap)</code> 方法来任意增加显示的图片。现在需要程序将一个给出的目录数组<code>File[] folders</code>中每个目录下的<code>png</code>图片都加载出来并显示在<code>imageCollectorView</code>中。需要注意的是，由于读取图片的这一过程较为耗时，需要放在后台执行，而图片的显示则必须在<code>UI</code>线程执行。常用的实现方式有多种，我这里贴出其中一种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Thread() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.run();</div><div class="line">        <span class="keyword">for</span> (File folder : folders) &#123;</div><div class="line">            File[] files = folder.listFiles();</div><div class="line">            <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">                <span class="keyword">if</span> (file.getName().endsWith(<span class="string">".png"</span>)) &#123;</div><div class="line">                    <span class="keyword">final</span> Bitmap bitmap = getBitmapFromFile(file);</div><div class="line">                    getActivity().runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            imageCollectorView.addImage(bitmap);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;.start();</div></pre></td></tr></table></figure>
<p>而如果使用 RxJava ，实现方式是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">Observable.from(folders)</div><div class="line">    .flatMap(<span class="keyword">new</span> Func1&lt;File, Observable&lt;File&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;File&gt; <span class="title">call</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Observable.from(file.listFiles());</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .filter(<span class="keyword">new</span> Func1&lt;File, Boolean&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> file.getName().endsWith(<span class="string">".png"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .map(<span class="keyword">new</span> Func1&lt;File, Bitmap&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Bitmap <span class="title">call</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getBitmapFromFile(file);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribeOn(Schedulers.io())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Action1&lt;Bitmap&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">            imageCollectorView.addImage(bitmap);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>那位说话了：『你这代码明明变多了啊！简洁个毛啊！』大兄弟你消消气，我说的是逻辑的简洁，不是单纯的代码量少（逻辑简洁才是提升读写代码速度的必杀技对不？）。观察一下你会发现， <code>RxJava</code>的这个实现，是一条从上到下的链式调用，没有任何嵌套，这在逻辑的简洁性上是具有优势的。当需求变得复杂时，这种优势将更加明显（试想如果还要求只选取前<code>10</code>张图片，常规方式要怎么办？如果有更多这样那样的要求呢？再试想，在这一大堆需求实现完两个月之后需要改功能，当你翻回这里看到自己当初写下的那一片迷之缩进，你能保证自己将迅速看懂，而不是对着代码重新捋一遍思路？）。</p>
<p>更多内容请看下一篇文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/RxJava%E8%AF%A6%E8%A7%A3(%E4%B8%8B">RxJava详解(下)</a>.md)</p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(中)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RecyclerView专题" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RecyclerView专题/">RecyclerView专题</a>
    </h1>
  

        
        <a href="/2015/01/01/RecyclerView专题/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RecyclerView专题"><a href="#RecyclerView专题" class="headerlink" title="RecyclerView专题"></a>RecyclerView专题</h1><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>RecyclerView</code>是<code>Android 5.0</code>提供的新控件，已经用了很长时间了，但是一直没有时间去仔细的梳理一下。现在项目不太紧，决定来整理下。</p>
<p>官方文档中是这样介绍的:<br><code>A flexible view for providing a limited window into a large data set.</code></p>
<p>RecyclerView比listview更先进更灵活，对于很多的视图它就是一个容器，可以有效的重用和滚动。当数据动态变化的时候请使用它。</p>
<p>#####专业术语:</p>
<ul>
<li><code>Adapter</code>: <code>A subclass of RecyclerView.Adapter responsible for providing views that represent items in a data set.</code></li>
<li><code>Position</code>: <code>The position of a data item within an Adapter.</code></li>
<li><code>Index</code>: <code>The index of an attached child view as used in a call to getChildAt(int). Contrast with Position.</code></li>
<li><code>Binding</code>: <code>The process of preparing a child view to display data corresponding to a position within the adapter.</code></li>
<li><code>Recycle (view)</code>: <code>A view previously used to display data for a specific adapter position may be placed in a cache for later reuse to display the same type of data again later. This can drastically improve performance by skipping initial layout inflation or construction.</code></li>
<li><code>Scrap (view)</code>: <code>A child view that has entered into a temporarily detached state during layout. Scrap views may be reused without becoming fully detached from the parent RecyclerView, either unmodified if no rebinding is required or modified by the adapter if the view was considered dirty.</code></li>
<li><code>Dirty (view)</code>: <code>A child view that must be rebound by the adapter before being displayed.</code></li>
</ul>
<p>#####<code>RecyclerView</code>中的位置:      </p>
<p><code>RecyclerView</code>在<code>RecyclerView.Adapter</code>和<code>RecyclerView.LayoutManager</code>中引进了一个抽象的额外中间层来保证在布局计算的过程中能批量的监听到数据变化。这样介绍了<code>LayoutManager</code>追踪<code>adapter</code>数据变化来计算动画的时间。因为所有的<code>View</code>绑定都是在同一时间执行，所以这样也提高了性能和避免了一些非必要的绑定。<br>因为这个原因，在<code>RecylcerView</code>中有两种<code>position</code>类型相关的方法:     </p>
<ul>
<li><code>layout position</code>:  在最近一次<code>layout</code>计算是<code>item</code>的位置。这是<code>LayoutManager</code>角度中的位置。   </li>
<li><code>adapter position</code>: <code>item</code>在<code>adapter</code>中的位置。这是从<code>Adapter</code>的角度中的位置。</li>
</ul>
<p>这两种<code>position</code>除了在分发<code>adapter.notify*</code>事件与之后计算布局更新的这段时间之内外都是相同的。<br>可以通过<code>getLayoutPosition(),findViewHolderForLayoutPosition(int)</code>方法来获取最近一次布局计算的<code>LayoutPosition</code>。这些<code>positions</code>包括从最近一次布局计算的所有改变。你可以根据这些位置来方便的得到用户当前从屏幕上所看到的。例如，如果在屏幕上有一个列表，用户请求的是第五个条目，你可以通过该方法来匹配当前用户正在看的内容。</p>
<p>另一种<code>AdapterPosition</code>相关的方法是<code>getAdapterPosition(),findViewHolderForAdapterPosition(int)</code>，当及时一些数据可能没有来得及被展现到布局上时便需要获取最新的<code>adapter</code>位置可以使用这些相关的方法。例如，如果你想获取一个条目的<code>ViewHOlder</code>的<code>click</code>事件时，你应该使用<code>getAdapterPosition()</code>。需要知道这些方法在<code>notifyDataSetChange()</code>方法被调用和新布局还没有被计算之前是不能使用的。鉴于这个原因，你应该小心的去处理这些方法有可能返回<code>NO_POSITION</code>或者<code>null</code>的情况。</p>
<p>###结构</p>
<ul>
<li><code>RecyclerView.Adapter</code>: 创建View并将数据集合绑定到View上</li>
<li><code>ViewHolder</code>: 持有所有的用于绑定数据或者需要操作的View</li>
<li><code>LayoutManager</code>: 布局管理器，负责摆放视图等相关操作</li>
<li><code>ItemDecoration</code>: 负责绘制<code>Item</code>附近的分割线，通过<code>RecyclerView.addItemDecoration()</code>使用</li>
<li><code>ItemAnimator</code>: 为<code>Item</code>的操作添加动画效果，如，增删条目等，通过<code>RecyclerView.setItemAnimator(new DefaultItemAnimator());</code>使用</li>
</ul>
<p>下图能更直观的了解:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/RecyclerView.png?raw=true" alt="image"></p>
<p>#####<code>RecyclerView</code>提供这些内置布局管理器:    </p>
<ul>
<li><code>LinearLayoutManager</code>: 以垂直或水平滚动列表方式显示项目。</li>
<li><code>GridLayoutManager</code>: 在网格中显示项目。</li>
<li><code>StaggeredGridLayoutManager</code>: 在分散对齐网格中显示项目。</li>
</ul>
<p>#####<code>RecyclerView.ItemDecoration</code>是一个抽象类，可以通过重写以下三个方法，来实现Item之间的偏移量或者装饰效果:     </p>
<ul>
<li><code>public void onDraw(Canvas c, RecyclerView parent)</code> 装饰的绘制在Item条目绘制之前调用，所以这有可能被Item的内容所遮挡</li>
<li><code>public void onDrawOver(Canvas c, RecyclerView parent)</code> 装饰的绘制在Item条目绘制之后调用，因此装饰将浮于Item之上</li>
<li><code>public void getItemOffsets(Rect outRect, int itemPosition, RecyclerView parent)</code> 与padding或margin类似，LayoutManager在测量阶段会调用该方法，计算出每一个Item的正确尺寸并设置偏移量。</li>
</ul>
<p>#####<code>ItemAnimator</code>触发于以下三种事件:    </p>
<ul>
<li>某条数据被插入到数据集合中</li>
<li>从数据集合中移除某条数据</li>
<li>更改数据集合中的某条数据</li>
</ul>
<p>在之前的版本中，当时据集合发生改变时通过调用<code>notifyDataSetChanged()</code>，来刷新列表，因为这样做会触发列表的重绘，所以并不会出现任何动画效果，因此需要调用一些以<code>notifyItem*()</code>作为前缀的特殊方法，比如:    </p>
<ul>
<li><code>public final void notifyItemInserted(int position)</code> 向指定位置插入<code>Item</code></li>
<li><code>public final void notifyItemRemoved(int position)</code> 移除指定位置<code>Item</code></li>
<li><code>public final void notifyItemChanged(int position)</code> 更新指定位置<code>Item</code></li>
</ul>
<p>###使用介绍:     </p>
<ul>
<li><p>添加依赖库           </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:recyclerview-v7:23.4.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>示例代码        </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line">    <span class="keyword">private</span> RecyclerView.Adapter mAdapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String [] mDatas = &#123;<span class="string">"Android"</span>,<span class="string">"ios"</span>,<span class="string">"jack"</span>,<span class="string">"tony"</span>,<span class="string">"window"</span>,<span class="string">"mac"</span>,<span class="string">"1234"</span>,<span class="string">"hehe"</span>,<span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findView();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">        <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use a linear layout manager</span></div><div class="line">        mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">        mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">        mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyHolder</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> String[] mData;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> MyHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="comment">// create a new view</span></div><div class="line">            View v = LayoutInflater.from(parent.getContext()).inflate(</div><div class="line">                    R.layout.item, parent, <span class="keyword">false</span>);</div><div class="line">            MyHolder holder = <span class="keyword">new</span> MyHolder(v);</div><div class="line">            <span class="keyword">return</span> holder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(MyHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            holder.mTitleTv.setText(mData[position]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mData == <span class="keyword">null</span> ? <span class="number">0</span> : mData.length;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> TextView mTitleTv;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            mTitleTv = (TextView) itemView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>`activity_main的内容如下: `     
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/rv"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div></pre></td></tr></table></figure>


`item的内容如下：`     
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:padding</span>=<span class="string">"20dp"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">    <span class="attr">android:textSize</span>=<span class="string">"30dp"</span>&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></div></pre></td></tr></table></figure>
</code></pre><p>###点击事件</p>
<p>之前在使用<code>ListView</code>的时候，设置点击事件是非常方便的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mListView.setOnItemClickListener();</div><div class="line">mListView.setOnItemLongClickListener();</div></pre></td></tr></table></figure></p>
<p>但是<code>RecylcerView</code>确没有提供类似的方法。那我们只能是自己去处理。处理的方式也有两种:       </p>
<ul>
<li><p>通过<code>itemView.onClickListener()</code>以及<code>onLongClickListener()</code>     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line">    <span class="keyword">private</span> MyAdapter mAdapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String[] mDatas = &#123;<span class="string">"Android"</span>, <span class="string">"ios"</span>, <span class="string">"jack"</span>, <span class="string">"tony"</span>, <span class="string">"window"</span>, <span class="string">"mac"</span>, <span class="string">"1234"</span>, <span class="string">"hehe"</span>, <span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findView();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">        <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use a linear layout manager</span></div><div class="line">        mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">        mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">        mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">        mAdapter.setOnItemClickListener(<span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mAdapter.setOnItemLongClickListener(<span class="keyword">new</span> OnItemLongClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"long click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyHolder</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> String[] mData;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> MyHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="comment">// create a new view</span></div><div class="line">            View v = LayoutInflater.from(parent.getContext()).inflate(</div><div class="line">                    R.layout.item, parent, <span class="keyword">false</span>);</div><div class="line">            MyHolder holder = <span class="keyword">new</span> MyHolder(v);</div><div class="line">            <span class="keyword">return</span> holder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(<span class="keyword">final</span> MyHolder holder, <span class="keyword">final</span> <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            holder.mTitleTv.setText(mData[position]);</div><div class="line">            <span class="keyword">if</span> (mOnItemClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        mOnItemClickListener.onItemClick(holder.itemView, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mOnItemLongClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                holder.itemView.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        mOnItemLongClickListener.onItemLongClick(holder.itemView, position);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mData == <span class="keyword">null</span> ? <span class="number">0</span> : mData.length;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> OnItemClickListener mOnItemClickListener;</div><div class="line">        <span class="keyword">private</span> OnItemLongClickListener mOnItemLongClickListener;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener mOnItemClickListener)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.mOnItemClickListener = mOnItemClickListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemLongClickListener</span><span class="params">(OnItemLongClickListener mOnItemLongClickListener)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.mOnItemLongClickListener = mOnItemLongClickListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> TextView mTitleTv;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            mTitleTv = (TextView) itemView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemLongClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>使用<code>RecyclerView.OnItemTouchListener</code>           </p>
<p>  虽然没有提供现成的监听器，但是提供了一个内部接口<code>OnItemTouchListener</code>。<br>  先来看看它的介绍:    </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * An OnItemTouchListener allows the application to intercept touch events in progress at the</div><div class="line"> * view hierarchy level of the RecyclerView before those touch events are considered for</div><div class="line"> * RecyclerView&apos;s own scrolling behavior.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This can be useful for applications that wish to implement various forms of gestural</div><div class="line"> * manipulation of item views within the RecyclerView. OnItemTouchListeners may intercept</div><div class="line"> * a touch interaction already in progress even if the RecyclerView is already handling that</div><div class="line"> * gesture stream itself for the purposes of scrolling.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @see SimpleOnItemTouchListener</div><div class="line"> */</div><div class="line">public static interface OnItemTouchListener &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  说的和明白了，而且还让你看<code>SimpleOnItemTouchListener</code>，猜也能猜出来是一个默认的实现类。<br>  好了直接上代码:      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line"><span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line"><span class="keyword">private</span> MyAdapter mAdapter;</div><div class="line"></div><div class="line"><span class="keyword">private</span> String[] mDatas = &#123;<span class="string">"Android"</span>, <span class="string">"ios"</span>, <span class="string">"jack"</span>, <span class="string">"tony"</span>, <span class="string">"window"</span>, <span class="string">"mac"</span>, <span class="string">"1234"</span>, <span class="string">"hehe"</span>, <span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line">    findView();</div><div class="line">    initView();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">    mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">    <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">    mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// use a linear layout manager</span></div><div class="line">    mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">    mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">    mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">    mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">    mRecyclerView.setAdapter(mAdapter);</div><div class="line">    mRecyclerView.addOnItemTouchListener(<span class="keyword">new</span> RecyclerViewClickListener(<span class="keyword">this</span>, mRecyclerView, <span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Long Click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecyclerViewClickListener</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">SimpleOnItemTouchListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> GestureDetector mGestureDetector;</div><div class="line">    <span class="keyword">private</span> OnItemClickListener mListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecyclerViewClickListener</span><span class="params">(Context context, <span class="keyword">final</span> RecyclerView recyclerView, OnItemClickListener listener)</span> </span>&#123;</div><div class="line">        mListener = listener;</div><div class="line">        mGestureDetector = <span class="keyword">new</span> GestureDetector(context,</div><div class="line">                <span class="keyword">new</span> GestureDetector.SimpleOnGestureListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSingleTapUp</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">                        View childView = recyclerView.findChildViewUnder(e.getX(), e.getY());</div><div class="line">                        <span class="keyword">if</span> (childView != <span class="keyword">null</span> &amp;&amp; mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                            mListener.onItemClick(childView, recyclerView.getChildLayoutPosition(childView));</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLongPress</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">                        View childView = recyclerView.findChildViewUnder(e.getX(), e.getY());</div><div class="line">                        <span class="keyword">if</span> (childView != <span class="keyword">null</span> &amp;&amp; mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                            mListener.onItemLongClick(childView, recyclerView.getChildLayoutPosition(childView));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mGestureDetector.onTouchEvent(e)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(rv, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onTouchEvent(rv, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestDisallowInterceptTouchEvent</span><span class="params">(<span class="keyword">boolean</span> disallowIntercept)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestDisallowInterceptTouchEvent(disallowIntercept);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  上面的实现稍微有些缺陷，就是如果我手指按住某个条目一直不抬起，他也会执行<code>Long click</code>事件，这显然是不合理的，至于怎么解决，就是可以不用<code>GestureDetector</code>，自己在<code>DOWN</code>和<code>UP</code>事件中去判断处理。</p>
</li>
</ul>
<h3 id="Headerview-FooterView"><a href="#Headerview-FooterView" class="headerlink" title="Headerview FooterView"></a>Headerview FooterView</h3><p>之前在<code>ListView</code>中提供了<code>addHeaderView()</code>和<code>addFooterView()</code>等方法，但是在<code>RecyclerView</code>中并没有提供类似的方法，那我们该如何添加呢？ 也很简单，就是通过<code>Adapter</code>中去添加，利用不同的<code>itemViewType</code>，然后根据不同的类型去在<code>onCreateViewHOlder</code>中创建不同的视图，通过这种方式来达到<code>headerview</code>和<code>FooterView</code>的效果。</p>
<p>上一段简单的示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecyclerView</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_HEADER = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_ITEM = <span class="number">1</span>;</div><div class="line">    String[] data;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeaderAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (viewType == TYPE_ITEM) &#123;</div><div class="line">            <span class="comment">//inflate your layout and pass it to view holder</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> VHItem(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (viewType == TYPE_HEADER) &#123;</div><div class="line">            <span class="comment">//inflate your layout and pass it to view holder</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> VHHeader(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"there is no type that matches the type "</span> + viewType + <span class="string">" + make sure your using types correctly"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (holder <span class="keyword">instanceof</span> VHItem) &#123;</div><div class="line">            String dataItem = getItem(position);</div><div class="line">            <span class="comment">//cast holder to VHItem and set data</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (holder <span class="keyword">instanceof</span> VHHeader) &#123;</div><div class="line">            <span class="comment">//cast holder to VHHeader and set data for header.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> data.length + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isPositionHeader(position))</div><div class="line">            <span class="keyword">return</span> TYPE_HEADER;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> TYPE_ITEM;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPositionHeader</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> position == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> data[position - <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">VHItem</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        TextView title;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VHItem</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">VHHeader</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        Button button;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VHHeader</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的代码对<code>LinearLayoutManger</code>是没问题的，但是使用<code>GridLayoutManager</code>呢？ 如果是两列，那添加的<code>HeaderView</code>并不是占据上第一行，而是<code>HeaderView</code>与第二个<code>ItemView</code>一起占据第一行。那该怎么处理呢？<br>那就是使用<code>setSpanSizeLookup()</code>方法。<br>比如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">recyclerView.setLayoutManager(<span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>, <span class="number">2</span>));</div></pre></td></tr></table></figure></p>
<p>在上面的基本设置中，我们的<code>spanCount</code>为2，每个<code>item</code>的<code>span size</code>为1，因此一个<code>header</code>需要的<code>span size</code>则为2。在我尝试着添加<code>header</code>之前，我想先看看如何设置<code>span size</code>。其实很简单。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> GridLayoutManager manager = <span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>, <span class="number">2</span>);</div><div class="line">recyclerView.setLayoutManager(manager);</div><div class="line">manager.setSpanSizeLookup(<span class="keyword">new</span> GridLayoutManager.SpanSizeLookup() &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSpanSize</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> adapter.isHeader(position) ? manager.getSpanCount() : <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="下拉刷新、自动加载"><a href="#下拉刷新、自动加载" class="headerlink" title="下拉刷新、自动加载"></a>下拉刷新、自动加载</h3><p>#####实现下拉刷新<br>实现下拉刷新也很简单了，可以使用<code>SwipeRefrshLayout</code>,<code>SwipeRefrshLayout</code>是<code>Google</code>官方提供的组件，可以实现下拉刷新的功能。已包含到<code>support.v4</code>包中。</p>
<p>主要方法有:      </p>
<ul>
<li><code>setOnRefreshListener(OnRefreshListener)</code>:添加下拉刷新监听器</li>
<li><code>setRefreshing(boolean)</code>:显示或者隐藏刷新进度条</li>
<li><code>isRefreshing()</code>:检查是否处于刷新状态</li>
<li><code>setColorSchemeResources()</code>:设置进度条的颜色主题，最多设置四种。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.SwipeRefreshLayout</span></span></div><div class="line">   <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">   <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:scrollbars</span>=<span class="string">"vertical"</span></div><div class="line">    &gt;</div><div class="line">   <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">       <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">       <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">       &gt;<span class="tag">&lt;/<span class="name">android.support.v7.widget.RecyclerView</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>具体实现就不写了。</p>
<p>#####实现滑动自动加载更多功能</p>
<p>实现方式和<code>ListView</code>的实现方式类似，就是通过监听<code>scroll</code>时间，然后判断当前显示的<code>item</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//RecyclerView滑动监听</span></div><div class="line">mRecylcerView.setOnScrollListener(<span class="keyword">new</span> RecyclerView.OnScrollListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrollStateChanged</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> newState)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState);</div><div class="line">        <span class="keyword">if</span> (newState ==RecyclerView.SCROLL_STATE_IDLE &amp;&amp; lastVisibleItem + <span class="number">1</span> ==adapter.getItemCount()) &#123;</div><div class="line">            <span class="keyword">new</span> Handler().postDelayed(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    List&lt;String&gt; newDatas = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">                        <span class="keyword">int</span> index = i +<span class="number">1</span>;</div><div class="line">                       newDatas.add(<span class="string">"more item"</span> + index);</div><div class="line">                    &#125;</div><div class="line">                   adapter.addMoreItem(newDatas);</div><div class="line">                &#125;</div><div class="line">            &#125;,<span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onScrolled(recyclerView,dx, dy);</div><div class="line">        lastVisibleItem =linearLayoutManager.findLastVisibleItemPosition();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>然后再通过结合<code>FooterView</code>以及增加几种状态就可以实现自动加载更多了。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RecyclerView专题/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio提高Build速度" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio提高Build速度/">AndroidStudio提高Build速度</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio提高Build速度/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio提高Build速度"><a href="#AndroidStudio提高Build速度" class="headerlink" title="AndroidStudio提高Build速度"></a>AndroidStudio提高Build速度</h1><p><code>Android Studio</code>自动发布以来，凭借其强大的功能，很快让开发者都投入到它的阵营下。但是也问题，就是<code>Build</code>速度太慢了。</p>
<p>之前也根据网上的资料，修改了一些配置，但是一次二分多种有时候还是让人抓狂。今天索性记录一下。首先看一下<a href="https://plus.google.com/+AndroidDevelopers/posts/ECrb9VQW9XP" target="_blank" rel="external">Google+</a>关于该问题的讨论。</p>
<ul>
<li><p>使用<code>daemon</code>及<code>parallel</code>模式</p>
<p>  在下面的目录中创建一个名为<code>gradle.properties</code>的文件:     </p>
<ul>
<li><code>/home/&lt;username&gt;/.gradle/ (Linux)</code></li>
<li><code>/Users/&lt;username&gt;/.gradle/ (Mac)</code></li>
<li><p><code>C:\Users\&lt;username&gt;\.gradle (Windows)</code></p>
<p>文件的内容为: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.gradle.daemon=true</div><div class="line">org.gradle.parallel=true</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>经过上面的这一步修改是对所有工程都有效果的，如果你只想对某一个工程配置的话，那就在该工程目录下的`gralde.properties`中进行配置。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line"># Default value: -Xmx10248m -XX:MaxPermSize=256m</div><div class="line"># org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div></pre></td></tr></table></figure>

打开时默认如上。我们给加添加上面的配置就好。

当然你也可以通过`Studio`的设置中进行修改。        
![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_speed.png?raw=true)
</code></pre><ul>
<li><p>使用<code>offline</code>模式      </p>
<p>  下一步就是开始<code>offline</code>模式，因为我们经常会在<code>gradle</code>中使用一下依赖库时用<code>+</code>这样的话就能保证你的依赖库是最新的版本，但是这样在每次<code>build</code>的时候都会去检查是不是最新的版本，所以就会耗时。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_offline.png?raw=true" alt="image"></p>
<p>  在开发过程中是不建议使用动态版本的，在<code>Studio</code>中使用动态版本的<code>gradle</code>中间中使用<code>ALT+ENTER</code>键进行修复。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_daymaic_version_tip.png?raw=true" alt="image"><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_dymaic_version_fix.png?raw=true" alt="image"><br>  详细有关为什么不要使用动态版本的介绍，请参考<a href="http://blog.danlew.net/2015/09/09/dont-use-dynamic-versions-for-your-dependencies/" target="_blank" rel="external">Don’t use dynamic versions for your dependencies</a></p>
</li>
<li><p>增加内存使用<code>SSD</code><br>  首先是增大内存,    <code>Mac</code>中在<code>Applications</code>中找到<code>Sutio</code>然后右键显示包内容<code>Contents/bin/studio.vmoptions</code>。<br>  打开该文件后修改就可以了，我是的是:     </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># *DO NOT* modify this file directly. If there is a value that you would like to override,</div><div class="line"># please add it to your user specific configuration file.</div><div class="line">#</div><div class="line"># See http://tools.android.com/tech-docs/configuration</div><div class="line">#</div><div class="line">-Xms1024m</div><div class="line">-Xmx4096m</div><div class="line">-XX:MaxPermSize=768m</div><div class="line">-XX:ReservedCodeCacheSize=768m</div><div class="line">-XX:+UseCompressedOops</div></pre></td></tr></table></figure>
<p>  我没看见<code>DO NOT</code>的提示- -!</p>
<ul>
<li>Xms 是JVN启动起始时的堆内存，堆内存是分配给对象的内容。</li>
<li>Xmx 是能使用的最大堆内存。</li>
</ul>
</li>
</ul>
<ul>
<li><p>使用<code>Instant Run</code>   </p>
<p>  <code>Instantt Run</code>放在这里说可能不合适，但是用他确实能大大的减少运行时间。<br>  如果还不了解的话可以参考<a href="http://tools.android.com/tech-docs/instant-run" target="_blank" rel="external">Instant Run</a><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_instantrun.png?raw=true" alt="image"></p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio提高Build速度/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android卸载反馈" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android卸载反馈/">Android卸载反馈</a>
    </h1>
  

        
        <a href="/2015/01/01/Android卸载反馈/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android卸载反馈"><a href="#Android卸载反馈" class="headerlink" title="Android卸载反馈"></a>Android卸载反馈</h1><p>最初记得是在360安全卫士中出现的，在手机上卸载他的应用之后浏览器就会弹出一个反馈页面，让用户进行反馈，感觉这种功能对于产品改进特别有帮助。<br>但是仔细一想该怎么去实现却犯愁了，最开始想这也简单啊，不就是监听下自身被卸载就可以了，应该系统会有卸载的广播，可惜没有。甚至其他的一些<br>方法也是不行的，因为你程序都被卸载了，你的代码怎么会执行呢？皮之不存，毛将焉附。那360是怎样实现的呢？说句真心话360做的产品还是非常有创新<br>的，虽然有些时候他会损坏用户的利益，不过但从技术方面，着实让人信服。</p>
<p>既然<code>Java</code>实现不了，那就得考虑下其他的了，自然最先想到的就是<code>JNI</code>了，可惜<code>C</code>的部分不懂，上网搜了很多资料和介绍，找得到可以通过一下方式实现:   </p>
<ul>
<li><p>通过<code>c</code>中的<code>fork</code>方法来复制一个子进程。复制出来的子进程在父进程被销毁后，仍然可以存在。<br>  <code>pid_t fpid = fork()</code>被调用前，就一个进程执行该段代码，这条语句执行之后，就会有两个进程执行该代码，两个进程执行没有固定先后顺序，只要看<br>  系统调度策略，<code>fork()</code>函数的特别之处在于调用一次会返回两次结果：   </p>
<pre><code>- 返回值大于0，当前是父进程。
- 返回0，当前是子进程。
- 返回小于0的负值。(出错了，可能是内存不足或者是进程数已经达到系统最大值)
</code></pre></li>
<li><p><code>fork</code>出子进程后让子进程一直去监听<code>/data/data/packageName</code>是否存在，如果不存在了，那就说明程序被卸载了，但是这样一直去轮训判断肯定会浪费<br>  系统资源的，当然也会更加费电，对用户来讲肯定是有损害的。所以这种技术最好也不好用，不然大家的手机以后还能了得。万恶的产品。</p>
</li>
<li><p>得到程序被卸载之后弹出浏览器打开指定反馈页面。这就要用到<code>am</code>命令了，最早知道这个命令是在开发<code>TV</code>版的时候，遥控器找不到了，程序安装后无法<br> 打开了，用该命令就不怕了，哈哈。但是在<code>c</code>中怎么执行<code>am</code>命令呢？这就要用到<code>execlp()</code>函数，该函数就是<code>c</code>中执行系统命令的函数。</p>
</li>
</ul>
<p>好了，主要的内容上面都分析完了，下面上代码。</p>
<ul>
<li><p><code>Java</code>层定义<code>natvie</code>方法。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"@@@"</span>;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.activity_main);</div><div class="line">		String packageDir = <span class="string">"/data/data/"</span> + getPackageName();</div><div class="line">		initUninstallFeedback(packageDir, Build.VERSION.SDK_INT);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initUninstallFeedback</span><span class="params">(String packagePath, <span class="keyword">int</span> sdkVersion)</span></span>;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		System.loadLibrary(<span class="string">"uninstall_feedback"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建jni目录，增加<code>Android.mk</code>以及<code>uninstall_feedback.c</code>文件。<br><code>Android.mk</code>的内容:</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line"></div><div class="line">include $(CLEAR_VARS)</div><div class="line"></div><div class="line">LOCAL_MODULE    := uninstall_feedback</div><div class="line">LOCAL_SRC_FILES := uninstall_feedback.c</div><div class="line"></div><div class="line">LOCAL_C_INCLUDES := $(LOCAL_PATH)/include</div><div class="line">LOCAL_LDLIBS += -L$(SYSROOT)/usr/lib -llog</div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<p><code>uninstall_feedback.c</code>的实现: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 将Java中的String转换成c中的char字符串</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">Jstring2CStr</span><span class="params">(JNIEnv* env, jstring jstr)</span> </span>&#123;</div><div class="line">	<span class="keyword">char</span>* rtn = <span class="literal">NULL</span>;</div><div class="line">	jclass clsstring = (*env)-&gt;FindClass(env, <span class="string">"java/lang/String"</span>); <span class="comment">//String</span></div><div class="line">	jstring strencode = (*env)-&gt;NewStringUTF(env, <span class="string">"GB2312"</span>); <span class="comment">// 得到一个java字符串 "GB2312"</span></div><div class="line">	jmethodID mid = (*env)-&gt;GetMethodID(env, clsstring, <span class="string">"getBytes"</span>,</div><div class="line">			<span class="string">"(Ljava/lang/String;)[B"</span>); <span class="comment">//[ String.getBytes("gb2312");</span></div><div class="line">	jbyteArray barr = (jbyteArray)(*env)-&gt;CallObjectMethod(env, jstr, mid,</div><div class="line">			strencode); <span class="comment">// String .getByte("GB2312");</span></div><div class="line">	jsize alen = (*env)-&gt;GetArrayLength(env, barr); <span class="comment">// byte数组的长度</span></div><div class="line">	jbyte* ba = (*env)-&gt;GetByteArrayElements(env, barr, JNI_FALSE);</div><div class="line">	<span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</div><div class="line">		rtn = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(alen + <span class="number">1</span>); <span class="comment">//""</span></div><div class="line">		<span class="built_in">memcpy</span>(rtn, ba, alen);</div><div class="line">		rtn[alen] = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	(*env)-&gt;ReleaseByteArrayElements(env, barr, ba, <span class="number">0</span>); <span class="comment">//</span></div><div class="line">	<span class="keyword">return</span> rtn;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_charon_uninstallfeedback_MainActivity_initUninstallFeedback</span><span class="params">(</span></span></div><div class="line">		JNIEnv* env, jobject thiz, jstring packageDir, jint sdkVersion) &#123;</div><div class="line"></div><div class="line">	<span class="keyword">char</span> * pd = Jstring2CStr(env, packageDir);</div><div class="line"></div><div class="line">	<span class="comment">//fork子进程，以执行轮询任务</span></div><div class="line">	<span class="keyword">pid_t</span> pid = fork();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// fork失败了</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// 可以一直采用一直判断文件是否存在的方式去判断，但是这样效率稍低，下面使用监听的方式，死循环，每个一秒判断一次，这样太浪费资源了。</span></div><div class="line">		<span class="keyword">int</span> check = <span class="number">1</span>;</div><div class="line">		<span class="keyword">while</span> (check) &#123;</div><div class="line">			FILE* file = fopen(pd, <span class="string">"rt"</span>);</div><div class="line">			<span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (sdkVersion &gt;= <span class="number">17</span>) &#123;</div><div class="line">					<span class="comment">// Android4.2系统之后支持多用户操作，所以得指定用户</span></div><div class="line">					execlp(<span class="string">"am"</span>, <span class="string">"am"</span>, <span class="string">"start"</span>, <span class="string">"--user"</span>, <span class="string">"0"</span>, <span class="string">"-a"</span>,</div><div class="line">							<span class="string">"android.intent.action.VIEW"</span>, <span class="string">"-d"</span>,</div><div class="line">							<span class="string">"http://shouji.360.cn/web/uninstall/uninstall.html"</span>,</div><div class="line">							(<span class="keyword">char</span>*) <span class="literal">NULL</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Android4.2以前的版本无需指定用户</span></div><div class="line">					execlp(<span class="string">"am"</span>, <span class="string">"am"</span>, <span class="string">"start"</span>, <span class="string">"-a"</span>,</div><div class="line">						<span class="string">"android.intent.action.VIEW"</span>, <span class="string">"-d"</span>,</div><div class="line">							<span class="string">"http://shouji.360.cn/web/uninstall/uninstall.html"</span>,</div><div class="line">							(<span class="keyword">char</span>*) <span class="literal">NULL</span>);</div><div class="line">				&#125;</div><div class="line">				check = <span class="number">0</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			&#125;</div><div class="line">			sleep(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编译so文件。<code>Windows</code>下要用<code>cygwin</code>来操作。<br>上面的介绍是在<code>Eclipse</code>中进行的，用<code>ndk-build</code>命令来编译<code>so</code>。具体请看之前写的<code>JNI基础</code>这篇文章。</li>
</ul>
<p>有关如何在<code>Android Stuido</code>中进行<code>ndk</code>开发请看另一篇文章。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android卸载反馈/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Activity启动过程" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Activity启动过程/">Activity启动过程</a>
    </h1>
  

        
        <a href="/2015/01/01/Activity启动过程/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Activity启动过程"><a href="#Activity启动过程" class="headerlink" title="Activity启动过程"></a>Activity启动过程</h1><p>前两天面试了天猫的开发，被问到了<code>Activity</code>启动过程，不懂啊….<br>今天就来分析一下，我们开启<code>Activity</code>主要有两种方式:    </p>
<ul>
<li>通过桌面图标启动，桌面就是<code>Launcher</code>其实他也是一个应用程序，他也是继承<code>Activity</code>。</li>
<li>在程序内部调用<code>startActivity()</code>开启。</li>
</ul>
<p>而<code>Launcher</code>点击图标其实也是调用了<code>Activity</code>的<code>startActivity()</code>方法，所以我们就从<code>startActivity()</code>方法入手了。<br>首先看一下<code>Activity</code>类中的<code>startActivity()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>startActivity(intent, null)</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Launch a new activity.  You will not receive any information about when</div><div class="line"> * the activity exits.  This implementation overrides the base version,</div><div class="line"> * providing information about</div><div class="line"> * the activity performing the launch.  Because of this additional</div><div class="line"> * information, the &#123;<span class="doctag">@link</span> Intent#FLAG_ACTIVITY_NEW_TASK&#125; launch flag is not</div><div class="line"> * required; if not specified, the new activity will be added to the</div><div class="line"> * task of the caller.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> intent The intent to start.</div><div class="line"> * <span class="doctag">@param</span> options Additional options for how the Activity should be started.</div><div class="line"> * See &#123;<span class="doctag">@link</span> android.content.Context#startActivity(Intent, Bundle)</div><div class="line"> * Context.startActivity(Intent, Bundle)&#125; for more details.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> &#123;<span class="doctag">@link</span> #startActivity(Intent)&#125;</div><div class="line"> * <span class="doctag">@see</span> #startActivityForResult</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">		startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Note we want to go through this call for compatibility with</span></div><div class="line">		<span class="comment">// applications that may have overridden the method.</span></div><div class="line">		startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来会调用<code>startActivityForResult()</code>方法(注释也很重要啊，里面也说明了singleTask启动模式时该方法不会走到回调中):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Launch an activity for which you would like a result when it finished.</div><div class="line"> * When this activity exits, your</div><div class="line"> * onActivityResult() method will be called with the given requestCode.</div><div class="line"> * Using a negative requestCode is the same as calling</div><div class="line"> * &#123;<span class="doctag">@link</span> #startActivity&#125; (the activity is not launched as a sub-activity).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this method should only be used with Intent protocols</div><div class="line"> * that are defined to return a result.  In other protocols (such as</div><div class="line"> * &#123;<span class="doctag">@link</span> Intent#ACTION_MAIN&#125; or &#123;<span class="doctag">@link</span> Intent#ACTION_VIEW&#125;), you may</div><div class="line"> * not get the result when you expect.  For example, if the activity you</div><div class="line"> * are launching uses the singleTask launch mode, it will not run in your</div><div class="line"> * task and thus you will immediately receive a cancel result.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;As a special case, if you call startActivityForResult() with a requestCode</div><div class="line"> * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your</div><div class="line"> * activity, then your window will not be displayed until a result is</div><div class="line"> * returned back from the started activity.  This is to avoid visible</div><div class="line"> * flickering when redirecting to another activity.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> intent The intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode If &gt;= 0, this code will be returned in</div><div class="line"> *                    onActivityResult() when the activity exits.</div><div class="line"> * <span class="doctag">@param</span> options Additional options for how the Activity should be started.</div><div class="line"> * See &#123;<span class="doctag">@link</span> android.content.Context#startActivity(Intent, Bundle)</div><div class="line"> * Context.startActivity(Intent, Bundle)&#125; for more details.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #startActivity</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">	<span class="comment">// mParent也是Activity类，通过名字就能看明白了。</span></div><div class="line">	<span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 开始了啊</span></div><div class="line">		Instrumentation.ActivityResult ar =</div><div class="line">			mInstrumentation.execStartActivity(</div><div class="line">				<span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">				intent, requestCode, options);</div><div class="line">		<span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">			mMainThread.sendActivityResult(</div><div class="line">				mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">				ar.getResultData());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// If this start is requesting a result, we can avoid making</span></div><div class="line">			<span class="comment">// the activity visible until the result is received.  Setting</span></div><div class="line">			<span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></div><div class="line">			<span class="comment">// activity hidden during this time, to avoid flickering.</span></div><div class="line">			<span class="comment">// This can only be done when a result is requested because</span></div><div class="line">			<span class="comment">// that guarantees we will get information back when the</span></div><div class="line">			<span class="comment">// activity is finished, no matter what happens to it.</span></div><div class="line">			mStartedActivity = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cancelInputsAndStartExitTransition(options);</div><div class="line">		<span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">			mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// Note we want to go through this method for compatibility with</span></div><div class="line">			<span class="comment">// existing applications that may have overridden it.</span></div><div class="line">			mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面调用了<code>mInstrumentation.execStartActivity</code>这是啥玩意，先看一下<code>mInstrumentation</code>属性，他是<code>Instrumentation</code>类，我们看下文档<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Base class for implementing application instrumentation code.  When running</div><div class="line"> * with instrumentation turned on, this class will be instantiated for you</div><div class="line"> * before any of the application code, allowing you to monitor all of the</div><div class="line"> * interaction the system has with the application.  An Instrumentation</div><div class="line"> * implementation is described to the system through an AndroidManifest.xml's</div><div class="line"> * &amp;lt;instrumentation&amp;gt; tag.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Instrumentation</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>放狗查了下<code>Instrumentation</code>的意思是仪器、工具、装置的意思。我就大体翻一下(英语不好- -~，可能不准确)该类是实现应用程序代码的基类，当该类在<br>启动的状态下运行时，该类会在其他任何应用程序运行前进行初始化，允许你件事所有应用程序与系统的交互。一个<code>Instrumentation</code>实例会通过<code>Manifest</code>文件<br>中的<code>&lt;instrumenttation</code>标签描述给系统。<br>所以继续看一下<code>mInstrumentation.execStartActivity()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   // 下面的注释说的很明白了默认实现会更新任何活跃的对象并分发给系统的`activity manager`</div><div class="line"> * Execute a startActivity call made by the application.  The default </div><div class="line"> * implementation takes care of updating any active &#123;<span class="doctag">@link</span> ActivityMonitor&#125;</div><div class="line"> * objects and dispatches this call to the system activity manager; you can</div><div class="line"> * override this to watch for the application to start an activity, and </div><div class="line"> * modify what happens when it does. </div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method returns an &#123;<span class="doctag">@link</span> ActivityResult&#125; object, which you can </div><div class="line"> * use when intercepting application calls to avoid performing the start </div><div class="line"> * activity action but still return the result the application is </div><div class="line"> * expecting.  To do this, override this method to catch the call to start </div><div class="line"> * activity so that it returns a new ActivityResult containing the results </div><div class="line"> * you would like the application to see, and don't call up to the super </div><div class="line"> * class.  Note that an application is only expecting a result if </div><div class="line"> * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> who The Context from which the activity is being started.</div><div class="line"> * <span class="doctag">@param</span> contextThread The main thread of the Context from which the activity</div><div class="line"> *                      is being started.</div><div class="line"> * <span class="doctag">@param</span> token Internal token identifying to the system who is starting </div><div class="line"> *              the activity; may be null.</div><div class="line"> * <span class="doctag">@param</span> target Which activity is performing the start (and thus receiving </div><div class="line"> *               any result); may be null if this call is not being made</div><div class="line"> *               from an activity.</div><div class="line"> * <span class="doctag">@param</span> intent The actual Intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode Identifier for this request's result; less than zero </div><div class="line"> *                    if the caller is not expecting a result.</div><div class="line"> * <span class="doctag">@param</span> options Addition options.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> To force the return of a particular result, return an </div><div class="line"> *         ActivityResult object containing the desired data; otherwise</div><div class="line"> *         return null.  The default implementation always returns null.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivity(Intent)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityForResult(Intent, int)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityFromChild</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">		Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">		Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</div><div class="line">	IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">	Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</div><div class="line">		intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">				<span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</div><div class="line">					am.mHits++;</div><div class="line">					<span class="keyword">if</span> (am.isBlocking()) &#123;</div><div class="line">						<span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		intent.migrateExtraStreamToClipData();</div><div class="line">		intent.prepareToLeaveProcess();</div><div class="line">		<span class="comment">// 通过注释然后再结合代码一看我们就知道这应该就是分发到系统activity manager的过程</span></div><div class="line">		<span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">			.startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">					intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">					token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">					requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">		checkStartActivityResult(result, intent);</div><div class="line">	&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那就直接看下<code>ActivityManagerNative.getDefault().startActivity()</code>方法，看之前我们先看看<code>ActivityManagerNative.getDefault()</code>是什么鬼:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve the system's default/global activity manager.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释说的明白的就是拿到系统默认/全局的<code>activity manager</code>，通过名字也能看出来<code>IActivityManager</code>是个接口，那就继续看<code>IActivityManager.startActivity()</code>方法吧:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">            String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> flags,</div><div class="line">            ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException;</div></pre></td></tr></table></figure></p>
<p>这里就顺便看一下<code>IActivityManager</code>接口是神马鬼：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * System private API for talking with the activity manager service.  This</div><div class="line"> * provides calls from the application back to the activity manager.</div><div class="line"> *</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">public interface IActivityManager extends IInterface &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是看到这里我不知道怎么继续往下分析了啊，既然是接口我们要找到实现类啊，又是通过<code>ActivityManagerNative.getDefault()</code>得到的<code>IActivityManager</code>实例，<br>所以这里我们再看下<code>ActivityManagerNative</code>类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>啊！ 隐藏的，连个注释也没有，我拖动了下这个类一看<code>5992</code>行，不知道从哪下手了，还能从哪下手啊，当然是从<code>ActivityManagerNative.getDefault()</code>方法啊<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 继承Binder接口，而且asInterFace方法，我好想明白了点什么</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cast a Binder object into an activity manager interface, generating</div><div class="line">     * a proxy if needed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        IActivityManager in =</div><div class="line">            (IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> in;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Retrieve the system's default/global activity manager.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 使用了getDefaule的get方法</span></div><div class="line">        <span class="keyword">return</span> gDefault.get();</div><div class="line">    &#125;</div><div class="line">	....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看：　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">	<span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="comment">// 进程间通信了</span></div><div class="line">		IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">			Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 看到了吗？用到了刚才我们说的asInterface方法</span></div><div class="line">		IActivityManager am = asInterface(b);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">			Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> am;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>好了，我们再看下<code>asInterface()</code>方法:　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	IActivityManager in =</div><div class="line">		(IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">	<span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> in;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 在这里</span></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>终于找到了其实就是<code>ActivityManagerProxy</code>类，刚才我们找到<code>IActivityManager</code>接口的<code>startActivity()</code> 方法，现在终于找到了在这里使用的是<code>IActivityManager</code>接口实现类的<br><code>ActivityManagerProxy</code>类，我们来看一下该类实现的<code>startActivity()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span></span></div><div class="line">    &#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">			String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">			<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">		Parcel data = Parcel.obtain();</div><div class="line">		Parcel reply = Parcel.obtain();</div><div class="line">		data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">		data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</div><div class="line">		data.writeString(callingPackage);</div><div class="line">		intent.writeToParcel(data, <span class="number">0</span>);</div><div class="line">		data.writeString(resolvedType);</div><div class="line">		data.writeStrongBinder(resultTo);</div><div class="line">		data.writeString(resultWho);</div><div class="line">		data.writeInt(requestCode);</div><div class="line">		data.writeInt(startFlags);</div><div class="line">		<span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">			data.writeInt(<span class="number">1</span>);</div><div class="line">			profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			data.writeInt(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">			data.writeInt(<span class="number">1</span>);</div><div class="line">			options.writeToParcel(data, <span class="number">0</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			data.writeInt(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">		reply.readException();</div><div class="line">		<span class="keyword">int</span> result = reply.readInt();</div><div class="line">		reply.recycle();</div><div class="line">		data.recycle();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再继续我就不知道走到哪里了….<br>这一块其实是用了<code>Binder</code>机制，上面的<code>IActivityManager.getDefault()</code>方法返回的是<code>ActivityManagerService</code>的远程接口，所以接下来<br>我们应该看一下<code>ActivityManagerService.startActivity()</code>类。(具体<code>Binder</code>机制我们后续会专门写一篇文章，这里就不说了，不然就说不完了)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">		Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) &#123;</div><div class="line">	<span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">		resultWho, requestCode, startFlags, profilerInfo, options,</div><div class="line">		UserHandle.getCallingUserId());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看下<code>startActivityAsUser()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">		Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId) &#123;</div><div class="line">	enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">	userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</div><div class="line">			<span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></div><div class="line">	<span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">			resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">			profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>mStackSupervisor.startActivityMayWait()</code>方法,这里<code>mStackSupervisor</code>是<code>ActivityStackSupervisor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></div><div class="line">		String callingPackage, Intent intent, String resolvedType,</div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">		IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</div><div class="line">		ProfilerInfo profilerInfo, WaitResult outResult, Configuration config,</div><div class="line">		Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</div><div class="line">		IActivityContainer iContainer, TaskRecord inTask) &#123;</div><div class="line">	<span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">	<span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Don't modify the client's object!</span></div><div class="line">	intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">	<span class="comment">// 解析出要开启的Activity的信息，包名、类名、参数等。</span></div><div class="line">	<span class="comment">// Collect information about the target of the Intent.</span></div><div class="line">	ActivityInfo aInfo =</div><div class="line">			resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</div><div class="line"></div><div class="line">	ActivityContainer container = (ActivityContainer)iContainer;</div><div class="line">	<span class="keyword">synchronized</span> (mService) &#123;</div><div class="line">		<span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">				container.mParentActivity.state != RESUMED) &#123;</div><div class="line">			<span class="comment">// Cannot start a child activity if the parent is not resumed.</span></div><div class="line">			<span class="keyword">return</span> ActivityManager.START_CANCELED;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</div><div class="line">		<span class="keyword">int</span> callingPid;</div><div class="line">		<span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</div><div class="line">			callingPid = -<span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</div><div class="line">			callingPid = realCallingPid;</div><div class="line">			callingUid = realCallingUid;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			callingPid = callingUid = -<span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> ActivityStack stack;</div><div class="line">		<span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</div><div class="line">			stack = mFocusedStack;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			stack = container.mStack;</div><div class="line">		&#125;</div><div class="line">		stack.mConfigWillChange = config != <span class="keyword">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</div><div class="line">		<span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</div><div class="line">				<span class="string">"Starting activity when config will change = "</span> + stack.mConfigWillChange);</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</div><div class="line">				(aInfo.applicationInfo.privateFlags</div><div class="line">						&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// This may be a heavy-weight process!  Check to see if we already</span></div><div class="line">			<span class="comment">// have another, different heavy-weight process running.</span></div><div class="line">			<span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</div><div class="line">				<span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span> &amp;&amp;</div><div class="line">						(mService.mHeavyWeightProcess.info.uid != aInfo.applicationInfo.uid ||</div><div class="line">						!mService.mHeavyWeightProcess.processName.equals(aInfo.processName))) &#123;</div><div class="line">					<span class="keyword">int</span> appCallingUid = callingUid;</div><div class="line">					<span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">						ProcessRecord callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">						<span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">							appCallingUid = callerApp.info.uid;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">								  + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></div><div class="line">								  + intent.toString());</div><div class="line">							ActivityOptions.abort(options);</div><div class="line">							<span class="keyword">return</span> ActivityManager.START_PERMISSION_DENIED;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					IIntentSender target = mService.getIntentSenderLocked(</div><div class="line">							ActivityManager.INTENT_SENDER_ACTIVITY, <span class="string">"android"</span>,</div><div class="line">							appCallingUid, userId, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">new</span> Intent[] &#123; intent &#125;,</div><div class="line">							<span class="keyword">new</span> String[] &#123; resolvedType &#125;, PendingIntent.FLAG_CANCEL_CURRENT</div><div class="line">							| PendingIntent.FLAG_ONE_SHOT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">					Intent newIntent = <span class="keyword">new</span> Intent();</div><div class="line">					<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">						<span class="comment">// Caller is requesting a result.</span></div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_HAS_RESULT, <span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">					newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT,</div><div class="line">							<span class="keyword">new</span> IntentSender(target));</div><div class="line">					<span class="keyword">if</span> (mService.mHeavyWeightProcess.activities.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">						ActivityRecord hist = mService.mHeavyWeightProcess.activities.get(<span class="number">0</span>);</div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_APP,</div><div class="line">								hist.packageName);</div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_TASK,</div><div class="line">								hist.task.taskId);</div><div class="line">					&#125;</div><div class="line">					newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP,</div><div class="line">							aInfo.packageName);</div><div class="line">					newIntent.setFlags(intent.getFlags());</div><div class="line">					newIntent.setClassName(<span class="string">"android"</span>,</div><div class="line">							HeavyWeightSwitcherActivity.class.getName());</div><div class="line">					intent = newIntent;</div><div class="line">					resolvedType = <span class="keyword">null</span>;</div><div class="line">					caller = <span class="keyword">null</span>;</div><div class="line">					callingUid = Binder.getCallingUid();</div><div class="line">					callingPid = Binder.getCallingPid();</div><div class="line">					componentSpecified = <span class="keyword">true</span>;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						ResolveInfo rInfo =</div><div class="line">							AppGlobals.getPackageManager().resolveIntent(</div><div class="line">									intent, <span class="keyword">null</span>,</div><div class="line">									PackageManager.MATCH_DEFAULT_ONLY</div><div class="line">									| ActivityManagerService.STOCK_PM_FLAGS, userId);</div><div class="line">						aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</div><div class="line">						aInfo = mService.getActivityInfoForUser(aInfo, userId);</div><div class="line">					&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">						aInfo = <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 根据上面解析的内容去开启了。。。</span></div><div class="line">		<span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</div><div class="line">				voiceSession, voiceInteractor, resultTo, resultWho,</div><div class="line">				requestCode, callingPid, callingUid, callingPackage,</div><div class="line">				realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</div><div class="line">				componentSpecified, <span class="keyword">null</span>, container, inTask);</div><div class="line"></div><div class="line">		Binder.restoreCallingIdentity(origId);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (stack.mConfigWillChange) &#123;</div><div class="line">			<span class="comment">// If the caller also wants to switch to a new configuration,</span></div><div class="line">			<span class="comment">// do so now.  This allows a clean switch, as we are waiting</span></div><div class="line">			<span class="comment">// for the current activity to pause (so we will not destroy</span></div><div class="line">			<span class="comment">// it), and have not yet started the next activity.</span></div><div class="line">			mService.enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</div><div class="line">					<span class="string">"updateConfiguration()"</span>);</div><div class="line">			stack.mConfigWillChange = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</div><div class="line">					<span class="string">"Updating to new configuration after starting activity."</span>);</div><div class="line">			mService.updateConfigurationLocked(config, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</div><div class="line">			outResult.result = res;</div><div class="line">			<span class="keyword">if</span> (res == ActivityManager.START_SUCCESS) &#123;</div><div class="line">				mWaitingActivityLaunched.add(outResult);</div><div class="line">				<span class="keyword">do</span> &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						mService.wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (res == ActivityManager.START_TASK_TO_FRONT) &#123;</div><div class="line">				ActivityRecord r = stack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">				<span class="keyword">if</span> (r.nowVisible &amp;&amp; r.state == RESUMED) &#123;</div><div class="line">					outResult.timeout = <span class="keyword">false</span>;</div><div class="line">					outResult.who = <span class="keyword">new</span> ComponentName(r.info.packageName, r.info.name);</div><div class="line">					outResult.totalTime = <span class="number">0</span>;</div><div class="line">					outResult.thisTime = <span class="number">0</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					outResult.thisTime = SystemClock.uptimeMillis();</div><div class="line">					mWaitingActivityVisible.add(outResult);</div><div class="line">					<span class="keyword">do</span> &#123;</div><div class="line">						<span class="keyword">try</span> &#123;</div><div class="line">							mService.wait();</div><div class="line">						&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> res;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那就继续看一下<code>startActivityLocked()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">		Intent intent, String resolvedType, ActivityInfo aInfo,</div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">		IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</div><div class="line">		<span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</div><div class="line">		<span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</div><div class="line">		ActivityContainer container, TaskRecord inTask) &#123;</div><div class="line">	<span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</div><div class="line"></div><div class="line">	ProcessRecord callerApp = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// mService就是ActivityManagerService类</span></div><div class="line">		callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">		<span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">			callingPid = callerApp.pid;</div><div class="line">			callingUid = callerApp.info.uid;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">				  + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></div><div class="line">				  + intent.toString());</div><div class="line">			err = ActivityManager.START_PERMISSION_DENIED;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</div><div class="line">		Slog.i(TAG, <span class="string">"START u"</span> + userId + <span class="string">" &#123;"</span> + intent.toShortString(<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>)</div><div class="line">				+ <span class="string">"&#125; from uid "</span> + callingUid</div><div class="line">				+ <span class="string">" on display "</span> + (container == <span class="keyword">null</span> ? (mFocusedStack == <span class="keyword">null</span> ?</div><div class="line">						Display.DEFAULT_DISPLAY : mFocusedStack.mDisplayId) :</div><div class="line">						(container.mActivityDisplay == <span class="keyword">null</span> ? Display.DEFAULT_DISPLAY :</div><div class="line">								container.mActivityDisplay.mDisplayId)));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ActivityRecord sourceRecord = <span class="keyword">null</span>;</div><div class="line">	ActivityRecord resultRecord = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">		sourceRecord = isInAnyStackLocked(resultTo);</div><div class="line">		<span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</div><div class="line">				<span class="string">"Will send result to "</span> + resultTo + <span class="string">" "</span> + sourceRecord);</div><div class="line">		<span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</div><div class="line">				resultRecord = sourceRecord;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// Transfer the result target from the source activity to the new</span></div><div class="line">		<span class="comment">// one being started, including any failures.</span></div><div class="line">		<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</div><div class="line">		&#125;</div><div class="line">		resultRecord = sourceRecord.resultTo;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;</div><div class="line">			resultRecord = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		resultWho = sourceRecord.resultWho;</div><div class="line">		requestCode = sourceRecord.requestCode;</div><div class="line">		sourceRecord.resultTo = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (sourceRecord.launchedFromUid == callingUid) &#123;</div><div class="line">			<span class="comment">// The new activity is being launched from the same uid as the previous</span></div><div class="line">			<span class="comment">// activity in the flow, and asking to forward its result back to the</span></div><div class="line">			<span class="comment">// previous.  In this case the activity is serving as a trampoline between</span></div><div class="line">			<span class="comment">// the two, so we also want to update its launchedFromPackage to be the</span></div><div class="line">			<span class="comment">// same as the previous activity.  Note that this is safe, since we know</span></div><div class="line">			<span class="comment">// these two packages come from the same uid; the caller could just as</span></div><div class="line">			<span class="comment">// well have supplied that same package name itself.  This specifially</span></div><div class="line">			<span class="comment">// deals with the case of an intent picker/chooser being launched in the app</span></div><div class="line">			<span class="comment">// flow to redirect to an activity picked by the user, where we want the final</span></div><div class="line">			<span class="comment">// activity to consider it to have been launched by the previous app activity.</span></div><div class="line">			callingPackage = sourceRecord.launchedFromPackage;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// We couldn't find a class that can handle the given Intent.</span></div><div class="line">		<span class="comment">// That's the end of that!</span></div><div class="line">		err = ActivityManager.START_INTENT_NOT_RESOLVED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// We couldn't find the specific class specified in the Intent.</span></div><div class="line">		<span class="comment">// Also the end of the line.</span></div><div class="line">		err = ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS</div><div class="line">			&amp;&amp; !isCurrentProfileLocked(userId)</div><div class="line">			&amp;&amp; (aInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// Trying to launch a background activity that doesn't show for all users.</span></div><div class="line">		err = ActivityManager.START_NOT_CURRENT_USER_ACTIVITY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class="keyword">null</span></div><div class="line">			&amp;&amp; sourceRecord.task.voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If this activity is being launched as part of a voice session, we need</span></div><div class="line">		<span class="comment">// to ensure that it is safe to do so.  If the upcoming activity will also</span></div><div class="line">		<span class="comment">// be part of the voice session, we can only launch it if it has explicitly</span></div><div class="line">		<span class="comment">// said it supports the VOICE category, or it is a part of the calling app.</span></div><div class="line">		<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span></div><div class="line">				&amp;&amp; sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				intent.addCategory(Intent.CATEGORY_VOICE);</div><div class="line">				<span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(</div><div class="line">						intent.getComponent(), intent, resolvedType)) &#123;</div><div class="line">					Slog.w(TAG,</div><div class="line">							<span class="string">"Activity being started in current voice task does not support voice: "</span></div><div class="line">							+ intent);</div><div class="line">					err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				Slog.w(TAG, <span class="string">"Failure checking voice capabilities"</span>, e);</div><div class="line">				err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the caller is starting a new voice session, just make sure the target</span></div><div class="line">		<span class="comment">// is actually allowing it to run this way.</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(intent.getComponent(),</div><div class="line">					intent, resolvedType)) &#123;</div><div class="line">				Slog.w(TAG,</div><div class="line">						<span class="string">"Activity being started in new voice task does not support: "</span></div><div class="line">						+ intent);</div><div class="line">				err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">			Slog.w(TAG, <span class="string">"Failure checking voice capabilities"</span>, e);</div><div class="line">			err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Activity栈</span></div><div class="line">	<span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err != ActivityManager.START_SUCCESS) &#123;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">				resultRecord, resultWho, requestCode,</div><div class="line">				Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> err;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> startAnyPerm = mService.checkPermission(</div><div class="line">			START_ANY_ACTIVITY, callingPid, callingUid);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (startAnyPerm != PERMISSION_GRANTED) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> componentRestriction = getComponentRestrictionForCallingPackage(</div><div class="line">				aInfo, callingPackage, callingPid, callingUid, ignoreTargetSecurity);</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> actionRestriction = getActionRestrictionForCallingPackage(</div><div class="line">				intent.getAction(), callingPackage, callingPid, callingUid);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION</div><div class="line">				|| actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</div><div class="line">			<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">				resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">						resultRecord, resultWho, requestCode,</div><div class="line">						Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			String msg;</div><div class="line">			<span class="keyword">if</span> (actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span> + <span class="string">" with revoked permission "</span></div><div class="line">						+ ACTION_TO_RUNTIME_PERMISSION.get(intent.getAction());</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!aInfo.exported) &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">						+ <span class="string">" not exported from uid "</span> + aInfo.applicationInfo.uid;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">						+ <span class="string">" requires "</span> + aInfo.permission;</div><div class="line">			&#125;</div><div class="line">			Slog.w(TAG, msg);</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (actionRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</div><div class="line">			String message = <span class="string">"Appop Denial: starting "</span> + intent.toString()</div><div class="line">					+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">					+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">					+ <span class="string">" requires "</span> + AppOpsManager.permissionToOp(</div><div class="line">							ACTION_TO_RUNTIME_PERMISSION.get(intent.getAction()));</div><div class="line">			Slog.w(TAG, message);</div><div class="line">			abort = <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (componentRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</div><div class="line">			String message = <span class="string">"Appop Denial: starting "</span> + intent.toString()</div><div class="line">					+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">					+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">					+ <span class="string">" requires appop "</span> + AppOpsManager.permissionToOp(aInfo.permission);</div><div class="line">			Slog.w(TAG, message);</div><div class="line">			abort = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</div><div class="line">			callingPid, resolvedType, aInfo.applicationInfo);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// The Intent we give to the watcher has the extra data</span></div><div class="line">			<span class="comment">// stripped off, since it can contain private information.</span></div><div class="line">			Intent watchIntent = intent.cloneFilter();</div><div class="line">			abort |= !mService.mController.activityStarting(watchIntent,</div><div class="line">					aInfo.applicationInfo.packageName);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">			mService.mController = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (abort) &#123;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultStack.sendActivityResultLocked(-<span class="number">1</span>, resultRecord, resultWho, requestCode,</div><div class="line">					Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// We pretend to the caller that it was really started, but</span></div><div class="line">		<span class="comment">// they will just get a cancel result.</span></div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// ActivityRecord: An entry in the history stack, representing an activity.</span></div><div class="line">	ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</div><div class="line">			intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</div><div class="line">			requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</div><div class="line">	<span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</div><div class="line">		outActivity[<span class="number">0</span>] = r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (r.appTimeTracker == <span class="keyword">null</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the caller didn't specify an explicit time tracker, we want to continue</span></div><div class="line">		<span class="comment">// tracking under any it has.</span></div><div class="line">		r.appTimeTracker = sourceRecord.appTimeTracker;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ActivityStack stack = mFocusedStack;</div><div class="line">	<span class="keyword">if</span> (voiceSession == <span class="keyword">null</span> &amp;&amp; (stack.mResumedActivity == <span class="keyword">null</span></div><div class="line">			|| stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</div><div class="line">		<span class="keyword">if</span> (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid,</div><div class="line">				realCallingPid, realCallingUid, <span class="string">"Activity start"</span>)) &#123;</div><div class="line">			PendingActivityLaunch pal =</div><div class="line">					<span class="keyword">new</span> PendingActivityLaunch(r, sourceRecord, startFlags, stack);</div><div class="line">			mPendingActivityLaunches.add(pal);</div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_SWITCHES_CANCELED;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mService.mDidAppSwitch) &#123;</div><div class="line">		<span class="comment">// This is the second allowed switch since we stopped switches,</span></div><div class="line">		<span class="comment">// so now just generally allow switches.  Use case: user presses</span></div><div class="line">		<span class="comment">// home (switches disabled, switch to home, mDidAppSwitch now true);</span></div><div class="line">		<span class="comment">// user taps a home icon (coming from home so allowed, we hit here</span></div><div class="line">		<span class="comment">// and now allow anyone to switch again).</span></div><div class="line">		mService.mAppSwitchesAllowedTime = <span class="number">0</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mService.mDidAppSwitch = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</div><div class="line">	<span class="comment">// 继续调用方法</span></div><div class="line">	err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">			startFlags, <span class="keyword">true</span>, options, inTask);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// If someone asked to have the keyguard dismissed on the next</span></div><div class="line">		<span class="comment">// activity start, but we are not actually doing an activity</span></div><div class="line">		<span class="comment">// switch...  just dismiss the keyguard now, because we</span></div><div class="line">		<span class="comment">// probably want to see whatever is behind it.</span></div><div class="line">		notifyActivityDrawnForKeyguard();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再继续看<code>startActivityUncheckedLocked</code>方法：　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,</div><div class="line">		<span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask) &#123;</div><div class="line">	<span class="keyword">final</span> Intent intent = r.intent;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</div><div class="line"></div><div class="line">	<span class="comment">// In some flows in to this function, we retrieve the task record and hold on to it</span></div><div class="line">	<span class="comment">// without a lock before calling back in to here...  so the task at this point may</span></div><div class="line">	<span class="comment">// not actually be in recents.  Check for that, and if it isn't in recents just</span></div><div class="line">	<span class="comment">// consider it invalid.</span></div><div class="line">	<span class="keyword">if</span> (inTask != <span class="keyword">null</span> &amp;&amp; !inTask.inRecents) &#123;</div><div class="line">		Slog.w(TAG, <span class="string">"Starting activity in task not in recents: "</span> + inTask);</div><div class="line">		inTask = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 判断不同的启动模式</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</div><div class="line"></div><div class="line">	.....</div><div class="line"></div><div class="line">	<span class="comment">// We may want to try to place the new activity in to an existing task.  We always</span></div><div class="line">	<span class="comment">// do this if the target activity is singleTask or singleInstance; we will also do</span></div><div class="line">	<span class="comment">// this if NEW_TASK has been requested, and there is not an additional qualifier telling</span></div><div class="line">	<span class="comment">// us to still place it in a new task: multi task, always doc mode, or being asked to</span></div><div class="line">	<span class="comment">// launch this as a new task behind the current one.</span></div><div class="line">	<span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</div><div class="line">			(launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</div><div class="line">			|| launchSingleInstance || launchSingleTask) &#123;</div><div class="line">		<span class="comment">// If bring to front is requested, and no result is requested and we have not</span></div><div class="line">		<span class="comment">// been given an explicit task to launch in to, and</span></div><div class="line">		<span class="comment">// we can find a task that was started with this same</span></div><div class="line">		<span class="comment">// component, then instead of launching bring that one to the front.</span></div><div class="line">		<span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// See if there is a task to bring to the front.  If this is</span></div><div class="line">			<span class="comment">// a SINGLE_INSTANCE activity, there can be one and only one</span></div><div class="line">			<span class="comment">// instance of it in the history, and it is always in its own</span></div><div class="line">			<span class="comment">// unique task, so we do a special search.</span></div><div class="line">			ActivityRecord intentActivity = !launchSingleInstance ?</div><div class="line">					findTaskLocked(r) : findActivityLocked(intent, r.info);</div><div class="line">			<span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused</span></div><div class="line">				<span class="comment">// but still needs to be a lock task mode violation since the task gets</span></div><div class="line">				<span class="comment">// cleared out and the device would otherwise leave the locked task.</span></div><div class="line">				<span class="keyword">if</span> (isLockTaskModeViolation(intentActivity.task,</div><div class="line">						(launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">						== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</div><div class="line">					showLockTaskToast();</div><div class="line">					Slog.e(TAG, <span class="string">"startActivityUnchecked: Attempt to violate Lock Task Mode"</span>);</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</div><div class="line">					r.task = intentActivity.task;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (intentActivity.task.intent == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// This task was started because of movement of</span></div><div class="line">					<span class="comment">// the activity based on affinity...  now that we</span></div><div class="line">					<span class="comment">// are actually launching it, we can assign the</span></div><div class="line">					<span class="comment">// base intent.</span></div><div class="line">					intentActivity.task.setIntent(r);</div><div class="line">				&#125;</div><div class="line">				targetStack = intentActivity.task.stack;</div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="comment">// If the target task is not in the front, then we need</span></div><div class="line">				<span class="comment">// to bring it to the front...  except...  well, with</span></div><div class="line">				<span class="comment">// SINGLE_TASK_LAUNCH it's not entirely clear.  We'd like</span></div><div class="line">				<span class="comment">// to have the same behavior as if a new instance was</span></div><div class="line">				<span class="comment">// being started, which means not bringing it to the front</span></div><div class="line">				<span class="comment">// if the caller is not itself in the front.</span></div><div class="line">				<span class="keyword">final</span> ActivityStack focusStack = getFocusedStack();</div><div class="line">				ActivityRecord curTop = (focusStack == <span class="keyword">null</span>)</div><div class="line">						? <span class="keyword">null</span> : focusStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">				<span class="keyword">boolean</span> movedToFront = <span class="keyword">false</span>;</div><div class="line">				<span class="keyword">if</span> (curTop != <span class="keyword">null</span> &amp;&amp; (curTop.task != intentActivity.task ||</div><div class="line">						curTop.task != focusStack.topTask())) &#123;</div><div class="line">					r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);</div><div class="line">					<span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> || (sourceStack.topActivity() != <span class="keyword">null</span> &amp;&amp;</div><div class="line">							sourceStack.topActivity().task == sourceRecord.task)) &#123;</div><div class="line">						<span class="comment">// We really do want to push this one into the user's face, right now.</span></div><div class="line">						<span class="keyword">if</span> (launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">							intentActivity.setTaskToAffiliateWith(sourceRecord.task);</div><div class="line">						&#125;</div><div class="line">						movedHome = <span class="keyword">true</span>;</div><div class="line">						targetStack.moveTaskToFrontLocked(intentActivity.task, noAnimation,</div><div class="line">								options, r.appTimeTracker, <span class="string">"bringingFoundTaskToFront"</span>);</div><div class="line">						movedToFront = <span class="keyword">true</span>;</div><div class="line">						<span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">								(FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">								== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">							<span class="comment">// Caller wants to appear on home activity.</span></div><div class="line">							intentActivity.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">						&#125;</div><div class="line">						options = <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">					<span class="keyword">if</span> (DEBUG_TASKS) Slog.d(TAG_TASKS, <span class="string">"Bring to front target: "</span> + targetStack</div><div class="line">							+ <span class="string">" from "</span> + intentActivity);</div><div class="line">					targetStack.moveToFront(<span class="string">"intentActivityFound"</span>);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// If the caller has requested that the target task be</span></div><div class="line">				<span class="comment">// reset, then do so.</span></div><div class="line">				<span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					intentActivity = targetStack.resetTaskIfNeededLocked(intentActivity, r);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">					<span class="comment">// the client said not to do anything if that</span></div><div class="line">					<span class="comment">// is the case, so this is it!  And for paranoia, make</span></div><div class="line">					<span class="comment">// sure we have correctly resumed the top activity.</span></div><div class="line">					<span class="keyword">if</span> (doResume) &#123;</div><div class="line">						resumeTopActivitiesLocked(targetStack, <span class="keyword">null</span>, options);</div><div class="line"></div><div class="line">						<span class="comment">// Make sure to notify Keyguard as well if we are not running an app</span></div><div class="line">						<span class="comment">// transition later.</span></div><div class="line">						<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">							notifyActivityDrawnForKeyguard();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> ((launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">						== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</div><div class="line">					<span class="comment">// The caller has requested to completely replace any</span></div><div class="line">					<span class="comment">// existing task with its new activity.  Well that should</span></div><div class="line">					<span class="comment">// not be too hard...</span></div><div class="line">					reuseTask = intentActivity.task;</div><div class="line">					reuseTask.performClearTaskLocked();</div><div class="line">					reuseTask.setIntent(r);</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></div><div class="line">						|| launchSingleInstance || launchSingleTask) &#123;</div><div class="line">					<span class="comment">// In this situation we want to remove all activities</span></div><div class="line">					<span class="comment">// from the task up to the one being started.  In most</span></div><div class="line">					<span class="comment">// cases this means we are resetting the task to its</span></div><div class="line">					<span class="comment">// initial state.</span></div><div class="line">					ActivityRecord top =</div><div class="line">							intentActivity.task.performClearTaskLocked(r, launchFlags);</div><div class="line">					<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">if</span> (top.frontOfTask) &#123;</div><div class="line">							<span class="comment">// Activity aliases may mean we use different</span></div><div class="line">							<span class="comment">// intents for the top activity, so make sure</span></div><div class="line">							<span class="comment">// the task now has the identity of the new</span></div><div class="line">							<span class="comment">// intent.</span></div><div class="line">							top.task.setIntent(r);</div><div class="line">						&#125;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT,</div><div class="line">								r, top.task);</div><div class="line">						top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="comment">// A special case: we need to start the activity because it is not</span></div><div class="line">						<span class="comment">// currently running, and the caller has asked to clear the current</span></div><div class="line">						<span class="comment">// task to have this activity at the top.</span></div><div class="line">						addingToTask = <span class="keyword">true</span>;</div><div class="line">						<span class="comment">// Now pretend like this activity is being started by the top of its</span></div><div class="line">						<span class="comment">// task, so it is put in the right place.</span></div><div class="line">						sourceRecord = intentActivity;</div><div class="line">						TaskRecord task = sourceRecord.task;</div><div class="line">						<span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.stack == <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Target stack got cleared when we all activities were removed</span></div><div class="line">							<span class="comment">// above. Go ahead and reset it.</span></div><div class="line">							targetStack = computeStackFocus(sourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>);</div><div class="line">							targetStack.addTask(</div><div class="line">									task, !launchTaskBehind <span class="comment">/* toTop */</span>, <span class="keyword">false</span> <span class="comment">/* moving */</span>);</div><div class="line">						&#125;</div><div class="line"></div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.realActivity.equals(intentActivity.task.realActivity)) &#123;</div><div class="line">					<span class="comment">// In this case the top activity on the task is the</span></div><div class="line">					<span class="comment">// same as the one being launched, so we take that</span></div><div class="line">					<span class="comment">// as a request to bring the task to the foreground.</span></div><div class="line">					<span class="comment">// If the top activity in the task is the root</span></div><div class="line">					<span class="comment">// activity, deliver this new intent to it if it</span></div><div class="line">					<span class="comment">// desires.</span></div><div class="line">					<span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || launchSingleTop)</div><div class="line">							&amp;&amp; intentActivity.realActivity.equals(r.realActivity)) &#123;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r,</div><div class="line">								intentActivity.task);</div><div class="line">						<span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</div><div class="line">							intentActivity.task.setIntent(r);</div><div class="line">						&#125;</div><div class="line">						intentActivity.deliverNewIntentLocked(callingUid, r.intent,</div><div class="line">								r.launchedFromPackage);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r.intent.filterEquals(intentActivity.task.intent)) &#123;</div><div class="line">						<span class="comment">// In this case we are launching the root activity</span></div><div class="line">						<span class="comment">// of the task, but with a different intent.  We</span></div><div class="line">						<span class="comment">// should start a new instance on top.</span></div><div class="line">						addingToTask = <span class="keyword">true</span>;</div><div class="line">						sourceRecord = intentActivity;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// In this case an activity is being launched in to an</span></div><div class="line">					<span class="comment">// existing task, without resetting that task.  This</span></div><div class="line">					<span class="comment">// is typically the situation of launching an activity</span></div><div class="line">					<span class="comment">// from a notification or shortcut.  We want to place</span></div><div class="line">					<span class="comment">// the new activity on top of the current task.</span></div><div class="line">					addingToTask = <span class="keyword">true</span>;</div><div class="line">					sourceRecord = intentActivity;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.task.rootWasReset) &#123;</div><div class="line">					<span class="comment">// In this case we are launching in to an existing task</span></div><div class="line">					<span class="comment">// that has not yet been started from its front door.</span></div><div class="line">					<span class="comment">// The current task has been brought to the front.</span></div><div class="line">					<span class="comment">// Ideally, we'd probably like to place this new task</span></div><div class="line">					<span class="comment">// at the bottom of its stack, but that's a little hard</span></div><div class="line">					<span class="comment">// to do with the current organization of the code so</span></div><div class="line">					<span class="comment">// for now we'll just drop it.</span></div><div class="line">					intentActivity.task.setIntent(r);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (!addingToTask &amp;&amp; reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// We didn't do anything...  but it was needed (a.k.a., client</span></div><div class="line">					<span class="comment">// don't use that intent!)  And for paranoia, make</span></div><div class="line">					<span class="comment">// sure we have correctly resumed the top activity.</span></div><div class="line">					<span class="keyword">if</span> (doResume) &#123;</div><div class="line">						targetStack.resumeTopActivityLocked(<span class="keyword">null</span>, options);</div><div class="line">						<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">							<span class="comment">// Make sure to notify Keyguard as well if we are not running an app</span></div><div class="line">							<span class="comment">// transition later.</span></div><div class="line">							notifyActivityDrawnForKeyguard();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//String uri = r.intent.toURI();</span></div><div class="line">	<span class="comment">//Intent intent2 = new Intent(uri);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "Given intent: " + r.intent);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "URI is: " + uri);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "To intent: " + intent2);</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the activity being launched is the same as the one currently</span></div><div class="line">		<span class="comment">// at the top, then we need to check if it should only be launched</span></div><div class="line">		<span class="comment">// once.</span></div><div class="line">		ActivityStack topStack = mFocusedStack;</div><div class="line">		ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">				<span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">						|| launchSingleTop || launchSingleTask) &#123;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</div><div class="line">								top.task);</div><div class="line">						<span class="comment">// For paranoia, make sure we have correctly</span></div><div class="line">						<span class="comment">// resumed the top activity.</span></div><div class="line">						topStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">						<span class="keyword">if</span> (doResume) &#123;</div><div class="line">							resumeTopActivitiesLocked();</div><div class="line">						&#125;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">						<span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">							<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">							<span class="comment">// the client said not to do anything if that</span></div><div class="line">							<span class="comment">// is the case, so this is it!</span></div><div class="line">							<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">						&#125;</div><div class="line">						top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">						<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">			r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>, r.resultTo, r.resultWho,</div><div class="line">					r.requestCode, Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</div><div class="line">			sourceRecord.task : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Should this be considered a new task?</span></div><div class="line">	<span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</div><div class="line">			&amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">		newTask = <span class="keyword">true</span>;</div><div class="line">		targetStack = computeStackFocus(r, newTask);</div><div class="line">		targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">			r.setTask(targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">					newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</div><div class="line">					newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</div><div class="line">					voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</div><div class="line">					taskToAffiliate);</div><div class="line">			<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS,</div><div class="line">					<span class="string">"Starting new activity "</span> + r + <span class="string">" in new task "</span> + r.task);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.setTask(reuseTask, taskToAffiliate);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(r.task)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!movedHome) &#123;</div><div class="line">			<span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">					(FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">					== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">				<span class="comment">// Caller wants to appear on home activity, so before starting</span></div><div class="line">				<span class="comment">// their own activity we will bring home to the front.</span></div><div class="line">				r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> TaskRecord sourceTask = sourceRecord.task;</div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(sourceTask)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		targetStack = sourceTask.stack;</div><div class="line">		targetStack.moveToFront(<span class="string">"sourceStackToFront"</span>);</div><div class="line">		<span class="keyword">final</span> TaskRecord topTask = targetStack.topTask();</div><div class="line">		<span class="keyword">if</span> (topTask != sourceTask) &#123;</div><div class="line">			targetStack.moveTaskToFrontLocked(sourceTask, noAnimation, options,</div><div class="line">					r.appTimeTracker, <span class="string">"sourceTaskToFront"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!addingToTask &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// In this case, we are adding the activity to an existing</span></div><div class="line">			<span class="comment">// task, but the caller has asked to clear that task if the</span></div><div class="line">			<span class="comment">// activity is already running.</span></div><div class="line">			ActivityRecord top = sourceTask.performClearTaskLocked(r, launchFlags);</div><div class="line">			keepCurTransition = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, top.task);</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				<span class="comment">// For paranoia, make sure we have correctly</span></div><div class="line">				<span class="comment">// resumed the top activity.</span></div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (doResume) &#123;</div><div class="line">					targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">				ActivityOptions.abort(options);</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addingToTask &amp;&amp;</div><div class="line">				(launchFlags&amp;Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// In this case, we are launching an activity in our own task</span></div><div class="line">			<span class="comment">// that may already be running somewhere in the history, and</span></div><div class="line">			<span class="comment">// we want to shuffle it to the front of the stack if so.</span></div><div class="line">			<span class="keyword">final</span> ActivityRecord top = sourceTask.findActivityInHistoryLocked(r);</div><div class="line">			<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> TaskRecord task = top.task;</div><div class="line">				task.moveActivityToFrontLocked(top);</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, task);</div><div class="line">				top.updateOptionsLocked(options);</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (doResume) &#123;</div><div class="line">					targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// An existing activity is starting this new activity, so we want</span></div><div class="line">		<span class="comment">// to keep the new one in the same task as the one that is starting</span></div><div class="line">		<span class="comment">// it.</span></div><div class="line">		r.setTask(sourceTask, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in existing task "</span> + r.task + <span class="string">" from source "</span> + sourceRecord);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The caller is asking that the new activity be started in an explicit</span></div><div class="line">		<span class="comment">// task it has provided to us.</span></div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(inTask)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		targetStack = inTask.stack;</div><div class="line">		targetStack.moveTaskToFrontLocked(inTask, noAnimation, options, r.appTimeTracker,</div><div class="line">				<span class="string">"inTaskToFront"</span>);</div><div class="line"></div><div class="line">		<span class="comment">// Check whether we should actually launch the new activity in to the task,</span></div><div class="line">		<span class="comment">// or just reuse the current activity on top.</span></div><div class="line">		ActivityRecord top = inTask.getTopActivity();</div><div class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">			<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">					|| launchSingleTop || launchSingleTask) &#123;</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top, top.task);</div><div class="line">				<span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">					<span class="comment">// the client said not to do anything if that</span></div><div class="line">					<span class="comment">// is the case, so this is it!</span></div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">				&#125;</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!addingToTask) &#123;</div><div class="line">			<span class="comment">// We don't actually want to have this activity added to the task, so just</span></div><div class="line">			<span class="comment">// stop here but still tell the caller that we consumed the intent.</span></div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		r.setTask(inTask, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in explicit task "</span> + r.task);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// This not being started from an existing activity, and not part</span></div><div class="line">		<span class="comment">// of a new task...  just put it in the top task, though these days</span></div><div class="line">		<span class="comment">// this case should never happen.</span></div><div class="line">		targetStack = computeStackFocus(r, newTask);</div><div class="line">		targetStack.moveToFront(<span class="string">"addingToTopTask"</span>);</div><div class="line">		ActivityRecord prev = targetStack.topActivity();</div><div class="line">		r.setTask(prev != <span class="keyword">null</span> ? prev.task : targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">						r.info, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>), <span class="keyword">null</span>);</div><div class="line">		mWindowManager.moveTaskToTop(r.task.taskId);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in new guessed "</span> + r.task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</div><div class="line">			intent, r.getUriPermissionsLocked(), r.userId);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span> &amp;&amp; sourceRecord.isRecentsActivity()) &#123;</div><div class="line">		r.task.setTaskToReturnTo(RECENTS_ACTIVITY_TYPE);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (newTask) &#123;</div><div class="line">		EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, r.userId, r.task.taskId);</div><div class="line">	&#125;</div><div class="line">	ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task);</div><div class="line">	targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">	</div><div class="line">	<span class="comment">// 上面这部分代码很多，各种启动模式、栈的处理啊，我们就不继续看了，接着看下面的启动。</span></div><div class="line">	targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</div><div class="line">	<span class="keyword">if</span> (!launchTaskBehind) &#123;</div><div class="line">		<span class="comment">// Don't set focus on an activity that's going to the back.</span></div><div class="line">		mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>targetStack.startActivityLocked()</code>方法,这里<code>targetStack</code>就是<code>ActivityStack</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span></span></div><div class="line">		<span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options) &#123;</div><div class="line">	TaskRecord rTask = r.task;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</div><div class="line">	<span class="comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span></div><div class="line">	<span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</div><div class="line">		<span class="comment">// Last activity in task had been removed or ActivityManagerService is reusing task.</span></div><div class="line">		<span class="comment">// Insert or replace.</span></div><div class="line">		<span class="comment">// Might not even be in.</span></div><div class="line">		insertTaskAtTop(rTask, r);</div><div class="line">		mWindowManager.moveTaskToTop(taskId);</div><div class="line">	&#125;</div><div class="line">	TaskRecord task = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (!newTask) &#123;</div><div class="line">		<span class="comment">// If starting in an existing task, find where that is...</span></div><div class="line">		<span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</div><div class="line">			task = mTaskHistory.get(taskNdx);</div><div class="line">			<span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// All activities in task are finishing.</span></div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (task == r.task) &#123;</div><div class="line">				<span class="comment">// Here it is!  Now, if this is not yet visible to the</span></div><div class="line">				<span class="comment">// user, then just add it without starting; it will</span></div><div class="line">				<span class="comment">// get started when the user navigates back to it.</span></div><div class="line">				<span class="keyword">if</span> (!startIt) &#123;</div><div class="line">					<span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to task "</span></div><div class="line">							+ task, <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">					task.addActivityToTop(r);</div><div class="line">					r.putInHistory();</div><div class="line">					mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">							r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">							(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>,</div><div class="line">							r.userId, r.info.configChanges, task.voiceSession != <span class="keyword">null</span>,</div><div class="line">							r.mLaunchTaskBehind);</div><div class="line">					<span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">						validateAppTokensLocked();</div><div class="line">					&#125;</div><div class="line">					ActivityOptions.abort(options);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</div><div class="line">				startIt = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Place a new activity at top of stack, so it is next to interact</span></div><div class="line">	<span class="comment">// with the user.</span></div><div class="line"></div><div class="line">	<span class="comment">// If we are not placing the new activity frontmost, we do not want</span></div><div class="line">	<span class="comment">// to deliver the onUserLeaving callback to the actual frontmost</span></div><div class="line">	<span class="comment">// activity</span></div><div class="line">	<span class="keyword">if</span> (task == r.task &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</div><div class="line">		mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (DEBUG_USER_LEAVING) Slog.v(TAG_USER_LEAVING,</div><div class="line">				<span class="string">"startActivity() behind front, mUserLeaving=false"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	task = r.task;</div><div class="line"></div><div class="line">	<span class="comment">// Slot the activity into the history stack and proceed</span></div><div class="line">	<span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to stack to task "</span> + task,</div><div class="line">			<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">	task.addActivityToTop(r);</div><div class="line">	task.setFrontOfTask();</div><div class="line"></div><div class="line">	r.putInHistory();</div><div class="line">	<span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// We want to show the starting preview window if we are</span></div><div class="line">		<span class="comment">// switching to a new task, or the next activity's process is</span></div><div class="line">		<span class="comment">// not currently running.</span></div><div class="line">		<span class="keyword">boolean</span> showStartingIcon = newTask;</div><div class="line">		ProcessRecord proc = r.app;</div><div class="line">		<span class="keyword">if</span> (proc == <span class="keyword">null</span>) &#123;</div><div class="line">			proc = mService.mProcessNames.get(r.processName, r.info.applicationInfo.uid);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.thread == <span class="keyword">null</span>) &#123;</div><div class="line">			showStartingIcon = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</div><div class="line">				<span class="string">"Prepare open transition: starting "</span> + r);</div><div class="line">		<span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</div><div class="line">			mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, keepCurTransition);</div><div class="line">			mNoAnimActivities.add(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mWindowManager.prepareAppTransition(newTask</div><div class="line">					? r.mLaunchTaskBehind</div><div class="line">							? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">							: AppTransition.TRANSIT_TASK_OPEN</div><div class="line">					: AppTransition.TRANSIT_ACTIVITY_OPEN, keepCurTransition);</div><div class="line">			mNoAnimActivities.remove(r);</div><div class="line">		&#125;</div><div class="line">		mWindowManager.addAppToken(task.mActivities.indexOf(r),</div><div class="line">				r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">				(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">				r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">		<span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">if</span> (newTask) &#123;</div><div class="line">			<span class="comment">// Even though this activity is starting fresh, we still need</span></div><div class="line">			<span class="comment">// to reset it to make sure we apply affinities to move any</span></div><div class="line">			<span class="comment">// existing activities from other tasks in to it.</span></div><div class="line">			<span class="comment">// If the caller has requested that the target task be</span></div><div class="line">			<span class="comment">// reset, then do so.</span></div><div class="line">			<span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">				resetTaskIfNeededLocked(r, r);</div><div class="line">				doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</div><div class="line">				== ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</div><div class="line">			doShow = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</div><div class="line">			<span class="comment">// Don't do a starting window for mLaunchTaskBehind. More importantly make sure we</span></div><div class="line">			<span class="comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span></div><div class="line">			mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line">			ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</div><div class="line">			<span class="comment">// Figure out if we are transitioning from another activity that is</span></div><div class="line">			<span class="comment">// "has the same starting icon" as the next one.  This allows the</span></div><div class="line">			<span class="comment">// window manager to keep the previous window it had previously</span></div><div class="line">			<span class="comment">// created, if it still had one.</span></div><div class="line">			ActivityRecord prev = mResumedActivity;</div><div class="line">			<span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// We don't want to reuse the previous starting preview if:</span></div><div class="line">				<span class="comment">// (1) The current activity is in a different task.</span></div><div class="line">				<span class="keyword">if</span> (prev.task != r.task) &#123;</div><div class="line">					prev = <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// (2) The current activity is already displayed.</span></div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</div><div class="line">					prev = <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			mWindowManager.setAppStartingWindow(</div><div class="line">					r.appToken, r.packageName, r.theme,</div><div class="line">					mService.compatibilityInfoForPackageLocked(</div><div class="line">							r.info.applicationInfo), r.nonLocalizedLabel,</div><div class="line">					r.labelRes, r.icon, r.logo, r.windowFlags,</div><div class="line">					prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</div><div class="line">			r.mStartingWindowShown = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// If this is the first activity, don't do any fancy animations,</span></div><div class="line">		<span class="comment">// because there is nothing for it to animate on top of.</span></div><div class="line">		mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">				r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">				(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">				r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		options = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">		validateAppTokensLocked();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (doResume) &#123;</div><div class="line">		mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 在Android应用程序框架层中，是由ActivityManagerService组件负责为Android应用程序创建新的进程的，它本来也是运行在一个独立的进程之中，不过这个进程是在系统启动的过程中创建的。<br> ActivityManagerService组件一般会在什么情况下会为应用程序创建一个新的进程呢？当系统决定要在一个新的进程中启动一个Activity或者Service时，它就会创建一个新的进程了，<br> 然后在这个新的进程中启动这个Activity或者Service</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Activity启动过程/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>