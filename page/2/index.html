<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/2/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200">
  
  <link rel="stylesheet" type="text/css" href="/./main.04d600.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=270 src="//music.163.com/outchain/player?type=0&id=120897804&auto=1&height=430"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友情</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 100%"><a href="/">主页</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-Android Touch事件分发详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android Touch事件分发详解/">Android Touch事件分发详解</a>
    </h1>
  

        
        <a href="/2015/01/01/Android Touch事件分发详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Touch事件分发详解"><a href="#Android-Touch事件分发详解" class="headerlink" title="Android Touch事件分发详解"></a>Android Touch事件分发详解</h1><p>先说一些基本的知识，方便后面分析源码时能更好理解。</p>
<ul>
<li><p>所有<code>Touch</code>事件都被封装成<code>MotionEvent</code>对象，包括<code>Touch</code>的位置、历史记录、第几个手指等.</p>
</li>
<li><p>事件类型分为<code>ACTION_DOWN</code>,<code>ACTION_UP</code>,<code>ACTION_MOVE</code>,<code>ACTION_POINTER_DOWN</code>,<code>ACTION_POINTER_UP</code>,<code>ACTION_CANCEL</code>, 每个<br>一个完整的事件以<code>ACTION_DOWN</code>开始<code>ACTION_UP</code>结束，并且<code>ACTION_CANCEL</code>只能由代码引起.一般对于<code>CANCEL</code>的处理和<code>UP</code>的相同。<br><code>CANCEL</code>的一个简单例子：手指在移动的过程中突然移动到了边界外，那么这时<code>ACTION_UP</code>事件了，所以这是的<code>CANCEL</code>和<code>UP</code>的处理是一致的。</p>
</li>
<li><p>事件的处理分别为<code>dispatchTouchEveent()</code>分发事件(<code>TextView</code>等这种最小的<code>View</code>中不会有该方式)、<code>onInterceptTouchEvent()</code>拦截事件(<code>ViewGroup</code>中拦截事件)、<code>onTouchEvent()</code>消费事件.</p>
</li>
<li><p>事件从<code>Activity.dispatchTouchEveent()</code>开始传递，只要没有停止拦截，就会从最上层(<code>ViewGroup</code>)开始一直往下传递，子<code>View</code>通过<code>onTouchEvent()</code>消费事件。(隧道式向下分发).</p>
</li>
<li><p>如果时间从上往下一直传递到最底层的子<code>View</code>，但是该<code>View</code>没有消费该事件，那么该事件会反序网上传递(从该<code>View</code>传递给自己的<code>ViewGroup</code>，然后再传给更上层的<code>ViewGroup</code>直至传递给<code>Activity.onTouchEvent()</code>).<br>(冒泡式向上处理).</p>
</li>
<li><p>如果<code>View</code>没有消费<code>ACTION_DOWN</code>事件，之后其他的<code>MOVE</code>、<code>UP</code>等事件都不会传递过来.</p>
</li>
<li><p>事件由父<code>View(ViewGroup)</code>传递给子<code>View</code>,<code>ViewGroup</code>可以通过<code>onInterceptTouchEvent()</code>方法对事件进行拦截，停止其往下传递，如果拦截(返回<code>true</code>)后该事件<br>会直接走到该<code>ViewGroup</code>中的<code>onTouchEvent()</code>中，不会再往下传递给子<code>View</code>.如果从<code>DOWN</code>开始，之后的<code>MOVE</code>、<code>UP</code>都会直接在该<code>ViewGroup.onTouchEvent()</code>中进行处理。<br>如果子<code>View</code>之前在处理某个事件，但是后续被<code>ViewGroup</code>拦截，那么子<code>View</code>会接收到<code>ACTION_CANCEL</code>.</p>
</li>
<li><p><code>OnTouchListener</code>优先于<code>onTouchEvent()</code>对事件进行消费。</p>
</li>
<li><p><code>TouchTarget</code>是保存手指点击区域属性的一个类，手指的所有移动过程都会被它记录下来, 包含被<code>touch</code>的<code>View</code>。  </p>
</li>
</ul>
<p>废话不多说，直接上源码，源码妥妥的是最新版5.0：<br>我们先从<code>Activity.dispatchTouchEveent()</code>说起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called to process touch screen events.  You can override this to</div><div class="line"> * intercept all touch screen events before they are dispatched to the</div><div class="line"> * window.  Be sure to call this implementation for touch screen events</div><div class="line"> * that should be handled normally.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> ev The touch screen event.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> boolean Return true if this event was consumed.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		onUserInteraction();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码一看能感觉出来<code>DOWN</code>事件比较特殊。我们继续走到<code>onUserInteraction()</code>代码中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called whenever a key, touch, or trackball event is dispatched to the</div><div class="line"> * activity.  Implement this method if you wish to know that the user has</div><div class="line"> * interacted with the device in some way while your activity is running.</div><div class="line"> * This callback and &#123;<span class="doctag">@link</span> #onUserLeaveHint&#125; are intended to help</div><div class="line"> * activities manage status bar notifications intelligently; specifically,</div><div class="line"> * for helping activities determine the proper time to cancel a notfication.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;All calls to your activity's &#123;<span class="doctag">@link</span> #onUserLeaveHint&#125; callback will</div><div class="line"> * be accompanied by calls to &#123;<span class="doctag">@link</span> #onUserInteraction&#125;.  This</div><div class="line"> * ensures that your activity will be told of relevant user activity such</div><div class="line"> * as pulling down the notification pane and touching an item there.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this callback will be invoked for the touch down action</div><div class="line"> * that begins a touch gesture, but may not be invoked for the touch-moved</div><div class="line"> * and touch-up actions that follow.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onUserLeaveHint()</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserInteraction</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是该方法是空方法，没有具体实现。 我们往下看<code>getWindow().superDispatchTouchEvent(ev)</code>.<br><code>getWindow()</code>获取到当前<code>Window</code>对象，表示顶层窗口，管理界面的显示和事件的响应；每个Activity 均会创建一个PhoneWindow对象，<br>是Activity和整个View系统交互的接口，但是该类是一个抽象类。<br>从文档中可以看到<code>The only existing implementation of this abstract class is android.policy.PhoneWindow, which you should instantiate when needing a Window.</code>，<br>所以我们找到<code>PhoneWindow</code>类，查看它的<code>superDispatchTouchEvent()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>该方法又是调用了<code>mDecor.superDispatchTouchEvent(event)</code>, <code>mDecor</code>是什么呢？ 从名字中我们大概也能猜出来是当前窗口最顶层的<code>DecorView</code>，<br><code>Window</code>界面的最顶层的<code>View</code>对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is the top-level view of the window, containing the window decor.</span></div><div class="line"><span class="keyword">private</span> DecorView mDecor;</div></pre></td></tr></table></figure></p>
<p>讲到这里不妨就提一下<code>DecorView</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它集成子<code>FrameLayout</code>所有很多时候我们在用布局工具查看的时候发现<code>Activity</code>的布局<code>FrameLayout</code>的。就是这个原因。<br>好了，我们接着看<code>DecorView</code>中的<code>superDispatchTouchEvent()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是调用了<code>super.dispatchTouchEveent()</code>，而<code>DecorView</code>的父类是<code>FrameLayout</code>所以我们找到<code>FrameLayout.dispatchTouchEveent()</code>.<br>我们看到<code>FrameLayout</code>中没有重写<code>dispatchTouchEveent()</code>方法，所以我们再找到<code>FrameLayout</code>的父类<code>ViewGroup</code>.看<code>ViewGroup.dispatchTouchEveent()</code>实现。<br>新大陆浮现了…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// Consistency verifier for debugging purposes.是调试使用的，我们不用管这里了。</span></div><div class="line">	<span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onTouchEvent(ev, <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">// onFilterTouchEventForSecurity()用安全机制来过滤触摸事件，true为不过滤分发下去，false则销毁掉该事件。</span></div><div class="line">	<span class="comment">// 方法具体实现是去判断是否被其它窗口遮挡住了，如果遮挡住就要过滤掉该事件。</span></div><div class="line">	<span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">		<span class="comment">// 没有被其它窗口遮住</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</div><div class="line"></div><div class="line">		<span class="comment">// 下面这一块注释说的很清楚了，就是在`Down`的时候把所有的状态都重置，作为一个新事件的开始。</span></div><div class="line">		<span class="comment">// Handle an initial down.</span></div><div class="line">		<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">			<span class="comment">// Throw away all previous state when starting a new touch gesture.</span></div><div class="line">			<span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></div><div class="line">			<span class="comment">// due to an app switch, ANR, or some other state change.</span></div><div class="line">			cancelAndClearTouchTargets(ev);</div><div class="line">			resetTouchState();</div><div class="line">			<span class="comment">// 如果是`Down`，那么`mFirstTouchTarget`到这里肯定是`null`.因为是新一系列手势的开始。</span></div><div class="line">			<span class="comment">// `mFirstTouchTarget`是处理第一个事件的目标。</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 检查是否拦截该事件(如果`onInterceptTouchEvent()`返回true就拦截该事件)</span></div><div class="line">		<span class="comment">// Check for interception.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line">		<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">				|| mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 标记事件不允许被拦截， 默认是`false`， 该值可以通过`requestDisallowInterceptTouchEvent(true)`方法来设置，</span></div><div class="line">			<span class="comment">// 通知父`View`不要拦截该`View`上的事件。</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line">				<span class="comment">// 判断该`ViewGroup`是否要拦截该事件。`onInterceptTouchEvent()`方法默认返回`false`即不拦截。</span></div><div class="line">				intercepted = onInterceptTouchEvent(ev);</div><div class="line">				ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// 子`View`通知父`View`不要拦截。这样就不会走到上面`onInterceptTouchEvent()`方法中了，</span></div><div class="line">				<span class="comment">// 所以父`View`就不会拦截该事件。</span></div><div class="line">				intercepted = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 注释比较清楚了，就是没有目标来处理该事件，而且也不是一个新的事件`Down`事件(新事件的开始), </span></div><div class="line">			<span class="comment">// 我们应该拦截下他。</span></div><div class="line">			<span class="comment">// There are no touch targets and this action is not an initial down</span></div><div class="line">			<span class="comment">// so this view group continues to intercept touches.</span></div><div class="line">			intercepted = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Check for cancelation.检查当前是否是`Cancel`事件或者是有`Cancel`标记。</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</div><div class="line">				|| actionMasked == MotionEvent.ACTION_CANCEL;</div><div class="line"></div><div class="line">		<span class="comment">// Update list of touch targets for pointer down, if needed. 这行代码为是否需要将当前的触摸事件分发给多个子`View`，</span></div><div class="line">		<span class="comment">// 默认为`true`，分发给多个`View`（比如几个子`View`位置重叠）。默认是true</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 保存当前要分发给的目标</span></div><div class="line">		TouchTarget newTouchTarget = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 如果没取消也不拦截，进入方法内部</span></div><div class="line">		<span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line">		</div><div class="line">			<span class="comment">// 下面这部分代码的意思其实就是找到该事件位置下的`View`(可见或者是在动画中的View), 并且与`pointID`关联。</span></div><div class="line">			<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">					|| (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</div><div class="line">					|| actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</div><div class="line">						: TouchTarget.ALL_POINTER_IDS;</div><div class="line"></div><div class="line">				<span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></div><div class="line">				<span class="comment">// have become out of sync.</span></div><div class="line">				removePointersFromTouchTargets(idBitsToAssign);</div><div class="line"></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">					<span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line">					<span class="comment">// Find a child that can receive the event.</span></div><div class="line">					<span class="comment">// Scan children from front to back.</span></div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</div><div class="line">					<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">							&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">					<span class="comment">// 遍历找子`View`进行分发了。</span></div><div class="line">					<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</div><div class="line">								? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">						<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">								? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">								</div><div class="line">						<span class="comment">// `canViewReceivePointerEvents()`方法会去判断这个`View`是否可见或者在播放动画，</span></div><div class="line">						<span class="comment">// 只有这两种情况下可以接受事件的分发</span></div><div class="line">						</div><div class="line">						<span class="comment">// `isTransformedTouchPointInView`判断这个事件的坐标值是否在该`View`内。</span></div><div class="line">						<span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line">								|| !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line">							<span class="keyword">continue</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="comment">// 找到该`View`对应的在`mFristTouchTarget`中的存储的目标， 判断这个`View`可能已经不是之前`mFristTouchTarget`中的`View`了。</span></div><div class="line">						<span class="comment">// 如果找不到就返回null, 这种情况是用于多点触摸， 比如在同一个`View`上按下了多跟手指。</span></div><div class="line">						newTouchTarget = getTouchTarget(child);</div><div class="line">						<span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Child View已经接受了这个事件了</span></div><div class="line">							<span class="comment">// Child is already receiving touch within its bounds.</span></div><div class="line">							<span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></div><div class="line">							newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">							<span class="comment">// 找到该View了，不用再循环找了</span></div><div class="line">							<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						resetCancelNextUpFlag(child);</div><div class="line">						<span class="comment">// 如果上面没有break，只有newTouchTarget为null，说明上面我们找到的Child View和之前的肯定不是同一个了， </span></div><div class="line">						<span class="comment">// 是新增的， 比如多点触摸的时候，一个手指按在了这个`View`上，另一个手指按在了另一个`View`上。</span></div><div class="line">						<span class="comment">// 这时候我们就看child是否分发该事件。dispatchTransformedTouchEvent如果child为null，就直接该ViewGroup出来事件</span></div><div class="line">						<span class="comment">// 如果child不为null，就调用child.dispatchTouchEvent</span></div><div class="line">						<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">							<span class="comment">// 如果这个Child View能分发，那我们就要把之前存储的值改变成现在的Child View。</span></div><div class="line">							<span class="comment">// Child wants to receive touch within its bounds.</span></div><div class="line">							mLastTouchDownTime = ev.getDownTime();</div><div class="line">							<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</div><div class="line">								<span class="comment">// childIndex points into presorted list, find original index</span></div><div class="line">								<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</div><div class="line">									<span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</div><div class="line">										mLastTouchDownIndex = j;</div><div class="line">										<span class="keyword">break</span>;</div><div class="line">									&#125;</div><div class="line">								&#125;</div><div class="line">							&#125; <span class="keyword">else</span> &#123;</div><div class="line">								mLastTouchDownIndex = childIndex;</div><div class="line">							&#125;</div><div class="line">							mLastTouchDownX = ev.getX();</div><div class="line">							mLastTouchDownY = ev.getY();</div><div class="line">							<span class="comment">// 赋值成现在的Child View对应的值，并且会把`mFirstTouchTarget`也改成该值(mFristTouchTarget`与`newTouchTarget`是一样的)。</span></div><div class="line">							newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">							<span class="comment">// 分发给子`View`了，不用再继续循环了</span></div><div class="line">							alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line">							<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// `newTouchTarget == null`就是没有找到新的可以分发该事件的子`View`，那我们只能用上一次的分发对象了。</span></div><div class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Did not find a child to receive the event.</span></div><div class="line">					<span class="comment">// Assign the pointer to the least recently added target.</span></div><div class="line">					newTouchTarget = mFirstTouchTarget;</div><div class="line">					<span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</div><div class="line">						newTouchTarget = newTouchTarget.next;</div><div class="line">					&#125;</div><div class="line">					newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// DOWN事件在上面会去找touch target</span></div><div class="line">		<span class="comment">// Dispatch to touch targets.</span></div><div class="line">		<span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// dispatchTransformedTouchEvent方法中如果child为null，那么就调用super.dispatchTouchEvent(transformedEvent);否则调用child.dispatchTouchEvent(transformedEvent)。</span></div><div class="line">			<span class="comment">// `super.dispatchTouchEvent()`也就是说，此时`Viewgroup`处理`touch`消息跟普通`view`一致。普通`View`类内部会调用`onTouchEvent()`方法</span></div><div class="line">			<span class="comment">// No touch targets so treat this as an ordinary view. 自己处理</span></div><div class="line">			handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</div><div class="line">					TouchTarget.ALL_POINTER_IDS);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 分发</span></div><div class="line">			<span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></div><div class="line">			<span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></div><div class="line">			TouchTarget predecessor = <span class="keyword">null</span>;</div><div class="line">			TouchTarget target = mFirstTouchTarget;</div><div class="line">			<span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> TouchTarget next = target.next;</div><div class="line">				<span class="comment">// 找到了新的子`View`，并且这个是新加的对象，上面已经处理过了。</span></div><div class="line">				<span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">					handled = <span class="keyword">true</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// 否则都调用dispatchTransformedTouchEvent处理，传递给child</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</div><div class="line">							|| intercepted;</div><div class="line">							</div><div class="line">					<span class="comment">// 正常分发</span></div><div class="line">					<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">							target.child, target.pointerIdBits)) &#123;</div><div class="line">						handled = <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">					<span class="comment">// 如果是onInterceptTouchEvent返回true就会遍历mFirstTouchTarget全部给销毁，这就是为什么onInterceptTouchEvent返回true，之后所有的时间都不会再继续分发的了。</span></div><div class="line">					<span class="keyword">if</span> (cancelChild) &#123;</div><div class="line">						<span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</div><div class="line">							mFirstTouchTarget = next;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							predecessor.next = next;</div><div class="line">						&#125;</div><div class="line">						target.recycle();</div><div class="line">						target = next;</div><div class="line">						<span class="keyword">continue</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				predecessor = target;</div><div class="line">				target = next;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Update list of touch targets for pointer up or cancel, if needed.</span></div><div class="line">		<span class="keyword">if</span> (canceled</div><div class="line">				|| actionMasked == MotionEvent.ACTION_UP</div><div class="line">				|| actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">			resetTouchState();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</div><div class="line">			<span class="comment">// 当某个手指抬起的时候，清除他相关的数据。</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> idBitsToRemove = <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex);</div><div class="line">			removePointersFromTouchTargets(idBitsToRemove);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div><div class="line">```   </div><div class="line"></div><div class="line">接下来还要说说`dispatchTransformedTouchEvent()`方法，虽然上面也说了大体功能，但是看一下源码能说明另一个问题：   </div><div class="line">```java</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Transforms a motion event into the coordinate space of a particular child view,</div><div class="line"> * filters out irrelevant pointer ids, and overrides its action if necessary.</div><div class="line"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></div><div class="line">		View child, <span class="keyword">int</span> desiredPointerIdBits) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> handled;</div><div class="line"></div><div class="line">	<span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></div><div class="line">	<span class="comment">// or filtering.  The important part is the action, not the contents.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</div><div class="line">	</div><div class="line">	<span class="comment">// 这就是为什么时间被拦截之后，之前处理过该事件的`View`会收到`CANCEL`.</span></div><div class="line">	<span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</div><div class="line">		event.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">		<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">			handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 子`View`去处理，如果子`View`仍然是`ViewGroup`那还是同样的处理，如果子`View`是普通`View`，普通`View`的`dispatchTouchEveent()`会调用`onTouchEvent()`.</span></div><div class="line">			handled = child.dispatchTouchEvent(event);</div><div class="line">		&#125;</div><div class="line">		event.setAction(oldAction);</div><div class="line">		<span class="keyword">return</span> handled;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Calculate the number of pointers to deliver.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> oldPointerIdBits = event.getPointerIdBits();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</div><div class="line"></div><div class="line">	<span class="comment">// If for some reason we ended up in an inconsistent state where it looks like we</span></div><div class="line">	<span class="comment">// might produce a motion event with no pointers in it, then drop the event.</span></div><div class="line">	<span class="keyword">if</span> (newPointerIdBits == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// If the number of pointers is the same and we don't need to perform any fancy</span></div><div class="line">	<span class="comment">// irreversible transformations, then we can reuse the motion event for this</span></div><div class="line">	<span class="comment">// dispatch as long as we are careful to revert any changes we make.</span></div><div class="line">	<span class="comment">// Otherwise we need to make a copy.</span></div><div class="line">	<span class="keyword">final</span> MotionEvent transformedEvent;</div><div class="line">	<span class="keyword">if</span> (newPointerIdBits == oldPointerIdBits) &#123;</div><div class="line">		<span class="keyword">if</span> (child == <span class="keyword">null</span> || child.hasIdentityMatrix()) &#123;</div><div class="line">			<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">				handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</div><div class="line">				event.offsetLocation(offsetX, offsetY);</div><div class="line"></div><div class="line">				handled = child.dispatchTouchEvent(event);</div><div class="line"></div><div class="line">				event.offsetLocation(-offsetX, -offsetY);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> handled;</div><div class="line">		&#125;</div><div class="line">		transformedEvent = MotionEvent.obtain(event);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		transformedEvent = event.split(newPointerIdBits);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Perform any necessary transformations and dispatch.</span></div><div class="line">	<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">		handled = <span class="keyword">super</span>.dispatchTouchEvent(transformedEvent);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</div><div class="line">		transformedEvent.offsetLocation(offsetX, offsetY);</div><div class="line">		<span class="keyword">if</span> (! child.hasIdentityMatrix()) &#123;</div><div class="line">			transformedEvent.transform(child.getInverseMatrix());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		handled = child.dispatchTouchEvent(transformedEvent);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Done.</span></div><div class="line">	transformedEvent.recycle();</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲了<code>ViewGroup</code>的<code>dispatchTouchEveent()</code>有些地方会调用<code>super.dispatchTouchEveent()</code>，而<code>ViewGroup</code>的父类就是<code>View</code>，接下来我们看一下<code>View.dispatchTouchEveent()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Pass the touch screen motion event down to the target view, or this</div><div class="line"> * view if it is the target.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> event The motion event to be dispatched.</div><div class="line"> * <span class="doctag">@return</span> True if the event was handled by the view, false otherwise.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">// 调试用</span></div><div class="line">	<span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		<span class="comment">// Defensive cleanup for new gesture</span></div><div class="line">		stopNestedScroll();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 判断该`View`是否被其它`View`遮盖住。</span></div><div class="line">	<span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">		<span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line">				&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">				&amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">			<span class="comment">// 先执行`listener`.</span></div><div class="line">			result = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">			<span class="comment">// 执行`onTouchEvent()`.</span></div><div class="line">			result = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></div><div class="line">	<span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span></div><div class="line">	<span class="comment">// of the gesture.</span></div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||</div><div class="line">			actionMasked == MotionEvent.ACTION_CANCEL ||</div><div class="line">			(actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</div><div class="line">		stopNestedScroll();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过上面的分析我们看到<code>View.dispatchTouchEvent()</code>里面会调用到<code>onTouchEvent()</code>来消耗事件。那么<code>onTouchEvent()</code>是如何处理的呢？下面我们看一下<br><code>View.onTouchEvent()</code>源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this method to handle touch screen motion events.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is used to detect click actions, it is recommended that</div><div class="line"> * the actions be performed by implementing and calling</div><div class="line"> * &#123;<span class="doctag">@link</span> #performClick()&#125;. This will ensure consistent system behavior,</div><div class="line"> * including:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> * &lt;li&gt;obeying click sound preferences</div><div class="line"> * &lt;li&gt;dispatching OnClickListener calls</div><div class="line"> * &lt;li&gt;handling &#123;<span class="doctag">@link</span> AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</div><div class="line"> * accessibility features are enabled</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> event The motion event.</div><div class="line"> * <span class="doctag">@return</span> True if the event was handled, false otherwise.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line"></div><div class="line">	<span class="comment">// 对disable按钮的处理，注释说的比较明白，一个disable但是clickable的view仍然会消耗事件,只是不响应而已。</span></div><div class="line">	<span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">		<span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">			setPressed(<span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">		<span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">		<span class="keyword">return</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">				(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 关于TouchDelegate,文档中是这样说的The delegate to handle touch events that are physically in this view</span></div><div class="line">    <span class="comment">// but should be handled by another view. 就是说如果两个View, View2在View1中，View1比较大，如果我们想点击</span></div><div class="line">	<span class="comment">// View1的时候，让View2去响应点击事件，这时候就需要使用TouchDelegate来设置。</span></div><div class="line">	<span class="comment">// 简单的理解就是如果这个View有自己的时间委托处理人，就交给委托人处理。</span></div><div class="line">	<span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">			(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)) &#123;</div><div class="line">	    <span class="comment">// 这个View可点击</span></div><div class="line">		<span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">			    <span class="comment">// 最好先看DOWN后再看MOVE最后看UP。</span></div><div class="line">				<span class="comment">// PFLAG_PREPRESSED 表示在一个可滚动的容器中,要稍后才能确定是按下还是滚动.</span></div><div class="line">                <span class="comment">// PFLAG_PRESSED 表示不是在一个可滚动的容器中,已经可以确定按下这一操作.</span></div><div class="line">				<span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</div><div class="line">				<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</div><div class="line">					<span class="comment">// 处理点击或长按事件</span></div><div class="line">					<span class="comment">// take focus if we don't have it already and we should in</span></div><div class="line">					<span class="comment">// touch mode.</span></div><div class="line">					<span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</div><div class="line">					<span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) </div><div class="line">						<span class="comment">// 如果现在还没获取到焦点，就再获取一次焦点</span></div><div class="line">						focusTaken = requestFocus();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">// 在前面`DOWN`事件的时候会延迟显示`View`的`pressed`状态,用户可能在我们还没有显示按下状态效果时就不按了.我们还是得在进行实际的点击操作时,让用户看到效果。</span></div><div class="line">					<span class="keyword">if</span> (prepressed) &#123;</div><div class="line">						<span class="comment">// The button is being released before we actually</span></div><div class="line">						<span class="comment">// showed it as pressed.  Make it show the pressed</span></div><div class="line">						<span class="comment">// state now (before scheduling the click) to ensure</span></div><div class="line">						<span class="comment">// the user sees it.</span></div><div class="line">						setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">				   &#125;</div><div class="line">					</div><div class="line">					</div><div class="line">					<span class="keyword">if</span> (!mHasPerformedLongPress) &#123;</div><div class="line">						<span class="comment">// 判断不是长按</span></div><div class="line">						</div><div class="line">						<span class="comment">// This is a tap, so remove the longpress check</span></div><div class="line">						removeLongPressCallback();</div><div class="line"></div><div class="line">						<span class="comment">// Only perform take click actions if we were in the pressed state</span></div><div class="line">						<span class="keyword">if</span> (!focusTaken) &#123;</div><div class="line">							<span class="comment">// Use a Runnable and post this rather than calling</span></div><div class="line">							<span class="comment">// performClick directly. This lets other visual state</span></div><div class="line">							<span class="comment">// of the view update before click actions start.</span></div><div class="line">							<span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</div><div class="line">								mPerformClick = <span class="keyword">new</span> PerformClick();</div><div class="line">							&#125;</div><div class="line">							<span class="comment">// PerformClick就是个Runnable,里面执行performClick()方法。performClick()方法中怎么执行呢？我们在后面再说。</span></div><div class="line">							<span class="keyword">if</span> (!post(mPerformClick)) &#123;</div><div class="line">								performClick();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</div><div class="line">						mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</div><div class="line">					&#125;</div><div class="line">					<span class="comment">// 取消按下状态，UnsetPressedState也是个Runnable,里面执行setPressed(false)</span></div><div class="line">					<span class="keyword">if</span> (prepressed) &#123;</div><div class="line">						postDelayed(mUnsetPressedState,</div><div class="line">								ViewConfiguration.getPressedStateDuration());</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</div><div class="line">						<span class="comment">// If the post failed, unpress right now</span></div><div class="line">						mUnsetPressedState.run();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					removeTapCallback();</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">				mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line">				<span class="comment">// performButtonActionOnTouchDown()处理鼠标右键菜单，有些View显示右键菜单就直接弹菜单.一般设备用不到鼠标，所以返回false。</span></div><div class="line">				<span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// Walk up the hierarchy to determine if we're inside a scrolling container.</span></div><div class="line">				<span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</div><div class="line"></div><div class="line">				<span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></div><div class="line">				<span class="comment">// a short period in case this is a scroll.</span></div><div class="line">				<span class="comment">// 就是遍历下View层级，判断这个View是不是在一个能scroll的View中。</span></div><div class="line">				<span class="keyword">if</span> (isInScrollingContainer) &#123;</div><div class="line">				    <span class="comment">// 因为用户可能是点击或者是滚动，所以我们不能立马判断，先给用户设置一个要点击的事件。</span></div><div class="line">					mPrivateFlags |= PFLAG_PREPRESSED;</div><div class="line">					<span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</div><div class="line">						mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</div><div class="line">					&#125;</div><div class="line">					mPendingCheckForTap.x = event.getX();</div><div class="line">					mPendingCheckForTap.y = event.getY();</div><div class="line">					<span class="comment">// 发送一个延时的操作，用于判断用户到底是点击还是滚动。其实就是在tapTimeout中如果用户没有滚动，那就是点击了。</span></div><div class="line">					postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">				    <span class="comment">// 设置成点击状态</span></div><div class="line">					<span class="comment">// Not inside a scrolling container, so show the feedback right away</span></div><div class="line">					setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">					<span class="comment">// 检查是否是长按，就是过一段时间后如果还在按住，那就是长按了。长按的时间是ViewConfiguration.getLongPressTimeout()</span></div><div class="line">					<span class="comment">// 也就是500毫秒</span></div><div class="line">					checkForLongClick(<span class="number">0</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">				<span class="comment">// 取消按下状态，移动点击消息，移动长按消息。</span></div><div class="line">				setPressed(<span class="keyword">false</span>);</div><div class="line">				removeTapCallback();</div><div class="line">				removeLongPressCallback();</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">				drawableHotspotChanged(x, y);</div><div class="line">				</div><div class="line">				<span class="comment">// Be lenient about moving outside of buttons， 检查是否移动到View外面了。</span></div><div class="line">				<span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">				    <span class="comment">// 移动到区域外面去了，就要取消点击。</span></div><div class="line">					<span class="comment">// Outside button</span></div><div class="line">					removeTapCallback();</div><div class="line">					<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">						<span class="comment">// Remove any future long press/tap checks</span></div><div class="line">						removeLongPressCallback();</div><div class="line"></div><div class="line">						setPressed(<span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲了<code>Touch</code>事件的分发和处理，随便说一下点击事件:<br>我们平时使用的时候都知道给<code>View</code>设置点击事件是<code>setOnClickListener()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Register a callback to be invoked when this view is clicked. If this view is not</div><div class="line"> * clickable, it becomes clickable.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l The callback that will run</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #setClickable(boolean)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(OnClickListener l)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!isClickable()) &#123;</div><div class="line">		setClickable(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// `getListenerInfo()`就是判断成员变量`mListenerInfo`是否是null，不是就返回，是的话就初始化一个。</span></div><div class="line">	getListenerInfo().mOnClickListener = l;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那什么地方会调用<code>mListenerInfo.mOnClickListener</code>呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Call this view's OnClickListener, if it is defined.  Performs all normal</div><div class="line"> * actions associated with clicking: reporting accessibility event, playing</div><div class="line"> * a sound, etc.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> True there was an assigned OnClickListener that was called, false</div><div class="line"> *         otherwise is returned.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> result;</div><div class="line">	<span class="keyword">final</span> ListenerInfo li = mListenerInfo;</div><div class="line">	<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">		playSoundEffect(SoundEffectConstants.CLICK);</div><div class="line">		li.mOnClickListener.onClick(<span class="keyword">this</span>);</div><div class="line">		result = <span class="keyword">true</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		result = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>讲到这里就明白了。<code>onTouchEvent()</code>中的<code>ACTION_UP</code>中会调用<code>performClick()</code>方法。</p>
<p>到这里，就全部分析完了，这一块还是比较麻烦的，中间查了很多资料，有些地方自己可能也理解的不太对，如果有哪里理解的不对的地方，还请大家指出来。谢谢。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android Touch事件分发详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android开发不申请权限来使用对应功能" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android开发不申请权限来使用对应功能/">Android开发不申请权限来使用对应功能</a>
    </h1>
  

        
        <a href="/2015/01/01/Android开发不申请权限来使用对应功能/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android开发不申请权限来使用对应功能"><a href="#Android开发不申请权限来使用对应功能" class="headerlink" title="Android开发不申请权限来使用对应功能"></a>Android开发不申请权限来使用对应功能</h1><p>从用户角度来说很难获取到正确的<code>android</code>权限。通常你只需要做一些很基础的事(例如编辑一个联系人)但实际你申请的权限却远远比这更强大(例如可以获取到所有的联系人明细等)。</p>
<p>这样能很容易的理解到用户会怀疑到你的应用。如果你的应用不是开源的，那他们就没有方法来验证你会不会下载所有的联系人数据并上传到服务器。及时你去解释为什么需要这个权限，但是人们不会相信你。原来我会选择不去使用这些敏感的权限来防止用户产生不信任。(当然很多应用他们申请权限只是为了后台获取你的联系人数据上传- -!以及之前被爆的某宝使用摄像头拍照的问题)</p>
<p>这就是说，有一件事在困扰着我，<strong>如何能在做一些操作时不去申请权限。</strong></p>
<p>打个比方说:<code>android.permission.CALL_PHONE</code>这个权限。你需要它来在应用中拨打电话，是吗？这就是你怎么去实现拨号的吗？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_CALL);</div><div class="line">intent.setData(Uri.parse(<span class="string">"tel:1234567890"</span>))</div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure></p>
<p><strong>错！</strong>，你通过这段代码需要该权限的原因是因为你可以在任何时间在不需要用户操作的情况下打电话。也就是说如果我的应用申请了这个权限，我可以在你不知情的情况下每天凌晨三点去拨打骚扰电话。</p>
<p>正确的方式是使用<code>ACTION_VIEW</code>或者<code>ACTION_DIAL</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_DIAL);</div><div class="line">intent.setData(Uri.parse(<span class="string">"tel:1234567890"</span>))</div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure></p>
<p><strong>这个问题的完美解决方案就是不需要申请权限了。</strong>原因就是你不是直接拨号，而是用指定的号码调起拨号器，仍然需要用户点击”拨号”来开始打电话。老实的说，这样让人感觉更好。</p>
<p>简单的说就是如果我想要的操作不是让用户在应用内点击某个按钮就直接开始拨打电话，而是让用户点击在应用内点击某个按钮是我们去调起拨号程序，并且显示指定号码，让用户在拨号器中点击拨号后再开始拨打电话。这样的话我们就完全不用申请拨号权限了。</p>
<p>另一个例子: 我想获取某一个联系人的号码，你可能会想这需要申请获取所有联系人的权限。这是错的！。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PICK);</div><div class="line">intent.setType(StructuredPostal.CONTENT_TYPE);</div><div class="line">startActivityForResult(intent, <span class="number">1</span>);</div></pre></td></tr></table></figure></p>
<p>我们可以使用上面的代码，来启动联系人管理器，让用户来选择某一个联系人。这样不仅是不需要申请任何权限，也不需要提供任何联系人相关的<code>UI</code>。这样也能完全保证你选择联系人时的体验。</p>
<p><code>Android</code>系统最酷的部分之一就是<code>Intent</code>系统，这意味着我不需要自己来实现所有的东西。应用可以注册处理它所擅长的指定数据，像电话号码、短信或者联系人。如果这些都要自己在一个应用中去实现，那这将会是很大的工作量，也会让应用变得臃肿。</p>
<p><code>Android</code>系统的另一个优势就是你可以使用其他应用申请的权限，而不用自己申请。这样才保证了上面的情况。拨号器需要申请拨打电话的权限，我只需要一个能调起拨号器的<code>Intent</code>就好了。用户信任拨号器拨打电话，而不是我们的应用。他们无论如何都宁愿使用系统的拨号器。</p>
<p>写这篇文章的意义是<strong>在你想要申请一个权限的时候，你需要至少看看<a href="https://developer.android.com/reference/android/content/Intent.html" target="_blank" rel="external">Intent的官方文档</a>看能否请求另外一个应用来帮我们做这些操作。</strong>如果想要深入的研究，可以学习下<a href="https://developer.android.com/guide/topics/security/permissions.html" target="_blank" rel="external">关于权限的详细介绍</a>，这里面包含了很多精细的权限。</p>
<p>使用更少的权限可以不但可以让用户更加信任你，而且可以让用户有一个更好的体验，因为他们仍然在使用他们所期望的应用。</p>
<ol>
<li>遗憾的是，不是一个真实的号码。</li>
<li>不幸的是，<code>Intent</code>系统的属性也建立了<a href="http://css.csail.mit.edu/6.858/2012/projects/ocderby-dennisw-kcasteel.pdf" target="_blank" rel="external">可能会被滥用的漏洞</a>，但你也不会写一个滥用的应用，是吗？</li>
</ol>
<ul>
<li>(译)<a href="http://blog.danlew.net/2014/11/26/i-dont-need-your-permission/" target="_blank" rel="external">感谢Dan Lew</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android开发不申请权限来使用对应功能/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-ApplicationId vs PackageName" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/ApplicationId vs PackageName/">ApplicationId vs PackageName</a>
    </h1>
  

        
        <a href="/2015/01/01/ApplicationId vs PackageName/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ApplicationId-vs-PackageName"><a href="#ApplicationId-vs-PackageName" class="headerlink" title="ApplicationId vs PackageName"></a>ApplicationId vs PackageName</h1><p>曾几何时，自从转入<code>Studio</code>阵营后就发现多了个<code>applicationId &quot;com.xx.xxx&quot;</code>，虽然知道肯定会有区别，但是我却没有仔细去看，只想着把它和<code>packageName</code>设置成相同即可(原谅我的懒惰- -!)。         </p>
<p>直到今天在官网看<code>Gradle</code>使用时，终于忍不住要搞明白它俩的区别。         </p>
<p>在<code>Android</code>官方文档中有一句是这样描述<code>applicationId</code>的:<code>applicationId : the effective packageName</code>，真是言简意赅，那既然<code>applicationId</code>是有效的包明了，<code>packageName</code>算啥？     </p>
<p>所有<code>Android</code>应用都有一个包名。包名在设备上能唯一的标示一个应用，它在<code>Google Play</code>应用商店中也是唯一的。这就意味着一旦你使用一个包名发布应用后，你就永 远不能改变它的包名；如果你改了包名就会导致你的应用被认为是一个新的应用，并且已经使用你之前应用的用户将不会看到作为更新的新应用包。          </p>
<p>之前的<code>Android Gradle</code>构建系统中，应用的包名是由你的<code>manifest</code>文件中的根元素中的<code>package</code>属性定义的:       </p>
<p><code>AndroidManifest.xml:</code>          </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    package=&quot;com.example.my.app&quot;</div><div class="line">    android:versionCode=&quot;1&quot;</div><div class="line">    android:versionName=&quot;1.0&quot; &gt;</div></pre></td></tr></table></figure>
<p>然而，这里定义的包也有第二个目的：就是被用来命名你的<code>R</code>资源类(以及解析任何与<code>Activities</code>相关的类名)的包。在上面的示例中，生成的<code>R</code>类就是<code>com.example.my.app.R</code>，所以如果你在其他的包中想引用资源，就需要导入<code>com.example.my.app.R</code>。      </p>
<p>伴随着新的<code>Android Gradle</code>构建系统，你可以很简单的为你的应用构建多个不同的版本；例如，你可以同时为你的应用构建一个免费版本和一个专业版(使用<code>flavors</code>)，并且他们应该在<code>Google Play</code>商店中有不同的包，这样才能让他们可以被单独安装和购买，同时安装两个，等等。同样的你也可能同时为你的应用构建<code>debug</code>版、<code>alpha</code>版和<code>beta</code>版(使用<code>build types</code>)，这些也可以同样使用不同的包名。    </p>
<p>在这同时，你在代码中导入的<code>R</code>类必须一直保持一直；在为应用构建不同的版本时<code>.java</code>源文件都不应该发生变化。</p>
<p>因此,我们解耦了<code>package name</code>的两种用法:       </p>
<ul>
<li>在生成的<code>.apk</code>中的<code>manifest</code>文件中使用的最终的包名以及在你的设备和<code>Google Play</code>商店中用来标示你的包名叫做<code>application id</code>的值。</li>
<li>在源代码中指向<code>R</code>类的包名以及在解析任何与<code>activity/service</code>注册相关的包名继续叫做<code>package name</code>。</li>
</ul>
<p>可以在<code>gradle</code>文件中像如下指定<code>application id</code>:  </p>
<p><code>app/build.gradle:</code>         </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 19</div><div class="line">    buildToolsVersion &quot;19.1&quot;</div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId &quot;com.example.my.app&quot;</div><div class="line">        minSdkVersion 15</div><div class="line">        targetSdkVersion 19</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line">    &#125;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>像之前一样，你需要在<code>Manifest</code>文件中指定你在代码中使用的’package name’，像上面<code>AndroidManifest.xml</code>的例子。<br><strong><em>下面进入关键部分了：</em></strong>当你按照上面的方式做完后，这两个包就是相互独立的了。你现在可以很简单的重构你的代码-通过修改<code>Manifest</code>中的包名来修改在你的<code>activitise</code>和<code>services</code>中使用的包和在重构你在代码中的引用声明。这不会影响你应用的最终<code>id</code>，也就是在<code>Gradle</code>文件中的<code>applicationId</code>。       </p>
<p>你可以通过以下<code>Gradle DSL</code>方法为应用的<code>flavors</code>和<code>build types</code>指定不同的<code>applicationId</code>:       </p>
<p><code>app/buid.gradle:</code>      </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">productFlavors &#123;</div><div class="line">    pro &#123;</div><div class="line">        applicationId = &quot;com.example.my.pkg.pro&quot;</div><div class="line">    &#125;</div><div class="line">    free &#123;</div><div class="line">        applicationId = &quot;com.example.my.pkg.free&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">buildTypes &#123;</div><div class="line">    debug &#123;</div><div class="line">        applicationIdSuffix &quot;.debug&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">....</div></pre></td></tr></table></figure>
<p>(在<code>Android Studio</code>中你也可以通过图形化的<code>Project Structure</code>的对话框来更改上面所有的配置)</p>
<p><strong><em>注意:</em></strong>为了兼容性，如果你在<code>build.gradle</code>文件中没有定义<code>applicationId</code> ，那<code>applicationId</code>就是与<code>AndroidManifest.xml</code>中配置的包名相同的默认值。在这种情况下，这两者显然脱不了干系，如果你试图重构代码中的包就将会导致同时会改变你应用程序的<code>id</code>！在<code>Android Studio</code>中新创建的项目都是同时指定他们俩。     </p>
<p><strong><em>注意2:</em></strong><code>package name</code>必须在默认的<code>AndroidManifest.xml</code>文件中指定。如果有多个<code>manifest</code>文件(例如对每个<code>flavor</code>制定一个<code>manifest</code>或者每个<code>build type</code>制定一个<code>manifest</code>)时，<code>package name</code>是可选的，但是如果你指定的话，它必须与主<code>manifest</code>中指定的<code>pakcage</code>相同。</p>
<hr>
<ul>
<li>邮箱 ：charon.chui@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/ApplicationId vs PackageName/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android开发中的MVP模式详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android开发中的MVP模式详解/">Android开发中的MVP模式详解</a>
    </h1>
  

        
        <a href="/2015/01/01/Android开发中的MVP模式详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android开发中的MVP模式详解"><a href="#Android开发中的MVP模式详解" class="headerlink" title="Android开发中的MVP模式详解"></a>Android开发中的MVP模式详解</h1><p><a href="https://github.com/CharonChui/AndroidNote/blob/master/JavaKnowledgePart/MVC%E4%B8%8EMVP%E5%8F%8AMVVM.md">MVC、MVP、MVVM介绍</a></p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/android_mvp.jpg?raw=true" alt="image"></p>
<p>在<code>Android</code>开发中，如果不注重架构的话，<code>Activity</code>类就会变得愈发庞大。这是因为在<code>Android</code>开发中<code>View</code>和其他的线程可以共存于<code>Activity</code>内。那最大的问题是什么呢？ 其实就是<code>Activity</code>中同时存在业务逻辑和<code>UI</code>逻辑。这导致增加了单元测试和维护的成本。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/activity_is_god.png?raw=true" alt="image"></p>
<p>这就是为什么要清晰架构的原因之一。不仅是因为<code>Activity</code>类变得臃肿，也是其他的一些问题，例如<code>Activity</code>和<code>Fragment</code>相结合时的生命周期、数据绑定等等。   </p>
<p>###MVP简介</p>
<p><code>MVP(Model,View,Presenter)</code>      </p>
<ul>
<li><code>View</code>：负责处理用户时间和视图展现。在<code>Android</code>中就可能是<code>Activity</code>或者<code>Fragment</code>。</li>
<li><code>Model</code>： 负责数据访问。数据可以是从接口或者本地数据库中获取。</li>
<li><code>Presenter</code>: 负责连接<code>View</code>和<code>Model</code>。</li>
</ul>
<p>用一句话来说:<code>MVP</code>其实就是面向接口编程，<code>V</code>实现接口，<code>P</code>使用接口。</p>
<p>清晰的架构:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/mvp_a.png?raw=true" alt="image"></p>
<p>举个栗子:<br>在<code>Android Studio</code>中新建一个<code>Activity</code>，系统提供了<code>LoginActivity</code>，直接用它是极好的。    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/loginactivity.png?raw=true" width="50%" height="50%"></p>
<p>不得不说，<code>Material Design</code>的效果真是美美哒！</p>
<p>好，那我们就用用户登录页来按照<code>MVP</code>的模式实现一下:     </p>
<ul>
<li>M: 很显然Model应该是<code>User</code>类。</li>
<li>V: <code>View</code>就是<code>LoginActivity</code>。</li>
<li>P: P那我们一会就创建一个<code>LoginPresenter</code>类。</li>
</ul>
<p>齐了，那接下来就详细分析下他们这三部分:   </p>
<ul>
<li><code>User</code>: 应该有<code>email</code>, <code>password</code>, <code>boolean login(email, password)</code>。</li>
<li><code>LoginActivity</code>:点击登录应该要出<code>loading</code>页。登录成功后要进入下一个页面。如果登录失败应该弹<code>toast</code>提示。那就需要<code>void showLoading()</code>，<code>void hideLoading()</code>，<code>void showErrorTip()</code>,<code>void doLoginSuccess()</code>这四个方法。</li>
<li><code>LoginPresenter</code>:这是<code>Model</code>和<code>View</code>的桥梁。他需要做的处理业务逻辑，直接与<code>Model</code>打交道，然后将<code>UI</code>的逻辑交给<code>LoginActivity</code>处理。<br>那怎么做呢？ 按照我上面总结的那一句话，、<code>MVP</code>其实就是面向接口编程，<code>V</code>实现接口，<code>P</code>使用接口。很显然我们需要提供一个接口。那就新建一个<code>ILoginView</code>的接口。这里面有哪些方法呢？ 当然是上面我们在分析<code>LoginActiity</code>时提出的那四个方法。这样<code>LoginActivity</code>直接实现<code>ILoginView</code>接口就好。</li>
</ul>
<p>开始做:   </p>
<ul>
<li><p>先把<code>Model</code>做好吧，创建<code>User</code>类。  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String email;</div><div class="line">    <span class="keyword">private</span> String password;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String email, String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.email = email;</div><div class="line">        <span class="keyword">this</span>.password = password;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// do login request..</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建<code>ILoginView</code>接口，定义登录所需要的<code>ui</code>逻辑。    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoginView</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showLoading</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hideLoading</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showErrorTip</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doLoginSuccess</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建<code>LoginPresenter</code>类，使用<code>ILoginView</code>接口，那该类主要有什么功能呢？ 它主要是处理业务逻辑的，<br>  对于登录的话，当然是用户在<code>UI</code>页面输入邮箱和密码，然后<code>Presenter</code>去开线程、请求接口。然后得到登录结果再去让<code>UI</code>显示对应的视图。那自然就是有一个<code>void login(String email, String passowrd)</code>的方法了  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ILoginView mLoginView;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenter</span><span class="params">(ILoginView loginView)</span> </span>&#123;</div><div class="line">        mLoginView = loginView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String email, String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(email) || TextUtils.isEmpty(password)) &#123;</div><div class="line">            <span class="comment">//</span></div><div class="line">            mLoginView.showErrorTip();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mLoginView.showLoading();</div><div class="line">        User user = <span class="keyword">new</span> User(email, password);</div><div class="line"></div><div class="line">        <span class="comment">// do network request....</span></div><div class="line">        <span class="comment">// ....</span></div><div class="line">        onSuccess() &#123;</div><div class="line">            <span class="keyword">boolean</span> login = user.login();</div><div class="line">            <span class="keyword">if</span> (login) &#123;</div><div class="line">                mLoginView.doLoginSuccess();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mLoginView.showErrorTip();</div><div class="line">            &#125;</div><div class="line">            mLoginView.hideLoading();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        onFailde() &#123;</div><div class="line">            mLoginView.showErrorTip();</div><div class="line">            mLoginView.hideLoading();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建<code>LoginActivity</code>，实现<code>ILoginView</code>的接口，然后内部调用<code>LoginPresenter</code>来处理业务逻辑。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">ILoginView</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> LoginPresenter mLoginPresenter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> AutoCompleteTextView mEmailView;</div><div class="line">    <span class="keyword">private</span> EditText mPasswordView;</div><div class="line">    <span class="keyword">private</span> View mProgressView;</div><div class="line">    <span class="keyword">private</span> View mLoginButton;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_login);</div><div class="line">        mEmailView = (AutoCompleteTextView) findViewById(R.id.email);</div><div class="line">        mPasswordView = (EditText) findViewById(R.id.password);</div><div class="line">        mLoginButton = findViewById(R.id.email_sign_in_button);</div><div class="line">        mProgressView = findViewById(R.id.login_progress);</div><div class="line"></div><div class="line">        mLoginPresenter = <span class="keyword">new</span> LoginPresenter(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        mLoginButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                mLoginPresenter.login(mEmailView.getText().toString().trim(), mPasswordView.getText().toString().trim());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoading</span><span class="params">()</span> </span>&#123;</div><div class="line">        mProgressView.setVisibility(View.VISIBLE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideLoading</span><span class="params">()</span> </span>&#123;</div><div class="line">        mProgressView.setVisibility(View.GONE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showErrorTip</span><span class="params">()</span> </span>&#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"login faled"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doLoginSuccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"login success"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>上面只是抛砖引玉。<code>MVP</code>的有点十分明显，就是代码解耦、可以让逻辑清晰，但是同样它也会有缺点，它的缺点就是项目的复杂程度会增加，项目中会多出很多类。<br>之前很多人都在讨论该如何去正确的设计使用<code>MVP</code>来避免它的缺点，众说纷纭，很多人讨论的你死我活。直到<code>Google</code>发布了<code>MVP架构蓝图</code>，大家才意识到这才是规范。     </p>
<p>项目地址:<a href="https://github.com/googlesamples/android-architecture">android-architecture</a><br><code>Google</code>将该项目命名为<code>Android</code>的架构蓝图，我想从名字上已可以看穿一切。</p>
<p>在它的官方介绍中是这样说的:   </p>
<blockquote>
<p>The Android framework offers a lot of flexibility when it comes to defining how to organize and architect an Android app. This freedom, whilst very valuable, can also result in apps with large classes, inconsistent naming and architectures (or lack of) that can make testing, maintaining and extending difficult.</p>
<p>Android Architecture Blueprints is meant to demonstrate possible ways to help with these common problems. In this project we offer the same application implemented using different architectural concepts and tools.</p>
<p>You can use these samples as a reference or as a starting point for creating your own apps. The focus here is on code structure, architecture, testing and maintainability. However, bear in mind that there are many ways to build apps with these architectures and tools, depending on your priorities, so these shouldn’t be considered canonical examples. The UI is deliberately kept simple.</p>
</blockquote>
<p>已完成的示例:  </p>
<ul>
<li>todo-mvp/ - Basic Model-View-Presenter architecture.</li>
<li>todo-mvp-loaders/ - Based on todo-mvp, fetches data using Loaders.</li>
<li>todo-mvp-databinding/ - Based on todo-mvp, uses the Data Binding Library.</li>
<li>todo-mvp-clean/ - Based on todo-mvp, uses concepts from Clean Architecture.</li>
<li>todo-mvp-dagger/ - Based on todo-mvp, uses Dagger2 for Dependency Injection</li>
<li>todo-mvp-contentproviders/ - Based on todo-mvp-loaders, fetches data using Loaders and uses Content Providers</li>
<li>todo-mvp-rxjava/ - Based on todo-mvp, uses RxJava for concurrency and data layer abstraction.</li>
</ul>
<p>我们接下来就用<code>todo-mvp</code>来进行分析，这个应用非常简单，主要有以下几个功能:     </p>
<ul>
<li>列表页:展示所有的<code>todo</code>项   </li>
<li>添加页:添加<code>todo</code>项</li>
<li>详情页:查看<code>todo</code>项的详情</li>
<li>统计页:查看当前所有已完成<code>todo</code>及未完成项的统计数据     </li>
</ul>
<p>代码并不多:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/google_mvp.png?raw=true" width="50%" height="50%"></p>
<p>功能也比较简单:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/google_todo_main.png?raw=true" width="40%" height="40%">    <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/google_todp_add.png?raw=true" width="40%" height="40%"><br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/google_todo_list.png?raw=true" width="40%" height="40%">          <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/google_todo_delete.png?raw=true" width="40%" height="40%"></p>
<p>我们先从两个<code>Base</code>类开始看，分别是<code>BaseView</code>以及<code>BasePresenter</code>类。 </p>
<p><code>BaseView</code>类:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseView</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPresenter</span><span class="params">(T presenter)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BaseView</code>中的<code>setPresenter()</code>是将<code>Presenter</code>的实例传入到<code>View</code>中。<br><code>BasePresenter</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BasePresenter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>BasePresenter</code>中只有一个<code>start()</code>方法，从名字上我们就能看出他的作用。 </p>
<p>接下来继续看一下项目的入口<code>Activity</code>，<code>TaskDetailActivity</code>的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskDetailActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_TASK_ID = <span class="string">"TASK_ID"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        setContentView(R.layout.taskdetail_act);</div><div class="line"></div><div class="line">        <span class="comment">// Set up the toolbar.</span></div><div class="line">        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">        setSupportActionBar(toolbar);</div><div class="line">        ActionBar ab = getSupportActionBar();</div><div class="line">        ab.setDisplayHomeAsUpEnabled(<span class="keyword">true</span>);</div><div class="line">        ab.setDisplayShowHomeEnabled(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Get the requested task id</span></div><div class="line">        String taskId = getIntent().getStringExtra(EXTRA_TASK_ID);</div><div class="line">        </div><div class="line">        TaskDetailFragment taskDetailFragment = (TaskDetailFragment) getSupportFragmentManager()</div><div class="line">                .findFragmentById(R.id.contentFrame);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (taskDetailFragment == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 创建对应的Fragment</span></div><div class="line">            taskDetailFragment = TaskDetailFragment.newInstance(taskId);</div><div class="line"></div><div class="line">            ActivityUtils.addFragmentToActivity(getSupportFragmentManager(),</div><div class="line">                    taskDetailFragment, R.id.contentFrame);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Create the presenter，因为Presenter是M和V的连接桥，所以在第二个参数中会传入TasksRepository</span></div><div class="line">        <span class="keyword">new</span> TaskDetailPresenter(</div><div class="line">                taskId,</div><div class="line">                Injection.provideTasksRepository(getApplicationContext()),</div><div class="line">                taskDetailFragment);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSupportNavigateUp</span><span class="params">()</span> </span>&#123;</div><div class="line">        onBackPressed();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里<code>Activity</code>相当于一个管理类，里面控制着<code>MVP</code>中的<code>V</code>和<code>P</code>,上面的代码主要做了两部分:  </p>
<ul>
<li>创建对应的<code>Fragment</code></li>
<li>创建对应的<code>Presenter</code></li>
</ul>
<p>这里分别看一下<code>TaskDetailFragment</code>和<code>TaskDetailPresenter</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskDetailFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">TaskDetailContract</span>.<span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> TaskDetailContract.Presenter mPresenter;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TaskDetailFragment <span class="title">newInstance</span><span class="params">(@Nullable String taskId)</span> </span>&#123;</div><div class="line">        Bundle arguments = <span class="keyword">new</span> Bundle();</div><div class="line">        arguments.putString(ARGUMENT_TASK_ID, taskId);</div><div class="line">        TaskDetailFragment fragment = <span class="keyword">new</span> TaskDetailFragment();</div><div class="line">        fragment.setArguments(arguments);</div><div class="line">        <span class="keyword">return</span> fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        <span class="comment">// 调用Presenter.start()方法</span></div><div class="line">        mPresenter.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">                             Bundle savedInstanceState) &#123;</div><div class="line">        ....</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPresenter</span><span class="params">(@NonNull TaskDetailContract.Presenter presenter)</span> </span>&#123;</div><div class="line">        <span class="comment">// 将Prsenter传递给V中 </span></div><div class="line">        mPresenter = checkNotNull(presenter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>及<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskDetailPresenter</span> <span class="keyword">implements</span> <span class="title">TaskDetailContract</span>.<span class="title">Presenter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TasksRepository mTasksRepository;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskDetailContract.View mTaskDetailView;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">private</span> String mTaskId;</div><div class="line"></div><div class="line">    <span class="comment">// 把M和V传递进来</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskDetailPresenter</span><span class="params">(@Nullable String taskId,</span></span></div><div class="line">                               @NonNull TasksRepository tasksRepository,</div><div class="line">                               @NonNull TaskDetailContract.View taskDetailView) &#123;</div><div class="line">        mTaskId = taskId;</div><div class="line">        mTasksRepository = checkNotNull(tasksRepository, <span class="string">"tasksRepository cannot be null!"</span>);</div><div class="line">        mTaskDetailView = checkNotNull(taskDetailView, <span class="string">"taskDetailView cannot be null!"</span>);</div><div class="line">        <span class="comment">// 将该Presenter设置给V</span></div><div class="line">        mTaskDetailView.setPresenter(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 调用获取数据的方法</span></div><div class="line">        openTask();</div><div class="line">    &#125;</div><div class="line">    ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到上面分别实现了<code>TaskDetailContract</code>类中的<code>Presenter</code>和<code>View</code>接口，而不是<code>BasePresenter</code>和<code>BaseView</code>中的接口，那这个<code>TaskDetailContract</code>类是什么呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This specifies the contract between the view and the presenter.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskDetailContract</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">View</span> <span class="keyword">extends</span> <span class="title">BaseView</span>&lt;<span class="title">Presenter</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setLoadingIndicator</span><span class="params">(<span class="keyword">boolean</span> active)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showMissingTask</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">hideTitle</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTitle</span><span class="params">(String title)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">hideDescription</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showDescription</span><span class="params">(String description)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showCompletionStatus</span><span class="params">(<span class="keyword">boolean</span> complete)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showEditTask</span><span class="params">(String taskId)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTaskDeleted</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTaskMarkedComplete</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTaskMarkedActive</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Presenter</span> <span class="keyword">extends</span> <span class="title">BasePresenter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">editTask</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">deleteTask</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">completeTask</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">activateTask</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>按照上面描述的介绍可以看出通过这个连接类将<code>VP</code>联系到了一起，它统一管理<code>view</code>和<code>presenter</code>中的所有接口，这样比起分开写会更加清晰。</p>
<p>分析完<code>VP</code>之后我们继续看一下<code>TaskDetailPresenter</code>类，因为<code>Presenter</code>是<code>MV</code>的桥梁。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TaskDetailPresenter</span><span class="params">(@Nullable String taskId,</span></span></div><div class="line">                               @NonNull TasksRepository tasksRepository,</div><div class="line">                               @NonNull TaskDetailContract.View taskDetailView) &#123;</div><div class="line">        mTaskId = taskId;</div><div class="line">        mTasksRepository = checkNotNull(tasksRepository, <span class="string">"tasksRepository cannot be null!"</span>);</div><div class="line">        mTaskDetailView = checkNotNull(taskDetailView, <span class="string">"taskDetailView cannot be null!"</span>);</div><div class="line"></div><div class="line">        mTaskDetailView.setPresenter(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        openTask();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openTask</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(mTaskId)) &#123;</div><div class="line">            mTaskDetailView.showMissingTask();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 控制V显示UI</span></div><div class="line">        mTaskDetailView.setLoadingIndicator(<span class="keyword">true</span>);</div><div class="line">    <span class="comment">// 通过M去获取数据</span></div><div class="line">        mTasksRepository.getTask(mTaskId, <span class="keyword">new</span> TasksDataSource.GetTaskCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span> </span>&#123;</div><div class="line">                <span class="comment">// The view may not be able to handle UI updates anymore</span></div><div class="line">                <span class="keyword">if</span> (!mTaskDetailView.isActive()) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                mTaskDetailView.setLoadingIndicator(<span class="keyword">false</span>);</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == task) &#123;</div><div class="line">                    mTaskDetailView.showMissingTask();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    showTask(task);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">// The view may not be able to handle UI updates anymore</span></div><div class="line">                <span class="keyword">if</span> (!mTaskDetailView.isActive()) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                mTaskDetailView.showMissingTask();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在它的构造函数中传入了一个<code>TasksRepository</code>，这个就是<code>Model</code>层。而在该<code>Presenter</code>中的<code>start()</code>方法回去调用获取数据的方法。   </p>
<p>我们继续看一下<code>M</code>层<code>TasksRepository</code>的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Concrete implementation to load tasks from the data sources into a cache.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * For simplicity, this implements a dumb synchronisation between locally persisted data and data</div><div class="line"> * obtained from the server, by using the remote data source only if the local database doesn't</div><div class="line"> * exist or is empty.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksRepository</span> <span class="keyword">implements</span> <span class="title">TasksDataSource</span> </span>&#123;</div><div class="line">    ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先看一下<code>TasksDataSource</code>接口:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Main entry point for accessing tasks data.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * For simplicity, only getTasks() and getTask() have callbacks. Consider adding callbacks to other</div><div class="line"> * methods to inform the user of network/database errors or successful operations.</div><div class="line"> * For example, when a new task is created, it's synchronously stored in cache but usually every</div><div class="line"> * operation on database or network should be executed in a different thread.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TasksDataSource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">LoadTasksCallback</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onTasksLoaded</span><span class="params">(List&lt;Task&gt; tasks)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">GetTaskCallback</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getTasks</span><span class="params">(@NonNull LoadTasksCallback callback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getTask</span><span class="params">(@NonNull String taskId, @NonNull GetTaskCallback callback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">saveTask</span><span class="params">(@NonNull Task task)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">completeTask</span><span class="params">(@NonNull Task task)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">completeTask</span><span class="params">(@NonNull String taskId)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activateTask</span><span class="params">(@NonNull Task task)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activateTask</span><span class="params">(@NonNull String taskId)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearCompletedTasks</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshTasks</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAllTasks</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteTask</span><span class="params">(@NonNull String taskId)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出<code>M</code>层被赋予了数据获取的功能，与之前我们写的<code>M</code>层只定义实体对象截然不同，数据的增删改查都是<code>M</code>层实现的。<code>Presenter</code>只需要调用<code>M</code>层的方法即可。这样<code>model、presenter、view</code>都只处理各自的任务，此种实现确实是单一职责最好的诠释。</p>
<p>这里我们就以上面用到的<code>getTasks()</code>方法为例来介绍一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTask</span><span class="params">(@NonNull <span class="keyword">final</span> String taskId, @NonNull <span class="keyword">final</span> GetTaskCallback callback)</span> </span>&#123;</div><div class="line">        checkNotNull(taskId);</div><div class="line">        checkNotNull(callback);</div><div class="line">        <span class="comment">// 从缓存中获取数据</span></div><div class="line">        Task cachedTask = getTaskWithId(taskId);</div><div class="line"></div><div class="line">        <span class="comment">// Respond immediately with cache if available</span></div><div class="line">        <span class="keyword">if</span> (cachedTask != <span class="keyword">null</span>) &#123;</div><div class="line">            callback.onTaskLoaded(cachedTask);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Load from server/persisted if needed.</span></div><div class="line"></div><div class="line">        <span class="comment">// Is the task in the local data source? If not, query the network.</span></div><div class="line">        mTasksLocalDataSource.getTask(taskId, <span class="keyword">new</span> GetTaskCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span> </span>&#123;</div><div class="line">                <span class="comment">// Do in memory cache update to keep the app UI up to date</span></div><div class="line">                <span class="keyword">if</span> (mCachedTasks == <span class="keyword">null</span>) &#123;</div><div class="line">                    mCachedTasks = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">                &#125;</div><div class="line">                mCachedTasks.put(task.getId(), task);</div><div class="line">                callback.onTaskLoaded(task);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">// 服务器的数据源</span></div><div class="line">                mTasksRemoteDataSource.getTask(taskId, <span class="keyword">new</span> GetTaskCallback() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span> </span>&#123;</div><div class="line">                        <span class="comment">// Do in memory cache update to keep the app UI up to date</span></div><div class="line">                        <span class="keyword">if</span> (mCachedTasks == <span class="keyword">null</span>) &#123;</div><div class="line">                            mCachedTasks = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">                        &#125;</div><div class="line">                        mCachedTasks.put(task.getId(), task);</div><div class="line">                        callback.onTaskLoaded(task);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">                        callback.onDataNotAvailable();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上面的注释说的非常明白了，这里就不去仔细看了。</p>
<p>下面用一张图来总结一下:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/google_todo_mvp.png?raw=true" alt="image"></p>
<p>由于架构的引入，虽然代码量有了一定的上升，但是功能分离的非常清晰明确，而且每个部分都可以进行单独的测试，对于后期的扩展维护会更加简单容易。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android开发中的MVP模式详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android开发工具及类库" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android开发工具及类库/">Android开发工具及类库</a>
    </h1>
  

        
        <a href="/2015/01/01/Android开发工具及类库/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android开发工具及类库"><a href="#Android开发工具及类库" class="headerlink" title="Android开发工具及类库"></a>Android开发工具及类库</h1><p>在项目开发过程中，总有一些必要的工具和类库。下面就简单介绍下我常用的一些(还在用<code>Eclipse</code>的请无视)。      </p>
<ol>
<li><p><a href="https://android.googlesource.com/platform/frameworks/volley" target="_blank" rel="external">volley</a><br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/volley.png?raw=true" alt="image"><br>在<code>Google I/0 2013</code>中发布了<code>Volley</code>.<code>Volley</code>是<code>Android</code>平台上的网络通信库，能使网络通信更快，更简单，更健壮。<br>这是<code>Volley</code>名称的由来:<code>a burst or emission of many things or a large amount at once</code>.<code>Volley</code>特别适合数据量不大但是通信频繁的场景。<br><code>Github</code>上面已经有大神做了镜像，使用更方便有木有。<a href="https://github.com/mcxiaoke/android-volley">Volley On Github</a>                     </p>
</li>
<li><p><a href="https://code.google.com/p/google-gson/" target="_blank" rel="external">Gson</a><br><code>Json</code>转换神器。</p>
</li>
<li><p><a href="https://github.com/zzz40500/GsonFormat">GsonFormat</a><br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/GsonFormat.gif?raw=true" alt="image"><br>既然用了<code>Gson</code>怎么能少了该神器呢？</p>
</li>
<li><p><a href="https://github.com/avast/android-butterknife-zelezny">android-butterknife-zelezny</a><br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/zelezny_animated.gif?raw=true" alt="image"><br>使用<a href="https://github.com/JakeWharton/butterknife">butterknife</a>制作的<code>Android Studio/IDEA</code>插件。非常方便有木有。</p>
</li>
<li><p><a href="https://github.com/inmite/android-selector-chapek">android-selector-chapek</a><br><code>selector</code>写起来是不是很麻烦？以后让<code>UI</code>规范化命名，然后就没有然后了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/select_folder.png?raw=true" alt="image"><br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/select_option.png?raw=true" alt="image"><br>接下来你就会在<code>drawable</code>目录发现对应的<code>selector</code>文件。           </p>
</li>
<li><p><a href="https://github.com/square/leakcanary">leakcanary</a><br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/screenshot.png?raw=true" alt="image"><br>内存泄漏你怕不怕？         </p>
</li>
<li><p><a href="https://github.com/facebook/fresco">fresco</a><br>怎么能少了对图片的处理呢？<code>Fracebook</code>出品。更快、更强、更方便。       </p>
</li>
<li><p><a href="https://github.com/KeepSafe/android-resource-remover">android-resource-remover</a><br> 开发过程中可能会经常遇到需求的变更，时间长了，项目中的无用资源就会越来越多。 虽然在<code>Gradle</code>中支持相应的配置来去除无用资源: </p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">buildTypes &#123;</div><div class="line">       debug &#123;</div><div class="line">           minifyEnabled false</div><div class="line">           zipAlignEnabled false</div><div class="line">           shrinkResources false</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       release &#123;</div><div class="line">           zipAlignEnabled true</div><div class="line">           // remove unused resources</div><div class="line">           shrinkResources true</div><div class="line">           minifyEnabled true</div><div class="line">           proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'</div><div class="line">           signingConfig signingConfigs.release</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>但是这只是在打包的时候不会打进去无用的资源，但是这些资源还是会在工程中。
那我们怎么能快速的移除掉这些无用资源呢？答案也很简单，就是使用`lint`检查出无用的资源后用工具删除，这个工具就是`android-resource-remover`。 
因为它是一个`python`脚本，所以如果不懂`python`的话使用起来会比较麻烦，下面就介绍一下具体的使用方法:            
- 下载并安装`Python 2.x`版本
    去[Python](https://www.python.org/)下载后即可，这里要下载2.x版本，因为3.x版本对语法做了很多改动，可能会不兼容，下载完成后安装就可。安装完成后将安装路径加入到`Path`中。如`D:\Python;`。
- 安装`android-resource-remover`     
    在命令行输入下面的命令`pip install android-resource-remover`。 这里有些电脑可能会提示错误，是因为没有安装`pip`导致的，具体可以看[pip](https://pip.pypa.io/en/latest/installing.html)找到安装的方法。上面介绍了要下载`get-pip.py`后执行`python get-pip.py`就能安装了。
- 将`D:\Python\Scripts`添加到`Path`中。
- 将`lint`命令添加到`Path`中，`D:\android-sdk-windows\tools`.
- 在`Studio`右侧的`Gradle`窗口中执行`lint`任务。 这样就会在`app/build/outputs`下生成`lint-results.xml`文件。下一步清理的时候需要使用`lint-results.xml`文件。               
    ![Image](https://raw.githubusercontent.com/CharonChui/Pictures/master/lint.png?raw=true)    
- 进入到`Android Studio`中的具体项目中执行`./gradlew clean`后再执行`./gradlew lint &amp;&amp; android-resource-remover --xml app/build/outputs/lint-results.xml`
</code></pre><ol>
<li><a href="https://github.com/facebook/stetho">stetho</a><br> <code>facebook</code>出品。快速查看布局、数据库、网络请求。实在不能再方便了。   </li>
<li><a href="https://github.com/ReactiveX/RxJava">RxJava</a><br>用了后你会爱上它。</li>
<li><a href="https://github.com/square/retrofit">Retrofilt</a><br><code>Square</code>出品。大神<code>JakeWharton</code>主导出品的网络请求框架。内部结合<code>OkHttp</code>。结合<code>RxJava</code>使用非常方便。   </li>
<li><a href="https://github.com/googlesamples/android-architecture">android-architecture</a><br>放到这里可能不太合适，因为它并不是工具和类库，而是<code>Google</code>官方发布的<code>Android</code>架构示例。非常值得参考。  </li>
<li><a href="https://github.com/pedrovgs/AndroidWiFiADB">AndroidWiFiADB</a><br>还在为数据线不够用而烦恼嘛?</li>
</ol>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android开发工具及类库/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Activity启动过程" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Activity启动过程/">Activity启动过程</a>
    </h1>
  

        
        <a href="/2015/01/01/Activity启动过程/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Activity启动过程"><a href="#Activity启动过程" class="headerlink" title="Activity启动过程"></a>Activity启动过程</h1><p>前两天面试了天猫的开发，被问到了<code>Activity</code>启动过程，不懂啊….<br>今天就来分析一下，我们开启<code>Activity</code>主要有两种方式:    </p>
<ul>
<li>通过桌面图标启动，桌面就是<code>Launcher</code>其实他也是一个应用程序，他也是继承<code>Activity</code>。</li>
<li>在程序内部调用<code>startActivity()</code>开启。</li>
</ul>
<p>而<code>Launcher</code>点击图标其实也是调用了<code>Activity</code>的<code>startActivity()</code>方法，所以我们就从<code>startActivity()</code>方法入手了。<br>首先看一下<code>Activity</code>类中的<code>startActivity()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>startActivity(intent, null)</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Launch a new activity.  You will not receive any information about when</div><div class="line"> * the activity exits.  This implementation overrides the base version,</div><div class="line"> * providing information about</div><div class="line"> * the activity performing the launch.  Because of this additional</div><div class="line"> * information, the &#123;<span class="doctag">@link</span> Intent#FLAG_ACTIVITY_NEW_TASK&#125; launch flag is not</div><div class="line"> * required; if not specified, the new activity will be added to the</div><div class="line"> * task of the caller.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> intent The intent to start.</div><div class="line"> * <span class="doctag">@param</span> options Additional options for how the Activity should be started.</div><div class="line"> * See &#123;<span class="doctag">@link</span> android.content.Context#startActivity(Intent, Bundle)</div><div class="line"> * Context.startActivity(Intent, Bundle)&#125; for more details.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> &#123;<span class="doctag">@link</span> #startActivity(Intent)&#125;</div><div class="line"> * <span class="doctag">@see</span> #startActivityForResult</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">		startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Note we want to go through this call for compatibility with</span></div><div class="line">		<span class="comment">// applications that may have overridden the method.</span></div><div class="line">		startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来会调用<code>startActivityForResult()</code>方法(注释也很重要啊，里面也说明了singleTask启动模式时该方法不会走到回调中):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Launch an activity for which you would like a result when it finished.</div><div class="line"> * When this activity exits, your</div><div class="line"> * onActivityResult() method will be called with the given requestCode.</div><div class="line"> * Using a negative requestCode is the same as calling</div><div class="line"> * &#123;<span class="doctag">@link</span> #startActivity&#125; (the activity is not launched as a sub-activity).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this method should only be used with Intent protocols</div><div class="line"> * that are defined to return a result.  In other protocols (such as</div><div class="line"> * &#123;<span class="doctag">@link</span> Intent#ACTION_MAIN&#125; or &#123;<span class="doctag">@link</span> Intent#ACTION_VIEW&#125;), you may</div><div class="line"> * not get the result when you expect.  For example, if the activity you</div><div class="line"> * are launching uses the singleTask launch mode, it will not run in your</div><div class="line"> * task and thus you will immediately receive a cancel result.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;As a special case, if you call startActivityForResult() with a requestCode</div><div class="line"> * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your</div><div class="line"> * activity, then your window will not be displayed until a result is</div><div class="line"> * returned back from the started activity.  This is to avoid visible</div><div class="line"> * flickering when redirecting to another activity.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> intent The intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode If &gt;= 0, this code will be returned in</div><div class="line"> *                    onActivityResult() when the activity exits.</div><div class="line"> * <span class="doctag">@param</span> options Additional options for how the Activity should be started.</div><div class="line"> * See &#123;<span class="doctag">@link</span> android.content.Context#startActivity(Intent, Bundle)</div><div class="line"> * Context.startActivity(Intent, Bundle)&#125; for more details.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #startActivity</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">	<span class="comment">// mParent也是Activity类，通过名字就能看明白了。</span></div><div class="line">	<span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 开始了啊</span></div><div class="line">		Instrumentation.ActivityResult ar =</div><div class="line">			mInstrumentation.execStartActivity(</div><div class="line">				<span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">				intent, requestCode, options);</div><div class="line">		<span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">			mMainThread.sendActivityResult(</div><div class="line">				mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">				ar.getResultData());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// If this start is requesting a result, we can avoid making</span></div><div class="line">			<span class="comment">// the activity visible until the result is received.  Setting</span></div><div class="line">			<span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></div><div class="line">			<span class="comment">// activity hidden during this time, to avoid flickering.</span></div><div class="line">			<span class="comment">// This can only be done when a result is requested because</span></div><div class="line">			<span class="comment">// that guarantees we will get information back when the</span></div><div class="line">			<span class="comment">// activity is finished, no matter what happens to it.</span></div><div class="line">			mStartedActivity = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cancelInputsAndStartExitTransition(options);</div><div class="line">		<span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">			mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// Note we want to go through this method for compatibility with</span></div><div class="line">			<span class="comment">// existing applications that may have overridden it.</span></div><div class="line">			mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面调用了<code>mInstrumentation.execStartActivity</code>这是啥玩意，先看一下<code>mInstrumentation</code>属性，他是<code>Instrumentation</code>类，我们看下文档<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Base class for implementing application instrumentation code.  When running</div><div class="line"> * with instrumentation turned on, this class will be instantiated for you</div><div class="line"> * before any of the application code, allowing you to monitor all of the</div><div class="line"> * interaction the system has with the application.  An Instrumentation</div><div class="line"> * implementation is described to the system through an AndroidManifest.xml's</div><div class="line"> * &amp;lt;instrumentation&amp;gt; tag.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Instrumentation</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>放狗查了下<code>Instrumentation</code>的意思是仪器、工具、装置的意思。我就大体翻一下(英语不好- -~，可能不准确)该类是实现应用程序代码的基类，当该类在<br>启动的状态下运行时，该类会在其他任何应用程序运行前进行初始化，允许你件事所有应用程序与系统的交互。一个<code>Instrumentation</code>实例会通过<code>Manifest</code>文件<br>中的<code>&lt;instrumenttation</code>标签描述给系统。<br>所以继续看一下<code>mInstrumentation.execStartActivity()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   // 下面的注释说的很明白了默认实现会更新任何活跃的对象并分发给系统的`activity manager`</div><div class="line"> * Execute a startActivity call made by the application.  The default </div><div class="line"> * implementation takes care of updating any active &#123;<span class="doctag">@link</span> ActivityMonitor&#125;</div><div class="line"> * objects and dispatches this call to the system activity manager; you can</div><div class="line"> * override this to watch for the application to start an activity, and </div><div class="line"> * modify what happens when it does. </div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method returns an &#123;<span class="doctag">@link</span> ActivityResult&#125; object, which you can </div><div class="line"> * use when intercepting application calls to avoid performing the start </div><div class="line"> * activity action but still return the result the application is </div><div class="line"> * expecting.  To do this, override this method to catch the call to start </div><div class="line"> * activity so that it returns a new ActivityResult containing the results </div><div class="line"> * you would like the application to see, and don't call up to the super </div><div class="line"> * class.  Note that an application is only expecting a result if </div><div class="line"> * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> who The Context from which the activity is being started.</div><div class="line"> * <span class="doctag">@param</span> contextThread The main thread of the Context from which the activity</div><div class="line"> *                      is being started.</div><div class="line"> * <span class="doctag">@param</span> token Internal token identifying to the system who is starting </div><div class="line"> *              the activity; may be null.</div><div class="line"> * <span class="doctag">@param</span> target Which activity is performing the start (and thus receiving </div><div class="line"> *               any result); may be null if this call is not being made</div><div class="line"> *               from an activity.</div><div class="line"> * <span class="doctag">@param</span> intent The actual Intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode Identifier for this request's result; less than zero </div><div class="line"> *                    if the caller is not expecting a result.</div><div class="line"> * <span class="doctag">@param</span> options Addition options.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> To force the return of a particular result, return an </div><div class="line"> *         ActivityResult object containing the desired data; otherwise</div><div class="line"> *         return null.  The default implementation always returns null.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivity(Intent)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityForResult(Intent, int)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityFromChild</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">		Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">		Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</div><div class="line">	IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">	Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</div><div class="line">		intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">				<span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</div><div class="line">					am.mHits++;</div><div class="line">					<span class="keyword">if</span> (am.isBlocking()) &#123;</div><div class="line">						<span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		intent.migrateExtraStreamToClipData();</div><div class="line">		intent.prepareToLeaveProcess();</div><div class="line">		<span class="comment">// 通过注释然后再结合代码一看我们就知道这应该就是分发到系统activity manager的过程</span></div><div class="line">		<span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">			.startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">					intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">					token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">					requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">		checkStartActivityResult(result, intent);</div><div class="line">	&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那就直接看下<code>ActivityManagerNative.getDefault().startActivity()</code>方法，看之前我们先看看<code>ActivityManagerNative.getDefault()</code>是什么鬼:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve the system's default/global activity manager.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释说的明白的就是拿到系统默认/全局的<code>activity manager</code>，通过名字也能看出来<code>IActivityManager</code>是个接口，那就继续看<code>IActivityManager.startActivity()</code>方法吧:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">            String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> flags,</div><div class="line">            ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException;</div></pre></td></tr></table></figure></p>
<p>这里就顺便看一下<code>IActivityManager</code>接口是神马鬼：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * System private API for talking with the activity manager service.  This</div><div class="line"> * provides calls from the application back to the activity manager.</div><div class="line"> *</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">public interface IActivityManager extends IInterface &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是看到这里我不知道怎么继续往下分析了啊，既然是接口我们要找到实现类啊，又是通过<code>ActivityManagerNative.getDefault()</code>得到的<code>IActivityManager</code>实例，<br>所以这里我们再看下<code>ActivityManagerNative</code>类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>啊！ 隐藏的，连个注释也没有，我拖动了下这个类一看<code>5992</code>行，不知道从哪下手了，还能从哪下手啊，当然是从<code>ActivityManagerNative.getDefault()</code>方法啊<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 继承Binder接口，而且asInterFace方法，我好想明白了点什么</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cast a Binder object into an activity manager interface, generating</div><div class="line">     * a proxy if needed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        IActivityManager in =</div><div class="line">            (IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> in;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Retrieve the system's default/global activity manager.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 使用了getDefaule的get方法</span></div><div class="line">        <span class="keyword">return</span> gDefault.get();</div><div class="line">    &#125;</div><div class="line">	....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看：　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">	<span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="comment">// 进程间通信了</span></div><div class="line">		IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">			Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 看到了吗？用到了刚才我们说的asInterface方法</span></div><div class="line">		IActivityManager am = asInterface(b);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">			Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> am;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>好了，我们再看下<code>asInterface()</code>方法:　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	IActivityManager in =</div><div class="line">		(IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">	<span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> in;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 在这里</span></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>终于找到了其实就是<code>ActivityManagerProxy</code>类，刚才我们找到<code>IActivityManager</code>接口的<code>startActivity()</code> 方法，现在终于找到了在这里使用的是<code>IActivityManager</code>接口实现类的<br><code>ActivityManagerProxy</code>类，我们来看一下该类实现的<code>startActivity()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span></span></div><div class="line">    &#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">			String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">			<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">		Parcel data = Parcel.obtain();</div><div class="line">		Parcel reply = Parcel.obtain();</div><div class="line">		data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">		data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</div><div class="line">		data.writeString(callingPackage);</div><div class="line">		intent.writeToParcel(data, <span class="number">0</span>);</div><div class="line">		data.writeString(resolvedType);</div><div class="line">		data.writeStrongBinder(resultTo);</div><div class="line">		data.writeString(resultWho);</div><div class="line">		data.writeInt(requestCode);</div><div class="line">		data.writeInt(startFlags);</div><div class="line">		<span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">			data.writeInt(<span class="number">1</span>);</div><div class="line">			profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			data.writeInt(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">			data.writeInt(<span class="number">1</span>);</div><div class="line">			options.writeToParcel(data, <span class="number">0</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			data.writeInt(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">		reply.readException();</div><div class="line">		<span class="keyword">int</span> result = reply.readInt();</div><div class="line">		reply.recycle();</div><div class="line">		data.recycle();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再继续我就不知道走到哪里了….<br>这一块其实是用了<code>Binder</code>机制，上面的<code>IActivityManager.getDefault()</code>方法返回的是<code>ActivityManagerService</code>的远程接口，所以接下来<br>我们应该看一下<code>ActivityManagerService.startActivity()</code>类。(具体<code>Binder</code>机制我们后续会专门写一篇文章，这里就不说了，不然就说不完了)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">		Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) &#123;</div><div class="line">	<span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">		resultWho, requestCode, startFlags, profilerInfo, options,</div><div class="line">		UserHandle.getCallingUserId());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看下<code>startActivityAsUser()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">		Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId) &#123;</div><div class="line">	enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">	userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</div><div class="line">			<span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></div><div class="line">	<span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">			resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">			profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>mStackSupervisor.startActivityMayWait()</code>方法,这里<code>mStackSupervisor</code>是<code>ActivityStackSupervisor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></div><div class="line">		String callingPackage, Intent intent, String resolvedType,</div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">		IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</div><div class="line">		ProfilerInfo profilerInfo, WaitResult outResult, Configuration config,</div><div class="line">		Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</div><div class="line">		IActivityContainer iContainer, TaskRecord inTask) &#123;</div><div class="line">	<span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">	<span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Don't modify the client's object!</span></div><div class="line">	intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">	<span class="comment">// 解析出要开启的Activity的信息，包名、类名、参数等。</span></div><div class="line">	<span class="comment">// Collect information about the target of the Intent.</span></div><div class="line">	ActivityInfo aInfo =</div><div class="line">			resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</div><div class="line"></div><div class="line">	ActivityContainer container = (ActivityContainer)iContainer;</div><div class="line">	<span class="keyword">synchronized</span> (mService) &#123;</div><div class="line">		<span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">				container.mParentActivity.state != RESUMED) &#123;</div><div class="line">			<span class="comment">// Cannot start a child activity if the parent is not resumed.</span></div><div class="line">			<span class="keyword">return</span> ActivityManager.START_CANCELED;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</div><div class="line">		<span class="keyword">int</span> callingPid;</div><div class="line">		<span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</div><div class="line">			callingPid = -<span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</div><div class="line">			callingPid = realCallingPid;</div><div class="line">			callingUid = realCallingUid;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			callingPid = callingUid = -<span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> ActivityStack stack;</div><div class="line">		<span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</div><div class="line">			stack = mFocusedStack;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			stack = container.mStack;</div><div class="line">		&#125;</div><div class="line">		stack.mConfigWillChange = config != <span class="keyword">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</div><div class="line">		<span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</div><div class="line">				<span class="string">"Starting activity when config will change = "</span> + stack.mConfigWillChange);</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</div><div class="line">				(aInfo.applicationInfo.privateFlags</div><div class="line">						&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// This may be a heavy-weight process!  Check to see if we already</span></div><div class="line">			<span class="comment">// have another, different heavy-weight process running.</span></div><div class="line">			<span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</div><div class="line">				<span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span> &amp;&amp;</div><div class="line">						(mService.mHeavyWeightProcess.info.uid != aInfo.applicationInfo.uid ||</div><div class="line">						!mService.mHeavyWeightProcess.processName.equals(aInfo.processName))) &#123;</div><div class="line">					<span class="keyword">int</span> appCallingUid = callingUid;</div><div class="line">					<span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">						ProcessRecord callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">						<span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">							appCallingUid = callerApp.info.uid;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">								  + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></div><div class="line">								  + intent.toString());</div><div class="line">							ActivityOptions.abort(options);</div><div class="line">							<span class="keyword">return</span> ActivityManager.START_PERMISSION_DENIED;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					IIntentSender target = mService.getIntentSenderLocked(</div><div class="line">							ActivityManager.INTENT_SENDER_ACTIVITY, <span class="string">"android"</span>,</div><div class="line">							appCallingUid, userId, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">new</span> Intent[] &#123; intent &#125;,</div><div class="line">							<span class="keyword">new</span> String[] &#123; resolvedType &#125;, PendingIntent.FLAG_CANCEL_CURRENT</div><div class="line">							| PendingIntent.FLAG_ONE_SHOT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">					Intent newIntent = <span class="keyword">new</span> Intent();</div><div class="line">					<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">						<span class="comment">// Caller is requesting a result.</span></div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_HAS_RESULT, <span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">					newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT,</div><div class="line">							<span class="keyword">new</span> IntentSender(target));</div><div class="line">					<span class="keyword">if</span> (mService.mHeavyWeightProcess.activities.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">						ActivityRecord hist = mService.mHeavyWeightProcess.activities.get(<span class="number">0</span>);</div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_APP,</div><div class="line">								hist.packageName);</div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_TASK,</div><div class="line">								hist.task.taskId);</div><div class="line">					&#125;</div><div class="line">					newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP,</div><div class="line">							aInfo.packageName);</div><div class="line">					newIntent.setFlags(intent.getFlags());</div><div class="line">					newIntent.setClassName(<span class="string">"android"</span>,</div><div class="line">							HeavyWeightSwitcherActivity.class.getName());</div><div class="line">					intent = newIntent;</div><div class="line">					resolvedType = <span class="keyword">null</span>;</div><div class="line">					caller = <span class="keyword">null</span>;</div><div class="line">					callingUid = Binder.getCallingUid();</div><div class="line">					callingPid = Binder.getCallingPid();</div><div class="line">					componentSpecified = <span class="keyword">true</span>;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						ResolveInfo rInfo =</div><div class="line">							AppGlobals.getPackageManager().resolveIntent(</div><div class="line">									intent, <span class="keyword">null</span>,</div><div class="line">									PackageManager.MATCH_DEFAULT_ONLY</div><div class="line">									| ActivityManagerService.STOCK_PM_FLAGS, userId);</div><div class="line">						aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</div><div class="line">						aInfo = mService.getActivityInfoForUser(aInfo, userId);</div><div class="line">					&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">						aInfo = <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 根据上面解析的内容去开启了。。。</span></div><div class="line">		<span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</div><div class="line">				voiceSession, voiceInteractor, resultTo, resultWho,</div><div class="line">				requestCode, callingPid, callingUid, callingPackage,</div><div class="line">				realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</div><div class="line">				componentSpecified, <span class="keyword">null</span>, container, inTask);</div><div class="line"></div><div class="line">		Binder.restoreCallingIdentity(origId);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (stack.mConfigWillChange) &#123;</div><div class="line">			<span class="comment">// If the caller also wants to switch to a new configuration,</span></div><div class="line">			<span class="comment">// do so now.  This allows a clean switch, as we are waiting</span></div><div class="line">			<span class="comment">// for the current activity to pause (so we will not destroy</span></div><div class="line">			<span class="comment">// it), and have not yet started the next activity.</span></div><div class="line">			mService.enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</div><div class="line">					<span class="string">"updateConfiguration()"</span>);</div><div class="line">			stack.mConfigWillChange = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</div><div class="line">					<span class="string">"Updating to new configuration after starting activity."</span>);</div><div class="line">			mService.updateConfigurationLocked(config, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</div><div class="line">			outResult.result = res;</div><div class="line">			<span class="keyword">if</span> (res == ActivityManager.START_SUCCESS) &#123;</div><div class="line">				mWaitingActivityLaunched.add(outResult);</div><div class="line">				<span class="keyword">do</span> &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						mService.wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (res == ActivityManager.START_TASK_TO_FRONT) &#123;</div><div class="line">				ActivityRecord r = stack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">				<span class="keyword">if</span> (r.nowVisible &amp;&amp; r.state == RESUMED) &#123;</div><div class="line">					outResult.timeout = <span class="keyword">false</span>;</div><div class="line">					outResult.who = <span class="keyword">new</span> ComponentName(r.info.packageName, r.info.name);</div><div class="line">					outResult.totalTime = <span class="number">0</span>;</div><div class="line">					outResult.thisTime = <span class="number">0</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					outResult.thisTime = SystemClock.uptimeMillis();</div><div class="line">					mWaitingActivityVisible.add(outResult);</div><div class="line">					<span class="keyword">do</span> &#123;</div><div class="line">						<span class="keyword">try</span> &#123;</div><div class="line">							mService.wait();</div><div class="line">						&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> res;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那就继续看一下<code>startActivityLocked()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">		Intent intent, String resolvedType, ActivityInfo aInfo,</div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">		IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</div><div class="line">		<span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</div><div class="line">		<span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</div><div class="line">		ActivityContainer container, TaskRecord inTask) &#123;</div><div class="line">	<span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</div><div class="line"></div><div class="line">	ProcessRecord callerApp = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// mService就是ActivityManagerService类</span></div><div class="line">		callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">		<span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">			callingPid = callerApp.pid;</div><div class="line">			callingUid = callerApp.info.uid;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">				  + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></div><div class="line">				  + intent.toString());</div><div class="line">			err = ActivityManager.START_PERMISSION_DENIED;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</div><div class="line">		Slog.i(TAG, <span class="string">"START u"</span> + userId + <span class="string">" &#123;"</span> + intent.toShortString(<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>)</div><div class="line">				+ <span class="string">"&#125; from uid "</span> + callingUid</div><div class="line">				+ <span class="string">" on display "</span> + (container == <span class="keyword">null</span> ? (mFocusedStack == <span class="keyword">null</span> ?</div><div class="line">						Display.DEFAULT_DISPLAY : mFocusedStack.mDisplayId) :</div><div class="line">						(container.mActivityDisplay == <span class="keyword">null</span> ? Display.DEFAULT_DISPLAY :</div><div class="line">								container.mActivityDisplay.mDisplayId)));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ActivityRecord sourceRecord = <span class="keyword">null</span>;</div><div class="line">	ActivityRecord resultRecord = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">		sourceRecord = isInAnyStackLocked(resultTo);</div><div class="line">		<span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</div><div class="line">				<span class="string">"Will send result to "</span> + resultTo + <span class="string">" "</span> + sourceRecord);</div><div class="line">		<span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</div><div class="line">				resultRecord = sourceRecord;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// Transfer the result target from the source activity to the new</span></div><div class="line">		<span class="comment">// one being started, including any failures.</span></div><div class="line">		<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</div><div class="line">		&#125;</div><div class="line">		resultRecord = sourceRecord.resultTo;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;</div><div class="line">			resultRecord = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		resultWho = sourceRecord.resultWho;</div><div class="line">		requestCode = sourceRecord.requestCode;</div><div class="line">		sourceRecord.resultTo = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (sourceRecord.launchedFromUid == callingUid) &#123;</div><div class="line">			<span class="comment">// The new activity is being launched from the same uid as the previous</span></div><div class="line">			<span class="comment">// activity in the flow, and asking to forward its result back to the</span></div><div class="line">			<span class="comment">// previous.  In this case the activity is serving as a trampoline between</span></div><div class="line">			<span class="comment">// the two, so we also want to update its launchedFromPackage to be the</span></div><div class="line">			<span class="comment">// same as the previous activity.  Note that this is safe, since we know</span></div><div class="line">			<span class="comment">// these two packages come from the same uid; the caller could just as</span></div><div class="line">			<span class="comment">// well have supplied that same package name itself.  This specifially</span></div><div class="line">			<span class="comment">// deals with the case of an intent picker/chooser being launched in the app</span></div><div class="line">			<span class="comment">// flow to redirect to an activity picked by the user, where we want the final</span></div><div class="line">			<span class="comment">// activity to consider it to have been launched by the previous app activity.</span></div><div class="line">			callingPackage = sourceRecord.launchedFromPackage;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// We couldn't find a class that can handle the given Intent.</span></div><div class="line">		<span class="comment">// That's the end of that!</span></div><div class="line">		err = ActivityManager.START_INTENT_NOT_RESOLVED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// We couldn't find the specific class specified in the Intent.</span></div><div class="line">		<span class="comment">// Also the end of the line.</span></div><div class="line">		err = ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS</div><div class="line">			&amp;&amp; !isCurrentProfileLocked(userId)</div><div class="line">			&amp;&amp; (aInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// Trying to launch a background activity that doesn't show for all users.</span></div><div class="line">		err = ActivityManager.START_NOT_CURRENT_USER_ACTIVITY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class="keyword">null</span></div><div class="line">			&amp;&amp; sourceRecord.task.voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If this activity is being launched as part of a voice session, we need</span></div><div class="line">		<span class="comment">// to ensure that it is safe to do so.  If the upcoming activity will also</span></div><div class="line">		<span class="comment">// be part of the voice session, we can only launch it if it has explicitly</span></div><div class="line">		<span class="comment">// said it supports the VOICE category, or it is a part of the calling app.</span></div><div class="line">		<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span></div><div class="line">				&amp;&amp; sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				intent.addCategory(Intent.CATEGORY_VOICE);</div><div class="line">				<span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(</div><div class="line">						intent.getComponent(), intent, resolvedType)) &#123;</div><div class="line">					Slog.w(TAG,</div><div class="line">							<span class="string">"Activity being started in current voice task does not support voice: "</span></div><div class="line">							+ intent);</div><div class="line">					err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				Slog.w(TAG, <span class="string">"Failure checking voice capabilities"</span>, e);</div><div class="line">				err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the caller is starting a new voice session, just make sure the target</span></div><div class="line">		<span class="comment">// is actually allowing it to run this way.</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(intent.getComponent(),</div><div class="line">					intent, resolvedType)) &#123;</div><div class="line">				Slog.w(TAG,</div><div class="line">						<span class="string">"Activity being started in new voice task does not support: "</span></div><div class="line">						+ intent);</div><div class="line">				err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">			Slog.w(TAG, <span class="string">"Failure checking voice capabilities"</span>, e);</div><div class="line">			err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Activity栈</span></div><div class="line">	<span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err != ActivityManager.START_SUCCESS) &#123;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">				resultRecord, resultWho, requestCode,</div><div class="line">				Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> err;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> startAnyPerm = mService.checkPermission(</div><div class="line">			START_ANY_ACTIVITY, callingPid, callingUid);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (startAnyPerm != PERMISSION_GRANTED) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> componentRestriction = getComponentRestrictionForCallingPackage(</div><div class="line">				aInfo, callingPackage, callingPid, callingUid, ignoreTargetSecurity);</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> actionRestriction = getActionRestrictionForCallingPackage(</div><div class="line">				intent.getAction(), callingPackage, callingPid, callingUid);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION</div><div class="line">				|| actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</div><div class="line">			<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">				resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">						resultRecord, resultWho, requestCode,</div><div class="line">						Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			String msg;</div><div class="line">			<span class="keyword">if</span> (actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span> + <span class="string">" with revoked permission "</span></div><div class="line">						+ ACTION_TO_RUNTIME_PERMISSION.get(intent.getAction());</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!aInfo.exported) &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">						+ <span class="string">" not exported from uid "</span> + aInfo.applicationInfo.uid;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">						+ <span class="string">" requires "</span> + aInfo.permission;</div><div class="line">			&#125;</div><div class="line">			Slog.w(TAG, msg);</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (actionRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</div><div class="line">			String message = <span class="string">"Appop Denial: starting "</span> + intent.toString()</div><div class="line">					+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">					+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">					+ <span class="string">" requires "</span> + AppOpsManager.permissionToOp(</div><div class="line">							ACTION_TO_RUNTIME_PERMISSION.get(intent.getAction()));</div><div class="line">			Slog.w(TAG, message);</div><div class="line">			abort = <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (componentRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</div><div class="line">			String message = <span class="string">"Appop Denial: starting "</span> + intent.toString()</div><div class="line">					+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">					+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">					+ <span class="string">" requires appop "</span> + AppOpsManager.permissionToOp(aInfo.permission);</div><div class="line">			Slog.w(TAG, message);</div><div class="line">			abort = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</div><div class="line">			callingPid, resolvedType, aInfo.applicationInfo);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// The Intent we give to the watcher has the extra data</span></div><div class="line">			<span class="comment">// stripped off, since it can contain private information.</span></div><div class="line">			Intent watchIntent = intent.cloneFilter();</div><div class="line">			abort |= !mService.mController.activityStarting(watchIntent,</div><div class="line">					aInfo.applicationInfo.packageName);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">			mService.mController = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (abort) &#123;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultStack.sendActivityResultLocked(-<span class="number">1</span>, resultRecord, resultWho, requestCode,</div><div class="line">					Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// We pretend to the caller that it was really started, but</span></div><div class="line">		<span class="comment">// they will just get a cancel result.</span></div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// ActivityRecord: An entry in the history stack, representing an activity.</span></div><div class="line">	ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</div><div class="line">			intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</div><div class="line">			requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</div><div class="line">	<span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</div><div class="line">		outActivity[<span class="number">0</span>] = r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (r.appTimeTracker == <span class="keyword">null</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the caller didn't specify an explicit time tracker, we want to continue</span></div><div class="line">		<span class="comment">// tracking under any it has.</span></div><div class="line">		r.appTimeTracker = sourceRecord.appTimeTracker;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ActivityStack stack = mFocusedStack;</div><div class="line">	<span class="keyword">if</span> (voiceSession == <span class="keyword">null</span> &amp;&amp; (stack.mResumedActivity == <span class="keyword">null</span></div><div class="line">			|| stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</div><div class="line">		<span class="keyword">if</span> (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid,</div><div class="line">				realCallingPid, realCallingUid, <span class="string">"Activity start"</span>)) &#123;</div><div class="line">			PendingActivityLaunch pal =</div><div class="line">					<span class="keyword">new</span> PendingActivityLaunch(r, sourceRecord, startFlags, stack);</div><div class="line">			mPendingActivityLaunches.add(pal);</div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_SWITCHES_CANCELED;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mService.mDidAppSwitch) &#123;</div><div class="line">		<span class="comment">// This is the second allowed switch since we stopped switches,</span></div><div class="line">		<span class="comment">// so now just generally allow switches.  Use case: user presses</span></div><div class="line">		<span class="comment">// home (switches disabled, switch to home, mDidAppSwitch now true);</span></div><div class="line">		<span class="comment">// user taps a home icon (coming from home so allowed, we hit here</span></div><div class="line">		<span class="comment">// and now allow anyone to switch again).</span></div><div class="line">		mService.mAppSwitchesAllowedTime = <span class="number">0</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mService.mDidAppSwitch = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</div><div class="line">	<span class="comment">// 继续调用方法</span></div><div class="line">	err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">			startFlags, <span class="keyword">true</span>, options, inTask);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// If someone asked to have the keyguard dismissed on the next</span></div><div class="line">		<span class="comment">// activity start, but we are not actually doing an activity</span></div><div class="line">		<span class="comment">// switch...  just dismiss the keyguard now, because we</span></div><div class="line">		<span class="comment">// probably want to see whatever is behind it.</span></div><div class="line">		notifyActivityDrawnForKeyguard();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再继续看<code>startActivityUncheckedLocked</code>方法：　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,</div><div class="line">		<span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask) &#123;</div><div class="line">	<span class="keyword">final</span> Intent intent = r.intent;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</div><div class="line"></div><div class="line">	<span class="comment">// In some flows in to this function, we retrieve the task record and hold on to it</span></div><div class="line">	<span class="comment">// without a lock before calling back in to here...  so the task at this point may</span></div><div class="line">	<span class="comment">// not actually be in recents.  Check for that, and if it isn't in recents just</span></div><div class="line">	<span class="comment">// consider it invalid.</span></div><div class="line">	<span class="keyword">if</span> (inTask != <span class="keyword">null</span> &amp;&amp; !inTask.inRecents) &#123;</div><div class="line">		Slog.w(TAG, <span class="string">"Starting activity in task not in recents: "</span> + inTask);</div><div class="line">		inTask = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 判断不同的启动模式</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</div><div class="line"></div><div class="line">	.....</div><div class="line"></div><div class="line">	<span class="comment">// We may want to try to place the new activity in to an existing task.  We always</span></div><div class="line">	<span class="comment">// do this if the target activity is singleTask or singleInstance; we will also do</span></div><div class="line">	<span class="comment">// this if NEW_TASK has been requested, and there is not an additional qualifier telling</span></div><div class="line">	<span class="comment">// us to still place it in a new task: multi task, always doc mode, or being asked to</span></div><div class="line">	<span class="comment">// launch this as a new task behind the current one.</span></div><div class="line">	<span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</div><div class="line">			(launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</div><div class="line">			|| launchSingleInstance || launchSingleTask) &#123;</div><div class="line">		<span class="comment">// If bring to front is requested, and no result is requested and we have not</span></div><div class="line">		<span class="comment">// been given an explicit task to launch in to, and</span></div><div class="line">		<span class="comment">// we can find a task that was started with this same</span></div><div class="line">		<span class="comment">// component, then instead of launching bring that one to the front.</span></div><div class="line">		<span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// See if there is a task to bring to the front.  If this is</span></div><div class="line">			<span class="comment">// a SINGLE_INSTANCE activity, there can be one and only one</span></div><div class="line">			<span class="comment">// instance of it in the history, and it is always in its own</span></div><div class="line">			<span class="comment">// unique task, so we do a special search.</span></div><div class="line">			ActivityRecord intentActivity = !launchSingleInstance ?</div><div class="line">					findTaskLocked(r) : findActivityLocked(intent, r.info);</div><div class="line">			<span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused</span></div><div class="line">				<span class="comment">// but still needs to be a lock task mode violation since the task gets</span></div><div class="line">				<span class="comment">// cleared out and the device would otherwise leave the locked task.</span></div><div class="line">				<span class="keyword">if</span> (isLockTaskModeViolation(intentActivity.task,</div><div class="line">						(launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">						== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</div><div class="line">					showLockTaskToast();</div><div class="line">					Slog.e(TAG, <span class="string">"startActivityUnchecked: Attempt to violate Lock Task Mode"</span>);</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</div><div class="line">					r.task = intentActivity.task;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (intentActivity.task.intent == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// This task was started because of movement of</span></div><div class="line">					<span class="comment">// the activity based on affinity...  now that we</span></div><div class="line">					<span class="comment">// are actually launching it, we can assign the</span></div><div class="line">					<span class="comment">// base intent.</span></div><div class="line">					intentActivity.task.setIntent(r);</div><div class="line">				&#125;</div><div class="line">				targetStack = intentActivity.task.stack;</div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="comment">// If the target task is not in the front, then we need</span></div><div class="line">				<span class="comment">// to bring it to the front...  except...  well, with</span></div><div class="line">				<span class="comment">// SINGLE_TASK_LAUNCH it's not entirely clear.  We'd like</span></div><div class="line">				<span class="comment">// to have the same behavior as if a new instance was</span></div><div class="line">				<span class="comment">// being started, which means not bringing it to the front</span></div><div class="line">				<span class="comment">// if the caller is not itself in the front.</span></div><div class="line">				<span class="keyword">final</span> ActivityStack focusStack = getFocusedStack();</div><div class="line">				ActivityRecord curTop = (focusStack == <span class="keyword">null</span>)</div><div class="line">						? <span class="keyword">null</span> : focusStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">				<span class="keyword">boolean</span> movedToFront = <span class="keyword">false</span>;</div><div class="line">				<span class="keyword">if</span> (curTop != <span class="keyword">null</span> &amp;&amp; (curTop.task != intentActivity.task ||</div><div class="line">						curTop.task != focusStack.topTask())) &#123;</div><div class="line">					r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);</div><div class="line">					<span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> || (sourceStack.topActivity() != <span class="keyword">null</span> &amp;&amp;</div><div class="line">							sourceStack.topActivity().task == sourceRecord.task)) &#123;</div><div class="line">						<span class="comment">// We really do want to push this one into the user's face, right now.</span></div><div class="line">						<span class="keyword">if</span> (launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">							intentActivity.setTaskToAffiliateWith(sourceRecord.task);</div><div class="line">						&#125;</div><div class="line">						movedHome = <span class="keyword">true</span>;</div><div class="line">						targetStack.moveTaskToFrontLocked(intentActivity.task, noAnimation,</div><div class="line">								options, r.appTimeTracker, <span class="string">"bringingFoundTaskToFront"</span>);</div><div class="line">						movedToFront = <span class="keyword">true</span>;</div><div class="line">						<span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">								(FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">								== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">							<span class="comment">// Caller wants to appear on home activity.</span></div><div class="line">							intentActivity.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">						&#125;</div><div class="line">						options = <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">					<span class="keyword">if</span> (DEBUG_TASKS) Slog.d(TAG_TASKS, <span class="string">"Bring to front target: "</span> + targetStack</div><div class="line">							+ <span class="string">" from "</span> + intentActivity);</div><div class="line">					targetStack.moveToFront(<span class="string">"intentActivityFound"</span>);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// If the caller has requested that the target task be</span></div><div class="line">				<span class="comment">// reset, then do so.</span></div><div class="line">				<span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					intentActivity = targetStack.resetTaskIfNeededLocked(intentActivity, r);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">					<span class="comment">// the client said not to do anything if that</span></div><div class="line">					<span class="comment">// is the case, so this is it!  And for paranoia, make</span></div><div class="line">					<span class="comment">// sure we have correctly resumed the top activity.</span></div><div class="line">					<span class="keyword">if</span> (doResume) &#123;</div><div class="line">						resumeTopActivitiesLocked(targetStack, <span class="keyword">null</span>, options);</div><div class="line"></div><div class="line">						<span class="comment">// Make sure to notify Keyguard as well if we are not running an app</span></div><div class="line">						<span class="comment">// transition later.</span></div><div class="line">						<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">							notifyActivityDrawnForKeyguard();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> ((launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">						== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</div><div class="line">					<span class="comment">// The caller has requested to completely replace any</span></div><div class="line">					<span class="comment">// existing task with its new activity.  Well that should</span></div><div class="line">					<span class="comment">// not be too hard...</span></div><div class="line">					reuseTask = intentActivity.task;</div><div class="line">					reuseTask.performClearTaskLocked();</div><div class="line">					reuseTask.setIntent(r);</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></div><div class="line">						|| launchSingleInstance || launchSingleTask) &#123;</div><div class="line">					<span class="comment">// In this situation we want to remove all activities</span></div><div class="line">					<span class="comment">// from the task up to the one being started.  In most</span></div><div class="line">					<span class="comment">// cases this means we are resetting the task to its</span></div><div class="line">					<span class="comment">// initial state.</span></div><div class="line">					ActivityRecord top =</div><div class="line">							intentActivity.task.performClearTaskLocked(r, launchFlags);</div><div class="line">					<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">if</span> (top.frontOfTask) &#123;</div><div class="line">							<span class="comment">// Activity aliases may mean we use different</span></div><div class="line">							<span class="comment">// intents for the top activity, so make sure</span></div><div class="line">							<span class="comment">// the task now has the identity of the new</span></div><div class="line">							<span class="comment">// intent.</span></div><div class="line">							top.task.setIntent(r);</div><div class="line">						&#125;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT,</div><div class="line">								r, top.task);</div><div class="line">						top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="comment">// A special case: we need to start the activity because it is not</span></div><div class="line">						<span class="comment">// currently running, and the caller has asked to clear the current</span></div><div class="line">						<span class="comment">// task to have this activity at the top.</span></div><div class="line">						addingToTask = <span class="keyword">true</span>;</div><div class="line">						<span class="comment">// Now pretend like this activity is being started by the top of its</span></div><div class="line">						<span class="comment">// task, so it is put in the right place.</span></div><div class="line">						sourceRecord = intentActivity;</div><div class="line">						TaskRecord task = sourceRecord.task;</div><div class="line">						<span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.stack == <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Target stack got cleared when we all activities were removed</span></div><div class="line">							<span class="comment">// above. Go ahead and reset it.</span></div><div class="line">							targetStack = computeStackFocus(sourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>);</div><div class="line">							targetStack.addTask(</div><div class="line">									task, !launchTaskBehind <span class="comment">/* toTop */</span>, <span class="keyword">false</span> <span class="comment">/* moving */</span>);</div><div class="line">						&#125;</div><div class="line"></div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.realActivity.equals(intentActivity.task.realActivity)) &#123;</div><div class="line">					<span class="comment">// In this case the top activity on the task is the</span></div><div class="line">					<span class="comment">// same as the one being launched, so we take that</span></div><div class="line">					<span class="comment">// as a request to bring the task to the foreground.</span></div><div class="line">					<span class="comment">// If the top activity in the task is the root</span></div><div class="line">					<span class="comment">// activity, deliver this new intent to it if it</span></div><div class="line">					<span class="comment">// desires.</span></div><div class="line">					<span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || launchSingleTop)</div><div class="line">							&amp;&amp; intentActivity.realActivity.equals(r.realActivity)) &#123;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r,</div><div class="line">								intentActivity.task);</div><div class="line">						<span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</div><div class="line">							intentActivity.task.setIntent(r);</div><div class="line">						&#125;</div><div class="line">						intentActivity.deliverNewIntentLocked(callingUid, r.intent,</div><div class="line">								r.launchedFromPackage);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r.intent.filterEquals(intentActivity.task.intent)) &#123;</div><div class="line">						<span class="comment">// In this case we are launching the root activity</span></div><div class="line">						<span class="comment">// of the task, but with a different intent.  We</span></div><div class="line">						<span class="comment">// should start a new instance on top.</span></div><div class="line">						addingToTask = <span class="keyword">true</span>;</div><div class="line">						sourceRecord = intentActivity;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// In this case an activity is being launched in to an</span></div><div class="line">					<span class="comment">// existing task, without resetting that task.  This</span></div><div class="line">					<span class="comment">// is typically the situation of launching an activity</span></div><div class="line">					<span class="comment">// from a notification or shortcut.  We want to place</span></div><div class="line">					<span class="comment">// the new activity on top of the current task.</span></div><div class="line">					addingToTask = <span class="keyword">true</span>;</div><div class="line">					sourceRecord = intentActivity;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.task.rootWasReset) &#123;</div><div class="line">					<span class="comment">// In this case we are launching in to an existing task</span></div><div class="line">					<span class="comment">// that has not yet been started from its front door.</span></div><div class="line">					<span class="comment">// The current task has been brought to the front.</span></div><div class="line">					<span class="comment">// Ideally, we'd probably like to place this new task</span></div><div class="line">					<span class="comment">// at the bottom of its stack, but that's a little hard</span></div><div class="line">					<span class="comment">// to do with the current organization of the code so</span></div><div class="line">					<span class="comment">// for now we'll just drop it.</span></div><div class="line">					intentActivity.task.setIntent(r);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (!addingToTask &amp;&amp; reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// We didn't do anything...  but it was needed (a.k.a., client</span></div><div class="line">					<span class="comment">// don't use that intent!)  And for paranoia, make</span></div><div class="line">					<span class="comment">// sure we have correctly resumed the top activity.</span></div><div class="line">					<span class="keyword">if</span> (doResume) &#123;</div><div class="line">						targetStack.resumeTopActivityLocked(<span class="keyword">null</span>, options);</div><div class="line">						<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">							<span class="comment">// Make sure to notify Keyguard as well if we are not running an app</span></div><div class="line">							<span class="comment">// transition later.</span></div><div class="line">							notifyActivityDrawnForKeyguard();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//String uri = r.intent.toURI();</span></div><div class="line">	<span class="comment">//Intent intent2 = new Intent(uri);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "Given intent: " + r.intent);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "URI is: " + uri);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "To intent: " + intent2);</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the activity being launched is the same as the one currently</span></div><div class="line">		<span class="comment">// at the top, then we need to check if it should only be launched</span></div><div class="line">		<span class="comment">// once.</span></div><div class="line">		ActivityStack topStack = mFocusedStack;</div><div class="line">		ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">				<span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">						|| launchSingleTop || launchSingleTask) &#123;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</div><div class="line">								top.task);</div><div class="line">						<span class="comment">// For paranoia, make sure we have correctly</span></div><div class="line">						<span class="comment">// resumed the top activity.</span></div><div class="line">						topStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">						<span class="keyword">if</span> (doResume) &#123;</div><div class="line">							resumeTopActivitiesLocked();</div><div class="line">						&#125;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">						<span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">							<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">							<span class="comment">// the client said not to do anything if that</span></div><div class="line">							<span class="comment">// is the case, so this is it!</span></div><div class="line">							<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">						&#125;</div><div class="line">						top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">						<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">			r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>, r.resultTo, r.resultWho,</div><div class="line">					r.requestCode, Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</div><div class="line">			sourceRecord.task : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Should this be considered a new task?</span></div><div class="line">	<span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</div><div class="line">			&amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">		newTask = <span class="keyword">true</span>;</div><div class="line">		targetStack = computeStackFocus(r, newTask);</div><div class="line">		targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">			r.setTask(targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">					newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</div><div class="line">					newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</div><div class="line">					voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</div><div class="line">					taskToAffiliate);</div><div class="line">			<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS,</div><div class="line">					<span class="string">"Starting new activity "</span> + r + <span class="string">" in new task "</span> + r.task);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.setTask(reuseTask, taskToAffiliate);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(r.task)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!movedHome) &#123;</div><div class="line">			<span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">					(FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">					== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">				<span class="comment">// Caller wants to appear on home activity, so before starting</span></div><div class="line">				<span class="comment">// their own activity we will bring home to the front.</span></div><div class="line">				r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> TaskRecord sourceTask = sourceRecord.task;</div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(sourceTask)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		targetStack = sourceTask.stack;</div><div class="line">		targetStack.moveToFront(<span class="string">"sourceStackToFront"</span>);</div><div class="line">		<span class="keyword">final</span> TaskRecord topTask = targetStack.topTask();</div><div class="line">		<span class="keyword">if</span> (topTask != sourceTask) &#123;</div><div class="line">			targetStack.moveTaskToFrontLocked(sourceTask, noAnimation, options,</div><div class="line">					r.appTimeTracker, <span class="string">"sourceTaskToFront"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!addingToTask &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// In this case, we are adding the activity to an existing</span></div><div class="line">			<span class="comment">// task, but the caller has asked to clear that task if the</span></div><div class="line">			<span class="comment">// activity is already running.</span></div><div class="line">			ActivityRecord top = sourceTask.performClearTaskLocked(r, launchFlags);</div><div class="line">			keepCurTransition = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, top.task);</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				<span class="comment">// For paranoia, make sure we have correctly</span></div><div class="line">				<span class="comment">// resumed the top activity.</span></div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (doResume) &#123;</div><div class="line">					targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">				ActivityOptions.abort(options);</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addingToTask &amp;&amp;</div><div class="line">				(launchFlags&amp;Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// In this case, we are launching an activity in our own task</span></div><div class="line">			<span class="comment">// that may already be running somewhere in the history, and</span></div><div class="line">			<span class="comment">// we want to shuffle it to the front of the stack if so.</span></div><div class="line">			<span class="keyword">final</span> ActivityRecord top = sourceTask.findActivityInHistoryLocked(r);</div><div class="line">			<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> TaskRecord task = top.task;</div><div class="line">				task.moveActivityToFrontLocked(top);</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, task);</div><div class="line">				top.updateOptionsLocked(options);</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (doResume) &#123;</div><div class="line">					targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// An existing activity is starting this new activity, so we want</span></div><div class="line">		<span class="comment">// to keep the new one in the same task as the one that is starting</span></div><div class="line">		<span class="comment">// it.</span></div><div class="line">		r.setTask(sourceTask, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in existing task "</span> + r.task + <span class="string">" from source "</span> + sourceRecord);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The caller is asking that the new activity be started in an explicit</span></div><div class="line">		<span class="comment">// task it has provided to us.</span></div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(inTask)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		targetStack = inTask.stack;</div><div class="line">		targetStack.moveTaskToFrontLocked(inTask, noAnimation, options, r.appTimeTracker,</div><div class="line">				<span class="string">"inTaskToFront"</span>);</div><div class="line"></div><div class="line">		<span class="comment">// Check whether we should actually launch the new activity in to the task,</span></div><div class="line">		<span class="comment">// or just reuse the current activity on top.</span></div><div class="line">		ActivityRecord top = inTask.getTopActivity();</div><div class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">			<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">					|| launchSingleTop || launchSingleTask) &#123;</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top, top.task);</div><div class="line">				<span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">					<span class="comment">// the client said not to do anything if that</span></div><div class="line">					<span class="comment">// is the case, so this is it!</span></div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">				&#125;</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!addingToTask) &#123;</div><div class="line">			<span class="comment">// We don't actually want to have this activity added to the task, so just</span></div><div class="line">			<span class="comment">// stop here but still tell the caller that we consumed the intent.</span></div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		r.setTask(inTask, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in explicit task "</span> + r.task);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// This not being started from an existing activity, and not part</span></div><div class="line">		<span class="comment">// of a new task...  just put it in the top task, though these days</span></div><div class="line">		<span class="comment">// this case should never happen.</span></div><div class="line">		targetStack = computeStackFocus(r, newTask);</div><div class="line">		targetStack.moveToFront(<span class="string">"addingToTopTask"</span>);</div><div class="line">		ActivityRecord prev = targetStack.topActivity();</div><div class="line">		r.setTask(prev != <span class="keyword">null</span> ? prev.task : targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">						r.info, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>), <span class="keyword">null</span>);</div><div class="line">		mWindowManager.moveTaskToTop(r.task.taskId);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in new guessed "</span> + r.task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</div><div class="line">			intent, r.getUriPermissionsLocked(), r.userId);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span> &amp;&amp; sourceRecord.isRecentsActivity()) &#123;</div><div class="line">		r.task.setTaskToReturnTo(RECENTS_ACTIVITY_TYPE);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (newTask) &#123;</div><div class="line">		EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, r.userId, r.task.taskId);</div><div class="line">	&#125;</div><div class="line">	ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task);</div><div class="line">	targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">	</div><div class="line">	<span class="comment">// 上面这部分代码很多，各种启动模式、栈的处理啊，我们就不继续看了，接着看下面的启动。</span></div><div class="line">	targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</div><div class="line">	<span class="keyword">if</span> (!launchTaskBehind) &#123;</div><div class="line">		<span class="comment">// Don't set focus on an activity that's going to the back.</span></div><div class="line">		mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>targetStack.startActivityLocked()</code>方法,这里<code>targetStack</code>就是<code>ActivityStack</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span></span></div><div class="line">		<span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options) &#123;</div><div class="line">	TaskRecord rTask = r.task;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</div><div class="line">	<span class="comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span></div><div class="line">	<span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</div><div class="line">		<span class="comment">// Last activity in task had been removed or ActivityManagerService is reusing task.</span></div><div class="line">		<span class="comment">// Insert or replace.</span></div><div class="line">		<span class="comment">// Might not even be in.</span></div><div class="line">		insertTaskAtTop(rTask, r);</div><div class="line">		mWindowManager.moveTaskToTop(taskId);</div><div class="line">	&#125;</div><div class="line">	TaskRecord task = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (!newTask) &#123;</div><div class="line">		<span class="comment">// If starting in an existing task, find where that is...</span></div><div class="line">		<span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</div><div class="line">			task = mTaskHistory.get(taskNdx);</div><div class="line">			<span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// All activities in task are finishing.</span></div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (task == r.task) &#123;</div><div class="line">				<span class="comment">// Here it is!  Now, if this is not yet visible to the</span></div><div class="line">				<span class="comment">// user, then just add it without starting; it will</span></div><div class="line">				<span class="comment">// get started when the user navigates back to it.</span></div><div class="line">				<span class="keyword">if</span> (!startIt) &#123;</div><div class="line">					<span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to task "</span></div><div class="line">							+ task, <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">					task.addActivityToTop(r);</div><div class="line">					r.putInHistory();</div><div class="line">					mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">							r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">							(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>,</div><div class="line">							r.userId, r.info.configChanges, task.voiceSession != <span class="keyword">null</span>,</div><div class="line">							r.mLaunchTaskBehind);</div><div class="line">					<span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">						validateAppTokensLocked();</div><div class="line">					&#125;</div><div class="line">					ActivityOptions.abort(options);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</div><div class="line">				startIt = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Place a new activity at top of stack, so it is next to interact</span></div><div class="line">	<span class="comment">// with the user.</span></div><div class="line"></div><div class="line">	<span class="comment">// If we are not placing the new activity frontmost, we do not want</span></div><div class="line">	<span class="comment">// to deliver the onUserLeaving callback to the actual frontmost</span></div><div class="line">	<span class="comment">// activity</span></div><div class="line">	<span class="keyword">if</span> (task == r.task &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</div><div class="line">		mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (DEBUG_USER_LEAVING) Slog.v(TAG_USER_LEAVING,</div><div class="line">				<span class="string">"startActivity() behind front, mUserLeaving=false"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	task = r.task;</div><div class="line"></div><div class="line">	<span class="comment">// Slot the activity into the history stack and proceed</span></div><div class="line">	<span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to stack to task "</span> + task,</div><div class="line">			<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">	task.addActivityToTop(r);</div><div class="line">	task.setFrontOfTask();</div><div class="line"></div><div class="line">	r.putInHistory();</div><div class="line">	<span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// We want to show the starting preview window if we are</span></div><div class="line">		<span class="comment">// switching to a new task, or the next activity's process is</span></div><div class="line">		<span class="comment">// not currently running.</span></div><div class="line">		<span class="keyword">boolean</span> showStartingIcon = newTask;</div><div class="line">		ProcessRecord proc = r.app;</div><div class="line">		<span class="keyword">if</span> (proc == <span class="keyword">null</span>) &#123;</div><div class="line">			proc = mService.mProcessNames.get(r.processName, r.info.applicationInfo.uid);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.thread == <span class="keyword">null</span>) &#123;</div><div class="line">			showStartingIcon = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</div><div class="line">				<span class="string">"Prepare open transition: starting "</span> + r);</div><div class="line">		<span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</div><div class="line">			mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, keepCurTransition);</div><div class="line">			mNoAnimActivities.add(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mWindowManager.prepareAppTransition(newTask</div><div class="line">					? r.mLaunchTaskBehind</div><div class="line">							? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">							: AppTransition.TRANSIT_TASK_OPEN</div><div class="line">					: AppTransition.TRANSIT_ACTIVITY_OPEN, keepCurTransition);</div><div class="line">			mNoAnimActivities.remove(r);</div><div class="line">		&#125;</div><div class="line">		mWindowManager.addAppToken(task.mActivities.indexOf(r),</div><div class="line">				r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">				(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">				r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">		<span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">if</span> (newTask) &#123;</div><div class="line">			<span class="comment">// Even though this activity is starting fresh, we still need</span></div><div class="line">			<span class="comment">// to reset it to make sure we apply affinities to move any</span></div><div class="line">			<span class="comment">// existing activities from other tasks in to it.</span></div><div class="line">			<span class="comment">// If the caller has requested that the target task be</span></div><div class="line">			<span class="comment">// reset, then do so.</span></div><div class="line">			<span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">				resetTaskIfNeededLocked(r, r);</div><div class="line">				doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</div><div class="line">				== ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</div><div class="line">			doShow = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</div><div class="line">			<span class="comment">// Don't do a starting window for mLaunchTaskBehind. More importantly make sure we</span></div><div class="line">			<span class="comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span></div><div class="line">			mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line">			ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</div><div class="line">			<span class="comment">// Figure out if we are transitioning from another activity that is</span></div><div class="line">			<span class="comment">// "has the same starting icon" as the next one.  This allows the</span></div><div class="line">			<span class="comment">// window manager to keep the previous window it had previously</span></div><div class="line">			<span class="comment">// created, if it still had one.</span></div><div class="line">			ActivityRecord prev = mResumedActivity;</div><div class="line">			<span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// We don't want to reuse the previous starting preview if:</span></div><div class="line">				<span class="comment">// (1) The current activity is in a different task.</span></div><div class="line">				<span class="keyword">if</span> (prev.task != r.task) &#123;</div><div class="line">					prev = <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// (2) The current activity is already displayed.</span></div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</div><div class="line">					prev = <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			mWindowManager.setAppStartingWindow(</div><div class="line">					r.appToken, r.packageName, r.theme,</div><div class="line">					mService.compatibilityInfoForPackageLocked(</div><div class="line">							r.info.applicationInfo), r.nonLocalizedLabel,</div><div class="line">					r.labelRes, r.icon, r.logo, r.windowFlags,</div><div class="line">					prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</div><div class="line">			r.mStartingWindowShown = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// If this is the first activity, don't do any fancy animations,</span></div><div class="line">		<span class="comment">// because there is nothing for it to animate on top of.</span></div><div class="line">		mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">				r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">				(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">				r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		options = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">		validateAppTokensLocked();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (doResume) &#123;</div><div class="line">		mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 在Android应用程序框架层中，是由ActivityManagerService组件负责为Android应用程序创建新的进程的，它本来也是运行在一个独立的进程之中，不过这个进程是在系统启动的过程中创建的。<br> ActivityManagerService组件一般会在什么情况下会为应用程序创建一个新的进程呢？当系统决定要在一个新的进程中启动一个Activity或者Service时，它就会创建一个新的进程了，<br> 然后在这个新的进程中启动这个Activity或者Service</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Activity启动过程/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-BroadcastReceiver安全问题" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/BroadcastReceiver安全问题/">BroadcastReceiver安全问题</a>
    </h1>
  

        
        <a href="/2015/01/01/BroadcastReceiver安全问题/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="BroadcastReceiver安全问题"><a href="#BroadcastReceiver安全问题" class="headerlink" title="BroadcastReceiver安全问题"></a>BroadcastReceiver安全问题</h1><p><code>BroadcastReceiver</code>设计的初衷是从全局考虑可以方便应用程序和系统、应用程序之间、应用程序内的通信，所以对单个应用程序而言<code>BroadcastReceiver</code>是存在安全性问题的(恶意程序脚本不断的去发送你所接收的广播)</p>
<ul>
<li><p>保证发送的广播要发送给指定的对象<br>  当应用程序发送某个广播时系统会将发送的<code>Intent</code>与系统中所有注册的<code>BroadcastReceiver</code>的<code>IntentFilter</code>进行匹配，若匹配成功则执行相应的<code>onReceive</code>函数。可以通过类似<code>sendBroadcast(Intent, String)</code>的接口在发送广播时指定接收者必须具备的<code>permission</code>或通过<code>Intent.setPackage</code>设置广播仅对某个程序有效。</p>
</li>
<li><p>保证我接收到的广播室指定对象发送过来的<br>  当应用程序注册了某个广播时，即便设置了<code>IntentFilter</code>还是会接收到来自其他应用程序的广播进行匹配判断。对于动态注册的广播可以通过类似<code>registerReceiver(BroadcastReceiver, IntentFilter, String, android.os.Handler)</code>的接口指定发送者必须具备的<code>permission</code>，对于静态注册的广播可以通过<code>android:exported=&quot;false&quot;</code>属性表示接收者对外部应用程序不可用，即不接受来自外部的广播。</p>
</li>
</ul>
<p><code>android.support.v4.content.LocalBroadcastManager</code>工具类，可以实现在自己的进程内进行局部广播发送与注册，使用它比直接通过sendBroadcast(Intent)发送系统全局广播有以下几个好处：</p>
<ul>
<li>因广播数据在本应用范围内传播，你不用担心隐私数据泄露的问题。</li>
<li>不用担心别的应用伪造广播，造成安全隐患。</li>
<li>相比在系统内发送全局广播，它更高效。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"> LocalBroadcastManager mLocalBroadcastManager;  </div><div class="line"> BroadcastReceiver mReceiver;  </div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">	 IntentFilter filter = <span class="keyword">new</span> IntentFilter();  </div><div class="line">	 filter.addAction(<span class="string">"test"</span>);  </div><div class="line"></div><div class="line">	 mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;  </div><div class="line">		<span class="meta">@Override</span>  </div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </div><div class="line">			<span class="keyword">if</span> (intent.getAction().equals(<span class="string">"test"</span>)) &#123;  </div><div class="line">				<span class="comment">//Do Something</span></div><div class="line">			&#125; </div><div class="line">		&#125;  </div><div class="line">	&#125;;  </div><div class="line">	mLocalBroadcastManager = LocalBroadcastManager.getInstance(<span class="keyword">this</span>);</div><div class="line">	mLocalBroadcastManager.registerReceiver(mReceiver, filter);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">   mLocalBroadcastManager.unregisterReceiver(mReceiver);</div><div class="line">   <span class="keyword">super</span>.onDestroy();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/BroadcastReceiver安全问题/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AsyncTask详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AsyncTask详解/">AsyncTask详解</a>
    </h1>
  

        
        <a href="/2015/01/01/AsyncTask详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AsyncTask详解"><a href="#AsyncTask详解" class="headerlink" title="AsyncTask详解"></a>AsyncTask详解</h1><p><code>AsyncTask</code>简单的说其实就是<code>Handler</code>和<code>Thread</code>的结合，就想下面自己写的<code>MyAsyncTask</code>一样，这就是它的基本远离，当然它并不止这么简单。</p>
<ul>
<li>经典版异步任务                </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAsyncTask</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Handler handler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(android.os.Message msg)</span> </span>&#123;</div><div class="line">			onPostExecute();</div><div class="line">		&#125;;</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 后台任务执行之前 提示用户的界面操作.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span></span>;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 后台任务执行之后 更新界面的操作.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">()</span></span>;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 在后台执行的一个耗时的操作.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doInBackground</span><span class="params">()</span></span>;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">//1. 耗时任务执行之前通知界面更新</span></div><div class="line">		onPreExecute();</div><div class="line">		<span class="keyword">new</span> Thread()&#123;</div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				doInBackground();</div><div class="line">				handler.sendEmptyMessage(<span class="number">0</span>);</div><div class="line">			&#125;;</div><div class="line">		&#125;.start();</div><div class="line">		</div><div class="line">	&#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>AsyncTask                 </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</div><div class="line">			blackNumberInfos = dao.findByPage(startIndex, maxNumber);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</div><div class="line">			loading.setVisibility(View.VISIBLE);</div><div class="line">			<span class="keyword">super</span>.onPreExecute();</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Void result)</span> </span>&#123;</div><div class="line">			loading.setVisibility(View.INVISIBLE);</div><div class="line">			<span class="keyword">if</span> (adapter == <span class="keyword">null</span>) &#123;<span class="comment">// 第一次加载数据 数据适配器还不存在</span></div><div class="line">				adapter = <span class="keyword">new</span> CallSmsAdapter();</div><div class="line">				lv_callsms_safe.setAdapter(adapter);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;<span class="comment">// 有新的数据被添加进来.</span></div><div class="line">				adapter.notifyDataSetChanged();<span class="comment">// 通知数据适配器 数据变化了.</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">super</span>.onPostExecute(result);</div><div class="line">		&#125;</div><div class="line">	&#125;.execute(); </div><div class="line">类的构造方法中接收三个参数，这里我们不用参数就都给它传Void，<span class="keyword">new</span>出来AsyncTask类之后然后重写这三个方法，</div><div class="line">最后别忘了执行execute方法，其实它的内部和我们写的经典版的异步任务相同，也是里面写了一个在新的线程中去执行耗时的操作，</div><div class="line">然后用handler发送Message对象，主线程收到这个Message之后去执行onPostExecute中的内容。</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//AsyncTask&lt;Params, Progress, Result&gt; ,params 异步任务执行(doBackgroud方法)需要的参数这个参数的实参可以由execute()方法的参数传入,</span></div><div class="line"><span class="comment">// Progess 执行的进度,result是(doBackground方法)执行后的结果 </span></div><div class="line"><span class="keyword">new</span> AsyncTask&lt;String, Void, Boolean&gt;() &#123; </div><div class="line">		ProgressDialog pd;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> Boolean <span class="title">doInBackground</span><span class="params">(String... params)</span> </span>&#123; <span class="comment">//这里返回的就是执行的接口，这个返回的结果会传递给onPostExecute的参数</span></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				String filename = params[<span class="number">0</span>];<span class="comment">//得到execute传入的参数</span></div><div class="line">				File file = <span class="keyword">new</span> File(Environment.getExternalStorageDirectory(),filename);</div><div class="line">				FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</div><div class="line">				SmsUtils.backUp(getApplicationContext(), fos, <span class="keyword">new</span> BackUpStatusListener() &#123;</div><div class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackUpProcess</span><span class="params">(<span class="keyword">int</span> process)</span> </span>&#123;</div><div class="line">						pd.setProgress(process);</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeBackup</span><span class="params">(<span class="keyword">int</span> max)</span> </span>&#123;</div><div class="line">						pd.setMax(max);</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">			&#125;    </div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</div><div class="line">			pd = <span class="keyword">new</span> ProgressDialog(AtoolsActivity.<span class="keyword">this</span>);</div><div class="line">			pd.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);</div><div class="line">			pd.setMessage(<span class="string">"正在备份短信"</span>);</div><div class="line">			pd.show();</div><div class="line">			<span class="keyword">super</span>.onPreExecute();</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Boolean result)</span> </span>&#123;</div><div class="line">			pd.dismiss();</div><div class="line">			<span class="keyword">if</span>(result)&#123;</div><div class="line">				Toast.makeText(getApplicationContext(), <span class="string">"备份成功"</span>, <span class="number">0</span>).show();</div><div class="line">			&#125;<span class="keyword">else</span>&#123;</div><div class="line">				Toast.makeText(getApplicationContext(), <span class="string">"备份失败"</span>, <span class="number">0</span>).show();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">super</span>.onPostExecute(result);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;.execute(<span class="string">"backup.xml"</span>); <span class="comment">//这里传入的参数就是doInBackgound中的参数，会传入到doInBackground中</span></div><div class="line"> </div><div class="line">ProgressDialog有个方法</div><div class="line">incrementProgressBy(<span class="keyword">int</span> num);方法，这个方法能够让进度条自动增加，如果参数为<span class="number">1</span>就是进度条累加<span class="number">1</span>。</div><div class="line"> </div><div class="line">可以给ProgressDialog添加一个监听dismiss的监听器。pd.setOnDismisListener(DismisListener listener);让其在取消显示后做什么事</div></pre></td></tr></table></figure>
<p>经过上面两部分，我们会发现<code>AsyncTask</code>太好了，他帮我们封装了<code>Handler</code>和<code>Thread</code>，当然他内部肯定会有线程池的管理，所以以后我们在开发中对于耗时的操作可以都用<code>AsyncTask</code>来搞定的。其实这种做法是错误的。今天发现公司项目中的网络请求都是用<code>AsyncTask</code>来做的(刚换的工作)。这样会有严重的问题。</p>
<p><code>AsyncTask</code>存在的问题:</p>
<ul>
<li><code>AsyncTask</code>虽然有<code>cancel</code>方法，但是一旦执行了<code>doInBackground</code>方法，就算调用取消方法，也会执行完<code>doInBackground</code>方法中的内容才会停止。</li>
<li>串行还是并行的问题。<br>  在<code>1.6</code>之前，<code>AsyncTask</code>是串行执行任务的。<code>1.6</code>的时候开始采用线程池并行处理。但是从<code>3.0</code>开始为了解决<code>AsyncTask</code>的并发问题，<code>AsyncTask</code>又采用一个现成来串行执行任务。(串行啊，每个任务10秒，五个任务，最后一个就要到50秒的时候才执行完)</li>
<li>线程池的问题。</li>
</ul>
<p>先从源码的角度分析下:<br>打开源码后先看下他的注释，注释把我们所关心的内容说的很明白了。<code>AsyncTask</code>并不是设计来处理耗时操作的，耗时的上限最多为几秒钟。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">AsyncTask enables proper and easy use of the UI thread. This class allows to perform background operations and </div><div class="line"> publish results on the UI thread without having to manipulate threads and/or handlers. </div><div class="line">AsyncTask is designed to be a helper class around Thread and Handler and does not constitute a generic threading </div><div class="line"> framework. ***AsyncTasks should ideally be used for short operations (a few seconds at the most.) If you need to keep </div><div class="line"> threads running for long periods of time, it is highly recommended you use the various APIs provided by the </div><div class="line"> java.util.concurrent package such as Executor, ThreadPoolExecutor and FutureTask. ***</div><div class="line"> </div><div class="line">There are a few threading rules that must be followed for this class to work properly: </div><div class="line">	- The AsyncTask class must be loaded on the UI thread. This is done automatically as of </div><div class="line">	 android.os.Build.VERSION_CODES.JELLY_BEAN. </div><div class="line">	- The task instance must be created on the UI thread. </div><div class="line">	- execute must be invoked on the UI thread. </div><div class="line">	- Do not call onPreExecute(), onPostExecute, doInBackground, onProgressUpdate manually. </div><div class="line">	- The task can be executed only once (an exception will be thrown if a second execution is attempted.) Memory </div><div class="line">	 observability</div><div class="line">	 </div><div class="line">    When first introduced, AsyncTasks were executed serially on a single background thread. Starting with </div><div class="line">android.os.Build.VERSION_CODES.DONUT, this was changed to a pool of threads allowing multiple tasks to operate </div><div class="line">in parallel. Starting with android.os.Build.VERSION_CODES.HONEYCOMB, tasks are executed on a single thread to </div><div class="line">avoid common application errors caused by parallel execution. </div><div class="line">If you truly want parallel execution, you can invoke executeOnExecutor(java.util.concurrent.Executor, Object[]) with </div><div class="line"> THREAD_POOL_EXECUTOR.</div></pre></td></tr></table></figure>
<p>拿到源码我们应该从哪里入手: 使用的时候我们都是 <code>new AsyncTask&lt;&gt;.execute()</code>所以我们可以先从构造方法和<code>execute</code>方法入手:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates a new asynchronous task. This constructor must be invoked on the UI thread.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 初始化mWorker</span></div><div class="line">	mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">			<span class="comment">// 修改该变量值</span></div><div class="line">			mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">			Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">			<span class="comment">// 熟悉的doInBackground方法，并且返回该方法的返回值。</span></div><div class="line">			<span class="comment">//noinspection unchecked</span></div><div class="line">			<span class="keyword">return</span> postResult(doInBackground(mParams));</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">	<span class="comment">// 初始化mFuture并且将mWorker作为参数。这个FutureTask是什么...我也不知道，放狗查了一下。FutureTask是一种可以取消的异步的计算任务实现了Runnable接口，</span></div><div class="line">	<span class="comment">// 它可以让程序员准确地知道线程什么时候执行完成并获得到线程执行完成后返回的结果。其实就是FutureTask就是个子线程，会去执行mWorker回调中的耗时的操作</span></div><div class="line">	<span class="comment">// 然后在执行完后执行done回调方法。</span></div><div class="line">	mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">			    <span class="comment">// 执行完成后的操作</span></div><div class="line">				postResultIfNotInvoked(get());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				android.util.Log.w(LOG_TAG, e);</div><div class="line">			&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occured while executing doInBackground()"</span>,</div><div class="line">						e.getCause());</div><div class="line">			&#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">				postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>WorkerRunnable</code>是<code>Callable</code>接口的抽象实现类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</div><div class="line">	Params[] mParams;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面上<code>postResultIfNotInvoked()</code>源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postResultIfNotInvoked</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> wasTaskInvoked = mTaskInvoked.get();</div><div class="line">	<span class="keyword">if</span> (!wasTaskInvoked) &#123;</div><div class="line">		postResult(result);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 通过Handler和Message将结果发布出去</span></div><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">	<span class="comment">// 调用getHandler去发送Message</span></div><div class="line">	Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">			<span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">	message.sendToTarget();</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那我们再看一下<code>getHandler()</code>方法得到的是哪个<code>Handler</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">synchronized</span> (AsyncTask.class) &#123;</div><div class="line">		<span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</div><div class="line">			sHandler = <span class="keyword">new</span> InternalHandler();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> sHandler;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那接下来再看一下<code>InternalHandler</code>的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">		AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">		<span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">			<span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">				<span class="comment">// There is only one result</span></div><div class="line">				result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">				result.mTask.onProgressUpdate(result.mData);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到如果判断消息类型为<code>MESSAGE_POST_RESULT</code>时，回去执行<code>finish()</code>方法，接着看一下<code>result.mTask.finish()</code>方法的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">	    <span class="comment">// 如果被取消了就执行onCancelled方法，这就是为什么虽然AsyncTask可以取消，但是doInBackground方法还是会执行完的原因。</span></div><div class="line">		onCancelled(result);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	    <span class="comment">// 没被取消就执行oPostExecute方法</span></div><div class="line">		onPostExecute(result);</div><div class="line">	&#125;</div><div class="line">	mStatus = Status.FINISHED;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里我们会发现已经分析完了<code>doInBackground</code>方法执行完后的一系列操作。那<code>onPreExecute</code>方法是在哪里?</p>
<p>好了，接着看<code>execute()</code>方法    :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面调用了<code>executeOnExecutor()</code>，我们看一下<code>executeOnExecutor()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">		Params... params) &#123;</div><div class="line">	<span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">		<span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">			<span class="keyword">case</span> RUNNING:</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">						+ <span class="string">" the task is already running."</span>);</div><div class="line">			<span class="keyword">case</span> FINISHED:</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">						+ <span class="string">" the task has already been executed "</span></div><div class="line">						+ <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mStatus = Status.RUNNING;</div><div class="line">	<span class="comment">// 看到我们熟悉的onPreExecute()方法。</span></div><div class="line">	onPreExecute();</div><div class="line">    <span class="comment">// 将参数设置给mWorker变量</span></div><div class="line">	mWorker.mParams = params;</div><div class="line">	<span class="comment">// 执行了Executor的execute方法并用mFuture为参数，这个exec就是上面的sDefaultExecutor</span></div><div class="line">	exec.execute(mFuture);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>sDefaultExecutor</code>是什么:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * An &#123;<span class="doctag">@link</span> Executor&#125; that executes tasks one at a time in serial</div><div class="line"> * order.  This serialization is global to a particular process.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_POST_RESULT = <span class="number">0x1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_POST_PROGRESS = <span class="number">0x2</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div></pre></td></tr></table></figure></p>
<p>从上面的部分能够看出<code>sDefaultExecutor</code>是一个<code>SerialExecutor</code>对象，好了，接下来看一下<code>SerialExecutor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="comment">// 用一个队列来管理所有的runnable。offer是把要执行的添加进来，在scheduleNext中取出来去执行。</span></div><div class="line">	<span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">	Runnable mActive;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">	    <span class="comment">// 终于找到了sDefaultExecutor.execute()所真正执行的部分。</span></div><div class="line">		mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">				    <span class="comment">// 就是mFuture的run方法，他会去调用mWorker.call方法，这样就会执行doInBackground方法，执行完后会把返回值用Handler发送出去</span></div><div class="line">					r.run();</div><div class="line">				&#125; <span class="keyword">finally</span> &#123;</div><div class="line">					scheduleNext();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		<span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">			scheduleNext();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">		    <span class="comment">// 去取队列中的runnable去执行，这个mActive其实就是mFuture对象。</span></div><div class="line">			THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以从<code>SerialExecutor</code>中我们能看到这就是为什么会串行的去执行了。因为他只会取队列的第一个去执行，其他的都在队列中等待。</p>
<p>但是这里<code>THREAD_POOL_EXECUTOR</code>是什么呢？　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * An &#123;<span class="doctag">@link</span> Executor&#125; that can be used to execute tasks in parallel.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR</div><div class="line">		= <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE,</div><div class="line">				TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div></pre></td></tr></table></figure></p>
<p>静态常量，也就是所不管你用多少个<code>AsyncTask</code>都会用这同一个线程池。</p>
<p>接着我们重点看一下<code>THREAD_POOL_EXECUTOR.execute(mActive)</code>:<br>因为<code>mActive</code>就是<code>mFuture = new FutureTask&lt;Result&gt;(mWorker)</code>。所以在执行<code>execute</code>方法时会执行<code>FutureTask</code>的<code>run</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (state != NEW ||</div><div class="line">		!UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, runnerOffset,</div><div class="line">									 <span class="keyword">null</span>, Thread.currentThread()))</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		Callable&lt;V&gt; c = callable;</div><div class="line">		<span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</div><div class="line">			V result;</div><div class="line">			<span class="keyword">boolean</span> ran;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">			    <span class="comment">// 他会去调用 Callable的call()方法，而上面传入的Callable参数是mWorker。所以这里就会调用mWorker的call方法。</span></div><div class="line">				<span class="comment">// 通过这里就和之前我们讲的doInBackground方法联系上了.</span></div><div class="line">				result = c.call();</div><div class="line">				ran = <span class="keyword">true</span>;</div><div class="line">			&#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">				result = <span class="keyword">null</span>;</div><div class="line">				ran = <span class="keyword">false</span>;</div><div class="line">				setException(ex);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (ran)</div><div class="line">				set(result);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="comment">// runner must be non-null until state is settled to</span></div><div class="line">		<span class="comment">// prevent concurrent calls to run()</span></div><div class="line">		runner = <span class="keyword">null</span>;</div><div class="line">		<span class="comment">// state must be re-read after nulling runner to prevent</span></div><div class="line">		<span class="comment">// leaked interrupts</span></div><div class="line">		<span class="keyword">int</span> s = state;</div><div class="line">		<span class="keyword">if</span> (s &gt;= INTERRUPTING)</div><div class="line">			handlePossibleCancellationInterrupt(s);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里就分析完了。</p>
<p>下面把完整的代码粘贴上(5.1.1):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span>&lt;<span class="title">Params</span>, <span class="title">Progress</span>, <span class="title">Result</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TAG = <span class="string">"AsyncTask"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = CPU_COUNT + <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadFactory sThreadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger mCount = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</div><div class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An &#123;<span class="doctag">@link</span> Executor&#125; that can be used to execute tasks in parallel.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR</div><div class="line">            = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE,</div><div class="line">                    TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An &#123;<span class="doctag">@link</span> Executor&#125; that executes tasks one at a time in serial</div><div class="line">     * order.  This serialization is global to a particular process.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_POST_RESULT = <span class="number">0x1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_POST_PROGRESS = <span class="number">0x2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InternalHandler sHandler;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WorkerRunnable&lt;Params, Result&gt; mWorker;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FutureTask&lt;Result&gt; mFuture;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Status mStatus = Status.PENDING;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean mCancelled = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean mTaskInvoked = <span class="keyword">new</span> AtomicBoolean();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">        Runnable mActive;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">            mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        r.run();</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        scheduleNext();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">                scheduleNext();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">                THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Indicates the current status of the task. Each status will be set only once</div><div class="line">     * during the lifetime of a task.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Status &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Indicates that the task has not been executed yet.</div><div class="line">         */</div><div class="line">        PENDING,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Indicates that the task is running.</div><div class="line">         */</div><div class="line">        RUNNING,</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Indicates that &#123;<span class="doctag">@link</span> AsyncTask#onPostExecute&#125; has finished.</div><div class="line">         */</div><div class="line">        FINISHED,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (AsyncTask.class) &#123;</div><div class="line">            <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</div><div class="line">                sHandler = <span class="keyword">new</span> InternalHandler();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sHandler;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDefaultExecutor</span><span class="params">(Executor exec)</span> </span>&#123;</div><div class="line">        sDefaultExecutor = exec;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new asynchronous task. This constructor must be invoked on the UI thread.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">        mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">                <span class="comment">//noinspection unchecked</span></div><div class="line">                <span class="keyword">return</span> postResult(doInBackground(mParams));</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    postResultIfNotInvoked(get());</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    android.util.Log.w(LOG_TAG, e);</div><div class="line">                &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occured while executing doInBackground()"</span>,</div><div class="line">                            e.getCause());</div><div class="line">                &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                    postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postResultIfNotInvoked</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> wasTaskInvoked = mTaskInvoked.get();</div><div class="line">        <span class="keyword">if</span> (!wasTaskInvoked) &#123;</div><div class="line">            postResult(result);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">                <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">        message.sendToTarget();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the current status of this task.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> The current status.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Status <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mStatus;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Override this method to perform a computation on a background thread. The</div><div class="line">     * specified parameters are the parameters passed to &#123;<span class="doctag">@link</span> #execute&#125;</div><div class="line">     * by the caller of this task.</div><div class="line">     *</div><div class="line">     * This method can call &#123;<span class="doctag">@link</span> #publishProgress&#125; to publish updates</div><div class="line">     * on the UI thread.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> params The parameters of the task.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> A result, defined by the subclass of this task.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onPreExecute()</div><div class="line">     * <span class="doctag">@see</span> #onPostExecute</div><div class="line">     * <span class="doctag">@see</span> #publishProgress</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Result <span class="title">doInBackground</span><span class="params">(Params... params)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Runs on the UI thread before &#123;<span class="doctag">@link</span> #doInBackground&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onPostExecute</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;p&gt;Runs on the UI thread after &#123;<span class="doctag">@link</span> #doInBackground&#125;. The</div><div class="line">     * specified result is the value returned by &#123;<span class="doctag">@link</span> #doInBackground&#125;.&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * &lt;p&gt;This method won't be invoked if the task was cancelled.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> result The result of the operation computed by &#123;<span class="doctag">@link</span> #doInBackground&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onPreExecute</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     * <span class="doctag">@see</span> #onCancelled(Object) </div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedDeclaration"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Runs on the UI thread after &#123;<span class="doctag">@link</span> #publishProgress&#125; is invoked.</div><div class="line">     * The specified values are the values passed to &#123;<span class="doctag">@link</span> #publishProgress&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> values The values indicating progress.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #publishProgress</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedDeclaration"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;p&gt;Runs on the UI thread after &#123;<span class="doctag">@link</span> #cancel(boolean)&#125; is invoked and</div><div class="line">     * &#123;<span class="doctag">@link</span> #doInBackground(Object[])&#125; has finished.&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * &lt;p&gt;The default implementation simply invokes &#123;<span class="doctag">@link</span> #onCancelled()&#125; and</div><div class="line">     * ignores the result. If you write your own implementation, do not call</div><div class="line">     * &lt;code&gt;super.onCancelled(result)&lt;/code&gt;.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> result The result, if any, computed in</div><div class="line">     *               &#123;<span class="doctag">@link</span> #doInBackground(Object[])&#125;, can be null</div><div class="line">     * </div><div class="line">     * <span class="doctag">@see</span> #cancel(boolean)</div><div class="line">     * <span class="doctag">@see</span> #isCancelled()</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"UnusedParameters"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCancelled</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        onCancelled();</div><div class="line">    &#125;    </div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;p&gt;Applications should preferably override &#123;<span class="doctag">@link</span> #onCancelled(Object)&#125;.</div><div class="line">     * This method is invoked by the default implementation of</div><div class="line">     * &#123;<span class="doctag">@link</span> #onCancelled(Object)&#125;.&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * &lt;p&gt;Runs on the UI thread after &#123;<span class="doctag">@link</span> #cancel(boolean)&#125; is invoked and</div><div class="line">     * &#123;<span class="doctag">@link</span> #doInBackground(Object[])&#125; has finished.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onCancelled(Object) </div><div class="line">     * <span class="doctag">@see</span> #cancel(boolean)</div><div class="line">     * <span class="doctag">@see</span> #isCancelled()</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCancelled</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns &lt;tt&gt;true&lt;/tt&gt; if this task was cancelled before it completed</div><div class="line">     * normally. If you are calling &#123;<span class="doctag">@link</span> #cancel(boolean)&#125; on the task,</div><div class="line">     * the value returned by this method should be checked periodically from</div><div class="line">     * &#123;<span class="doctag">@link</span> #doInBackground(Object[])&#125; to end the task as soon as possible.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> &lt;tt&gt;true&lt;/tt&gt; if task was cancelled before it completed</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #cancel(boolean)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mCancelled.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &lt;p&gt;Attempts to cancel execution of this task.  This attempt will</div><div class="line">     * fail if the task has already completed, already been cancelled,</div><div class="line">     * or could not be cancelled for some other reason. If successful,</div><div class="line">     * and this task has not started when &lt;tt&gt;cancel&lt;/tt&gt; is called,</div><div class="line">     * this task should never run. If the task has already started,</div><div class="line">     * then the &lt;tt&gt;mayInterruptIfRunning&lt;/tt&gt; parameter determines</div><div class="line">     * whether the thread executing this task should be interrupted in</div><div class="line">     * an attempt to stop the task.&lt;/p&gt;</div><div class="line">     * </div><div class="line">     * &lt;p&gt;Calling this method will result in &#123;<span class="doctag">@link</span> #onCancelled(Object)&#125; being</div><div class="line">     * invoked on the UI thread after &#123;<span class="doctag">@link</span> #doInBackground(Object[])&#125;</div><div class="line">     * returns. Calling this method guarantees that &#123;<span class="doctag">@link</span> #onPostExecute(Object)&#125;</div><div class="line">     * is never invoked. After invoking this method, you should check the</div><div class="line">     * value returned by &#123;<span class="doctag">@link</span> #isCancelled()&#125; periodically from</div><div class="line">     * &#123;<span class="doctag">@link</span> #doInBackground(Object[])&#125; to finish the task as early as</div><div class="line">     * possible.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> mayInterruptIfRunning &lt;tt&gt;true&lt;/tt&gt; if the thread executing this</div><div class="line">     *        task should be interrupted; otherwise, in-progress tasks are allowed</div><div class="line">     *        to complete.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> &lt;tt&gt;false&lt;/tt&gt; if the task could not be cancelled,</div><div class="line">     *         typically because it has already completed normally;</div><div class="line">     *         &lt;tt&gt;true&lt;/tt&gt; otherwise</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #isCancelled()</div><div class="line">     * <span class="doctag">@see</span> #onCancelled(Object)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</div><div class="line">        mCancelled.set(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> mFuture.cancel(mayInterruptIfRunning);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Waits if necessary for the computation to complete, and then</div><div class="line">     * retrieves its result.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> The computed result.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> CancellationException If the computation was cancelled.</div><div class="line">     * <span class="doctag">@throws</span> ExecutionException If the computation threw an exception.</div><div class="line">     * <span class="doctag">@throws</span> InterruptedException If the current thread was interrupted</div><div class="line">     *         while waiting.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Result <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">        <span class="keyword">return</span> mFuture.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Waits if necessary for at most the given time for the computation</div><div class="line">     * to complete, and then retrieves its result.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> timeout Time to wait before cancelling the operation.</div><div class="line">     * <span class="doctag">@param</span> unit The time unit for the timeout.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> The computed result.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> CancellationException If the computation was cancelled.</div><div class="line">     * <span class="doctag">@throws</span> ExecutionException If the computation threw an exception.</div><div class="line">     * <span class="doctag">@throws</span> InterruptedException If the current thread was interrupted</div><div class="line">     *         while waiting.</div><div class="line">     * <span class="doctag">@throws</span> TimeoutException If the wait timed out.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Result <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException,</span></div><div class="line">            ExecutionException, TimeoutException &#123;</div><div class="line">        <span class="keyword">return</span> mFuture.get(timeout, unit);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Executes the task with the specified parameters. The task returns</div><div class="line">     * itself (this) so that the caller can keep a reference to it.</div><div class="line">     * </div><div class="line">     * &lt;p&gt;Note: this function schedules the task on a queue for a single background</div><div class="line">     * thread or pool of threads depending on the platform version.  When first</div><div class="line">     * introduced, AsyncTasks were executed serially on a single background thread.</div><div class="line">     * Starting with &#123;<span class="doctag">@link</span> android.os.Build.VERSION_CODES#DONUT&#125;, this was changed</div><div class="line">     * to a pool of threads allowing multiple tasks to operate in parallel. Starting</div><div class="line">     * &#123;<span class="doctag">@link</span> android.os.Build.VERSION_CODES#HONEYCOMB&#125;, tasks are back to being</div><div class="line">     * executed on a single thread to avoid common application errors caused</div><div class="line">     * by parallel execution.  If you truly want parallel execution, you can use</div><div class="line">     * the &#123;<span class="doctag">@link</span> #executeOnExecutor&#125; version of this method</div><div class="line">     * with &#123;<span class="doctag">@link</span> #THREAD_POOL_EXECUTOR&#125;; however, see commentary there for warnings</div><div class="line">     * on its use.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;This method must be invoked on the UI thread.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> params The parameters of the task.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> This instance of AsyncTask.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException If &#123;<span class="doctag">@link</span> #getStatus()&#125; returns either</div><div class="line">     *         &#123;<span class="doctag">@link</span> AsyncTask.Status#RUNNING&#125; or &#123;<span class="doctag">@link</span> AsyncTask.Status#FINISHED&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #executeOnExecutor(java.util.concurrent.Executor, Object[])</div><div class="line">     * <span class="doctag">@see</span> #execute(Runnable)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">		<span class="comment">// 这里就多插一嘴了。 sDefaultExecutor在上面我们分析过了，就是一个队列来保证串行进行。从3.0开始都是这样。</span></div><div class="line">		<span class="comment">// 那在1.6到3.0之间是怎么并行执行的呢？　按照下面的方式改就可以了</span></div><div class="line">		<span class="comment">// return executeOnExecutor(THREAD_POOL_EXECUTOR, params);</span></div><div class="line">		<span class="comment">// 就是将sDefaultExecutor改成THREAD_POOL_EXECUTOR， THREAD_POOL_EXECUTOR就是线程池。</span></div><div class="line">		<span class="comment">// new ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE, TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</span></div><div class="line">		<span class="comment">// 原来的CORE_POOL_SIZE是5, KEEP_ALIVE是10, MAXIMUM_POOL_SIZE是128</span></div><div class="line">		<span class="comment">// 也就是说可以同时执行的线程是5个，如果超过5个后，超过的部分就会放到缓存队列中，如果超过了128那就挂了</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Executes the task with the specified parameters. The task returns</div><div class="line">     * itself (this) so that the caller can keep a reference to it.</div><div class="line">     * </div><div class="line">     * &lt;p&gt;This method is typically used with &#123;<span class="doctag">@link</span> #THREAD_POOL_EXECUTOR&#125; to</div><div class="line">     * allow multiple tasks to run in parallel on a pool of threads managed by</div><div class="line">     * AsyncTask, however you can also use your own &#123;<span class="doctag">@link</span> Executor&#125; for custom</div><div class="line">     * behavior.</div><div class="line">     * </div><div class="line">     * &lt;p&gt;&lt;em&gt;Warning:&lt;/em&gt; Allowing multiple tasks to run in parallel from</div><div class="line">     * a thread pool is generally &lt;em&gt;not&lt;/em&gt; what one wants, because the order</div><div class="line">     * of their operation is not defined.  For example, if these tasks are used</div><div class="line">     * to modify any state in common (such as writing a file due to a button click),</div><div class="line">     * there are no guarantees on the order of the modifications.</div><div class="line">     * Without careful work it is possible in rare cases for the newer version</div><div class="line">     * of the data to be over-written by an older one, leading to obscure data</div><div class="line">     * loss and stability issues.  Such changes are best</div><div class="line">     * executed in serial; to guarantee such work is serialized regardless of</div><div class="line">     * platform version you can use this function with &#123;<span class="doctag">@link</span> #SERIAL_EXECUTOR&#125;.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;This method must be invoked on the UI thread.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> exec The executor to use.  &#123;<span class="doctag">@link</span> #THREAD_POOL_EXECUTOR&#125; is available as a</div><div class="line">     *              convenient process-wide thread pool for tasks that are loosely coupled.</div><div class="line">     * <span class="doctag">@param</span> params The parameters of the task.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> This instance of AsyncTask.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException If &#123;<span class="doctag">@link</span> #getStatus()&#125; returns either</div><div class="line">     *         &#123;<span class="doctag">@link</span> AsyncTask.Status#RUNNING&#125; or &#123;<span class="doctag">@link</span> AsyncTask.Status#FINISHED&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #execute(Object[])</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">            Params... params) &#123;</div><div class="line">        <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">            <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">                <span class="keyword">case</span> RUNNING:</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                            + <span class="string">" the task is already running."</span>);</div><div class="line">                <span class="keyword">case</span> FINISHED:</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                            + <span class="string">" the task has already been executed "</span></div><div class="line">                            + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mStatus = Status.RUNNING;</div><div class="line"></div><div class="line">        onPreExecute();</div><div class="line"></div><div class="line">        mWorker.mParams = params;</div><div class="line">        exec.execute(mFuture);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Convenience version of &#123;<span class="doctag">@link</span> #execute(Object...)&#125; for use with</div><div class="line">     * a simple Runnable object. See &#123;<span class="doctag">@link</span> #execute(Object[])&#125; for more</div><div class="line">     * information on the order of execution.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #execute(Object[])</div><div class="line">     * <span class="doctag">@see</span> #executeOnExecutor(java.util.concurrent.Executor, Object[])</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable)</span> </span>&#123;</div><div class="line">        sDefaultExecutor.execute(runnable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This method can be invoked from &#123;<span class="doctag">@link</span> #doInBackground&#125; to</div><div class="line">     * publish updates on the UI thread while the background computation is</div><div class="line">     * still running. Each call to this method will trigger the execution of</div><div class="line">     * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; on the UI thread.</div><div class="line">     *</div><div class="line">     * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; will not be called if the task has been</div><div class="line">     * canceled.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> values The progress values to update the UI with.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onProgressUpdate</div><div class="line">     * <span class="doctag">@see</span> #doInBackground</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">            getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                    <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">            onCancelled(result);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            onPostExecute(result);</div><div class="line">        &#125;</div><div class="line">        mStatus = Status.FINISHED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                    <span class="comment">// There is only one result</span></div><div class="line">                    result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                    result.mTask.onProgressUpdate(result.mData);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</div><div class="line">        Params[] mParams;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskResult</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> AsyncTask mTask;</div><div class="line">        <span class="keyword">final</span> Data[] mData;</div><div class="line"></div><div class="line">        AsyncTaskResult(AsyncTask task, Data... data) &#123;</div><div class="line">            mTask = task;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AsyncTask详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Github个人主页绑定域名" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Github个人主页绑定域名/">Github个人主页绑定域名</a>
    </h1>
  

        
        <a href="/2015/01/01/Github个人主页绑定域名/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Github个人主页绑定域名"><a href="#Github个人主页绑定域名" class="headerlink" title="Github个人主页绑定域名"></a>Github个人主页绑定域名</h1><p><code>Github</code>虽然很好，可毕竟是免费的，还是有不少限制的。写到这里，特意去看了下<code>Github</code>对免费用户究竟有什么限制。发现除了300M的空间限制（还是所谓软限制），没有其他限制。所以用它来作为博客平台，真是再理想不过了。</p>
<h2 id="创建步骤"><a href="#创建步骤" class="headerlink" title="创建步骤"></a>创建步骤</h2><ol>
<li><p>建立一个博客<code>repository</code><br> 建立一个命名为<code>username.github.io</code>的<code>repository</code>, <code>username</code>就是你在<code>Github</code>上的用户名或机构名</p>
</li>
<li><p>增加主页<br> <code>clone</code>该<code>repository</code>到本地，增加<code>index.html</code></p>
</li>
<li><p>提交<br> <code>commit</code>并且<code>push</code>该次修改。</p>
</li>
<li><p>OK<br> 打开浏览器输入 <code>username.github.io</code> 即可。注意提交之后可能需要一小段时间的延迟。</p>
</li>
</ol>
<h2 id="绑定域名"><a href="#绑定域名" class="headerlink" title="绑定域名"></a>绑定域名</h2><ol>
<li>在<code>repository</code>根目录新建<code>CNAME</code>文件, 内容为<code>xxx.com</code>(要绑定的域名),然后<code>commit</code>、<code>push</code>.</li>
<li>在自己的域名管理页面中,进入域名解析.<br> <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/bindhost.jpg?raw=true" alt="image"><br> <strong>注意记录值 <code>username.github.io.</code> (最后面有一个.)</strong></li>
</ol>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Github</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Github个人主页绑定域名/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Gradle专题" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Gradle专题/">Gradle专题</a>
    </h1>
  

        
        <a href="/2015/01/01/Gradle专题/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Gradle专题"><a href="#Gradle专题" class="headerlink" title="Gradle专题"></a>Gradle专题</h1><p>随着<code>Google</code>对<code>Eclipse</code>的无情抛弃以及<code>Studio</code>的不断壮大，<code>Android</code>开发者逐渐拜倒在<code>Studio</code>的石榴裙下。<br>而作为<code>Studio</code>的默认编译方式，<code>Gradle</code>已逐渐普及。我最开始是被它的多渠道打包所吸引。关于多渠道打包，请看之前我写的文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%9F%BA%E7%A1%80/AndroidStudio%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B(%E7%AC%AC%E4%B8%83%E5%BC%B9">AndroidStudio使用教程(第七弹)</a>.md)</p>
<p>接下来我们就系统的学习一下<code>Gradle</code>。    </p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>Gradle</code>是以<code>Groovy</code>语言为基础，面向<code>Java</code>应用为主。基于<code>DSL(Domain Specific Language)</code>语法的自动化构建工具。</p>
<p><code>Gradle</code>集合了<code>Ant</code>的灵活性和强大功能，同时也集合了<code>Maven</code>的依赖管理和约定，从而创造了一个更有效的构建方式。凭借<code>Groovy</code>的<code>DSL</code>和创新打包方式，<code>Gradle</code>提供了一个可声明的方式，并在合理默认值的基础上描述所有类型的构建。 <code>Gradle</code>目前已被选作许多开源项目的构建系统。</p>
<p>因为<code>Gradle</code>是基于<code>DSL</code>语法的，如果想看到<code>build.gradle</code>文件中全部可以选项的配置，可以看这里<br><a href="http://google.github.io/android-gradle-dsl/current/" target="_blank" rel="external">DSL Reference</a></p>
<h2 id="基本的项目设置"><a href="#基本的项目设置" class="headerlink" title="基本的项目设置"></a>基本的项目设置</h2><p>一个<code>Gradle</code>项目通过一个在项目根目录中的<code>build.gradle</code>文件来描述它的构建。</p>
<p>###简单的<code>Build</code>文件</p>
<p>最简单的<code>Android</code>应用中的<code>build.gradle</code>都会包含以下几个配置：<br><code>Project</code>根目录的<code>build.gradle</code>:       </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath &apos;com.android.tools.build:gradle:1.5.0&apos;</div><div class="line"></div><div class="line">        // NOTE: Do not place your application dependencies here; they belong</div><div class="line">        // in the individual module build.gradle files</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Module</code>中的<code>build.gradle</code>:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 23</div><div class="line">    buildToolsVersion &quot;23.0.3&quot;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>buildscript { ... }</code>配置了编译时的代码驱动. 这种情况下，它声明所使用的是<code>jCenter</code>仓库。还有一个声明所依赖的在<code>Maven</code>文件的路径。这里声明的包含了<code>Android</code>插件所使用的1.5.0版本的<code>Gradle</code>. <strong><em>注意:</em></strong>这只会影响<code>build</code>中运行的代码，不是项目中。项目中需要声明它自己所需要仓库和依赖关系。</li>
<li><code>apply plugin : com.android.application</code>，声明使用<code>com.androdi.application</code>插件。这是构建<code>Android</code>应用所需要的插件。</li>
<li><code>android{...}</code>配置了所有<code>Android</code>构建时的参数。默认情况下，只有编译的目标版本以及编译工具的版本是需要的。</li>
</ul>
<p>重要: 这里只能使用<code>com.android.application</code>插件。如果使用<code>java</code>插件将会报错。</p>
<p>###目录结构<br><code>module/src/main</code>下的目录结构，因为有时候很多人把<code>so</code>放到<code>libs</code>目录就会报错:    </p>
<ul>
<li>java/</li>
<li>res/</li>
<li>AndroidManifest.xml</li>
<li>assets/</li>
<li>aidl/  </li>
<li>jniLibs/</li>
<li>jni/  </li>
<li>rs/</li>
</ul>
<p>###配置目录结构<br>如果项目的结构不标准的时候，可能就需要去配置它。<code>Android</code>插件使用了相似的语法，但是因为它有自己的<code>sourceSets</code>，所以要在<code>android</code>代码块中进行配置。下面就是一个从<code>Eclipse</code>的老项目结构中配置主要代码并且将<code>androidTest</code>的<code>sourceSet</code>设置给<code>tests</code>目录的例子:     </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    sourceSets &#123;</div><div class="line">        main &#123;</div><div class="line">            manifest.srcFile &apos;AndroidManifest.xml&apos;</div><div class="line">            java.srcDirs = [&apos;src&apos;]</div><div class="line">            resources.srcDirs = [&apos;src&apos;]</div><div class="line">            aidl.srcDirs = [&apos;src&apos;]</div><div class="line">            renderscript.srcDirs = [&apos;src&apos;]</div><div class="line">            res.srcDirs = [&apos;res&apos;]</div><div class="line">            assets.srcDirs = [&apos;assets&apos;]</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        androidTest.setRoot(&apos;tests&apos;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就像有些人就是要把<code>so</code>放到<code>libs</code>目录中(这类人有点犟)，那就需要这样进行修改。<br><strong><em>注意:</em></strong>因为在旧的项目结构中所有的源文件(<code>Java</code>,<code>AIDL</code>和<code>RenderScript</code>)都放到同一个目录中，我们需要将<code>sourceSet</code>中的这些新部件都设置给<code>src</code>目录。</p>
<h2 id="Build-Tasks"><a href="#Build-Tasks" class="headerlink" title="Build Tasks"></a>Build Tasks</h2><p>对构建文件声明插件时通常或自动创建一些列的构建任务去执行。不管<code>Java</code>插件还是<code>Android</code>插件都是这样。<code>Android</code>常规的任务如下：    </p>
<ul>
<li><code>assemble</code>生成项目<code>output</code>目录中的内容的任务。</li>
<li><code>check</code>执行所有的检查的任务。</li>
<li><code>build</code>执行<code>assemble</code>和<code>check</code>的任务。</li>
<li><code>clean</code>清理项目<code>output</code>目录的任务。</li>
</ul>
<p>在<code>Android</code>项目中至少会有两种<code>output</code>输出:一个<code>debug apk</code>和一个<code>release apk</code>。他们都有自己的主任务来分别执行构建:    </p>
<ul>
<li><code>assemble</code><ul>
<li><code>assembleDebug</code></li>
<li><code>assembleRelease</code>  </li>
</ul>
</li>
</ul>
<p><strong><em>提示:</em></strong><code>Gradle</code>支持通过命令行执行任务首字母缩写的方式。例如:<br>在没有其他任务符合<code>aR</code>的前提下，<code>gradle aR</code>与<code>gradle assembleRelease</code>是相同的。</p>
<p>最后，构建插件创建了为所有<code>build type(debug, release, test)</code>类型安装和卸载的任务，只要他们能被安装(需要签名)。</p>
<ul>
<li><code>installDebug</code></li>
<li><code>installRelease</code></li>
<li><code>uninstallAll</code><ul>
<li><code>uninstallDebug</code></li>
<li><code>uninstallRelease</code></li>
<li><code>uninstallDebugAndroidTest</code></li>
</ul>
</li>
</ul>
<p>###基本的<code>Build</code>定制</p>
<p><code>Android</code>插件提供了一些列的<code>DSL</code>来让直接从构建系统中做大部分的定制。</p>
<p>#####<code>Manifest</code>整体部分<br><code>DSL</code>提供了很多重要的配置<code>manifest</code>文件的参数，例如:     </p>
<ul>
<li><code>minSdkVersion</code></li>
<li><code>targetSdkVersion</code></li>
<li><code>versionCode</code></li>
<li><code>versionName</code></li>
<li><code>applicationId</code></li>
<li><code>testApplicationId</code></li>
<li><code>testInstrumentationRunnder</code></li>
</ul>
<p><a href="http://google.github.io/android-gradle-dsl/current/" target="_blank" rel="external">Android Plugin DSL Reference</a>提供了一个完整的构建参数列表。</p>
<p>把这些<code>manifest</code>属性放到<code>build</code>文件中的一个重要功能就是它可以被动态的设置。例如，可以通过读取一个文件或者其他逻辑来获取版本名称。     </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def computeVersionName() &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 23</div><div class="line">    buildToolsVersion &quot;23.0.1&quot;</div><div class="line"></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        versionCode 12 </div><div class="line">        versionName computeVersionName()</div><div class="line">        minSdkVersion 16</div><div class="line">        targetSdkVersion 23</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><em>注意:</em></strong>不要使用可能与现有给定冲突的方法名。例如<code>defaultConfig{...}</code>中使用<code>getVersionName()</code>方法将会自动使用<code>defaultConfig.getVersionName()</code>来带起自定义的方法。</p>
<p>#####<code>Build Types</code></p>
<p>默认情况下<code>Android</code>插件会自动将应用程序设置成有一个<code>debug</code>版本和一个<code>release</code>版本。<br>这就是通过调用<code>BuildType</code>对象完成。默认情况下会创建两个实例，一个<code>debug</code>实例和一个<code>release</code>实例。<code>Android</code>插件同样允许通过其他的<code>Build Types</code>来定制其他的实例。这就是通过<code>buildTypes</code>来设置的:     </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    buildTypes &#123;</div><div class="line">        debug &#123;</div><div class="line">            applicationIdSuffix &quot;.debug&quot;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        jnidebug &#123;</div><div class="line">            initWith(buildTypes.debug)</div><div class="line">            applicationIdSuffix &quot;.jnidebug&quot;</div><div class="line">            jniDebuggable true</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码执行了以下操作:     </p>
<ul>
<li>配置了默认<code>debug</code>的<code>Build Type</code>:     <ul>
<li>设置了它的<code>applicationId</code>。这样<code>debug</code>模式就能与<code>release</code>模式的<code>apk</code>同时安装在同一手机上。</li>
</ul>
</li>
<li>创建了一个新的<code>jnidebug</code>的<code>Build Type</code>，并且把它设置为<code>debug</code>的拷贝。</li>
<li>通过允许<code>JNI</code>组件的<code>debug</code>和增加一个新的包名后缀来继续定制该<code>Build Type</code>。  </li>
</ul>
<p>不管使用<code>initWith()</code>还是使用其他的代码块，创建一个新的<code>Build Types</code>都是非常简单的在<code>buildTypes</code>代码块中创建一个新的元素就可以了。</p>
<p>#####签名配置</p>
<p>为应用签名需要使用如下几个部分:      </p>
<ul>
<li><code>A keystore</code></li>
<li><code>A keystore password</code></li>
<li><code>A key alias name</code></li>
<li><code>A key password</code></li>
<li><code>The store type</code></li>
</ul>
<p>默认情况下有一个<code>debug</code>的配置，设置了一个<code>debug</code>的<code>keystore</code>，有一个已知的密码。<code>debug keystore</code>的位置是在<code>$HOME/.android/debug.keystore</code>，如果没有的话他会被默认创建。<code>Debug</code>的<code>Build Type</code>会默认使用该<code>debug</code>的签名设置。</p>
<p>当然也可以通过使用<code>DSL</code>语法中的<code>signingconfigs</code>部分来创建其他的配置来进行定制:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    signingConfigs &#123;</div><div class="line">        debug &#123;</div><div class="line">            storeFile file(&quot;debug.keystore&quot;)</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        myConfig &#123;</div><div class="line">            storeFile file(&quot;other.keystore&quot;)</div><div class="line">            storePassword &quot;android&quot;</div><div class="line">            keyAlias &quot;androiddebugkey&quot;</div><div class="line">            keyPassword &quot;android&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    buildTypes &#123;</div><div class="line">        foo &#123;</div><div class="line">            signingConfig signingConfigs.myConfig</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的设置将把<code>debug keystore</code>的位置改为项目的根目录。同样也创建了一个新的签名配置，并且有一个新的<code>Build Type</code>使用它。</p>
<p>###<code>Dependencies, Android Libraries and Multi-project setup</code></p>
<p><code>Gradle</code>项目可以依赖其他的外部二进制包、或者其他的<code>Gradle</code>项目。</p>
<h5 id="本地包"><a href="#本地包" class="headerlink" title="本地包"></a>本地包</h5><p>想要配置依赖一个外部<code>jar</code>包，需要在<code>compile</code>的配置中添加一个<code>dependency</code>。下面的配置是添加了所有在<code>libs</code>目录的<code>jar</code>包:   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><em>注意:</em></strong><code>DSL</code>元素中的<code>dependencies</code>是<code>Gradle API</code>中的标准元素。不属于<code>andorid</code>元素。<br><code>compile</code>配置是用来编译主应用的。它配置的所有部分都会被打包到<code>apk</code>中。当然也有一些其他的配置:      </p>
<ul>
<li><code>compile</code>: <code>main application</code></li>
<li><code>androidTestCompile</code>:<code>test application</code></li>
<li><code>debugCompile</code>:<code>debug Build Type</code></li>
<li><code>release Compile</code>:<code>release Build Type</code></li>
</ul>
<p>当然我们可以使用<code>compile</code>和<code>&lt;buildtype&gt;.compile</code>这两种配置。创建一个新的<code>Build Type</code>通常会自动基于它的名字创建一个新的配置部分。这样在像<code>debug</code>版本而<code>release</code>版本不适用的一些特别的<code>library</code>时非常有用。</p>
<p>#####远程仓库</p>
<p><code>Gradle</code>只是使用<code>Maven</code>和<code>Ivy</code>仓库。但是仓库必须要添加到列表中，并且必须声明所依赖仓库的<code>Maven</code>或者<code>Ivy</code>定义。      </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">repositories &#123;</div><div class="line">     jcenter()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.google.guava:guava:18.0&apos;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><em>注意: </em></strong><code>jcenter()</code>是指定仓库<code>URL</code>的快捷设置。<code>Gradle</code>支持远程和本地仓库。<br><strong><em>注意: </em></strong><code>Gradle</code>会直接识别所有的依赖关系。这就意味着如果一个依赖库自身又依赖别的库时，他们会被一起下下来。</p>
<p>#####本地<code>AAR</code>库     </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">	compile(name:&apos;本地aar库的名字，不用加后缀&apos;, ext:&apos;aar&apos;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#####多项目设置      </p>
<p><code>Gradle</code>项目通常使用多项目设置来依赖其他的<code>gradle</code>项目。例如:      </p>
<ul>
<li>MyProject/         <ul>
<li>app/          </li>
<li>libraries/        <ul>
<li>lib1/           </li>
<li>lib2/     </li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>Gradle</code>会通过下面的名字来引用他们：<br><code>:app</code><br><code>:libraries:lib1</code><br><code>:libraries:lib2</code>      </p>
<p>每个项目都会有一个单独的<code>build</code>文件，并且在项目的根目录还会有一个<code>setting.gradle</code>文件：    </p>
<ul>
<li>MyProject/         <ul>
<li>settings.gradle         </li>
<li>app/      <ul>
<li>build.gradle       </li>
</ul>
</li>
</ul>
<ul>
<li>libraries/      <ul>
<li>lib1/       <ul>
<li>build.gradle      </li>
</ul>
</li>
<li>lib2/      <ul>
<li>build.gradle      </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>setting.gradle</code>文件中的内容非常简单。它指定了哪个目录是<code>Gralde</code>项目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">include &apos;:app&apos;, &apos;:libraries:lib1&apos;, &apos;:libraries:lib2&apos;</div></pre></td></tr></table></figure></p>
<p><code>：app</code>这个项目可能会依赖其他的<code>libraries</code>，这样可以通过如下进行声明:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">     compile project(&apos;:libraries:lib1&apos;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###<code>Library</code>项目</p>
<p>上面用到了<code>:libraries:lib1</code>和<code>:libraries:lib2</code>可以是<code>Java</code>项目，<code>:app</code>项目会使用他们俩的输出的<code>jar</code>包。但是如果你需要使用<code>android</code>资源等，这些<code>libraries</code>就不能是普通的<code>Java</code>项目了，他们必须是<code>Android Library</code>项目。    </p>
<p>#####创建一个<code>Library</code>项目      </p>
<p><code>Library</code>项目和普通的<code>Android</code>项目的区别比较少，由于<code>libraries</code>的构建类型与应用程序的构建不同，所有它会使用一个别的构建插件。但是他们所使用的插件内部有很多相同的代码，他们都是由<code>com.android.tools.build.gradle</code>这个<code>jar</code>包提供的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">        classpath &apos;com.android.tools.build:gradle:1.3.1&apos;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">apply plugin: &apos;com.android.library&apos;</div><div class="line"></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 23</div><div class="line">    buildToolsVersion &quot;23.0.1&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#####普通项目与<code>Library</code>项目的区别       </p>
<p><code>Library</code>项目的主要输出我<code>.aar</code>包。它结合了代码(例如<code>jar</code>包或者本地<code>.so</code>文件)和资源(<code>manifest</code>,<code>res</code>,<code>assets</code>)。每个<code>library</code>也可以单独设置<code>Build Type</code>等来指定生成不同版本的<code>aar</code>。</p>
<p>###<code>Lint Support</code></p>
<p>你可以通过指定对应的变量来设置<code>lint</code>的运行。可以通过添加<code>lintOptions</code>来进行配置:      </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    lintOptions &#123;</div><div class="line">        // turn off checking the given issue id&apos;s</div><div class="line">        disable &apos;TypographyFractions&apos;,&apos;TypographyQuotes&apos;</div><div class="line"></div><div class="line">        // turn on the given issue id&apos;s</div><div class="line">        enable &apos;RtlHardcoded&apos;,&apos;RtlCompat&apos;, &apos;RtlEnabled&apos;</div><div class="line"></div><div class="line">        // check *only* the given issue id&apos;s</div><div class="line">        check &apos;NewApi&apos;, &apos;InlinedApi&apos;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###<code>Build</code>变量</p>
<p>构建系统的一个目标就是能对同一个应用创建多个不同的版本。    </p>
<p>#####<code>Product flavors</code>    </p>
<p>一个<code>product flavor</code>可以针对一个项目制定不同的构建版本。一个应用可以有多个不同的<code>falvors</code>来改变生成的应用。<br><code>Product flavors</code>是通过<code>DSL</code>语法中的<code>productFlavors</code>来声明的:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ....</div><div class="line"></div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        flavor1 &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        flavor2 &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>#####<code>Build Type + Product Flavor = Build Variant</code></p>
<p>像我们之前看到的，每个<code>Build Type</code>都会生成一个<code>apk</code>.<code>Product Flavors</code>也是同样的：项目的输出僵尸所有<code>Build Types</code>与<code>Product Flavors</code>的结合。每种结合方式称之为<code>Build Variant</code>。例如，如果有<code>debug</code>和<code>release</code>版本的<code>Build Types</code>，上面的例子就会生成4种<code>Build Variants</code>：    </p>
<ul>
<li><code>Flavor1</code> - <code>debug</code></li>
<li><code>Flavor1</code> - <code>release</code></li>
<li><code>Flavor2</code> - <code>debug</code></li>
<li><code>Flavor2</code> - <code>release</code></li>
</ul>
<p>没有配置<code>flavors</code>的项目仍然有<code>Build Variants</code>，它只是用了一个默认的<code>flavor/config</code>，没有名字，这导致<code>variants</code>的列表和<code>Build Types</code>的列表比较相同。</p>
<p>#####<code>Product Flavor</code>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion 8</div><div class="line">        versionCode 10</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        flavor1 &#123;</div><div class="line">            applicationId &quot;com.example.flavor1&quot;</div><div class="line">            versionCode 20</div><div class="line">         &#125;</div><div class="line"></div><div class="line"></div><div class="line">         flavor2 &#123;</div><div class="line">             applicationId &quot;com.example.flavor2&quot;</div><div class="line">             minSdkVersion 14</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意<code>android.productFlavors.*</code>对象<code>ProductFlavor</code>有<code>android.defaultConfig</code>是相同的类型。这就意味着他们有相同的属性。<br><code>defaultConfig</code>为所有的<code>flavors</code>提供了一些基本的配置，每个<code>flavor</code>都已重写他们。在上面的例子中，这些配置有:       </p>
<ul>
<li><code>flavor1</code>        <ul>
<li><code>applicationId</code>: <code>com.example.flavor1</code>      </li>
<li><code>minSdkVersion</code>: 8       </li>
<li><code>versionCode</code>: 20</li>
</ul>
</li>
<li><code>flavor2</code>    <ul>
<li><code>applicationId</code>: <code>com.example.flavor2</code>      </li>
<li><code>minSdkVersion</code>: 14       </li>
<li><code>versionCode</code>: 10       </li>
</ul>
</li>
</ul>
<p>通常，<code>Build Type</code>配置会覆盖其他的配置。例如，<code>Build Type</code>的<code>applicationIdSuffix</code>会添加到<code>Product Flavor</code>的<code>applicationId</code>上。</p>
<p>最后，就像<code>Build Types</code>一样，<code>Product Flavors</code>也可以有他们自己的依赖关系。例如，如果有一个单独的<code>flavors</code>会使用一些广告或者支付，那这个<code>flavors</code>生成的<code>apk</code>就会使用广告的依赖，而其他的<code>flavors</code>就不需要使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    flavor1Compile &quot;...&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###<code>BuildConfig</code>      </p>
<p>在编译阶段，<code>Android Studio</code>会生成一个叫做<code>BuildConfig</code>的类，该类包含了编译时使用的一些变量的值。你可以观看这些值来改变不同变量的行为:       </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private void javaCode() &#123;</div><div class="line">    if (BuildConfig.FLAVOR.equals(&quot;paidapp&quot;)) &#123;</div><div class="line">        doIt();</div><div class="line">    else &#123;</div><div class="line">        showOnlyInPaidAppDialog();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是<code>BuildConfig</code>中包含的一些值:      </p>
<ul>
<li><code>boolean DEBUG</code> - <code>if the build is debuggable</code>      </li>
<li><code>int VERSION_CODE</code> </li>
<li><code>String VERSION_NAME</code></li>
<li><code>String APPLICATION_ID</code></li>
<li><code>String BUILD_TYPE</code>- <code>Build Type</code>的名字，例如<code>release</code>      </li>
<li><code>String FLAVOR</code> - <code>flavor</code>的名字，例如<code>flavor1</code>      </li>
</ul>
<p>###<code>ProGuard</code>配置      </p>
<p><code>Android</code>插件默认会使用<code>ProGuard</code>插件，并且如果<code>Build Type</code>中使用<code>ProGuard</code>的<code>minifyEnabled</code>属性开启的话，会默认创建对应的<code>task</code>。   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled true</div><div class="line">            proguardFile getDefaultProguardFile(&apos;proguard-android.txt&apos;)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        flavor1 &#123;</div><div class="line">        &#125;</div><div class="line">        flavor2 &#123;</div><div class="line">            proguardFile &apos;some-other-rules.txt&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###<code>Tasks</code>控制     </p>
<p>基本的<code>Java</code>项目有一系列的<code>tasks</code>一起制作输出文件。<br><code>classes task</code>就是编译<code>Java</code>源码的任务。 我们可以在<code>build.gradle</code>中通过使用<code>classes</code>很简单的获取到它。就是<code>project.tasks.classes</code>.    </p>
<p>在<code>Android</code>项目中，更多的编译<code>task</code>，因为他们的名字通过<code>Build Types</code>和<code>Product Flavors</code>生成。</p>
<p>为了解决这个问题，<code>android</code>对象有两种属性:     </p>
<ul>
<li><code>applicationVariants</code> - <code>only for the app plugin</code>     </li>
<li><code>libraryVariants</code> - <code>only for the library plugin</code>      </li>
<li><code>testVariants</code> - <code>for both plugins</code><br>这些都会返回一个<code>ApplicationVariant</code>, <code>LibraryVariant</code>,<code>TestVariant</code>的<code>DomainObjectCollection</code>接口的实现类对象。<br><code>DomainObjectCollection</code>提供了直接获取或者很方便的间接获取所有对象的方法。     <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android.applicationVariants.all &#123; variant -&gt;</div><div class="line">   ....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###设置编译语言版本</p>
<p>可以使用<code>compileOptions</code>代码块来设置编译时使用的语言版本。默认是基于<code>compileSdkVersion</code>的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_6</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_6</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###<code>Resource Shrinking</code>    </p>
<p><code>Gradle</code>构建系统支持资源清理：对构建的应用会自动移除无用的资源。不仅会移除项目中未使用的资源，而且还会移除项目所以来的类库中的资源。注意，资源清理只能在与代码清理结合使用(例如<code>ProGuad</code>)。这就是为什么它能移除所依赖类库的无用资源。通常，类库中的所有资源都是使用的，只有类库中无用代码被移除后这些资源才会变成没有代码引用的无用资源。    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled true</div><div class="line">            shrinkResources true</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Gradle专题/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/itgoyo" target="_blank">itgoyo</a> by itgoyo
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="./",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}])</script><script src="/./main.04d600.js"></script><script>!function(){var e=function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)};e("/slider.885efe.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友情</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Lantern</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="https://github.com/itgoyo" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="https://www.zhihu.com/people/mkosto" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="https://itgoyo.github.io/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>