<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/4/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=270 src="//music.163.com/outchain/player?type=0&id=120897804&auto=1&height=430"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-Android Studio你可能不知道的操作" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android Studio你可能不知道的操作/">Android Studio你可能不知道的操作</a>
    </h1>
  

        
        <a href="/2015/01/01/Android Studio你可能不知道的操作/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Studio你可能不知道的操作"><a href="#Android-Studio你可能不知道的操作" class="headerlink" title="Android Studio你可能不知道的操作"></a>Android Studio你可能不知道的操作</h1><p>今天看在<code>Youtube</code>看视频，看到<code>Reto Meier</code>在讲解<code>Studio</code>，<br>一查才知道他现在是<code>Studio</code>的开发人员。<br>想起刚开始学<code>Android</code>时买的他写的书<code>Professional Android 4 Application Development</code>，<br>当时很多内容没看懂。不过看了这个视频才发现大神写代码如此之快…</p>
<p>现在天天用着大神开发的工具，没有理由不去好好学习下。</p>
<p>工欲善其事必先利其器，一个好的开发工具可以让你事半功倍。<code>Android Studio</code>是一个非常好的开发工具，但是虽然都在用，你可能还是了解的不全面，今天就来说一下一些你可能不知道的功能。</p>
<p>熟练使用快捷键是非常有必要的:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/use_shortcut.gif?raw=true" alt="image">  </p>
<ul>
<li><p>自动导入<br>经常听到同事抱怨，<code>Studio</code>怎么没有<code>Eclipse</code>那种批量导包啊，那么多类要到，费劲了。其实不用一个个导的。<br>使用<code>Command+Shift+A(Windows或Linux是Ctrl+Shift+A)</code>快速的查找设置命令。我们输入<code>auto import</code>后将<code>Add unambiguous imports on fly</code>选项开启就好了，很爽有木有？你的是不是也没开啊？<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/auto_import.gif?raw=true" alt="image"><br>你可以快速打开一些设置，例如你想在<code>finder</code>中查看该文件，直接输入<code>find</code>就好了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/action_find.png?raw=true" alt="image">        </p>
</li>
<li><p>在自动完成代码时使用<code>Tab</code>键来替换已存在的方法和参数。<br>经常如我们想要修改一个已经存在的方法时，我们移动到对象的<code>.</code>的提示区域，如果使用<code>Command+Space</code>来补充代码选择后按<code>enter</code>的话，会把之前已经存在的代码往后移动，这样还要再去删除，很不方便。但是如果我们直接使用<code>Tag</code>键，那就会直接替换当前已经存在的方法。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/tab_tip.gif?raw=true" alt="image">  </p>
</li>
<li><p>内容选择技巧<br>使用<code>Control+↑或↓</code>能在方法间移动。使用<code>Shift+↑或↓</code>来选择至上一行或者至下一行代码的代码？那么使用<code>option++↑或↓(Windows或Linux是alt++↑或↓)</code>呢？它能选择或者取消选择和你鼠标所在位置的代码区域。同时使用`option+shift++↑或↓(Windows或Linux是alt+shift++↑或↓)可以交换选中代码块与上一行的位置。这样我们就不需要剪切和粘贴了。</p>
</li>
<li><p>使用模板补全代码<br>你可以在代码后加用后缀的方式补充代码块，也可以用<code>Command+J(Windows是Ctrl+J)</code>来提示。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/command_j.gif?raw=true" alt="image"><br>对于一些更多的模式，在代码自动完成时也支持生成对应的模板，例如使用<code>Toast</code>的快捷键可以很方便的生成一个新的<code>toast</code>对象，你只需要指定文字就可以了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/toast_autocomp.gif?raw=true" alt="image"><br>用<code>Command+Shift+A</code>然后输入<code>live template</code>然后打开对应的页面，可以看到目前已经存在的模板。当然你也可以添加新的模板。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/live_templete.png?raw=true" alt="image">  </p>
</li>
<li><p>在<code>Evaluating Expressions</code>中为<code>Object</code>对象指定显示内容<br>如果我们在<code>debug</code>的时候查看断点处的变量值或者<code>evaluating expressions</code>，你会发现<code>objects</code>会显示他们的<code>toString()</code>值。如果你的变量是<code>String</code>类型或者基础类型那不会有问题，但是大多数其他对象，这样没有什么意义。<br>尤其是在集合对象时，你看的是一个<code>CallsName:HashValue</code>的列表。而为了需要看清数据，我们需要知道每个对象的内容。<br>你当然可以去对每个对象类型指定索要显示的内容。在对应的对象上邮件<code>View as</code>然后创建你想要显示的内容就可以了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/debug_eva.gif?raw=true" alt="image">  </p>
</li>
<li><p>结构性的搜索、替换、和检查<br><code>Command+shift+A</code>然后输入<code>structural</code>后选择<code>search structurally</code>或者<code>replace structurally</code>，然后可以对应的结构性搜索的模板，完成之后所有符合该模板的代码都会提示<code>warning</code>。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/structural_search.gif?raw=true" alt="image"><br>更有用的是可以使用快速修复来替换一些代码，例如一些废弃的代码或者你在<code>review</code>时发现的其他团队成员提交的一些普遍的错误。</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android Studio你可能不知道的操作/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RecyclerView专题" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RecyclerView专题/">RecyclerView专题</a>
    </h1>
  

        
        <a href="/2015/01/01/RecyclerView专题/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RecyclerView专题"><a href="#RecyclerView专题" class="headerlink" title="RecyclerView专题"></a>RecyclerView专题</h1><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>RecyclerView</code>是<code>Android 5.0</code>提供的新控件，已经用了很长时间了，但是一直没有时间去仔细的梳理一下。现在项目不太紧，决定来整理下。</p>
<p>官方文档中是这样介绍的:<br><code>A flexible view for providing a limited window into a large data set.</code></p>
<p>RecyclerView比listview更先进更灵活，对于很多的视图它就是一个容器，可以有效的重用和滚动。当数据动态变化的时候请使用它。</p>
<p>#####专业术语:</p>
<ul>
<li><code>Adapter</code>: <code>A subclass of RecyclerView.Adapter responsible for providing views that represent items in a data set.</code></li>
<li><code>Position</code>: <code>The position of a data item within an Adapter.</code></li>
<li><code>Index</code>: <code>The index of an attached child view as used in a call to getChildAt(int). Contrast with Position.</code></li>
<li><code>Binding</code>: <code>The process of preparing a child view to display data corresponding to a position within the adapter.</code></li>
<li><code>Recycle (view)</code>: <code>A view previously used to display data for a specific adapter position may be placed in a cache for later reuse to display the same type of data again later. This can drastically improve performance by skipping initial layout inflation or construction.</code></li>
<li><code>Scrap (view)</code>: <code>A child view that has entered into a temporarily detached state during layout. Scrap views may be reused without becoming fully detached from the parent RecyclerView, either unmodified if no rebinding is required or modified by the adapter if the view was considered dirty.</code></li>
<li><code>Dirty (view)</code>: <code>A child view that must be rebound by the adapter before being displayed.</code></li>
</ul>
<p>#####<code>RecyclerView</code>中的位置:      </p>
<p><code>RecyclerView</code>在<code>RecyclerView.Adapter</code>和<code>RecyclerView.LayoutManager</code>中引进了一个抽象的额外中间层来保证在布局计算的过程中能批量的监听到数据变化。这样介绍了<code>LayoutManager</code>追踪<code>adapter</code>数据变化来计算动画的时间。因为所有的<code>View</code>绑定都是在同一时间执行，所以这样也提高了性能和避免了一些非必要的绑定。<br>因为这个原因，在<code>RecylcerView</code>中有两种<code>position</code>类型相关的方法:     </p>
<ul>
<li><code>layout position</code>:  在最近一次<code>layout</code>计算是<code>item</code>的位置。这是<code>LayoutManager</code>角度中的位置。   </li>
<li><code>adapter position</code>: <code>item</code>在<code>adapter</code>中的位置。这是从<code>Adapter</code>的角度中的位置。</li>
</ul>
<p>这两种<code>position</code>除了在分发<code>adapter.notify*</code>事件与之后计算布局更新的这段时间之内外都是相同的。<br>可以通过<code>getLayoutPosition(),findViewHolderForLayoutPosition(int)</code>方法来获取最近一次布局计算的<code>LayoutPosition</code>。这些<code>positions</code>包括从最近一次布局计算的所有改变。你可以根据这些位置来方便的得到用户当前从屏幕上所看到的。例如，如果在屏幕上有一个列表，用户请求的是第五个条目，你可以通过该方法来匹配当前用户正在看的内容。</p>
<p>另一种<code>AdapterPosition</code>相关的方法是<code>getAdapterPosition(),findViewHolderForAdapterPosition(int)</code>，当及时一些数据可能没有来得及被展现到布局上时便需要获取最新的<code>adapter</code>位置可以使用这些相关的方法。例如，如果你想获取一个条目的<code>ViewHOlder</code>的<code>click</code>事件时，你应该使用<code>getAdapterPosition()</code>。需要知道这些方法在<code>notifyDataSetChange()</code>方法被调用和新布局还没有被计算之前是不能使用的。鉴于这个原因，你应该小心的去处理这些方法有可能返回<code>NO_POSITION</code>或者<code>null</code>的情况。</p>
<p>###结构</p>
<ul>
<li><code>RecyclerView.Adapter</code>: 创建View并将数据集合绑定到View上</li>
<li><code>ViewHolder</code>: 持有所有的用于绑定数据或者需要操作的View</li>
<li><code>LayoutManager</code>: 布局管理器，负责摆放视图等相关操作</li>
<li><code>ItemDecoration</code>: 负责绘制<code>Item</code>附近的分割线，通过<code>RecyclerView.addItemDecoration()</code>使用</li>
<li><code>ItemAnimator</code>: 为<code>Item</code>的操作添加动画效果，如，增删条目等，通过<code>RecyclerView.setItemAnimator(new DefaultItemAnimator());</code>使用</li>
</ul>
<p>下图能更直观的了解:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/RecyclerView.png?raw=true" alt="image"></p>
<p>#####<code>RecyclerView</code>提供这些内置布局管理器:    </p>
<ul>
<li><code>LinearLayoutManager</code>: 以垂直或水平滚动列表方式显示项目。</li>
<li><code>GridLayoutManager</code>: 在网格中显示项目。</li>
<li><code>StaggeredGridLayoutManager</code>: 在分散对齐网格中显示项目。</li>
</ul>
<p>#####<code>RecyclerView.ItemDecoration</code>是一个抽象类，可以通过重写以下三个方法，来实现Item之间的偏移量或者装饰效果:     </p>
<ul>
<li><code>public void onDraw(Canvas c, RecyclerView parent)</code> 装饰的绘制在Item条目绘制之前调用，所以这有可能被Item的内容所遮挡</li>
<li><code>public void onDrawOver(Canvas c, RecyclerView parent)</code> 装饰的绘制在Item条目绘制之后调用，因此装饰将浮于Item之上</li>
<li><code>public void getItemOffsets(Rect outRect, int itemPosition, RecyclerView parent)</code> 与padding或margin类似，LayoutManager在测量阶段会调用该方法，计算出每一个Item的正确尺寸并设置偏移量。</li>
</ul>
<p>#####<code>ItemAnimator</code>触发于以下三种事件:    </p>
<ul>
<li>某条数据被插入到数据集合中</li>
<li>从数据集合中移除某条数据</li>
<li>更改数据集合中的某条数据</li>
</ul>
<p>在之前的版本中，当时据集合发生改变时通过调用<code>notifyDataSetChanged()</code>，来刷新列表，因为这样做会触发列表的重绘，所以并不会出现任何动画效果，因此需要调用一些以<code>notifyItem*()</code>作为前缀的特殊方法，比如:    </p>
<ul>
<li><code>public final void notifyItemInserted(int position)</code> 向指定位置插入<code>Item</code></li>
<li><code>public final void notifyItemRemoved(int position)</code> 移除指定位置<code>Item</code></li>
<li><code>public final void notifyItemChanged(int position)</code> 更新指定位置<code>Item</code></li>
</ul>
<p>###使用介绍:     </p>
<ul>
<li><p>添加依赖库           </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:recyclerview-v7:23.4.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>示例代码        </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line">    <span class="keyword">private</span> RecyclerView.Adapter mAdapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String [] mDatas = &#123;<span class="string">"Android"</span>,<span class="string">"ios"</span>,<span class="string">"jack"</span>,<span class="string">"tony"</span>,<span class="string">"window"</span>,<span class="string">"mac"</span>,<span class="string">"1234"</span>,<span class="string">"hehe"</span>,<span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findView();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">        <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use a linear layout manager</span></div><div class="line">        mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">        mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">        mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyHolder</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> String[] mData;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> MyHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="comment">// create a new view</span></div><div class="line">            View v = LayoutInflater.from(parent.getContext()).inflate(</div><div class="line">                    R.layout.item, parent, <span class="keyword">false</span>);</div><div class="line">            MyHolder holder = <span class="keyword">new</span> MyHolder(v);</div><div class="line">            <span class="keyword">return</span> holder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(MyHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            holder.mTitleTv.setText(mData[position]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mData == <span class="keyword">null</span> ? <span class="number">0</span> : mData.length;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> TextView mTitleTv;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            mTitleTv = (TextView) itemView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>`activity_main的内容如下: `     
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/rv"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div></pre></td></tr></table></figure>


`item的内容如下：`     
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:padding</span>=<span class="string">"20dp"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">    <span class="attr">android:textSize</span>=<span class="string">"30dp"</span>&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></div></pre></td></tr></table></figure>
</code></pre><p>###点击事件</p>
<p>之前在使用<code>ListView</code>的时候，设置点击事件是非常方便的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mListView.setOnItemClickListener();</div><div class="line">mListView.setOnItemLongClickListener();</div></pre></td></tr></table></figure></p>
<p>但是<code>RecylcerView</code>确没有提供类似的方法。那我们只能是自己去处理。处理的方式也有两种:       </p>
<ul>
<li><p>通过<code>itemView.onClickListener()</code>以及<code>onLongClickListener()</code>     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line">    <span class="keyword">private</span> MyAdapter mAdapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String[] mDatas = &#123;<span class="string">"Android"</span>, <span class="string">"ios"</span>, <span class="string">"jack"</span>, <span class="string">"tony"</span>, <span class="string">"window"</span>, <span class="string">"mac"</span>, <span class="string">"1234"</span>, <span class="string">"hehe"</span>, <span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findView();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">        <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use a linear layout manager</span></div><div class="line">        mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">        mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">        mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">        mAdapter.setOnItemClickListener(<span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mAdapter.setOnItemLongClickListener(<span class="keyword">new</span> OnItemLongClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"long click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyHolder</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> String[] mData;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> MyHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="comment">// create a new view</span></div><div class="line">            View v = LayoutInflater.from(parent.getContext()).inflate(</div><div class="line">                    R.layout.item, parent, <span class="keyword">false</span>);</div><div class="line">            MyHolder holder = <span class="keyword">new</span> MyHolder(v);</div><div class="line">            <span class="keyword">return</span> holder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(<span class="keyword">final</span> MyHolder holder, <span class="keyword">final</span> <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            holder.mTitleTv.setText(mData[position]);</div><div class="line">            <span class="keyword">if</span> (mOnItemClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        mOnItemClickListener.onItemClick(holder.itemView, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mOnItemLongClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                holder.itemView.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        mOnItemLongClickListener.onItemLongClick(holder.itemView, position);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mData == <span class="keyword">null</span> ? <span class="number">0</span> : mData.length;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> OnItemClickListener mOnItemClickListener;</div><div class="line">        <span class="keyword">private</span> OnItemLongClickListener mOnItemLongClickListener;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener mOnItemClickListener)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.mOnItemClickListener = mOnItemClickListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemLongClickListener</span><span class="params">(OnItemLongClickListener mOnItemLongClickListener)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.mOnItemLongClickListener = mOnItemLongClickListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> TextView mTitleTv;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            mTitleTv = (TextView) itemView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemLongClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>使用<code>RecyclerView.OnItemTouchListener</code>           </p>
<p>  虽然没有提供现成的监听器，但是提供了一个内部接口<code>OnItemTouchListener</code>。<br>  先来看看它的介绍:    </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * An OnItemTouchListener allows the application to intercept touch events in progress at the</div><div class="line"> * view hierarchy level of the RecyclerView before those touch events are considered for</div><div class="line"> * RecyclerView&apos;s own scrolling behavior.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This can be useful for applications that wish to implement various forms of gestural</div><div class="line"> * manipulation of item views within the RecyclerView. OnItemTouchListeners may intercept</div><div class="line"> * a touch interaction already in progress even if the RecyclerView is already handling that</div><div class="line"> * gesture stream itself for the purposes of scrolling.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @see SimpleOnItemTouchListener</div><div class="line"> */</div><div class="line">public static interface OnItemTouchListener &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  说的和明白了，而且还让你看<code>SimpleOnItemTouchListener</code>，猜也能猜出来是一个默认的实现类。<br>  好了直接上代码:      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line"><span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line"><span class="keyword">private</span> MyAdapter mAdapter;</div><div class="line"></div><div class="line"><span class="keyword">private</span> String[] mDatas = &#123;<span class="string">"Android"</span>, <span class="string">"ios"</span>, <span class="string">"jack"</span>, <span class="string">"tony"</span>, <span class="string">"window"</span>, <span class="string">"mac"</span>, <span class="string">"1234"</span>, <span class="string">"hehe"</span>, <span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line">    findView();</div><div class="line">    initView();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">    mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">    <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">    mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// use a linear layout manager</span></div><div class="line">    mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">    mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">    mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">    mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">    mRecyclerView.setAdapter(mAdapter);</div><div class="line">    mRecyclerView.addOnItemTouchListener(<span class="keyword">new</span> RecyclerViewClickListener(<span class="keyword">this</span>, mRecyclerView, <span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Long Click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecyclerViewClickListener</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">SimpleOnItemTouchListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> GestureDetector mGestureDetector;</div><div class="line">    <span class="keyword">private</span> OnItemClickListener mListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecyclerViewClickListener</span><span class="params">(Context context, <span class="keyword">final</span> RecyclerView recyclerView, OnItemClickListener listener)</span> </span>&#123;</div><div class="line">        mListener = listener;</div><div class="line">        mGestureDetector = <span class="keyword">new</span> GestureDetector(context,</div><div class="line">                <span class="keyword">new</span> GestureDetector.SimpleOnGestureListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSingleTapUp</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">                        View childView = recyclerView.findChildViewUnder(e.getX(), e.getY());</div><div class="line">                        <span class="keyword">if</span> (childView != <span class="keyword">null</span> &amp;&amp; mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                            mListener.onItemClick(childView, recyclerView.getChildLayoutPosition(childView));</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLongPress</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">                        View childView = recyclerView.findChildViewUnder(e.getX(), e.getY());</div><div class="line">                        <span class="keyword">if</span> (childView != <span class="keyword">null</span> &amp;&amp; mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                            mListener.onItemLongClick(childView, recyclerView.getChildLayoutPosition(childView));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mGestureDetector.onTouchEvent(e)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(rv, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onTouchEvent(rv, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestDisallowInterceptTouchEvent</span><span class="params">(<span class="keyword">boolean</span> disallowIntercept)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestDisallowInterceptTouchEvent(disallowIntercept);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  上面的实现稍微有些缺陷，就是如果我手指按住某个条目一直不抬起，他也会执行<code>Long click</code>事件，这显然是不合理的，至于怎么解决，就是可以不用<code>GestureDetector</code>，自己在<code>DOWN</code>和<code>UP</code>事件中去判断处理。</p>
</li>
</ul>
<h3 id="Headerview-FooterView"><a href="#Headerview-FooterView" class="headerlink" title="Headerview FooterView"></a>Headerview FooterView</h3><p>之前在<code>ListView</code>中提供了<code>addHeaderView()</code>和<code>addFooterView()</code>等方法，但是在<code>RecyclerView</code>中并没有提供类似的方法，那我们该如何添加呢？ 也很简单，就是通过<code>Adapter</code>中去添加，利用不同的<code>itemViewType</code>，然后根据不同的类型去在<code>onCreateViewHOlder</code>中创建不同的视图，通过这种方式来达到<code>headerview</code>和<code>FooterView</code>的效果。</p>
<p>上一段简单的示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecyclerView</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_HEADER = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_ITEM = <span class="number">1</span>;</div><div class="line">    String[] data;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeaderAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (viewType == TYPE_ITEM) &#123;</div><div class="line">            <span class="comment">//inflate your layout and pass it to view holder</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> VHItem(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (viewType == TYPE_HEADER) &#123;</div><div class="line">            <span class="comment">//inflate your layout and pass it to view holder</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> VHHeader(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"there is no type that matches the type "</span> + viewType + <span class="string">" + make sure your using types correctly"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (holder <span class="keyword">instanceof</span> VHItem) &#123;</div><div class="line">            String dataItem = getItem(position);</div><div class="line">            <span class="comment">//cast holder to VHItem and set data</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (holder <span class="keyword">instanceof</span> VHHeader) &#123;</div><div class="line">            <span class="comment">//cast holder to VHHeader and set data for header.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> data.length + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isPositionHeader(position))</div><div class="line">            <span class="keyword">return</span> TYPE_HEADER;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> TYPE_ITEM;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPositionHeader</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> position == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> data[position - <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">VHItem</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        TextView title;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VHItem</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">VHHeader</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        Button button;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VHHeader</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的代码对<code>LinearLayoutManger</code>是没问题的，但是使用<code>GridLayoutManager</code>呢？ 如果是两列，那添加的<code>HeaderView</code>并不是占据上第一行，而是<code>HeaderView</code>与第二个<code>ItemView</code>一起占据第一行。那该怎么处理呢？<br>那就是使用<code>setSpanSizeLookup()</code>方法。<br>比如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">recyclerView.setLayoutManager(<span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>, <span class="number">2</span>));</div></pre></td></tr></table></figure></p>
<p>在上面的基本设置中，我们的<code>spanCount</code>为2，每个<code>item</code>的<code>span size</code>为1，因此一个<code>header</code>需要的<code>span size</code>则为2。在我尝试着添加<code>header</code>之前，我想先看看如何设置<code>span size</code>。其实很简单。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> GridLayoutManager manager = <span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>, <span class="number">2</span>);</div><div class="line">recyclerView.setLayoutManager(manager);</div><div class="line">manager.setSpanSizeLookup(<span class="keyword">new</span> GridLayoutManager.SpanSizeLookup() &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSpanSize</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> adapter.isHeader(position) ? manager.getSpanCount() : <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="下拉刷新、自动加载"><a href="#下拉刷新、自动加载" class="headerlink" title="下拉刷新、自动加载"></a>下拉刷新、自动加载</h3><p>#####实现下拉刷新<br>实现下拉刷新也很简单了，可以使用<code>SwipeRefrshLayout</code>,<code>SwipeRefrshLayout</code>是<code>Google</code>官方提供的组件，可以实现下拉刷新的功能。已包含到<code>support.v4</code>包中。</p>
<p>主要方法有:      </p>
<ul>
<li><code>setOnRefreshListener(OnRefreshListener)</code>:添加下拉刷新监听器</li>
<li><code>setRefreshing(boolean)</code>:显示或者隐藏刷新进度条</li>
<li><code>isRefreshing()</code>:检查是否处于刷新状态</li>
<li><code>setColorSchemeResources()</code>:设置进度条的颜色主题，最多设置四种。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.SwipeRefreshLayout</span></span></div><div class="line">   <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">   <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:scrollbars</span>=<span class="string">"vertical"</span></div><div class="line">    &gt;</div><div class="line">   <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">       <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">       <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">       &gt;<span class="tag">&lt;/<span class="name">android.support.v7.widget.RecyclerView</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>具体实现就不写了。</p>
<p>#####实现滑动自动加载更多功能</p>
<p>实现方式和<code>ListView</code>的实现方式类似，就是通过监听<code>scroll</code>时间，然后判断当前显示的<code>item</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//RecyclerView滑动监听</span></div><div class="line">mRecylcerView.setOnScrollListener(<span class="keyword">new</span> RecyclerView.OnScrollListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrollStateChanged</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> newState)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState);</div><div class="line">        <span class="keyword">if</span> (newState ==RecyclerView.SCROLL_STATE_IDLE &amp;&amp; lastVisibleItem + <span class="number">1</span> ==adapter.getItemCount()) &#123;</div><div class="line">            <span class="keyword">new</span> Handler().postDelayed(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    List&lt;String&gt; newDatas = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">                        <span class="keyword">int</span> index = i +<span class="number">1</span>;</div><div class="line">                       newDatas.add(<span class="string">"more item"</span> + index);</div><div class="line">                    &#125;</div><div class="line">                   adapter.addMoreItem(newDatas);</div><div class="line">                &#125;</div><div class="line">            &#125;,<span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onScrolled(recyclerView,dx, dy);</div><div class="line">        lastVisibleItem =linearLayoutManager.findLastVisibleItemPosition();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>然后再通过结合<code>FooterView</code>以及增加几种状态就可以实现自动加载更多了。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RecyclerView专题/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-注解使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/注解使用/">注解使用</a>
    </h1>
  

        
        <a href="/2015/01/01/注解使用/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="注解使用"><a href="#注解使用" class="headerlink" title="注解使用"></a>注解使用</h1><p>###简介</p>
<blockquote>
<p>Annotations, a form of metadata, provide data about a program that is not part of the program itself. Annotations have no direct effect on the operation of the code they annotate.</p>
</blockquote>
<p>更通俗的意思是为程序的元素（类、方法、成员变量）加上更直观更明了的说明，这些说明信息是与程序的业务逻辑无关，并且是供指定的工具或框架使用的。<br><code>Annontation</code>像一种修饰符一样，应用于包、类型、构造方法、方法、成员变量、参数及本地变量的声明语句中。</p>
<p><code>Annotation</code>其实是一种接口。通过反射来访问<code>annotation</code>信息。相关类（框架或工具中的类）根据这些信息来决定如何使用该程序元素或改变它们的行为。<br><code>Annotation</code>是不会影响程序代码的执行，无论<code>annotation</code>怎么变化，代码都始终如一地执行。<br><code>Java</code>语言解释器在工作时会忽略这些<code>annotation</code>，因此在<code>JVM</code>中这些<code>annotation</code>是“不起作用”的，只能通过配套的工具才能对这些<code>annontaion</code>类型的信息进行访问和处理。</p>
<p>###说明</p>
<ul>
<li><code>Annotation</code>的声明是通过关键字<code>@interface</code>。这个关键字会去继承<code>Annotation</code>接口。</li>
<li><p><code>Annotation</code>的方法定义是独特的、受限制的。<br> <code>Annotation</code>类型的方法必须声明为无参数、无异常的。这些方法定义了<code>Annotation</code>的成员: 方法名代表成员变量名，而方法返回值代表了成员变量的类型。而且方法的返回值类型必须是基本数据类型、<code>Class</code>类型、<code>String类型</code>、枚举类型、<code>Annotation</code>类型或者由前面类型之一作为元素的一维数组。方法的后面可以使用<code>default</code>和一个默认的数值来声明成员变量的默认值，<code>null</code>不能作为成员变量的默认值，这与我们平时的使用有很大的区别。<br>  注解如果只有一个默认属性，可直接用<code>value()</code>函数。一个属性也没有则表示该<code>Annotation</code>为<code>Mark Annotation</code>。<br>  例如:</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public @interface UnitTest &#123;</div><div class="line">     String value();</div><div class="line">&#125;</div><div class="line">```    </div><div class="line">在使用时可以直接使用`@UnitTest("GCD")`，`@UnitTest("GCD"`实际上就是是 `@UnitTest(value="GCD)`的简单写法。  </div><div class="line">例如:</div><div class="line">   </div><div class="line">```java</div><div class="line">@Target(ElementType.METHOD)</div><div class="line">@Retention(RetentionPolicy.RUNTIME)</div><div class="line">public @interface UseCase &#123;</div><div class="line">    public int id();</div><div class="line">    public String description() default "no description";</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###作用</p>
<p><code>Annotation</code>一般作为一种辅助途径，应用在软件框架或者工具中。让这些工具类可以根据不同的<code>Annotation</code>注解信息来采取不同的处理过程或者改变相应程的行为。具有“让编译器进行编译检查的作用”。   </p>
<p>具体可分为如下三类:    </p>
<ul>
<li>标记，用于告诉编译器一些信息</li>
<li>编译时动态处理，如动态生成代码</li>
<li>运行时动态处理，如得到注解信息</li>
</ul>
<p>###Annotation分类    </p>
<p>#####标准的<code>Annotaion</code>    </p>
<p>从<code>jdk 1.5</code>开始，自带了三种标准的<code>annotation</code>类型：   </p>
<ul>
<li><p><code>Override</code><br>  它是一种<code>marker</code>类型的<code>Annotation</code>，用来标注方法，说明被它标注的方法是重载了父类中的方法。如果我们使用了该注解到一个没有覆盖父类方法的方法时，编译器就会提示一个编译错误的警告。   </p>
</li>
<li><p><code>Deprecated</code><br>  它也是一种<code>marker</code>类型的<code>Annotation</code>。当方法或者变量使用该注解时，编译器就会提示该方法已经废弃。</p>
</li>
<li><p><code>SuppressWarnings</code><br>  它不是<code>marker</code>类型的<code>Annotation</code>。用户告诉编译器不要再对该类、方法或者成员变量进行警告提示。   </p>
</li>
</ul>
<p>#####元<code>Annotation</code></p>
<p>元<code>Annotation</code>是指用来定义<code>Annotation</code>的<code>Annotation</code>。  </p>
<ul>
<li><p><code>@Retention</code><br>  保留时间，可为<code>RetentionPolicy.SOURCE(源码时)</code>、<code>RetentionPolicy.CLASS(编译时)</code>、<code>RetentionPolicy.RUNTIME(运行时)</code>，默认为<code>CLASS</code>。如果值为<code>RetentionPolicy.SOURCE</code>那大多都是<code>Mark Annotation</code>，例如:<code>Override</code>、<code>Deprecated</code>、<code>Suppress Warnings</code>。<code>SOURCE</code>表示仅存在于源码中，在<code>class</code>文件中不会包含。<code>CLASS</code>表示会在<code>class</code>文件中存在，但是运行时无法获取。<code>RUNTIME</code>表示会在<code>class</code>文件中存在，并且在运行时可以通过反射获取。    </p>
</li>
<li><p><code>@Target</code><br>  用来标记可进行修饰哪些元素，例如<code>ElementType.TYPE</code>、<code>ElementType.METHOD</code>、<code>ElementType.CONSTRUCTOR</code>、<code>ElementType.FIELD</code>、<code>ElementType.PARAMETER</code>等，如果未指定则默认为可修饰所有。</p>
</li>
<li><p><code>@Inherited</code><br>  子类是否可以继承父类中的该注解。它所标注的<code>Annotation</code>将具有继承性。<br>  例如:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">java.lang.annotation.Inherited</div><div class="line"></div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAnnotation &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MyAnnotation</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySuperClass</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySubClass</span> <span class="keyword">extends</span> <span class="title">MySuperClass</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>

在这个例子中`MySubClass`类继承了`@MyAnnotation`注解，因为`MySubClass`继承了`MySuperClass`类，而`MySuperClass`类使用了`@MyAnnotation`注解。   
</code></pre><ul>
<li><code>@Documented</code><br>  是否会保存到<code>javadoc</code>文档中。  </li>
</ul>
<p>###自定义<code>Annotation</code> </p>
<p>假设现在有个开发团队在每个类的开始都要提供一些信息，例如:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation3List</span> <span class="keyword">extends</span> <span class="title">Generation2List</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">// Author: John Doe</span></div><div class="line">   <span class="comment">// Date: 3/17/2002</span></div><div class="line">   <span class="comment">// Current revision: 6</span></div><div class="line">   <span class="comment">// Last modified: 4/12/2004</span></div><div class="line">   <span class="comment">// By: Jane Doe</span></div><div class="line">   <span class="comment">// Reviewers: Alice, Bill, Cindy</span></div><div class="line"></div><div class="line">   <span class="comment">// class code goes here</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以声明一个注解来保存这些相同的元数据。如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> ClassPreamble &#123;</div><div class="line">   <span class="function">String <span class="title">author</span><span class="params">()</span></span>;</div><div class="line">   <span class="function">String <span class="title">date</span><span class="params">()</span></span>;</div><div class="line">   <span class="function"><span class="keyword">int</span> <span class="title">currentRevision</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</div><div class="line">   <span class="function">String <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">default</span> "N/A"</span>;</div><div class="line">   <span class="function">String <span class="title">lastModifiedBy</span><span class="params">()</span> <span class="keyword">default</span> "N/A"</span>;</div><div class="line">   <span class="comment">// Note use of array</span></div><div class="line">   String[] reviewers();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>声明完注解之后我们就可以填写一些参数来使用它，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ClassPreamble</span> (</div><div class="line">   author = <span class="string">"John Doe"</span>,</div><div class="line">   date = <span class="string">"3/17/2002"</span>,</div><div class="line">   currentRevision = <span class="number">6</span>,</div><div class="line">   lastModified = <span class="string">"4/12/2004"</span>,</div><div class="line">   lastModifiedBy = <span class="string">"Jane Doe"</span>,</div><div class="line">   <span class="comment">// Note array notation</span></div><div class="line">   reviewers = &#123;<span class="string">"Alice"</span>, <span class="string">"Bob"</span>, <span class="string">"Cindy"</span>&#125;</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation3List</span> <span class="keyword">extends</span> <span class="title">Generation2List</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">// class code goes here</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###<code>Annotation</code>解析    </p>
<p>当<code>Java</code>源代码被编译时，编译器的一个插件<code>annotation</code>处理器则会处理这些<code>annotation</code>。<br>处理器可以产生报告信息，或者创建附加的<code>Java</code>源文件或资源。<br>如果<code>annotation</code>本身被加上了<code>RententionPolicy</code>的运行时类，<br>则<code>Java</code>编译器则会将<code>annotation</code>的元数据存储到<code>class</code>文件中。然后<code>Java</code>虚拟机或其他的程序可以查找这些元数据并做相应的处理。</p>
<p>当然除了<code>annotation</code>处理器可以处理<code>annotation</code>外，我们也可以使用反射自己来处理<code>annotation</code>。<code>Java SE 5</code>有一个名为<code>AnnotatedElement</code>的接口，<br><code>Java</code>的反射对象类<code>Class</code>,<code>Constructor</code>,<code>Field</code>,<code>Method</code>以及<code>Package</code>都实现了这个接口。<br>这个接口用来表示当前运行在<code>Java</code>虚拟机中的被加上了<code>annotation</code>的程序元素。<br>通过这个接口可以使用反射读取<code>annotation</code>。<code>AnnotatedElement</code>接口可以访问被加上<code>RUNTIME</code>标记的<code>annotation</code>，<br>相应的方法有<code>getAnnotation</code>,<code>getAnnotations</code>,<code>isAnnotationPresent</code>。<br>由于<code>Annotation</code>类型被编译和存储在二进制文件中就像<code>class</code>一样，<br>所以可以像查询普通的<code>Java</code>对象一样查询这些方法返回的<code>Annotation</code>。</p>
<p>#####运行时<code>Annotation</code>解析</p>
<p>该类是指<code>@Retention</code>为<code>RUNTIME</code>的<code>Annotation</code>。<br>该类型的解析其实本质的使用反射。反射执行的效率是很低的<br>如果不是必要，应当尽量减少反射的使用，因为它会大大拖累你应用的执行效率。</p>
<ul>
<li><p>类注解</p>
<p>  可以通过<code>Class</code>、<code>Method</code>、<code>Field</code>类来在运行时获取注解。下面是通过<code>Class</code>类获取注解的示例:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Class aClass = TheClass.class;</div><div class="line">Annotation[] annotations = aClass.getAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  也可以获取一个指定的注解类型:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Class aClass = TheClass.class;</div><div class="line">Annotation annotation = aClass.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <code>JDK</code>提供的主要方法有:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">getAnnotation</span><span class="params">(Class&lt;A&gt; annotationType)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Annotation[] getAnnotations() &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAnnotationPresent</span><span class="params">(Class&lt;? extends Annotation&gt; annotationType)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>方法注解</p>
<p>  下面是一个方法使用注解的例子:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line">  <span class="meta">@MyAnnotation</span>(name=<span class="string">"someName"</span>,  value = <span class="string">"Hello World"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>你可以通过如下方式获取方法注解:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">//obtain method object</span></div><div class="line">Annotation[] annotations = method.getDeclaredAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

也可以获取一个指定的方法注解，如下:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">// obtain method object</span></div><div class="line">Annotation annotation = method.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>参数注解</p>
<p>  在方法的参数中声明注解，如下:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doSomethingElse</span><span class="params">(</span></span></div><div class="line">        @MyAnnotation(name=<span class="string">"aName"</span>, value=<span class="string">"aValue"</span>) String parameter)&#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>可以通过`Method`对象获取到参数的注解，如下:          
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">//obtain method object</span></div><div class="line">Annotation[][] parameterAnnotations = method.getParameterAnnotations();</div><div class="line">Class[] parameterTypes = method.getParameterTypes();</div><div class="line"></div><div class="line"><span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(Annotation[] annotations : parameterAnnotations)&#123;</div><div class="line">  Class parameterType = parameterTypes[i++];</div><div class="line"></div><div class="line">  <span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"param: "</span> + parameterType.getName());</div><div class="line">        System.out.println(<span class="string">"name : "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

注意，`Method.getParameterAnnotations()`方法会返回一个二维的`Annotation`数组，包含每个方法参数的一个注解数组。    
</code></pre><ul>
<li><p>变量注解</p>
<p>  下面是一个变量使用注解的例子:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@MyAnnotation</span>(name=<span class="string">"someName"</span>,  value = <span class="string">"Hello World"</span>)</div><div class="line">  <span class="keyword">public</span> String myField = <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line"></div><div class="line">你可以像下面这样获取变量的注解:    </div><div class="line">```java</div><div class="line">Field field = ... <span class="comment">//obtain field object</span></div><div class="line">Annotation[] annotations = field.getDeclaredAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>当然也可以获取一个指定的变量注解，如下:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Field field = ... <span class="comment">// obtain method object</span></div><div class="line">Annotation annotation = field.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>记下来我们来举个栗子,运行时注解示例:   </p>
<p>相信很多人都知道<code>Butter Knife</code>。它里面就是使用了注解:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindView</span>(R.id.user) EditText username;</div><div class="line"><span class="meta">@BindView</span>(R.id.pass) EditText password;</div><div class="line"></div><div class="line"><span class="meta">@BindString</span>(R.string.login_error) String loginErrorMessage;</div><div class="line"></div><div class="line"><span class="meta">@OnClick</span>(R.id.submit) <span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO call server...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那我们就以<code>onClick</code>事件为例模仿着他去写一下。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectorProcessor</span> </span>&#123;    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> Object object)</span> </span>&#123;        </div><div class="line">        Class class_=object.getClass();        </div><div class="line">        Method[] methods=class_.getDeclaredMethods();        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Method method : methods) &#123;            </div><div class="line">            onClick clickMethod=method.getAnnotation(onClick.class);            </div><div class="line">            <span class="keyword">if</span> (clickMethod!=<span class="keyword">null</span>) &#123;                </div><div class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Activity) &#123;                   </div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> id : clickMethod.value()) &#123;                        </div><div class="line">                        View view=((Activity) object).findViewById(id);                        </div><div class="line">                        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;                            </div><div class="line">                            <span class="meta">@Override</span>                            </div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;                                </div><div class="line">                                <span class="keyword">try</span> &#123;                                    </div><div class="line">                                    method.invoke(object);                                </div><div class="line">                                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;                                    </div><div class="line">                                    e.printStackTrace();                                </div><div class="line">                                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;                                    </div><div class="line">                                    e.printStackTrace();                                </div><div class="line">                                &#125;                            </div><div class="line">                            &#125;                        </div><div class="line">                        &#125;);                    </div><div class="line">                    &#125;                </div><div class="line">                &#125;            </div><div class="line">             &#125;        </div><div class="line">         &#125;    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;    </div><div class="line">    <span class="meta">@Override</span>    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;        </div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);        </div><div class="line">        setContentView(R.layout.activity_main);        </div><div class="line">        InjectorProcessor processor=<span class="keyword">new</span> InjectorProcessor();        </div><div class="line">        processor.process(MainActivity.<span class="keyword">this</span>);    </div><div class="line">    &#125;    </div><div class="line"></div><div class="line">    <span class="meta">@onClick</span>(&#123;R.id.textview&#125;)    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click</span><span class="params">()</span> </span>&#123;        </div><div class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"HHH"</span>, Toast.LENGTH_SHORT).show();    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很显然大神<code>JakeWharton</code>不会这样做的，毕竟反射会影响性能。<br>我们来看一下<code>ButterKnife</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(METHOD)</div><div class="line"><span class="meta">@Retention</span>(CLASS)</div><div class="line"><span class="meta">@ListenerClass</span>(</div><div class="line">    targetType = <span class="string">"android.view.View"</span>,</div><div class="line">    setter = <span class="string">"setOnClickListener"</span>,</div><div class="line">    type = <span class="string">"butterknife.internal.DebouncingOnClickListener"</span>,</div><div class="line">    method = <span class="meta">@ListenerMethod</span>(</div><div class="line">        name = <span class="string">"doClick"</span>,</div><div class="line">        parameters = <span class="string">"android.view.View"</span></div><div class="line">    )</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</div><div class="line">  <span class="comment">/** View IDs to which the method will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到了吗？是编译型的注解。这样不会影响性能。</p>
<p>一张图总结一下:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/java_annotation.jpg?raw=true" alt="image"></p>
<p>#####编译时<code>Annotation</code>解析    </p>
<p>在刚才介绍的运行时注解中，很多人肯定会说使用反射会影响性能，那有没有不影响性能的方式呢？当然有了，那就是编译时注解。在编译时会通过注解标示来动态生成一些类或者<code>xml</code>，而在运行时，这里注解是没有的，它会依靠动态生成的类来进行操作。所以它就和直接调用方法一样，当然不会有效率影响了。       </p>
<p>该类型注解值是<code>@Retention</code>为<code>CLASS</code>的<code>Annotation</code>，由<code>APT(Annotaion Processing Tool)</code>自动进行解析。是在编译时注入，所以不会像反射一样影响效率问题。   </p>
<p>根据<code>sun</code>官方的解释，<code>APT（annotation processing tool）</code>是一个命令行工具，<br>它对源代码文件进行检测找出其中的<code>annotation</code>后，使用<code>annotation processors</code>来处理<code>annotation</code>。<br>而<code>annotation processors</code>使用了一套反射<code>API</code>并具备对<code>JSR175</code>规范的支持。</p>
<p><code>annotation processors</code>处理<code>annotation</code>的基本过程如下：</p>
<ul>
<li><code>APT</code>运行<code>annotation processors</code>根据提供的源文件中的<code>annotation</code>生成源代码文件和其它的文件（文件具体内容由<code>annotation processors</code>的编写者决定）</li>
<li>接着<code>APT</code>将生成的源代码文件和提供的源文件进行编译生成类文件。</li>
</ul>
<p><code>APT</code>在编译时自动查找所有继承自<code>AbstractProcessor</code>的类，然后调用他们的<code>process</code>方法去处理，这样就拥有了在编译过程中执行代码的能力</p>
<p>所以我们需要做的是:    </p>
<ul>
<li>自定义类继承<code>AbstractProcessor</code></li>
<li>重写<code>process</code>方法</li>
</ul>
<p>那我们就开始写:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span></span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是在<code>Android Studio</code>死活提示找不到<code>AbstractProcessor</code>类，这是因为注解是<code>javase</code>中<code>javax</code>包里面的，<code>android.jar</code>默认是不包含的，所以会编译报错.<br>解决方法就是新建一个<code>Module</code>，在选择类型时将该<code>Module</code>的类型选为<code>Java Library</code>。<br>然后在该<code>Module</code>中创建就好了<code>Processor</code>就好了，完美解决。 </p>
<p>好，那我们就开始写个编译时处理的<code>demo</code> :  </p>
<ul>
<li><code>Android Studio</code>中创建一个<code>Android</code>工程。</li>
<li>新建一个<code>Module</code>，然后选择<code>Java Library</code>类型(我的名字为<code>annotations</code>)，并且让<code>app</code>依赖该<code>module</code>。</li>
<li><p>在<code>annotations</code>的<code>module</code>中创建注解类:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnnotationTest &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>annotations</code>的<code>module</code>自定义<code>Processor</code>类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedAnnotationTypes;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedSourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</div><div class="line"></div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(<span class="string">"com.charon.AnnotationTest"</span>)</div><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.RELEASE_7)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"process"</span>);</div><div class="line">        <span class="keyword">for</span> (TypeElement te : annotations) &#123;</div><div class="line">            <span class="keyword">for</span> (Element element : roundEnv.getElementsAnnotatedWith(te)) &#123;</div><div class="line">                AnnotationTest annotation = element.getAnnotation(AnnotationTest.class);</div><div class="line">                String value = annotation.value();</div><div class="line">                System.out.println(<span class="string">"type : "</span> + value);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <strong><em>注意:</em></strong><code>@SupportedAnnotationTypes(&quot;com.charon.AnnotationTest&quot;)</code>来指定要处理的注解类。<br>  <code>@SupportedSourceVersion(SourceVersion.RELEASE_7)</code>指定编译的版本。这种通过注解指定编译版本和类型的方式是从<code>Java 1.7</code>才有的。<br>  对于之前的版本都是通过重写<code>AbstractProcessor</code>中的方法来指定的。   </p>
</li>
<li><p>注册处理器<br>  我们自定义了<code>Processor</code>那如何才能让其生效呢?就是在<code>annotations</code>的<code>java</code>同级目录新建<code>resources/META-INF/services/javax.annotation.processing.Processor</code>文件</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- java</div><div class="line">- META-INF</div><div class="line">    - services</div><div class="line">        - javax.annotation.processing.Processor</div></pre></td></tr></table></figure>
<p>  然后在<code>javax.annotation.processing.Processor</code>文件中指定自定义的处理器，如:      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.charon.TestProcessor</div></pre></td></tr></table></figure>
<p>  如果多个话就分行写。 </p>
<p>  然后我们<code>Build</code>一下(命令行执行<code>./gradlew build</code>)，就能看到控制台打印出来如下的信息: </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">:app:compileReleaseJavaWithJavac</div><div class="line">:app:compileReleaseJavaWithJavac - <span class="function">is not <span class="title">incremental</span> <span class="params">(e.g. outputs have changed, no previous execution, etc.)</span>.</span></div><div class="line">process</div><div class="line">value : haha</div><div class="line">process</div></pre></td></tr></table></figure>
<p>  <strong><em>注意:</em></strong>千万不要去<code>logcat</code>中找信息，这是编译时注解。<br>  <strong><em>注意:</em></strong>一定要使用<code>jdk1.7</code>，<code>1.8</code>对注解的支持有<code>bug</code>。</p>
</li>
</ul>
<p>上面只是一个简单的例子，如果你想用编译时注解去做一些更高级的事情，例如自动生成一些代码，那你可能就会用到如下几个类库:   </p>
<ul>
<li><a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="external">android-apt</a></li>
<li><a href="https://github.com/google/auto">Google Auto</a>      </li>
<li><a href="https://github.com/square/javapoet">Square javapoet</a></li>
</ul>
<p>这三个库分别的作用为:    </p>
<ul>
<li><p><code>android-apt</code><br>  <code>Android Studio</code>原本是不支持注解处理器的, 但是用<code>android-apt</code>这个插件后, 我们就可以使用注解处理器了,<br>  这个插件可以自动的帮你为生成的代码创建目录, 让生成的代码编译到<code>APK</code>里面去, 而且它还可以让最终编译出来的<code>APK</code>里面不包含注解处理器本身的代码,<br>  因为这部分代码只是编译的时候需要用来生成代码, 最终运行的时候是不需要的。<br>  也就是说它主要有两个目的:    </p>
<ul>
<li>允许配置只在编译时作为注解处理器的依赖，而不添加到最后的APK或library</li>
<li><p>设置源路径，使注解处理器生成的代码能被Android Studio正确的引用</p>
<p>那在什么情况下我们会需要使用它呢？<br>当你需要引入<code>Processor</code>生成的源代码到你的代码中时。例如当你使用<code>Dagger 2</code>或<code>AndroidAnnotaition</code>.<br>该插件使得<code>Android Studio</code>可以配置生成资源的<code>build path</code>,避免<code>IDE</code>报错。<br>当使用<code>apt</code>添加添加依赖，它将不会被包含到最终的<code>APK</code>里。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><code>Auto</code>     </p>
<p>  <code>Google Auto</code>的主要作用是注解<code>Processor</code>类，并对其生成<code>META-INF</code>的配置信息，<br>  可以让你不用去写<code>META-INF</code>这些配置文件，只要在自定义的<code>Processor</code>上面加上<code>@AutoService(Processor.class)</code></p>
</li>
<li><p><code>javapoet</code><br>  <code>javapoet</code>:<code>A Java API for generating .java source files.</code>可以更方便的生成代码，它可以帮助我们通过类调用的形式来生成代码。   </p>
</li>
</ul>
<p>###自定义编译时注解</p>
<p>在自定义注解时，一般来说可能会建三个<code>modules</code>:  </p>
<ul>
<li><code>app module</code>:写一些使用注解的<code>android</code>应用逻辑。</li>
<li><code>api module</code>:定义一些可以在<code>app</code>中使用的注解。它会被<code>app</code>以及<code>compiler</code>使用。</li>
<li><code>compiler module</code>:定义<code>Processor</code>该<code>module</code>不会被包含到应用中，它只会在构建过程中被使用。在编译的过程中它会生成一些<code>java</code>文件，而这些<code>java</code>文件会被打包进<code>apk</code>中。<br>  我们可以在该<code>module</code>中使用<code>auto</code>以及<code>javapoet</code>。  </li>
</ul>
<p>下面开始配置<code>android-apt</code>：   </p>
<ul>
<li><p>配置到<code>app module</code>下的<code>build.gradle</code>中</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.application'</span></div><div class="line"><span class="comment">// apt</span></div><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">23</span></div><div class="line">    buildToolsVersion <span class="string">"23.0.3"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"com.charon.annotationdemo"</span></div><div class="line">        minSdkVersion <span class="number">14</span></div><div class="line">        targetSdkVersion <span class="number">23</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_7</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_7</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        <span class="comment">// 配置apt</span></div><div class="line">        classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">    testCompile 'junit:junit:4.12'</div><div class="line">    compile 'com.android.support:appcompat-v7:23.4.0'</div><div class="line">    compile <span class="title">project</span><span class="params">(<span class="string">':api'</span>)</span></div><div class="line">    apt <span class="title">project</span><span class="params">(<span class="string">':compiler'</span>)</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接下来在<code>compiler module</code>中配置<code>auto</code>以及<code>javapoet</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line">sourceCompatibility = JavaVersion.VERSION_1_7</div><div class="line">targetCompatibility = JavaVersion.VERSION_1_7</div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">project</span> <span class="params">(<span class="string">':api'</span>)</span></span></div><div class="line">    compile 'com.google.auto.service:auto-service:1.0-rc2'</div><div class="line">    compile 'com.squareup:javapoet:1.7.0'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在<code>api module</code>中也加上如下的配置:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line">sourceCompatibility = JavaVersion.VERSION_1_7</div><div class="line">targetCompatibility = JavaVersion.VERSION_1_7</div></pre></td></tr></table></figure>
</li>
<li><p>接下来在<code>api module</code>中定义一个注解       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnnotationTest &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>compiler module</code>中自定义一个<code>Processor</code>       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.ProcessingEnvironment;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.Processor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</div><div class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</div><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes the processor with the processing environment by</div><div class="line">     * setting the &#123;<span class="doctag">@code</span> processingEnv&#125; field to the value of the</div><div class="line">     * &#123;<span class="doctag">@code</span> processingEnv&#125; argument.  An &#123;<span class="doctag">@code</span></div><div class="line">     * IllegalStateException&#125; will be thrown if this method is called</div><div class="line">     * more than once on the same object.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> processingEnv environment to access facilities the tool framework</div><div class="line">     * provides to the processor</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException if this method is called more than once.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Processes a set of annotation types on type elements originating from the prior round </div><div class="line">     * and returns whether or not these annotations are claimed by this processor. </div><div class="line">     * If true is returned, the annotations are claimed and subsequent processors will </div><div class="line">     * not be asked to process them; </div><div class="line">     * if false is returned, the annotations are unclaimed and subsequent processors may be </div><div class="line">     * asked to process them. A processor may always return the same boolean value </div><div class="line">     * or may vary the result based on chosen criteria.</div><div class="line">     * The input set will be empty if the processor supports "*" and the root elements </div><div class="line">     * have no annotations. A Processor must gracefully handle an empty set of annotations.</div><div class="line">     * <span class="doctag">@param</span> annotations</div><div class="line">     * <span class="doctag">@param</span> roundEnv</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"hello processor"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getSupportedAnnotationTypes();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>这里简单的说一下这几个主要的方法:   

- `init()`:初始化操作的方法，`RoundEnvironment`会提供很多有用的工具类`Elements`、`Types`和`Filer`等。
- `process()`:这相当于每个处理器的主函数`main()`。在该方法中去扫描、评估、处理以及生成`Java`文件。 
- `getSupportedAnnotationTypes()`:这里你必须指定，该注解器是注册给哪个注解的。
- `getSupportedSourceVersion()`:用来指定你使用的`java`版本。通常这里会直接放回`SourceVersion.latestSupported()`即可。  

从`idk 1.7`开始，可以使用如下注解来代替`getSupporedAnnotationTypes()`和`getSupportedSourceVersion()`方法:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.latestSupported())</div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;</div><div class="line">   <span class="comment">// 合法注解全名的集合</span></div><div class="line"> &#125;)</div></pre></td></tr></table></figure>
</code></pre><p>注解相关<code>API</code>:     </p>
<ul>
<li><code>Set&lt;? extends Element&gt; getElementsAnnotatedWith(Class&lt;? extends Annotation&gt; a)</code><br>  返回使用给定注释类型注释的元素。该注释可能直接出现或者被继承。只返回注释处理的此<code>round</code>中包括的<code>package</code>元素和<code>type</code>元素、成员声明、参数或者这些元素中声明的类型参数。</li>
<li><p><code>Element</code><br>  表示一个程序元素，比如包、类或者方法。每个元素都表示一个静态的语言级构造（不表示虚拟机的运行时构造）。<br>  元素应该使用<code>equals(Object)</code>方法进行比较。不保证总是使用相同的对象表示某个特定的元素。<br>  要实现基于<code>Element</code>对象类的操作，可以使用<code>visitor</code>或者使用<code>getKind()</code>方法的结果。使用<code>instanceof</code>确定此建模层次结构中某一对象的有效类未必可靠，因为一个实现可以选择让单个对象实现多个<code>Element</code>子接口。</p>
</li>
<li><p><code>TypeElement</code><br>  表示一个类或接口程序元素。提供对有关类型及其成员的信息的访问。注意，枚举类型是一种类，而注释类型是一种接口。<br>  而<code>DeclaredType</code>表示一个类或接口类型，后者将成为前者的一种使用（或调用）。这种区别对于一般的类型是最明显的，对于这些类型，单个元素可以定义一系列完整的类型。<br>  例如，元素<code>java.util.Set</code>对应于参数化类型<code>java.util.Set&lt;String&gt;</code>和<code>java.util.Set&lt;Number&gt;</code>（以及其他许多类型），还对应于原始类型<code>java.util.Set</code>。</p>
</li>
</ul>
<p>扯远了，那我们就以上面的目录结构和实现方式，通过一个具体的例子要详细说明，例子真的很难找，我在网上找到了一个大神写的，虽然从这个例子中并不能看出注解的强大之处，但是对于讲解来说还是非常有用的: </p>
<p>我们要解决的问题是我们想要实现一个披萨店，该店会提供两种披萨(<code>Margherita</code>和<code>Calzone</code>)和一种甜点(<code>Tiramisu</code>)。</p>
<p>首先我们在<code>app module</code>中创建对应的接口和代码 ，如下:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Meal</span> </span>&#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6.0f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果消费者想要下单，那么它需要输入对应的物品名字:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mealName == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Name of the meal is null!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown meal '"</span> + mealName + <span class="string">"'"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这样的话在<code>order()</code>方法中，会有很多<code>if</code>语句，并且每当我们添加一种新的披萨，我们都要添加一条新的<code>if</code>语句。但是我们可以使用注解和工厂模式，我们就可以让注解来自动生成这些在工厂中的<code>if</code>语句。我们期待的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> factory.create(mealName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>MealFactory</code>的实现应该如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MealFactory</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">create</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"id is null!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown id = "</span> + id);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们要做的就是通过注解来生成<code>MealFactory</code>中的代码。<br>想法是这样的：我们将使用同样的<code>type()</code>注解那些属于同一个工厂的类，并且用注解的<code>id()</code>做一个映射，例如从”Calzone”映射到”ClzonePizza”类。我们使用<code>@Factory</code>注解到我们的类中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Margherita"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Calzone"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Tiramisu"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可能会问你自己，我们是否可以只把<code>@Factory</code>注解应用到<code>Meal</code>接口上？答案是注解是不能继承的。一个类<code>class X</code>被注解，并不意味着它的子类<code>class Y extends X</code>会自动被注解。在我们开始写处理器的代码之前，我们先规定如下一些规则：</p>
<ul>
<li>只有类可以被<code>@Factory</code>注解，因为接口或者抽象类并不能用<code>new</code>操作实例化；</li>
<li>被<code>@Factory</code>注解的类，必须至少提供一个公开的默认构造器（即没有参数的构造函数）。否者我们没法实例化一个对象。</li>
<li>被<code>@Factory</code>注解的类必须直接或者间接的继承于<code>type()</code>指定的类型；</li>
<li>具有相同的<code>type</code>的注解类，将被聚合在一起生成一个工厂类。这个生成的类使用<code>Factory</code>后缀，例如<code>type = Meal.class</code>，将生成<code>MealFactory</code>工厂类；</li>
<li><code>id</code>只能是<code>String</code>类型，并且在同一个<code>type</code>组中必须唯一。</li>
</ul>
<p>那我们接着看一下在<code>compiler module</code>中的自定义的<code>FactoryProcessor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Types typeUtils;</div><div class="line">  <span class="keyword">private</span> Elements elementUtils;</div><div class="line">  <span class="keyword">private</span> Filer filer;</div><div class="line">  <span class="keyword">private</span> Messager messager;</div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses = <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    typeUtils = processingEnv.getTypeUtils();</div><div class="line">    elementUtils = processingEnv.getElementUtils();</div><div class="line">    filer = processingEnv.getFiler();</div><div class="line">    messager = processingEnv.getMessager();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">    <span class="comment">// 指定支持@Factory注解</span></div><div class="line">    annotataions.add(Factory.class.getCanonicalName());</div><div class="line">    <span class="keyword">return</span> annotataions;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>init()</code>方法中，我们初始化了几个变量:   </p>
<ul>
<li><code>Elements</code>: 处理<code>Element</code>的工具类  </li>
<li><code>Types</code>: 处理<code>TypeMirror</code>的工具类</li>
<li><code>Filer</code>: 用来创建你要创建的文件</li>
<li><code>Messager</code>:提供给注解处理器一个报告错误、警告以及提示信息的途径。</li>
</ul>
<p>在注解的处理过程中会扫描所有的<code>java</code>源文件。源代码中的每一个部分都是一个特定类型的<code>Element</code>。换句话说:<code>Element</code>代表程序的元素，例如包、类或者方法等。每个<code>Element</code>代表一个构建，例如通过下面的例子我们来说明一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example;    <span class="comment">// PackageElement</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;        <span class="comment">// TypeElement</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> a;      <span class="comment">// VariableElement</span></div><div class="line">    <span class="keyword">private</span> Foo other;  <span class="comment">// VariableElement</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span> <span class="params">()</span> </span>&#123;&#125;    <span class="comment">// ExecuteableElement</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span> <span class="params">(  // ExecuteableElement</span></span></div><div class="line">                     <span class="keyword">int</span> newA   // TypeElement</div><div class="line">                     ) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以在注解中我们必须要换一个角度来看待源代码，它只是一个结构化的文本，我们可以像<code>XML</code>中的<code>DOM</code>一样去解析它。<br>例如现在有一个代表<code>public class Foo</code>类的<code>TypeElement</code>元素，你可以遍历它的子元素，如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TypeElement fooClass = ... ;  </div><div class="line"><span class="keyword">for</span> (Element e : fooClass.getEnclosedElements())&#123; <span class="comment">// iterate over children  </span></div><div class="line">    Element parent = e.getEnclosingElement();  <span class="comment">// parent == fooClass</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你所见，<code>Element</code>代表的是源代码。<code>TypeElement</code>代表的是源代码中的类型元素，例如类。然而<code>TypeElement</code>并不包含类本身的信息。你可以从<code>TypeElement</code>中获取类的名字，但是你获取不到类的信息，例如它的父类。这种信息需要通过<code>TypeMirror</code>获取。你可以通过调用<code>elements.asType()</code>获取元素的<code>TypeMirror</code>。</p>
<p>接下来我们来继续实现<code>process()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Types typeUtils;</div><div class="line">    <span class="keyword">private</span> Elements elementUtils;</div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">        typeUtils = processingEnv.getTypeUtils();</div><div class="line">        elementUtils = processingEnv.getElementUtils();</div><div class="line">        filer = processingEnv.getFiler();</div><div class="line">        messager = processingEnv.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">        annotataions.add(Factory.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> annotataions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// roundEnv.getElementsAnnotatedWith(Factory.class))返回所有被注解了@Factory的元素的列表。</span></div><div class="line">        <span class="comment">// 你可能已经注意到，我们并没有说“所有被注解了@Factory的类的列表”，因为它真的是返回Element的列表。</span></div><div class="line">        <span class="comment">// 请记住：Element可以是类、方法、变量等。所以，接下来，我们必须检查这些Element是否是一个类</span></div><div class="line">        <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">            <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">            <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在继续检查被注解<code>@Fractory</code>的类是否满足我们上面说的5条规则之前，我们将介绍一个让我们更方便继续处理的数据结构。有时候，一个问题或者解释器看起来如此简单，以至于程序员倾向于用一个面向过程方式来写整个处理器。但是你知道吗？一个注解处理器仍然是一个<code>Java</code>程序，所以我们需要使用面向对象编程、接口、设计模式，以及任何你将在其他普通<code>Java</code>程序中使用的技巧。</p>
<p>我们的<code>FactoryProcessor</code>非常简单，但是我们仍然想要把一些信息存为对象。在<code>FactoryAnnotatedClass</code>中，我们保存被注解类的数据，比如合法的类的名字，以及<code>@Factory</code>注解本身的一些信息。也就是说每一个使用了<code>@Factory</code>注解的类都对应一个<code>FactoryAnnotatedClass</code>类，所以，我们保存<code>TypeElement</code>和处理过的<code>@Factory</code>注解：</p>
<p>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryAnnotatedClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> TypeElement annotatedClassElement;</div><div class="line">  <span class="keyword">private</span> String qualifiedSuperClassName;</div><div class="line">  <span class="keyword">private</span> String simpleTypeName;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryAnnotatedClass</span><span class="params">(TypeElement classElement)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</div><div class="line">    <span class="keyword">this</span>.annotatedClassElement = classElement;</div><div class="line">    Factory annotation = classElement.getAnnotation(Factory.class);</div><div class="line">    id = annotation.id();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(id)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">          String.format(<span class="string">"id() in @%s for class %s is null or empty! that's not allowed"</span>,</div><div class="line">              Factory.class.getSimpleName(), classElement.getQualifiedName().toString()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Get the full QualifiedTypeName</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; clazz = annotation.type();</div><div class="line">      <span class="comment">// 返回底层阶级Java语言规范中定义的标准名称。</span></div><div class="line">      qualifiedSuperClassName = clazz.getCanonicalName();</div><div class="line">      simpleTypeName = clazz.getSimpleName();</div><div class="line">    &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">      DeclaredType classTypeMirror = (DeclaredType) mte.getTypeMirror();</div><div class="line">      TypeElement classTypeElement = (TypeElement) classTypeMirror.asElement();</div><div class="line">      qualifiedSuperClassName = classTypeElement.getQualifiedName().toString();</div><div class="line">      simpleTypeName = classTypeElement.getSimpleName().toString();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#id()&#125;中指定的id</div><div class="line">   * return the id</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#type()&#125;指定的类型合法全名</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> qualified name</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getQualifiedFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> qualifiedSuperClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#type()&#125;&#123;<span class="doctag">@link</span> Factory#type()&#125;指定的类型的简单名字</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> qualified name</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getSimpleFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> simpleTypeName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取被<span class="doctag">@Factory</span>注解的原始元素</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> TypeElement <span class="title">getTypeElement</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> annotatedClassElement;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面我们用到了<code>Class</code>,因为这里的类型是一个<code>java.lang.Class</code>。这就意味着，他是一个真正的<code>Class</code>对象。因为注解处理是在编译<code>Java</code>源代码之前。我们需要考虑如下两种情况：</p>
<ul>
<li>这个类已经被编译：这种情况是：如果第三方<code>.jar</code>包含已编译的被<code>@Factory</code>注解<code>.class</code>文件。在这种情况下，可以通过上面的方式在<code>try</code>代码块中直接获取。</li>
<li>这个还没有被编译：这种情况是我们尝试编译被<code>@Fractory</code>注解的源代码。这种情况下，直接获取<code>Class</code>会抛出<code>MirroredTypeException</code>异常。幸运的是，<code>MirroredTypeException</code>包含一个<code>TypeMirror</code>，它表示我们未编译类。因为我们已经知道它必定是一个类类型（我们已经在前面检查过），我们可以直接强制转换为<code>DeclaredType</code>，然后读取<code>TypeElement</code>来获取合法的名字。</li>
</ul>
<p>好了，我们现在还需要一个数据结构类<code>FactoryGroupedClasses</code>，它将简单的组合所有的<code>FactoryAnnotatedClasses</code>到一起。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">      <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> IdAlreadyUsedException </span>&#123;</div><div class="line"></div><div class="line">    FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IdAlreadyUsedException(existing);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你所见，这是一个基本的<code>Map&lt;String, FactoryAnnotatedClass&gt;</code>，这个映射表用来映射<code>@Factory.id()</code>到<code>FactoryAnnotatedClass</code>。我们选择<code>Map</code>这个数据类型，是因为我们要确保每个<code>id</code>是唯一的，我们可以很容易通过<code>map</code>查找实现。<code>generateCode()</code>方法将被用来生成工厂类代码（将在后面讨论）。</p>
<p>我们继续实现<code>process()</code>方法。接下来我们想要检查被注解的类必须有只要一个公开的构造函数，不是抽象类，继承于特定的类型，以及是一个公开类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Types typeUtils;</div><div class="line">    <span class="keyword">private</span> Elements elementUtils;</div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line">    <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">        typeUtils = processingEnv.getTypeUtils();</div><div class="line">        elementUtils = processingEnv.getElementUtils();</div><div class="line">        filer = processingEnv.getFiler();</div><div class="line">        messager = processingEnv.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">        annotataions.add(Factory.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> annotataions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// roundEnv.getElementsAnnotatedWith(Factory.class))返回所有被注解了@Factory的元素的列表。</span></div><div class="line">        <span class="comment">// 你可能已经注意到，我们并没有说“所有被注解了@Factory的类的列表”，因为它真的是返回Element的列表。</span></div><div class="line">        <span class="comment">// 请记住：Element可以是类、方法、变量等。所以，接下来，我们必须检查这些Element是否是一个类</span></div><div class="line">        <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">            <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">            <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">                error(annotatedElement, <span class="string">"Only classes can be annotated with @%s"</span>,</div><div class="line">                        Factory.class.getSimpleName());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 退出处理</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="comment">// 因为我们已经知道它是ElementKind.CLASS类型，所以可以直接强制转换</span></div><div class="line">            TypeElement typeElement = (TypeElement) annotatedElement;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                FactoryAnnotatedClass annotatedClass =</div><div class="line">                        <span class="keyword">new</span> FactoryAnnotatedClass(typeElement); <span class="comment">// throws IllegalArgumentException</span></div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!isValidClass(annotatedClass)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 已经打印了错误信息，退出处理过程</span></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 一旦我们检查isValidClass()成功，我们将添加FactoryAnnotatedClass到对应的FactoryGroupedClasses中</span></div><div class="line">                FactoryGroupedClasses factoryClass =</div><div class="line">                        factoryClasses.get(annotatedClass.getQualifiedFactoryGroupName());</div><div class="line">                <span class="keyword">if</span> (factoryClass == <span class="keyword">null</span>) &#123;</div><div class="line">                    String qualifiedGroupName = annotatedClass.getQualifiedFactoryGroupName();</div><div class="line">                    factoryClass = <span class="keyword">new</span> FactoryGroupedClasses(qualifiedGroupName);</div><div class="line">                    factoryClasses.put(qualifiedGroupName, factoryClass);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 如果和其他的@Factory标注的类的id相同冲突，</span></div><div class="line">                <span class="comment">// 抛出IdAlreadyUsedException异常</span></div><div class="line">                factoryClass.add(annotatedClass);</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">                <span class="comment">// @Factory.id()为空 --&gt; 打印错误信息</span></div><div class="line">                error(typeElement, e.getMessage());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (IdAlreadyUsedException e) &#123;</div><div class="line">                FactoryAnnotatedClass existing = e.getExisting();</div><div class="line">                <span class="comment">// 已经存在</span></div><div class="line">                error(annotatedElement,</div><div class="line">                        <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">                        typeElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                        existing.getTypeElement().getQualifiedName().toString());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 为每个工厂生成Java文件</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">                factoryClass.generateCode(elementUtils, filer);</div><div class="line">            &#125;</div><div class="line">        <span class="comment">// TODO ...注意这里会遗留一个问题，我们后面再仔细说。 </span></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Element e, String msg, Object... args)</span> </span>&#123;</div><div class="line">        messager.printMessage(</div><div class="line">                Diagnostic.Kind.ERROR,</div><div class="line">                String.format(msg, args),</div><div class="line">                e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidClass</span><span class="params">(FactoryAnnotatedClass item)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 转换为TypeElement, 含有更多特定的方法</span></div><div class="line">        TypeElement classElement = item.getTypeElement();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!classElement.getModifiers().contains(Modifier.PUBLIC)) &#123;</div><div class="line">            error(classElement, <span class="string">"The class %s is not public."</span>,</div><div class="line">                    classElement.getQualifiedName().toString());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查是否是一个抽象类</span></div><div class="line">        <span class="keyword">if</span> (classElement.getModifiers().contains(Modifier.ABSTRACT)) &#123;</div><div class="line">            error(classElement, <span class="string">"The class %s is abstract. You can't annotate abstract classes with @%"</span>,</div><div class="line">                    classElement.getQualifiedName().toString(), Factory.class.getSimpleName());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查继承关系: 必须是@Factory.type()指定的类型子类</span></div><div class="line">        TypeElement superClassElement =</div><div class="line">                elementUtils.getTypeElement(item.getQualifiedFactoryGroupName());</div><div class="line">        <span class="keyword">if</span> (superClassElement.getKind() == ElementKind.INTERFACE) &#123;</div><div class="line">            <span class="comment">// 检查接口是否实现了</span></div><div class="line">            <span class="keyword">if</span>(!classElement.getInterfaces().contains(superClassElement.asType())) &#123;</div><div class="line">                error(classElement, <span class="string">"The class %s annotated with @%s must implement the interface %s"</span>,</div><div class="line">                        classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                        item.getQualifiedFactoryGroupName());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 检查子类</span></div><div class="line">            TypeElement currentClass = classElement;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                TypeMirror superClassType = currentClass.getSuperclass();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (superClassType.getKind() == TypeKind.NONE) &#123;</div><div class="line">                    <span class="comment">// 到达了基本类型(java.lang.Object), 所以退出</span></div><div class="line">                    error(classElement, <span class="string">"The class %s annotated with @%s must inherit from %s"</span>,</div><div class="line">                            classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                            item.getQualifiedFactoryGroupName());</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (superClassType.toString().equals(item.getQualifiedFactoryGroupName())) &#123;</div><div class="line">                    <span class="comment">// 找到了要求的父类</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 在继承树上继续向上搜寻</span></div><div class="line">                currentClass = (TypeElement) typeUtils.asElement(superClassType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查是否提供了默认公开构造函数</span></div><div class="line">        <span class="keyword">for</span> (Element enclosed : classElement.getEnclosedElements()) &#123;</div><div class="line">            <span class="keyword">if</span> (enclosed.getKind() == ElementKind.CONSTRUCTOR) &#123;</div><div class="line">                ExecutableElement constructorElement = (ExecutableElement) enclosed;</div><div class="line">                <span class="keyword">if</span> (constructorElement.getParameters().size() == <span class="number">0</span> &amp;&amp; constructorElement.getModifiers()</div><div class="line">                        .contains(Modifier.PUBLIC)) &#123;</div><div class="line">                    <span class="comment">// 找到了默认构造函数</span></div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 没有找到默认构造函数</span></div><div class="line">        error(classElement, <span class="string">"The class %s must provide an public empty default constructor"</span>,</div><div class="line">                classElement.getQualifiedName().toString());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们这里添加了<code>isValidClass()</code>方法，来检查是否我们所有的规则都被满足了：</p>
<ul>
<li>必须是公开类：<code>classElement.getModifiers().contains(Modifier.PUBLIC)</code></li>
<li>必须是非抽象类：<code>classElement.getModifiers().contains(Modifier.ABSTRACT)</code></li>
<li>必须是<code>@Factoy.type()</code>指定的类型的子类或者接口的实现：首先我们使用<code>elementUtils.getTypeElement(item.getQualifiedFactoryGroupName())</code>创建一个传入的<code>Class(@Factoy.type())</code>的元素。是的，你可以仅仅通过已知的合法类名来直接创建<code>TypeElement</code>（使用<code>TypeMirror</code>）。接下来我们检查它是一个接口还是一个类：<code>superClassElement.getKind() == ElementKind.INTERFACE</code>。所以我们这里有两种情况：如果是接口，就判断<code>classElement.getInterfaces().contains(superClassElement.asType())</code>；如果是类，我们就必须使用<code>currentClass.getSuperclass()</code>扫描继承层级。注意，整个检查也可以使用<code>typeUtils.isSubtype()</code>来实现。</li>
<li>类必须有一个公开的默认构造函数：我们遍历所有的闭元素<code>classElement.getEnclosedElements()</code>，然后检查<code>ElementKind.CONSTRUCTOR</code>、<code>Modifier.PUBLIC</code>以及<code>constructorElement.getParameters().size() == 0</code>。</li>
</ul>
<p>上面都实现完成后下面就是在<code>FactoryGroupedClasses.generateCode()</code>方法中去生成<code>java</code>文件了。<br>写<code>Java</code>文件，和写其他普通文件没有什么两样。使用<code>Filer</code>提供的<code>Writer</code>对象，我们可以连接字符串来写我们生成的<code>Java</code>代码。但是这样是不是非常麻烦啊？还好良心企业<code>Square</code>给我们提供了<code>Javapoet</code>，我们可以用它来非常简单的去生成<code>java</code>文件。那我们接下来就使用<code>javapoet</code>来去生成代码:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将被添加到生成的工厂类的名字中</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">"Factory"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> ProcessingException </span>&#123;</div><div class="line"></div><div class="line">        FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">        <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Alredy existing</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProcessingException(toInsert.getTypeElement(),</div><div class="line">                    <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">                    toInsert.getTypeElement().getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                    toInsert.getId(), existing.getTypeElement().getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        TypeElement superClassName = elementUtils.getTypeElement(qualifiedClassName);</div><div class="line">        String factoryClassName = superClassName.getSimpleName() + SUFFIX;</div><div class="line">        String qualifiedFactoryClassName = qualifiedClassName + SUFFIX;</div><div class="line">        PackageElement pkg = elementUtils.getPackageOf(superClassName);</div><div class="line">        String packageName = pkg.isUnnamed() ? <span class="keyword">null</span> : pkg.getQualifiedName().toString();</div><div class="line"></div><div class="line">        MethodSpec.Builder method = MethodSpec.methodBuilder(<span class="string">"create"</span>)</div><div class="line">                .addModifiers(Modifier.PUBLIC)</div><div class="line">                .addParameter(String.class, <span class="string">"id"</span>)</div><div class="line">                .returns(TypeName.get(superClassName.asType()));</div><div class="line"></div><div class="line">        <span class="comment">// check if id is null</span></div><div class="line">        method.beginControlFlow(<span class="string">"if (id == null)"</span>)</div><div class="line">                .addStatement(<span class="string">"throw new IllegalArgumentException($S)"</span>, <span class="string">"id is null!"</span>)</div><div class="line">                .endControlFlow();</div><div class="line"></div><div class="line">        <span class="comment">// Generate items map</span></div><div class="line">        <span class="keyword">for</span> (FactoryAnnotatedClass item : itemsMap.values()) &#123;</div><div class="line">            method.beginControlFlow(<span class="string">"if ($S.equals(id))"</span>, item.getId())</div><div class="line">                    .addStatement(<span class="string">"return new $L()"</span>, item.getTypeElement().getQualifiedName().toString())</div><div class="line">                    .endControlFlow();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        method.addStatement(<span class="string">"throw new IllegalArgumentException($S + id)"</span>, <span class="string">"Unknown id = "</span>);</div><div class="line"></div><div class="line">        TypeSpec typeSpec = TypeSpec.classBuilder(factoryClassName).addMethod(method.build()).build();</div><div class="line"></div><div class="line">        <span class="comment">// Write file</span></div><div class="line">        JavaFile.builder(packageName, typeSpec).build().writeTo(filer);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里，我感觉完成了，运行一下，结果发现报错了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:compiler:jar UP-TO-DATE</div><div class="line">:app:compileDebugJavaWithJavac</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line"><span class="number">2</span> 个错误</div><div class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':app:compileDebugJavaWithJavac'</span>.</div><div class="line">&gt; Compilation failed; see the compiler error output <span class="keyword">for</span> details.</div></pre></td></tr></table></figure></p>
<p>那我们继续来解决这个问题，这个问题是由于循环引起的，我们还要处理一个重要的事情就是循环的问题:    </p>
<p>注解处理可能会执行多次，官方文档中是这样介绍的:   </p>
<blockquote>
<p>Annotation processing happens in a sequence of rounds. On each round, a processor may be asked to process a subset of the annotations found on the source and class files produced by a prior round. The inputs to the first round of processing are the initial inputs to a run of the tool; these initial inputs can be regarded as the output of a virtual zeroth round of processing.</p>
</blockquote>
<p>一个简单的定义：一个处理循环是调用一个注解处理器的<code>process()</code>方法。对应到我们的工厂模式的例子中：<code>FactoryProcessor</code>被初始化一次（不是每次循环都会新建处理器对象），然而，如果生成了新的源文件<code>process()</code>能够被调用多次。听起来有点奇怪不是么？原因是这样的，这些生成的文件中也可能包含<code>@Factory</code>注解，它们还将会被<code>FactoryProcessor</code>处理。</p>
<p>例如我们的<code>PizzaStore</code>的例子中将会经过3次循环处理：</p>
<table>
<thead>
<tr>
<th>Round</th>
<th style="text-align:center">Input</th>
<th style="text-align:right">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:center">CalzonePizza.java Tiramisu.java MargheritaPizza.java Meal.java   PizzaStore.java</td>
<td style="text-align:right">MealFactory.java</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:center">MealFactory.java</td>
<td style="text-align:right">none</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">none</td>
<td style="text-align:right">none</td>
</tr>
</tbody>
</table>
<p>会循环三次，但是第一次就会生成代码，所以上面会出现两次重复创建文件的错误。   </p>
<p>解释处理循环还有另外一个原因。如果你看一下我们的<code>FactoryProcessor</code>代码你就能注意到，我们收集数据和保存它们在一个私有的域中<code>Map&lt;String, FactoryGroupedClasses&gt; factoryClasses</code>。在第一轮中，我们检测到了<code>MagheritaPizza</code>, <code>CalzonePizza</code>和<code>Tiramisu</code>，然后生成了<code>MealFactory.java</code>。在第二轮中把<code>MealFactory</code>作为输入。因为在<code>MealFactory</code>中没有检测到<code>@Factory</code>注解，我们预期并没有错误，然而我们得到如下的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:compiler:jar UP-TO-DATE</div><div class="line">:app:compileDebugJavaWithJavac</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line"><span class="number">2</span> 个错误</div><div class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':app:compileDebugJavaWithJavac'</span>.</div><div class="line">&gt; Compilation failed; see the compiler error output <span class="keyword">for</span> details.</div></pre></td></tr></table></figure>
<p>这个问题是因为我们没有清除<code>factoryClasses</code>，这意味着，在第二轮的<code>process()</code>中，任然保存着第一轮的数据，并且会尝试生成在第一轮中已经生成的文件，从而导致这个错误的出现。在我们的这个场景中，我们知道只有在第一轮中检查<code>@Factory</code>注解的类，所以我们可以简单的修复这个问题，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;  </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">        factoryClass.generateCode(elementUtils, filer);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 清除factoryClasses</span></div><div class="line">      factoryClasses.clear();</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong><em>我们要记住注解处理过程是需要经过多轮处理的，并且你不能重载或者重新创建已经生成的源代码。</em></strong></p>
<p>好了，到这里就彻底完成了，运行一下，当然成功了，那生成的文件在哪里呢？ </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/annotation_ato_create_file.png" alt="image">     </p>
<p>那既然能生成，我们该怎么去调用呢？很简单，像平常一样去用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> View view;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        view = findViewById(R.id.tv);</div><div class="line">        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line">                factory.create(<span class="string">"Calzone"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可能会发现报错，找不到类，你可以不用管它，直接运行，你会发现一切都<code>OK</code>的。当然如果你倒错了包你就当我没说。</p>
<p>作为<code>Android</code>开发者，当然应该很熟悉<code>ButterKnife</code>。在<code>ButterKnife</code>中使用<code>@InjectView</code>注解<code>View</code>。<code>ButterKnifeProcessor</code>生成一个<code>MyActivity$$ViewInjector</code>，但是在<code>ButterKnife</code>你不需要手动调用<code>new MyActivity$$ViewInjector()</code>来实例化一个<code>ButterKnife</code>注入的对象，而是使用<code>Butterknife.inject(activity)</code>。<code>ButterKnife</code>内部使用反射机制来实例化<code>MyActivity$$ViewInjector()</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    Class&lt;?&gt; injector = Class.forName(clsName + <span class="string">"$$ViewInjector"</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123; ... &#125;</div></pre></td></tr></table></figure>
<p>但是反射机制会稍微有些慢，我们使用注解处理来生成本地代码，会不会导致很多的反射性能的问题？的确，反射机制的性能确实是一个问题。然而，它不需要手动去创建对象，确实提高了开发者的开发速度。<code>ButterKnife</code>中有一个哈希表<code>HashMap</code>来缓存实例化过的对象。所以<code>MyActivity$$ViewInjector</code>只是使用反射机制实例化一次，第二次需要<code>MyActivity$$ViewInjector</code>的时候，就直接从哈希表中获得。</p>
<p><code>FragmentArgs</code>非常类似于<code>ButterKnife</code>。它使用反射机制来创建对象，而不需要开发者手动来做这些。<code>FragmentArgs</code>在处理注解的时候生成一个特别的查找表类，它其实就是一种哈希表，所以整个<code>FragmentArgs</code>库只是在第一次使用的时候，执行一次反射调用，一旦整个<code>Class.forName()</code>的<code>Fragemnt</code>的参数对象被创建，后面的都是本地代码运行了。</p>
<p>好了至此例子讲完了。   </p>
<p>最后讲一下按照上面的三层分类:<code>app</code>,<code>api</code>,<code>compiler</code>进行分类的好处。<br>我们这么做是因为想让我们的工厂模式的例子的使用者在他们的工程中只编译注解，而包含处理器模块只是为了编译。有点晕？我们举个例子，如果我们只有一个包。如果另一个开发者想要把我们的工厂模式处理器用于他的项目中，他就必须包含<code>@Factory</code>注解和整个<code>FactoryProcessor</code>的代码（包括<code>FactoryAnnotatedClass</code>和<code>FactoryGroupedClasses</code>）到他们项目中。我非常确定的是，他并不需要在他已经编译好的项目中包含处理器相关的代码。如果你是一个<code>Android</code>的开发者，你肯定听说过<code>65536</code>个方法的限制（即在一个<code>.dex</code>文件中，只能寻址65536个方法）。如果你在<code>FactoryProcessor</code>中使用<code>guava</code>，并且把注解和处理器打包在一个包中，这样的话，<code>Android APK</code>安装包中不只是包含<code>FactoryProcessor</code>的代码，而也包含了整个<code>guava</code>的代码。<code>Guava</code>有大约20000个方法。所以分开注解和处理器是非常有意义的。</p>
<p>###使用注解提高代码的检查性    </p>
<p><code>Google</code>提供了<code>Support-Annotations library</code>来支持更多的注解功能。<br>可以直接在<code>build.gradle</code>中添加如下代码:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:support-annotations:23.3.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Android</code>提供了很多注解来支持在方法、参数和返回值上面使用，例如:    </p>
<ul>
<li><code>@Nullable</code><br>  可以为<code>null</code></li>
<li><p><code>@NonNull</code><br>  不能为<code>null</code>  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment">/** Add support for inflating the &lt;fragment&gt; tag. */</span></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, @NonNull Context context,</span></span></div><div class="line">      @NonNull AttributeSet attrs) &#123;</div><div class="line">      ...</div><div class="line">      &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p><code>@StringRes</code><br>  <code>R.string</code>类型的资源。  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.annotation.StringRes;</div><div class="line">...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(@StringRes <span class="keyword">int</span> resId)</span></span>;</div><div class="line">    ...</div><div class="line"></div><div class="line">遇到那种你写了个`setTitle(<span class="keyword">int</span> resId)`他确给你传`setTitle(R.drawable.xxx)`的选手，用这种方式能很好的去提示下。</div></pre></td></tr></table></figure>
</li>
<li><p><code>@DrawableRes</code><br>  <code>Drawable</code>类型的资源。</p>
</li>
<li><code>@ColorRes</code><br>  <code>Color</code>类型的资源。</li>
<li><code>@InterpolatorRes</code><br>  <code>Interpolatro</code>类型。</li>
<li><code>@AnyRes</code><br>  <code>R.</code>类型。</li>
<li><code>@UiThread</code><br>  从<code>UI thread</code>调用。 </li>
<li><p><code>@RequiresPermission</code><br>  来验证该方法的调用者所需要有的权限。检查一个列表中的任何一个权限可以使用<code>anyOf</code>属性。想要检查多个权限时，可以使用<code>allOf</code>属性。如下:  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequiresPermission</span>(Manifest.permission.SET_WALLPAPER)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setWallpaper</span><span class="params">(Bitmap bitmap)</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure>
<p>  检查多个权限:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequiresPermission</span>(allOf = &#123;</div><div class="line">    Manifest.permission.READ_EXTERNAL_STORAGE,</div><div class="line">    Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String dest, String source)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>示例<code>Demo</code>已上传到<code>Github</code>:<a href="https://github.com/CharonChui/AnnotationDemo">AnnotationDemo</a>    </p>
<p>文中例子来自<code>Hannes Dorfmann</code>大神的<code>ANNOTATION PROCESSING 101</code>，我对其重新梳理了下，来让能正常使用，并且上面的示例已经过我实际运行:   </p>
<ul>
<li><a href="http://hannesdorfmann.com/annotation-processing/annotationprocessing101" target="_blank" rel="external">Hannes Dorfmann</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/注解使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-ListView源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/ListView源码分析/">ListView源码分析</a>
    </h1>
  

        
        <a href="/2015/01/01/ListView源码分析/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ListView源码分析"><a href="#ListView源码分析" class="headerlink" title="ListView源码分析"></a>ListView源码分析</h1><p>一直都想写一篇文章分析下<code>ListView</code>的实现，总是忙，一直拖到现在，快到年底了，写出来希望能帮助一些面试跳槽的人。<br>当然写这篇文章也是有原因的，当时有同事在面试的时候，被对方要求当场实现一个<code>ListView</code>，同事简单的答了一些实现原理后，很显然对方不满意，经过几轮PK后，就有了不河蟹的结局。<br>不欢而散，哈哈。听说后当时我想着要把<code>ListView</code>源码仔细分析后，我自己也去面试试试，可是拖到了现在也没机会了。</p>
<p><code>GridView</code>与<code>ListView</code>都继承自<code>AbsListView</code>，他俩的实现也比较类似，这里就不说<code>GridView</code>了。只说一下<code>ListView</code>。<br>首先看一下<code>ListView</code>的文档:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Implementation Notes:</div><div class="line"> *</div><div class="line"> * Some terminology:</div><div class="line"> *</div><div class="line"> *     index    - index of the items that are currently visible</div><div class="line"> *     position - index of the items in the cursor</div><div class="line"> */</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A view that shows items in a vertically scrolling list. The items</div><div class="line"> * come from the &#123;<span class="doctag">@link</span> ListAdapter&#125; associated with this view.</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>然后再说一下<code>ListView</code>的继承关系<code>ListView extends AbsListView extends AdapterView&lt;ListAdapter&gt; extends ViewGroup extends View</code>。<br><code>ListView</code>与其他空间不一样，不是拖到界面上就能用，而是要通过设置适配器来添加条目。这就是<code>AdapterView</code>的主要功能。既然通过适配器来操作数据。<br>这里自然想到的就是<code>MVC</code>设计模式。     </p>
<ul>
<li><code>Data</code>     - <code>M</code>                </li>
<li><code>ListView</code> - <code>V</code></li>
<li><code>Adapter</code>  - <code>C</code></li>
</ul>
<p>到这里我们写罗列一下我们将要分析的内容:      </p>
<ul>
<li><code>ListView</code>与<code>Adapter</code>间的调用。</li>
<li><code>ListView</code>上下滑动时操作及缓存。 </li>
</ul>
<p>我们平时使用<code>ListView</code>的时候都是调用<code>setAdapter()</code>方法，所以我们这里就从该方法入手:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Sets the data behind this ListView.</div><div class="line">    *</div><div class="line">    * The adapter passed to this method may be wrapped by a &#123;<span class="doctag">@link</span> WrapperListAdapter&#125;,</div><div class="line">    * depending on the ListView features currently in use. For instance, adding</div><div class="line">    * headers and/or footers will cause the adapter to be wrapped.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> adapter The ListAdapter which is responsible for maintaining the</div><div class="line">    *        data backing this list and for producing a view to represent an</div><div class="line">    *        item in that data set.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@see</span> #getAdapter() </div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(ListAdapter adapter)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mDataSetObserver != <span class="keyword">null</span>) &#123;</div><div class="line">   	    <span class="comment">// 取消之前注册过的Adapter</span></div><div class="line">           mAdapter.unregisterDataSetObserver(mDataSetObserver);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 清空所有的数据</span></div><div class="line">       resetList();	</div><div class="line">       <span class="comment">// The data set used to store unused views that should be reused during the next layout to avoid creating new ones.</span></div><div class="line">       <span class="comment">// 从注释中可以很明显的看出`View`的复用是通过`RecycleBin`类来实现的。它就决定了为什么`ListView`可以显示很多数据缺不会内存溢出。</span></div><div class="line">       mRecycler.clear();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mHeaderViewInfos.size() &gt; <span class="number">0</span>|| mFooterViewInfos.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">// 如果有HeaderView或者FooterView就把Adapter重新封装下,这是什么设计模式？－装饰</span></div><div class="line">		<span class="comment">// mHeaderViewInfos和mFooterViewInfos分别是header view和foooter view装饰类FixedViewInfo的集合。</span></div><div class="line">		<span class="comment">// 会在addHeaderView()和addFooterView()中进行添加。</span></div><div class="line">           mAdapter = <span class="keyword">new</span> HeaderViewListAdapter(mHeaderViewInfos, mFooterViewInfos, adapter);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           mAdapter = adapter;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mOldSelectedPosition = INVALID_POSITION;</div><div class="line">       mOldSelectedRowId = INVALID_ROW_ID;</div><div class="line"></div><div class="line">       <span class="comment">// AbsListView#setAdapter will update choice mode states.</span></div><div class="line">       <span class="keyword">super</span>.setAdapter(adapter);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">           mAreAllItemsSelectable = mAdapter.areAllItemsEnabled();</div><div class="line">           mOldItemCount = mItemCount;</div><div class="line">           mItemCount = mAdapter.getCount();</div><div class="line">           checkFocus();</div><div class="line"></div><div class="line">           mDataSetObserver = <span class="keyword">new</span> AdapterDataSetObserver();</div><div class="line">           mAdapter.registerDataSetObserver(mDataSetObserver); </div><div class="line">           <span class="comment">// 将viewtypecount设置给RecycleBin</span></div><div class="line">           mRecycler.setViewTypeCount(mAdapter.getViewTypeCount());</div><div class="line"></div><div class="line">           <span class="keyword">int</span> position;</div><div class="line">           <span class="comment">// mStackFromBottom Indicates whether the list is stacked from the bottom edge or the top edge.</span></div><div class="line">           <span class="keyword">if</span> (mStackFromBottom) &#123;</div><div class="line">               position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           setSelectedPositionInt(position);</div><div class="line">           setNextSelectedPositionInt(position);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// Nothing selected</span></div><div class="line">               checkSelectionChanged();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           mAreAllItemsSelectable = <span class="keyword">true</span>;</div><div class="line">           checkFocus();</div><div class="line">           <span class="comment">// Nothing selected</span></div><div class="line">           checkSelectionChanged();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">// 请求layout了，这个就很重要了啊...我们稍后看一下。</span></div><div class="line">       requestLayout();</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">    * The list is empty. Clear everything out.</div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">resetList</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// The parent's resetList() will remove all views from the layout so we need to</span></div><div class="line">       <span class="comment">// cleanup the state of our footers and headers</span></div><div class="line">       clearRecycledState(mHeaderViewInfos);</div><div class="line">       clearRecycledState(mFooterViewInfos);</div><div class="line">       <span class="comment">// The list is empty. Clear everything out.</span></div><div class="line">       <span class="keyword">super</span>.resetList();</div><div class="line"></div><div class="line">       mLayoutMode = LAYOUT_NORMAL;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearRecycledState</span><span class="params">(ArrayList&lt;FixedViewInfo&gt; infos)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (infos != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> count = infos.size();</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">               <span class="keyword">final</span> View child = infos.get(i).view;</div><div class="line">               <span class="keyword">final</span> LayoutParams p = (LayoutParams) child.getLayoutParams();</div><div class="line">               <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">			    <span class="comment">// 这里p就是AbsListView.LayoutParams。对于recycledHeaderFooter在注释中是这样说的. </span></div><div class="line">				<span class="comment">/**</span></div><div class="line">				 * When this boolean is set, the view has been added to the AbsListView</div><div class="line">				 * at least once. It is used to know whether headers/footers have already</div><div class="line">				 * been added to the list view and whether they should be treated as</div><div class="line">				 * recycled views or not.</div><div class="line">				 */</div><div class="line">                   p.recycledHeaderFooter = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>setAdapter()</code>方法中会调用<code>requestLayout()</code>方法。而<code>requestLayout()</code>方法会调用<code>onLayout()</code>方法，但是我们在<code>ListView</code>中找不到<code>onLayout()</code>方法。<br>那就去他的父类<code>AbsListView</code>中找。我们接着来看一下<code>AbsListView.onLayout()</code>方法的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Subclasses should NOT override this method but</div><div class="line"> *  &#123;<span class="doctag">@link</span> #layoutChildren()&#125; instead.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">	<span class="keyword">if</span> (changed) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			getChildAt(i).forceLayout();</div><div class="line">		&#125;</div><div class="line">		mRecycler.markChildrenDirty();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 调用layoutChildren()方法。</span></div><div class="line">	layoutChildren();</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn't belong in onLayout().</span></div><div class="line">	<span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">		mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>AbsListView.layoutChildren()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Subclasses must override this method to layout their children.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实现是空的,文档说的很明白了，子类必须要去实现该方法，这也是应该的，因为<code>ListView</code>和<code>GridView</code>的展现是不一样的.所以我们看一下<code>ListView.layoutChildren()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// When set to true, calls to requestLayout() will not propagate up the parent hierarchy.</span></div><div class="line">    <span class="comment">// This is used to layout the children during a layout pass.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">	<span class="keyword">if</span> (blockLayoutRequests) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 开始了，置为true</span></div><div class="line">	mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">super</span>.layoutChildren();</div><div class="line"></div><div class="line">		invalidate();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">			resetList();</div><div class="line">			invokeOnItemScrollListener();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">		<span class="keyword">int</span> delta = <span class="number">0</span>;</div><div class="line"></div><div class="line">		View sel;</div><div class="line">		View oldSel = <span class="keyword">null</span>;</div><div class="line">		View oldFirst = <span class="keyword">null</span>;</div><div class="line">		View newSel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="comment">// Remember stuff we will need down below</span></div><div class="line">		<span class="comment">// mLayoutMode的注释为Controls how the next layout will happen，默认为LAYOUT_NORMAL</span></div><div class="line">		<span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">			index = mNextSelectedPosition - mFirstPosition;</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">				newSel = getChildAt(index);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">		<span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">		<span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="comment">// Remember the previously selected view</span></div><div class="line">			index = mSelectedPosition - mFirstPosition;</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">				oldSel = getChildAt(index);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Remember the previous first child</span></div><div class="line">			oldFirst = getChildAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Caution: newSel might be null</span></div><div class="line">			newSel = getChildAt(index + delta);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// mDataChanged变量标记Adapter中数据是否发生变化</span></div><div class="line">		<span class="keyword">boolean</span> dataChanged = mDataChanged;</div><div class="line">		<span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">			handleDataChanged();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Handle the empty set by removing all views that are visible</span></div><div class="line">		<span class="comment">// and calling it a day</span></div><div class="line">		<span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">			resetList();</div><div class="line">			invokeOnItemScrollListener();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></div><div class="line">					+ <span class="string">"ListView did not receive a notification. Make sure the content of "</span></div><div class="line">					+ <span class="string">"your adapter is not modified from a background thread, but only from "</span></div><div class="line">					+ <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></div><div class="line">					+ <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</div><div class="line">					+ <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">		AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = <span class="keyword">null</span>;</div><div class="line">		View accessibilityFocusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">int</span> accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">		<span class="comment">// Remember which child, if any, had accessibility focus. This must</span></div><div class="line">		<span class="comment">// occur before recycling any views, since that will clear</span></div><div class="line">		<span class="comment">// accessibility focus.</span></div><div class="line">		<span class="keyword">final</span> ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">		<span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">			<span class="keyword">if</span> (focusHost != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">				<span class="keyword">if</span> (focusChild != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">							|| focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">						<span class="comment">// The views won't be changing, so try to maintain</span></div><div class="line">						<span class="comment">// focus on the current host and virtual view.</span></div><div class="line">						accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">						accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">								.getAccessibilityFocusedVirtualView();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">// If all else fails, maintain focus at the same</span></div><div class="line">					<span class="comment">// position.</span></div><div class="line">					accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		View focusLayoutRestoreDirectChild = <span class="keyword">null</span>;</div><div class="line">		View focusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="comment">// Take focus back to us temporarily to avoid the eventual call to</span></div><div class="line">		<span class="comment">// clear focus when removing the focused child below from messing</span></div><div class="line">		<span class="comment">// things up when ViewAncestor assigns focus back to someone else.</span></div><div class="line">		<span class="keyword">final</span> View focusedChild = getFocusedChild();</div><div class="line">		<span class="keyword">if</span> (focusedChild != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> in some cases focusedChild.getParent() == null</span></div><div class="line"></div><div class="line">			<span class="comment">// We can remember the focused view to restore after re-layout</span></div><div class="line">			<span class="comment">// if the data hasn't changed, or if the focused position is a</span></div><div class="line">			<span class="comment">// header or footer.</span></div><div class="line">			<span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)) &#123;</div><div class="line">				focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">				<span class="comment">// Remember the specific view that had focus.</span></div><div class="line">				focusLayoutRestoreView = findFocus();</div><div class="line">				<span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Tell it we are going to mess with it.</span></div><div class="line">					focusLayoutRestoreView.onStartTemporaryDetach();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			requestFocus();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Pull all children into the RecycleBin.</span></div><div class="line">		<span class="comment">// These views will be reused if possible</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line">		<span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</div><div class="line">		<span class="comment">// RecycleBin控制着整个item的复用，等最后我们再仔细分析下RecycleBin类</span></div><div class="line">		<span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">		    <span class="comment">// 如果数据发生变化，就把现在的View都添加到一个废弃的View进行缓存，RecycleBin.addScrapView()方法就是缓存一些废弃的View</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">				recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">		    <span class="comment">// 调用这个方法后就会根据传入的参数来将ListView中的指定元素存储到mActiveViews数组当中。</span></div><div class="line">			recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Clear out old views</span></div><div class="line">		detachAllViewsFromParent();</div><div class="line">		recycleBin.removeSkippedScrap();</div><div class="line">		<span class="comment">// mLayoutMode默认是LAYOUT_NORMAL</span></div><div class="line">		<span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">			<span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</div><div class="line">				sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">			sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">			sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">			adjustViewsUpOrDown();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">			mFirstPosition = <span class="number">0</span>;</div><div class="line">			sel = fillFromTop(childrenTop);</div><div class="line">			adjustViewsUpOrDown();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">			sel = fillSpecific(reconcileSelectedPosition(), mSpecificTop);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">			sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">		    <span class="comment">// 第一次调用layoutChildren方法的时候是还没有layout的，所以这时候childCount是0</span></div><div class="line">			<span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">			    <span class="comment">// mStackFromBottom的注释Indicates whether the list is stacked from the bottom edge or the top edge.</span></div><div class="line">				<span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">				    <span class="comment">// 默认的布局方式是从上往下的。</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">					setSelectedPositionInt(position);</div><div class="line">					<span class="comment">// 调用fillFromTop方法。</span></div><div class="line">					sel = fillFromTop(childrenTop);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">					setSelectedPositionInt(position);</div><div class="line">					sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			    <span class="comment">// 如果已经有条目了就会走到这里</span></div><div class="line">				<span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">					sel = fillSpecific(mSelectedPosition,</div><div class="line">							oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">				    <span class="comment">// 没有选中的条目</span></div><div class="line">					<span class="comment">// TODO 一会先分析上面的fillFromTop部分，把其全部分析完后再回来分析这里。</span></div><div class="line">					sel = fillSpecific(mFirstPosition,</div><div class="line">							oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					sel = fillSpecific(<span class="number">0</span>, childrenTop);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Flush any cached views that did not get reused above</span></div><div class="line">		recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (sel != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// The current selected item should get focus if items are</span></div><div class="line">			<span class="comment">// focusable.</span></div><div class="line">			<span class="keyword">if</span> (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">boolean</span> focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">						focusLayoutRestoreView != <span class="keyword">null</span> &amp;&amp;</div><div class="line">						focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">				<span class="keyword">if</span> (!focusWasTaken) &#123;</div><div class="line">					<span class="comment">// Selected item didn't take focus, but we still want to</span></div><div class="line">					<span class="comment">// make sure something else outside of the selected view</span></div><div class="line">					<span class="comment">// has focus.</span></div><div class="line">					<span class="keyword">final</span> View focused = getFocusedChild();</div><div class="line">					<span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</div><div class="line">						focused.clearFocus();</div><div class="line">					&#125;</div><div class="line">					positionSelector(INVALID_POSITION, sel);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					sel.setSelected(<span class="keyword">false</span>);</div><div class="line">					mSelectorRect.setEmpty();</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				positionSelector(INVALID_POSITION, sel);</div><div class="line">			&#125;</div><div class="line">			mSelectedTop = sel.getTop();</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">					|| mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">			<span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">				<span class="comment">// If the user's finger is down, select the motion position.</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">				<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">					positionSelector(mMotionPosition, child);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">				<span class="comment">// If we had previously positioned the selector somewhere,</span></div><div class="line">				<span class="comment">// put it back there. It might not match up with the data,</span></div><div class="line">				<span class="comment">// but it's transitioning out so it's not a big deal.</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">				<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">					positionSelector(mSelectorPosition, child);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Otherwise, clear selection.</span></div><div class="line">				mSelectedTop = <span class="number">0</span>;</div><div class="line">				mSelectorRect.setEmpty();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Even if there is not selected position, we may need to</span></div><div class="line">			<span class="comment">// restore focus (i.e. something focusable in touch mode).</span></div><div class="line">			<span class="keyword">if</span> (hasFocus() &amp;&amp; focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">				focusLayoutRestoreView.requestFocus();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Attempt to restore accessibility focus, if necessary.</span></div><div class="line">		<span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">			<span class="keyword">if</span> (newAccessibilityFocusedView == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (accessibilityFocusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">						&amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">					<span class="keyword">final</span> AccessibilityNodeProvider provider =</div><div class="line">							accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">					<span class="keyword">if</span> (accessibilityFocusLayoutRestoreNode != <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">								accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">						provider.performAction(virtualViewId,</div><div class="line">								AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, <span class="keyword">null</span>);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">					<span class="comment">// Bound the position within the visible children.</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = MathUtils.constrain(</div><div class="line">							accessibilityFocusPosition - mFirstPosition, <span class="number">0</span>,</div><div class="line">							getChildCount() - <span class="number">1</span>);</div><div class="line">					<span class="keyword">final</span> View restoreView = getChildAt(position);</div><div class="line">					<span class="keyword">if</span> (restoreView != <span class="keyword">null</span>) &#123;</div><div class="line">						restoreView.requestAccessibilityFocus();</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Tell focus view we are done mucking with it, if it is still in</span></div><div class="line">		<span class="comment">// our view hierarchy.</span></div><div class="line">		<span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">				&amp;&amp; focusLayoutRestoreView.getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">			focusLayoutRestoreView.onFinishTemporaryDetach();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		mLayoutMode = LAYOUT_NORMAL;</div><div class="line">		mDataChanged = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mPositionScrollAfterLayout != <span class="keyword">null</span>) &#123;</div><div class="line">			post(mPositionScrollAfterLayout);</div><div class="line">			mPositionScrollAfterLayout = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		mNeedSync = <span class="keyword">false</span>;</div><div class="line">		setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">		updateScrollIndicators();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			checkSelectionChanged();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		invokeOnItemScrollListener();</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">if</span> (!blockLayoutRequests) &#123;</div><div class="line">			mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面看到会调用<code>fillFromTop()</code>方法，我们看一下该方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the list from top to bottom, starting with mFirstPosition</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> nextTop The location where the top of the first item should be</div><div class="line"> *        drawn</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The view that is currently selected</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillFromTop</span><span class="params">(<span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">	mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</div><div class="line">	mFirstPosition = Math.min(mFirstPosition, mItemCount - <span class="number">1</span>);</div><div class="line">	<span class="keyword">if</span> (mFirstPosition &lt; <span class="number">0</span>) &#123;</div><div class="line">		mFirstPosition = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 调用fillDown()方法。</span></div><div class="line">	<span class="keyword">return</span> fillDown(mFirstPosition, nextTop);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下<code>fillDown()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the list from pos down to the end of the list view.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> pos The first position to put in the list</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> nextTop The location where the top of the item associated with pos</div><div class="line"> *        should be drawn</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The view that is currently selected, if it happens to be in the</div><div class="line"> *         range that we draw.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillDown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">	View selectedView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> end = (mBottom - mTop);</div><div class="line">	<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">		end -= mListPadding.bottom;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 用一个循环一直去填充，nextTop与end的比较来判断是否超过当前屏幕了，这就是为什么ListView就算有一万条最开始载入也不卡，因为他只初始化一屏啊。</span></div><div class="line">	<span class="comment">// 以后都是边滑动边显示啊，说到这里一会我们还要看一下手势部分的处理。pos和mItemCount的比较来判断当前是否已经把所有条目填充完</span></div><div class="line">	<span class="keyword">while</span> (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</div><div class="line">		<span class="comment">// is this the selected item?</span></div><div class="line">		<span class="keyword">boolean</span> selected = pos == mSelectedPosition;</div><div class="line">		<span class="comment">// 调用makeAndAddView方法</span></div><div class="line">		View child = makeAndAddView(pos, nextTop, <span class="keyword">true</span>, mListPadding.left, selected);</div><div class="line"></div><div class="line">		nextTop = child.getBottom() + mDividerHeight;</div><div class="line">		<span class="keyword">if</span> (selected) &#123;</div><div class="line">			selectedView = child;</div><div class="line">		&#125;</div><div class="line">		pos++;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</div><div class="line">	<span class="keyword">return</span> selectedView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来看一下<code>makeAndAddView()</code>方法，文档里面说的非常清楚了:　　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Obtain the view and add it to our list of children. The view can be made</div><div class="line"> * fresh, converted from an unused view, or used as is if it was in the</div><div class="line"> * recycle bin.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position Logical position in the list</div><div class="line"> * <span class="doctag">@param</span> y Top or bottom edge of the view to add</div><div class="line"> * <span class="doctag">@param</span> flow If flow is true, align top edge to y. If false, align bottom</div><div class="line"> *        edge to y.</div><div class="line"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</div><div class="line"> * <span class="doctag">@param</span> selected Is this position selected?</div><div class="line"> * <span class="doctag">@return</span> View that was added</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">		<span class="keyword">boolean</span> selected) &#123;</div><div class="line">	View child;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">		<span class="comment">// Try to use an existing view for this position</span></div><div class="line">		child = mRecycler.getActiveView(position);</div><div class="line">		<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// Found it -- we're using an existing child</span></div><div class="line">			<span class="comment">// This just needs to be positioned</span></div><div class="line">			<span class="comment">// 最后一个参数为true说明是复用的</span></div><div class="line">			setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">			<span class="keyword">return</span> child;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Make a new view for this position, or convert an unused view if possible</span></div><div class="line">	<span class="comment">// 一会我们先看一下obtainView方法，这个方法其实就是创建一个childView</span></div><div class="line">	<span class="comment">// obtainView方法中会更改mIsScrap[0]的值，以便下面setupChild()中使用。</span></div><div class="line">	child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">	<span class="comment">// This needs to be positioned and measured</span></div><div class="line">	<span class="comment">// 把childView添加到listview中，这里最后一个参数会是false</span></div><div class="line">	setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>makeAndAddView()</code>方法里面就是通过<code>RecycleBin</code>来复用<code>View</code>，如果不存在可以复用的<code>View</code>时就创建一个新的。<br>那我们就先看一下`obtainView()方法，这个方法中的注释写的非常清楚，谷歌大神写代码就是规范，不想某些牛逼哄哄的人整天咋呼敏捷开发，一个注释也不写，那能叫敏捷？。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a view and have it show the data associated with the specified</div><div class="line"> * position. This is called when we have already discovered that the view is</div><div class="line"> * not available for reuse in the recycle bin. The only choices left are</div><div class="line"> * converting an old view or making a new one.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position The position to display</div><div class="line"> * <span class="doctag">@param</span> isScrap Array of at least 1 boolean, the first entry will become true if</div><div class="line"> *                the returned view was taken from the scrap heap, false if otherwise.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> A view displaying the data associated with the specified position</div><div class="line"> */</div><div class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] isScrap)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"obtainView"</span>);</div><div class="line"></div><div class="line">	isScrap[<span class="number">0</span>] = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Check whether we have a transient state view. Attempt to re-bind the</span></div><div class="line">	<span class="comment">// data and discard the view if we fail.</span></div><div class="line">	<span class="keyword">final</span> View transientView = mRecycler.getTransientStateView(position);</div><div class="line">	<span class="keyword">if</span> (transientView != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> LayoutParams params = (LayoutParams) transientView.getLayoutParams();</div><div class="line"></div><div class="line">		<span class="comment">// If the view type hasn't changed, attempt to re-bind the data.</span></div><div class="line">		<span class="keyword">if</span> (params.viewType == mAdapter.getItemViewType(position)) &#123;</div><div class="line">			<span class="keyword">final</span> View updatedView = mAdapter.getView(position, transientView, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">			<span class="comment">// If we failed to re-bind the data, scrap the obtained view.</span></div><div class="line">			<span class="keyword">if</span> (updatedView != transientView) &#123;</div><div class="line">				setItemViewLayoutParams(updatedView, position);</div><div class="line">				mRecycler.addScrapView(updatedView, position);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Scrap view implies temporary detachment.</span></div><div class="line">		isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">return</span> transientView;</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// getScrapView()方法会从废弃View的缓存中去取，一旦View移除了屏幕就会被加到该废弃缓存中，所以他就是当View移除屏幕了就加到该缓存中</span></div><div class="line">	<span class="comment">// 显示的时候再从该缓存中取，就这样进行了复用。</span></div><div class="line">	<span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</div><div class="line">	<span class="comment">// 调用Adapter.getView()方法了。并且将scrapView作为converview的参数传入。这个方法都挺熟，就不说了。</span></div><div class="line">	<span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (child != scrapView) &#123;</div><div class="line">			<span class="comment">// Failed to re-bind the data, return scrap to the heap.</span></div><div class="line">			mRecycler.addScrapView(scrapView, position);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">			child.dispatchFinishTemporaryDetach();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;</div><div class="line">		child.setDrawingCacheBackgroundColor(mCacheColorHint);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</div><div class="line">		child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 设置该view的layoutparams</span></div><div class="line">	setItemViewLayoutParams(child, position);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</div><div class="line">		<span class="keyword">if</span> (mAccessibilityDelegate == <span class="keyword">null</span>) &#123;</div><div class="line">			mAccessibilityDelegate = <span class="keyword">new</span> ListItemAccessibilityDelegate();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (child.getAccessibilityDelegate() == <span class="keyword">null</span>) &#123;</div><div class="line">			child.setAccessibilityDelegate(mAccessibilityDelegate);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里我们就把<code>obtainView()</code>方法都看完了，接下来我们再看一下<code>setupChild()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Add a view as a child and make sure it is measured (if necessary) and</div><div class="line"> * positioned properly.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The view to add</div><div class="line"> * <span class="doctag">@param</span> position The position of this child</div><div class="line"> * <span class="doctag">@param</span> y The y position relative to which this view will be positioned</div><div class="line"> * <span class="doctag">@param</span> flowDown If true, align top edge to y. If false, align bottom</div><div class="line"> *        edge to y.</div><div class="line"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</div><div class="line"> * <span class="doctag">@param</span> selected Is this position selected?</div><div class="line"> * <span class="doctag">@param</span> recycled Has this view been pulled from the recycle bin? If so it</div><div class="line"> *        does not need to be remeasured.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">		<span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> recycled) &#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"setupListItem"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isSelected = selected &amp;&amp; shouldShowSelector();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> updateChildSelected = isSelected != child.isSelected();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> mode = mTouchMode;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isPressed = mode &gt; TOUCH_MODE_DOWN &amp;&amp; mode &lt; TOUCH_MODE_SCROLL &amp;&amp;</div><div class="line">			mMotionPosition == position;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> updateChildPressed = isPressed != child.isPressed();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> needToMeasure = !recycled || updateChildSelected || child.isLayoutRequested();</div><div class="line"></div><div class="line">	<span class="comment">// Respect layout params that are already in the view. Otherwise make some up...</span></div><div class="line">	<span class="comment">// noinspection unchecked</span></div><div class="line">	AbsListView.LayoutParams p = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">	<span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">		p = (AbsListView.LayoutParams) generateDefaultLayoutParams();</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 这里就是Adapter中getItemViewType的调用处</span></div><div class="line">	p.viewType = mAdapter.getItemViewType(position);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((recycled &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter &amp;&amp;</div><div class="line">			p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">		<span class="comment">// 复用的或者headerView及footerView等调用attachViewToParent方法，把之前detach的View重新attach到ViewGroup上</span></div><div class="line">		attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		p.forceAdd = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">			p.recycledHeaderFooter = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 第一次都是通过该方法来把View添加到ViewGroup中</span></div><div class="line">		addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (updateChildSelected) &#123;</div><div class="line">		child.setSelected(isSelected);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (updateChildPressed) &#123;</div><div class="line">		child.setPressed(isPressed);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</div><div class="line">			((Checkable) child).setChecked(mCheckStates.get(position));</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</div><div class="line">				&gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">			child.setActivated(mCheckStates.get(position));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">		<span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</div><div class="line">				mListPadding.left + mListPadding.right, p.width);</div><div class="line">		<span class="keyword">int</span> lpHeight = p.height;</div><div class="line">		<span class="keyword">int</span> childHeightSpec;</div><div class="line">		<span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">			childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			childHeightSpec = MeasureSpec.makeMeasureSpec(<span class="number">0</span>, MeasureSpec.UNSPECIFIED);</div><div class="line">		&#125;</div><div class="line">		child.measure(childWidthSpec, childHeightSpec);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		cleanupLayoutState(child);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</div><div class="line">		child.layout(childrenLeft, childTop, childRight, childBottom);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		child.offsetLeftAndRight(childrenLeft - child.getLeft());</div><div class="line">		child.offsetTopAndBottom(childTop - child.getTop());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mCachingStarted &amp;&amp; !child.isDrawingCacheEnabled()) &#123;</div><div class="line">		child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (recycled &amp;&amp; (((AbsListView.LayoutParams)child.getLayoutParams()).scrappedFromPosition)</div><div class="line">			!= position) &#123;</div><div class="line">		child.jumpDrawablesToCurrentState();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过分析我们看到核心的部分就是<code>attachViewToParent()</code>方法和<code>addViewInLayout()</code>方法，这两个方法都是父类<code>ViewGroup</code>中的方法，<br>我们分别来看一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Attaches a view to this view group. Attaching a view assigns this group as the parent,</div><div class="line"> * sets the layout parameters and puts the view in the list of children so that</div><div class="line"> * it can be retrieved by calling &#123;<span class="doctag">@link</span> #getChildAt(int)&#125;.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This method is intended to be lightweight and makes no assumptions about whether the</div><div class="line"> * parent or child should be redrawn. Proper use of this method will include also making</div><div class="line"> * any appropriate &#123;<span class="doctag">@link</span> #requestLayout()&#125; or &#123;<span class="doctag">@link</span> #invalidate()&#125; calls.</div><div class="line"> * For example, callers can &#123;<span class="doctag">@link</span> #post(Runnable) post&#125; a &#123;<span class="doctag">@link</span> Runnable&#125;</div><div class="line"> * which performs a &#123;<span class="doctag">@link</span> #requestLayout()&#125; on the next frame, after all detach/attach</div><div class="line"> * calls are finished, causing layout to be run prior to redrawing the view hierarchy.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This method should be called only for views which were detached from their parent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child the child to attach</div><div class="line"> * <span class="doctag">@param</span> index the index at which the child should be attached</div><div class="line"> * <span class="doctag">@param</span> params the layout parameters of the child</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #removeDetachedView(View, boolean)</div><div class="line"> * <span class="doctag">@see</span> #detachAllViewsFromParent()</div><div class="line"> * <span class="doctag">@see</span> #detachViewFromParent(View)</div><div class="line"> * <span class="doctag">@see</span> #detachViewFromParent(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachViewToParent</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params)</span> </span>&#123;</div><div class="line">	child.mLayoutParams = params;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">		index = mChildrenCount;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 把该view添加到数组中，就像注释所说的为了能够让`getChildAt()`方法能获取到。</span></div><div class="line">	addInArray(child, index);</div><div class="line"></div><div class="line">	child.mParent = <span class="keyword">this</span>;</div><div class="line">	child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK</div><div class="line">					&amp; ~PFLAG_DRAWING_CACHE_VALID)</div><div class="line">			| PFLAG_DRAWN | PFLAG_INVALIDATED;</div><div class="line">	<span class="keyword">this</span>.mPrivateFlags |= PFLAG_INVALIDATED;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (child.hasFocus()) &#123;</div><div class="line">		requestChildFocus(child, child.findFocus());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>复用的处理看完后，我们看一下新创建的childView如何被添加到ListView上，我们看一下<code>addViewInLayout()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adds a view during layout. This is useful if in your onLayout() method,</div><div class="line"> * you need to add more views (as does the list view for example).</div><div class="line"> *</div><div class="line"> * If index is negative, it means put it at the end of the list.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child the view to add to the group</div><div class="line"> * <span class="doctag">@param</span> index the index at which the child must be added</div><div class="line"> * <span class="doctag">@param</span> params the layout parameters to associate with the child</div><div class="line"> * <span class="doctag">@param</span> preventRequestLayout if true, calling this method will not trigger a</div><div class="line"> *        layout request on child</div><div class="line"> * <span class="doctag">@return</span> true if the child was added, false otherwise</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">addViewInLayout</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params,</span></span></div><div class="line">		<span class="keyword">boolean</span> preventRequestLayout) &#123;</div><div class="line">	<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add a null child view to a ViewGroup"</span>);</div><div class="line">	&#125;</div><div class="line">	child.mParent = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 这个方法最终会调用addView方法添加childView</span></div><div class="line">	addViewInner(child, index, params, preventRequestLayout);</div><div class="line">	child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里已经把上面<code>fillFromTop()</code>方法的部分都分析完了。<br>不要忘了我们上面还留了一个TODO的部分，就是对于已经有数据的部分调用<code>fillSpecific()</code>方法，那我们就看一下他的实现:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Put a specific item at a specific location on the screen and then build</div><div class="line"> * up and down from there.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position The reference view to use as the starting point</div><div class="line"> * <span class="doctag">@param</span> top Pixel offset from the top of this view to the top of the</div><div class="line"> *        reference view.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The selected view, or null if the selected view is outside the</div><div class="line"> *         visible area.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillSpecific</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> top)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> tempIsSelected = position == mSelectedPosition;</div><div class="line">	View temp = makeAndAddView(position, top, <span class="keyword">true</span>, mListPadding.left, tempIsSelected);</div><div class="line">	<span class="comment">// Possibly changed again in fillUp if we add rows above this one.</span></div><div class="line">	mFirstPosition = position;</div><div class="line"></div><div class="line">	View above;</div><div class="line">	View below;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> dividerHeight = mDividerHeight;</div><div class="line">	<span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">		above = fillUp(position - <span class="number">1</span>, temp.getTop() - dividerHeight);</div><div class="line">		<span class="comment">// This will correct for the top of the first view not touching the top of the list</span></div><div class="line">		adjustViewsUpOrDown();</div><div class="line">		below = fillDown(position + <span class="number">1</span>, temp.getBottom() + dividerHeight);</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			correctTooHigh(childCount);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		below = fillDown(position + <span class="number">1</span>, temp.getBottom() + dividerHeight);</div><div class="line">		<span class="comment">// This will correct for the bottom of the last view not touching the bottom of the list</span></div><div class="line">		adjustViewsUpOrDown();</div><div class="line">		above = fillUp(position - <span class="number">1</span>, temp.getTop() - dividerHeight);</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			 correctTooLow(childCount);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tempIsSelected) &#123;</div><div class="line">		<span class="keyword">return</span> temp;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (above != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> above;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> below;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就像注释所说的它是让指定位置的View先加载到屏幕上，然后在加载该view往上以及往下位置的其他View，他里面会调用<code>fillUp()</code>和<code>fillDown()</code>方法，又会走上面的流程，所以这里就不分析了。</p>
<p>好了，到这里我们就基本已经分析完了，但是感觉好像好少了点什么？　　　</p>
<p>这里少了不是一点，是两点:      </p>
<ul>
<li>手势滑动过程中ListView的复用处理</li>
<li>RecycleBin中复用的具体实现</li>
</ul>
<p>一个个的来，先看一下手势滑动部分，这个当然是从<code>onTouchEvent()</code>方法看了，<br>手势这一块不太清楚的可以看我之前的一篇文章<br><a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/Android%20Touch%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E8%AF%A6%E8%A7%A3.md">Android Touch事件分发详解</a></p>
<p>发现<code>ListView</code>没有重写<code>onTouchEvent()</code>方法，这也好理解，因为<code>GridView</code>也有类似的滑动功能，所以去父类<code>AbsListView</code>中看.<br>我们看一下<code>AbsListView.onTouchEvent()</code>方法:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!isEnabled()) &#123;</div><div class="line">		<span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">		<span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">		<span class="keyword">return</span> isClickable() || isLongClickable();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mPositionScroller != <span class="keyword">null</span>) &#123;</div><div class="line">		mPositionScroller.stop();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mIsDetaching || !isAttachedToWindow()) &#123;</div><div class="line">		<span class="comment">// Something isn't right.</span></div><div class="line">		<span class="comment">// Since we rely on being attached to get data set change notifications,</span></div><div class="line">		<span class="comment">// don't risk doing anything where we might try to resync and find things</span></div><div class="line">		<span class="comment">// in a bogus state.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	startNestedScroll(SCROLL_AXIS_VERTICAL);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">boolean</span> intercepted = mFastScroll.onTouchEvent(ev);</div><div class="line">		<span class="keyword">if</span> (intercepted) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	initVelocityTrackerIfNotExists();</div><div class="line">	<span class="keyword">final</span> MotionEvent vtev = MotionEvent.obtain(ev);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = ev.getActionMasked();</div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		mNestedYOffset = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	vtev.offsetLocation(<span class="number">0</span>, mNestedYOffset);</div><div class="line">	<span class="keyword">switch</span> (actionMasked) &#123;</div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">			onTouchDown(ev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">		    <span class="comment">// 具体移动的部分就在这里了</span></div><div class="line">			onTouchMove(ev, vtev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">			onTouchUp(ev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">			onTouchCancel();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP: &#123;</div><div class="line">			onSecondaryPointerUp(ev);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> x = mMotionX;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> y = mMotionY;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">			<span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Remember where the motion event started</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = child.getTop();</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN: &#123;</div><div class="line">			<span class="comment">// New pointers take over dragging duties</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> index = ev.getActionIndex();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(index);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX(index);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(index);</div><div class="line">			mMotionCorrection = <span class="number">0</span>;</div><div class="line">			mActivePointerId = id;</div><div class="line">			mMotionX = x;</div><div class="line">			mMotionY = y;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">			<span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Remember where the motion event started</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = child.getTop();</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">		mVelocityTracker.addMovement(vtev);</div><div class="line">	&#125;</div><div class="line">	vtev.recycle();</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>onTouchMove()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTouchMove</span><span class="params">(MotionEvent ev, MotionEvent vtev)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">	<span class="keyword">if</span> (pointerIndex == -<span class="number">1</span>) &#123;</div><div class="line">		pointerIndex = <span class="number">0</span>;</div><div class="line">		mActivePointerId = ev.getPointerId(pointerIndex);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mDataChanged) &#123;</div><div class="line">		<span class="comment">// Re-sync everything if data has been changed</span></div><div class="line">		<span class="comment">// since the scroll operation can query the adapter.</span></div><div class="line">		layoutChildren();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(pointerIndex);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (mTouchMode) &#123;</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_DOWN:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_TAP:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_DONE_WAITING:</div><div class="line">			<span class="comment">// Check if we have moved far enough that it looks more like a</span></div><div class="line">			<span class="comment">// scroll than a tap. If so, we'll enter scrolling mode.</span></div><div class="line">			<span class="keyword">if</span> (startScrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev)) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Otherwise, check containment within list bounds. If we're</span></div><div class="line">			<span class="comment">// outside bounds, cancel any active presses.</span></div><div class="line">			<span class="keyword">final</span> View motionView = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(pointerIndex);</div><div class="line">			<span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">				setPressed(<span class="keyword">false</span>);</div><div class="line">				<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">					motionView.setPressed(<span class="keyword">false</span>);</div><div class="line">				&#125;</div><div class="line">				removeCallbacks(mTouchMode == TOUCH_MODE_DOWN ?</div><div class="line">						mPendingCheckForTap : mPendingCheckForLongPress);</div><div class="line">				mTouchMode = TOUCH_MODE_DONE_WAITING;</div><div class="line">				updateSelectorState();</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Still within bounds, update the hotspot.</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span>[] point = mTmpPoint;</div><div class="line">				point[<span class="number">0</span>] = x;</div><div class="line">				point[<span class="number">1</span>] = y;</div><div class="line">				transformPointToViewLocal(point, motionView);</div><div class="line">				motionView.drawableHotspotChanged(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_SCROLL:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_OVERSCROLL:</div><div class="line">			<span class="comment">// 滑动部分的处理，传入当前位置的x,y坐标</span></div><div class="line">			scrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>scrollIfNeeded()</code>方法的实现:　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrollIfNeeded</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, MotionEvent vtev)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> rawDeltaY = y - mMotionY;</div><div class="line">	<span class="keyword">int</span> scrollOffsetCorrection = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> scrollConsumedCorrection = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mLastY == Integer.MIN_VALUE) &#123;</div><div class="line">		rawDeltaY -= mMotionCorrection;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (dispatchNestedPreScroll(<span class="number">0</span>, mLastY != Integer.MIN_VALUE ? mLastY - y : -rawDeltaY,</div><div class="line">			mScrollConsumed, mScrollOffset)) &#123;</div><div class="line">		rawDeltaY += mScrollConsumed[<span class="number">1</span>];</div><div class="line">		scrollOffsetCorrection = -mScrollOffset[<span class="number">1</span>];</div><div class="line">		scrollConsumedCorrection = mScrollConsumed[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">			vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">			mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> deltaY = rawDeltaY;</div><div class="line">	<span class="keyword">int</span> incrementalDeltaY =</div><div class="line">			mLastY != Integer.MIN_VALUE ? y - mLastY + scrollConsumedCorrection : deltaY;</div><div class="line">	<span class="keyword">int</span> lastYCorrection = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mTouchMode == TOUCH_MODE_SCROLL) &#123;</div><div class="line">		<span class="keyword">if</span> (PROFILE_SCROLLING) &#123;</div><div class="line">			<span class="keyword">if</span> (!mScrollProfilingStarted) &#123;</div><div class="line">				Debug.startMethodTracing(<span class="string">"AbsListViewScroll"</span>);</div><div class="line">				mScrollProfilingStarted = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mScrollStrictSpan == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// If it's non-null, we're already in a scroll.</span></div><div class="line">			mScrollStrictSpan = StrictMode.enterCriticalSpan(<span class="string">"AbsListView-scroll"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">			<span class="comment">// 移动了</span></div><div class="line">			<span class="comment">// We may be here after stopping a fling and continuing to scroll.</span></div><div class="line">			<span class="comment">// If so, we haven't disallowed intercepting touch events yet.</span></div><div class="line">			<span class="comment">// Make sure that we do so in case we're in a parent that can intercept.</span></div><div class="line">			<span class="keyword">if</span> ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) == <span class="number">0</span> &amp;&amp;</div><div class="line">					Math.abs(rawDeltaY) &gt; mTouchSlop) &#123;</div><div class="line">				<span class="keyword">final</span> ViewParent parent = getParent();</div><div class="line">				<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">					parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionIndex;</div><div class="line">			<span class="keyword">if</span> (mMotionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				motionIndex = mMotionPosition - mFirstPosition;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// If we don't have a motion position that we can reliably track,</span></div><div class="line">				<span class="comment">// pick something in the middle to make a best guess at things below.</span></div><div class="line">				motionIndex = getChildCount() / <span class="number">2</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> motionViewPrevTop = <span class="number">0</span>;</div><div class="line">			View motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">			<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				motionViewPrevTop = motionView.getTop();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// No need to do all this work if we're not going to move anyway</span></div><div class="line">			<span class="keyword">boolean</span> atEdge = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">			    <span class="comment">// 移动的过程中不断调用</span></div><div class="line">				atEdge = trackMotionScroll(deltaY, incrementalDeltaY);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Check to see if we have bumped into the scroll limit</span></div><div class="line">			motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">			<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Check if the top of the motion view is where it is</span></div><div class="line">				<span class="comment">// supposed to be</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> motionViewRealTop = motionView.getTop();</div><div class="line">				<span class="keyword">if</span> (atEdge) &#123;</div><div class="line">					<span class="comment">// Apply overscroll</span></div><div class="line"></div><div class="line">					<span class="keyword">int</span> overscroll = -incrementalDeltaY -</div><div class="line">							(motionViewRealTop - motionViewPrevTop);</div><div class="line">					<span class="keyword">if</span> (dispatchNestedScroll(<span class="number">0</span>, overscroll - incrementalDeltaY, <span class="number">0</span>, overscroll,</div><div class="line">							mScrollOffset)) &#123;</div><div class="line">						lastYCorrection -= mScrollOffset[<span class="number">1</span>];</div><div class="line">						<span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">							vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">							mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">boolean</span> atOverscrollEdge = overScrollBy(<span class="number">0</span>, overscroll,</div><div class="line">								<span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">						<span class="keyword">if</span> (atOverscrollEdge &amp;&amp; mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Don't allow overfling if we're at the edge</span></div><div class="line">							mVelocityTracker.clear();</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">						<span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">								(overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">										!contentFits())) &#123;</div><div class="line">							<span class="keyword">if</span> (!atOverscrollEdge) &#123;</div><div class="line">								mDirection = <span class="number">0</span>; <span class="comment">// Reset when entering overscroll.</span></div><div class="line">								mTouchMode = TOUCH_MODE_OVERSCROLL;</div><div class="line">							&#125;</div><div class="line">							<span class="keyword">if</span> (incrementalDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">								mEdgeGlowTop.onPull((<span class="keyword">float</span>) -overscroll / getHeight(),</div><div class="line">										(<span class="keyword">float</span>) x / getWidth());</div><div class="line">								<span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">									mEdgeGlowBottom.onRelease();</div><div class="line">								&#125;</div><div class="line">								invalidate(<span class="number">0</span>, <span class="number">0</span>, getWidth(),</div><div class="line">										mEdgeGlowTop.getMaxHeight() + getPaddingTop());</div><div class="line">							&#125; <span class="keyword">else</span> <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">								mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overscroll / getHeight(),</div><div class="line">										<span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">								<span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">									mEdgeGlowTop.onRelease();</div><div class="line">								&#125;</div><div class="line">								invalidate(<span class="number">0</span>, getHeight() - getPaddingBottom() -</div><div class="line">										mEdgeGlowBottom.getMaxHeight(), getWidth(),</div><div class="line">										getHeight());</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				mMotionY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">			&#125;</div><div class="line">			mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_OVERSCROLL) &#123;</div><div class="line">	    <span class="comment">// 灰起了.</span></div><div class="line">		<span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> oldScroll = mScrollY;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> newScroll = oldScroll - incrementalDeltaY;</div><div class="line">			<span class="keyword">int</span> newDirection = y &gt; mLastY ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mDirection == <span class="number">0</span>) &#123;</div><div class="line">				mDirection = newDirection;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> overScrollDistance = -incrementalDeltaY;</div><div class="line">			<span class="keyword">if</span> ((newScroll &lt; <span class="number">0</span> &amp;&amp; oldScroll &gt;= <span class="number">0</span>) || (newScroll &gt; <span class="number">0</span> &amp;&amp; oldScroll &lt;= <span class="number">0</span>)) &#123;</div><div class="line">				overScrollDistance = -oldScroll;</div><div class="line">				incrementalDeltaY += overScrollDistance;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				incrementalDeltaY = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (overScrollDistance != <span class="number">0</span>) &#123;</div><div class="line">				overScrollBy(<span class="number">0</span>, overScrollDistance, <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">						<span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">				<span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">						(overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">								!contentFits())) &#123;</div><div class="line">					<span class="keyword">if</span> (rawDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">						mEdgeGlowTop.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">								(<span class="keyword">float</span>) x / getWidth());</div><div class="line">						<span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">							mEdgeGlowBottom.onRelease();</div><div class="line">						&#125;</div><div class="line">						invalidate(<span class="number">0</span>, <span class="number">0</span>, getWidth(),</div><div class="line">								mEdgeGlowTop.getMaxHeight() + getPaddingTop());</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">						mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">								<span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">						<span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">							mEdgeGlowTop.onRelease();</div><div class="line">						&#125;</div><div class="line">						invalidate(<span class="number">0</span>, getHeight() - getPaddingBottom() -</div><div class="line">								mEdgeGlowBottom.getMaxHeight(), getWidth(),</div><div class="line">								getHeight());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Coming back to 'real' list scrolling</span></div><div class="line">				<span class="keyword">if</span> (mScrollY != <span class="number">0</span>) &#123;</div><div class="line">					mScrollY = <span class="number">0</span>;</div><div class="line">					invalidateParentIfNeeded();</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 继续处理着</span></div><div class="line">				trackMotionScroll(incrementalDeltaY, incrementalDeltaY);</div><div class="line"></div><div class="line">				mTouchMode = TOUCH_MODE_SCROLL;</div><div class="line"></div><div class="line">				<span class="comment">// We did not scroll the full amount. Treat this essentially like the</span></div><div class="line">				<span class="comment">// start of a new touch scroll</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = findClosestMotionRow(y);</div><div class="line"></div><div class="line">				mMotionCorrection = <span class="number">0</span>;</div><div class="line">				View motionView = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = motionView != <span class="keyword">null</span> ? motionView.getTop() : <span class="number">0</span>;</div><div class="line">				mMotionY =  y + scrollOffsetCorrection;</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">			mDirection = newDirection;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这部分代码逻辑牵扯太多，有点晕呼呼的，记着看一下<code>trackMotionScroll()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Track a motion scroll</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> deltaY Amount to offset mMotionView. This is the accumulated delta since the motion</div><div class="line"> *        began. Positive numbers mean the user's finger is moving down the screen.</div><div class="line"> * <span class="doctag">@param</span> incrementalDeltaY Change in deltaY from the previous event. 通过它的正负来判断是向上还是向下。</div><div class="line"> * <span class="doctag">@return</span> true if we're already at the beginning/end of the list and have nothing to do.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">trackMotionScroll</span><span class="params">(<span class="keyword">int</span> deltaY, <span class="keyword">int</span> incrementalDeltaY)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">	<span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> firstTop = getChildAt(<span class="number">0</span>).getTop();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> lastBottom = getChildAt(childCount - <span class="number">1</span>).getBottom();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect listPadding = mListPadding;</div><div class="line"></div><div class="line">	<span class="comment">// "effective padding" In this case is the amount of padding that affects</span></div><div class="line">	<span class="comment">// how much space should not be filled by items. If we don't clip to padding</span></div><div class="line">	<span class="comment">// there is no effective padding.</span></div><div class="line">	<span class="keyword">int</span> effectivePaddingTop = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> effectivePaddingBottom = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">		effectivePaddingTop = listPadding.top;</div><div class="line">		effectivePaddingBottom = listPadding.bottom;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">// FIXME account for grid vertical spacing too?</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> spaceAbove = effectivePaddingTop - firstTop;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> end = getHeight() - effectivePaddingBottom;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> spaceBelow = lastBottom - end;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - mPaddingBottom - mPaddingTop;</div><div class="line">	<span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">		deltaY = Math.max(-(height - <span class="number">1</span>), deltaY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		deltaY = Math.min(height - <span class="number">1</span>, deltaY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">		incrementalDeltaY = Math.max(-(height - <span class="number">1</span>), incrementalDeltaY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		incrementalDeltaY = Math.min(height - <span class="number">1</span>, incrementalDeltaY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line"></div><div class="line">	<span class="comment">// Update our guesses for where the first and last views are</span></div><div class="line">	<span class="keyword">if</span> (firstPosition == <span class="number">0</span>) &#123;</div><div class="line">		mFirstPositionDistanceGuess = firstTop - listPadding.top;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mFirstPositionDistanceGuess += incrementalDeltaY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (firstPosition + childCount == mItemCount) &#123;</div><div class="line">		mLastPositionDistanceGuess = lastBottom + listPadding.bottom;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mLastPositionDistanceGuess += incrementalDeltaY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollDown = (firstPosition == <span class="number">0</span> &amp;&amp;</div><div class="line">			firstTop &gt;= listPadding.top &amp;&amp; incrementalDeltaY &gt;= <span class="number">0</span>);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollUp = (firstPosition + childCount == mItemCount &amp;&amp;</div><div class="line">			lastBottom &lt;= getHeight() - listPadding.bottom &amp;&amp; incrementalDeltaY &lt;= <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (cannotScrollDown || cannotScrollUp) &#123;</div><div class="line">		<span class="keyword">return</span> incrementalDeltaY != <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 判断向上还是向下</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = isInTouchMode();</div><div class="line">	<span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">		hideSelector();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> headerViewsCount = getHeaderViewsCount();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> footerViewsStart = mItemCount - getFooterViewsCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (down) &#123;</div><div class="line">		<span class="keyword">int</span> top = -incrementalDeltaY;</div><div class="line">		<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">			top += listPadding.top;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getBottom() &gt;= top) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			    <span class="comment">// 如果这个View的底部位置已经小于top值了，说明这个view已经移除屏幕了，不可见了</span></div><div class="line">				count++;</div><div class="line">				<span class="keyword">int</span> position = firstPosition + i;</div><div class="line">				<span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">					<span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">					<span class="comment">// system-managed transient state.</span></div><div class="line">					child.clearAccessibilityFocus();</div><div class="line">					<span class="comment">// 只要该view移除屏幕就把该view添加到废弃的缓存中</span></div><div class="line">					mRecycler.addScrapView(child, position);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">int</span> bottom = getHeight() - incrementalDeltaY;</div><div class="line">		<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">			bottom -= listPadding.bottom;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getTop() &lt;= bottom) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				start = i;</div><div class="line">				count++;</div><div class="line">				<span class="keyword">int</span> position = firstPosition + i;</div><div class="line">				<span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">					<span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">					<span class="comment">// system-managed transient state.</span></div><div class="line">					child.clearAccessibilityFocus();</div><div class="line">					mRecycler.addScrapView(child, position);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mMotionViewNewTop = mMotionViewOriginalTop + deltaY;</div><div class="line"></div><div class="line">	mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="comment">// count记录了当前已经移除屏幕的view个数</span></div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">	    <span class="comment">// 把已经移除的View从ViewGroup总detach掉</span></div><div class="line">		detachViewsFromParent(start, count);</div><div class="line">		mRecycler.removeSkippedScrap();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// invalidate before moving the children to avoid unnecessary invalidate</span></div><div class="line">	<span class="comment">// calls to bubble up from the children all the way to the top</span></div><div class="line">	<span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">	   invalidate();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 这个方法让所有的子view都按照这个参数的距离大小进行改变，这样就实现了移动也就是滑动的功能。</span></div><div class="line">	offsetChildrenTopAndBottom(incrementalDeltaY);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (down) &#123;</div><div class="line">		mFirstPosition += count;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> absIncrementalDeltaY = Math.abs(incrementalDeltaY);</div><div class="line">	<span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) &#123;</div><div class="line">	    <span class="comment">// 第一个View的顶部移入了屏幕或者最后一个View的底部移入了屏幕</span></div><div class="line">		fillGap(down);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!inTouchMode &amp;&amp; mSelectedPosition != INVALID_POSITION) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectedPosition - mFirstPosition;</div><div class="line">		<span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">			positionSelector(mSelectedPosition, getChildAt(childIndex));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectorPosition - mFirstPosition;</div><div class="line">		<span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">			positionSelector(INVALID_POSITION, getChildAt(childIndex));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mSelectorRect.setEmpty();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	invokeOnItemScrollListener();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>offsetChildrenTopAndBottom()</code>方法的，在<code>AbsListView</code>中没有重写该方法，具体要看其父类<code>ViewGroup</code>中的实现:       `<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Offset the vertical location of all children of this view by the specified number of pixels.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> offset the number of pixels to offset</div><div class="line"> *</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offsetChildrenTopAndBottom</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">boolean</span> invalidate = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">	    <span class="comment">// 把所有的view都移动指定的距离</span></div><div class="line">		<span class="keyword">final</span> View v = children[i];</div><div class="line">		v.mTop += offset;</div><div class="line">		v.mBottom += offset;</div><div class="line">		<span class="keyword">if</span> (v.mRenderNode != <span class="keyword">null</span>) &#123;</div><div class="line">			invalidate = <span class="keyword">true</span>;</div><div class="line">			v.mRenderNode.offsetTopAndBottom(offset);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (invalidate) &#123;</div><div class="line">		invalidateViewProperty(<span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">	notifySubtreeAccessibilityStateChangedIfNeeded();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>fillGap()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the gap left open by a touch-scroll. During a touch scroll, children that</div><div class="line"> * remain on screen are shifted and the other ones are discarded. The role of this</div><div class="line"> * method is to fill the gap thus created by performing a partial layout in the</div><div class="line"> * empty space.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> down true if the scroll is going down, false if it is going up</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span></span>;</div></pre></td></tr></table></figure></p>
<p>发现在<code>AbsListView</code>中该方法是抽象的，所以我们要再<code>ListView</code>中找一下他的具体实现类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">    <span class="keyword">if</span> (down) &#123;</div><div class="line">        <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            paddingTop = getListPaddingTop();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(count - <span class="number">1</span>).getBottom() + mDividerHeight :</div><div class="line">                paddingTop;</div><div class="line">        fillDown(mFirstPosition + count, startOffset);</div><div class="line">        correctTooHigh(getChildCount());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            paddingBottom = getListPaddingBottom();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</div><div class="line">                getHeight() - paddingBottom;</div><div class="line">        fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</div><div class="line">        correctTooLow(getChildCount());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到他会分别根据向下滑动还是向上滑动去调用<code>fillDown</code>和<code>fillUp</code>两个方法，这两个方法之前我们都分析过了，就不再继续看了。</p>
<p>到这里基本就把滑动部分的处理都看完了。<br>还剩最后一个问题就是<code>RecycleBin</code>的实现,他是<code>AbsListView</code>中的一个内部类。</p>
<p>直接上代码了，他的注释也说的非常清楚，我就把不好理解的地方简单说一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The RecycleBin facilitates reuse of views across layouts. The RecycleBin has two levels of</div><div class="line"> * storage: ActiveViews and ScrapViews. ActiveViews are those views which were onscreen at the</div><div class="line"> * start of a layout. By construction, they are displaying current information. At the end of</div><div class="line"> * layout, all views in ActiveViews are demoted to ScrapViews. ScrapViews are old views that</div><div class="line"> * could potentially be used by the adapter to avoid allocating views unnecessarily.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> android.widget.AbsListView#setRecyclerListener(android.widget.AbsListView.RecyclerListener)</div><div class="line"> * <span class="doctag">@see</span> android.widget.AbsListView.RecyclerListener</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecycleBin</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> RecyclerListener mRecyclerListener;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * The position of the first view stored in mActiveViews.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mFirstActivePosition;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Views that were on screen at the start of layout. This array is populated at the start of</div><div class="line">	 * layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.</div><div class="line">	 * Views in mActiveViews represent a contiguous range of Views, with position of the first</div><div class="line">	 * view store in mFirstActivePosition.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> View[] mActiveViews = <span class="keyword">new</span> View[<span class="number">0</span>];</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 为什么是个数组呢？因为ListView会有多种不同的ViewType啊。</div><div class="line">	 * Unsorted views that can be used by the adapter as a convert view.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mViewTypeCount;</div><div class="line">	<span class="comment">// mScrapViews数组中的第一个元素，方便在ViewType是1的时候使用</span></div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt; mCurrentScrap;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt; mSkippedScrap;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> SparseArray&lt;View&gt; mTransientStateViews;</div><div class="line">	<span class="keyword">private</span> LongSparseArray&lt;View&gt; mTransientStateViewsById;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewTypeCount</span><span class="params">(<span class="keyword">int</span> viewTypeCount)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (viewTypeCount &lt; <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't have a viewTypeCount &lt; 1"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 根据ViewType的数量来创建，因为ViewType可以有多中类型，每种不同类型的View肯定要分开单独进行缓存和复用的。</span></div><div class="line">		<span class="comment">//noinspection unchecked</span></div><div class="line">		ArrayList&lt;View&gt;[] scrapViews = <span class="keyword">new</span> ArrayList[viewTypeCount];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; i++) &#123;</div><div class="line">			scrapViews[i] = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">		&#125;</div><div class="line">		mViewTypeCount = viewTypeCount;</div><div class="line">		mCurrentScrap = scrapViews[<span class="number">0</span>];</div><div class="line">		mScrapViews = scrapViews;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 方法名说明了一切</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markChildrenDirty</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">				scrap.get(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">					scrap.get(j).forceLayout();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViews.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">				mTransientStateViews.valueAt(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViewsById.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">				mTransientStateViewsById.valueAt(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldRecycleViewType</span><span class="params">(<span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewType &gt;= <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Clears the scrap heap.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			clearScrap(scrap);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				clearScrap(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		clearTransientStateViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Fill ActiveViews with all of the children of the AbsListView.</div><div class="line">	 * 将View存储到mActiveViews数组中</div><div class="line">	 * <span class="doctag">@param</span> childCount The minimum number of views mActiveViews should hold</div><div class="line">	 * <span class="doctag">@param</span> firstActivePosition The position of the first view that will be stored in</div><div class="line">	 *        mActiveViews</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fillActiveViews</span><span class="params">(<span class="keyword">int</span> childCount, <span class="keyword">int</span> firstActivePosition)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mActiveViews.length &lt; childCount) &#123;</div><div class="line">			mActiveViews = <span class="keyword">new</span> View[childCount];</div><div class="line">		&#125;</div><div class="line">		mFirstActivePosition = firstActivePosition;</div><div class="line"></div><div class="line">		<span class="comment">//noinspection MismatchedReadAndWriteOfArray</span></div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			View child = getChildAt(i);</div><div class="line">			AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">			<span class="comment">// Don't put header or footer views into the scrap heap</span></div><div class="line">			<span class="keyword">if</span> (lp != <span class="keyword">null</span> &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">				<span class="comment">// Note:  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</span></div><div class="line">				<span class="comment">//        However, we will NOT place them into scrap views.</span></div><div class="line">				activeViews[i] = child;</div><div class="line">				<span class="comment">// Remember the position so that setupChild() doesn't reset state.</span></div><div class="line">				lp.scrappedFromPosition = firstActivePosition + i;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the view corresponding to the specified position. The view will be removed from</div><div class="line">	 * mActiveViews if it is found.注释说了获取完之后就会从mActiveViews中移除，这是很好理解的</div><div class="line">	 * 因为获取了就是说这个View已经显示到当前的ListView中了，肯定不能再复用他了。</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> position The position to look up in mActiveViews</div><div class="line">	 * <span class="doctag">@return</span> The view if it is found, null otherwise</div><div class="line">	 */</div><div class="line">	<span class="function">View <span class="title">getActiveView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> index = position - mFirstActivePosition;</div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">if</span> (index &gt;=<span class="number">0</span> &amp;&amp; index &lt; activeViews.length) &#123;</div><div class="line">			<span class="keyword">final</span> View match = activeViews[index];</div><div class="line">			activeViews[index] = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">return</span> match;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">View <span class="title">getTransientStateView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds &amp;&amp; mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">			View result = mTransientStateViewsById.get(id);</div><div class="line">			mTransientStateViewsById.remove(id);</div><div class="line">			<span class="keyword">return</span> result;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> index = mTransientStateViews.indexOfKey(position);</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">				View result = mTransientStateViews.valueAt(index);</div><div class="line">				mTransientStateViews.removeAt(index);</div><div class="line">				<span class="keyword">return</span> result;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Dumps and fully detaches any currently saved views with transient</div><div class="line">	 * state.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clearTransientStateViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> SparseArray&lt;View&gt; viewsByPos = mTransientStateViews;</div><div class="line">		<span class="keyword">if</span> (viewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = viewsByPos.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">				removeDetachedView(viewsByPos.valueAt(i), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">			viewsByPos.clear();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LongSparseArray&lt;View&gt; viewsById = mTransientStateViewsById;</div><div class="line">		<span class="keyword">if</span> (viewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = viewsById.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">				removeDetachedView(viewsById.valueAt(i), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">			viewsById.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 从废弃View的缓存中获取，只要移动出屏幕之后就都会被加到废弃View的缓存中 </div><div class="line">	 * <span class="doctag">@return</span> A view from the ScrapViews collection. These are unordered.</div><div class="line">	 */</div><div class="line">	<span class="function">View <span class="title">getScrapView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> retrieveFromScrap(mCurrentScrap, position);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> whichScrap = mAdapter.getItemViewType(position);</div><div class="line">			<span class="keyword">if</span> (whichScrap &gt;= <span class="number">0</span> &amp;&amp; whichScrap &lt; mScrapViews.length) &#123;</div><div class="line">				<span class="keyword">return</span> retrieveFromScrap(mScrapViews[whichScrap], position);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Puts a view into the list of scrap views.</div><div class="line">	 * &lt;p&gt;</div><div class="line">	 * If the list data hasn't changed or the adapter has stable IDs, views</div><div class="line">	 * with transient state will be preserved for later retrieval.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> scrap The view to add</div><div class="line">	 * <span class="doctag">@param</span> position The view's position within its parent</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addScrapView</span><span class="params">(View scrap, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</div><div class="line">		<span class="keyword">if</span> (lp == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		lp.scrappedFromPosition = position;</div><div class="line"></div><div class="line">		<span class="comment">// Remove but don't scrap header or footer views, or views that</span></div><div class="line">		<span class="comment">// should otherwise not be recycled.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> viewType = lp.viewType;</div><div class="line">		<span class="keyword">if</span> (!shouldRecycleViewType(viewType)) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		scrap.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">		<span class="comment">// The the accessibility state of the view may change while temporary</span></div><div class="line">		<span class="comment">// detached and we do not allow detached views to fire accessibility</span></div><div class="line">		<span class="comment">// events. So we are announcing that the subtree changed giving a chance</span></div><div class="line">		<span class="comment">// to clients holding on to a view in this subtree to refresh it.</span></div><div class="line">		notifyViewAccessibilityStateChangedIfNeeded(</div><div class="line">				AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);</div><div class="line">		</div><div class="line">		<span class="comment">// 对一些瞬态View的处理</span></div><div class="line">		<span class="comment">// Don't scrap views that have transient state.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();</div><div class="line">		<span class="keyword">if</span> (scrapHasTransientState) &#123;</div><div class="line">			<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">				<span class="comment">// If the adapter has stable IDs, we can reuse the view for</span></div><div class="line">				<span class="comment">// the same data.</span></div><div class="line">				<span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">					mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mTransientStateViewsById.put(lp.itemId, scrap);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">				<span class="comment">// If the data hasn't changed, we can reuse the views at</span></div><div class="line">				<span class="comment">// their old positions.</span></div><div class="line">				<span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">					mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mTransientStateViews.put(position, scrap);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Otherwise, we'll have to remove the view and start over.</span></div><div class="line">				<span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">					mSkippedScrap = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mSkippedScrap.add(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">				mCurrentScrap.add(scrap);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				mScrapViews[viewType].add(scrap);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mRecyclerListener != <span class="keyword">null</span>) &#123;</div><div class="line">				mRecyclerListener.onMovedToScrapHeap(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Finish the removal of any views that skipped the scrap heap.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeSkippedScrap</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mSkippedScrap.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			removeDetachedView(mSkippedScrap.get(i), <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		mSkippedScrap.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Move all views remaining in mActiveViews to mScrapViews.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">scrapActiveViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> hasListener = mRecyclerListener != <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> multipleScraps = mViewTypeCount &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line">		ArrayList&lt;View&gt; scrapViews = mCurrentScrap;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">			<span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> AbsListView.LayoutParams lp</div><div class="line">						= (AbsListView.LayoutParams) victim.getLayoutParams();</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> whichScrap = lp.viewType;</div><div class="line"></div><div class="line">				activeViews[i] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (victim.hasTransientState()) &#123;</div><div class="line">					<span class="comment">// Store views with transient state for later use.</span></div><div class="line">					victim.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">						<span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">							mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">						&#125;</div><div class="line">						<span class="keyword">long</span> id = mAdapter.getItemId(mFirstActivePosition + i);</div><div class="line">						mTransientStateViewsById.put(id, victim);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">						<span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">							mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">						&#125;</div><div class="line">						mTransientStateViews.put(mFirstActivePosition + i, victim);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">						<span class="comment">// The data has changed, we can't keep this view.</span></div><div class="line">						removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!shouldRecycleViewType(whichScrap)) &#123;</div><div class="line">					<span class="comment">// Discard non-recyclable views except headers/footers.</span></div><div class="line">					<span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">						removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Store everything else on the appropriate scrap heap.</span></div><div class="line">					<span class="keyword">if</span> (multipleScraps) &#123;</div><div class="line">						scrapViews = mScrapViews[whichScrap];</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					victim.dispatchStartTemporaryDetach();</div><div class="line">					lp.scrappedFromPosition = mFirstActivePosition + i;</div><div class="line">					scrapViews.add(victim);</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (hasListener) &#123;</div><div class="line">						mRecyclerListener.onMovedToScrapHeap(victim);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		pruneScrapViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Makes sure that the size of mScrapViews does not exceed the size of</div><div class="line">	 * mActiveViews, which can happen if an adapter does not recycle its</div><div class="line">	 * views. Removes cached transient state views that no longer have</div><div class="line">	 * transient state.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneScrapViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> maxViews = mActiveViews.length;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">			<span class="keyword">int</span> size = scrapPile.size();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> extras = size - maxViews;</div><div class="line">			size--;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; extras; j++) &#123;</div><div class="line">				removeDetachedView(scrapPile.remove(size--), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> SparseArray&lt;View&gt; transViewsByPos = mTransientStateViews;</div><div class="line">		<span class="keyword">if</span> (transViewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsByPos.size(); i++) &#123;</div><div class="line">				<span class="keyword">final</span> View v = transViewsByPos.valueAt(i);</div><div class="line">				<span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">					removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">					transViewsByPos.removeAt(i);</div><div class="line">					i--;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LongSparseArray&lt;View&gt; transViewsById = mTransientStateViewsById;</div><div class="line">		<span class="keyword">if</span> (transViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsById.size(); i++) &#123;</div><div class="line">				<span class="keyword">final</span> View v = transViewsById.valueAt(i);</div><div class="line">				<span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">					removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">					transViewsById.removeAt(i);</div><div class="line">					i--;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Puts all views in the scrap heap into the supplied list.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reclaimScrapViews</span><span class="params">(List&lt;View&gt; views)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			views.addAll(mCurrentScrap);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">				views.addAll(scrapPile);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Updates the cache color hint of all known views.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> color The new cache color hint.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setCacheColorHint</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">				scrap.get(i).setDrawingCacheBackgroundColor(color);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">					scrap.get(j).setDrawingCacheBackgroundColor(color);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Just in case this is called during a layout pass</span></div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">			<span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">			<span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">				victim.setDrawingCacheBackgroundColor(color);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">retrieveFromScrap</span><span class="params">(ArrayList&lt;View&gt; scrapViews, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> size = scrapViews.size();</div><div class="line">		<span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// See if we still have a view for this position or ID.</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">				<span class="keyword">final</span> View view = scrapViews.get(i);</div><div class="line">				<span class="keyword">final</span> AbsListView.LayoutParams params =</div><div class="line">						(AbsListView.LayoutParams) view.getLayoutParams();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (mAdapterHasStableIds) &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">					<span class="keyword">if</span> (id == params.itemId) &#123;</div><div class="line">						<span class="keyword">return</span> scrapViews.remove(i);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.scrappedFromPosition == position) &#123;</div><div class="line">					<span class="keyword">final</span> View scrap = scrapViews.remove(i);</div><div class="line">					clearAccessibilityFromScrap(scrap);</div><div class="line">					<span class="keyword">return</span> scrap;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">final</span> View scrap = scrapViews.remove(size - <span class="number">1</span>);</div><div class="line">			clearAccessibilityFromScrap(scrap);</div><div class="line">			<span class="keyword">return</span> scrap;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearScrap</span><span class="params">(<span class="keyword">final</span> ArrayList&lt;View&gt; scrap)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">			removeDetachedView(scrap.remove(scrapCount - <span class="number">1</span> - j), <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAccessibilityFromScrap</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">		view.clearAccessibilityFocus();</div><div class="line">		view.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeDetachedView</span><span class="params">(View child, <span class="keyword">boolean</span> animate)</span> </span>&#123;</div><div class="line">		child.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">		AbsListView.<span class="keyword">this</span>.removeDetachedView(child, animate);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到此为止。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/ListView源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(上)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(上)/">RxJava详解(上)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(上)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-上"><a href="#RxJava详解-上" class="headerlink" title="RxJava详解(上)"></a>RxJava详解(上)</h1><p>年初的时候就想学习下<code>RxJava</code>然后写一些<code>RxJava</code>的教程，无奈发现已经年底了，然而我还么有写。今天有点时间，特别是发布了<code>RxJava 2.0</code>后，我决定动笔开始。</p>
<p>现在<code>RxJava</code>变的越来越流行了，很多项目中都使用了它。特别是大神<code>JakeWharton</code>等的加入，以及<code>RxBinding、Retrofit、RxLifecycle</code>等众多项目的，然开发越来越方便，但是上手比较难，不过一旦你入门后你就会发现真是太棒了。</p>
<h2 id="RxJava简介"><a href="#RxJava简介" class="headerlink" title="RxJava简介"></a><code>RxJava</code>简介</h2><p>在介绍<code>RxJava</code>之前先说一下<code>Rx</code>。<code>Rx</code>的全称是<code>Reactive Extensions</code>，直译过来就是响应式扩展。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rx_logo.png?raw=true" alt="image"></p>
<p><code>Rx</code>基于观察者模式，它是一种编程模型，目标是提供一致的编程接口，帮助开发者更方便的处理异步数据流。<code>ReactiveX.io</code>给的定义是，<code>Rx</code>是一个使用可观察数据流进行异步编程的编程接口，<code>ReactiveX</code>结合了观察者模式、迭代器模式和函数式编程的精华。<code>Rx</code>已经渗透到了各个语言中，有了<code>Rx</code>所以才有了<code>RxJava</code>、<code>Rx.NET</code>、<code>RxJS</code>、<code>RxSwift</code>、<code>Rx.rb</code>、<code>RxPHP</code>等等，</p>
<p>这里先列举一下相关的官网:  </p>
<ul>
<li><a href="http://reactivex.io/" target="_blank" rel="external">Rx</a></li>
<li><a href="https://github.com/ReactiveX/RxJava">RxJava</a>       </li>
<li><a href="https://github.com/ReactiveX/RxAndroid">RxAndroid</a></li>
</ul>
<p><code>RxJava</code>在<code>GitHub</code>上的介绍是：<code>a library for composing asynchronous and event-based programs by using observable sequences for the Java VM.</code><br>翻译过来也就是一个基于事件和程序在<code>Java VM</code>上使用可观测的序列来组成异步的库。<code>RxJava</code>的本质就是一个实现异步操作的库，它的优势就是简洁，随着程序逻辑变得越来越复杂，它依然能够保持简洁。       </p>
<p>其实一句话总结一下<code>RxJava</code>的作用就是：异步   </p>
<p>这里可能会有人想不就是个异步吗，至于辣么矫情么?用<code>AsyncTask</code>、<code>Handler</code>甚至自定义一个<code>BigAsyncTask</code>分分钟搞定。</p>
<p>但是<code>RxJava</code>的好处是简洁。异步操作很关键的一点是程序的简洁性，因为在调度过程比较复杂的情况下，异步代码经常会既难写也难被读懂。 <code>Android</code>创造的<code>AsyncTask</code>和<code>Handler</code>其实都是为了让异步代码更加简洁。虽然<code>RxJava</code>的优势也是简洁，但它的简洁的与众不同之处在于，随着程序逻辑变得越来越复杂，它依然能够保持简洁。</p>
<p>####扩展的观察者模式</p>
<p><code>RxJava</code>的异步实现，是通过一种扩展的观察者模式来实现的。</p>
<p>观察者模式面向的需求是：<code>A</code>对象（观察者）对<code>B</code>对象（被观察者）的某种变化高度敏感，需要在<code>B</code>变化的一瞬间做出反应。举个例子，新闻里喜闻乐见的警察抓小偷，警察需要在小偷伸手作案的时候实施抓捕。在这个例子里，警察是观察者，小偷是被观察者，警察需要时刻盯着小偷的一举一动，才能保证不会漏过任何瞬间。程序的观察者模式和这种真正的『观察』略有不同，观察者不需要时刻盯着被观察者（例如<code>A</code>不需要每过<code>2ms</code>就检查一次<code>B</code>的状态），而是采用注册(<code>Register</code>)或者称为订阅(<code>Subscribe</code>)的方式，告诉被观察者：我需要你的某某状态，你要在它变化的时候通知我。 <code>Android</code>开发中一个比较典型的例子是点击监听器<code>OnClickListener</code>。对设置<code>OnClickListener</code>来说，<code>View</code>是被观察者，<code>OnClickListener</code>是观察者，二者通过 <code>setOnClickListener()</code>方法达成订阅关系。订阅之后用户点击按钮的瞬间，<code>Android Framework</code>就会将点击事件发送给已经注册的<code>OnClickListener</code>。采取这样被动的观察方式，既省去了反复检索状态的资源消耗，也能够得到最高的反馈速度。当然，这也得益于我们可以随意定制自己程序中的观察者和被观察者，而警察叔叔明显无法要求小偷『你在作案的时候务必通知我』。</p>
<p><code>OnClickListener</code>的模式大致如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/btn_onclick.jpg?raw=true" alt="image"></p>
<p>如图所示，通过<code>setOnClickListener()</code>方法，<code>Button</code>持有<code>OnClickListener</code>的引用（这一过程没有在图上画出）；当用户点击时，<code>Button</code>自动调用<code>OnClickListener</code>的<code>onClick()</code> 方法。另外，如果把这张图中的概念抽象出来（<code>Button</code> -&gt; 被观察者、<code>OnClickListener</code> -&gt; 观察者、<code>setOnClickListener()</code> -&gt; 订阅，<code>onClick()</code> -&gt; 事件），就由专用的观察者模式（例如只用于监听控件点击）转变成了通用的观察者模式。如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/btn_rxjava_observable.jpg?raw=true" alt="image"></p>
<p>而<code>RxJava</code>作为一个工具库，使用的就是通用形式的观察者模式。</p>
<p>####<code>RxJava</code>的观察者模式</p>
<p><code>RxJava</code>的基本概念：</p>
<ul>
<li><code>Observable</code>(可观察者，即被观察者)、 </li>
<li><code>Observer</code>(观察者)、 </li>
<li><code>subscribe()</code>(订阅)、事件。<br>  <code>Observable</code>和<code>Observer</code>通过<code>subscribe()</code> 方法实现订阅关系，从而<code>Observable</code>可以在需要的时候发出事件来通知<code>Observer</code>。</li>
</ul>
<p>与传统观察者模式不同，<code>RxJava</code>的事件回调方法除了普通事件<code>onNext()</code>(相当于<code>onClick()</code>/<code>onEvent()</code>)之外，还定义了两个特殊的事件：<code>onCompleted()</code>和<code>onError()</code>:<br>但是<code>RxJava</code>与传统的观察者设计模式有一点明显不同，那就是如果一个<code>Observerble</code>没有任何的的<code>Subscriber</code>，那么这个<code>Observable</code>是不会发出任何事件的。</p>
<ul>
<li><code>onCompleted()</code>: 事件队列完结。<br>  <code>RxJava</code>不仅把每个事件单独处理，还会把它们看做一个队列。<code>RxJava</code>规定，当不会再有新的<code>onNext()</code>发出时，需要触发<code>onCompleted()</code> 方法作为标志。</li>
<li><code>onError()</code>: 事件队列异常。<br>  在事件处理过程中出异常时，<code>onError()</code>会被触发，同时队列自动终止，不允许再有事件发出。</li>
<li>在一个正确运行的事件序列中, <code>onCompleted()</code>和<code>onError()</code>有且只有一个，并且是事件序列中的最后一个。需要注意的是<code>onCompleted()</code>和<code>onError()</code> 二者也是互斥的，即在队列中调用了其中一个，就不应该再调用另一个。</li>
</ul>
<p><code>RxJava</code>的观察者模式大致如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observer_1.jpg?raw=true" alt="image"></p>
<p>####基本实现</p>
<p>基于上面的概念， <code>RxJava</code>的基本实现主要有三点:    </p>
<ul>
<li><p>创建<code>Observable</code><br>  <code>Observable</code>即被观察者，它决定什么时候触发事件以及触发怎样的事件。 <code>RxJava</code>使用<code>Observable.create()</code>方法来创建一个<code>Observable</code>，并为它定义事件触发规则。    </p>
</li>
<li><p>创建<code>Observer</code>即观察者，它决定事件触发的时候将有怎样的行为。<br>  <code>RxJava</code>中的<code>Observer</code>接口的实现方式:    </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Observer&lt;String&gt; observer = <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  除了<code>Observer</code>接口之外，<code>RxJava</code>还内置了一个实现了<code>Observer</code>的抽象类:<code>Subscriber</code>。<code>Subscriber</code>对<code>Observer</code>接口进行了一些扩展，但他们的基本使用方式是完全一样的。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  不仅基本使用方式一样，实质上，在<code>RxJava</code>的<code>subscribe()</code>过程中，<code>Observer</code>也总是会先被转换成一个<code>Subscriber</code>再使用。所以如果你只想使用基本功能，选择<code>Observer</code>和 <code>Subscriber</code>是完全一样的。它们的区别对于使用者来说主要有两点：</p>
<ul>
<li><code>onStart()</code>: 这是<code>Subscriber</code>增加的方法。它会在<code>subscribe()</code>刚开始而事件还未发送之前被调用，可以用于做一些准备工作，例如数据的清零或重置。这是一个可选方法，默认情况下它的实现为空。需要注意的是，如果对准备工作的线程有要求（例如弹出一个显示进度的对话框，这必须在主线程执行）， <code>onStart()</code>就不适用了，因为它总是在<code>subscribe()</code> 所发生的线程被调用，而不能指定线程。要在指定的线程来做准备工作，可以使用<code>doOnSubscribe()</code>方法，具体可以在后面的文中看到。</li>
<li><code>unsubscribe</code>(): 这是<code>Subscriber</code>所实现的另一个接口<code>Subscription</code>的方法，用于取消订阅。在这个方法被调用后，<code>Subscriber</code> 将不再接收事件。一般在这个方法调用前，可以使用<code>isUnsubscribed()</code>先判断一下状态。 <code>unsubscribe()</code>这个方法很重要，因为在<code>subscribe()</code>之后,<code>Observable</code>会持有 <code>Subscriber</code>的引用，这个引用如果不能及时被释放，将有内存泄露的风险。所以最好保持一个原则：要在不再使用的时候尽快在合适的地方（例如<code>onPause()、onStop()</code>等方法中）调用<code>unsubscribe()</code>来解除引用关系，以避免内存泄露的发生。<br>所以后续讲解时我们有时会用<code>Subscriber</code>来代替<code>Observer</code>。</li>
</ul>
</li>
<li><p>调用<code>subscribe()</code>方法(订阅)</p>
<p>  创建了一个<code>Observable</code>和<code>Observer</code>之后，再用<code>subscribe()</code>方法将它们联结起来，整条链子就可以工作了。代码形式很简单：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">observable.subscribe(observer);  </div><div class="line"><span class="comment">// 或者：</span></div><div class="line">observable.subscribe(subscriber);</div></pre></td></tr></table></figure>
<blockquote>
<p>有人可能会注意到，<code>subscribe()</code>这个方法有点怪：它看起来是<code>observalbe</code>订阅了<code>observer/subscriber</code>而不是<code>observer/subscriber</code>订阅了<code>observalbe</code>，这看起来就像『杂志订阅了读者』一样颠倒了对象关系。这让人读起来有点别扭，不过如果把<code>API</code>设计成<code>observer.subscribe(observable)/subscriber.subscribe(observable)</code> ，虽然更加符合思维逻辑，但对流式<code>API</code>的设计就造成影响了，比较起来明显是得不偿失的。</p>
</blockquote>
</li>
</ul>
<h2 id="RxJava入门示例"><a href="#RxJava入门示例" class="headerlink" title="RxJava入门示例"></a><code>RxJava</code>入门示例</h2><p>一个<code>Observable</code>可以发出零个或者多个事件，知道结束或者出错。每发出一个事件，就会调用它的<code>Subscriber</code>的<code>onNext</code>方法，最后调用<code>Subscriber.onComplete()</code>或者<code>Subscriber.onError()</code>结束。</p>
<p>####<code>Hello World</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">compile &apos;io.reactivex:rxandroid:1.2.1&apos;</div><div class="line">// Because RxAndroid releases are few and far between, it is recommended you also</div><div class="line">// explicitly depend on RxJava&apos;s latest version for bug fixes and new features.</div><div class="line">compile &apos;io.reactivex:rxjava:1.2.3&apos;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建被观察者、数据源</span></div><div class="line">Observable&lt;String&gt; observable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber)</span> </span>&#123;</div><div class="line">        <span class="comment">// 可以看到，这里传入了一个 OnSubscribe 对象作为参数。OnSubscribe 会被存储在返回的 Observable 对象中，它的作用相当于一个计划表，当 Observable      </span></div><div class="line">        <span class="comment">//被订阅的时候，OnSubscribe 的 call() 方法会自动被调用，事件序列就会依照设定依次触发（对于上面的代码，就是观察者Subscriber 将会被调用三次 onNext() 和一次 </span></div><div class="line">        <span class="comment">// onCompleted()）。这样，由被观察者调用了观察者的回调方法，就实现了由被观察者向观察者的事件传递，即观察者模式。</span></div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call"</span>);</div><div class="line">        subscriber.onNext(<span class="string">"Hello "</span>);</div><div class="line">        subscriber.onNext(<span class="string">"World !"</span>);</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 创建观察者</span></div><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onCompleted"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onError"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onNext : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 关联或者叫订阅更合适。</span></div><div class="line">observable.subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>一旦<code>subscriber</code>订阅了<code>observable</code>，<code>observable</code>就会调用<code>subscriber</code>对象的<code>onNext</code>和<code>onComplete</code>方法，<code>subscriber</code>就会打印出<code>Hello World</code>.        </p>
<p> <code>Observable.subscribe(Subscriber)</code>的内部实现是这样的（仅核心代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意：这不是`subscribe()`的源码，而是将源码中与性能、兼容性、扩展性有关的代码剔除后的核心代码。</span></div><div class="line"><span class="function"><span class="keyword">public</span> Subscription <span class="title">subscribe</span><span class="params">(Subscriber subscriber)</span> </span>&#123;</div><div class="line">   subscriber.onStart();</div><div class="line">   onSubscribe.call(subscriber);</div><div class="line">   <span class="keyword">return</span> subscriber;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到<code>subscriber()</code>做了3件事：</p>
<ul>
<li>调用<code>Subscriber.onStart()</code>。这个方法在前面已经介绍过，是一个可选的准备方法。</li>
<li>调用<code>Observable</code>中的<code>onSubscribe.call(Subscriber)</code>。在这里，事件发送的逻辑开始运行。从这也可以看出，在<code>RxJava</code>中，<code>Observable</code> 并不是在创建的时候就立即开始发送事件，而是在它被订阅的时候，即当<code>subscribe()</code>方法执行的时候。</li>
<li>将传入的<code>Subscriber</code>作为<code>Subscription</code>返回。这是为了方便<code>unsubscribe()</code>.</li>
</ul>
<p>整个过程中对象间的关系如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observable_list.gif?raw=true" alt="image"></p>
<p>讲到这里很多人肯定会骂傻<code>X</code>,这TM简洁你妹啊…，这里只是个入门<code>Hello World</code>，真正的简洁等你看完全部介绍后就明白了。</p>
<p><code>RxJava</code>内置了很多简化创建<code>Observable</code>对象的函数，比如<code>Observable.just()</code>就是用来创建只发出一个事件就结束的<code>Observable</code>对象，上面创建<code>Observable</code>对象的代码可以简化为一行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; observable = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div></pre></td></tr></table></figure>
<p>接下来看看如何简化<code>Subscriber</code>，上面的例子中，我们其实并不关心<code>onComplete()</code>和<code>onError</code>，我们只需要在<code>onNext</code>的时候做一些处理，这时候就可以使用<code>Action1</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Action1&lt;String&gt; action1 = <span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>Observable.subscribe()</code>方法有一个重载版本，接受三个<code>Action1</code>类型的参数      </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_subscribe_params.png?raw=true" alt="image"></p>
<p>所以上面的代码最终可以写成这样:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里顺便多提一些<code>subscribe()</code>的多个<code>Action</code>参数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Action1&lt;String&gt; onNextAction = <span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="comment">// onNext()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Action1&lt;Throwable&gt; onErrorAction = <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line">    <span class="comment">// onError()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">        <span class="comment">// Error handling</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Action0 onCompletedAction = <span class="keyword">new</span> Action0() &#123;</div><div class="line">    <span class="comment">// onCompleted()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"completed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">observable.subscribe(onNextAction, onErrorAction, onCompletedAction);</div></pre></td></tr></table></figure></p>
<p>简单解释一下这段代码中出现的<code>Action1</code>和<code>Action0</code>。<code>Action0</code>是<code>RxJava</code>的一个接口，它只有一个方法<code>call()</code>，这个方法是无参无返回值的；由于<code>onCompleted()</code> 方法也是无参无返回值的，因此<code>Action0</code>可以被当成一个包装对象，将<code>onCompleted()</code>的内容打包起来将自己作为一个参数传入<code>subscribe()</code>以实现不完整定义的回调。这样其实也可以看做将 <code>onCompleted()</code>方法作为参数传进了<code>subscribe()</code>，相当于其他某些语言中的『闭包』。<code>Action1</code>也是一个接口，它同样只有一个方法<code>call(T param)</code>，这个方法也无返回值，但有一个参数；与<code>Action0</code>同理，由于<code>onNext(T obj)</code>和<code>onError(Throwable error)</code>也是单参数无返回值的，因此<code>Action1</code>可以将<code>onNext(obj)</code>和<code>onError(error)</code>打包起来传入<code>subscribe()</code>以实现不完整定义的回调。事实上，虽然<code>Action0</code>和<code>Action1</code>在<code>API</code>中使用最广泛，但<code>RxJava</code>是提供了多个<code>ActionX</code>形式的接口(例如<code>Action2</code>, <code>Action3</code>)的，它们可以被用以包装不同的无返回值的方法。</p>
<p>假设我们的<code>Observable</code>是第三方提供的，它提供了大量的用户数据给我们，而我们需要从用户数据中筛选部分有用的信息，那我们该怎么办呢？<br>从<code>Observable</code>中去修改肯定是不现实的？那从<code>Subscriber</code>中进行修改呢？ 这样好像是可以完成的。但是这种方式并不好，因为我们希望<code>Subscriber</code>越轻量越好，因为很有可能我们需要<br>在主线程中去执行<code>Subscriber</code>。另外，根据响应式函数编程的概念，<code>Subscribers</code>更应该做的事情是<code>响应</code>，响应<code>Observable</code>发出的事件，而不是去修改。<br>那该怎么办呢？ 这就要用到下面的部分要讲的操作符。  </p>
<h2 id="操作符-Operators"><a href="#操作符-Operators" class="headerlink" title="操作符(Operators)"></a>操作符(<code>Operators</code>)</h2><p><code>RxJava</code>提供了对事件序列进行变换的支持，这是它的核心功能之一.所谓变换，就是将事件序列中的对象或整个序列进行加工处理，转换成不同的事件或事件序列。<br>操作符就是为了解决对<code>Observable</code>对象的变换的问题，操作符用于在<code>Observable</code>和最终的<code>Subscriber</code>之间修改<code>Observable</code>发出的事件。<code>RxJava</code>提供了很多很有用的操作符。<br>比如<code>map</code>操作符，就是用来把把一个事件转换为另一个事件的。</p>
<p>####<code>map</code></p>
<p><code>Returns an Observable that applies a specified function to each item emitted by the source Observable and emits the results of these function applications.</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; just = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div><div class="line">Observable&lt;String&gt; map = just.map(<span class="keyword">new</span> Func1&lt;String, String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s + <span class="string">"@@@"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">map.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的代码打印出的结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12-12 15:51:22.184 472-472/com.charon.rxjavastudydemo I/@@@: Hello @@@</div><div class="line">12-12 15:51:22.184 472-472/com.charon.rxjavastudydemo I/@@@: World !@@@</div></pre></td></tr></table></figure></p>
<p><code>map()</code>操作符就是用于变换<code>Observable</code>对象的，<code>map</code>操作符返回一个<code>Observable</code>对象，这样就可以实现链式调用，在一个<code>Observable</code>对象上多次使用map操作符，最终将最简洁的数据传递给<code>Subscriber</code>对象。</p>
<p><code>map</code>操作符更有趣的一点是它不必返回Observable对象返回的类型，你可以使用<code>map</code>操作符返回一个发出新的数据类型的<code>Observable</code>对象。<br>比如上面的例子中，<code>Subscriber</code>并不关心返回的字符串，而是想要字符串的<code>hash</code>值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; just = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div><div class="line">Observable&lt;Integer&gt; map = just.map(<span class="keyword">new</span> Func1&lt;String, Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s.hashCode();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">map.subscribe(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">""</span> + integer);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面部分的打印结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12-12 15:54:35.515 8521-8521/com.charon.rxjavastudydemo I/@@@: -2137068114</div><div class="line">12-12 15:54:35.516 8521-8521/com.charon.rxjavastudydemo I/@@@: -1105126669</div></pre></td></tr></table></figure></p>
<p><code>map()</code>的示意图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_map.jpg?raw=true" alt="image"></p>
<p>通过上面的部分我们可以得知:   </p>
<ul>
<li><p><code>Observable</code>和<code>Subscriber</code>可以做任何事情<br>  <code>Observable</code>可以是一个数据库查询，<code>Subscriber</code>用来显示查询结果；<code>Observable</code>可以是屏幕上的点击事件，<code>Subscriber</code>用来响应点击事件；<code>Observable</code>可以是一个网络请求，<code>Subscriber</code>用来显示请求结果。</p>
</li>
<li><p><code>Observable</code>和<code>Subscriber</code>是独立于中间的变换过程的。<br>  在<code>Observable</code>和<code>Subscriber</code>中间 可以增减任何数量的<code>map</code>。整个系统是高度可组合的，操作数据是一个很简单的过程。</p>
</li>
</ul>
<p>####<code>flatmap</code></p>
<p><code>Returns an Observable that emits items based on applying a function that you supply to each item emitted 
 by the source Observable, where that function returns an Observable, and then merging those resulting 
 Observables and emitting the results of this merger.</code></p>
<p><code>flatMap()</code>是一个很有用但非常难理解的变换，首先假设这么一种需求：假设有一个数据结构『学生』，现在需要打印出一组学生的名字。实现方式很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        Log.d(tag, name);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .map(<span class="keyword">new</span> Func1&lt;Student, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> student.getName();</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>很简单。那么再假设：如果要打印出每个学生所需要修的所有课程的名称呢?(需求的区别在于，每个学生只有一个名字，但却有多个课程)首先可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;Student&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Student&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">        List&lt;Course&gt; courses = student.getCourses();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; courses.size(); i++) &#123;</div><div class="line">            Course course = courses.get(i);</div><div class="line">            Log.d(tag, course.getName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>依然很简单。那么如果我不想在<code>Subscriber</code>中使用<code>for</code>循环，而是希望<code>Subscriber</code>中直接传入单个的<code>Course</code>对象呢(这对于代码复用很重要),用<code>map()</code>显然是不行的，因为<code>map()</code> 是一对一的转化，而我现在的要求是一对多的转化。那怎么才能把一个<code>Student</code>转化成多个<code>Course</code>呢？</p>
<p>这个时候，就需要用<code>flatMap()</code>了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;Course&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Course&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Course course)</span> </span>&#123;</div><div class="line">        Log.d(tag, course.getName());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .flatMap(<span class="keyword">new</span> Func1&lt;Student, Observable&lt;Course&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;Course&gt; <span class="title">call</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Observable.from(student.getCourses());</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure></p>
<p><code>map</code>与<code>flatmap</code>在功能上是一致的,它也是把传入的参数转化之后返回另一个对象。区别在于<code>flatmap</code>是通过中间<code>Observable</code>来进行，而<code>map</code>是直接执行.<code>flatMap()</code>中返回的是个 <code>Observable</code>对象，并且这个<code>Observable</code>对象并不是被直接发送到了<code>Subscriber</code>的回调方法中。 </p>
<p><code>flatMap()</code>的原理是这样的:  </p>
<ul>
<li>使用传入的事件对象创建一个<code>Observable</code>对象</li>
<li>并不发送这个<code>Observable</code>而是将它激活，于是它开始发送事件</li>
<li>每一个创建出来的<code>Observable</code>发送的事件，都被汇入同一个<code>Observable</code>,而这个<code>Observable</code>负责将这些事件统一交给<code>Subscriber</code> 的回调方法。</li>
</ul>
<p>这三个步骤，把事件拆成了两级，通过一组新创建的<code>Observable</code>将初始的对象『铺平』之后通过统一路径分发了下去。而这个『铺平』就是<code>flatMap()</code>所谓的<code>flat</code>。</p>
<p><code>flatMap()</code>就是根据你的规则，将<code>Observable</code>转换之后再发射出去，注意最后的顺序很可能是错乱的，如果要保证顺序的一致性，要使用<code>concatMap()</code><br>由于可以在嵌套的<code>Observable</code>中添加异步代码<code>flatMap()</code>也常用于嵌套的异步操作，例如嵌套的网络请求<code>(Retrofit + RxJava)</code></p>
<p><code>flatMap()</code>示意图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_flatmap.jpg?raw=true" alt="image"></p>
<p>####<code>throttleFirst()</code></p>
<p>在每次事件触发后的一定时间间隔内丢弃新的事件。常用作去抖动过滤。<br>例如按钮的点击监听器:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RxView.clickEvents(button); <span class="comment">// RxBinding 代码`</span></div><div class="line">    .throttleFirst(<span class="number">500</span>, TimeUnit.MILLISECONDS) <span class="comment">// 设置防抖间隔为 500ms </span></div><div class="line">    .subscribe(subscriber); <span class="comment">// 妈妈再也不怕我的用户手抖点开两个重复的界面啦。</span></div></pre></td></tr></table></figure></p>
<p>####<code>from</code></p>
<p><code>convert various other objects and data types into Observables</code></p>
<p><code>from()</code>接收一个集合作为输入，然后每次输出一个元素给<code>subscriber</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; s = Arrays.asList(<span class="string">"Java"</span>, <span class="string">"Android"</span>, <span class="string">"Ruby"</span>, <span class="string">"Ios"</span>, <span class="string">"Swift"</span>);</div><div class="line">Observable.from(s).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>####<code>filter</code></p>
<p>返回满足过滤条件的数据。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable.from(<span class="keyword">new</span> Integer[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;)</div><div class="line">                .filter(<span class="keyword">new</span> Func1&lt;Integer, Boolean&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> integer &lt; <span class="number">5</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .subscribe(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        Log.i(<span class="string">"@@@"</span>, <span class="string">"integer="</span> + integer); <span class="comment">//1,2,3,4</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>####<code>timer</code></p>
<p><code>Timer</code>会在指定时间后发射一个数字0，该操作符运行在<code>Computation Scheduler</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Observable.timer(<span class="number">3</span>, TimeUnit.SECONDS).observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribe(<span class="keyword">new</span> Action1&lt;Long&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                        Log.i(<span class="string">"@@@"</span>, <span class="string">"aLong="</span> + aLong); <span class="comment">// 延时3s</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>####<code>interval</code></p>
<p>创建一个按固定时间间隔发射整数序列的<code>Observable</code>.<br><code>interval</code>默认在<code>computation</code>调度器上执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS, AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;Long&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                Log.i(<span class="string">"@@@"</span>, <span class="string">"aLong="</span> + aLong); <span class="comment">//从0递增，间隔1s 0,1,2,3....</span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>####<code>Repeat</code></p>
<p>重复执行 </p>
<p>等等…就不继续介绍了，到时候查下文档就好了。</p>
<p>是不是感觉没什么乱用，那就继续看下一部分吧。</p>
<p>更多内容请看下一篇文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/RxJava%E8%AF%A6%E8%A7%A3(%E4%B8%AD">RxJava详解(下)</a>.md)</p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(上)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Activity界面绘制过程详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Activity界面绘制过程详解/">Activity界面绘制过程详解</a>
    </h1>
  

        
        <a href="/2015/01/01/Activity界面绘制过程详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Activity界面绘制过程详解"><a href="#Activity界面绘制过程详解" class="headerlink" title="Activity界面绘制过程详解"></a>Activity界面绘制过程详解</h1><p>设置界面首先就是<code>Activity.setContentView()</code>方法：我们先看一下他的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Set the activity content from a layout resource.  The resource will be</div><div class="line"> * inflated, adding all top-level views to the activity.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> layoutResID Resource ID to be inflated.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View)</div><div class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">	getWindow().setContentView(layoutResID);</div><div class="line">	initWindowDecorActionBar();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>getWindow()</code>就是获取该页面的窗体<code>Window</code>，该类是一个抽象类，他有一个唯一的子类<code>PhoneWindow</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve the current &#123;<span class="doctag">@link</span> android.view.Window&#125; for the activity.</div><div class="line"> * This can be used to directly access parts of the Window API that</div><div class="line"> * are not available through Activity/Screen.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> Window The current window, or null if the activity is not</div><div class="line"> *         visual.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Window <span class="title">getWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> mWindow;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来，我们看一下<code>PhoneWindow.setContentView()</code>方法。(简单的理解是<code>PhoneWindow</code>把<code>DectorView(</code>FrameLayout的子类)<code>进行包装，将它作为窗口的根</code>View`)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// mContentParent 是当前window显示内容的父布局，它只能是mDecor或mDecor的子View,如果mContentParent为null，说明是第一次调用setContentView方法</span></div><div class="line">	<span class="comment">// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span></div><div class="line">	<span class="comment">// decor, when theme attributes and the like are crystalized. Do not check the feature</span></div><div class="line">	<span class="comment">// before this happens.</span></div><div class="line">	<span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">	    <span class="comment">// 内部会创建mContentParent, 如果mDecor为null就创建，然后如果mContentParent为null，就根据当前要显示的主题去添加对应的布局，</span></div><div class="line">		<span class="comment">// 并把该布局中id为content的ViewGroup赋值给mContentParent。</span></div><div class="line">		installDecor();</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">		<span class="comment">// 多次调用setContentView，可能是第二次、第三次，先把之前的页面内容移除</span></div><div class="line">		mContentParent.removeAllViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">		<span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</div><div class="line">				getContext());</div><div class="line">		transitionTo(newScene);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	    <span class="comment">// 把布局inflate后添加到mContentParent中</span></div><div class="line">		mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">final</span> Callback cb = getCallback();</div><div class="line">	<span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</div><div class="line">		cb.onContentChanged();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面简单的说明了installDecor()的作用，这里我们在源码中仔细说明一下, 通过这个源码<br>我们知道设置主题要在setContentView之前去调用，如用代码设置<code>requestWindowFeature()</code>设置主题时要在<code>setContentView()</code>之前设置才有用.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 内部就是new 一个 DecorView</span></div><div class="line">		mDecor = generateDecor();</div><div class="line">		mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">		mDecor.setIsRootNamespace(<span class="keyword">true</span>);</div><div class="line">		<span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</div><div class="line">			mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 根据当前主题去选择对应的布局文件，然后把布局中的id=content(一般为FrameLayout)部分赋值给mContentParent.</span></div><div class="line">		mContentParent = generateLayout(mDecor);</div><div class="line"></div><div class="line">		<span class="comment">// Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span></div><div class="line">		mDecor.makeOptionalFitsSystemWindows();</div><div class="line"></div><div class="line">		<span class="keyword">final</span> DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</div><div class="line">				R.id.decor_content_parent);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (decorContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">			mDecorContentParent = decorContentParent;</div><div class="line">			mDecorContentParent.setWindowCallback(getCallback());</div><div class="line">			<span class="keyword">if</span> (mDecorContentParent.getTitle() == <span class="keyword">null</span>) &#123;</div><div class="line">				mDecorContentParent.setWindowTitle(mTitle);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> localFeatures = getLocalFeatures();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FEATURE_MAX; i++) &#123;</div><div class="line">				<span class="keyword">if</span> ((localFeatures &amp; (<span class="number">1</span> &lt;&lt; i)) != <span class="number">0</span>) &#123;</div><div class="line">					mDecorContentParent.initFeature(i);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			mDecorContentParent.setUiOptions(mUiOptions);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) != <span class="number">0</span> ||</div><div class="line">					(mIconRes != <span class="number">0</span> &amp;&amp; !mDecorContentParent.hasIcon())) &#123;</div><div class="line">				mDecorContentParent.setIcon(mIconRes);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) == <span class="number">0</span> &amp;&amp;</div><div class="line">					mIconRes == <span class="number">0</span> &amp;&amp; !mDecorContentParent.hasIcon()) &#123;</div><div class="line">				mDecorContentParent.setIcon(</div><div class="line">						getContext().getPackageManager().getDefaultActivityIcon());</div><div class="line">				mResourcesSetFlags |= FLAG_RESOURCE_SET_ICON_FALLBACK;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_LOGO) != <span class="number">0</span> ||</div><div class="line">					(mLogoRes != <span class="number">0</span> &amp;&amp; !mDecorContentParent.hasLogo())) &#123;</div><div class="line">				mDecorContentParent.setLogo(mLogoRes);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Invalidate if the panel menu hasn't been created before this.</span></div><div class="line">			<span class="comment">// Panel menu invalidation is deferred avoiding application onCreateOptionsMenu</span></div><div class="line">			<span class="comment">// being called in the middle of onCreate or similar.</span></div><div class="line">			<span class="comment">// A pending invalidation will typically be resolved before the posted message</span></div><div class="line">			<span class="comment">// would run normally in order to satisfy instance state restoration.</span></div><div class="line">			PanelFeatureState st = getPanelState(FEATURE_OPTIONS_PANEL, <span class="keyword">false</span>);</div><div class="line">			<span class="keyword">if</span> (!isDestroyed() &amp;&amp; (st == <span class="keyword">null</span> || st.menu == <span class="keyword">null</span>)) &#123;</div><div class="line">				invalidatePanelMenu(FEATURE_ACTION_BAR);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mTitleView = (TextView)findViewById(R.id.title);</div><div class="line">			<span class="keyword">if</span> (mTitleView != <span class="keyword">null</span>) &#123;</div><div class="line">				mTitleView.setLayoutDirection(mDecor.getLayoutDirection());</div><div class="line">				<span class="keyword">if</span> ((getLocalFeatures() &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) != <span class="number">0</span>) &#123;</div><div class="line">					View titleContainer = findViewById(</div><div class="line">							R.id.title_container);</div><div class="line">					<span class="keyword">if</span> (titleContainer != <span class="keyword">null</span>) &#123;</div><div class="line">						titleContainer.setVisibility(View.GONE);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						mTitleView.setVisibility(View.GONE);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (mContentParent <span class="keyword">instanceof</span> FrameLayout) &#123;</div><div class="line">						((FrameLayout)mContentParent).setForeground(<span class="keyword">null</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					mTitleView.setText(mTitle);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mDecor.getBackground() == <span class="keyword">null</span> &amp;&amp; mBackgroundFallbackResource != <span class="number">0</span>) &#123;</div><div class="line">			mDecor.setBackgroundFallback(mBackgroundFallbackResource);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Only inflate or create a new TransitionManager if the caller hasn't</span></div><div class="line">		<span class="comment">// already set a custom one.</span></div><div class="line">		<span class="keyword">if</span> (hasFeature(FEATURE_ACTIVITY_TRANSITIONS)) &#123;</div><div class="line">			<span class="keyword">if</span> (mTransitionManager == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> transitionRes = getWindowStyle().getResourceId(</div><div class="line">						R.styleable.Window_windowContentTransitionManager,</div><div class="line">						<span class="number">0</span>);</div><div class="line">				<span class="keyword">if</span> (transitionRes != <span class="number">0</span>) &#123;</div><div class="line">					<span class="keyword">final</span> TransitionInflater inflater = TransitionInflater.from(getContext());</div><div class="line">					mTransitionManager = inflater.inflateTransitionManager(transitionRes,</div><div class="line">							mContentParent);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					mTransitionManager = <span class="keyword">new</span> TransitionManager();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			mEnterTransition = getTransition(mEnterTransition, <span class="keyword">null</span>,</div><div class="line">					R.styleable.Window_windowEnterTransition);</div><div class="line">			mReturnTransition = getTransition(mReturnTransition, USE_DEFAULT_TRANSITION,</div><div class="line">					R.styleable.Window_windowReturnTransition);</div><div class="line">			mExitTransition = getTransition(mExitTransition, <span class="keyword">null</span>,</div><div class="line">					R.styleable.Window_windowExitTransition);</div><div class="line">			mReenterTransition = getTransition(mReenterTransition, USE_DEFAULT_TRANSITION,</div><div class="line">					R.styleable.Window_windowReenterTransition);</div><div class="line">			mSharedElementEnterTransition = getTransition(mSharedElementEnterTransition, <span class="keyword">null</span>,</div><div class="line">					R.styleable.Window_windowSharedElementEnterTransition);</div><div class="line">			mSharedElementReturnTransition = getTransition(mSharedElementReturnTransition,</div><div class="line">					USE_DEFAULT_TRANSITION,</div><div class="line">					R.styleable.Window_windowSharedElementReturnTransition);</div><div class="line">			mSharedElementExitTransition = getTransition(mSharedElementExitTransition, <span class="keyword">null</span>,</div><div class="line">					R.styleable.Window_windowSharedElementExitTransition);</div><div class="line">			mSharedElementReenterTransition = getTransition(mSharedElementReenterTransition,</div><div class="line">					USE_DEFAULT_TRANSITION,</div><div class="line">					R.styleable.Window_windowSharedElementReenterTransition);</div><div class="line">			<span class="keyword">if</span> (mAllowEnterTransitionOverlap == <span class="keyword">null</span>) &#123;</div><div class="line">				mAllowEnterTransitionOverlap = getWindowStyle().getBoolean(</div><div class="line">						R.styleable.Window_windowAllowEnterTransitionOverlap, <span class="keyword">true</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (mAllowReturnTransitionOverlap == <span class="keyword">null</span>) &#123;</div><div class="line">				mAllowReturnTransitionOverlap = getWindowStyle().getBoolean(</div><div class="line">						R.styleable.Window_windowAllowReturnTransitionOverlap, <span class="keyword">true</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (mBackgroundFadeDurationMillis &lt; <span class="number">0</span>) &#123;</div><div class="line">				mBackgroundFadeDurationMillis = getWindowStyle().getInteger(</div><div class="line">						R.styleable.Window_windowTransitionBackgroundFadeDuration,</div><div class="line">						DEFAULT_BACKGROUND_FADE_DURATION_MS);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (mSharedElementsUseOverlay == <span class="keyword">null</span>) &#123;</div><div class="line">				mSharedElementsUseOverlay = getWindowStyle().getBoolean(</div><div class="line">						R.styleable.Window_windowSharedElementsUseOverlay, <span class="keyword">true</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们先看一下<code>generateLayout</code>的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</div><div class="line">	<span class="comment">// Apply data from current theme.</span></div><div class="line"></div><div class="line">	TypedArray a = getWindowStyle();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">		System.out.println(<span class="string">"From style:"</span>);</div><div class="line">		String s = <span class="string">"Attrs:"</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; R.styleable.Window.length; i++) &#123;</div><div class="line">			s = s + <span class="string">" "</span> + Integer.toHexString(R.styleable.Window[i]) + <span class="string">"="</span></div><div class="line">					+ a.getString(i);</div><div class="line">		&#125;</div><div class="line">		System.out.println(s);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, <span class="keyword">false</span>);</div><div class="line">	<span class="keyword">int</span> flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR)</div><div class="line">			&amp; (~getForcedWindowFlags());</div><div class="line">	<span class="keyword">if</span> (mIsFloating) &#123;</div><div class="line">		setLayout(WRAP_CONTENT, WRAP_CONTENT);</div><div class="line">		setFlags(<span class="number">0</span>, flagsToUpdate);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		setFlags(FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR, flagsToUpdate);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowNoTitle, <span class="keyword">false</span>)) &#123;</div><div class="line">		requestFeature(FEATURE_NO_TITLE);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBar, <span class="keyword">false</span>)) &#123;</div><div class="line">		<span class="comment">// Don't allow an action bar if there is no title.</span></div><div class="line">		requestFeature(FEATURE_ACTION_BAR);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBarOverlay, <span class="keyword">false</span>)) &#123;</div><div class="line">		requestFeature(FEATURE_ACTION_BAR_OVERLAY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionModeOverlay, <span class="keyword">false</span>)) &#123;</div><div class="line">		requestFeature(FEATURE_ACTION_MODE_OVERLAY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowSwipeToDismiss, <span class="keyword">false</span>)) &#123;</div><div class="line">		requestFeature(FEATURE_SWIPE_TO_DISMISS);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowFullscreen, <span class="keyword">false</span>)) &#123;</div><div class="line">		setFlags(FLAG_FULLSCREEN, FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowTranslucentStatus,</div><div class="line">			<span class="keyword">false</span>)) &#123;</div><div class="line">		setFlags(FLAG_TRANSLUCENT_STATUS, FLAG_TRANSLUCENT_STATUS</div><div class="line">				&amp; (~getForcedWindowFlags()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowTranslucentNavigation,</div><div class="line">			<span class="keyword">false</span>)) &#123;</div><div class="line">		setFlags(FLAG_TRANSLUCENT_NAVIGATION, FLAG_TRANSLUCENT_NAVIGATION</div><div class="line">				&amp; (~getForcedWindowFlags()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowOverscan, <span class="keyword">false</span>)) &#123;</div><div class="line">		setFlags(FLAG_LAYOUT_IN_OVERSCAN, FLAG_LAYOUT_IN_OVERSCAN&amp;(~getForcedWindowFlags()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowShowWallpaper, <span class="keyword">false</span>)) &#123;</div><div class="line">		setFlags(FLAG_SHOW_WALLPAPER, FLAG_SHOW_WALLPAPER&amp;(~getForcedWindowFlags()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowEnableSplitTouch,</div><div class="line">			getContext().getApplicationInfo().targetSdkVersion</div><div class="line">					&gt;= android.os.Build.VERSION_CODES.HONEYCOMB)) &#123;</div><div class="line">		setFlags(FLAG_SPLIT_TOUCH, FLAG_SPLIT_TOUCH&amp;(~getForcedWindowFlags()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	a.getValue(R.styleable.Window_windowMinWidthMajor, mMinWidthMajor);</div><div class="line">	a.getValue(R.styleable.Window_windowMinWidthMinor, mMinWidthMinor);</div><div class="line">	<span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedWidthMajor)) &#123;</div><div class="line">		<span class="keyword">if</span> (mFixedWidthMajor == <span class="keyword">null</span>) mFixedWidthMajor = <span class="keyword">new</span> TypedValue();</div><div class="line">		a.getValue(R.styleable.Window_windowFixedWidthMajor,</div><div class="line">				mFixedWidthMajor);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedWidthMinor)) &#123;</div><div class="line">		<span class="keyword">if</span> (mFixedWidthMinor == <span class="keyword">null</span>) mFixedWidthMinor = <span class="keyword">new</span> TypedValue();</div><div class="line">		a.getValue(R.styleable.Window_windowFixedWidthMinor,</div><div class="line">				mFixedWidthMinor);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedHeightMajor)) &#123;</div><div class="line">		<span class="keyword">if</span> (mFixedHeightMajor == <span class="keyword">null</span>) mFixedHeightMajor = <span class="keyword">new</span> TypedValue();</div><div class="line">		a.getValue(R.styleable.Window_windowFixedHeightMajor,</div><div class="line">				mFixedHeightMajor);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedHeightMinor)) &#123;</div><div class="line">		<span class="keyword">if</span> (mFixedHeightMinor == <span class="keyword">null</span>) mFixedHeightMinor = <span class="keyword">new</span> TypedValue();</div><div class="line">		a.getValue(R.styleable.Window_windowFixedHeightMinor,</div><div class="line">				mFixedHeightMinor);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowContentTransitions, <span class="keyword">false</span>)) &#123;</div><div class="line">		requestFeature(FEATURE_CONTENT_TRANSITIONS);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActivityTransitions, <span class="keyword">false</span>)) &#123;</div><div class="line">		requestFeature(FEATURE_ACTIVITY_TRANSITIONS);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> WindowManager windowService = (WindowManager) getContext().getSystemService(</div><div class="line">			Context.WINDOW_SERVICE);</div><div class="line">	<span class="keyword">if</span> (windowService != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> Display display = windowService.getDefaultDisplay();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> shouldUseBottomOutset =</div><div class="line">				display.getDisplayId() == Display.DEFAULT_DISPLAY</div><div class="line">						|| (getForcedWindowFlags() &amp; FLAG_FULLSCREEN) != <span class="number">0</span>;</div><div class="line">		<span class="keyword">if</span> (shouldUseBottomOutset &amp;&amp; a.hasValue(R.styleable.Window_windowOutsetBottom)) &#123;</div><div class="line">			<span class="keyword">if</span> (mOutsetBottom == <span class="keyword">null</span>) mOutsetBottom = <span class="keyword">new</span> TypedValue();</div><div class="line">			a.getValue(R.styleable.Window_windowOutsetBottom,</div><div class="line">					mOutsetBottom);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Context context = getContext();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> targetSdk = context.getApplicationInfo().targetSdkVersion;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> targetPreHoneycomb = targetSdk &lt; android.os.Build.VERSION_CODES.HONEYCOMB;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> targetPreIcs = targetSdk &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> targetPreL = targetSdk &lt; android.os.Build.VERSION_CODES.LOLLIPOP;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> targetHcNeedsOptions = context.getResources().getBoolean(</div><div class="line">			R.bool.target_honeycomb_needs_options_menu);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> noActionBar = !hasFeature(FEATURE_ACTION_BAR) || hasFeature(FEATURE_NO_TITLE);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (targetPreHoneycomb || (targetPreIcs &amp;&amp; targetHcNeedsOptions &amp;&amp; noActionBar)) &#123;</div><div class="line">		addFlags(WindowManager.LayoutParams.FLAG_NEEDS_MENU_KEY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		clearFlags(WindowManager.LayoutParams.FLAG_NEEDS_MENU_KEY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Non-floating windows on high end devices must put up decor beneath the system bars and</span></div><div class="line">	<span class="comment">// therefore must know about visibility changes of those.</span></div><div class="line">	<span class="keyword">if</span> (!mIsFloating &amp;&amp; ActivityManager.isHighEndGfx()) &#123;</div><div class="line">		<span class="keyword">if</span> (!targetPreL &amp;&amp; a.getBoolean(</div><div class="line">				R.styleable.Window_windowDrawsSystemBarBackgrounds,</div><div class="line">				<span class="keyword">false</span>)) &#123;</div><div class="line">			setFlags(FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS,</div><div class="line">					FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS &amp; ~getForcedWindowFlags());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (!mForcedStatusBarColor) &#123;</div><div class="line">		mStatusBarColor = a.getColor(R.styleable.Window_statusBarColor, <span class="number">0xFF000000</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (!mForcedNavigationBarColor) &#123;</div><div class="line">		mNavigationBarColor = a.getColor(R.styleable.Window_navigationBarColor, <span class="number">0xFF000000</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mAlwaysReadCloseOnTouchAttr || getContext().getApplicationInfo().targetSdkVersion</div><div class="line">			&gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">		<span class="keyword">if</span> (a.getBoolean(</div><div class="line">				R.styleable.Window_windowCloseOnTouchOutside,</div><div class="line">				<span class="keyword">false</span>)) &#123;</div><div class="line">			setCloseOnTouchOutsideIfNotSet(<span class="keyword">true</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	WindowManager.LayoutParams params = getAttributes();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!hasSoftInputMode()) &#123;</div><div class="line">		params.softInputMode = a.getInt(</div><div class="line">				R.styleable.Window_windowSoftInputMode,</div><div class="line">				params.softInputMode);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_backgroundDimEnabled,</div><div class="line">			mIsFloating)) &#123;</div><div class="line">		<span class="comment">/* All dialogs should have the window dimmed */</span></div><div class="line">		<span class="keyword">if</span> ((getForcedWindowFlags()&amp;WindowManager.LayoutParams.FLAG_DIM_BEHIND) == <span class="number">0</span>) &#123;</div><div class="line">			params.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!haveDimAmount()) &#123;</div><div class="line">			params.dimAmount = a.getFloat(</div><div class="line">					android.R.styleable.Window_backgroundDimAmount, <span class="number">0.5f</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (params.windowAnimations == <span class="number">0</span>) &#123;</div><div class="line">		params.windowAnimations = a.getResourceId(</div><div class="line">				R.styleable.Window_windowAnimationStyle, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// The rest are only done if this window is not embedded; otherwise,</span></div><div class="line">	<span class="comment">// the values are inherited from our container.</span></div><div class="line">	<span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (mBackgroundDrawable == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (mBackgroundResource == <span class="number">0</span>) &#123;</div><div class="line">				mBackgroundResource = a.getResourceId(</div><div class="line">						R.styleable.Window_windowBackground, <span class="number">0</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (mFrameResource == <span class="number">0</span>) &#123;</div><div class="line">				mFrameResource = a.getResourceId(R.styleable.Window_windowFrame, <span class="number">0</span>);</div><div class="line">			&#125;</div><div class="line">			mBackgroundFallbackResource = a.getResourceId(</div><div class="line">					R.styleable.Window_windowBackgroundFallback, <span class="number">0</span>);</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">				System.out.println(<span class="string">"Background: "</span></div><div class="line">						+ Integer.toHexString(mBackgroundResource) + <span class="string">" Frame: "</span></div><div class="line">						+ Integer.toHexString(mFrameResource));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		mElevation = a.getDimension(R.styleable.Window_windowElevation, <span class="number">0</span>);</div><div class="line">		mClipToOutline = a.getBoolean(R.styleable.Window_windowClipToOutline, <span class="keyword">false</span>);</div><div class="line">		mTextColor = a.getColor(R.styleable.Window_textColor, Color.TRANSPARENT);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 上面的那一块都是对Activity中设置的主题进行判断。下面就是根据不同的主题，选择不同的布局文件。</span></div><div class="line">	<span class="comment">// Inflate the window decor.</span></div><div class="line"></div><div class="line">	<span class="keyword">int</span> layoutResource;</div><div class="line">	<span class="keyword">int</span> features = getLocalFeatures();</div><div class="line">	<span class="comment">// System.out.println("Features: 0x" + Integer.toHexString(features));</span></div><div class="line">	<span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</div><div class="line">		layoutResource = R.layout.screen_swipe_dismiss;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_LEFT_ICON) | (<span class="number">1</span> &lt;&lt; FEATURE_RIGHT_ICON))) != <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (mIsFloating) &#123;</div><div class="line">			TypedValue res = <span class="keyword">new</span> TypedValue();</div><div class="line">			getContext().getTheme().resolveAttribute(</div><div class="line">					R.attr.dialogTitleIconsDecorLayout, res, <span class="keyword">true</span>);</div><div class="line">			layoutResource = res.resourceId;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			layoutResource = R.layout.screen_title_icons;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// XXX Remove this once action bar supports these features.</span></div><div class="line">		removeFeature(FEATURE_ACTION_BAR);</div><div class="line">		<span class="comment">// System.out.println("Title Icons!");</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></div><div class="line">			&amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// Special case for a window with only a progress bar (and title).</span></div><div class="line">		<span class="comment">// XXX Need to have a no-title version of embedded windows.</span></div><div class="line">		layoutResource = R.layout.screen_progress;</div><div class="line">		<span class="comment">// System.out.println("Progress!");</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_CUSTOM_TITLE)) != <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// Special case for a window with a custom title.</span></div><div class="line">		<span class="comment">// If the window is floating, we need a dialog layout</span></div><div class="line">		<span class="keyword">if</span> (mIsFloating) &#123;</div><div class="line">			TypedValue res = <span class="keyword">new</span> TypedValue();</div><div class="line">			getContext().getTheme().resolveAttribute(</div><div class="line">					R.attr.dialogCustomTitleDecorLayout, res, <span class="keyword">true</span>);</div><div class="line">			layoutResource = res.resourceId;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			layoutResource = R.layout.screen_custom_title;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// XXX Remove this once action bar supports these features.</span></div><div class="line">		removeFeature(FEATURE_ACTION_BAR);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// If no other features and not embedded, only need a title.</span></div><div class="line">		<span class="comment">// If the window is floating, we need a dialog layout</span></div><div class="line">		<span class="keyword">if</span> (mIsFloating) &#123;</div><div class="line">			TypedValue res = <span class="keyword">new</span> TypedValue();</div><div class="line">			getContext().getTheme().resolveAttribute(</div><div class="line">					R.attr.dialogTitleDecorLayout, res, <span class="keyword">true</span>);</div><div class="line">			layoutResource = res.resourceId;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) != <span class="number">0</span>) &#123;</div><div class="line">			layoutResource = a.getResourceId(</div><div class="line">					R.styleable.Window_windowActionBarFullscreenDecorLayout,</div><div class="line">					R.layout.screen_action_bar);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			layoutResource = R.layout.screen_title;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// System.out.println("Title!");</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != <span class="number">0</span>) &#123;</div><div class="line">		layoutResource = R.layout.screen_simple_overlay_action_mode;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Embedded, so no decoration is needed.</span></div><div class="line">		layoutResource = R.layout.screen_simple;</div><div class="line">		<span class="comment">// System.out.println("Simple!");</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mDecor.startChanging();</div><div class="line"></div><div class="line">	<span class="comment">// inflate对应的布局文件，并添加到mDecor中。</span></div><div class="line">	View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</div><div class="line">	decor.addView(in, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">	mContentRoot = (ViewGroup) in;</div><div class="line"></div><div class="line">	<span class="comment">// 找到布局中android:id="@android:id/content"。的ViewGroup赋值给contentParent,一般是FrameLayout</span></div><div class="line">	ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</div><div class="line">	<span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Window couldn't find content container view"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != <span class="number">0</span>) &#123;</div><div class="line">		ProgressBar progress = getCircularProgressBar(<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">if</span> (progress != <span class="keyword">null</span>) &#123;</div><div class="line">			progress.setIndeterminate(<span class="keyword">true</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</div><div class="line">		registerSwipeCallbacks();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Remaining setup -- of background and title -- that only applies</span></div><div class="line">	<span class="comment">// to top-level windows.</span></div><div class="line">	<span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> Drawable background;</div><div class="line">		<span class="keyword">if</span> (mBackgroundResource != <span class="number">0</span>) &#123;</div><div class="line">			background = getContext().getDrawable(mBackgroundResource);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			background = mBackgroundDrawable;</div><div class="line">		&#125;</div><div class="line">		mDecor.setWindowBackground(background);</div><div class="line"></div><div class="line">		<span class="keyword">final</span> Drawable frame;</div><div class="line">		<span class="keyword">if</span> (mFrameResource != <span class="number">0</span>) &#123;</div><div class="line">			frame = getContext().getDrawable(mFrameResource);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			frame = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		mDecor.setWindowFrame(frame);</div><div class="line"></div><div class="line">		mDecor.setElevation(mElevation);</div><div class="line">		mDecor.setClipToOutline(mClipToOutline);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mTitle != <span class="keyword">null</span>) &#123;</div><div class="line">			setTitle(mTitle);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mTitleColor == <span class="number">0</span>) &#123;</div><div class="line">			mTitleColor = mTextColor;</div><div class="line">		&#125;</div><div class="line">		setTitleColor(mTitleColor);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mDecor.finishChanging();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> contentParent;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面看到有很多相应主题的布局文件，我们就以典型的<code>R.layout.screen_title</code>为例看一下。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">"true"</span>&gt;</div><div class="line">    <span class="comment">&lt;!-- Popout bar for action modes --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">"@+id/action_mode_bar_stub"</span></span></div><div class="line">              <span class="attr">android:inflatedId</span>=<span class="string">"@+id/action_mode_bar"</span></div><div class="line">              <span class="attr">android:layout</span>=<span class="string">"@layout/action_mode_bar"</span></div><div class="line">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">              <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">              <span class="attr">android:theme</span>=<span class="string">"?attr/actionBarTheme"</span> /&gt;</div><div class="line">	// 标题</div><div class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span> </div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"?android:attr/windowTitleSize"</span></div><div class="line">        <span class="attr">style</span>=<span class="string">"?android:attr/windowTitleBackgroundStyle"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:id</span>=<span class="string">"@android:id/title"</span> </span></div><div class="line">            <span class="attr">style</span>=<span class="string">"?android:attr/windowTitleStyle"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@null"</span></div><div class="line">            <span class="attr">android:fadingEdge</span>=<span class="string">"horizontal"</span></div><div class="line">            <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line">	// 页面内容</div><div class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">android:id</span>=<span class="string">"@android:id/content"</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span> </div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"0dip"</span></div><div class="line">        <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">        <span class="attr">android:foregroundGravity</span>=<span class="string">"fill_horizontal|top"</span></div><div class="line">        <span class="attr">android:foreground</span>=<span class="string">"?android:attr/windowContentOverlay"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>看到这里基本差不多了，我们就以第一次调用<code>setContentView</code>方法为例总结一下整体的流程。</p>
<ul>
<li>第一次调用<code>setContentView()</code>方法时会去创建一个<code>DecorView</code>，这就是整个窗口的根布局。</li>
<li>接着回去根据我们设置的对应主题，来加载与之对应的布局文件并将其添加到<code>DecorView</code>中，然后找到该布局中<code>id=content</code>的<code>ViewGroup</code>赋值给<code>mContentParent</code>。</li>
<li>将我们要设置的<code>Activity</code>对应的布局添加到<code>mContentParent</code>中。</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Activity界面绘制过程详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Activity启动过程" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Activity启动过程/">Activity启动过程</a>
    </h1>
  

        
        <a href="/2015/01/01/Activity启动过程/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Activity启动过程"><a href="#Activity启动过程" class="headerlink" title="Activity启动过程"></a>Activity启动过程</h1><p>前两天面试了天猫的开发，被问到了<code>Activity</code>启动过程，不懂啊….<br>今天就来分析一下，我们开启<code>Activity</code>主要有两种方式:    </p>
<ul>
<li>通过桌面图标启动，桌面就是<code>Launcher</code>其实他也是一个应用程序，他也是继承<code>Activity</code>。</li>
<li>在程序内部调用<code>startActivity()</code>开启。</li>
</ul>
<p>而<code>Launcher</code>点击图标其实也是调用了<code>Activity</code>的<code>startActivity()</code>方法，所以我们就从<code>startActivity()</code>方法入手了。<br>首先看一下<code>Activity</code>类中的<code>startActivity()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>startActivity(intent, null)</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Launch a new activity.  You will not receive any information about when</div><div class="line"> * the activity exits.  This implementation overrides the base version,</div><div class="line"> * providing information about</div><div class="line"> * the activity performing the launch.  Because of this additional</div><div class="line"> * information, the &#123;<span class="doctag">@link</span> Intent#FLAG_ACTIVITY_NEW_TASK&#125; launch flag is not</div><div class="line"> * required; if not specified, the new activity will be added to the</div><div class="line"> * task of the caller.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> intent The intent to start.</div><div class="line"> * <span class="doctag">@param</span> options Additional options for how the Activity should be started.</div><div class="line"> * See &#123;<span class="doctag">@link</span> android.content.Context#startActivity(Intent, Bundle)</div><div class="line"> * Context.startActivity(Intent, Bundle)&#125; for more details.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> &#123;<span class="doctag">@link</span> #startActivity(Intent)&#125;</div><div class="line"> * <span class="doctag">@see</span> #startActivityForResult</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">		startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Note we want to go through this call for compatibility with</span></div><div class="line">		<span class="comment">// applications that may have overridden the method.</span></div><div class="line">		startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来会调用<code>startActivityForResult()</code>方法(注释也很重要啊，里面也说明了singleTask启动模式时该方法不会走到回调中):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Launch an activity for which you would like a result when it finished.</div><div class="line"> * When this activity exits, your</div><div class="line"> * onActivityResult() method will be called with the given requestCode.</div><div class="line"> * Using a negative requestCode is the same as calling</div><div class="line"> * &#123;<span class="doctag">@link</span> #startActivity&#125; (the activity is not launched as a sub-activity).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this method should only be used with Intent protocols</div><div class="line"> * that are defined to return a result.  In other protocols (such as</div><div class="line"> * &#123;<span class="doctag">@link</span> Intent#ACTION_MAIN&#125; or &#123;<span class="doctag">@link</span> Intent#ACTION_VIEW&#125;), you may</div><div class="line"> * not get the result when you expect.  For example, if the activity you</div><div class="line"> * are launching uses the singleTask launch mode, it will not run in your</div><div class="line"> * task and thus you will immediately receive a cancel result.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;As a special case, if you call startActivityForResult() with a requestCode</div><div class="line"> * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your</div><div class="line"> * activity, then your window will not be displayed until a result is</div><div class="line"> * returned back from the started activity.  This is to avoid visible</div><div class="line"> * flickering when redirecting to another activity.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> intent The intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode If &gt;= 0, this code will be returned in</div><div class="line"> *                    onActivityResult() when the activity exits.</div><div class="line"> * <span class="doctag">@param</span> options Additional options for how the Activity should be started.</div><div class="line"> * See &#123;<span class="doctag">@link</span> android.content.Context#startActivity(Intent, Bundle)</div><div class="line"> * Context.startActivity(Intent, Bundle)&#125; for more details.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #startActivity</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">	<span class="comment">// mParent也是Activity类，通过名字就能看明白了。</span></div><div class="line">	<span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 开始了啊</span></div><div class="line">		Instrumentation.ActivityResult ar =</div><div class="line">			mInstrumentation.execStartActivity(</div><div class="line">				<span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">				intent, requestCode, options);</div><div class="line">		<span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">			mMainThread.sendActivityResult(</div><div class="line">				mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">				ar.getResultData());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// If this start is requesting a result, we can avoid making</span></div><div class="line">			<span class="comment">// the activity visible until the result is received.  Setting</span></div><div class="line">			<span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></div><div class="line">			<span class="comment">// activity hidden during this time, to avoid flickering.</span></div><div class="line">			<span class="comment">// This can only be done when a result is requested because</span></div><div class="line">			<span class="comment">// that guarantees we will get information back when the</span></div><div class="line">			<span class="comment">// activity is finished, no matter what happens to it.</span></div><div class="line">			mStartedActivity = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cancelInputsAndStartExitTransition(options);</div><div class="line">		<span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">			mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// Note we want to go through this method for compatibility with</span></div><div class="line">			<span class="comment">// existing applications that may have overridden it.</span></div><div class="line">			mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面调用了<code>mInstrumentation.execStartActivity</code>这是啥玩意，先看一下<code>mInstrumentation</code>属性，他是<code>Instrumentation</code>类，我们看下文档<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Base class for implementing application instrumentation code.  When running</div><div class="line"> * with instrumentation turned on, this class will be instantiated for you</div><div class="line"> * before any of the application code, allowing you to monitor all of the</div><div class="line"> * interaction the system has with the application.  An Instrumentation</div><div class="line"> * implementation is described to the system through an AndroidManifest.xml's</div><div class="line"> * &amp;lt;instrumentation&amp;gt; tag.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Instrumentation</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>放狗查了下<code>Instrumentation</code>的意思是仪器、工具、装置的意思。我就大体翻一下(英语不好- -~，可能不准确)该类是实现应用程序代码的基类，当该类在<br>启动的状态下运行时，该类会在其他任何应用程序运行前进行初始化，允许你件事所有应用程序与系统的交互。一个<code>Instrumentation</code>实例会通过<code>Manifest</code>文件<br>中的<code>&lt;instrumenttation</code>标签描述给系统。<br>所以继续看一下<code>mInstrumentation.execStartActivity()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   // 下面的注释说的很明白了默认实现会更新任何活跃的对象并分发给系统的`activity manager`</div><div class="line"> * Execute a startActivity call made by the application.  The default </div><div class="line"> * implementation takes care of updating any active &#123;<span class="doctag">@link</span> ActivityMonitor&#125;</div><div class="line"> * objects and dispatches this call to the system activity manager; you can</div><div class="line"> * override this to watch for the application to start an activity, and </div><div class="line"> * modify what happens when it does. </div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method returns an &#123;<span class="doctag">@link</span> ActivityResult&#125; object, which you can </div><div class="line"> * use when intercepting application calls to avoid performing the start </div><div class="line"> * activity action but still return the result the application is </div><div class="line"> * expecting.  To do this, override this method to catch the call to start </div><div class="line"> * activity so that it returns a new ActivityResult containing the results </div><div class="line"> * you would like the application to see, and don't call up to the super </div><div class="line"> * class.  Note that an application is only expecting a result if </div><div class="line"> * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This method throws &#123;<span class="doctag">@link</span> android.content.ActivityNotFoundException&#125;</div><div class="line"> * if there was no Activity found to run the given Intent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> who The Context from which the activity is being started.</div><div class="line"> * <span class="doctag">@param</span> contextThread The main thread of the Context from which the activity</div><div class="line"> *                      is being started.</div><div class="line"> * <span class="doctag">@param</span> token Internal token identifying to the system who is starting </div><div class="line"> *              the activity; may be null.</div><div class="line"> * <span class="doctag">@param</span> target Which activity is performing the start (and thus receiving </div><div class="line"> *               any result); may be null if this call is not being made</div><div class="line"> *               from an activity.</div><div class="line"> * <span class="doctag">@param</span> intent The actual Intent to start.</div><div class="line"> * <span class="doctag">@param</span> requestCode Identifier for this request's result; less than zero </div><div class="line"> *                    if the caller is not expecting a result.</div><div class="line"> * <span class="doctag">@param</span> options Addition options.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> To force the return of a particular result, return an </div><div class="line"> *         ActivityResult object containing the desired data; otherwise</div><div class="line"> *         return null.  The default implementation always returns null.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivity(Intent)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityForResult(Intent, int)</div><div class="line"> * <span class="doctag">@see</span> Activity#startActivityFromChild</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">		Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">		Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</div><div class="line">	IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">	Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</div><div class="line">		intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">				<span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</div><div class="line">					am.mHits++;</div><div class="line">					<span class="keyword">if</span> (am.isBlocking()) &#123;</div><div class="line">						<span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		intent.migrateExtraStreamToClipData();</div><div class="line">		intent.prepareToLeaveProcess();</div><div class="line">		<span class="comment">// 通过注释然后再结合代码一看我们就知道这应该就是分发到系统activity manager的过程</span></div><div class="line">		<span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">			.startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">					intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">					token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">					requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">		checkStartActivityResult(result, intent);</div><div class="line">	&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那就直接看下<code>ActivityManagerNative.getDefault().startActivity()</code>方法，看之前我们先看看<code>ActivityManagerNative.getDefault()</code>是什么鬼:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve the system's default/global activity manager.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释说的明白的就是拿到系统默认/全局的<code>activity manager</code>，通过名字也能看出来<code>IActivityManager</code>是个接口，那就继续看<code>IActivityManager.startActivity()</code>方法吧:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">            String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> flags,</div><div class="line">            ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException;</div></pre></td></tr></table></figure></p>
<p>这里就顺便看一下<code>IActivityManager</code>接口是神马鬼：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * System private API for talking with the activity manager service.  This</div><div class="line"> * provides calls from the application back to the activity manager.</div><div class="line"> *</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">public interface IActivityManager extends IInterface &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是看到这里我不知道怎么继续往下分析了啊，既然是接口我们要找到实现类啊，又是通过<code>ActivityManagerNative.getDefault()</code>得到的<code>IActivityManager</code>实例，<br>所以这里我们再看下<code>ActivityManagerNative</code>类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>啊！ 隐藏的，连个注释也没有，我拖动了下这个类一看<code>5992</code>行，不知道从哪下手了，还能从哪下手啊，当然是从<code>ActivityManagerNative.getDefault()</code>方法啊<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 继承Binder接口，而且asInterFace方法，我好想明白了点什么</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cast a Binder object into an activity manager interface, generating</div><div class="line">     * a proxy if needed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        IActivityManager in =</div><div class="line">            (IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> in;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Retrieve the system's default/global activity manager.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 使用了getDefaule的get方法</span></div><div class="line">        <span class="keyword">return</span> gDefault.get();</div><div class="line">    &#125;</div><div class="line">	....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看：　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">	<span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="comment">// 进程间通信了</span></div><div class="line">		IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">			Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 看到了吗？用到了刚才我们说的asInterface方法</span></div><div class="line">		IActivityManager am = asInterface(b);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">			Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> am;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>好了，我们再看下<code>asInterface()</code>方法:　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	IActivityManager in =</div><div class="line">		(IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">	<span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> in;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 在这里</span></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>终于找到了其实就是<code>ActivityManagerProxy</code>类，刚才我们找到<code>IActivityManager</code>接口的<code>startActivity()</code> 方法，现在终于找到了在这里使用的是<code>IActivityManager</code>接口实现类的<br><code>ActivityManagerProxy</code>类，我们来看一下该类实现的<code>startActivity()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span></span></div><div class="line">    &#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">			String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">			<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">		Parcel data = Parcel.obtain();</div><div class="line">		Parcel reply = Parcel.obtain();</div><div class="line">		data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">		data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</div><div class="line">		data.writeString(callingPackage);</div><div class="line">		intent.writeToParcel(data, <span class="number">0</span>);</div><div class="line">		data.writeString(resolvedType);</div><div class="line">		data.writeStrongBinder(resultTo);</div><div class="line">		data.writeString(resultWho);</div><div class="line">		data.writeInt(requestCode);</div><div class="line">		data.writeInt(startFlags);</div><div class="line">		<span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">			data.writeInt(<span class="number">1</span>);</div><div class="line">			profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			data.writeInt(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">			data.writeInt(<span class="number">1</span>);</div><div class="line">			options.writeToParcel(data, <span class="number">0</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			data.writeInt(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">		reply.readException();</div><div class="line">		<span class="keyword">int</span> result = reply.readInt();</div><div class="line">		reply.recycle();</div><div class="line">		data.recycle();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再继续我就不知道走到哪里了….<br>这一块其实是用了<code>Binder</code>机制，上面的<code>IActivityManager.getDefault()</code>方法返回的是<code>ActivityManagerService</code>的远程接口，所以接下来<br>我们应该看一下<code>ActivityManagerService.startActivity()</code>类。(具体<code>Binder</code>机制我们后续会专门写一篇文章，这里就不说了，不然就说不完了)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">		Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) &#123;</div><div class="line">	<span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">		resultWho, requestCode, startFlags, profilerInfo, options,</div><div class="line">		UserHandle.getCallingUserId());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看下<code>startActivityAsUser()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">		Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId) &#123;</div><div class="line">	enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">	userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</div><div class="line">			<span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></div><div class="line">	<span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">			resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">			profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>mStackSupervisor.startActivityMayWait()</code>方法,这里<code>mStackSupervisor</code>是<code>ActivityStackSupervisor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></div><div class="line">		String callingPackage, Intent intent, String resolvedType,</div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">		IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</div><div class="line">		ProfilerInfo profilerInfo, WaitResult outResult, Configuration config,</div><div class="line">		Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</div><div class="line">		IActivityContainer iContainer, TaskRecord inTask) &#123;</div><div class="line">	<span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">	<span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Don't modify the client's object!</span></div><div class="line">	intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">	<span class="comment">// 解析出要开启的Activity的信息，包名、类名、参数等。</span></div><div class="line">	<span class="comment">// Collect information about the target of the Intent.</span></div><div class="line">	ActivityInfo aInfo =</div><div class="line">			resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</div><div class="line"></div><div class="line">	ActivityContainer container = (ActivityContainer)iContainer;</div><div class="line">	<span class="keyword">synchronized</span> (mService) &#123;</div><div class="line">		<span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">				container.mParentActivity.state != RESUMED) &#123;</div><div class="line">			<span class="comment">// Cannot start a child activity if the parent is not resumed.</span></div><div class="line">			<span class="keyword">return</span> ActivityManager.START_CANCELED;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</div><div class="line">		<span class="keyword">int</span> callingPid;</div><div class="line">		<span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</div><div class="line">			callingPid = -<span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</div><div class="line">			callingPid = realCallingPid;</div><div class="line">			callingUid = realCallingUid;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			callingPid = callingUid = -<span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> ActivityStack stack;</div><div class="line">		<span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</div><div class="line">			stack = mFocusedStack;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			stack = container.mStack;</div><div class="line">		&#125;</div><div class="line">		stack.mConfigWillChange = config != <span class="keyword">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</div><div class="line">		<span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</div><div class="line">				<span class="string">"Starting activity when config will change = "</span> + stack.mConfigWillChange);</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</div><div class="line">				(aInfo.applicationInfo.privateFlags</div><div class="line">						&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// This may be a heavy-weight process!  Check to see if we already</span></div><div class="line">			<span class="comment">// have another, different heavy-weight process running.</span></div><div class="line">			<span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</div><div class="line">				<span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span> &amp;&amp;</div><div class="line">						(mService.mHeavyWeightProcess.info.uid != aInfo.applicationInfo.uid ||</div><div class="line">						!mService.mHeavyWeightProcess.processName.equals(aInfo.processName))) &#123;</div><div class="line">					<span class="keyword">int</span> appCallingUid = callingUid;</div><div class="line">					<span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">						ProcessRecord callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">						<span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">							appCallingUid = callerApp.info.uid;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">								  + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></div><div class="line">								  + intent.toString());</div><div class="line">							ActivityOptions.abort(options);</div><div class="line">							<span class="keyword">return</span> ActivityManager.START_PERMISSION_DENIED;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					IIntentSender target = mService.getIntentSenderLocked(</div><div class="line">							ActivityManager.INTENT_SENDER_ACTIVITY, <span class="string">"android"</span>,</div><div class="line">							appCallingUid, userId, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">new</span> Intent[] &#123; intent &#125;,</div><div class="line">							<span class="keyword">new</span> String[] &#123; resolvedType &#125;, PendingIntent.FLAG_CANCEL_CURRENT</div><div class="line">							| PendingIntent.FLAG_ONE_SHOT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">					Intent newIntent = <span class="keyword">new</span> Intent();</div><div class="line">					<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">						<span class="comment">// Caller is requesting a result.</span></div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_HAS_RESULT, <span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">					newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT,</div><div class="line">							<span class="keyword">new</span> IntentSender(target));</div><div class="line">					<span class="keyword">if</span> (mService.mHeavyWeightProcess.activities.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">						ActivityRecord hist = mService.mHeavyWeightProcess.activities.get(<span class="number">0</span>);</div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_APP,</div><div class="line">								hist.packageName);</div><div class="line">						newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_TASK,</div><div class="line">								hist.task.taskId);</div><div class="line">					&#125;</div><div class="line">					newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP,</div><div class="line">							aInfo.packageName);</div><div class="line">					newIntent.setFlags(intent.getFlags());</div><div class="line">					newIntent.setClassName(<span class="string">"android"</span>,</div><div class="line">							HeavyWeightSwitcherActivity.class.getName());</div><div class="line">					intent = newIntent;</div><div class="line">					resolvedType = <span class="keyword">null</span>;</div><div class="line">					caller = <span class="keyword">null</span>;</div><div class="line">					callingUid = Binder.getCallingUid();</div><div class="line">					callingPid = Binder.getCallingPid();</div><div class="line">					componentSpecified = <span class="keyword">true</span>;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						ResolveInfo rInfo =</div><div class="line">							AppGlobals.getPackageManager().resolveIntent(</div><div class="line">									intent, <span class="keyword">null</span>,</div><div class="line">									PackageManager.MATCH_DEFAULT_ONLY</div><div class="line">									| ActivityManagerService.STOCK_PM_FLAGS, userId);</div><div class="line">						aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</div><div class="line">						aInfo = mService.getActivityInfoForUser(aInfo, userId);</div><div class="line">					&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">						aInfo = <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 根据上面解析的内容去开启了。。。</span></div><div class="line">		<span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</div><div class="line">				voiceSession, voiceInteractor, resultTo, resultWho,</div><div class="line">				requestCode, callingPid, callingUid, callingPackage,</div><div class="line">				realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</div><div class="line">				componentSpecified, <span class="keyword">null</span>, container, inTask);</div><div class="line"></div><div class="line">		Binder.restoreCallingIdentity(origId);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (stack.mConfigWillChange) &#123;</div><div class="line">			<span class="comment">// If the caller also wants to switch to a new configuration,</span></div><div class="line">			<span class="comment">// do so now.  This allows a clean switch, as we are waiting</span></div><div class="line">			<span class="comment">// for the current activity to pause (so we will not destroy</span></div><div class="line">			<span class="comment">// it), and have not yet started the next activity.</span></div><div class="line">			mService.enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</div><div class="line">					<span class="string">"updateConfiguration()"</span>);</div><div class="line">			stack.mConfigWillChange = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</div><div class="line">					<span class="string">"Updating to new configuration after starting activity."</span>);</div><div class="line">			mService.updateConfigurationLocked(config, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</div><div class="line">			outResult.result = res;</div><div class="line">			<span class="keyword">if</span> (res == ActivityManager.START_SUCCESS) &#123;</div><div class="line">				mWaitingActivityLaunched.add(outResult);</div><div class="line">				<span class="keyword">do</span> &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						mService.wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (res == ActivityManager.START_TASK_TO_FRONT) &#123;</div><div class="line">				ActivityRecord r = stack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">				<span class="keyword">if</span> (r.nowVisible &amp;&amp; r.state == RESUMED) &#123;</div><div class="line">					outResult.timeout = <span class="keyword">false</span>;</div><div class="line">					outResult.who = <span class="keyword">new</span> ComponentName(r.info.packageName, r.info.name);</div><div class="line">					outResult.totalTime = <span class="number">0</span>;</div><div class="line">					outResult.thisTime = <span class="number">0</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					outResult.thisTime = SystemClock.uptimeMillis();</div><div class="line">					mWaitingActivityVisible.add(outResult);</div><div class="line">					<span class="keyword">do</span> &#123;</div><div class="line">						<span class="keyword">try</span> &#123;</div><div class="line">							mService.wait();</div><div class="line">						&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> res;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那就继续看一下<code>startActivityLocked()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">		Intent intent, String resolvedType, ActivityInfo aInfo,</div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">		IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">		<span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</div><div class="line">		<span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</div><div class="line">		<span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</div><div class="line">		ActivityContainer container, TaskRecord inTask) &#123;</div><div class="line">	<span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</div><div class="line"></div><div class="line">	ProcessRecord callerApp = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// mService就是ActivityManagerService类</span></div><div class="line">		callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">		<span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">			callingPid = callerApp.pid;</div><div class="line">			callingUid = callerApp.info.uid;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			Slog.w(TAG, <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">				  + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting: "</span></div><div class="line">				  + intent.toString());</div><div class="line">			err = ActivityManager.START_PERMISSION_DENIED;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</div><div class="line">		Slog.i(TAG, <span class="string">"START u"</span> + userId + <span class="string">" &#123;"</span> + intent.toShortString(<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>)</div><div class="line">				+ <span class="string">"&#125; from uid "</span> + callingUid</div><div class="line">				+ <span class="string">" on display "</span> + (container == <span class="keyword">null</span> ? (mFocusedStack == <span class="keyword">null</span> ?</div><div class="line">						Display.DEFAULT_DISPLAY : mFocusedStack.mDisplayId) :</div><div class="line">						(container.mActivityDisplay == <span class="keyword">null</span> ? Display.DEFAULT_DISPLAY :</div><div class="line">								container.mActivityDisplay.mDisplayId)));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ActivityRecord sourceRecord = <span class="keyword">null</span>;</div><div class="line">	ActivityRecord resultRecord = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">		sourceRecord = isInAnyStackLocked(resultTo);</div><div class="line">		<span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</div><div class="line">				<span class="string">"Will send result to "</span> + resultTo + <span class="string">" "</span> + sourceRecord);</div><div class="line">		<span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</div><div class="line">				resultRecord = sourceRecord;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// Transfer the result target from the source activity to the new</span></div><div class="line">		<span class="comment">// one being started, including any failures.</span></div><div class="line">		<span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</div><div class="line">		&#125;</div><div class="line">		resultRecord = sourceRecord.resultTo;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;</div><div class="line">			resultRecord = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		resultWho = sourceRecord.resultWho;</div><div class="line">		requestCode = sourceRecord.requestCode;</div><div class="line">		sourceRecord.resultTo = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (sourceRecord.launchedFromUid == callingUid) &#123;</div><div class="line">			<span class="comment">// The new activity is being launched from the same uid as the previous</span></div><div class="line">			<span class="comment">// activity in the flow, and asking to forward its result back to the</span></div><div class="line">			<span class="comment">// previous.  In this case the activity is serving as a trampoline between</span></div><div class="line">			<span class="comment">// the two, so we also want to update its launchedFromPackage to be the</span></div><div class="line">			<span class="comment">// same as the previous activity.  Note that this is safe, since we know</span></div><div class="line">			<span class="comment">// these two packages come from the same uid; the caller could just as</span></div><div class="line">			<span class="comment">// well have supplied that same package name itself.  This specifially</span></div><div class="line">			<span class="comment">// deals with the case of an intent picker/chooser being launched in the app</span></div><div class="line">			<span class="comment">// flow to redirect to an activity picked by the user, where we want the final</span></div><div class="line">			<span class="comment">// activity to consider it to have been launched by the previous app activity.</span></div><div class="line">			callingPackage = sourceRecord.launchedFromPackage;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// We couldn't find a class that can handle the given Intent.</span></div><div class="line">		<span class="comment">// That's the end of that!</span></div><div class="line">		err = ActivityManager.START_INTENT_NOT_RESOLVED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// We couldn't find the specific class specified in the Intent.</span></div><div class="line">		<span class="comment">// Also the end of the line.</span></div><div class="line">		err = ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS</div><div class="line">			&amp;&amp; !isCurrentProfileLocked(userId)</div><div class="line">			&amp;&amp; (aInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// Trying to launch a background activity that doesn't show for all users.</span></div><div class="line">		err = ActivityManager.START_NOT_CURRENT_USER_ACTIVITY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class="keyword">null</span></div><div class="line">			&amp;&amp; sourceRecord.task.voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If this activity is being launched as part of a voice session, we need</span></div><div class="line">		<span class="comment">// to ensure that it is safe to do so.  If the upcoming activity will also</span></div><div class="line">		<span class="comment">// be part of the voice session, we can only launch it if it has explicitly</span></div><div class="line">		<span class="comment">// said it supports the VOICE category, or it is a part of the calling app.</span></div><div class="line">		<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span></div><div class="line">				&amp;&amp; sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				intent.addCategory(Intent.CATEGORY_VOICE);</div><div class="line">				<span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(</div><div class="line">						intent.getComponent(), intent, resolvedType)) &#123;</div><div class="line">					Slog.w(TAG,</div><div class="line">							<span class="string">"Activity being started in current voice task does not support voice: "</span></div><div class="line">							+ intent);</div><div class="line">					err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				Slog.w(TAG, <span class="string">"Failure checking voice capabilities"</span>, e);</div><div class="line">				err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; voiceSession != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the caller is starting a new voice session, just make sure the target</span></div><div class="line">		<span class="comment">// is actually allowing it to run this way.</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(intent.getComponent(),</div><div class="line">					intent, resolvedType)) &#123;</div><div class="line">				Slog.w(TAG,</div><div class="line">						<span class="string">"Activity being started in new voice task does not support: "</span></div><div class="line">						+ intent);</div><div class="line">				err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">			Slog.w(TAG, <span class="string">"Failure checking voice capabilities"</span>, e);</div><div class="line">			err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Activity栈</span></div><div class="line">	<span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err != ActivityManager.START_SUCCESS) &#123;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">				resultRecord, resultWho, requestCode,</div><div class="line">				Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> err;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> startAnyPerm = mService.checkPermission(</div><div class="line">			START_ANY_ACTIVITY, callingPid, callingUid);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (startAnyPerm != PERMISSION_GRANTED) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> componentRestriction = getComponentRestrictionForCallingPackage(</div><div class="line">				aInfo, callingPackage, callingPid, callingUid, ignoreTargetSecurity);</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> actionRestriction = getActionRestrictionForCallingPackage(</div><div class="line">				intent.getAction(), callingPackage, callingPid, callingUid);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (componentRestriction == ACTIVITY_RESTRICTION_PERMISSION</div><div class="line">				|| actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</div><div class="line">			<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">				resultStack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">						resultRecord, resultWho, requestCode,</div><div class="line">						Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			String msg;</div><div class="line">			<span class="keyword">if</span> (actionRestriction == ACTIVITY_RESTRICTION_PERMISSION) &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span> + <span class="string">" with revoked permission "</span></div><div class="line">						+ ACTION_TO_RUNTIME_PERMISSION.get(intent.getAction());</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!aInfo.exported) &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">						+ <span class="string">" not exported from uid "</span> + aInfo.applicationInfo.uid;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				msg = <span class="string">"Permission Denial: starting "</span> + intent.toString()</div><div class="line">						+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">						+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">						+ <span class="string">" requires "</span> + aInfo.permission;</div><div class="line">			&#125;</div><div class="line">			Slog.w(TAG, msg);</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (actionRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</div><div class="line">			String message = <span class="string">"Appop Denial: starting "</span> + intent.toString()</div><div class="line">					+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">					+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">					+ <span class="string">" requires "</span> + AppOpsManager.permissionToOp(</div><div class="line">							ACTION_TO_RUNTIME_PERMISSION.get(intent.getAction()));</div><div class="line">			Slog.w(TAG, message);</div><div class="line">			abort = <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (componentRestriction == ACTIVITY_RESTRICTION_APPOP) &#123;</div><div class="line">			String message = <span class="string">"Appop Denial: starting "</span> + intent.toString()</div><div class="line">					+ <span class="string">" from "</span> + callerApp + <span class="string">" (pid="</span> + callingPid</div><div class="line">					+ <span class="string">", uid="</span> + callingUid + <span class="string">")"</span></div><div class="line">					+ <span class="string">" requires appop "</span> + AppOpsManager.permissionToOp(aInfo.permission);</div><div class="line">			Slog.w(TAG, message);</div><div class="line">			abort = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</div><div class="line">			callingPid, resolvedType, aInfo.applicationInfo);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// The Intent we give to the watcher has the extra data</span></div><div class="line">			<span class="comment">// stripped off, since it can contain private information.</span></div><div class="line">			Intent watchIntent = intent.cloneFilter();</div><div class="line">			abort |= !mService.mController.activityStarting(watchIntent,</div><div class="line">					aInfo.applicationInfo.packageName);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">			mService.mController = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (abort) &#123;</div><div class="line">		<span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">			resultStack.sendActivityResultLocked(-<span class="number">1</span>, resultRecord, resultWho, requestCode,</div><div class="line">					Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// We pretend to the caller that it was really started, but</span></div><div class="line">		<span class="comment">// they will just get a cancel result.</span></div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// ActivityRecord: An entry in the history stack, representing an activity.</span></div><div class="line">	ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</div><div class="line">			intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</div><div class="line">			requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</div><div class="line">	<span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</div><div class="line">		outActivity[<span class="number">0</span>] = r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (r.appTimeTracker == <span class="keyword">null</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the caller didn't specify an explicit time tracker, we want to continue</span></div><div class="line">		<span class="comment">// tracking under any it has.</span></div><div class="line">		r.appTimeTracker = sourceRecord.appTimeTracker;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ActivityStack stack = mFocusedStack;</div><div class="line">	<span class="keyword">if</span> (voiceSession == <span class="keyword">null</span> &amp;&amp; (stack.mResumedActivity == <span class="keyword">null</span></div><div class="line">			|| stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</div><div class="line">		<span class="keyword">if</span> (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid,</div><div class="line">				realCallingPid, realCallingUid, <span class="string">"Activity start"</span>)) &#123;</div><div class="line">			PendingActivityLaunch pal =</div><div class="line">					<span class="keyword">new</span> PendingActivityLaunch(r, sourceRecord, startFlags, stack);</div><div class="line">			mPendingActivityLaunches.add(pal);</div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_SWITCHES_CANCELED;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mService.mDidAppSwitch) &#123;</div><div class="line">		<span class="comment">// This is the second allowed switch since we stopped switches,</span></div><div class="line">		<span class="comment">// so now just generally allow switches.  Use case: user presses</span></div><div class="line">		<span class="comment">// home (switches disabled, switch to home, mDidAppSwitch now true);</span></div><div class="line">		<span class="comment">// user taps a home icon (coming from home so allowed, we hit here</span></div><div class="line">		<span class="comment">// and now allow anyone to switch again).</span></div><div class="line">		mService.mAppSwitchesAllowedTime = <span class="number">0</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mService.mDidAppSwitch = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</div><div class="line">	<span class="comment">// 继续调用方法</span></div><div class="line">	err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">			startFlags, <span class="keyword">true</span>, options, inTask);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// If someone asked to have the keyguard dismissed on the next</span></div><div class="line">		<span class="comment">// activity start, but we are not actually doing an activity</span></div><div class="line">		<span class="comment">// switch...  just dismiss the keyguard now, because we</span></div><div class="line">		<span class="comment">// probably want to see whatever is behind it.</span></div><div class="line">		notifyActivityDrawnForKeyguard();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再继续看<code>startActivityUncheckedLocked</code>方法：　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></div><div class="line">		IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,</div><div class="line">		<span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask) &#123;</div><div class="line">	<span class="keyword">final</span> Intent intent = r.intent;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</div><div class="line"></div><div class="line">	<span class="comment">// In some flows in to this function, we retrieve the task record and hold on to it</span></div><div class="line">	<span class="comment">// without a lock before calling back in to here...  so the task at this point may</span></div><div class="line">	<span class="comment">// not actually be in recents.  Check for that, and if it isn't in recents just</span></div><div class="line">	<span class="comment">// consider it invalid.</span></div><div class="line">	<span class="keyword">if</span> (inTask != <span class="keyword">null</span> &amp;&amp; !inTask.inRecents) &#123;</div><div class="line">		Slog.w(TAG, <span class="string">"Starting activity in task not in recents: "</span> + inTask);</div><div class="line">		inTask = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 判断不同的启动模式</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</div><div class="line"></div><div class="line">	.....</div><div class="line"></div><div class="line">	<span class="comment">// We may want to try to place the new activity in to an existing task.  We always</span></div><div class="line">	<span class="comment">// do this if the target activity is singleTask or singleInstance; we will also do</span></div><div class="line">	<span class="comment">// this if NEW_TASK has been requested, and there is not an additional qualifier telling</span></div><div class="line">	<span class="comment">// us to still place it in a new task: multi task, always doc mode, or being asked to</span></div><div class="line">	<span class="comment">// launch this as a new task behind the current one.</span></div><div class="line">	<span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</div><div class="line">			(launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</div><div class="line">			|| launchSingleInstance || launchSingleTask) &#123;</div><div class="line">		<span class="comment">// If bring to front is requested, and no result is requested and we have not</span></div><div class="line">		<span class="comment">// been given an explicit task to launch in to, and</span></div><div class="line">		<span class="comment">// we can find a task that was started with this same</span></div><div class="line">		<span class="comment">// component, then instead of launching bring that one to the front.</span></div><div class="line">		<span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// See if there is a task to bring to the front.  If this is</span></div><div class="line">			<span class="comment">// a SINGLE_INSTANCE activity, there can be one and only one</span></div><div class="line">			<span class="comment">// instance of it in the history, and it is always in its own</span></div><div class="line">			<span class="comment">// unique task, so we do a special search.</span></div><div class="line">			ActivityRecord intentActivity = !launchSingleInstance ?</div><div class="line">					findTaskLocked(r) : findActivityLocked(intent, r.info);</div><div class="line">			<span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused</span></div><div class="line">				<span class="comment">// but still needs to be a lock task mode violation since the task gets</span></div><div class="line">				<span class="comment">// cleared out and the device would otherwise leave the locked task.</span></div><div class="line">				<span class="keyword">if</span> (isLockTaskModeViolation(intentActivity.task,</div><div class="line">						(launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">						== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</div><div class="line">					showLockTaskToast();</div><div class="line">					Slog.e(TAG, <span class="string">"startActivityUnchecked: Attempt to violate Lock Task Mode"</span>);</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</div><div class="line">					r.task = intentActivity.task;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (intentActivity.task.intent == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// This task was started because of movement of</span></div><div class="line">					<span class="comment">// the activity based on affinity...  now that we</span></div><div class="line">					<span class="comment">// are actually launching it, we can assign the</span></div><div class="line">					<span class="comment">// base intent.</span></div><div class="line">					intentActivity.task.setIntent(r);</div><div class="line">				&#125;</div><div class="line">				targetStack = intentActivity.task.stack;</div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="comment">// If the target task is not in the front, then we need</span></div><div class="line">				<span class="comment">// to bring it to the front...  except...  well, with</span></div><div class="line">				<span class="comment">// SINGLE_TASK_LAUNCH it's not entirely clear.  We'd like</span></div><div class="line">				<span class="comment">// to have the same behavior as if a new instance was</span></div><div class="line">				<span class="comment">// being started, which means not bringing it to the front</span></div><div class="line">				<span class="comment">// if the caller is not itself in the front.</span></div><div class="line">				<span class="keyword">final</span> ActivityStack focusStack = getFocusedStack();</div><div class="line">				ActivityRecord curTop = (focusStack == <span class="keyword">null</span>)</div><div class="line">						? <span class="keyword">null</span> : focusStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">				<span class="keyword">boolean</span> movedToFront = <span class="keyword">false</span>;</div><div class="line">				<span class="keyword">if</span> (curTop != <span class="keyword">null</span> &amp;&amp; (curTop.task != intentActivity.task ||</div><div class="line">						curTop.task != focusStack.topTask())) &#123;</div><div class="line">					r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);</div><div class="line">					<span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> || (sourceStack.topActivity() != <span class="keyword">null</span> &amp;&amp;</div><div class="line">							sourceStack.topActivity().task == sourceRecord.task)) &#123;</div><div class="line">						<span class="comment">// We really do want to push this one into the user's face, right now.</span></div><div class="line">						<span class="keyword">if</span> (launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">							intentActivity.setTaskToAffiliateWith(sourceRecord.task);</div><div class="line">						&#125;</div><div class="line">						movedHome = <span class="keyword">true</span>;</div><div class="line">						targetStack.moveTaskToFrontLocked(intentActivity.task, noAnimation,</div><div class="line">								options, r.appTimeTracker, <span class="string">"bringingFoundTaskToFront"</span>);</div><div class="line">						movedToFront = <span class="keyword">true</span>;</div><div class="line">						<span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">								(FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">								== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">							<span class="comment">// Caller wants to appear on home activity.</span></div><div class="line">							intentActivity.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">						&#125;</div><div class="line">						options = <span class="keyword">null</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">					<span class="keyword">if</span> (DEBUG_TASKS) Slog.d(TAG_TASKS, <span class="string">"Bring to front target: "</span> + targetStack</div><div class="line">							+ <span class="string">" from "</span> + intentActivity);</div><div class="line">					targetStack.moveToFront(<span class="string">"intentActivityFound"</span>);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// If the caller has requested that the target task be</span></div><div class="line">				<span class="comment">// reset, then do so.</span></div><div class="line">				<span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					intentActivity = targetStack.resetTaskIfNeededLocked(intentActivity, r);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">					<span class="comment">// the client said not to do anything if that</span></div><div class="line">					<span class="comment">// is the case, so this is it!  And for paranoia, make</span></div><div class="line">					<span class="comment">// sure we have correctly resumed the top activity.</span></div><div class="line">					<span class="keyword">if</span> (doResume) &#123;</div><div class="line">						resumeTopActivitiesLocked(targetStack, <span class="keyword">null</span>, options);</div><div class="line"></div><div class="line">						<span class="comment">// Make sure to notify Keyguard as well if we are not running an app</span></div><div class="line">						<span class="comment">// transition later.</span></div><div class="line">						<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">							notifyActivityDrawnForKeyguard();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> ((launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">						== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</div><div class="line">					<span class="comment">// The caller has requested to completely replace any</span></div><div class="line">					<span class="comment">// existing task with its new activity.  Well that should</span></div><div class="line">					<span class="comment">// not be too hard...</span></div><div class="line">					reuseTask = intentActivity.task;</div><div class="line">					reuseTask.performClearTaskLocked();</div><div class="line">					reuseTask.setIntent(r);</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></div><div class="line">						|| launchSingleInstance || launchSingleTask) &#123;</div><div class="line">					<span class="comment">// In this situation we want to remove all activities</span></div><div class="line">					<span class="comment">// from the task up to the one being started.  In most</span></div><div class="line">					<span class="comment">// cases this means we are resetting the task to its</span></div><div class="line">					<span class="comment">// initial state.</span></div><div class="line">					ActivityRecord top =</div><div class="line">							intentActivity.task.performClearTaskLocked(r, launchFlags);</div><div class="line">					<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">if</span> (top.frontOfTask) &#123;</div><div class="line">							<span class="comment">// Activity aliases may mean we use different</span></div><div class="line">							<span class="comment">// intents for the top activity, so make sure</span></div><div class="line">							<span class="comment">// the task now has the identity of the new</span></div><div class="line">							<span class="comment">// intent.</span></div><div class="line">							top.task.setIntent(r);</div><div class="line">						&#125;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT,</div><div class="line">								r, top.task);</div><div class="line">						top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="comment">// A special case: we need to start the activity because it is not</span></div><div class="line">						<span class="comment">// currently running, and the caller has asked to clear the current</span></div><div class="line">						<span class="comment">// task to have this activity at the top.</span></div><div class="line">						addingToTask = <span class="keyword">true</span>;</div><div class="line">						<span class="comment">// Now pretend like this activity is being started by the top of its</span></div><div class="line">						<span class="comment">// task, so it is put in the right place.</span></div><div class="line">						sourceRecord = intentActivity;</div><div class="line">						TaskRecord task = sourceRecord.task;</div><div class="line">						<span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.stack == <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Target stack got cleared when we all activities were removed</span></div><div class="line">							<span class="comment">// above. Go ahead and reset it.</span></div><div class="line">							targetStack = computeStackFocus(sourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>);</div><div class="line">							targetStack.addTask(</div><div class="line">									task, !launchTaskBehind <span class="comment">/* toTop */</span>, <span class="keyword">false</span> <span class="comment">/* moving */</span>);</div><div class="line">						&#125;</div><div class="line"></div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.realActivity.equals(intentActivity.task.realActivity)) &#123;</div><div class="line">					<span class="comment">// In this case the top activity on the task is the</span></div><div class="line">					<span class="comment">// same as the one being launched, so we take that</span></div><div class="line">					<span class="comment">// as a request to bring the task to the foreground.</span></div><div class="line">					<span class="comment">// If the top activity in the task is the root</span></div><div class="line">					<span class="comment">// activity, deliver this new intent to it if it</span></div><div class="line">					<span class="comment">// desires.</span></div><div class="line">					<span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || launchSingleTop)</div><div class="line">							&amp;&amp; intentActivity.realActivity.equals(r.realActivity)) &#123;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r,</div><div class="line">								intentActivity.task);</div><div class="line">						<span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</div><div class="line">							intentActivity.task.setIntent(r);</div><div class="line">						&#125;</div><div class="line">						intentActivity.deliverNewIntentLocked(callingUid, r.intent,</div><div class="line">								r.launchedFromPackage);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r.intent.filterEquals(intentActivity.task.intent)) &#123;</div><div class="line">						<span class="comment">// In this case we are launching the root activity</span></div><div class="line">						<span class="comment">// of the task, but with a different intent.  We</span></div><div class="line">						<span class="comment">// should start a new instance on top.</span></div><div class="line">						addingToTask = <span class="keyword">true</span>;</div><div class="line">						sourceRecord = intentActivity;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// In this case an activity is being launched in to an</span></div><div class="line">					<span class="comment">// existing task, without resetting that task.  This</span></div><div class="line">					<span class="comment">// is typically the situation of launching an activity</span></div><div class="line">					<span class="comment">// from a notification or shortcut.  We want to place</span></div><div class="line">					<span class="comment">// the new activity on top of the current task.</span></div><div class="line">					addingToTask = <span class="keyword">true</span>;</div><div class="line">					sourceRecord = intentActivity;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.task.rootWasReset) &#123;</div><div class="line">					<span class="comment">// In this case we are launching in to an existing task</span></div><div class="line">					<span class="comment">// that has not yet been started from its front door.</span></div><div class="line">					<span class="comment">// The current task has been brought to the front.</span></div><div class="line">					<span class="comment">// Ideally, we'd probably like to place this new task</span></div><div class="line">					<span class="comment">// at the bottom of its stack, but that's a little hard</span></div><div class="line">					<span class="comment">// to do with the current organization of the code so</span></div><div class="line">					<span class="comment">// for now we'll just drop it.</span></div><div class="line">					intentActivity.task.setIntent(r);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (!addingToTask &amp;&amp; reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// We didn't do anything...  but it was needed (a.k.a., client</span></div><div class="line">					<span class="comment">// don't use that intent!)  And for paranoia, make</span></div><div class="line">					<span class="comment">// sure we have correctly resumed the top activity.</span></div><div class="line">					<span class="keyword">if</span> (doResume) &#123;</div><div class="line">						targetStack.resumeTopActivityLocked(<span class="keyword">null</span>, options);</div><div class="line">						<span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">							<span class="comment">// Make sure to notify Keyguard as well if we are not running an app</span></div><div class="line">							<span class="comment">// transition later.</span></div><div class="line">							notifyActivityDrawnForKeyguard();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//String uri = r.intent.toURI();</span></div><div class="line">	<span class="comment">//Intent intent2 = new Intent(uri);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "Given intent: " + r.intent);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "URI is: " + uri);</span></div><div class="line">	<span class="comment">//Slog.i(TAG, "To intent: " + intent2);</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// If the activity being launched is the same as the one currently</span></div><div class="line">		<span class="comment">// at the top, then we need to check if it should only be launched</span></div><div class="line">		<span class="comment">// once.</span></div><div class="line">		ActivityStack topStack = mFocusedStack;</div><div class="line">		ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">				<span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">						|| launchSingleTop || launchSingleTask) &#123;</div><div class="line">						ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</div><div class="line">								top.task);</div><div class="line">						<span class="comment">// For paranoia, make sure we have correctly</span></div><div class="line">						<span class="comment">// resumed the top activity.</span></div><div class="line">						topStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">						<span class="keyword">if</span> (doResume) &#123;</div><div class="line">							resumeTopActivitiesLocked();</div><div class="line">						&#125;</div><div class="line">						ActivityOptions.abort(options);</div><div class="line">						<span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">							<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">							<span class="comment">// the client said not to do anything if that</span></div><div class="line">							<span class="comment">// is the case, so this is it!</span></div><div class="line">							<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">						&#125;</div><div class="line">						top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">						<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">			r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>, r.resultTo, r.resultWho,</div><div class="line">					r.requestCode, Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		<span class="keyword">return</span> ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</div><div class="line">			sourceRecord.task : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Should this be considered a new task?</span></div><div class="line">	<span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</div><div class="line">			&amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">		newTask = <span class="keyword">true</span>;</div><div class="line">		targetStack = computeStackFocus(r, newTask);</div><div class="line">		targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">			r.setTask(targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">					newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</div><div class="line">					newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</div><div class="line">					voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</div><div class="line">					taskToAffiliate);</div><div class="line">			<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS,</div><div class="line">					<span class="string">"Starting new activity "</span> + r + <span class="string">" in new task "</span> + r.task);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.setTask(reuseTask, taskToAffiliate);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(r.task)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!movedHome) &#123;</div><div class="line">			<span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">					(FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">					== (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">				<span class="comment">// Caller wants to appear on home activity, so before starting</span></div><div class="line">				<span class="comment">// their own activity we will bring home to the front.</span></div><div class="line">				r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> TaskRecord sourceTask = sourceRecord.task;</div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(sourceTask)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		targetStack = sourceTask.stack;</div><div class="line">		targetStack.moveToFront(<span class="string">"sourceStackToFront"</span>);</div><div class="line">		<span class="keyword">final</span> TaskRecord topTask = targetStack.topTask();</div><div class="line">		<span class="keyword">if</span> (topTask != sourceTask) &#123;</div><div class="line">			targetStack.moveTaskToFrontLocked(sourceTask, noAnimation, options,</div><div class="line">					r.appTimeTracker, <span class="string">"sourceTaskToFront"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!addingToTask &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// In this case, we are adding the activity to an existing</span></div><div class="line">			<span class="comment">// task, but the caller has asked to clear that task if the</span></div><div class="line">			<span class="comment">// activity is already running.</span></div><div class="line">			ActivityRecord top = sourceTask.performClearTaskLocked(r, launchFlags);</div><div class="line">			keepCurTransition = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, top.task);</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				<span class="comment">// For paranoia, make sure we have correctly</span></div><div class="line">				<span class="comment">// resumed the top activity.</span></div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (doResume) &#123;</div><div class="line">					targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">				ActivityOptions.abort(options);</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addingToTask &amp;&amp;</div><div class="line">				(launchFlags&amp;Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// In this case, we are launching an activity in our own task</span></div><div class="line">			<span class="comment">// that may already be running somewhere in the history, and</span></div><div class="line">			<span class="comment">// we want to shuffle it to the front of the stack if so.</span></div><div class="line">			<span class="keyword">final</span> ActivityRecord top = sourceTask.findActivityInHistoryLocked(r);</div><div class="line">			<span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> TaskRecord task = top.task;</div><div class="line">				task.moveActivityToFrontLocked(top);</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, r, task);</div><div class="line">				top.updateOptionsLocked(options);</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (doResume) &#123;</div><div class="line">					targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// An existing activity is starting this new activity, so we want</span></div><div class="line">		<span class="comment">// to keep the new one in the same task as the one that is starting</span></div><div class="line">		<span class="comment">// it.</span></div><div class="line">		r.setTask(sourceTask, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in existing task "</span> + r.task + <span class="string">" from source "</span> + sourceRecord);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The caller is asking that the new activity be started in an explicit</span></div><div class="line">		<span class="comment">// task it has provided to us.</span></div><div class="line">		<span class="keyword">if</span> (isLockTaskModeViolation(inTask)) &#123;</div><div class="line">			Slog.e(TAG, <span class="string">"Attempted Lock Task Mode violation r="</span> + r);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">		&#125;</div><div class="line">		targetStack = inTask.stack;</div><div class="line">		targetStack.moveTaskToFrontLocked(inTask, noAnimation, options, r.appTimeTracker,</div><div class="line">				<span class="string">"inTaskToFront"</span>);</div><div class="line"></div><div class="line">		<span class="comment">// Check whether we should actually launch the new activity in to the task,</span></div><div class="line">		<span class="comment">// or just reuse the current activity on top.</span></div><div class="line">		ActivityRecord top = inTask.getTopActivity();</div><div class="line">		<span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">			<span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">					|| launchSingleTop || launchSingleTask) &#123;</div><div class="line">				ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top, top.task);</div><div class="line">				<span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">					<span class="comment">// We don't need to start a new activity, and</span></div><div class="line">					<span class="comment">// the client said not to do anything if that</span></div><div class="line">					<span class="comment">// is the case, so this is it!</span></div><div class="line">					<span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">				&#125;</div><div class="line">				top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">				<span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!addingToTask) &#123;</div><div class="line">			<span class="comment">// We don't actually want to have this activity added to the task, so just</span></div><div class="line">			<span class="comment">// stop here but still tell the caller that we consumed the intent.</span></div><div class="line">			ActivityOptions.abort(options);</div><div class="line">			<span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		r.setTask(inTask, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in explicit task "</span> + r.task);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// This not being started from an existing activity, and not part</span></div><div class="line">		<span class="comment">// of a new task...  just put it in the top task, though these days</span></div><div class="line">		<span class="comment">// this case should never happen.</span></div><div class="line">		targetStack = computeStackFocus(r, newTask);</div><div class="line">		targetStack.moveToFront(<span class="string">"addingToTopTask"</span>);</div><div class="line">		ActivityRecord prev = targetStack.topActivity();</div><div class="line">		r.setTask(prev != <span class="keyword">null</span> ? prev.task : targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">						r.info, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>), <span class="keyword">null</span>);</div><div class="line">		mWindowManager.moveTaskToTop(r.task.taskId);</div><div class="line">		<span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">"Starting new activity "</span> + r</div><div class="line">				+ <span class="string">" in new guessed "</span> + r.task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</div><div class="line">			intent, r.getUriPermissionsLocked(), r.userId);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span> &amp;&amp; sourceRecord.isRecentsActivity()) &#123;</div><div class="line">		r.task.setTaskToReturnTo(RECENTS_ACTIVITY_TYPE);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (newTask) &#123;</div><div class="line">		EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, r.userId, r.task.taskId);</div><div class="line">	&#125;</div><div class="line">	ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task);</div><div class="line">	targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">	</div><div class="line">	<span class="comment">// 上面这部分代码很多，各种启动模式、栈的处理啊，我们就不继续看了，接着看下面的启动。</span></div><div class="line">	targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</div><div class="line">	<span class="keyword">if</span> (!launchTaskBehind) &#123;</div><div class="line">		<span class="comment">// Don't set focus on an activity that's going to the back.</span></div><div class="line">		mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>targetStack.startActivityLocked()</code>方法,这里<code>targetStack</code>就是<code>ActivityStack</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span></span></div><div class="line">		<span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options) &#123;</div><div class="line">	TaskRecord rTask = r.task;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</div><div class="line">	<span class="comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span></div><div class="line">	<span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</div><div class="line">		<span class="comment">// Last activity in task had been removed or ActivityManagerService is reusing task.</span></div><div class="line">		<span class="comment">// Insert or replace.</span></div><div class="line">		<span class="comment">// Might not even be in.</span></div><div class="line">		insertTaskAtTop(rTask, r);</div><div class="line">		mWindowManager.moveTaskToTop(taskId);</div><div class="line">	&#125;</div><div class="line">	TaskRecord task = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (!newTask) &#123;</div><div class="line">		<span class="comment">// If starting in an existing task, find where that is...</span></div><div class="line">		<span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</div><div class="line">			task = mTaskHistory.get(taskNdx);</div><div class="line">			<span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// All activities in task are finishing.</span></div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (task == r.task) &#123;</div><div class="line">				<span class="comment">// Here it is!  Now, if this is not yet visible to the</span></div><div class="line">				<span class="comment">// user, then just add it without starting; it will</span></div><div class="line">				<span class="comment">// get started when the user navigates back to it.</span></div><div class="line">				<span class="keyword">if</span> (!startIt) &#123;</div><div class="line">					<span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to task "</span></div><div class="line">							+ task, <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">					task.addActivityToTop(r);</div><div class="line">					r.putInHistory();</div><div class="line">					mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">							r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">							(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>,</div><div class="line">							r.userId, r.info.configChanges, task.voiceSession != <span class="keyword">null</span>,</div><div class="line">							r.mLaunchTaskBehind);</div><div class="line">					<span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">						validateAppTokensLocked();</div><div class="line">					&#125;</div><div class="line">					ActivityOptions.abort(options);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</div><div class="line">				startIt = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Place a new activity at top of stack, so it is next to interact</span></div><div class="line">	<span class="comment">// with the user.</span></div><div class="line"></div><div class="line">	<span class="comment">// If we are not placing the new activity frontmost, we do not want</span></div><div class="line">	<span class="comment">// to deliver the onUserLeaving callback to the actual frontmost</span></div><div class="line">	<span class="comment">// activity</span></div><div class="line">	<span class="keyword">if</span> (task == r.task &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</div><div class="line">		mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (DEBUG_USER_LEAVING) Slog.v(TAG_USER_LEAVING,</div><div class="line">				<span class="string">"startActivity() behind front, mUserLeaving=false"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	task = r.task;</div><div class="line"></div><div class="line">	<span class="comment">// Slot the activity into the history stack and proceed</span></div><div class="line">	<span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to stack to task "</span> + task,</div><div class="line">			<span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">	task.addActivityToTop(r);</div><div class="line">	task.setFrontOfTask();</div><div class="line"></div><div class="line">	r.putInHistory();</div><div class="line">	<span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// We want to show the starting preview window if we are</span></div><div class="line">		<span class="comment">// switching to a new task, or the next activity's process is</span></div><div class="line">		<span class="comment">// not currently running.</span></div><div class="line">		<span class="keyword">boolean</span> showStartingIcon = newTask;</div><div class="line">		ProcessRecord proc = r.app;</div><div class="line">		<span class="keyword">if</span> (proc == <span class="keyword">null</span>) &#123;</div><div class="line">			proc = mService.mProcessNames.get(r.processName, r.info.applicationInfo.uid);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.thread == <span class="keyword">null</span>) &#123;</div><div class="line">			showStartingIcon = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</div><div class="line">				<span class="string">"Prepare open transition: starting "</span> + r);</div><div class="line">		<span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</div><div class="line">			mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, keepCurTransition);</div><div class="line">			mNoAnimActivities.add(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mWindowManager.prepareAppTransition(newTask</div><div class="line">					? r.mLaunchTaskBehind</div><div class="line">							? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">							: AppTransition.TRANSIT_TASK_OPEN</div><div class="line">					: AppTransition.TRANSIT_ACTIVITY_OPEN, keepCurTransition);</div><div class="line">			mNoAnimActivities.remove(r);</div><div class="line">		&#125;</div><div class="line">		mWindowManager.addAppToken(task.mActivities.indexOf(r),</div><div class="line">				r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">				(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">				r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">		<span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">if</span> (newTask) &#123;</div><div class="line">			<span class="comment">// Even though this activity is starting fresh, we still need</span></div><div class="line">			<span class="comment">// to reset it to make sure we apply affinities to move any</span></div><div class="line">			<span class="comment">// existing activities from other tasks in to it.</span></div><div class="line">			<span class="comment">// If the caller has requested that the target task be</span></div><div class="line">			<span class="comment">// reset, then do so.</span></div><div class="line">			<span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">				resetTaskIfNeededLocked(r, r);</div><div class="line">				doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</div><div class="line">				== ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</div><div class="line">			doShow = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</div><div class="line">			<span class="comment">// Don't do a starting window for mLaunchTaskBehind. More importantly make sure we</span></div><div class="line">			<span class="comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span></div><div class="line">			mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line">			ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</div><div class="line">			<span class="comment">// Figure out if we are transitioning from another activity that is</span></div><div class="line">			<span class="comment">// "has the same starting icon" as the next one.  This allows the</span></div><div class="line">			<span class="comment">// window manager to keep the previous window it had previously</span></div><div class="line">			<span class="comment">// created, if it still had one.</span></div><div class="line">			ActivityRecord prev = mResumedActivity;</div><div class="line">			<span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// We don't want to reuse the previous starting preview if:</span></div><div class="line">				<span class="comment">// (1) The current activity is in a different task.</span></div><div class="line">				<span class="keyword">if</span> (prev.task != r.task) &#123;</div><div class="line">					prev = <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// (2) The current activity is already displayed.</span></div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</div><div class="line">					prev = <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			mWindowManager.setAppStartingWindow(</div><div class="line">					r.appToken, r.packageName, r.theme,</div><div class="line">					mService.compatibilityInfoForPackageLocked(</div><div class="line">							r.info.applicationInfo), r.nonLocalizedLabel,</div><div class="line">					r.labelRes, r.icon, r.logo, r.windowFlags,</div><div class="line">					prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</div><div class="line">			r.mStartingWindowShown = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// If this is the first activity, don't do any fancy animations,</span></div><div class="line">		<span class="comment">// because there is nothing for it to animate on top of.</span></div><div class="line">		mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">				r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">				(r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">				r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">		ActivityOptions.abort(options);</div><div class="line">		options = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</div><div class="line">		validateAppTokensLocked();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (doResume) &#123;</div><div class="line">		mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 在Android应用程序框架层中，是由ActivityManagerService组件负责为Android应用程序创建新的进程的，它本来也是运行在一个独立的进程之中，不过这个进程是在系统启动的过程中创建的。<br> ActivityManagerService组件一般会在什么情况下会为应用程序创建一个新的进程呢？当系统决定要在一个新的进程中启动一个Activity或者Service时，它就会创建一个新的进程了，<br> 然后在这个新的进程中启动这个Activity或者Service</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Activity启动过程/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Zipalign优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Zipalign优化/">Zipalign优化</a>
    </h1>
  

        
        <a href="/2015/01/01/Zipalign优化/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Zipalign优化"><a href="#Zipalign优化" class="headerlink" title="Zipalign优化"></a>Zipalign优化</h1><p><code>Zipalign</code>优化工具是<code>SDK</code>中自带的优化工具,在<code>android-sdk-windows\build-tools\23.0.1</code>，在我们上传<code>Google Pay</code>的时候都会遇到您上传的<code>Apk</code>没有经过<code>Zipalign</code>处理<br>的失败提示，就是说如果你的<code>apk</code>没有使用<code>zipalign</code>优化，那<code>google play</code>是拒绝给你上架的，从这里能看出<code>zipalign</code>优化是多么滴重要。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">zipalign is an archive alignment tool that provides important optimization to Android application (.apk) files. </div><div class="line">The purpose is to ensure that all uncompressed data starts with a particular alignment relative to the start of the file. </div><div class="line">Specifically, it causes all uncompressed data within the .apk, such as images or raw files, to be aligned on 4-byte boundaries. </div><div class="line">This allows all portions to be accessed directly with mmap() even if they contain binary data with alignment restrictions. </div><div class="line">The benefit is a reduction in the amount of RAM consumed when running the application.</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Caution: zipalign must only be performed after the .apk file has been signed with your private key. </div><div class="line">If you perform zipalign before signing, then the signing procedure will undo the alignment. </div><div class="line">Also, do not make alterations to the aligned package. </div><div class="line">Alterations to the archive, such as renaming or deleting entries, </div><div class="line">will potentially disrupt the alignment of the modified entry and all later entries. </div><div class="line">And any files added to an &quot;aligned&quot; archive will not be aligned.</div></pre></td></tr></table></figure>
<p>大意就是它提供了一个灰常重要滴功能来确保所有未压缩的数据都从文件的开始位置以指定的4字节对齐方式排列，例如图片或者<br><code>raw</code>文件。当然好处也是大大的，就是能够减少内存的资源消耗。最后他还特意提醒了你一下就是已经在对<code>apk</code>签完名之后再用<code>zipalign</code><br>优化，如果你在之前用，那无效。</p>
<p>废多看用法:      </p>
<ul>
<li><p>首先我要检查下我的<code>apk</code>到底用没用过<code>zipalign</code>优化呢?<br>  <code>zipalign -c -v 4 test.apk</code><br>  这个4是神马呢？就是４个字节的队列方式<br>  命令一顿执行，然后打出来了<code>Verification failed</code>，我不想再解释了。</p>
</li>
<li><p>如何使用?<br><code>zipalign -f -v 4 test.apk zip.apk</code><br>就是把当前的<code>test.apk</code>使用<code>zipalign</code>优化，优化完成后的是<code>zip.apk</code></p>
</li>
</ul>
<p>Flag:     </p>
<ul>
<li>-f : overwrite existing outfile.zip</li>
<li>-v : verbose output</li>
<li>-c : confirm the alignment of the given file</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Zipalign优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-View绘制过程详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/View绘制过程详解/">View绘制过程详解</a>
    </h1>
  

        
        <a href="/2015/01/01/View绘制过程详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="View绘制过程详解"><a href="#View绘制过程详解" class="headerlink" title="View绘制过程详解"></a>View绘制过程详解</h1><p>界面窗口的根布局是<code>DecorView</code>，该类继承自<code>FrameLayout</code>.说到<code>View</code>绘制，想到的就是从这里入手，而<code>FrameLayout</code>继承自<code>ViewGroup</code>。感觉绘制肯定会在<code>ViewGroup</code>或者<code>View</code>中，<br>但是木有找到。发现<code>ViewGroup</code>实现<code>ViewParent</code>接口，而<code>ViewParent</code>有一个实现类是<code>ViewRootImpl</code>， <code>ViewGruop</code>中会使用<code>ViewRootImpl</code>…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The top of a view hierarchy, implementing the needed protocol between View</div><div class="line"> * and the WindowManager.  This is for the most part an internal implementation</div><div class="line"> * detail of &#123;<span class="doctag">@link</span> WindowManagerGlobal&#125;.</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"EmptyCatchBlock"</span>, <span class="string">"PointlessBooleanExpression"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></div><div class="line">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">HardwareRenderer</span>.<span class="title">HardwareDrawCallbacks</span> &#123;</div><div class="line">		</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p><code>View</code>的绘制过程从<code>ViewRootImpl.performTraversals()</code>方法开始。<br>首先先说明一下，这部分代码比较多，逻辑也比较麻烦，很容易弄晕，如果感觉看起来费劲，就跳过这一块，直接到下面的Measure、Layout、Draw部分开始看。<br>我也没有全部弄清楚，我只是把里面的步骤标注了下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// ... 此处省略源代码N行</span></div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Measure</span></div><div class="line">	<span class="keyword">if</span> (!mStopped) &#123;</div><div class="line">		<span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</div><div class="line">				(relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</div><div class="line">		<span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</div><div class="line">				|| mHeight != host.getMeasuredHeight() || contentInsetsChanged) &#123;</div><div class="line">			<span class="comment">// 这里是获取widthMeasureSpec,这俩参数不是一般的尺寸数值，而是将模式和尺寸组合在一起的数值.</span></div><div class="line">			<span class="comment">// getRootMeasureSpec方法内部会使用MeasureSpec.makeMeasureSpec()方法来组装一个MeasureSpec，</span></div><div class="line">			<span class="comment">// 当lp.width参数等于MATCH_PARENT的时候，MeasureSpec的specMode就等于EXACTLY，当lp.width等于WRAP_CONTENT的时候，MeasureSpec的specMode就等于AT_MOST。</span></div><div class="line">			<span class="comment">// 并且MATCH_PARENT和WRAP_CONTENT时的specSize都是等于windowSize的，也就意味着根视图总是会充满全屏的。</span></div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG, <span class="string">"Ooops, something changed!  mWidth="</span></div><div class="line">					+ mWidth + <span class="string">" measuredWidth="</span> + host.getMeasuredWidth()</div><div class="line">					+ <span class="string">" mHeight="</span> + mHeight</div><div class="line">					+ <span class="string">" measuredHeight="</span> + host.getMeasuredHeight()</div><div class="line">					+ <span class="string">" coveredInsetsChanged="</span> + contentInsetsChanged);</div><div class="line">			</div><div class="line">			<span class="comment">// 调用PerformMeasure方法。</span></div><div class="line">			 <span class="comment">// Ask host how big it wants to be</span></div><div class="line">			performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">			<span class="comment">// Implementation of weights from WindowManager.LayoutParams</span></div><div class="line">			<span class="comment">// We just grow the dimensions as needed and re-measure if</span></div><div class="line">			<span class="comment">// needs be</span></div><div class="line">			<span class="keyword">int</span> width = host.getMeasuredWidth();</div><div class="line">			<span class="keyword">int</span> height = host.getMeasuredHeight();</div><div class="line">			<span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (measureAgain) &#123;</div><div class="line">				<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG,</div><div class="line">						<span class="string">"And hey let's measure once more: width="</span> + width</div><div class="line">						+ <span class="string">" height="</span> + height);</div><div class="line">				performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			layoutRequested = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; !mStopped;</div><div class="line">	<span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</div><div class="line">			|| mAttachInfo.mRecomputeGlobalAttributes;</div><div class="line">	<span class="comment">// 是否需要Layout</span></div><div class="line">	<span class="keyword">if</span> (didLayout) &#123;</div><div class="line">		<span class="comment">// 调用performLayout方法。</span></div><div class="line">		performLayout(lp, desiredWindowWidth, desiredWindowHeight);</div><div class="line"></div><div class="line">		<span class="comment">// By this point all views have been sized and positioned</span></div><div class="line">		<span class="comment">// We can compute the transparent area</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span> ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// start out transparent</span></div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> AVOID THAT CALL BY CACHING THE RESULT?</span></div><div class="line">			host.getLocationInWindow(mTmpLocation);</div><div class="line">			mTransparentRegion.set(mTmpLocation[<span class="number">0</span>], mTmpLocation[<span class="number">1</span>],</div><div class="line">					mTmpLocation[<span class="number">0</span>] + host.mRight - host.mLeft,</div><div class="line">					mTmpLocation[<span class="number">1</span>] + host.mBottom - host.mTop);</div><div class="line"></div><div class="line">			host.gatherTransparentRegion(mTransparentRegion);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</div><div class="line">				mPreviousTransparentRegion.set(mTransparentRegion);</div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				<span class="comment">// reconfigure window manager</span></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</div><div class="line">				&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DBG) &#123;</div><div class="line">			System.out.println(<span class="string">"======================================"</span>);</div><div class="line">			System.out.println(<span class="string">"performTraversals -- after setFrame"</span>);</div><div class="line">			host.debug();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Draw</span></div><div class="line">	<span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</div><div class="line">		<span class="keyword">if</span> (!skipDraw || mReportNextDraw) &#123;</div><div class="line">			<span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">					mPendingTransitions.get(i).startChangingAnimations();</div><div class="line">				&#125;</div><div class="line">				mPendingTransitions.clear();</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 调用performDraw方法</span></div><div class="line">			performDraw();</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (viewVisibility == View.VISIBLE) &#123;</div><div class="line">			<span class="comment">// Try again</span></div><div class="line">			scheduleTraversals();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">				mPendingTransitions.get(i).endChangingAnimations();</div><div class="line">			&#125;</div><div class="line">			mPendingTransitions.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mIsInTraversal = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面源码可以看出,<code>performTraversals()</code>方法中会依次做三件事：</p>
<ul>
<li><code>performMeasure()</code>, 内部是<code>mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</code>测量<code>View</code>大小。这里顺便提一下，这个<code>mView</code>是什么？它就是<code>Window</code>最顶成的<code>View(DecorView)</code>,它是<code>FrameLayout</code>的子类。</li>
<li><code>performLayout()</code>, 内部是<code>mView.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</code>视图布局，确定<code>View</code>位置。</li>
<li><code>performDraw()</code>, 内部是<code>draw(fullRedrawNeeded);</code> 绘制界面。</li>
</ul>
<p>至此<code>View</code>绘制的三个过程已经展现：</p>
<h1 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a><code>Measure</code></h1><p><code>performMeasure</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>performMeasure()</code>方法中会调用<code>View.measure()</code>方法， 源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is called to find out how big a view should be. The parent</div><div class="line"> * supplies constraint information in the width and height parameters.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The actual measurement work of a view is performed in</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> oWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> oHeight = insets.top  + insets.bottom;</div><div class="line">		widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</div><div class="line">		heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Suppress sign extension for the low bytes</span></div><div class="line">	<span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</div><div class="line">	<span class="keyword">if</span> (mMeasureCache == <span class="keyword">null</span>) mMeasureCache = <span class="keyword">new</span> LongSparseLongArray(<span class="number">2</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</div><div class="line">			widthMeasureSpec != mOldWidthMeasureSpec ||</div><div class="line">			heightMeasureSpec != mOldHeightMeasureSpec) &#123;</div><div class="line"></div><div class="line">		<span class="comment">// first clears the measured dimension flag</span></div><div class="line">		mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">		resolveRtlPropertiesIfNeeded();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</div><div class="line">				mMeasureCache.indexOfKey(key);</div><div class="line">		<span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</div><div class="line">			<span class="comment">// 调用onMeasure方法</span></div><div class="line">			<span class="comment">// measure ourselves, this should set the measured dimension flag back</span></div><div class="line">			onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">			mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">			<span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></div><div class="line">			setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</div><div class="line">			mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// flag not set, setMeasuredDimension() was not invoked, we raise</span></div><div class="line">		<span class="comment">// an exception to warn the developer</span></div><div class="line">		<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">			<span class="comment">// 重写onMeausre方法的时，必须调用setMeasuredDimension或者super.onMeasure方法，不然就会走到这里报错。</span></div><div class="line">			<span class="comment">// setMeasuredDimension中回去改变mPrivateFlags的值</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"onMeasure() did not set the"</span></div><div class="line">					+ <span class="string">" measured dimension by calling"</span></div><div class="line">					+ <span class="string">" setMeasuredDimension()"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">	mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">	mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</div><div class="line">			(<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>measure</code>方法中会调用<code>onMeasure</code>方法。<code>ViewGroup</code>的子类会重写该方法来进行测量大小，因为<code>mView</code>是<code>DecorView</code>，<br>而<code>DecorView</code>是<code>FrameLayout</code>的子类。所以我们看一下<code>FrameLayout.onMeasure</code>方法：<br><code>FrameLayout.onMeasure</code>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> measureMatchParentChildren =</div><div class="line">			MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">			MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">	mMatchParentChildren.clear();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="comment">// 调用该方法去测量每个子View</span></div><div class="line">			measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">			maxWidth = Math.max(maxWidth,</div><div class="line">					child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">			maxHeight = Math.max(maxHeight,</div><div class="line">					child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">			childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">			<span class="keyword">if</span> (measureMatchParentChildren) &#123;</div><div class="line">				<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">						lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">					mMatchParentChildren.add(child);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Account for padding too</span></div><div class="line">	maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">	maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	<span class="comment">// Check against our minimum height and width</span></div><div class="line">	maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">	maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">	<span class="comment">// Check against our foreground's minimum height and width</span></div><div class="line">	<span class="keyword">final</span> Drawable drawable = getForeground();</div><div class="line">	<span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</div><div class="line">		maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">		maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">			resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">					childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line"></div><div class="line">	count = mMatchParentChildren.size();</div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = mMatchParentChildren.get(i);</div><div class="line"></div><div class="line">			<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec;</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredWidth() -</div><div class="line">						getPaddingLeftWithForeground() - getPaddingRightWithForeground() -</div><div class="line">						lp.leftMargin - lp.rightMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">						getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">						lp.leftMargin + lp.rightMargin,</div><div class="line">						lp.width);</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredHeight() -</div><div class="line">						getPaddingTopWithForeground() - getPaddingBottomWithForeground() -</div><div class="line">						lp.topMargin - lp.bottomMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">						getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">						lp.topMargin + lp.bottomMargin,</div><div class="line">						lp.height);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到内部会调用<code>measureChildWithMargins()</code>方法,该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Ask one of the children of this view to measure itself, taking into</div><div class="line"> * account both the MeasureSpec requirements for this view and its padding</div><div class="line"> * and margins. The child must have MarginLayoutParams The heavy lifting is</div><div class="line"> * done in getChildMeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The child to measure</div><div class="line"> * <span class="doctag">@param</span> parentWidthMeasureSpec The width requirements for this view</div><div class="line"> * <span class="doctag">@param</span> widthUsed Extra space that has been used up by the parent</div><div class="line"> *        horizontally (possibly by other children of the parent)</div><div class="line"> * <span class="doctag">@param</span> parentHeightMeasureSpec The height requirements for this view</div><div class="line"> * <span class="doctag">@param</span> heightUsed Extra space that has been used up by the parent</div><div class="line"> *        vertically (possibly by other children of the parent)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">		<span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">		<span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">	<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">			mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">					+ widthUsed, lp.width);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">			mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">					+ heightUsed, lp.height);</div><div class="line"></div><div class="line">	child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面就是对该子<code>View</code>调用了<code>measure</code>方法，我们假设这个<code>View</code>已经不是<code>ViewGroup</code>了，就会又和上面一样，又调用<code>onMeasure</code>方法，<br>下面我们直接看一下<code>View.onMeasure()</code>方法：<br><code>View.onMeasure()</code>方法的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line"> * should be overriden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass's responsibility to make</div><div class="line"> * sure the measured height and width are at least the view's minimum height</div><div class="line"> * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line"> * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="comment">// 如果不重写onMeasure方法，默认会调用getDefaultSize获取大小，下面会说getDefaultSize这个方法。</span></div><div class="line">	setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">			getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimension()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;This method must be called by &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to store the</div><div class="line"> * measured width and measured height. Failing to do so will trigger an</div><div class="line"> * exception at measurement time.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">		measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">		measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">	&#125;</div><div class="line">	setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimensionRaw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets the measured dimension without extra processing for things like optical bounds.</div><div class="line"> * Useful for reapplying consistent values that have already been cooked with adjustments</div><div class="line"> * for optical bounds, etc. such as those from the measurement cache.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="comment">// 赋值给mMeasuredWidth，getMeasuredWidth就会调用该值。</span></div><div class="line">	mMeasuredWidth = measuredWidth;</div><div class="line">	mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">	<span class="comment">// 这就是重写onMeasure方法时如果不调用setMeasuredDimension方法时为什么会报错的原因。</span></div><div class="line">	mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们接着看一下上面用到的<code>getDefaultSize()</code>方法，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size Default size for this view</div><div class="line"> * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line"> * <span class="doctag">@return</span> The size this view should be.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> result = size;</div><div class="line">	<span class="comment">// measureSpec值用于获取宽度(高度)的规格和大小，解析出对应的size和mode</span></div><div class="line">	<span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">	<span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (specMode) &#123;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">		result = size;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">	<span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">		result = specSize;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>getDefaultSize</code>方法又会使用到<code>MeasureSpec</code>类，文档中对<code>MeasureSpec</code>是这样介绍的<code>A MeasureSpec is comprised of a size and a mode. There are three possible modes:</code></p>
<ul>
<li>MeasureSpec.EXACTLY The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.<br>  理解成MATCH_PARENT或者在布局中指定了宽高值，如layout:width=’50dp’</li>
<li>MeasureSpec.AT_MOST The child can be as large as it wants up to the specified size.理解成WRAP_CONTENT,这是的值是父View可以允许的最大的值，只要不超过这个值都可以。</li>
<li>MeasureSpec.UNSPECIFIED The parent has not imposed any constraint on the child. It can be whatever size it wants. 这种情况比较少，一般用不到。</li>
</ul>
<p>这里简单总结一下上面的过程:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">performMeasure() &#123;</div><div class="line">	- <span class="number">1</span>.调用View.measure方法</div><div class="line">	mView.measure():</div><div class="line">		- <span class="number">2</span>.measure内部会调用onMeasure方法,但是因为这里mView是DecorView，所以会调用FrameLayout的onMeasure方法。</div><div class="line">	        onMeasure(FrameLayout)</div><div class="line">			- <span class="number">3</span>. 内部设置ViewGroup的宽高</div><div class="line">				setMeasuredDimension</div><div class="line">				并且对每个子View进行遍历测量</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					- <span class="number">4</span>. 对每个子View调用measureChildWithMargins方法</div><div class="line">					measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);	</div><div class="line">					    -<span class="number">5</span>. measureChildWithMargins内部调用子View的measure方法</div><div class="line">					        meausre</div><div class="line">							- <span class="number">6</span>. measure方法内部又调用onMeasure方法</div><div class="line">					            onMeasure(View)</div><div class="line">					            - <span class="number">7</span>. onMeasure方法内部调用setMeasuredDimension</div><div class="line">									setMeasuredDimension</div><div class="line">									- <span class="number">8</span>. setMeasuredDimension内部调用setMeasuredDimensionRaw</div><div class="line">									    setMeasuredDimensionRaw</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码中能看到<code>measure</code>是<code>final</code>的，我们可以重写<code>onMeasure</code>来实现<code>measure</code>过程。<br>到这里基本都讲完了，我们在开发中会按照需要重写<code>onMeasure</code>方法，然后调用<code>setMeasuredDimension</code>方法设置大小，<br>ps:譬如我们设置了<code>setMeasuredDimension(10, 10)</code>,那么不管布局中怎么设置这个<code>View</code>的大小<br>都是没用的，最后显示出来大小都是10*10。</p>
<h1 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a><code>Layout</code></h1><p><code>performLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	mLayoutRequested = <span class="keyword">false</span>;</div><div class="line">	mScrollMayChange = <span class="keyword">true</span>;</div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> View host = mView;</div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_LAYOUT) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Laying out "</span> + host + <span class="string">" to ("</span> +</div><div class="line">				host.getMeasuredWidth() + <span class="string">", "</span> + host.getMeasuredHeight() + <span class="string">")"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"layout"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 把刚才测量的宽高设置进来</span></div><div class="line">		host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">		mInLayout = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">		<span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// requestLayout() was called during layout.</span></div><div class="line">			<span class="comment">// If no layout-request flags are set on the requesting views, there is no problem.</span></div><div class="line">			<span class="comment">// If some requests are still pending, then we need to clear those flags and do</span></div><div class="line">			<span class="comment">// a full request/measure/layout pass to handle this situation.</span></div><div class="line">			ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">					<span class="keyword">false</span>);</div><div class="line">			<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Set this flag to indicate that any further requests are happening during</span></div><div class="line">				<span class="comment">// the second pass, which may result in posting those requests to the next</span></div><div class="line">				<span class="comment">// frame instead</span></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Process fresh layout requests, then measure and layout</span></div><div class="line">				<span class="keyword">int</span> numValidRequests = validLayoutRequesters.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">					<span class="keyword">final</span> View view = validLayoutRequesters.get(i);</div><div class="line">					Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">							<span class="string">" during layout: running second layout pass"</span>);</div><div class="line">					view.requestLayout();</div><div class="line">				&#125;</div><div class="line">				measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">						desiredWindowWidth, desiredWindowHeight);</div><div class="line">				mInLayout = <span class="keyword">true</span>;</div><div class="line">				host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Check the valid requests again, this time without checking/clearing the</span></div><div class="line">				<span class="comment">// layout flags, since requests happening during the second pass get noop'd</span></div><div class="line">				validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">					<span class="comment">// Post second-pass requests to the next frame</span></div><div class="line">					getRunQueue().post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">						<span class="meta">@Override</span></div><div class="line">						<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">							<span class="keyword">int</span> numValidRequests = finalRequesters.size();</div><div class="line">							<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">								<span class="keyword">final</span> View view = finalRequesters.get(i);</div><div class="line">								Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">										<span class="string">" during second layout pass: posting in next frame"</span>);</div><div class="line">								view.requestLayout();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>layout()</code>方法，因为<code>host</code>是<code>mView</code>，<code>ViewGroup</code>中重写了<code>layout</code>方法，并调用了<code>super.layout</code>.<br>所以我们直接看<code>View.layout()</code>方法，该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Assign a size and position to a view and all of its</div><div class="line"> * descendants</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line"> * (The first is measuring). In this phase, each parent calls</div><div class="line"> * layout on all of its children to position them.</div><div class="line"> * This is typically done using the child measurements</div><div class="line"> * that were stored in the measure pass().&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Derived classes should not override this method.</div><div class="line"> * Derived classes with children should override</div><div class="line"> * onLayout. In that method, they should</div><div class="line"> * call layout on each of their children.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> t Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> r Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> b Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">		onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">		mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> oldL = mLeft;</div><div class="line">	<span class="keyword">int</span> oldT = mTop;</div><div class="line">	<span class="keyword">int</span> oldB = mBottom;</div><div class="line">	<span class="keyword">int</span> oldR = mRight;</div><div class="line"></div><div class="line">	<span class="comment">// 这部分是判断这个View的大小是否已经发生了变化，来判断是否需要重绘。</span></div><div class="line">	<span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">			setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">		<span class="comment">// 内部调用onLayout方法</span></div><div class="line">		onLayout(changed, l, t, r, b);</div><div class="line">		mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">			ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">					(ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">			<span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">				listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">	mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里会调用<code>onLayout</code>方法，同样因为<code>mView</code>是<code>FrameLayout</code>的子类，所以我们要看<code>FrameLayout</code>的<code>onLayout</code>方法，<br>这里我们先看一下<code>ViewGroup.onLayout</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></div><div class="line">		<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b);</div></pre></td></tr></table></figure></p>
<p>是个抽象方法，所以<code>ViewGroup</code>的子类都需要实现该方法。<br>我们看一下<code>FrameLayout.onLayout</code>方法,源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">	layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">							  <span class="keyword">boolean</span> forceLeftGravity) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	mForegroundBoundsChanged = <span class="keyword">true</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</div><div class="line"></div><div class="line">			<span class="keyword">int</span> childLeft;</div><div class="line">			<span class="keyword">int</span> childTop;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">			<span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</div><div class="line">				gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">					childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</div><div class="line">					lp.leftMargin - lp.rightMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">					<span class="keyword">if</span> (!forceLeftGravity) &#123;</div><div class="line">						childLeft = parentRight - width - lp.rightMargin;</div><div class="line">						<span class="keyword">break</span>;</div><div class="line">					&#125;</div><div class="line">				<span class="keyword">case</span> Gravity.LEFT:</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childLeft = parentLeft + lp.leftMargin;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.TOP:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">					childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">					lp.topMargin - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">					childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//调用子View的layout方法</span></div><div class="line">			child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>View.layout</code>方法，又会调用到<code>View.onLayout</code>方法，我们假设这个子<code>View</code>不是<code>ViewGroup</code>.<br>看一下<code>View.onLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called from layout when this view should</div><div class="line"> * assign a size and position to each of its children.</div><div class="line"> *</div><div class="line"> * Derived classes with children should override</div><div class="line"> * this method and call layout on each of</div><div class="line"> * their children.</div><div class="line"> * <span class="doctag">@param</span> changed This is a new size or position for this view</div><div class="line"> * <span class="doctag">@param</span> left Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> top Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> right Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> bottom Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是一个空方法，这是因为<code>Layout</code>需要<code>ViewGroup</code>来控制进行。      </p>
<p>这里也总结一下<code>layout</code>的过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	- <span class="number">1</span>. host.layout</div><div class="line">	host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">		-<span class="number">2</span>. layout方法会分别调用setFrame()和onLayout()方法</div><div class="line">			setFrame()</div><div class="line">			onLayout()</div><div class="line">			-<span class="number">3</span>. 因为host是mView也就是DecorView也就是FrameLayout的子类。FrameLayout的onLayout方法如下</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">					    -<span class="number">4</span>. 遍历每个子View，并分别调用layout方法。</div><div class="line">						child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a><code>Draw</code></h1><p>绘制阶段是从<code>ViewRootImpl</code>中的<code>performDraw</code>方法开始的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">	mFullRedrawNeeded = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mIsDrawing = <span class="keyword">true</span>;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"draw"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 开始draw了</span></div><div class="line">		draw(fullRedrawNeeded);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		mIsDrawing = <span class="keyword">false</span>;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// For whatever reason we didn't create a HardwareRenderer, end any</span></div><div class="line">	<span class="comment">// hardware animations that are now dangling</span></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mPendingAnimatingRenderNodes != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mAttachInfo.mPendingAnimatingRenderNodes.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</div><div class="line">		&#125;</div><div class="line">		mAttachInfo.mPendingAnimatingRenderNodes.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mReportNextDraw) &#123;</div><div class="line">		mReportNextDraw = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span>) &#123;</div><div class="line">			mAttachInfo.mHardwareRenderer.fence();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"FINISHED DRAWING: "</span> + mWindowAttributes.getTitle());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span> &amp;&amp; mSurface.isValid()) &#123;</div><div class="line">			mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">			SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</div><div class="line">			<span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (SurfaceHolder.Callback c : callbacks) &#123;</div><div class="line">					<span class="keyword">if</span> (c <span class="keyword">instanceof</span> SurfaceHolder.Callback2) &#123;</div><div class="line">						((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(</div><div class="line">								mSurfaceHolder);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			mWindowSession.finishDrawing(mWindow);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>draw</code>方法，<code>draw</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</div><div class="line">	Surface surface = mSurface;</div><div class="line">	<span class="keyword">if</span> (!surface.isValid()) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_FPS) &#123;</div><div class="line">		trackFPS();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!sFirstDrawComplete) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (sFirstDrawHandlers) &#123;</div><div class="line">			sFirstDrawComplete = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = sFirstDrawHandlers.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; count; i++) &#123;</div><div class="line">				mHandler.post(sFirstDrawHandlers.get(i));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	scrollToRectOrFocus(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mViewScrollChanged) &#123;</div><div class="line">		mAttachInfo.mViewScrollChanged = <span class="keyword">false</span>;</div><div class="line">		mAttachInfo.mTreeObserver.dispatchOnScrollChanged();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> animating = mScroller != <span class="keyword">null</span> &amp;&amp; mScroller.computeScrollOffset();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> curScrollY;</div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		curScrollY = mScroller.getCurrY();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		curScrollY = mScrollY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mCurScrollY != curScrollY) &#123;</div><div class="line">		mCurScrollY = curScrollY;</div><div class="line">		fullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> appScale = mAttachInfo.mApplicationScale;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> scalingRequired = mAttachInfo.mScalingRequired;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> resizeAlpha = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mResizeBuffer != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">long</span> deltaTime = SystemClock.uptimeMillis() - mResizeBufferStartTime;</div><div class="line">		<span class="keyword">if</span> (deltaTime &lt; mResizeBufferDuration) &#123;</div><div class="line">			<span class="keyword">float</span> amt = deltaTime/(<span class="keyword">float</span>) mResizeBufferDuration;</div><div class="line">			amt = mResizeInterpolator.getInterpolation(amt);</div><div class="line">			animating = <span class="keyword">true</span>;</div><div class="line">			resizeAlpha = <span class="number">255</span> - (<span class="keyword">int</span>)(amt*<span class="number">255</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect dirty = mDirty;</div><div class="line">	<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The app owns the surface, we won't draw.</span></div><div class="line">		dirty.setEmpty();</div><div class="line">		<span class="keyword">if</span> (animating) &#123;</div><div class="line">			<span class="keyword">if</span> (mScroller != <span class="keyword">null</span>) &#123;</div><div class="line">				mScroller.abortAnimation();</div><div class="line">			&#125;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (fullRedrawNeeded) &#123;</div><div class="line">		mAttachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		dirty.set(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">int</span>) (mWidth * appScale + <span class="number">0.5f</span>), (<span class="keyword">int</span>) (mHeight * appScale + <span class="number">0.5f</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Draw "</span> + mView + <span class="string">"/"</span></div><div class="line">				+ mWindowAttributes.getTitle()</div><div class="line">				+ <span class="string">": dirty=&#123;"</span> + dirty.left + <span class="string">","</span> + dirty.top</div><div class="line">				+ <span class="string">","</span> + dirty.right + <span class="string">","</span> + dirty.bottom + <span class="string">"&#125; surface="</span></div><div class="line">				+ surface + <span class="string">" surface.isValid()="</span> + surface.isValid() + <span class="string">", appScale:"</span> +</div><div class="line">				appScale + <span class="string">", width="</span> + mWidth + <span class="string">", height="</span> + mHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mAttachInfo.mTreeObserver.dispatchOnDraw();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> xOffset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> yOffset = curScrollY;</div><div class="line">	<span class="keyword">final</span> WindowManager.LayoutParams params = mWindowAttributes;</div><div class="line">	<span class="keyword">final</span> Rect surfaceInsets = params != <span class="keyword">null</span> ? params.surfaceInsets : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (surfaceInsets != <span class="keyword">null</span>) &#123;</div><div class="line">		xOffset -= surfaceInsets.left;</div><div class="line">		yOffset -= surfaceInsets.top;</div><div class="line"></div><div class="line">		<span class="comment">// Offset dirty rect for surface insets.</span></div><div class="line">		dirty.offset(surfaceInsets.left, surfaceInsets.right);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating) &#123;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</div><div class="line">			<span class="comment">// Draw with hardware renderer.</span></div><div class="line">			mIsAnimating = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">boolean</span> invalidateRoot = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</div><div class="line">				mHardwareYOffset = yOffset;</div><div class="line">				mHardwareXOffset = xOffset;</div><div class="line">				mAttachInfo.mHardwareRenderer.invalidateRoot();</div><div class="line">			&#125;</div><div class="line">			mResizeAlpha = resizeAlpha;</div><div class="line"></div><div class="line">			dirty.setEmpty();</div><div class="line"></div><div class="line">			mBlockResizeBuffer = <span class="keyword">false</span>;</div><div class="line">			mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// If we get here with a disabled &amp; requested hardware renderer, something went</span></div><div class="line">			<span class="comment">// wrong (an invalidate posted right before we destroyed the hardware surface</span></div><div class="line">			<span class="comment">// for instance) so we should just bail out. Locking the surface with software</span></div><div class="line">			<span class="comment">// rendering at this point would lock it forever and prevent hardware renderer</span></div><div class="line">			<span class="comment">// from doing its job when it comes back.</span></div><div class="line">			<span class="comment">// Before we request a new frame we must however attempt to reinitiliaze the</span></div><div class="line">			<span class="comment">// hardware renderer if it's in requested state. This would happen after an</span></div><div class="line">			<span class="comment">// eglTerminate() for instance.</span></div><div class="line">			<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp;</div><div class="line">					!mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</div><div class="line">					mAttachInfo.mHardwareRenderer.isRequested()) &#123;</div><div class="line"></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mAttachInfo.mHardwareRenderer.initializeIfNeeded(</div><div class="line">							mWidth, mHeight, mSurface, surfaceInsets);</div><div class="line">				&#125; <span class="keyword">catch</span> (OutOfResourcesException e) &#123;</div><div class="line">					handleOutOfResourcesException(e);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				scheduleTraversals();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="comment">// draw的部分在这里。。。内部会用canvas去画</span></div><div class="line">			<span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">		scheduleTraversals();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>drawSoftware</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@return</span> true if drawing was successful, false if an error occurred</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></div><div class="line">		<span class="keyword">boolean</span> scalingRequired, Rect dirty) &#123;</div><div class="line"></div><div class="line">	<span class="comment">// Draw with software renderer.</span></div><div class="line">	<span class="keyword">final</span> Canvas canvas;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> left = dirty.left;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> top = dirty.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> right = dirty.right;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> bottom = dirty.bottom;</div><div class="line"></div><div class="line">		canvas = mSurface.lockCanvas(dirty);</div><div class="line"></div><div class="line">		<span class="comment">// The dirty rectangle can be modified by Surface.lockCanvas()</span></div><div class="line">		<span class="comment">//noinspection ConstantConditions</span></div><div class="line">		<span class="keyword">if</span> (left != dirty.left || top != dirty.top || right != dirty.right</div><div class="line">				|| bottom != dirty.bottom) &#123;</div><div class="line">			attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> Do this in native</span></div><div class="line">		canvas.setDensity(mDensity);</div><div class="line">	&#125; <span class="keyword">catch</span> (Surface.OutOfResourcesException e) &#123;</div><div class="line">		handleOutOfResourcesException(e);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">		Log.e(TAG, <span class="string">"Could not lock surface"</span>, e);</div><div class="line">		<span class="comment">// Don't assume this is due to out of memory, it could be</span></div><div class="line">		<span class="comment">// something else, and if it is something else then we could</span></div><div class="line">		<span class="comment">// kill stuff (or ourself) for no reason.</span></div><div class="line">		mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" drawing to bitmap w="</span></div><div class="line">					+ canvas.getWidth() + <span class="string">", h="</span> + canvas.getHeight());</div><div class="line">			<span class="comment">//canvas.drawARGB(255, 255, 0, 0);</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// If this bitmap's format includes an alpha channel, we</span></div><div class="line">		<span class="comment">// need to clear it before drawing so that the child will</span></div><div class="line">		<span class="comment">// properly re-composite its drawing on a transparent</span></div><div class="line">		<span class="comment">// background. This automatically respects the clip/dirty region</span></div><div class="line">		<span class="comment">// or</span></div><div class="line">		<span class="comment">// If we are applying an offset, we need to clear the area</span></div><div class="line">		<span class="comment">// where the offset doesn't appear to avoid having garbage</span></div><div class="line">		<span class="comment">// left in the blank areas.</span></div><div class="line">		<span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</div><div class="line">			canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		dirty.setEmpty();</div><div class="line">		mIsAnimating = <span class="keyword">false</span>;</div><div class="line">		attachInfo.mDrawingTime = SystemClock.uptimeMillis();</div><div class="line">		mView.mPrivateFlags |= View.PFLAG_DRAWN;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DEBUG_DRAW) &#123;</div><div class="line">			Context cxt = mView.getContext();</div><div class="line">			Log.i(TAG, <span class="string">"Drawing: package:"</span> + cxt.getPackageName() +</div><div class="line">					<span class="string">", metrics="</span> + cxt.getResources().getDisplayMetrics() +</div><div class="line">					<span class="string">", compatibilityInfo="</span> + cxt.getResources().getCompatibilityInfo());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			canvas.translate(-xoff, -yoff);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateCanvas(canvas);</div><div class="line">			&#125;</div><div class="line">			canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</div><div class="line">			attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			</div><div class="line">			<span class="comment">// 内部会去调用View.draw()；</span></div><div class="line">			mView.draw(canvas);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!attachInfo.mSetIgnoreDirtyState) &#123;</div><div class="line">				<span class="comment">// Only clear the flag if it was not set during the mView.draw() call</span></div><div class="line">				attachInfo.mIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			surface.unlockCanvasAndPost(canvas);</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">			Log.e(TAG, <span class="string">"Could not unlock surface"</span>, e);</div><div class="line">			mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">			<span class="comment">//noinspection ReturnInsideFinallyBlock</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" unlockCanvasAndPost"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码中调用了<code>mView.draw()</code>方法，所以我们看一下<code>FrameLayout.draw()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.draw(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mForeground != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> Drawable foreground = mForeground;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mForegroundBoundsChanged) &#123;</div><div class="line">			mForegroundBoundsChanged = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">final</span> Rect selfBounds = mSelfBounds;</div><div class="line">			<span class="keyword">final</span> Rect overlayBounds = mOverlayBounds;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> w = mRight-mLeft;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> h = mBottom-mTop;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mForegroundInPadding) &#123;</div><div class="line">				selfBounds.set(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				selfBounds.set(mPaddingLeft, mPaddingTop, w - mPaddingRight, h - mPaddingBottom);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			Gravity.apply(mForegroundGravity, foreground.getIntrinsicWidth(),</div><div class="line">					foreground.getIntrinsicHeight(), selfBounds, overlayBounds,</div><div class="line">					layoutDirection);</div><div class="line">			foreground.setBounds(overlayBounds);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		foreground.draw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部调用了<code>super.draw()</code>，而<code>ViewGroup</code>没有重写该方法，所以直接看<code>View</code>的<code>draw()</code>方法.<br><code>View.draw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Manually render this view (and all of its children) to the given Canvas.</div><div class="line"> * The view must have already done a full layout before this function is</div><div class="line"> * called.  When implementing a view, implement</div><div class="line"> * &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line"> * If you do need to override this method, call the superclass version.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The Canvas to which the View is rendered.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">			(mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">	mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">	<span class="comment">// 这里注释说的很明白了，draw的6个步骤。</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Draw traversal performs several drawing steps which must be executed</div><div class="line">	 * in the appropriate order:</div><div class="line">	 *</div><div class="line">	 *      1. Draw the background</div><div class="line">	 *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">	 *      3. Draw view's content, 调用onDraw方法绘制自身</div><div class="line">	 *      4. Draw children, 调用dispatchDraw方法绘制子View</div><div class="line">	 *      5. If necessary, draw the fading edges and restore layers</div><div class="line">	 *      6. Draw decorations (scrollbars for instance)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">	<span class="keyword">int</span> saveCount;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">		drawBackground(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">	<span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">		<span class="comment">// Step 3, draw the content</span></div><div class="line">		<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 4, draw the children</span></div><div class="line">		dispatchDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">		onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">			mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// we're done...</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Here we do the full fledged routine...</div><div class="line">	 * (this is an uncommon case where speed matters less,</div><div class="line">	 * this is why we repeat some of the tests that have been</div><div class="line">	 * done above)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> drawTop = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawBottom = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawLeft = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawRight = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> topFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> bottomFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> leftFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> rightFadeStrength = <span class="number">0.0f</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Step 2, save the canvas' layers</span></div><div class="line">	<span class="keyword">int</span> paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> offsetRequired = isPaddingOffsetRequired();</div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		paddingLeft += getLeftPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> left = mScrollX + paddingLeft;</div><div class="line">	<span class="keyword">int</span> right = left + mRight - mLeft - mPaddingRight - paddingLeft;</div><div class="line">	<span class="keyword">int</span> top = mScrollY + getFadeTop(offsetRequired);</div><div class="line">	<span class="keyword">int</span> bottom = top + getFadeHeight(offsetRequired);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		right += getRightPaddingOffset();</div><div class="line">		bottom += getBottomPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ScrollabilityCache scrollabilityCache = mScrollCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> fadeHeight = scrollabilityCache.fadingEdgeLength;</div><div class="line">	<span class="keyword">int</span> length = (<span class="keyword">int</span>) fadeHeight;</div><div class="line"></div><div class="line">	<span class="comment">// clip the fade length if top and bottom fades overlap</span></div><div class="line">	<span class="comment">// overlapping fades produce odd-looking artifacts</span></div><div class="line">	<span class="keyword">if</span> (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) &#123;</div><div class="line">		length = (bottom - top) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// also clip horizontal fades if necessary</span></div><div class="line">	<span class="keyword">if</span> (horizontalEdges &amp;&amp; (left + length &gt; right - length)) &#123;</div><div class="line">		length = (right - left) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (verticalEdges) &#123;</div><div class="line">		topFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getTopFadingEdgeStrength()));</div><div class="line">		drawTop = topFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		bottomFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getBottomFadingEdgeStrength()));</div><div class="line">		drawBottom = bottomFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (horizontalEdges) &#123;</div><div class="line">		leftFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getLeftFadingEdgeStrength()));</div><div class="line">		drawLeft = leftFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		rightFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getRightFadingEdgeStrength()));</div><div class="line">		drawRight = rightFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	saveCount = canvas.getSaveCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> solidColor = getSolidColor();</div><div class="line">	<span class="keyword">if</span> (solidColor == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">			canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">			canvas.saveLayer(left, bottom - length, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">			canvas.saveLayer(left, top, left + length, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">			canvas.saveLayer(right - length, top, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		scrollabilityCache.setFadeColor(solidColor);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Step 3, draw the content</span></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 4, draw the children</span></div><div class="line">	dispatchDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 5, draw the fade effect and restore layers</span></div><div class="line">	<span class="keyword">final</span> Paint p = scrollabilityCache.paint;</div><div class="line">	<span class="keyword">final</span> Matrix matrix = scrollabilityCache.matrix;</div><div class="line">	<span class="keyword">final</span> Shader fade = scrollabilityCache.shader;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, right, top + length, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * bottomFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">180</span>);</div><div class="line">		matrix.postTranslate(left, bottom);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, bottom - length, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * leftFadeStrength);</div><div class="line">		matrix.postRotate(-<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, left + length, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * rightFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(right, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(right - length, top, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	canvas.restoreToCount(saveCount);</div><div class="line"></div><div class="line">	<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">	onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">		mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面会调用<code>onDraw</code>和<code>dispatchDraw</code>方法。<br>我们先看一下<code>View.onDraw</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this to do your drawing.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas the canvas on which the background will be drawn</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是空方法，这是也很好理解，因为每个<code>View</code>的展现都不一样，例如<code>TextView</code>、<code>ProgressBar</code>等，<br>所以<code>View</code>不会去实现<code>onDraw</code>方法，具体是要子类去根据自己的显示要求实现该方法。</p>
<p>再看一下<code>dispatchDraw</code>方法，这个方法是用来绘制子<code>View</code>的，所以要看<code>ViewGroup.dispatchDraw</code>方法，<code>View.dispatchDraw</code>是空的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">int</span> flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_RUN_ANIMATION) != <span class="number">0</span> &amp;&amp; canAnimate()) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> cache = (mGroupFlags &amp; FLAG_ANIMATION_CACHE) == FLAG_ANIMATION_CACHE;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> buildCache = !isHardwareAccelerated();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = children[i];</div><div class="line">			<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</div><div class="line">				<span class="keyword">final</span> LayoutParams params = child.getLayoutParams();</div><div class="line">				attachLayoutAnimationParameters(child, params, i, childrenCount);</div><div class="line">				bindLayoutAnimation(child);</div><div class="line">				<span class="keyword">if</span> (cache) &#123;</div><div class="line">					child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">					<span class="keyword">if</span> (buildCache) &#123;</div><div class="line">						child.buildDrawingCache(<span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LayoutAnimationController controller = mLayoutAnimationController;</div><div class="line">		<span class="keyword">if</span> (controller.willOverlap()) &#123;</div><div class="line">			mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		controller.start();</div><div class="line"></div><div class="line">		mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;</div><div class="line">		mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (cache) &#123;</div><div class="line">			mGroupFlags |= FLAG_CHILDREN_DRAWN_WITH_CACHE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAnimationListener != <span class="keyword">null</span>) &#123;</div><div class="line">			mAnimationListener.onAnimationStart(controller.getAnimation());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> clipSaveCount = <span class="number">0</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		clipSaveCount = canvas.save();</div><div class="line">		canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</div><div class="line">				mScrollX + mRight - mLeft - mPaddingRight,</div><div class="line">				mScrollY + mBottom - mTop - mPaddingBottom);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// We will draw our child's animation, let's reset the flag</span></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</div><div class="line">	mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> more = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">long</span> drawingTime = getDrawingTime();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertReorderBarrier();</div><div class="line">	<span class="comment">// Only use the preordered list if not HW accelerated, since the HW pipeline will do the</span></div><div class="line">	<span class="comment">// draw reordering internally</span></div><div class="line">	<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</div><div class="line">			? <span class="keyword">null</span> : buildOrderedChildList();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">			&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">		<span class="keyword">int</span> childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">		<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">				? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">		<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 调用drawChild方法</span></div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line"></div><div class="line">	<span class="comment">// Draw any disappearing views that have animations</span></div><div class="line">	<span class="keyword">if</span> (mDisappearingChildren != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> disappearingCount = disappearingChildren.size() - <span class="number">1</span>;</div><div class="line">		<span class="comment">// Go backwards -- we may delete as animations finish</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = disappearingCount; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = disappearingChildren.get(i);</div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (debugDraw()) &#123;</div><div class="line">		onDebugDraw(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		canvas.restoreToCount(clipSaveCount);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// mGroupFlags might have been updated by drawChild()</span></div><div class="line">	flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) &#123;</div><div class="line">		invalidate(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_ANIMATION_DONE) == <span class="number">0</span> &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == <span class="number">0</span> &amp;&amp;</div><div class="line">			mLayoutAnimationController.isDone() &amp;&amp; !more) &#123;</div><div class="line">		<span class="comment">// We want to erase the drawing cache and notify the listener after the</span></div><div class="line">		<span class="comment">// next frame is drawn because one extra invalidate() is caused by</span></div><div class="line">		<span class="comment">// drawChild() after the animation is over</span></div><div class="line">		mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;</div><div class="line">		<span class="keyword">final</span> Runnable end = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">		   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			   notifyAnimationListener();</div><div class="line">		   &#125;</div><div class="line">		&#125;;</div><div class="line">		post(end);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到上面的方法中会调用<code>drawChild</code>方法，该方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Draw one child of this View Group. This method is responsible for getting</div><div class="line"> * the canvas in the right state. This includes clipping, translating so</div><div class="line"> * that the child's scrolled origin is at 0, 0, and applying any animation</div><div class="line"> * transformations.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The canvas on which to draw the child</div><div class="line"> * <span class="doctag">@param</span> child Who to draw</div><div class="line"> * <span class="doctag">@param</span> drawingTime The time at which draw is occurring</div><div class="line"> * <span class="doctag">@return</span> True if an invalidate() was issued</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里也简单总结一下<code>draw</code>的过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. ViewRootImpl.performDraw()</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 2. ViewRootImpl.draw()</span></div><div class="line">	draw(fullRedrawNeeded);	</div><div class="line">		<span class="comment">// 3. ViewRootImpl.drawSoftware</span></div><div class="line">		drawSoftware</div><div class="line">			<span class="comment">// 4. 内部调用mView.draw,也就是FrameLayout.draw(). </span></div><div class="line">			mView.draw()(FrameLayout)</div><div class="line">				<span class="comment">// 5. FrameLayout.draw方法内部会调用super.draw方法，也就是View.draw方法.</span></div><div class="line">				<span class="keyword">super</span>.draw(canvas);</div><div class="line">					<span class="comment">// 6. View.draw方法内部会分别调用onDraw绘制自己以及dispatchDraw绘制子View.</span></div><div class="line">					onDraw</div><div class="line">					<span class="comment">// 绘制子View</span></div><div class="line">					dispatchDraw</div><div class="line">						<span class="comment">// 7. dispatchDraw方法内部会遍历所有子View.</span></div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">							<span class="comment">// 8. 对每个子View分别调用drawChild方法</span></div><div class="line">							drawChild()</div><div class="line">								<span class="comment">// 9. drawChild方法内部会对该子View调用draw方法，进行绘制。然后draw又会调用onDraw等，循环就开始了。 </span></div><div class="line">									child.draw()</div><div class="line">						&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后补充一个小问题： <code>getWidth()</code>与<code>getMeasuredWidth()</code>有什么区别呢？<br>一般情况下这两个的值是相同的，<code>getMeasureWidth()</code>方法在<code>measure()</code>过程结束后就可以获取到了，而<code>getWidth()</code>方法要在<code>layout()</code>过程结束后才能获取到。<br>而且<code>getMeasureWidth()</code>的值是通过<code>setMeasuredDimension()</code>设置的，但是<code>getWidth()</code>的值是通过视图右边的坐标减去左边的坐标计算出来的。如果我们在<code>layout</code>的时候将宽高<br>不传<code>getMeasureWidth</code>的值，那么这时候<code>getWidth()</code>与<code>getMeasuredWidth</code>的值就不会再相同了，当然一般也不会这么干…</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/View绘制过程详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio中进行ndk开发" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio中进行ndk开发/">AndroidStudio中进行ndk开发</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio中进行ndk开发/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio中进行ndk开发"><a href="#AndroidStudio中进行ndk开发" class="headerlink" title="AndroidStudio中进行ndk开发"></a>AndroidStudio中进行ndk开发</h1><ul>
<li>创建工程，声明<code>native</code>方法。                 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startDaemon</span><span class="params">(String serviceName, <span class="keyword">int</span> sdkVersion)</span></span>;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> &#123;</div><div class="line">       System.loadLibrary(<span class="string">"daemon"</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>生成<code>class</code>文件。<br>  执行<code>Build-Make Project</code>命令，生成<code>class</code>文件。所在目录为<code>app_path/build/intermediates/classes/debug</code></li>
</ul>
<ul>
<li><p>执行<code>javah</code>生成<code>.h文件</code>                    </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">	C:\Users\Administrator&gt;javah -help</div><div class="line">	用法:</div><div class="line">	  javah [options] &lt;classes&gt;</div><div class="line">	其中, [options] 包括:</div><div class="line">	  -o &lt;file&gt;                输出文件 (只能使用 -d 或 -o 之一)</div><div class="line">	  -d &lt;dir&gt;                 输出目录</div><div class="line">	  -v  -verbose             启用详细输出</div><div class="line">	  -h  --help  -?           输出此消息</div><div class="line">	  -version                 输出版本信息</div><div class="line">	  -jni                     生成 JNI 样式的标头文件 (默认值)</div><div class="line">	  -force                   始终写入输出文件</div><div class="line">	  -classpath &lt;path&gt;        从中加载类的路径</div><div class="line">	  -cp &lt;path&gt;               从中加载类的路径</div><div class="line">	  -bootclasspath &lt;path&gt;    从中加载引导类的路径</div><div class="line">	```	</div><div class="line">	在`Studio Terminal`中进入到`src/main`目录下执行`javah`命令:       </div><div class="line">	`javah -d jni -classpath &lt;SDK_android.jar&gt;;&lt;APP_classes&gt; &lt;class&gt;`</div><div class="line">	</div><div class="line">	`F:\DaemonService\app\src\main&gt;javah -d jni -classpath C:\develop\android-sdk-windows\platforms\android-22\android.jar;..\..\build\intermediates\classes\debug com.charonchui.daemonservice.service.DaemonService`</div><div class="line">	执行完成后就会在`src/main/jni`目录下生成`com_charonchui_daemonservice_service_DaemonService.h`文件。</div><div class="line"></div><div class="line">- 在`module/src/main/jni`目录下创建对应的`.c`文件。</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">- 配置`ndk`路径，在项目右键`Moudle Setting`中设置。              </div><div class="line">    ![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_ndk_jni.png?raw=true)    </div><div class="line">	</div><div class="line">- 在`build.gradle`中配置`ndk`选项              </div><div class="line"></div><div class="line">    ```java</div><div class="line">	android &#123;</div><div class="line">		compileSdkVersion 23</div><div class="line">		buildToolsVersion &quot;23.0.1&quot;</div><div class="line"></div><div class="line">		defaultConfig &#123;</div><div class="line">			applicationId &quot;com.charonchui.daemonservice&quot;</div><div class="line">			minSdkVersion 8</div><div class="line">			targetSdkVersion 23</div><div class="line">			versionCode 1</div><div class="line">			versionName &quot;1.0&quot;</div><div class="line"></div><div class="line">			ndk &#123;</div><div class="line">				moduleName &quot;uninstall_feedback&quot; // 配置so名字</div><div class="line">				ldLibs &quot;log&quot;</div><div class="line">	//            abiFilters &quot;armeabi&quot;, &quot;x86&quot;  // 默认就是全部的，加了配置才会生成选中的</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buildTypes &#123;</div><div class="line">			release &#123;</div><div class="line">				minifyEnabled false</div><div class="line">				proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>  这里可能会出现错误:      </p>
<ul>
<li><code>Error: NDK integration is deprecated in the current plugin. Consider trying the new experimental plugin. For details, see http://tools.android.com/tech-docs/new-build-system/gradle-experimental. Set &quot;android.useDeprecatedNdk=true&quot; in gradle.properties to continue using the current NDK integration.</code><br>  解决方法就是在<code>gradle.properties</code>文件中添加<code>android:useDeprecatedNdk=true</code>就可以了。</li>
<li>`Error:Execution failed for task ‘:app:compileDebugNdk’.<blockquote>
<p>com.android.ide.common.process.ProcessException: org.gradle.process.internal.ExecException: Process ‘command ‘E:\android-ndk-r10\ndk-build.cmd’’ finished with non-zero exit value 2<code>解决方法就是在</code>jni<code>目录建一个任意名字的</code>.c`空文件就可以了。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>执行Build<br>  然后就可以在<code>app/build/intermediates/ndk/debug/obj/local</code>下看到所有架构的<code>so</code>了。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_ndk_build.png?raw=true" alt="image">    </p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio中进行ndk开发/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Lantern</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>