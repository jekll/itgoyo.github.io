<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/4/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=110 src="//music.163.com/outchain/player?type=0&id=120897804&auto=0&height=90"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-MaterialDesign使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/MaterialDesign使用/">MaterialDesign使用</a>
    </h1>
  

        
        <a href="/2015/01/01/MaterialDesign使用/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MaterialDesign使用"><a href="#MaterialDesign使用" class="headerlink" title="MaterialDesign使用"></a>MaterialDesign使用</h1><ul>
<li><code>Material Design</code>是<code>Google</code>在<code>2014</code>年的<code>I/O</code>大会上推出的全新设计语言。                        </li>
<li><code>Material Design</code>是基于<code>Android 5.0``(API level 21)</code>的，兼容5.0以下的设备时需要使用版本号<code>v21.0.0</code>以上的<br><code>support v7</code>包中的<code>appcpmpat</code>，不过遗憾的是<code>support</code>包只支持<code>Material Design</code>的部分特性。<br>使用<code>eclipse</code>或<code>Android Studio</code>进行开发时，直接在<code>Android SDK Manager</code>中将<code>Extras-&gt;Android Support Library</code><br>升级至最新版即可。</li>
</ul>
<p>下面我就简单讲解一下如何通过<code>support v7</code>包来使用<code>Material Design</code>进行开发。</p>
<h2 id="Material-Design-Theme"><a href="#Material-Design-Theme" class="headerlink" title="Material Design Theme"></a>Material Design Theme</h2><p><code>Material</code>主题:                         </p>
<ul>
<li>@android:style/Theme.Material (dark version)             –               Theme.AppCompat                           </li>
<li>@android:style/Theme.Material.Light (light version)      –               Theme.AppCompat.Light                 </li>
<li>@android:style/Theme.Material.Light.DarkActionBar        –               Theme.AppCompat.Light.DarkActionBar                 </li>
</ul>
<p>对应的效果分别如下:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/Material_theme.png?raw=true" alt="Image">    </p>
<h2 id="使用ToolBar"><a href="#使用ToolBar" class="headerlink" title="使用ToolBar"></a>使用ToolBar</h2><ul>
<li>禁止Action Bar<br>  可以通过使用<code>Material theme</code>来让应用使用<code>Material Design</code>。想要使用<code>ToolBar</code>需要先禁用<code>ActionBar</code>。<br>  可以通过自定义<code>theme</code>继承<code>Theme.AppCompat.Light.NoActionBar</code>或者在<code>theme</code>中通过以下配置来进行。  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"windowActionBar"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowNoTitle"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>下面我通过第二种方式来看一下具体的实现:   

在`style.xml`中自定义`AppTheme`:    

<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Base application theme. --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme"</span> <span class="attr">parent</span>=<span class="string">"AppTheme.Base"</span>/&gt;</span><span class="xml"></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme.Base"</span> <span class="attr">parent</span>=<span class="string">"Theme.AppCompat.Light.DarkActionBar"</span>&gt;</span><span class="xml"></span></div><div class="line">	<span class="comment">&lt;!-- Tell Android System that we will use ToolBar instead of ActionBar --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"windowNoTitle"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"windowActionBar"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- colorPrimary is used for the default action bar background --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimary"</span>&gt;</span>@color/colorPrimary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- colorPrimaryDark is used for the status bar --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimaryDark"</span>&gt;</span>@color/colorPrimaryDark<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- colorAccent is used as the default value for colorControlActivated</span></div><div class="line">		 which is used to tint widgets --&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorAccent"</span>&gt;</span>@color/colorAccent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure>


配置的这几种颜色分别如下图所示:    
![Image](https://raw.githubusercontent.com/CharonChui/Pictures/master/material_color.png?raw=true)           
里面没有`colorAccent`的颜色，这个颜色是设置`Checkbox`等控件选中时的颜色。

在`values-v21`中的`style.xml`中同样自定义`AppTheme`主题: 
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme"</span> <span class="attr">parent</span>=<span class="string">"AppTheme.Base"</span>&gt;</span><span class="xml"></span></div><div class="line">    <span class="comment">&lt;!-- Customize your theme using Material Design here. --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowContentTransitions"</span> &gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowAllowEnterTransitionOverlap"</span> &gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowAllowReturnTransitionOverlap"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowSharedElementEnterTransition"</span>&gt;</span>@android:transition/move<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowSharedElementExitTransition"</span>&gt;</span>@android:transition/move<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>在<code>Manifest</code>文件中设置<code>AppTheme</code>主题:   </p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;application</div><div class="line">	android:allowBackup="true"</div><div class="line">	android:icon="@mipmap/ic_launcher"</div><div class="line">	android:label="@string/app_name"</div><div class="line">	android:theme="@style/AppTheme" &gt;</div><div class="line">	&lt;activity</div><div class="line">		...</div><div class="line">	&lt;/activity&gt;</div><div class="line">	&lt;activity android:name="com.charon.materialsample.FriendsActivity"&gt;&lt;/activity&gt;</div><div class="line">&lt;/application&gt;</div></pre></td></tr></table></figure>
<p>  这里说一下为什么要在<code>values-v21</code>中也自定义个主题，这是为了能让在<code>21</code>以上的版本能更好的使用<code>Material Design</code>，<br>在21以上的版本中会有更多的动画、特效等。</p>
</li>
<li><p>让Activity继承AppCompatActivity</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在布局文件中进行声明</p>
<p>  声明<code>toolbar.xml</code>，我们把他单独放到一个文件中，方便多布局使用:    </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:local</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span></div><div class="line">    <span class="attr">android:minHeight</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">    <span class="attr">local:popupTheme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Light"</span></div><div class="line">    <span class="attr">local:theme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Dark.ActionBar"</span> /&gt;</div></pre></td></tr></table></figure>
<p>  在<code>Activity</code>的布局中使用<code>ToolBar</code>:    </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">include</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">		<span class="attr">layout</span>=<span class="string">"@layout/toolbar"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">com.charon.materialsample.view.PagerSlidingTabStrip</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/psts_main"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"48dip"</span></div><div class="line">		<span class="attr">android:background</span>=<span class="string">"@color/colorPrimary"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/vp_main"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;<span class="tag">&lt;/<span class="name">android.support.v4.view.ViewPager</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>在Activity中设置ToolBar</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> Toolbar mToolbar;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContext = <span class="keyword">this</span>;</div><div class="line">		mToolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">		mToolbar.setTitle(R.string.app_name);</div><div class="line">		<span class="comment">// 将ToolBar设置为ActionBar，这样一设置后他就能像ActionBar一样直接显示menu目录中的菜单资源</span></div><div class="line">		<span class="comment">// 如果不用该方法，那ToolBar就只是一个普通的View，对menu要用inflateMenu去加载布局。</span></div><div class="line">		setSupportActionBar(mToolbar);</div><div class="line">		getSupportActionBar().setDisplayShowHomeEnabled(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>到这里运行项目就可以了，就可以看到一个简单的<code>ToolBar</code>实现。</p>
<p>接下来我们看一下<code>ToolBar</code>中具体有哪些内容:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/ToolBar_content.jpg?raw=true" alt="Image">                  </p>
<p>我们可以通过对应的方法来修改他们的属性:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/toolbarCode.png?raw=true" alt="Image">               </p>
<p>对于<code>ToolBar</code>中的<code>Menu</code>部分我们可以通过一下方法来设置:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">toolbar.inflateMenu(R.menu.menu_main);</div><div class="line">toolbar.setOnMenuItemClickListener();</div></pre></td></tr></table></figure></p>
<p>或者也可以直接在<code>Activity</code>的<code>onCreateOptionsMenu</code>及<code>onOptionsItemSelected</code>来处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">	<span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></div><div class="line">	getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">	<span class="comment">// Handle action bar item clicks here. The action bar will</span></div><div class="line">	<span class="comment">// automatically handle clicks on the Home/Up button, so long</span></div><div class="line">	<span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></div><div class="line">	<span class="keyword">int</span> id = item.getItemId();</div><div class="line"></div><div class="line">	<span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">	<span class="keyword">if</span> (id == R.id.action_settings) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (id == R.id.action_search) &#123;</div><div class="line">		Toast.makeText(getApplicationContext(), <span class="string">"Search action is selected!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>menu</code>的实现如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span> <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">item</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/action_search"</span></div><div class="line">            <span class="attr">android:title</span>=<span class="string">"@string/action_search"</span></div><div class="line">            <span class="attr">android:orderInCategory</span>=<span class="string">"100"</span></div><div class="line">            <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_action_search"</span></div><div class="line">            <span class="attr">app:showAsAction</span>=<span class="string">"ifRoom"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">item</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/action_settings"</span></div><div class="line">            <span class="attr">android:title</span>=<span class="string">"@string/action_settings"</span></div><div class="line">            <span class="attr">android:orderInCategory</span>=<span class="string">"100"</span></div><div class="line">            <span class="attr">app:showAsAction</span>=<span class="string">"never"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果想要对<code>NavigationIcon</code>添加点击实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">toolbar.setNavigationOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">		onBackPressed();</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>运行后发现我们强大的<code>Activity</code>切换动画怎么在<code>5.0</code>一下系统上实现呢？<code>support v7</code>包也帮我们考虑到了。使用<code>ActivityOptionsCompat</code><br>及<code>ActivityCompat.startActivity</code>，但是悲剧了，他对4.0一下基本都无效，而且就算在4.0上很多动画也不行，具体还是用其他<br>大神在<code>github</code>写的开源项目吧。</p>
<ul>
<li><p>动态取色Palette </p>
<p>  <code>Palette</code>这个类中可以提取一下集中颜色：　　</p>
<ul>
<li>Vibrant （有活力）</li>
<li>Vibrant dark（有活力 暗色）</li>
<li>Vibrant light（有活力 亮色）</li>
<li>Muted （柔和）</li>
<li>Muted dark（柔和 暗色）</li>
<li><p>Muted light（柔和 亮色）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//目标bitmap，代码片段</span></div><div class="line">Bitmap bm = BitmapFactory.decodeResource(getResources(),</div><div class="line">		R.drawable.kale);</div><div class="line">Palette palette = Palette.generate(bm);</div><div class="line"><span class="keyword">if</span> (palette.getLightVibrantSwatch() != <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="comment">//得到不同的样本，设置给imageview进行显示</span></div><div class="line">	iv.setBackgroundColor(palette.getLightVibrantSwatch().getRgb());</div><div class="line">	iv1.setBackgroundColor(palette.getDarkVibrantSwatch().getRgb());</div><div class="line">	iv2.setBackgroundColor(palette.getLightMutedSwatch().getRgb());</div><div class="line">	iv3.setBackgroundColor(palette.getDarkMutedSwatch().getRgb());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="使用DrawerLayout"><a href="#使用DrawerLayout" class="headerlink" title="使用DrawerLayout"></a>使用DrawerLayout</h2><ul>
<li>布局中的使用</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.DrawerLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/drawer_layout"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!--主页面--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">include</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">            <span class="attr">layout</span>=<span class="string">"@layout/toolbar"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.charon.materialsample.view.PagerSlidingTabStrip</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/psts_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"48dip"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@color/colorPrimary"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/vp_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;<span class="tag">&lt;/<span class="name">android.support.v4.view.ViewPager</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--侧边栏部分--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"com.charon.materialsample.fragment.FragmentDrawer"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"@dimen/nav_drawer_width"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"start"</span></div><div class="line">        <span class="attr">app:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">tools:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.DrawerLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用DrawerLayout后可以实现类似SlidingMenu的效果。但是怎么将DrawerLayout与ToolBar结合起来呢？ 还有再结合Navigation Tabs<br>以及ViewPager。下面我就直接上代码了。</p>
<p>先看布局：　activity_main.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.DrawerLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/drawer_layout"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!--主页面--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">include</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">            <span class="attr">layout</span>=<span class="string">"@layout/toolbar"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.charon.materialsample.view.PagerSlidingTabStrip</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/psts_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"48dip"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@color/colorPrimary"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/vp_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--侧边栏部分--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"com.charon.materialsample.fragment.DrawerFragment"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"56dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"start"</span></div><div class="line">        <span class="attr">app:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">tools:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.DrawerLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>MainActivity的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Toolbar mToolbar;</div><div class="line">    <span class="keyword">private</span> PagerSlidingTabStrip mScrollingTabs;</div><div class="line">    <span class="keyword">private</span> ViewPager mViewPager;</div><div class="line">    <span class="keyword">private</span> MainPagerAdapter mPagerAdapter;</div><div class="line">    <span class="keyword">private</span> ActionBarDrawerToggle mDrawerToggle;</div><div class="line">    <span class="keyword">private</span> DrawerLayout mDrawerLayout;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; mTitles;</div><div class="line">    <span class="keyword">private</span> List&lt;Fragment&gt; mFragments;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContext = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">        findView();</div><div class="line">        setToolBar();</div><div class="line">        initView();</div><div class="line">        initDrawerFragment();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mToolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">        mScrollingTabs = (PagerSlidingTabStrip) findViewById(R.id.psts_main);</div><div class="line">        mViewPager = (ViewPager) findViewById(R.id.vp_main);</div><div class="line">        mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setToolBar</span><span class="params">()</span> </span>&#123;</div><div class="line">        mToolbar.setTitle(R.string.app_name);</div><div class="line">        setSupportActionBar(mToolbar);</div><div class="line">        getSupportActionBar().setDisplayShowHomeEnabled(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mFragments = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xxx = <span class="number">0</span>; xxx &lt; <span class="number">5</span>; xxx++) &#123;</div><div class="line">            mFragments.add(<span class="keyword">new</span> FriendsFragment());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mTitles = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xxx = <span class="number">0</span>; xxx &lt; <span class="number">5</span>; xxx++) &#123;</div><div class="line">            mTitles.add(<span class="string">"Tab : "</span> + xxx);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mPagerAdapter = <span class="keyword">new</span> MainPagerAdapter(getSupportFragmentManager(), mFragments, mTitles);</div><div class="line">        mViewPager.setAdapter(mPagerAdapter);</div><div class="line">        mScrollingTabs.setDividerColor(Color.TRANSPARENT);</div><div class="line">        mScrollingTabs.setIndicatorHeight(<span class="number">10</span>);</div><div class="line">        mScrollingTabs.setUnderlineHeight(<span class="number">0</span>);</div><div class="line">        mScrollingTabs.setTextSize(<span class="number">50</span>);</div><div class="line">        mScrollingTabs.setTextColor(Color.BLACK);</div><div class="line">        mScrollingTabs.setSelectedTextColor(Color.WHITE);</div><div class="line">        mScrollingTabs.setViewPager(mViewPager);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDrawerFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDrawerToggle = <span class="keyword">new</span> ActionBarDrawerToggle(<span class="keyword">this</span>, mDrawerLayout, mToolbar, R.string.drawer_open, R.string.drawer_close) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawerOpened</span><span class="params">(View drawerView)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onDrawerOpened(drawerView);</div><div class="line">                MainActivity.<span class="keyword">this</span>.invalidateOptionsMenu();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawerClosed</span><span class="params">(View drawerView)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onDrawerClosed(drawerView);</div><div class="line">                MainActivity.<span class="keyword">this</span>.invalidateOptionsMenu();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawerSlide</span><span class="params">(View drawerView, <span class="keyword">float</span> slideOffset)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onDrawerSlide(drawerView, slideOffset);</div><div class="line">                mToolbar.setAlpha(<span class="number">1</span> - slideOffset / <span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        mDrawerLayout.setDrawerListener(mDrawerToggle);</div><div class="line">        mDrawerToggle.syncState();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">        <span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></div><div class="line">        getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">        <span class="comment">// Handle action bar item clicks here. The action bar will</span></div><div class="line">        <span class="comment">// automatically handle clicks on the Home/Up button, so long</span></div><div class="line">        <span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></div><div class="line">        <span class="keyword">int</span> id = item.getItemId();</div><div class="line"></div><div class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (id == R.id.action_search) &#123;</div><div class="line">            Toast.makeText(getApplicationContext(), <span class="string">"Search action is selected!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后再看一下<code>DrawerFragment</code>的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawerFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> NavigationDrawerAdapter mAdapter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] titles = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DrawerFragment</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;NavDrawerItem&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;NavDrawerItem&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// preparing navigation drawer items</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; titles.length; i++) &#123;</div><div class="line">            NavDrawerItem navItem = <span class="keyword">new</span> NavDrawerItem();</div><div class="line">            navItem.setTitle(titles[i]);</div><div class="line">            data.add(navItem);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mContext = getActivity();</div><div class="line">        <span class="comment">// drawer labels</span></div><div class="line">        titles = getActivity().getResources().getStringArray(R.array.nav_drawer_labels);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">                             Bundle savedInstanceState) &#123;</div><div class="line">        <span class="comment">// Inflating view layout</span></div><div class="line">        View layout = inflater.inflate(R.layout.fragment_navigation_drawer, container, <span class="keyword">false</span>);</div><div class="line">        mRecyclerView = (RecyclerView) layout.findViewById(R.id.drawerList);</div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line">        mAdapter = <span class="keyword">new</span> NavigationDrawerAdapter(getActivity(), getData());</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">        mRecyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(getActivity()));</div><div class="line">        mAdapter.setOnRecyclerViewListener(<span class="keyword">new</span> NavigationDrawerAdapter.OnRecyclerViewListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(mContext, getData().get(position).getTitle(), Toast.LENGTH_SHORT).show();</div><div class="line">                startActivity(<span class="keyword">new</span> Intent(getActivity(), FriendsActivity.class));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onItemLongClick</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> layout;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的<code>PagerSlidingTabStrip</code>是开源项目，我改了下，添加了一个选中时的文字颜色改变。</p>
<p><a href="https://github.com/CharonChui/MaterialLibrary">Demo地址</a></p>
<h2 id="Ripple效果"><a href="#Ripple效果" class="headerlink" title="Ripple效果"></a>Ripple效果</h2><p>个人非常喜欢的效果。相当于给点击事件加上了动态的赶脚。。。</p>
<p>假设现在有一个<code>Button</code>的<code>selector</code>，我们想给这个<code>Button</code>加上<code>Ripple</code>效果，肿么办？<br>新建一个<code>xml</code>文件，用<code>ripple</code>包裹<code>selector</code>，然后在<code>Button</code>的<code>backgroud</code>直接引用这个<code>xml</code>就好了。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">&lt;ripple xmlns:android="http://schemas.android.com/apk/res/android"</div><div class="line">android:color="@color/whatever"&gt;</div><div class="line">&lt;selector xmlns:android="http://schemas.android.com/apk/res/android"</div><div class="line">&lt;item android:state_pressed="false" android:state_focused="true"</div><div class="line">android:drawable="@drawable/some_focused_blah"/&gt;</div><div class="line">&lt;item android:state_pressed="true" android:drawable="@drawable/some_pressed_blah"/&gt;</div><div class="line">&lt;item android:drawable="@android:color/whatever"/&gt;</div><div class="line">&lt;/selector&gt;</div><div class="line">&lt;/ripple&gt;</div></pre></td></tr></table></figure></p>
<p>但是很遗憾，<code>ripple</code>是5.0才有的，而且<code>support</code>包中没有实现该功能的扩展。<br><code>5.0</code>的这些效果还是无法在低版本上实现，包括一些<code>TextView</code>等样式，现在可以用大神的开源项目<br><a href="https://github.com/navasmdc/MaterialDesignLibrary">MaterialDesignLibrary</a></p>
<h2 id="RecyclerView"><a href="#RecyclerView" class="headerlink" title="RecyclerView"></a>RecyclerView</h2><p><code>ListView</code>的升级版，还有什么理由不去用呢？ 同样他也在<code>support v7</code>包中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.android.support:recyclerview-v7:21.+&apos;</div></pre></td></tr></table></figure></p>
<p>通过<code>mRecyclerView.setLayoutManager(new LinearLayoutManager(this));</code>设置为<code>LinearLayoutManager</code>来实现水平或者竖直<br>方向的<code>ListView</code>。</p>
<h2 id="阴影"><a href="#阴影" class="headerlink" title="阴影"></a>阴影</h2><p>通过对<code>View</code>设置<code>backgroud</code>后再添加<code>android:elevation=&quot;2dp&quot;</code>来实现背景大小。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/MaterialDesign使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-注解使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/注解使用/">注解使用</a>
    </h1>
  

        
        <a href="/2015/01/01/注解使用/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="注解使用"><a href="#注解使用" class="headerlink" title="注解使用"></a>注解使用</h1><p>###简介</p>
<blockquote>
<p>Annotations, a form of metadata, provide data about a program that is not part of the program itself. Annotations have no direct effect on the operation of the code they annotate.</p>
</blockquote>
<p>更通俗的意思是为程序的元素（类、方法、成员变量）加上更直观更明了的说明，这些说明信息是与程序的业务逻辑无关，并且是供指定的工具或框架使用的。<br><code>Annontation</code>像一种修饰符一样，应用于包、类型、构造方法、方法、成员变量、参数及本地变量的声明语句中。</p>
<p><code>Annotation</code>其实是一种接口。通过反射来访问<code>annotation</code>信息。相关类（框架或工具中的类）根据这些信息来决定如何使用该程序元素或改变它们的行为。<br><code>Annotation</code>是不会影响程序代码的执行，无论<code>annotation</code>怎么变化，代码都始终如一地执行。<br><code>Java</code>语言解释器在工作时会忽略这些<code>annotation</code>，因此在<code>JVM</code>中这些<code>annotation</code>是“不起作用”的，只能通过配套的工具才能对这些<code>annontaion</code>类型的信息进行访问和处理。</p>
<p>###说明</p>
<ul>
<li><code>Annotation</code>的声明是通过关键字<code>@interface</code>。这个关键字会去继承<code>Annotation</code>接口。</li>
<li><p><code>Annotation</code>的方法定义是独特的、受限制的。<br> <code>Annotation</code>类型的方法必须声明为无参数、无异常的。这些方法定义了<code>Annotation</code>的成员: 方法名代表成员变量名，而方法返回值代表了成员变量的类型。而且方法的返回值类型必须是基本数据类型、<code>Class</code>类型、<code>String类型</code>、枚举类型、<code>Annotation</code>类型或者由前面类型之一作为元素的一维数组。方法的后面可以使用<code>default</code>和一个默认的数值来声明成员变量的默认值，<code>null</code>不能作为成员变量的默认值，这与我们平时的使用有很大的区别。<br>  注解如果只有一个默认属性，可直接用<code>value()</code>函数。一个属性也没有则表示该<code>Annotation</code>为<code>Mark Annotation</code>。<br>  例如:</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public @interface UnitTest &#123;</div><div class="line">     String value();</div><div class="line">&#125;</div><div class="line">```    </div><div class="line">在使用时可以直接使用`@UnitTest("GCD")`，`@UnitTest("GCD"`实际上就是是 `@UnitTest(value="GCD)`的简单写法。  </div><div class="line">例如:</div><div class="line">   </div><div class="line">```java</div><div class="line">@Target(ElementType.METHOD)</div><div class="line">@Retention(RetentionPolicy.RUNTIME)</div><div class="line">public @interface UseCase &#123;</div><div class="line">    public int id();</div><div class="line">    public String description() default "no description";</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###作用</p>
<p><code>Annotation</code>一般作为一种辅助途径，应用在软件框架或者工具中。让这些工具类可以根据不同的<code>Annotation</code>注解信息来采取不同的处理过程或者改变相应程的行为。具有“让编译器进行编译检查的作用”。   </p>
<p>具体可分为如下三类:    </p>
<ul>
<li>标记，用于告诉编译器一些信息</li>
<li>编译时动态处理，如动态生成代码</li>
<li>运行时动态处理，如得到注解信息</li>
</ul>
<p>###Annotation分类    </p>
<p>#####标准的<code>Annotaion</code>    </p>
<p>从<code>jdk 1.5</code>开始，自带了三种标准的<code>annotation</code>类型：   </p>
<ul>
<li><p><code>Override</code><br>  它是一种<code>marker</code>类型的<code>Annotation</code>，用来标注方法，说明被它标注的方法是重载了父类中的方法。如果我们使用了该注解到一个没有覆盖父类方法的方法时，编译器就会提示一个编译错误的警告。   </p>
</li>
<li><p><code>Deprecated</code><br>  它也是一种<code>marker</code>类型的<code>Annotation</code>。当方法或者变量使用该注解时，编译器就会提示该方法已经废弃。</p>
</li>
<li><p><code>SuppressWarnings</code><br>  它不是<code>marker</code>类型的<code>Annotation</code>。用户告诉编译器不要再对该类、方法或者成员变量进行警告提示。   </p>
</li>
</ul>
<p>#####元<code>Annotation</code></p>
<p>元<code>Annotation</code>是指用来定义<code>Annotation</code>的<code>Annotation</code>。  </p>
<ul>
<li><p><code>@Retention</code><br>  保留时间，可为<code>RetentionPolicy.SOURCE(源码时)</code>、<code>RetentionPolicy.CLASS(编译时)</code>、<code>RetentionPolicy.RUNTIME(运行时)</code>，默认为<code>CLASS</code>。如果值为<code>RetentionPolicy.SOURCE</code>那大多都是<code>Mark Annotation</code>，例如:<code>Override</code>、<code>Deprecated</code>、<code>Suppress Warnings</code>。<code>SOURCE</code>表示仅存在于源码中，在<code>class</code>文件中不会包含。<code>CLASS</code>表示会在<code>class</code>文件中存在，但是运行时无法获取。<code>RUNTIME</code>表示会在<code>class</code>文件中存在，并且在运行时可以通过反射获取。    </p>
</li>
<li><p><code>@Target</code><br>  用来标记可进行修饰哪些元素，例如<code>ElementType.TYPE</code>、<code>ElementType.METHOD</code>、<code>ElementType.CONSTRUCTOR</code>、<code>ElementType.FIELD</code>、<code>ElementType.PARAMETER</code>等，如果未指定则默认为可修饰所有。</p>
</li>
<li><p><code>@Inherited</code><br>  子类是否可以继承父类中的该注解。它所标注的<code>Annotation</code>将具有继承性。<br>  例如:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">java.lang.annotation.Inherited</div><div class="line"></div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAnnotation &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MyAnnotation</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySuperClass</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySubClass</span> <span class="keyword">extends</span> <span class="title">MySuperClass</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>

在这个例子中`MySubClass`类继承了`@MyAnnotation`注解，因为`MySubClass`继承了`MySuperClass`类，而`MySuperClass`类使用了`@MyAnnotation`注解。   
</code></pre><ul>
<li><code>@Documented</code><br>  是否会保存到<code>javadoc</code>文档中。  </li>
</ul>
<p>###自定义<code>Annotation</code> </p>
<p>假设现在有个开发团队在每个类的开始都要提供一些信息，例如:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation3List</span> <span class="keyword">extends</span> <span class="title">Generation2List</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">// Author: John Doe</span></div><div class="line">   <span class="comment">// Date: 3/17/2002</span></div><div class="line">   <span class="comment">// Current revision: 6</span></div><div class="line">   <span class="comment">// Last modified: 4/12/2004</span></div><div class="line">   <span class="comment">// By: Jane Doe</span></div><div class="line">   <span class="comment">// Reviewers: Alice, Bill, Cindy</span></div><div class="line"></div><div class="line">   <span class="comment">// class code goes here</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以声明一个注解来保存这些相同的元数据。如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> ClassPreamble &#123;</div><div class="line">   <span class="function">String <span class="title">author</span><span class="params">()</span></span>;</div><div class="line">   <span class="function">String <span class="title">date</span><span class="params">()</span></span>;</div><div class="line">   <span class="function"><span class="keyword">int</span> <span class="title">currentRevision</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</div><div class="line">   <span class="function">String <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">default</span> "N/A"</span>;</div><div class="line">   <span class="function">String <span class="title">lastModifiedBy</span><span class="params">()</span> <span class="keyword">default</span> "N/A"</span>;</div><div class="line">   <span class="comment">// Note use of array</span></div><div class="line">   String[] reviewers();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>声明完注解之后我们就可以填写一些参数来使用它，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ClassPreamble</span> (</div><div class="line">   author = <span class="string">"John Doe"</span>,</div><div class="line">   date = <span class="string">"3/17/2002"</span>,</div><div class="line">   currentRevision = <span class="number">6</span>,</div><div class="line">   lastModified = <span class="string">"4/12/2004"</span>,</div><div class="line">   lastModifiedBy = <span class="string">"Jane Doe"</span>,</div><div class="line">   <span class="comment">// Note array notation</span></div><div class="line">   reviewers = &#123;<span class="string">"Alice"</span>, <span class="string">"Bob"</span>, <span class="string">"Cindy"</span>&#125;</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation3List</span> <span class="keyword">extends</span> <span class="title">Generation2List</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">// class code goes here</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###<code>Annotation</code>解析    </p>
<p>当<code>Java</code>源代码被编译时，编译器的一个插件<code>annotation</code>处理器则会处理这些<code>annotation</code>。<br>处理器可以产生报告信息，或者创建附加的<code>Java</code>源文件或资源。<br>如果<code>annotation</code>本身被加上了<code>RententionPolicy</code>的运行时类，<br>则<code>Java</code>编译器则会将<code>annotation</code>的元数据存储到<code>class</code>文件中。然后<code>Java</code>虚拟机或其他的程序可以查找这些元数据并做相应的处理。</p>
<p>当然除了<code>annotation</code>处理器可以处理<code>annotation</code>外，我们也可以使用反射自己来处理<code>annotation</code>。<code>Java SE 5</code>有一个名为<code>AnnotatedElement</code>的接口，<br><code>Java</code>的反射对象类<code>Class</code>,<code>Constructor</code>,<code>Field</code>,<code>Method</code>以及<code>Package</code>都实现了这个接口。<br>这个接口用来表示当前运行在<code>Java</code>虚拟机中的被加上了<code>annotation</code>的程序元素。<br>通过这个接口可以使用反射读取<code>annotation</code>。<code>AnnotatedElement</code>接口可以访问被加上<code>RUNTIME</code>标记的<code>annotation</code>，<br>相应的方法有<code>getAnnotation</code>,<code>getAnnotations</code>,<code>isAnnotationPresent</code>。<br>由于<code>Annotation</code>类型被编译和存储在二进制文件中就像<code>class</code>一样，<br>所以可以像查询普通的<code>Java</code>对象一样查询这些方法返回的<code>Annotation</code>。</p>
<p>#####运行时<code>Annotation</code>解析</p>
<p>该类是指<code>@Retention</code>为<code>RUNTIME</code>的<code>Annotation</code>。<br>该类型的解析其实本质的使用反射。反射执行的效率是很低的<br>如果不是必要，应当尽量减少反射的使用，因为它会大大拖累你应用的执行效率。</p>
<ul>
<li><p>类注解</p>
<p>  可以通过<code>Class</code>、<code>Method</code>、<code>Field</code>类来在运行时获取注解。下面是通过<code>Class</code>类获取注解的示例:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Class aClass = TheClass.class;</div><div class="line">Annotation[] annotations = aClass.getAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  也可以获取一个指定的注解类型:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Class aClass = TheClass.class;</div><div class="line">Annotation annotation = aClass.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <code>JDK</code>提供的主要方法有:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">getAnnotation</span><span class="params">(Class&lt;A&gt; annotationType)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Annotation[] getAnnotations() &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAnnotationPresent</span><span class="params">(Class&lt;? extends Annotation&gt; annotationType)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>方法注解</p>
<p>  下面是一个方法使用注解的例子:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line">  <span class="meta">@MyAnnotation</span>(name=<span class="string">"someName"</span>,  value = <span class="string">"Hello World"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>你可以通过如下方式获取方法注解:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">//obtain method object</span></div><div class="line">Annotation[] annotations = method.getDeclaredAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

也可以获取一个指定的方法注解，如下:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">// obtain method object</span></div><div class="line">Annotation annotation = method.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>参数注解</p>
<p>  在方法的参数中声明注解，如下:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doSomethingElse</span><span class="params">(</span></span></div><div class="line">        @MyAnnotation(name=<span class="string">"aName"</span>, value=<span class="string">"aValue"</span>) String parameter)&#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>可以通过`Method`对象获取到参数的注解，如下:          
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">//obtain method object</span></div><div class="line">Annotation[][] parameterAnnotations = method.getParameterAnnotations();</div><div class="line">Class[] parameterTypes = method.getParameterTypes();</div><div class="line"></div><div class="line"><span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(Annotation[] annotations : parameterAnnotations)&#123;</div><div class="line">  Class parameterType = parameterTypes[i++];</div><div class="line"></div><div class="line">  <span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"param: "</span> + parameterType.getName());</div><div class="line">        System.out.println(<span class="string">"name : "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

注意，`Method.getParameterAnnotations()`方法会返回一个二维的`Annotation`数组，包含每个方法参数的一个注解数组。    
</code></pre><ul>
<li><p>变量注解</p>
<p>  下面是一个变量使用注解的例子:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@MyAnnotation</span>(name=<span class="string">"someName"</span>,  value = <span class="string">"Hello World"</span>)</div><div class="line">  <span class="keyword">public</span> String myField = <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line"></div><div class="line">你可以像下面这样获取变量的注解:    </div><div class="line">```java</div><div class="line">Field field = ... <span class="comment">//obtain field object</span></div><div class="line">Annotation[] annotations = field.getDeclaredAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>当然也可以获取一个指定的变量注解，如下:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Field field = ... <span class="comment">// obtain method object</span></div><div class="line">Annotation annotation = field.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>记下来我们来举个栗子,运行时注解示例:   </p>
<p>相信很多人都知道<code>Butter Knife</code>。它里面就是使用了注解:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindView</span>(R.id.user) EditText username;</div><div class="line"><span class="meta">@BindView</span>(R.id.pass) EditText password;</div><div class="line"></div><div class="line"><span class="meta">@BindString</span>(R.string.login_error) String loginErrorMessage;</div><div class="line"></div><div class="line"><span class="meta">@OnClick</span>(R.id.submit) <span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO call server...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那我们就以<code>onClick</code>事件为例模仿着他去写一下。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectorProcessor</span> </span>&#123;    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> Object object)</span> </span>&#123;        </div><div class="line">        Class class_=object.getClass();        </div><div class="line">        Method[] methods=class_.getDeclaredMethods();        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Method method : methods) &#123;            </div><div class="line">            onClick clickMethod=method.getAnnotation(onClick.class);            </div><div class="line">            <span class="keyword">if</span> (clickMethod!=<span class="keyword">null</span>) &#123;                </div><div class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Activity) &#123;                   </div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> id : clickMethod.value()) &#123;                        </div><div class="line">                        View view=((Activity) object).findViewById(id);                        </div><div class="line">                        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;                            </div><div class="line">                            <span class="meta">@Override</span>                            </div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;                                </div><div class="line">                                <span class="keyword">try</span> &#123;                                    </div><div class="line">                                    method.invoke(object);                                </div><div class="line">                                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;                                    </div><div class="line">                                    e.printStackTrace();                                </div><div class="line">                                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;                                    </div><div class="line">                                    e.printStackTrace();                                </div><div class="line">                                &#125;                            </div><div class="line">                            &#125;                        </div><div class="line">                        &#125;);                    </div><div class="line">                    &#125;                </div><div class="line">                &#125;            </div><div class="line">             &#125;        </div><div class="line">         &#125;    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;    </div><div class="line">    <span class="meta">@Override</span>    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;        </div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);        </div><div class="line">        setContentView(R.layout.activity_main);        </div><div class="line">        InjectorProcessor processor=<span class="keyword">new</span> InjectorProcessor();        </div><div class="line">        processor.process(MainActivity.<span class="keyword">this</span>);    </div><div class="line">    &#125;    </div><div class="line"></div><div class="line">    <span class="meta">@onClick</span>(&#123;R.id.textview&#125;)    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click</span><span class="params">()</span> </span>&#123;        </div><div class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"HHH"</span>, Toast.LENGTH_SHORT).show();    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很显然大神<code>JakeWharton</code>不会这样做的，毕竟反射会影响性能。<br>我们来看一下<code>ButterKnife</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(METHOD)</div><div class="line"><span class="meta">@Retention</span>(CLASS)</div><div class="line"><span class="meta">@ListenerClass</span>(</div><div class="line">    targetType = <span class="string">"android.view.View"</span>,</div><div class="line">    setter = <span class="string">"setOnClickListener"</span>,</div><div class="line">    type = <span class="string">"butterknife.internal.DebouncingOnClickListener"</span>,</div><div class="line">    method = <span class="meta">@ListenerMethod</span>(</div><div class="line">        name = <span class="string">"doClick"</span>,</div><div class="line">        parameters = <span class="string">"android.view.View"</span></div><div class="line">    )</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</div><div class="line">  <span class="comment">/** View IDs to which the method will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到了吗？是编译型的注解。这样不会影响性能。</p>
<p>一张图总结一下:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/java_annotation.jpg?raw=true" alt="image"></p>
<p>#####编译时<code>Annotation</code>解析    </p>
<p>在刚才介绍的运行时注解中，很多人肯定会说使用反射会影响性能，那有没有不影响性能的方式呢？当然有了，那就是编译时注解。在编译时会通过注解标示来动态生成一些类或者<code>xml</code>，而在运行时，这里注解是没有的，它会依靠动态生成的类来进行操作。所以它就和直接调用方法一样，当然不会有效率影响了。       </p>
<p>该类型注解值是<code>@Retention</code>为<code>CLASS</code>的<code>Annotation</code>，由<code>APT(Annotaion Processing Tool)</code>自动进行解析。是在编译时注入，所以不会像反射一样影响效率问题。   </p>
<p>根据<code>sun</code>官方的解释，<code>APT（annotation processing tool）</code>是一个命令行工具，<br>它对源代码文件进行检测找出其中的<code>annotation</code>后，使用<code>annotation processors</code>来处理<code>annotation</code>。<br>而<code>annotation processors</code>使用了一套反射<code>API</code>并具备对<code>JSR175</code>规范的支持。</p>
<p><code>annotation processors</code>处理<code>annotation</code>的基本过程如下：</p>
<ul>
<li><code>APT</code>运行<code>annotation processors</code>根据提供的源文件中的<code>annotation</code>生成源代码文件和其它的文件（文件具体内容由<code>annotation processors</code>的编写者决定）</li>
<li>接着<code>APT</code>将生成的源代码文件和提供的源文件进行编译生成类文件。</li>
</ul>
<p><code>APT</code>在编译时自动查找所有继承自<code>AbstractProcessor</code>的类，然后调用他们的<code>process</code>方法去处理，这样就拥有了在编译过程中执行代码的能力</p>
<p>所以我们需要做的是:    </p>
<ul>
<li>自定义类继承<code>AbstractProcessor</code></li>
<li>重写<code>process</code>方法</li>
</ul>
<p>那我们就开始写:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span></span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是在<code>Android Studio</code>死活提示找不到<code>AbstractProcessor</code>类，这是因为注解是<code>javase</code>中<code>javax</code>包里面的，<code>android.jar</code>默认是不包含的，所以会编译报错.<br>解决方法就是新建一个<code>Module</code>，在选择类型时将该<code>Module</code>的类型选为<code>Java Library</code>。<br>然后在该<code>Module</code>中创建就好了<code>Processor</code>就好了，完美解决。 </p>
<p>好，那我们就开始写个编译时处理的<code>demo</code> :  </p>
<ul>
<li><code>Android Studio</code>中创建一个<code>Android</code>工程。</li>
<li>新建一个<code>Module</code>，然后选择<code>Java Library</code>类型(我的名字为<code>annotations</code>)，并且让<code>app</code>依赖该<code>module</code>。</li>
<li><p>在<code>annotations</code>的<code>module</code>中创建注解类:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnnotationTest &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>annotations</code>的<code>module</code>自定义<code>Processor</code>类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedAnnotationTypes;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedSourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</div><div class="line"></div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(<span class="string">"com.charon.AnnotationTest"</span>)</div><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.RELEASE_7)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"process"</span>);</div><div class="line">        <span class="keyword">for</span> (TypeElement te : annotations) &#123;</div><div class="line">            <span class="keyword">for</span> (Element element : roundEnv.getElementsAnnotatedWith(te)) &#123;</div><div class="line">                AnnotationTest annotation = element.getAnnotation(AnnotationTest.class);</div><div class="line">                String value = annotation.value();</div><div class="line">                System.out.println(<span class="string">"type : "</span> + value);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <strong><em>注意:</em></strong><code>@SupportedAnnotationTypes(&quot;com.charon.AnnotationTest&quot;)</code>来指定要处理的注解类。<br>  <code>@SupportedSourceVersion(SourceVersion.RELEASE_7)</code>指定编译的版本。这种通过注解指定编译版本和类型的方式是从<code>Java 1.7</code>才有的。<br>  对于之前的版本都是通过重写<code>AbstractProcessor</code>中的方法来指定的。   </p>
</li>
<li><p>注册处理器<br>  我们自定义了<code>Processor</code>那如何才能让其生效呢?就是在<code>annotations</code>的<code>java</code>同级目录新建<code>resources/META-INF/services/javax.annotation.processing.Processor</code>文件</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- java</div><div class="line">- META-INF</div><div class="line">    - services</div><div class="line">        - javax.annotation.processing.Processor</div></pre></td></tr></table></figure>
<p>  然后在<code>javax.annotation.processing.Processor</code>文件中指定自定义的处理器，如:      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.charon.TestProcessor</div></pre></td></tr></table></figure>
<p>  如果多个话就分行写。 </p>
<p>  然后我们<code>Build</code>一下(命令行执行<code>./gradlew build</code>)，就能看到控制台打印出来如下的信息: </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">:app:compileReleaseJavaWithJavac</div><div class="line">:app:compileReleaseJavaWithJavac - <span class="function">is not <span class="title">incremental</span> <span class="params">(e.g. outputs have changed, no previous execution, etc.)</span>.</span></div><div class="line">process</div><div class="line">value : haha</div><div class="line">process</div></pre></td></tr></table></figure>
<p>  <strong><em>注意:</em></strong>千万不要去<code>logcat</code>中找信息，这是编译时注解。<br>  <strong><em>注意:</em></strong>一定要使用<code>jdk1.7</code>，<code>1.8</code>对注解的支持有<code>bug</code>。</p>
</li>
</ul>
<p>上面只是一个简单的例子，如果你想用编译时注解去做一些更高级的事情，例如自动生成一些代码，那你可能就会用到如下几个类库:   </p>
<ul>
<li><a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="external">android-apt</a></li>
<li><a href="https://github.com/google/auto">Google Auto</a>      </li>
<li><a href="https://github.com/square/javapoet">Square javapoet</a></li>
</ul>
<p>这三个库分别的作用为:    </p>
<ul>
<li><p><code>android-apt</code><br>  <code>Android Studio</code>原本是不支持注解处理器的, 但是用<code>android-apt</code>这个插件后, 我们就可以使用注解处理器了,<br>  这个插件可以自动的帮你为生成的代码创建目录, 让生成的代码编译到<code>APK</code>里面去, 而且它还可以让最终编译出来的<code>APK</code>里面不包含注解处理器本身的代码,<br>  因为这部分代码只是编译的时候需要用来生成代码, 最终运行的时候是不需要的。<br>  也就是说它主要有两个目的:    </p>
<ul>
<li>允许配置只在编译时作为注解处理器的依赖，而不添加到最后的APK或library</li>
<li><p>设置源路径，使注解处理器生成的代码能被Android Studio正确的引用</p>
<p>那在什么情况下我们会需要使用它呢？<br>当你需要引入<code>Processor</code>生成的源代码到你的代码中时。例如当你使用<code>Dagger 2</code>或<code>AndroidAnnotaition</code>.<br>该插件使得<code>Android Studio</code>可以配置生成资源的<code>build path</code>,避免<code>IDE</code>报错。<br>当使用<code>apt</code>添加添加依赖，它将不会被包含到最终的<code>APK</code>里。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><code>Auto</code>     </p>
<p>  <code>Google Auto</code>的主要作用是注解<code>Processor</code>类，并对其生成<code>META-INF</code>的配置信息，<br>  可以让你不用去写<code>META-INF</code>这些配置文件，只要在自定义的<code>Processor</code>上面加上<code>@AutoService(Processor.class)</code></p>
</li>
<li><p><code>javapoet</code><br>  <code>javapoet</code>:<code>A Java API for generating .java source files.</code>可以更方便的生成代码，它可以帮助我们通过类调用的形式来生成代码。   </p>
</li>
</ul>
<p>###自定义编译时注解</p>
<p>在自定义注解时，一般来说可能会建三个<code>modules</code>:  </p>
<ul>
<li><code>app module</code>:写一些使用注解的<code>android</code>应用逻辑。</li>
<li><code>api module</code>:定义一些可以在<code>app</code>中使用的注解。它会被<code>app</code>以及<code>compiler</code>使用。</li>
<li><code>compiler module</code>:定义<code>Processor</code>该<code>module</code>不会被包含到应用中，它只会在构建过程中被使用。在编译的过程中它会生成一些<code>java</code>文件，而这些<code>java</code>文件会被打包进<code>apk</code>中。<br>  我们可以在该<code>module</code>中使用<code>auto</code>以及<code>javapoet</code>。  </li>
</ul>
<p>下面开始配置<code>android-apt</code>：   </p>
<ul>
<li><p>配置到<code>app module</code>下的<code>build.gradle</code>中</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.application'</span></div><div class="line"><span class="comment">// apt</span></div><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">23</span></div><div class="line">    buildToolsVersion <span class="string">"23.0.3"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"com.charon.annotationdemo"</span></div><div class="line">        minSdkVersion <span class="number">14</span></div><div class="line">        targetSdkVersion <span class="number">23</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_7</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_7</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        <span class="comment">// 配置apt</span></div><div class="line">        classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">    testCompile 'junit:junit:4.12'</div><div class="line">    compile 'com.android.support:appcompat-v7:23.4.0'</div><div class="line">    compile <span class="title">project</span><span class="params">(<span class="string">':api'</span>)</span></div><div class="line">    apt <span class="title">project</span><span class="params">(<span class="string">':compiler'</span>)</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接下来在<code>compiler module</code>中配置<code>auto</code>以及<code>javapoet</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line">sourceCompatibility = JavaVersion.VERSION_1_7</div><div class="line">targetCompatibility = JavaVersion.VERSION_1_7</div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">project</span> <span class="params">(<span class="string">':api'</span>)</span></span></div><div class="line">    compile 'com.google.auto.service:auto-service:1.0-rc2'</div><div class="line">    compile 'com.squareup:javapoet:1.7.0'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在<code>api module</code>中也加上如下的配置:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line">sourceCompatibility = JavaVersion.VERSION_1_7</div><div class="line">targetCompatibility = JavaVersion.VERSION_1_7</div></pre></td></tr></table></figure>
</li>
<li><p>接下来在<code>api module</code>中定义一个注解       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnnotationTest &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>compiler module</code>中自定义一个<code>Processor</code>       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.ProcessingEnvironment;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.Processor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</div><div class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</div><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes the processor with the processing environment by</div><div class="line">     * setting the &#123;<span class="doctag">@code</span> processingEnv&#125; field to the value of the</div><div class="line">     * &#123;<span class="doctag">@code</span> processingEnv&#125; argument.  An &#123;<span class="doctag">@code</span></div><div class="line">     * IllegalStateException&#125; will be thrown if this method is called</div><div class="line">     * more than once on the same object.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> processingEnv environment to access facilities the tool framework</div><div class="line">     * provides to the processor</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException if this method is called more than once.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Processes a set of annotation types on type elements originating from the prior round </div><div class="line">     * and returns whether or not these annotations are claimed by this processor. </div><div class="line">     * If true is returned, the annotations are claimed and subsequent processors will </div><div class="line">     * not be asked to process them; </div><div class="line">     * if false is returned, the annotations are unclaimed and subsequent processors may be </div><div class="line">     * asked to process them. A processor may always return the same boolean value </div><div class="line">     * or may vary the result based on chosen criteria.</div><div class="line">     * The input set will be empty if the processor supports "*" and the root elements </div><div class="line">     * have no annotations. A Processor must gracefully handle an empty set of annotations.</div><div class="line">     * <span class="doctag">@param</span> annotations</div><div class="line">     * <span class="doctag">@param</span> roundEnv</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"hello processor"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getSupportedAnnotationTypes();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>这里简单的说一下这几个主要的方法:   

- `init()`:初始化操作的方法，`RoundEnvironment`会提供很多有用的工具类`Elements`、`Types`和`Filer`等。
- `process()`:这相当于每个处理器的主函数`main()`。在该方法中去扫描、评估、处理以及生成`Java`文件。 
- `getSupportedAnnotationTypes()`:这里你必须指定，该注解器是注册给哪个注解的。
- `getSupportedSourceVersion()`:用来指定你使用的`java`版本。通常这里会直接放回`SourceVersion.latestSupported()`即可。  

从`idk 1.7`开始，可以使用如下注解来代替`getSupporedAnnotationTypes()`和`getSupportedSourceVersion()`方法:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.latestSupported())</div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;</div><div class="line">   <span class="comment">// 合法注解全名的集合</span></div><div class="line"> &#125;)</div></pre></td></tr></table></figure>
</code></pre><p>注解相关<code>API</code>:     </p>
<ul>
<li><code>Set&lt;? extends Element&gt; getElementsAnnotatedWith(Class&lt;? extends Annotation&gt; a)</code><br>  返回使用给定注释类型注释的元素。该注释可能直接出现或者被继承。只返回注释处理的此<code>round</code>中包括的<code>package</code>元素和<code>type</code>元素、成员声明、参数或者这些元素中声明的类型参数。</li>
<li><p><code>Element</code><br>  表示一个程序元素，比如包、类或者方法。每个元素都表示一个静态的语言级构造（不表示虚拟机的运行时构造）。<br>  元素应该使用<code>equals(Object)</code>方法进行比较。不保证总是使用相同的对象表示某个特定的元素。<br>  要实现基于<code>Element</code>对象类的操作，可以使用<code>visitor</code>或者使用<code>getKind()</code>方法的结果。使用<code>instanceof</code>确定此建模层次结构中某一对象的有效类未必可靠，因为一个实现可以选择让单个对象实现多个<code>Element</code>子接口。</p>
</li>
<li><p><code>TypeElement</code><br>  表示一个类或接口程序元素。提供对有关类型及其成员的信息的访问。注意，枚举类型是一种类，而注释类型是一种接口。<br>  而<code>DeclaredType</code>表示一个类或接口类型，后者将成为前者的一种使用（或调用）。这种区别对于一般的类型是最明显的，对于这些类型，单个元素可以定义一系列完整的类型。<br>  例如，元素<code>java.util.Set</code>对应于参数化类型<code>java.util.Set&lt;String&gt;</code>和<code>java.util.Set&lt;Number&gt;</code>（以及其他许多类型），还对应于原始类型<code>java.util.Set</code>。</p>
</li>
</ul>
<p>扯远了，那我们就以上面的目录结构和实现方式，通过一个具体的例子要详细说明，例子真的很难找，我在网上找到了一个大神写的，虽然从这个例子中并不能看出注解的强大之处，但是对于讲解来说还是非常有用的: </p>
<p>我们要解决的问题是我们想要实现一个披萨店，该店会提供两种披萨(<code>Margherita</code>和<code>Calzone</code>)和一种甜点(<code>Tiramisu</code>)。</p>
<p>首先我们在<code>app module</code>中创建对应的接口和代码 ，如下:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Meal</span> </span>&#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6.0f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果消费者想要下单，那么它需要输入对应的物品名字:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mealName == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Name of the meal is null!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown meal '"</span> + mealName + <span class="string">"'"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这样的话在<code>order()</code>方法中，会有很多<code>if</code>语句，并且每当我们添加一种新的披萨，我们都要添加一条新的<code>if</code>语句。但是我们可以使用注解和工厂模式，我们就可以让注解来自动生成这些在工厂中的<code>if</code>语句。我们期待的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> factory.create(mealName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>MealFactory</code>的实现应该如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MealFactory</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">create</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"id is null!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown id = "</span> + id);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们要做的就是通过注解来生成<code>MealFactory</code>中的代码。<br>想法是这样的：我们将使用同样的<code>type()</code>注解那些属于同一个工厂的类，并且用注解的<code>id()</code>做一个映射，例如从”Calzone”映射到”ClzonePizza”类。我们使用<code>@Factory</code>注解到我们的类中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Margherita"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Calzone"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Tiramisu"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可能会问你自己，我们是否可以只把<code>@Factory</code>注解应用到<code>Meal</code>接口上？答案是注解是不能继承的。一个类<code>class X</code>被注解，并不意味着它的子类<code>class Y extends X</code>会自动被注解。在我们开始写处理器的代码之前，我们先规定如下一些规则：</p>
<ul>
<li>只有类可以被<code>@Factory</code>注解，因为接口或者抽象类并不能用<code>new</code>操作实例化；</li>
<li>被<code>@Factory</code>注解的类，必须至少提供一个公开的默认构造器（即没有参数的构造函数）。否者我们没法实例化一个对象。</li>
<li>被<code>@Factory</code>注解的类必须直接或者间接的继承于<code>type()</code>指定的类型；</li>
<li>具有相同的<code>type</code>的注解类，将被聚合在一起生成一个工厂类。这个生成的类使用<code>Factory</code>后缀，例如<code>type = Meal.class</code>，将生成<code>MealFactory</code>工厂类；</li>
<li><code>id</code>只能是<code>String</code>类型，并且在同一个<code>type</code>组中必须唯一。</li>
</ul>
<p>那我们接着看一下在<code>compiler module</code>中的自定义的<code>FactoryProcessor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Types typeUtils;</div><div class="line">  <span class="keyword">private</span> Elements elementUtils;</div><div class="line">  <span class="keyword">private</span> Filer filer;</div><div class="line">  <span class="keyword">private</span> Messager messager;</div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses = <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    typeUtils = processingEnv.getTypeUtils();</div><div class="line">    elementUtils = processingEnv.getElementUtils();</div><div class="line">    filer = processingEnv.getFiler();</div><div class="line">    messager = processingEnv.getMessager();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">    <span class="comment">// 指定支持@Factory注解</span></div><div class="line">    annotataions.add(Factory.class.getCanonicalName());</div><div class="line">    <span class="keyword">return</span> annotataions;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>init()</code>方法中，我们初始化了几个变量:   </p>
<ul>
<li><code>Elements</code>: 处理<code>Element</code>的工具类  </li>
<li><code>Types</code>: 处理<code>TypeMirror</code>的工具类</li>
<li><code>Filer</code>: 用来创建你要创建的文件</li>
<li><code>Messager</code>:提供给注解处理器一个报告错误、警告以及提示信息的途径。</li>
</ul>
<p>在注解的处理过程中会扫描所有的<code>java</code>源文件。源代码中的每一个部分都是一个特定类型的<code>Element</code>。换句话说:<code>Element</code>代表程序的元素，例如包、类或者方法等。每个<code>Element</code>代表一个构建，例如通过下面的例子我们来说明一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example;    <span class="comment">// PackageElement</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;        <span class="comment">// TypeElement</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> a;      <span class="comment">// VariableElement</span></div><div class="line">    <span class="keyword">private</span> Foo other;  <span class="comment">// VariableElement</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span> <span class="params">()</span> </span>&#123;&#125;    <span class="comment">// ExecuteableElement</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span> <span class="params">(  // ExecuteableElement</span></span></div><div class="line">                     <span class="keyword">int</span> newA   // TypeElement</div><div class="line">                     ) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以在注解中我们必须要换一个角度来看待源代码，它只是一个结构化的文本，我们可以像<code>XML</code>中的<code>DOM</code>一样去解析它。<br>例如现在有一个代表<code>public class Foo</code>类的<code>TypeElement</code>元素，你可以遍历它的子元素，如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TypeElement fooClass = ... ;  </div><div class="line"><span class="keyword">for</span> (Element e : fooClass.getEnclosedElements())&#123; <span class="comment">// iterate over children  </span></div><div class="line">    Element parent = e.getEnclosingElement();  <span class="comment">// parent == fooClass</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你所见，<code>Element</code>代表的是源代码。<code>TypeElement</code>代表的是源代码中的类型元素，例如类。然而<code>TypeElement</code>并不包含类本身的信息。你可以从<code>TypeElement</code>中获取类的名字，但是你获取不到类的信息，例如它的父类。这种信息需要通过<code>TypeMirror</code>获取。你可以通过调用<code>elements.asType()</code>获取元素的<code>TypeMirror</code>。</p>
<p>接下来我们来继续实现<code>process()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Types typeUtils;</div><div class="line">    <span class="keyword">private</span> Elements elementUtils;</div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">        typeUtils = processingEnv.getTypeUtils();</div><div class="line">        elementUtils = processingEnv.getElementUtils();</div><div class="line">        filer = processingEnv.getFiler();</div><div class="line">        messager = processingEnv.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">        annotataions.add(Factory.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> annotataions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// roundEnv.getElementsAnnotatedWith(Factory.class))返回所有被注解了@Factory的元素的列表。</span></div><div class="line">        <span class="comment">// 你可能已经注意到，我们并没有说“所有被注解了@Factory的类的列表”，因为它真的是返回Element的列表。</span></div><div class="line">        <span class="comment">// 请记住：Element可以是类、方法、变量等。所以，接下来，我们必须检查这些Element是否是一个类</span></div><div class="line">        <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">            <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">            <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在继续检查被注解<code>@Fractory</code>的类是否满足我们上面说的5条规则之前，我们将介绍一个让我们更方便继续处理的数据结构。有时候，一个问题或者解释器看起来如此简单，以至于程序员倾向于用一个面向过程方式来写整个处理器。但是你知道吗？一个注解处理器仍然是一个<code>Java</code>程序，所以我们需要使用面向对象编程、接口、设计模式，以及任何你将在其他普通<code>Java</code>程序中使用的技巧。</p>
<p>我们的<code>FactoryProcessor</code>非常简单，但是我们仍然想要把一些信息存为对象。在<code>FactoryAnnotatedClass</code>中，我们保存被注解类的数据，比如合法的类的名字，以及<code>@Factory</code>注解本身的一些信息。也就是说每一个使用了<code>@Factory</code>注解的类都对应一个<code>FactoryAnnotatedClass</code>类，所以，我们保存<code>TypeElement</code>和处理过的<code>@Factory</code>注解：</p>
<p>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryAnnotatedClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> TypeElement annotatedClassElement;</div><div class="line">  <span class="keyword">private</span> String qualifiedSuperClassName;</div><div class="line">  <span class="keyword">private</span> String simpleTypeName;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryAnnotatedClass</span><span class="params">(TypeElement classElement)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</div><div class="line">    <span class="keyword">this</span>.annotatedClassElement = classElement;</div><div class="line">    Factory annotation = classElement.getAnnotation(Factory.class);</div><div class="line">    id = annotation.id();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(id)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">          String.format(<span class="string">"id() in @%s for class %s is null or empty! that's not allowed"</span>,</div><div class="line">              Factory.class.getSimpleName(), classElement.getQualifiedName().toString()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Get the full QualifiedTypeName</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; clazz = annotation.type();</div><div class="line">      <span class="comment">// 返回底层阶级Java语言规范中定义的标准名称。</span></div><div class="line">      qualifiedSuperClassName = clazz.getCanonicalName();</div><div class="line">      simpleTypeName = clazz.getSimpleName();</div><div class="line">    &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">      DeclaredType classTypeMirror = (DeclaredType) mte.getTypeMirror();</div><div class="line">      TypeElement classTypeElement = (TypeElement) classTypeMirror.asElement();</div><div class="line">      qualifiedSuperClassName = classTypeElement.getQualifiedName().toString();</div><div class="line">      simpleTypeName = classTypeElement.getSimpleName().toString();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#id()&#125;中指定的id</div><div class="line">   * return the id</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#type()&#125;指定的类型合法全名</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> qualified name</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getQualifiedFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> qualifiedSuperClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#type()&#125;&#123;<span class="doctag">@link</span> Factory#type()&#125;指定的类型的简单名字</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> qualified name</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getSimpleFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> simpleTypeName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取被<span class="doctag">@Factory</span>注解的原始元素</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> TypeElement <span class="title">getTypeElement</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> annotatedClassElement;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面我们用到了<code>Class</code>,因为这里的类型是一个<code>java.lang.Class</code>。这就意味着，他是一个真正的<code>Class</code>对象。因为注解处理是在编译<code>Java</code>源代码之前。我们需要考虑如下两种情况：</p>
<ul>
<li>这个类已经被编译：这种情况是：如果第三方<code>.jar</code>包含已编译的被<code>@Factory</code>注解<code>.class</code>文件。在这种情况下，可以通过上面的方式在<code>try</code>代码块中直接获取。</li>
<li>这个还没有被编译：这种情况是我们尝试编译被<code>@Fractory</code>注解的源代码。这种情况下，直接获取<code>Class</code>会抛出<code>MirroredTypeException</code>异常。幸运的是，<code>MirroredTypeException</code>包含一个<code>TypeMirror</code>，它表示我们未编译类。因为我们已经知道它必定是一个类类型（我们已经在前面检查过），我们可以直接强制转换为<code>DeclaredType</code>，然后读取<code>TypeElement</code>来获取合法的名字。</li>
</ul>
<p>好了，我们现在还需要一个数据结构类<code>FactoryGroupedClasses</code>，它将简单的组合所有的<code>FactoryAnnotatedClasses</code>到一起。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">      <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> IdAlreadyUsedException </span>&#123;</div><div class="line"></div><div class="line">    FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IdAlreadyUsedException(existing);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你所见，这是一个基本的<code>Map&lt;String, FactoryAnnotatedClass&gt;</code>，这个映射表用来映射<code>@Factory.id()</code>到<code>FactoryAnnotatedClass</code>。我们选择<code>Map</code>这个数据类型，是因为我们要确保每个<code>id</code>是唯一的，我们可以很容易通过<code>map</code>查找实现。<code>generateCode()</code>方法将被用来生成工厂类代码（将在后面讨论）。</p>
<p>我们继续实现<code>process()</code>方法。接下来我们想要检查被注解的类必须有只要一个公开的构造函数，不是抽象类，继承于特定的类型，以及是一个公开类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Types typeUtils;</div><div class="line">    <span class="keyword">private</span> Elements elementUtils;</div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line">    <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">        typeUtils = processingEnv.getTypeUtils();</div><div class="line">        elementUtils = processingEnv.getElementUtils();</div><div class="line">        filer = processingEnv.getFiler();</div><div class="line">        messager = processingEnv.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">        annotataions.add(Factory.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> annotataions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// roundEnv.getElementsAnnotatedWith(Factory.class))返回所有被注解了@Factory的元素的列表。</span></div><div class="line">        <span class="comment">// 你可能已经注意到，我们并没有说“所有被注解了@Factory的类的列表”，因为它真的是返回Element的列表。</span></div><div class="line">        <span class="comment">// 请记住：Element可以是类、方法、变量等。所以，接下来，我们必须检查这些Element是否是一个类</span></div><div class="line">        <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">            <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">            <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">                error(annotatedElement, <span class="string">"Only classes can be annotated with @%s"</span>,</div><div class="line">                        Factory.class.getSimpleName());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 退出处理</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="comment">// 因为我们已经知道它是ElementKind.CLASS类型，所以可以直接强制转换</span></div><div class="line">            TypeElement typeElement = (TypeElement) annotatedElement;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                FactoryAnnotatedClass annotatedClass =</div><div class="line">                        <span class="keyword">new</span> FactoryAnnotatedClass(typeElement); <span class="comment">// throws IllegalArgumentException</span></div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!isValidClass(annotatedClass)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 已经打印了错误信息，退出处理过程</span></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 一旦我们检查isValidClass()成功，我们将添加FactoryAnnotatedClass到对应的FactoryGroupedClasses中</span></div><div class="line">                FactoryGroupedClasses factoryClass =</div><div class="line">                        factoryClasses.get(annotatedClass.getQualifiedFactoryGroupName());</div><div class="line">                <span class="keyword">if</span> (factoryClass == <span class="keyword">null</span>) &#123;</div><div class="line">                    String qualifiedGroupName = annotatedClass.getQualifiedFactoryGroupName();</div><div class="line">                    factoryClass = <span class="keyword">new</span> FactoryGroupedClasses(qualifiedGroupName);</div><div class="line">                    factoryClasses.put(qualifiedGroupName, factoryClass);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 如果和其他的@Factory标注的类的id相同冲突，</span></div><div class="line">                <span class="comment">// 抛出IdAlreadyUsedException异常</span></div><div class="line">                factoryClass.add(annotatedClass);</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">                <span class="comment">// @Factory.id()为空 --&gt; 打印错误信息</span></div><div class="line">                error(typeElement, e.getMessage());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (IdAlreadyUsedException e) &#123;</div><div class="line">                FactoryAnnotatedClass existing = e.getExisting();</div><div class="line">                <span class="comment">// 已经存在</span></div><div class="line">                error(annotatedElement,</div><div class="line">                        <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">                        typeElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                        existing.getTypeElement().getQualifiedName().toString());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 为每个工厂生成Java文件</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">                factoryClass.generateCode(elementUtils, filer);</div><div class="line">            &#125;</div><div class="line">        <span class="comment">// TODO ...注意这里会遗留一个问题，我们后面再仔细说。 </span></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Element e, String msg, Object... args)</span> </span>&#123;</div><div class="line">        messager.printMessage(</div><div class="line">                Diagnostic.Kind.ERROR,</div><div class="line">                String.format(msg, args),</div><div class="line">                e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidClass</span><span class="params">(FactoryAnnotatedClass item)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 转换为TypeElement, 含有更多特定的方法</span></div><div class="line">        TypeElement classElement = item.getTypeElement();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!classElement.getModifiers().contains(Modifier.PUBLIC)) &#123;</div><div class="line">            error(classElement, <span class="string">"The class %s is not public."</span>,</div><div class="line">                    classElement.getQualifiedName().toString());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查是否是一个抽象类</span></div><div class="line">        <span class="keyword">if</span> (classElement.getModifiers().contains(Modifier.ABSTRACT)) &#123;</div><div class="line">            error(classElement, <span class="string">"The class %s is abstract. You can't annotate abstract classes with @%"</span>,</div><div class="line">                    classElement.getQualifiedName().toString(), Factory.class.getSimpleName());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查继承关系: 必须是@Factory.type()指定的类型子类</span></div><div class="line">        TypeElement superClassElement =</div><div class="line">                elementUtils.getTypeElement(item.getQualifiedFactoryGroupName());</div><div class="line">        <span class="keyword">if</span> (superClassElement.getKind() == ElementKind.INTERFACE) &#123;</div><div class="line">            <span class="comment">// 检查接口是否实现了</span></div><div class="line">            <span class="keyword">if</span>(!classElement.getInterfaces().contains(superClassElement.asType())) &#123;</div><div class="line">                error(classElement, <span class="string">"The class %s annotated with @%s must implement the interface %s"</span>,</div><div class="line">                        classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                        item.getQualifiedFactoryGroupName());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 检查子类</span></div><div class="line">            TypeElement currentClass = classElement;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                TypeMirror superClassType = currentClass.getSuperclass();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (superClassType.getKind() == TypeKind.NONE) &#123;</div><div class="line">                    <span class="comment">// 到达了基本类型(java.lang.Object), 所以退出</span></div><div class="line">                    error(classElement, <span class="string">"The class %s annotated with @%s must inherit from %s"</span>,</div><div class="line">                            classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                            item.getQualifiedFactoryGroupName());</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (superClassType.toString().equals(item.getQualifiedFactoryGroupName())) &#123;</div><div class="line">                    <span class="comment">// 找到了要求的父类</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 在继承树上继续向上搜寻</span></div><div class="line">                currentClass = (TypeElement) typeUtils.asElement(superClassType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查是否提供了默认公开构造函数</span></div><div class="line">        <span class="keyword">for</span> (Element enclosed : classElement.getEnclosedElements()) &#123;</div><div class="line">            <span class="keyword">if</span> (enclosed.getKind() == ElementKind.CONSTRUCTOR) &#123;</div><div class="line">                ExecutableElement constructorElement = (ExecutableElement) enclosed;</div><div class="line">                <span class="keyword">if</span> (constructorElement.getParameters().size() == <span class="number">0</span> &amp;&amp; constructorElement.getModifiers()</div><div class="line">                        .contains(Modifier.PUBLIC)) &#123;</div><div class="line">                    <span class="comment">// 找到了默认构造函数</span></div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 没有找到默认构造函数</span></div><div class="line">        error(classElement, <span class="string">"The class %s must provide an public empty default constructor"</span>,</div><div class="line">                classElement.getQualifiedName().toString());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们这里添加了<code>isValidClass()</code>方法，来检查是否我们所有的规则都被满足了：</p>
<ul>
<li>必须是公开类：<code>classElement.getModifiers().contains(Modifier.PUBLIC)</code></li>
<li>必须是非抽象类：<code>classElement.getModifiers().contains(Modifier.ABSTRACT)</code></li>
<li>必须是<code>@Factoy.type()</code>指定的类型的子类或者接口的实现：首先我们使用<code>elementUtils.getTypeElement(item.getQualifiedFactoryGroupName())</code>创建一个传入的<code>Class(@Factoy.type())</code>的元素。是的，你可以仅仅通过已知的合法类名来直接创建<code>TypeElement</code>（使用<code>TypeMirror</code>）。接下来我们检查它是一个接口还是一个类：<code>superClassElement.getKind() == ElementKind.INTERFACE</code>。所以我们这里有两种情况：如果是接口，就判断<code>classElement.getInterfaces().contains(superClassElement.asType())</code>；如果是类，我们就必须使用<code>currentClass.getSuperclass()</code>扫描继承层级。注意，整个检查也可以使用<code>typeUtils.isSubtype()</code>来实现。</li>
<li>类必须有一个公开的默认构造函数：我们遍历所有的闭元素<code>classElement.getEnclosedElements()</code>，然后检查<code>ElementKind.CONSTRUCTOR</code>、<code>Modifier.PUBLIC</code>以及<code>constructorElement.getParameters().size() == 0</code>。</li>
</ul>
<p>上面都实现完成后下面就是在<code>FactoryGroupedClasses.generateCode()</code>方法中去生成<code>java</code>文件了。<br>写<code>Java</code>文件，和写其他普通文件没有什么两样。使用<code>Filer</code>提供的<code>Writer</code>对象，我们可以连接字符串来写我们生成的<code>Java</code>代码。但是这样是不是非常麻烦啊？还好良心企业<code>Square</code>给我们提供了<code>Javapoet</code>，我们可以用它来非常简单的去生成<code>java</code>文件。那我们接下来就使用<code>javapoet</code>来去生成代码:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将被添加到生成的工厂类的名字中</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">"Factory"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> ProcessingException </span>&#123;</div><div class="line"></div><div class="line">        FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">        <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Alredy existing</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProcessingException(toInsert.getTypeElement(),</div><div class="line">                    <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">                    toInsert.getTypeElement().getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                    toInsert.getId(), existing.getTypeElement().getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        TypeElement superClassName = elementUtils.getTypeElement(qualifiedClassName);</div><div class="line">        String factoryClassName = superClassName.getSimpleName() + SUFFIX;</div><div class="line">        String qualifiedFactoryClassName = qualifiedClassName + SUFFIX;</div><div class="line">        PackageElement pkg = elementUtils.getPackageOf(superClassName);</div><div class="line">        String packageName = pkg.isUnnamed() ? <span class="keyword">null</span> : pkg.getQualifiedName().toString();</div><div class="line"></div><div class="line">        MethodSpec.Builder method = MethodSpec.methodBuilder(<span class="string">"create"</span>)</div><div class="line">                .addModifiers(Modifier.PUBLIC)</div><div class="line">                .addParameter(String.class, <span class="string">"id"</span>)</div><div class="line">                .returns(TypeName.get(superClassName.asType()));</div><div class="line"></div><div class="line">        <span class="comment">// check if id is null</span></div><div class="line">        method.beginControlFlow(<span class="string">"if (id == null)"</span>)</div><div class="line">                .addStatement(<span class="string">"throw new IllegalArgumentException($S)"</span>, <span class="string">"id is null!"</span>)</div><div class="line">                .endControlFlow();</div><div class="line"></div><div class="line">        <span class="comment">// Generate items map</span></div><div class="line">        <span class="keyword">for</span> (FactoryAnnotatedClass item : itemsMap.values()) &#123;</div><div class="line">            method.beginControlFlow(<span class="string">"if ($S.equals(id))"</span>, item.getId())</div><div class="line">                    .addStatement(<span class="string">"return new $L()"</span>, item.getTypeElement().getQualifiedName().toString())</div><div class="line">                    .endControlFlow();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        method.addStatement(<span class="string">"throw new IllegalArgumentException($S + id)"</span>, <span class="string">"Unknown id = "</span>);</div><div class="line"></div><div class="line">        TypeSpec typeSpec = TypeSpec.classBuilder(factoryClassName).addMethod(method.build()).build();</div><div class="line"></div><div class="line">        <span class="comment">// Write file</span></div><div class="line">        JavaFile.builder(packageName, typeSpec).build().writeTo(filer);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里，我感觉完成了，运行一下，结果发现报错了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:compiler:jar UP-TO-DATE</div><div class="line">:app:compileDebugJavaWithJavac</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line"><span class="number">2</span> 个错误</div><div class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':app:compileDebugJavaWithJavac'</span>.</div><div class="line">&gt; Compilation failed; see the compiler error output <span class="keyword">for</span> details.</div></pre></td></tr></table></figure></p>
<p>那我们继续来解决这个问题，这个问题是由于循环引起的，我们还要处理一个重要的事情就是循环的问题:    </p>
<p>注解处理可能会执行多次，官方文档中是这样介绍的:   </p>
<blockquote>
<p>Annotation processing happens in a sequence of rounds. On each round, a processor may be asked to process a subset of the annotations found on the source and class files produced by a prior round. The inputs to the first round of processing are the initial inputs to a run of the tool; these initial inputs can be regarded as the output of a virtual zeroth round of processing.</p>
</blockquote>
<p>一个简单的定义：一个处理循环是调用一个注解处理器的<code>process()</code>方法。对应到我们的工厂模式的例子中：<code>FactoryProcessor</code>被初始化一次（不是每次循环都会新建处理器对象），然而，如果生成了新的源文件<code>process()</code>能够被调用多次。听起来有点奇怪不是么？原因是这样的，这些生成的文件中也可能包含<code>@Factory</code>注解，它们还将会被<code>FactoryProcessor</code>处理。</p>
<p>例如我们的<code>PizzaStore</code>的例子中将会经过3次循环处理：</p>
<table>
<thead>
<tr>
<th>Round</th>
<th style="text-align:center">Input</th>
<th style="text-align:right">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:center">CalzonePizza.java Tiramisu.java MargheritaPizza.java Meal.java   PizzaStore.java</td>
<td style="text-align:right">MealFactory.java</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:center">MealFactory.java</td>
<td style="text-align:right">none</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">none</td>
<td style="text-align:right">none</td>
</tr>
</tbody>
</table>
<p>会循环三次，但是第一次就会生成代码，所以上面会出现两次重复创建文件的错误。   </p>
<p>解释处理循环还有另外一个原因。如果你看一下我们的<code>FactoryProcessor</code>代码你就能注意到，我们收集数据和保存它们在一个私有的域中<code>Map&lt;String, FactoryGroupedClasses&gt; factoryClasses</code>。在第一轮中，我们检测到了<code>MagheritaPizza</code>, <code>CalzonePizza</code>和<code>Tiramisu</code>，然后生成了<code>MealFactory.java</code>。在第二轮中把<code>MealFactory</code>作为输入。因为在<code>MealFactory</code>中没有检测到<code>@Factory</code>注解，我们预期并没有错误，然而我们得到如下的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:compiler:jar UP-TO-DATE</div><div class="line">:app:compileDebugJavaWithJavac</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line"><span class="number">2</span> 个错误</div><div class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':app:compileDebugJavaWithJavac'</span>.</div><div class="line">&gt; Compilation failed; see the compiler error output <span class="keyword">for</span> details.</div></pre></td></tr></table></figure>
<p>这个问题是因为我们没有清除<code>factoryClasses</code>，这意味着，在第二轮的<code>process()</code>中，任然保存着第一轮的数据，并且会尝试生成在第一轮中已经生成的文件，从而导致这个错误的出现。在我们的这个场景中，我们知道只有在第一轮中检查<code>@Factory</code>注解的类，所以我们可以简单的修复这个问题，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;  </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">        factoryClass.generateCode(elementUtils, filer);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 清除factoryClasses</span></div><div class="line">      factoryClasses.clear();</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong><em>我们要记住注解处理过程是需要经过多轮处理的，并且你不能重载或者重新创建已经生成的源代码。</em></strong></p>
<p>好了，到这里就彻底完成了，运行一下，当然成功了，那生成的文件在哪里呢？ </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/annotation_ato_create_file.png" alt="image">     </p>
<p>那既然能生成，我们该怎么去调用呢？很简单，像平常一样去用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> View view;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        view = findViewById(R.id.tv);</div><div class="line">        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line">                factory.create(<span class="string">"Calzone"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可能会发现报错，找不到类，你可以不用管它，直接运行，你会发现一切都<code>OK</code>的。当然如果你倒错了包你就当我没说。</p>
<p>作为<code>Android</code>开发者，当然应该很熟悉<code>ButterKnife</code>。在<code>ButterKnife</code>中使用<code>@InjectView</code>注解<code>View</code>。<code>ButterKnifeProcessor</code>生成一个<code>MyActivity$$ViewInjector</code>，但是在<code>ButterKnife</code>你不需要手动调用<code>new MyActivity$$ViewInjector()</code>来实例化一个<code>ButterKnife</code>注入的对象，而是使用<code>Butterknife.inject(activity)</code>。<code>ButterKnife</code>内部使用反射机制来实例化<code>MyActivity$$ViewInjector()</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    Class&lt;?&gt; injector = Class.forName(clsName + <span class="string">"$$ViewInjector"</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123; ... &#125;</div></pre></td></tr></table></figure>
<p>但是反射机制会稍微有些慢，我们使用注解处理来生成本地代码，会不会导致很多的反射性能的问题？的确，反射机制的性能确实是一个问题。然而，它不需要手动去创建对象，确实提高了开发者的开发速度。<code>ButterKnife</code>中有一个哈希表<code>HashMap</code>来缓存实例化过的对象。所以<code>MyActivity$$ViewInjector</code>只是使用反射机制实例化一次，第二次需要<code>MyActivity$$ViewInjector</code>的时候，就直接从哈希表中获得。</p>
<p><code>FragmentArgs</code>非常类似于<code>ButterKnife</code>。它使用反射机制来创建对象，而不需要开发者手动来做这些。<code>FragmentArgs</code>在处理注解的时候生成一个特别的查找表类，它其实就是一种哈希表，所以整个<code>FragmentArgs</code>库只是在第一次使用的时候，执行一次反射调用，一旦整个<code>Class.forName()</code>的<code>Fragemnt</code>的参数对象被创建，后面的都是本地代码运行了。</p>
<p>好了至此例子讲完了。   </p>
<p>最后讲一下按照上面的三层分类:<code>app</code>,<code>api</code>,<code>compiler</code>进行分类的好处。<br>我们这么做是因为想让我们的工厂模式的例子的使用者在他们的工程中只编译注解，而包含处理器模块只是为了编译。有点晕？我们举个例子，如果我们只有一个包。如果另一个开发者想要把我们的工厂模式处理器用于他的项目中，他就必须包含<code>@Factory</code>注解和整个<code>FactoryProcessor</code>的代码（包括<code>FactoryAnnotatedClass</code>和<code>FactoryGroupedClasses</code>）到他们项目中。我非常确定的是，他并不需要在他已经编译好的项目中包含处理器相关的代码。如果你是一个<code>Android</code>的开发者，你肯定听说过<code>65536</code>个方法的限制（即在一个<code>.dex</code>文件中，只能寻址65536个方法）。如果你在<code>FactoryProcessor</code>中使用<code>guava</code>，并且把注解和处理器打包在一个包中，这样的话，<code>Android APK</code>安装包中不只是包含<code>FactoryProcessor</code>的代码，而也包含了整个<code>guava</code>的代码。<code>Guava</code>有大约20000个方法。所以分开注解和处理器是非常有意义的。</p>
<p>###使用注解提高代码的检查性    </p>
<p><code>Google</code>提供了<code>Support-Annotations library</code>来支持更多的注解功能。<br>可以直接在<code>build.gradle</code>中添加如下代码:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:support-annotations:23.3.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Android</code>提供了很多注解来支持在方法、参数和返回值上面使用，例如:    </p>
<ul>
<li><code>@Nullable</code><br>  可以为<code>null</code></li>
<li><p><code>@NonNull</code><br>  不能为<code>null</code>  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment">/** Add support for inflating the &lt;fragment&gt; tag. */</span></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, @NonNull Context context,</span></span></div><div class="line">      @NonNull AttributeSet attrs) &#123;</div><div class="line">      ...</div><div class="line">      &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p><code>@StringRes</code><br>  <code>R.string</code>类型的资源。  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.annotation.StringRes;</div><div class="line">...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(@StringRes <span class="keyword">int</span> resId)</span></span>;</div><div class="line">    ...</div><div class="line"></div><div class="line">遇到那种你写了个`setTitle(<span class="keyword">int</span> resId)`他确给你传`setTitle(R.drawable.xxx)`的选手，用这种方式能很好的去提示下。</div></pre></td></tr></table></figure>
</li>
<li><p><code>@DrawableRes</code><br>  <code>Drawable</code>类型的资源。</p>
</li>
<li><code>@ColorRes</code><br>  <code>Color</code>类型的资源。</li>
<li><code>@InterpolatorRes</code><br>  <code>Interpolatro</code>类型。</li>
<li><code>@AnyRes</code><br>  <code>R.</code>类型。</li>
<li><code>@UiThread</code><br>  从<code>UI thread</code>调用。 </li>
<li><p><code>@RequiresPermission</code><br>  来验证该方法的调用者所需要有的权限。检查一个列表中的任何一个权限可以使用<code>anyOf</code>属性。想要检查多个权限时，可以使用<code>allOf</code>属性。如下:  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequiresPermission</span>(Manifest.permission.SET_WALLPAPER)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setWallpaper</span><span class="params">(Bitmap bitmap)</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure>
<p>  检查多个权限:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequiresPermission</span>(allOf = &#123;</div><div class="line">    Manifest.permission.READ_EXTERNAL_STORAGE,</div><div class="line">    Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String dest, String source)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>示例<code>Demo</code>已上传到<code>Github</code>:<a href="https://github.com/CharonChui/AnnotationDemo">AnnotationDemo</a>    </p>
<p>文中例子来自<code>Hannes Dorfmann</code>大神的<code>ANNOTATION PROCESSING 101</code>，我对其重新梳理了下，来让能正常使用，并且上面的示例已经过我实际运行:   </p>
<ul>
<li><a href="http://hannesdorfmann.com/annotation-processing/annotationprocessing101" target="_blank" rel="external">Hannes Dorfmann</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/注解使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android Touch事件分发详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android Touch事件分发详解/">Android Touch事件分发详解</a>
    </h1>
  

        
        <a href="/2015/01/01/Android Touch事件分发详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Touch事件分发详解"><a href="#Android-Touch事件分发详解" class="headerlink" title="Android Touch事件分发详解"></a>Android Touch事件分发详解</h1><p>先说一些基本的知识，方便后面分析源码时能更好理解。</p>
<ul>
<li><p>所有<code>Touch</code>事件都被封装成<code>MotionEvent</code>对象，包括<code>Touch</code>的位置、历史记录、第几个手指等.</p>
</li>
<li><p>事件类型分为<code>ACTION_DOWN</code>,<code>ACTION_UP</code>,<code>ACTION_MOVE</code>,<code>ACTION_POINTER_DOWN</code>,<code>ACTION_POINTER_UP</code>,<code>ACTION_CANCEL</code>, 每个<br>一个完整的事件以<code>ACTION_DOWN</code>开始<code>ACTION_UP</code>结束，并且<code>ACTION_CANCEL</code>只能由代码引起.一般对于<code>CANCEL</code>的处理和<code>UP</code>的相同。<br><code>CANCEL</code>的一个简单例子：手指在移动的过程中突然移动到了边界外，那么这时<code>ACTION_UP</code>事件了，所以这是的<code>CANCEL</code>和<code>UP</code>的处理是一致的。</p>
</li>
<li><p>事件的处理分别为<code>dispatchTouchEveent()</code>分发事件(<code>TextView</code>等这种最小的<code>View</code>中不会有该方式)、<code>onInterceptTouchEvent()</code>拦截事件(<code>ViewGroup</code>中拦截事件)、<code>onTouchEvent()</code>消费事件.</p>
</li>
<li><p>事件从<code>Activity.dispatchTouchEveent()</code>开始传递，只要没有停止拦截，就会从最上层(<code>ViewGroup</code>)开始一直往下传递，子<code>View</code>通过<code>onTouchEvent()</code>消费事件。(隧道式向下分发).</p>
</li>
<li><p>如果时间从上往下一直传递到最底层的子<code>View</code>，但是该<code>View</code>没有消费该事件，那么该事件会反序网上传递(从该<code>View</code>传递给自己的<code>ViewGroup</code>，然后再传给更上层的<code>ViewGroup</code>直至传递给<code>Activity.onTouchEvent()</code>).<br>(冒泡式向上处理).</p>
</li>
<li><p>如果<code>View</code>没有消费<code>ACTION_DOWN</code>事件，之后其他的<code>MOVE</code>、<code>UP</code>等事件都不会传递过来.</p>
</li>
<li><p>事件由父<code>View(ViewGroup)</code>传递给子<code>View</code>,<code>ViewGroup</code>可以通过<code>onInterceptTouchEvent()</code>方法对事件进行拦截，停止其往下传递，如果拦截(返回<code>true</code>)后该事件<br>会直接走到该<code>ViewGroup</code>中的<code>onTouchEvent()</code>中，不会再往下传递给子<code>View</code>.如果从<code>DOWN</code>开始，之后的<code>MOVE</code>、<code>UP</code>都会直接在该<code>ViewGroup.onTouchEvent()</code>中进行处理。<br>如果子<code>View</code>之前在处理某个事件，但是后续被<code>ViewGroup</code>拦截，那么子<code>View</code>会接收到<code>ACTION_CANCEL</code>.</p>
</li>
<li><p><code>OnTouchListener</code>优先于<code>onTouchEvent()</code>对事件进行消费。</p>
</li>
<li><p><code>TouchTarget</code>是保存手指点击区域属性的一个类，手指的所有移动过程都会被它记录下来, 包含被<code>touch</code>的<code>View</code>。  </p>
</li>
</ul>
<p>废话不多说，直接上源码，源码妥妥的是最新版5.0：<br>我们先从<code>Activity.dispatchTouchEveent()</code>说起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called to process touch screen events.  You can override this to</div><div class="line"> * intercept all touch screen events before they are dispatched to the</div><div class="line"> * window.  Be sure to call this implementation for touch screen events</div><div class="line"> * that should be handled normally.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> ev The touch screen event.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> boolean Return true if this event was consumed.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		onUserInteraction();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码一看能感觉出来<code>DOWN</code>事件比较特殊。我们继续走到<code>onUserInteraction()</code>代码中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called whenever a key, touch, or trackball event is dispatched to the</div><div class="line"> * activity.  Implement this method if you wish to know that the user has</div><div class="line"> * interacted with the device in some way while your activity is running.</div><div class="line"> * This callback and &#123;<span class="doctag">@link</span> #onUserLeaveHint&#125; are intended to help</div><div class="line"> * activities manage status bar notifications intelligently; specifically,</div><div class="line"> * for helping activities determine the proper time to cancel a notfication.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;All calls to your activity's &#123;<span class="doctag">@link</span> #onUserLeaveHint&#125; callback will</div><div class="line"> * be accompanied by calls to &#123;<span class="doctag">@link</span> #onUserInteraction&#125;.  This</div><div class="line"> * ensures that your activity will be told of relevant user activity such</div><div class="line"> * as pulling down the notification pane and touching an item there.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this callback will be invoked for the touch down action</div><div class="line"> * that begins a touch gesture, but may not be invoked for the touch-moved</div><div class="line"> * and touch-up actions that follow.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onUserLeaveHint()</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserInteraction</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是该方法是空方法，没有具体实现。 我们往下看<code>getWindow().superDispatchTouchEvent(ev)</code>.<br><code>getWindow()</code>获取到当前<code>Window</code>对象，表示顶层窗口，管理界面的显示和事件的响应；每个Activity 均会创建一个PhoneWindow对象，<br>是Activity和整个View系统交互的接口，但是该类是一个抽象类。<br>从文档中可以看到<code>The only existing implementation of this abstract class is android.policy.PhoneWindow, which you should instantiate when needing a Window.</code>，<br>所以我们找到<code>PhoneWindow</code>类，查看它的<code>superDispatchTouchEvent()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>该方法又是调用了<code>mDecor.superDispatchTouchEvent(event)</code>, <code>mDecor</code>是什么呢？ 从名字中我们大概也能猜出来是当前窗口最顶层的<code>DecorView</code>，<br><code>Window</code>界面的最顶层的<code>View</code>对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is the top-level view of the window, containing the window decor.</span></div><div class="line"><span class="keyword">private</span> DecorView mDecor;</div></pre></td></tr></table></figure></p>
<p>讲到这里不妨就提一下<code>DecorView</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它集成子<code>FrameLayout</code>所有很多时候我们在用布局工具查看的时候发现<code>Activity</code>的布局<code>FrameLayout</code>的。就是这个原因。<br>好了，我们接着看<code>DecorView</code>中的<code>superDispatchTouchEvent()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是调用了<code>super.dispatchTouchEveent()</code>，而<code>DecorView</code>的父类是<code>FrameLayout</code>所以我们找到<code>FrameLayout.dispatchTouchEveent()</code>.<br>我们看到<code>FrameLayout</code>中没有重写<code>dispatchTouchEveent()</code>方法，所以我们再找到<code>FrameLayout</code>的父类<code>ViewGroup</code>.看<code>ViewGroup.dispatchTouchEveent()</code>实现。<br>新大陆浮现了…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// Consistency verifier for debugging purposes.是调试使用的，我们不用管这里了。</span></div><div class="line">	<span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onTouchEvent(ev, <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">// onFilterTouchEventForSecurity()用安全机制来过滤触摸事件，true为不过滤分发下去，false则销毁掉该事件。</span></div><div class="line">	<span class="comment">// 方法具体实现是去判断是否被其它窗口遮挡住了，如果遮挡住就要过滤掉该事件。</span></div><div class="line">	<span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">		<span class="comment">// 没有被其它窗口遮住</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</div><div class="line"></div><div class="line">		<span class="comment">// 下面这一块注释说的很清楚了，就是在`Down`的时候把所有的状态都重置，作为一个新事件的开始。</span></div><div class="line">		<span class="comment">// Handle an initial down.</span></div><div class="line">		<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">			<span class="comment">// Throw away all previous state when starting a new touch gesture.</span></div><div class="line">			<span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></div><div class="line">			<span class="comment">// due to an app switch, ANR, or some other state change.</span></div><div class="line">			cancelAndClearTouchTargets(ev);</div><div class="line">			resetTouchState();</div><div class="line">			<span class="comment">// 如果是`Down`，那么`mFirstTouchTarget`到这里肯定是`null`.因为是新一系列手势的开始。</span></div><div class="line">			<span class="comment">// `mFirstTouchTarget`是处理第一个事件的目标。</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 检查是否拦截该事件(如果`onInterceptTouchEvent()`返回true就拦截该事件)</span></div><div class="line">		<span class="comment">// Check for interception.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line">		<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">				|| mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 标记事件不允许被拦截， 默认是`false`， 该值可以通过`requestDisallowInterceptTouchEvent(true)`方法来设置，</span></div><div class="line">			<span class="comment">// 通知父`View`不要拦截该`View`上的事件。</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line">				<span class="comment">// 判断该`ViewGroup`是否要拦截该事件。`onInterceptTouchEvent()`方法默认返回`false`即不拦截。</span></div><div class="line">				intercepted = onInterceptTouchEvent(ev);</div><div class="line">				ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// 子`View`通知父`View`不要拦截。这样就不会走到上面`onInterceptTouchEvent()`方法中了，</span></div><div class="line">				<span class="comment">// 所以父`View`就不会拦截该事件。</span></div><div class="line">				intercepted = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 注释比较清楚了，就是没有目标来处理该事件，而且也不是一个新的事件`Down`事件(新事件的开始), </span></div><div class="line">			<span class="comment">// 我们应该拦截下他。</span></div><div class="line">			<span class="comment">// There are no touch targets and this action is not an initial down</span></div><div class="line">			<span class="comment">// so this view group continues to intercept touches.</span></div><div class="line">			intercepted = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Check for cancelation.检查当前是否是`Cancel`事件或者是有`Cancel`标记。</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</div><div class="line">				|| actionMasked == MotionEvent.ACTION_CANCEL;</div><div class="line"></div><div class="line">		<span class="comment">// Update list of touch targets for pointer down, if needed. 这行代码为是否需要将当前的触摸事件分发给多个子`View`，</span></div><div class="line">		<span class="comment">// 默认为`true`，分发给多个`View`（比如几个子`View`位置重叠）。默认是true</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 保存当前要分发给的目标</span></div><div class="line">		TouchTarget newTouchTarget = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 如果没取消也不拦截，进入方法内部</span></div><div class="line">		<span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line">		</div><div class="line">			<span class="comment">// 下面这部分代码的意思其实就是找到该事件位置下的`View`(可见或者是在动画中的View), 并且与`pointID`关联。</span></div><div class="line">			<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">					|| (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</div><div class="line">					|| actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</div><div class="line">						: TouchTarget.ALL_POINTER_IDS;</div><div class="line"></div><div class="line">				<span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></div><div class="line">				<span class="comment">// have become out of sync.</span></div><div class="line">				removePointersFromTouchTargets(idBitsToAssign);</div><div class="line"></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">					<span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line">					<span class="comment">// Find a child that can receive the event.</span></div><div class="line">					<span class="comment">// Scan children from front to back.</span></div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</div><div class="line">					<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">							&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">					<span class="comment">// 遍历找子`View`进行分发了。</span></div><div class="line">					<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</div><div class="line">								? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">						<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">								? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">								</div><div class="line">						<span class="comment">// `canViewReceivePointerEvents()`方法会去判断这个`View`是否可见或者在播放动画，</span></div><div class="line">						<span class="comment">// 只有这两种情况下可以接受事件的分发</span></div><div class="line">						</div><div class="line">						<span class="comment">// `isTransformedTouchPointInView`判断这个事件的坐标值是否在该`View`内。</span></div><div class="line">						<span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line">								|| !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line">							<span class="keyword">continue</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="comment">// 找到该`View`对应的在`mFristTouchTarget`中的存储的目标， 判断这个`View`可能已经不是之前`mFristTouchTarget`中的`View`了。</span></div><div class="line">						<span class="comment">// 如果找不到就返回null, 这种情况是用于多点触摸， 比如在同一个`View`上按下了多跟手指。</span></div><div class="line">						newTouchTarget = getTouchTarget(child);</div><div class="line">						<span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Child View已经接受了这个事件了</span></div><div class="line">							<span class="comment">// Child is already receiving touch within its bounds.</span></div><div class="line">							<span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></div><div class="line">							newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">							<span class="comment">// 找到该View了，不用再循环找了</span></div><div class="line">							<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						resetCancelNextUpFlag(child);</div><div class="line">						<span class="comment">// 如果上面没有break，只有newTouchTarget为null，说明上面我们找到的Child View和之前的肯定不是同一个了， </span></div><div class="line">						<span class="comment">// 是新增的， 比如多点触摸的时候，一个手指按在了这个`View`上，另一个手指按在了另一个`View`上。</span></div><div class="line">						<span class="comment">// 这时候我们就看child是否分发该事件。dispatchTransformedTouchEvent如果child为null，就直接该ViewGroup出来事件</span></div><div class="line">						<span class="comment">// 如果child不为null，就调用child.dispatchTouchEvent</span></div><div class="line">						<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">							<span class="comment">// 如果这个Child View能分发，那我们就要把之前存储的值改变成现在的Child View。</span></div><div class="line">							<span class="comment">// Child wants to receive touch within its bounds.</span></div><div class="line">							mLastTouchDownTime = ev.getDownTime();</div><div class="line">							<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</div><div class="line">								<span class="comment">// childIndex points into presorted list, find original index</span></div><div class="line">								<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</div><div class="line">									<span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</div><div class="line">										mLastTouchDownIndex = j;</div><div class="line">										<span class="keyword">break</span>;</div><div class="line">									&#125;</div><div class="line">								&#125;</div><div class="line">							&#125; <span class="keyword">else</span> &#123;</div><div class="line">								mLastTouchDownIndex = childIndex;</div><div class="line">							&#125;</div><div class="line">							mLastTouchDownX = ev.getX();</div><div class="line">							mLastTouchDownY = ev.getY();</div><div class="line">							<span class="comment">// 赋值成现在的Child View对应的值，并且会把`mFirstTouchTarget`也改成该值(mFristTouchTarget`与`newTouchTarget`是一样的)。</span></div><div class="line">							newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">							<span class="comment">// 分发给子`View`了，不用再继续循环了</span></div><div class="line">							alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line">							<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// `newTouchTarget == null`就是没有找到新的可以分发该事件的子`View`，那我们只能用上一次的分发对象了。</span></div><div class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Did not find a child to receive the event.</span></div><div class="line">					<span class="comment">// Assign the pointer to the least recently added target.</span></div><div class="line">					newTouchTarget = mFirstTouchTarget;</div><div class="line">					<span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</div><div class="line">						newTouchTarget = newTouchTarget.next;</div><div class="line">					&#125;</div><div class="line">					newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// DOWN事件在上面会去找touch target</span></div><div class="line">		<span class="comment">// Dispatch to touch targets.</span></div><div class="line">		<span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// dispatchTransformedTouchEvent方法中如果child为null，那么就调用super.dispatchTouchEvent(transformedEvent);否则调用child.dispatchTouchEvent(transformedEvent)。</span></div><div class="line">			<span class="comment">// `super.dispatchTouchEvent()`也就是说，此时`Viewgroup`处理`touch`消息跟普通`view`一致。普通`View`类内部会调用`onTouchEvent()`方法</span></div><div class="line">			<span class="comment">// No touch targets so treat this as an ordinary view. 自己处理</span></div><div class="line">			handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</div><div class="line">					TouchTarget.ALL_POINTER_IDS);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 分发</span></div><div class="line">			<span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></div><div class="line">			<span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></div><div class="line">			TouchTarget predecessor = <span class="keyword">null</span>;</div><div class="line">			TouchTarget target = mFirstTouchTarget;</div><div class="line">			<span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> TouchTarget next = target.next;</div><div class="line">				<span class="comment">// 找到了新的子`View`，并且这个是新加的对象，上面已经处理过了。</span></div><div class="line">				<span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">					handled = <span class="keyword">true</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// 否则都调用dispatchTransformedTouchEvent处理，传递给child</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</div><div class="line">							|| intercepted;</div><div class="line">							</div><div class="line">					<span class="comment">// 正常分发</span></div><div class="line">					<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">							target.child, target.pointerIdBits)) &#123;</div><div class="line">						handled = <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">					<span class="comment">// 如果是onInterceptTouchEvent返回true就会遍历mFirstTouchTarget全部给销毁，这就是为什么onInterceptTouchEvent返回true，之后所有的时间都不会再继续分发的了。</span></div><div class="line">					<span class="keyword">if</span> (cancelChild) &#123;</div><div class="line">						<span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</div><div class="line">							mFirstTouchTarget = next;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							predecessor.next = next;</div><div class="line">						&#125;</div><div class="line">						target.recycle();</div><div class="line">						target = next;</div><div class="line">						<span class="keyword">continue</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				predecessor = target;</div><div class="line">				target = next;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Update list of touch targets for pointer up or cancel, if needed.</span></div><div class="line">		<span class="keyword">if</span> (canceled</div><div class="line">				|| actionMasked == MotionEvent.ACTION_UP</div><div class="line">				|| actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">			resetTouchState();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</div><div class="line">			<span class="comment">// 当某个手指抬起的时候，清除他相关的数据。</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> idBitsToRemove = <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex);</div><div class="line">			removePointersFromTouchTargets(idBitsToRemove);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div><div class="line">```   </div><div class="line"></div><div class="line">接下来还要说说`dispatchTransformedTouchEvent()`方法，虽然上面也说了大体功能，但是看一下源码能说明另一个问题：   </div><div class="line">```java</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Transforms a motion event into the coordinate space of a particular child view,</div><div class="line"> * filters out irrelevant pointer ids, and overrides its action if necessary.</div><div class="line"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></div><div class="line">		View child, <span class="keyword">int</span> desiredPointerIdBits) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> handled;</div><div class="line"></div><div class="line">	<span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></div><div class="line">	<span class="comment">// or filtering.  The important part is the action, not the contents.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</div><div class="line">	</div><div class="line">	<span class="comment">// 这就是为什么时间被拦截之后，之前处理过该事件的`View`会收到`CANCEL`.</span></div><div class="line">	<span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</div><div class="line">		event.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">		<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">			handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 子`View`去处理，如果子`View`仍然是`ViewGroup`那还是同样的处理，如果子`View`是普通`View`，普通`View`的`dispatchTouchEveent()`会调用`onTouchEvent()`.</span></div><div class="line">			handled = child.dispatchTouchEvent(event);</div><div class="line">		&#125;</div><div class="line">		event.setAction(oldAction);</div><div class="line">		<span class="keyword">return</span> handled;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Calculate the number of pointers to deliver.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> oldPointerIdBits = event.getPointerIdBits();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</div><div class="line"></div><div class="line">	<span class="comment">// If for some reason we ended up in an inconsistent state where it looks like we</span></div><div class="line">	<span class="comment">// might produce a motion event with no pointers in it, then drop the event.</span></div><div class="line">	<span class="keyword">if</span> (newPointerIdBits == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// If the number of pointers is the same and we don't need to perform any fancy</span></div><div class="line">	<span class="comment">// irreversible transformations, then we can reuse the motion event for this</span></div><div class="line">	<span class="comment">// dispatch as long as we are careful to revert any changes we make.</span></div><div class="line">	<span class="comment">// Otherwise we need to make a copy.</span></div><div class="line">	<span class="keyword">final</span> MotionEvent transformedEvent;</div><div class="line">	<span class="keyword">if</span> (newPointerIdBits == oldPointerIdBits) &#123;</div><div class="line">		<span class="keyword">if</span> (child == <span class="keyword">null</span> || child.hasIdentityMatrix()) &#123;</div><div class="line">			<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">				handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</div><div class="line">				event.offsetLocation(offsetX, offsetY);</div><div class="line"></div><div class="line">				handled = child.dispatchTouchEvent(event);</div><div class="line"></div><div class="line">				event.offsetLocation(-offsetX, -offsetY);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> handled;</div><div class="line">		&#125;</div><div class="line">		transformedEvent = MotionEvent.obtain(event);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		transformedEvent = event.split(newPointerIdBits);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Perform any necessary transformations and dispatch.</span></div><div class="line">	<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">		handled = <span class="keyword">super</span>.dispatchTouchEvent(transformedEvent);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</div><div class="line">		transformedEvent.offsetLocation(offsetX, offsetY);</div><div class="line">		<span class="keyword">if</span> (! child.hasIdentityMatrix()) &#123;</div><div class="line">			transformedEvent.transform(child.getInverseMatrix());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		handled = child.dispatchTouchEvent(transformedEvent);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Done.</span></div><div class="line">	transformedEvent.recycle();</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲了<code>ViewGroup</code>的<code>dispatchTouchEveent()</code>有些地方会调用<code>super.dispatchTouchEveent()</code>，而<code>ViewGroup</code>的父类就是<code>View</code>，接下来我们看一下<code>View.dispatchTouchEveent()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Pass the touch screen motion event down to the target view, or this</div><div class="line"> * view if it is the target.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> event The motion event to be dispatched.</div><div class="line"> * <span class="doctag">@return</span> True if the event was handled by the view, false otherwise.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">// 调试用</span></div><div class="line">	<span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		<span class="comment">// Defensive cleanup for new gesture</span></div><div class="line">		stopNestedScroll();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 判断该`View`是否被其它`View`遮盖住。</span></div><div class="line">	<span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">		<span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line">				&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">				&amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">			<span class="comment">// 先执行`listener`.</span></div><div class="line">			result = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">			<span class="comment">// 执行`onTouchEvent()`.</span></div><div class="line">			result = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></div><div class="line">	<span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span></div><div class="line">	<span class="comment">// of the gesture.</span></div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||</div><div class="line">			actionMasked == MotionEvent.ACTION_CANCEL ||</div><div class="line">			(actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</div><div class="line">		stopNestedScroll();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过上面的分析我们看到<code>View.dispatchTouchEvent()</code>里面会调用到<code>onTouchEvent()</code>来消耗事件。那么<code>onTouchEvent()</code>是如何处理的呢？下面我们看一下<br><code>View.onTouchEvent()</code>源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this method to handle touch screen motion events.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is used to detect click actions, it is recommended that</div><div class="line"> * the actions be performed by implementing and calling</div><div class="line"> * &#123;<span class="doctag">@link</span> #performClick()&#125;. This will ensure consistent system behavior,</div><div class="line"> * including:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> * &lt;li&gt;obeying click sound preferences</div><div class="line"> * &lt;li&gt;dispatching OnClickListener calls</div><div class="line"> * &lt;li&gt;handling &#123;<span class="doctag">@link</span> AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</div><div class="line"> * accessibility features are enabled</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> event The motion event.</div><div class="line"> * <span class="doctag">@return</span> True if the event was handled, false otherwise.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line"></div><div class="line">	<span class="comment">// 对disable按钮的处理，注释说的比较明白，一个disable但是clickable的view仍然会消耗事件,只是不响应而已。</span></div><div class="line">	<span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">		<span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">			setPressed(<span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">		<span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">		<span class="keyword">return</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">				(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 关于TouchDelegate,文档中是这样说的The delegate to handle touch events that are physically in this view</span></div><div class="line">    <span class="comment">// but should be handled by another view. 就是说如果两个View, View2在View1中，View1比较大，如果我们想点击</span></div><div class="line">	<span class="comment">// View1的时候，让View2去响应点击事件，这时候就需要使用TouchDelegate来设置。</span></div><div class="line">	<span class="comment">// 简单的理解就是如果这个View有自己的时间委托处理人，就交给委托人处理。</span></div><div class="line">	<span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">			(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)) &#123;</div><div class="line">	    <span class="comment">// 这个View可点击</span></div><div class="line">		<span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">			    <span class="comment">// 最好先看DOWN后再看MOVE最后看UP。</span></div><div class="line">				<span class="comment">// PFLAG_PREPRESSED 表示在一个可滚动的容器中,要稍后才能确定是按下还是滚动.</span></div><div class="line">                <span class="comment">// PFLAG_PRESSED 表示不是在一个可滚动的容器中,已经可以确定按下这一操作.</span></div><div class="line">				<span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</div><div class="line">				<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</div><div class="line">					<span class="comment">// 处理点击或长按事件</span></div><div class="line">					<span class="comment">// take focus if we don't have it already and we should in</span></div><div class="line">					<span class="comment">// touch mode.</span></div><div class="line">					<span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</div><div class="line">					<span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) </div><div class="line">						<span class="comment">// 如果现在还没获取到焦点，就再获取一次焦点</span></div><div class="line">						focusTaken = requestFocus();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">// 在前面`DOWN`事件的时候会延迟显示`View`的`pressed`状态,用户可能在我们还没有显示按下状态效果时就不按了.我们还是得在进行实际的点击操作时,让用户看到效果。</span></div><div class="line">					<span class="keyword">if</span> (prepressed) &#123;</div><div class="line">						<span class="comment">// The button is being released before we actually</span></div><div class="line">						<span class="comment">// showed it as pressed.  Make it show the pressed</span></div><div class="line">						<span class="comment">// state now (before scheduling the click) to ensure</span></div><div class="line">						<span class="comment">// the user sees it.</span></div><div class="line">						setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">				   &#125;</div><div class="line">					</div><div class="line">					</div><div class="line">					<span class="keyword">if</span> (!mHasPerformedLongPress) &#123;</div><div class="line">						<span class="comment">// 判断不是长按</span></div><div class="line">						</div><div class="line">						<span class="comment">// This is a tap, so remove the longpress check</span></div><div class="line">						removeLongPressCallback();</div><div class="line"></div><div class="line">						<span class="comment">// Only perform take click actions if we were in the pressed state</span></div><div class="line">						<span class="keyword">if</span> (!focusTaken) &#123;</div><div class="line">							<span class="comment">// Use a Runnable and post this rather than calling</span></div><div class="line">							<span class="comment">// performClick directly. This lets other visual state</span></div><div class="line">							<span class="comment">// of the view update before click actions start.</span></div><div class="line">							<span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</div><div class="line">								mPerformClick = <span class="keyword">new</span> PerformClick();</div><div class="line">							&#125;</div><div class="line">							<span class="comment">// PerformClick就是个Runnable,里面执行performClick()方法。performClick()方法中怎么执行呢？我们在后面再说。</span></div><div class="line">							<span class="keyword">if</span> (!post(mPerformClick)) &#123;</div><div class="line">								performClick();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</div><div class="line">						mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</div><div class="line">					&#125;</div><div class="line">					<span class="comment">// 取消按下状态，UnsetPressedState也是个Runnable,里面执行setPressed(false)</span></div><div class="line">					<span class="keyword">if</span> (prepressed) &#123;</div><div class="line">						postDelayed(mUnsetPressedState,</div><div class="line">								ViewConfiguration.getPressedStateDuration());</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</div><div class="line">						<span class="comment">// If the post failed, unpress right now</span></div><div class="line">						mUnsetPressedState.run();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					removeTapCallback();</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">				mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line">				<span class="comment">// performButtonActionOnTouchDown()处理鼠标右键菜单，有些View显示右键菜单就直接弹菜单.一般设备用不到鼠标，所以返回false。</span></div><div class="line">				<span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// Walk up the hierarchy to determine if we're inside a scrolling container.</span></div><div class="line">				<span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</div><div class="line"></div><div class="line">				<span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></div><div class="line">				<span class="comment">// a short period in case this is a scroll.</span></div><div class="line">				<span class="comment">// 就是遍历下View层级，判断这个View是不是在一个能scroll的View中。</span></div><div class="line">				<span class="keyword">if</span> (isInScrollingContainer) &#123;</div><div class="line">				    <span class="comment">// 因为用户可能是点击或者是滚动，所以我们不能立马判断，先给用户设置一个要点击的事件。</span></div><div class="line">					mPrivateFlags |= PFLAG_PREPRESSED;</div><div class="line">					<span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</div><div class="line">						mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</div><div class="line">					&#125;</div><div class="line">					mPendingCheckForTap.x = event.getX();</div><div class="line">					mPendingCheckForTap.y = event.getY();</div><div class="line">					<span class="comment">// 发送一个延时的操作，用于判断用户到底是点击还是滚动。其实就是在tapTimeout中如果用户没有滚动，那就是点击了。</span></div><div class="line">					postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">				    <span class="comment">// 设置成点击状态</span></div><div class="line">					<span class="comment">// Not inside a scrolling container, so show the feedback right away</span></div><div class="line">					setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">					<span class="comment">// 检查是否是长按，就是过一段时间后如果还在按住，那就是长按了。长按的时间是ViewConfiguration.getLongPressTimeout()</span></div><div class="line">					<span class="comment">// 也就是500毫秒</span></div><div class="line">					checkForLongClick(<span class="number">0</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">				<span class="comment">// 取消按下状态，移动点击消息，移动长按消息。</span></div><div class="line">				setPressed(<span class="keyword">false</span>);</div><div class="line">				removeTapCallback();</div><div class="line">				removeLongPressCallback();</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">				drawableHotspotChanged(x, y);</div><div class="line">				</div><div class="line">				<span class="comment">// Be lenient about moving outside of buttons， 检查是否移动到View外面了。</span></div><div class="line">				<span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">				    <span class="comment">// 移动到区域外面去了，就要取消点击。</span></div><div class="line">					<span class="comment">// Outside button</span></div><div class="line">					removeTapCallback();</div><div class="line">					<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">						<span class="comment">// Remove any future long press/tap checks</span></div><div class="line">						removeLongPressCallback();</div><div class="line"></div><div class="line">						setPressed(<span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲了<code>Touch</code>事件的分发和处理，随便说一下点击事件:<br>我们平时使用的时候都知道给<code>View</code>设置点击事件是<code>setOnClickListener()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Register a callback to be invoked when this view is clicked. If this view is not</div><div class="line"> * clickable, it becomes clickable.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l The callback that will run</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #setClickable(boolean)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(OnClickListener l)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!isClickable()) &#123;</div><div class="line">		setClickable(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// `getListenerInfo()`就是判断成员变量`mListenerInfo`是否是null，不是就返回，是的话就初始化一个。</span></div><div class="line">	getListenerInfo().mOnClickListener = l;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那什么地方会调用<code>mListenerInfo.mOnClickListener</code>呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Call this view's OnClickListener, if it is defined.  Performs all normal</div><div class="line"> * actions associated with clicking: reporting accessibility event, playing</div><div class="line"> * a sound, etc.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> True there was an assigned OnClickListener that was called, false</div><div class="line"> *         otherwise is returned.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> result;</div><div class="line">	<span class="keyword">final</span> ListenerInfo li = mListenerInfo;</div><div class="line">	<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">		playSoundEffect(SoundEffectConstants.CLICK);</div><div class="line">		li.mOnClickListener.onClick(<span class="keyword">this</span>);</div><div class="line">		result = <span class="keyword">true</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		result = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>讲到这里就明白了。<code>onTouchEvent()</code>中的<code>ACTION_UP</code>中会调用<code>performClick()</code>方法。</p>
<p>到这里，就全部分析完了，这一块还是比较麻烦的，中间查了很多资料，有些地方自己可能也理解的不太对，如果有哪里理解的不对的地方，还请大家指出来。谢谢。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android Touch事件分发详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android6.0权限系统" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android6.0权限系统/">Android6.0权限系统</a>
    </h1>
  

        
        <a href="/2015/01/01/Android6.0权限系统/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android6-0权限系统"><a href="#Android6-0权限系统" class="headerlink" title="Android6.0权限系统"></a>Android6.0权限系统</h1><p><code>Android</code>权限系统是一个非常重要的安全问题，因为它只有在安装时会询问一次。一旦软件本安装之后，应用程序可以在用户毫不知情的情况下使用这些权限来获取所有的内容。     </p>
<p>很多坏蛋会通过这个安全缺陷来收集用户的个人信息并使用它们来做坏事的情况就不足为奇了。    </p>
<p><code>Android</code>团队也意识到了这个问题。在经过了7年后，权限系统终于被重新设置了。从<code>Anroid 6.0(API Level 23)</code>开始，应用程序在安装时不会被授予任何权限，取而代之的是在运行时应用回去请求用户授予对应的权限。这样可以让用户能更好的去控制应用功能。例如，一个用户可能会同一个拍照应用使用摄像头的权限，但是不同授权它获取设备位置的权限。用户可以在任何时候通过去应用的设置页面来撤销授权。    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/runtimepermission.jpg?raw=true" alt="image">  </p>
<p><strong>注意:</strong>上面请求权限的对话框不会自动弹出。开发者需要手动的调用。如果开发者调用了一些需要权限的功能，但是用户又拒绝授权的话，应用就会<code>crash</code>。   </p>
<p>系统权限被分为两类，<code>normal</code>和<code>dangerous</code>:    </p>
<ul>
<li><code>Normal Permissions</code>不需要用户直接授权，如果你的应用在清单文件中声明了Normal Permissions`，系统会自动授权该权限。    </li>
<li><code>Dangerous Permissions</code>可以让应用获取用户的私人数据。如果你的应用在清单文件中申请了<code>Dangerous Permissions</code>，那就必须要用户来授权给应用。   </li>
</ul>
<p><code>Normal Permissions</code>:<br><code>Normal Permission</code>是当用户安装或更新应用时，系统将授予应用所请求的权限，又称为<code>PROTECTION_NORMAL</code>（安装时授权的一类基本权限）。该类权限只需要在<code>manifest</code>文件中声明即可，安装时就授权，不需要每次使用时进行检查，而且用户不能取消以上授权。   </p>
<ul>
<li>ACCESS_LOCATION_EXTRA_COMMANDS</li>
<li>ACCESS_NETWORK_STATE</li>
<li>ACCESS_NOTIFICATION_POLICY</li>
<li>ACCESS_WIFI_STATE</li>
<li>BLUETOOTH</li>
<li>BLUETOOTH_ADMIN</li>
<li>BROADCAST_STICKY</li>
<li>CHANGE_NETWORK_STATE</li>
<li>CHANGE_WIFI_MULTICAST_STATE</li>
<li>CHANGE_WIFI_STATE</li>
<li>DISABLE_KEYGUARD</li>
<li>EXPAND_STATUS_BAR</li>
<li>GET_PACKAGE_SIZE</li>
<li>INSTALL_SHORTCUT</li>
<li>INTERNET</li>
<li>KILL_BACKGROUND_PROCESSES</li>
<li>MODIFY_AUDIO_SETTINGS</li>
<li>NFC</li>
<li>READ_SYNC_SETTINGS</li>
<li>READ_SYNC_STATS</li>
<li>RECEIVE_BOOT_COMPLETED</li>
<li>REORDER_TASKS</li>
<li>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</li>
<li>REQUEST_INSTALL_PACKAGES</li>
<li>SET_ALARM</li>
<li>SET_TIME_ZONE</li>
<li>SET_WALLPAPER</li>
<li>SET_WALLPAPER_HINTS</li>
<li>TRANSMIT_IR</li>
<li>UNINSTALL_SHORTCUT</li>
<li>USE_FINGERPRINT</li>
<li>VIBRATE</li>
<li>WAKE_LOCK</li>
<li>WRITE_SYNC_SETTINGS</li>
</ul>
<p>下图为<code>Dangerous permissions and permission groups</code>:  </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/permgroup.png?raw=true" alt="image">     </p>
<p>在所有的<code>Android</code>版本中，你的应用都需要在<code>manifest</code>文件中声明<code>normal</code>和<code>dangerous</code>权限。然而声明所影响的效果会因系统版本和你应用的<code>target SDK lever</code>有关:     </p>
<ul>
<li>如果设备运行的是<code>Android 5.1</code>或者之前的系统，或者应用的<code>targetSdkVersion</code>是22或者之前版本：如果你在<code>manifest</code>中声明了<code>dangerous permission</code>，用户需要在安装应用时授权这些权限。如果用户不授权这些权限，系统就不会安装该应用。(我试了下发现即使<code>targetSdkVersion</code>是22及以下，在6.0的手机上时，如果你安装时你不同意一些权限，也仍然可以安装的)  </li>
<li>如果设备运行的是<code>Android 6.0</code>或者更高的系统，并且你应用的<code>targetSdkVersion</code>是23或者更高:应用必须在<code>manifest</code>文件中申请这些权限，而且必须要在运行时对所需要的<code>dangerous permission</code>申请授权。用户可以统一或者拒绝授权，并且及时用户拒绝了授权，应用在无法使用一些功能的情况下也要保证能继续运行。     </li>
</ul>
<p>也就是说新的运行时权限仅当我们设置<code>targetSdkVersion</code>是23及以上时才会起作用。<br>如果你的<code>targtSdkVersion</code>低于23，那将被认为该应用没有经过<code>android 6.0</code>的测试，当该应用被安装到了6.0的手机上时，仍然会使用之前的旧权限规则，在安装时会提示所有需要的权限(这样做是有道理的，不然对于之前开发的应用，我们都要立马去修改让它适应6.0，来不及的话就导致6.0的手机都无法使用了，显然Android开发团队不会考虑不到这种情况)，当然用户可以在安装的界面不允许一些权限，那当程序使用到了这些权限时，会崩溃吗？答案是在<code>Android 6.0</code>及以上的手机会直接<code>crash</code>，但是在<code>23</code>之前的手机上不会<code>crash</code>。     </p>
<p>所以如果你的应用没有支持运行时权限的功能，那千万不要讲<code>targetSdkVersion</code>设置为23，否则就麻烦了。  </p>
<blockquote>
<p><strong><em>注意:</em></strong>从<code>Android 6.0(API Level 23)</code>开始，即使应用的<code>targetSdkVersion</code>是比较低的版本，但是用户仍然可以在任何时候撤销对应用的授权。所以不管应用的<code>targetSdkVerison</code>是什么版本，你都要测试你的应用在不能获取权限时能不能正常运行。 </p>
</blockquote>
<p>下面介绍下如何使用<code>Android Support Library</code>来检查和请求权限。<code>Android</code>框架在<code>6.0</code>开始也提供了相同的方法。然而使用<code>support</code>包会比较简单，因为这样你就不需要在请求方法时判断当前的系统版本。(后面说的这几个类都是<code>android.support.v4</code>中的)    </p>
<p>###检查权限    </p>
<p>如果应用需要使用<code>dangerous permission</code>，在任何时候执行需要该权限的操作时你都需要检查是否已经授权。用户可能会经常取消授权，所以即使昨天应用已经使用了摄像头，这也不能保证今天仍然有使用摄像头的权限。    </p>
<p>为了检查是否可以使用该权限，调用<code>ContextCompat.checkSelfPermission()</code>。<br>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Assume thisActivity is the current activity</span></div><div class="line"><span class="keyword">int</span> permissionCheck = ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">        Manifest.permission.WRITE_CALENDAR);</div></pre></td></tr></table></figure></p>
<p>如果应用有该权限，该方法将返回<code>PackageManager.PERMISSION_GRANTED</code>，应用可以进行相关的操作。如果应用不能使用该权限，该方法将返回<code>PERMISSION_DENIED</code>，这是应用将必须要向用户申请该权限。    </p>
<p>###申请使用权限</p>
<p>如果应用需要使用清单文件中申明的<code>dangerous permission</code>，它必须要向用户申请来授权。<code>Android</code>提供了几种申请授权的方法。使用这些方法时将会弹出一个标准的系统对话框，该对话框不能自定义。     </p>
<p>#####说明为什么应用需要使用这些权限      </p>
<p>在一些情况下，你可能需要帮助用力理解为什么需要该权限。例如，一个用户使用了一个照相的应用，用户不会奇怪为什么应用申请使用摄像头的权限，但是用户可能会不理解为什么应用需要获取位置或者联系人的权限。在请求一个权限之前，你需要该用户一个说明。一定要切记不要通过说明来压倒用户。如果你提供了太多的说明，用户可能会感觉沮丧并且会卸载它。   </p>
<p>一个你需要提供说明的合适时机就是在用户之前已经不同意授权该权限的情况下。如果一个用户继续尝试使用需要权限的功能时，但是之前确禁止了该权限的请求，这就可能是因为用户不理解为什么该功能需要使用该权限。在这种情况下，提供一个说明是非常合适的。  </p>
<p>为了能找到用户可能需要说明的情况，<code>android</code>提供了一个工具类方法<code>ActivityCompat.shouldShowRequestPermissionRationale().</code>。如果应用之前申请了该权限但是用户拒绝授权后该方法会返回<code>true</code>。(在Android 6.0之前调用的时候会直接返回false)     </p>
<blockquote>
<p><strong><em>注意：</em></strong>如果用户之前拒绝了权限申请并且选择了请求权限对话框中的<code>Don’t ask again</code>选项，该方法就会返回<code>false</code>。如果设备策略禁止了该应用使用该权限，该方法也会返回<code>false</code>。(我测试的时候发现请求权限的对话框中并没有<code>Don’t asdk again</code>这一项)<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/request_permission_dialog.png?raw=true" alt="image">      </p>
</blockquote>
<p>#####申请需要的权限      </p>
<p>如果应用没有所需的权限时，应用必须调用<code>ActivityCompat.requestPermissions (Activity activity, 
                String[] permissions, 
                int requestCode)</code>方法来申请对用的权限。参数传递对应所需的权限以及一个整数型的<code>request code</code>来标记该权限申请。 该方法是异步的:该方法会立即返回，在用户响应了请求权限的对话框之后，系统会调用对用的回调方法来通知结果，并且会传递在<code>reqeustPermissions()</code>方法中的<code>request code</code>。(在Android 6.0之前调用的时候会直接去调用<code>onRequestPermissionsResult()</code>的回调方法)<br>如图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/requestpermission.jpg?raw=true" alt="image">  </p>
<p>下面是检查是否读取联系人权限，并且在必要时申请权限的代码:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Here, thisActivity is the current activity</span></div><div class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">                Manifest.permission.READ_CONTACTS)</div><div class="line">        != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Should we show an explanation?</span></div><div class="line">    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(thisActivity,</div><div class="line">            Manifest.permission.READ_CONTACTS)) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Show an expanation to the user *asynchronously* -- don't block</span></div><div class="line">        <span class="comment">// this thread waiting for the user's response! After the user</span></div><div class="line">        <span class="comment">// sees the explanation, try again to request the permission.</span></div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// No explanation needed, we can request the permission.</span></div><div class="line"></div><div class="line">        ActivityCompat.requestPermissions(thisActivity,</div><div class="line">                <span class="keyword">new</span> String[]&#123;Manifest.permission.READ_CONTACTS&#125;,</div><div class="line">                MY_PERMISSIONS_REQUEST_READ_CONTACTS);</div><div class="line"></div><div class="line">        <span class="comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span></div><div class="line">        <span class="comment">// app-defined int constant. The callback method gets the</span></div><div class="line">        <span class="comment">// result of the request.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong><em>注意：</em></strong>当调用<code>requestPermissions()</code>方法时，系统会显示一个标准的对话框。应用不能指定或者改变该对话框。如果你想提供一些信息或者说明给用户，你需要在调用<code>requestPermissions()</code>之前处理。    </p>
</blockquote>
<p>#####处理请求权限的的结果     </p>
<p>如果应用申请权限，系统会显示一个对话框。当用户相应后，系统会调用应用中的<code>onRequestPermissionsResult (int requestCode, 
                String[] permissions, 
                int[] grantResults)</code>方法并传递用户的操作结果。在应用中必须要重写该方法来查找授权了什么权限。该回调方法会传递你在<code>requestPermisssions()</code>方法中传递的<code>request code</code>。直接在<code>Activity</code>或者<code>Fragment</code>中重写<code>onRequestPermissionsResult()</code>方法即可。例如，申请<code>READ_CONTACTS</code>的权限可能会有下面的回到方法:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode,</span></span></div><div class="line">        String permissions[], <span class="keyword">int</span>[] grantResults) &#123;</div><div class="line">    <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">        <span class="keyword">case</span> MY_PERMISSIONS_REQUEST_READ_CONTACTS: &#123;</div><div class="line">            <span class="comment">// If request is cancelled, the result arrays are empty.</span></div><div class="line">            <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span></div><div class="line">                &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission was granted, yay! Do the</span></div><div class="line">                <span class="comment">// contacts-related task you need to do.</span></div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission denied, boo! Disable the</span></div><div class="line">                <span class="comment">// functionality that depends on this permission.</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// other 'case' lines to check for other</span></div><div class="line">        <span class="comment">// permissions this app might request</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>系统提示的对话框会描述应用所需的<code>permission groud</code>。它不会列出特定的权限。例如，如果你申请了<code>READ_CONTACTS</code>权限，系统的对话框只会说你的应用需要获取设备的联系人信息。用户只需要授权每个<code>permission group</code>一次。如果你应用需要申请其他任何一个在该<code>permission group</code>中的权限时，系统会自动授权。在申请这些授权时，系统会像用户明确通过系统对话框统一授权时一样去调用<code>onRequestPermissionsResult()</code>方法并且传递<code>PERMISSION_GRANTED</code>参数。    </p>
<blockquote>
<p><strong><em>注意：</em></strong>虽然用户已经授权了同一<code>permission group</code>中其他的任何权限，但是应用仍然需要明确申请每个需要的权限。例外，<code>permission group</code>中的权限在以后可能会发生变化。    </p>
</blockquote>
<p>例如，假设在应用的<code>manifest</code>文件中同时声明了<code>READ_CONTACTS</code>和<code>WRITE_CONTACTS</code>权限。如果你申请<code>READ_CONTACTS</code>权限而且用户同意了该权限，如果你想继续申请<code>WRITE_CONTACTS</code>权限，系统不会与用户有任何交互就会直接进行授权。     </p>
<p>如果用户拒绝了一个权限申请，你的应用进行合适的处理。例如，你的应用可能显示一个对话框来表明无法执行用户请求的需要该权限的操作。</p>
<p>如果系统向用户申请权限授权，用户选择了让系统以后不要再申请该权限。 在这种情况下，应用在任何时间调用<code>reqeustPermissions()</code>方法来再次申请权限时，系统都会直接拒绝该请求。系统会直接调用<code>onRequestPermissionResult()</code>回调方法并且传递<code>PERMISSION_DENIED</code>参数，和用户明确拒绝应用申请该权限时一样。 这就意味着在你调用<code>requestPermissions()</code>方法是，你无法确定是否会和用户有直接的交互操作。   </p>
<p>示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">int</span> REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS = <span class="number">124</span>;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertDummyContactWrapper</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; permissionsNeeded = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">  </div><div class="line">    <span class="keyword">final</span> List&lt;String&gt; permissionsList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.ACCESS_FINE_LOCATION))</div><div class="line">        permissionsNeeded.add(<span class="string">"GPS"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.READ_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Read Contacts"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.WRITE_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Write Contacts"</span>);</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (permissionsList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (permissionsNeeded.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Need Rationale</span></div><div class="line">            String message = <span class="string">"You need to grant access to "</span> + permissionsNeeded.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; permissionsNeeded.size(); i++)</div><div class="line">                message = message + <span class="string">", "</span> + permissionsNeeded.get(i);</div><div class="line">            showMessageOKCancel(message,</div><div class="line">                    <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                            requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                                    REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    insertDummyContact();</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addPermission</span><span class="params">(List&lt;String&gt; permissionsList, String permission)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (checkSelfPermission(permission) != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">        permissionsList.add(permission);</div><div class="line">        <span class="comment">// Check for Rationale Option</span></div><div class="line">        <span class="keyword">if</span> (!shouldShowRequestPermissionRationale(permission))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲到的都是<code>Activity</code>中的使用方法，那<code>Fragment</code>中怎么授权呢？<br>如果在<code>Fragment</code>中使用，用<code>v13</code>包中的<code>FragmentCompat.requestPermissions()</code>和<code>FragmentCompat.shouldShowRequestPermissionRationale()</code>。 </p>
<p>在<code>Fragment</code>中申请权限，不要使用<code>ActivityCompat.requestPermissions</code>, 直接使用<code>Fragment.requestPermissions</code>方法，<br>否则会回调到<code>Activity</code>的<code>onRequestPermissionsResult</code>。但是虽然你使用<code>Fragment.requestPermissions</code>方法，也照样回调不到<code>Fragment.onRequestPermissionsResult</code>中。这是<code>Android</code>的<code>Bug</code>,<a href="https://code.google.com/p/android/issues/detail?can=2&amp;start=0&amp;num=100&amp;q=&amp;colspec=ID%20Status%20Priority%20Owner%20Summary%20Stars%20Reporter%20Opened&amp;groupby=&amp;sort=&amp;id=189121" target="_blank" rel="external">详见</a>，<code>Google</code>已经在<code>23.3.0</code>修复了该问题，所以要尽快升级。</p>
<p>所以升级到<code>23.3.0</code>及以上就没问题了。如果不升级该怎么处理呢？就是在<code>Activity.onRequestPermissionsResult</code>方法中去手动调用每个<code>Fragment</code>的方法(当然你要判断下权限个数，不然申请一个权限的情况下会重复调用).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">    List&lt;Fragment&gt; fragments = getSupportFragmentManager().getFragments();</div><div class="line">    <span class="keyword">if</span> (fragments != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (Fragment fragment : fragments) &#123;</div><div class="line">            fragment.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我简单的写了一个工具类:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionUtil</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在调用需要权限的功能时使用该方法进行检查。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(activity, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在Actvitiy或者Fragment中重写onRequestPermissionsResult方法后调用该方法。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> grantResults</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(activity, requestCode, permissions, grantResults, iPermission);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String... permission)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String s : permission) &#123;</div><div class="line">            permissions.add(s);</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在检查权限后自己处理权限说明的逻辑后调用该方法，直接申请权限。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> t</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (permissions == <span class="keyword">null</span> || permissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSelfPermission</span><span class="params">(Context context, String permission)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || TextUtils.isEmpty(permission)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params: the params is null !"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        context = context.getApplicationContext();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            <span class="keyword">int</span> result = ContextCompat.checkSelfPermission(context, permission);</div><div class="line">            <span class="keyword">if</span> (PackageManager.PERMISSION_DENIED == result) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">handleRequestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            Activity activity = getActivity(t);</div><div class="line">            List&lt;String&gt; deniedPermissions = getDeniedPermissions(activity, permissions);</div><div class="line">            <span class="keyword">if</span> (deniedPermissions != <span class="keyword">null</span> &amp;&amp; deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                List&lt;String&gt; rationalPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                <span class="keyword">for</span> (String deniedPermission : deniedPermissions) &#123;</div><div class="line">                    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(activity,</div><div class="line">                            deniedPermission)) &#123;</div><div class="line">                        rationalPermissions.add(deniedPermission);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> showRational = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    showRational = iPermission.showRational(requestCode);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (rationalPermissions.size() &gt; <span class="number">0</span> &amp;&amp; showRational) &#123;</div><div class="line">                    <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                        iPermission.onRational(requestCode, deniedPermissions);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    requestPermissions(t, requestCode, deniedPermissions);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    iPermission.onGranted(requestCode);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Activity <span class="title">getActivity</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">        Activity activity = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            activity = (Activity) t;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            activity = ((Fragment) t).getActivity();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            activity = ((android.app.Fragment) t).getActivity();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> activity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.M)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; deniedPermissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions == <span class="keyword">null</span> || deniedPermissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// has denied permissions</span></div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            ((Activity) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            ((Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            ((android.app.Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getDeniedPermissions</span><span class="params">(Context context, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        List&lt;String&gt; denyPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String permission : permissions) &#123;</div><div class="line">            <span class="keyword">if</span> (!checkSelfPermission(context, permission)) &#123;</div><div class="line">                denyPermissions.add(permission);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> denyPermissions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestResult</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                          <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        List&lt;String&gt; deniedPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grantResults.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (grantResults[i] != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">                deniedPermissions.add(permissions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onDenied(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPermission</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否需要提示用户该权限的作用，提示后需要再调用requestPermission()方法来申请。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> true 为提示，false为不提示</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Button mReqCameraBt;</div><div class="line">    <span class="keyword">private</span> Button mReqContactsBt;</div><div class="line">    <span class="keyword">private</span> Button mReqMoreBt;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.fragment_main, container, <span class="keyword">false</span>);</div><div class="line">        findView(view);</div><div class="line">        initView();</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        mReqCameraBt = (Button) view.findViewById(R.id.bt_requestCamera);</div><div class="line">        mReqContactsBt = (Button) view.findViewById(R.id.bt_requestContacts);</div><div class="line">        mReqMoreBt = (Button) view.findViewById(R.id.bt_requestMore);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mReqCameraBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqContactsBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqMoreBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CAMERA = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CONTACTS = <span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_MORE = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        PermissionUtil.onRequestPermissionsResult(<span class="keyword">this</span>, requestCode, permissions, grantResults, mPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestCamera</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CAMERA, mPermission, Manifest.permission.CAMERA);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestReadContacts</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CONTACTS, mPermission, Manifest.permission.READ_CONTACTS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestMore</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_MORE, mPermission, Manifest.permission.READ_CONTACTS, Manifest.permission.READ_CALENDAR, Manifest.permission.CALL_PHONE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPermissionTipDialog</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity());</div><div class="line">        builder.setMessage(<span class="string">"I want you permissions"</span>);</div><div class="line">        builder.setTitle(<span class="string">"Hello Permission"</span>);</div><div class="line">        builder.setPositiveButton(<span class="string">"确认"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">                PermissionUtil.requestPermission(MainFragment.<span class="keyword">this</span>, requestCode, permissions);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.setNegativeButton(<span class="string">"取消"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.create().show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> IPermission mPermission = <span class="keyword">new</span> IPermission() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onGranted :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onDenied :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permission)</span> </span>&#123;</div><div class="line">            showPermissionTipDialog(requestCode, permission);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">                <span class="keyword">case</span> REQUEST_CODE_MORE:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> id = v.getId();</div><div class="line">        <span class="keyword">switch</span> (id) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestCamera:</div><div class="line">                requestCamera();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestContacts:</div><div class="line">                requestReadContacts();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestMore:</div><div class="line">                requestMore();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android6.0权限系统/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-View绘制过程详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/View绘制过程详解/">View绘制过程详解</a>
    </h1>
  

        
        <a href="/2015/01/01/View绘制过程详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="View绘制过程详解"><a href="#View绘制过程详解" class="headerlink" title="View绘制过程详解"></a>View绘制过程详解</h1><p>界面窗口的根布局是<code>DecorView</code>，该类继承自<code>FrameLayout</code>.说到<code>View</code>绘制，想到的就是从这里入手，而<code>FrameLayout</code>继承自<code>ViewGroup</code>。感觉绘制肯定会在<code>ViewGroup</code>或者<code>View</code>中，<br>但是木有找到。发现<code>ViewGroup</code>实现<code>ViewParent</code>接口，而<code>ViewParent</code>有一个实现类是<code>ViewRootImpl</code>， <code>ViewGruop</code>中会使用<code>ViewRootImpl</code>…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The top of a view hierarchy, implementing the needed protocol between View</div><div class="line"> * and the WindowManager.  This is for the most part an internal implementation</div><div class="line"> * detail of &#123;<span class="doctag">@link</span> WindowManagerGlobal&#125;.</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"EmptyCatchBlock"</span>, <span class="string">"PointlessBooleanExpression"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></div><div class="line">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">HardwareRenderer</span>.<span class="title">HardwareDrawCallbacks</span> &#123;</div><div class="line">		</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p><code>View</code>的绘制过程从<code>ViewRootImpl.performTraversals()</code>方法开始。<br>首先先说明一下，这部分代码比较多，逻辑也比较麻烦，很容易弄晕，如果感觉看起来费劲，就跳过这一块，直接到下面的Measure、Layout、Draw部分开始看。<br>我也没有全部弄清楚，我只是把里面的步骤标注了下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// ... 此处省略源代码N行</span></div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Measure</span></div><div class="line">	<span class="keyword">if</span> (!mStopped) &#123;</div><div class="line">		<span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</div><div class="line">				(relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</div><div class="line">		<span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</div><div class="line">				|| mHeight != host.getMeasuredHeight() || contentInsetsChanged) &#123;</div><div class="line">			<span class="comment">// 这里是获取widthMeasureSpec,这俩参数不是一般的尺寸数值，而是将模式和尺寸组合在一起的数值.</span></div><div class="line">			<span class="comment">// getRootMeasureSpec方法内部会使用MeasureSpec.makeMeasureSpec()方法来组装一个MeasureSpec，</span></div><div class="line">			<span class="comment">// 当lp.width参数等于MATCH_PARENT的时候，MeasureSpec的specMode就等于EXACTLY，当lp.width等于WRAP_CONTENT的时候，MeasureSpec的specMode就等于AT_MOST。</span></div><div class="line">			<span class="comment">// 并且MATCH_PARENT和WRAP_CONTENT时的specSize都是等于windowSize的，也就意味着根视图总是会充满全屏的。</span></div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG, <span class="string">"Ooops, something changed!  mWidth="</span></div><div class="line">					+ mWidth + <span class="string">" measuredWidth="</span> + host.getMeasuredWidth()</div><div class="line">					+ <span class="string">" mHeight="</span> + mHeight</div><div class="line">					+ <span class="string">" measuredHeight="</span> + host.getMeasuredHeight()</div><div class="line">					+ <span class="string">" coveredInsetsChanged="</span> + contentInsetsChanged);</div><div class="line">			</div><div class="line">			<span class="comment">// 调用PerformMeasure方法。</span></div><div class="line">			 <span class="comment">// Ask host how big it wants to be</span></div><div class="line">			performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">			<span class="comment">// Implementation of weights from WindowManager.LayoutParams</span></div><div class="line">			<span class="comment">// We just grow the dimensions as needed and re-measure if</span></div><div class="line">			<span class="comment">// needs be</span></div><div class="line">			<span class="keyword">int</span> width = host.getMeasuredWidth();</div><div class="line">			<span class="keyword">int</span> height = host.getMeasuredHeight();</div><div class="line">			<span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (measureAgain) &#123;</div><div class="line">				<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG,</div><div class="line">						<span class="string">"And hey let's measure once more: width="</span> + width</div><div class="line">						+ <span class="string">" height="</span> + height);</div><div class="line">				performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			layoutRequested = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; !mStopped;</div><div class="line">	<span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</div><div class="line">			|| mAttachInfo.mRecomputeGlobalAttributes;</div><div class="line">	<span class="comment">// 是否需要Layout</span></div><div class="line">	<span class="keyword">if</span> (didLayout) &#123;</div><div class="line">		<span class="comment">// 调用performLayout方法。</span></div><div class="line">		performLayout(lp, desiredWindowWidth, desiredWindowHeight);</div><div class="line"></div><div class="line">		<span class="comment">// By this point all views have been sized and positioned</span></div><div class="line">		<span class="comment">// We can compute the transparent area</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span> ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// start out transparent</span></div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> AVOID THAT CALL BY CACHING THE RESULT?</span></div><div class="line">			host.getLocationInWindow(mTmpLocation);</div><div class="line">			mTransparentRegion.set(mTmpLocation[<span class="number">0</span>], mTmpLocation[<span class="number">1</span>],</div><div class="line">					mTmpLocation[<span class="number">0</span>] + host.mRight - host.mLeft,</div><div class="line">					mTmpLocation[<span class="number">1</span>] + host.mBottom - host.mTop);</div><div class="line"></div><div class="line">			host.gatherTransparentRegion(mTransparentRegion);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</div><div class="line">				mPreviousTransparentRegion.set(mTransparentRegion);</div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				<span class="comment">// reconfigure window manager</span></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</div><div class="line">				&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DBG) &#123;</div><div class="line">			System.out.println(<span class="string">"======================================"</span>);</div><div class="line">			System.out.println(<span class="string">"performTraversals -- after setFrame"</span>);</div><div class="line">			host.debug();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Draw</span></div><div class="line">	<span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</div><div class="line">		<span class="keyword">if</span> (!skipDraw || mReportNextDraw) &#123;</div><div class="line">			<span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">					mPendingTransitions.get(i).startChangingAnimations();</div><div class="line">				&#125;</div><div class="line">				mPendingTransitions.clear();</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 调用performDraw方法</span></div><div class="line">			performDraw();</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (viewVisibility == View.VISIBLE) &#123;</div><div class="line">			<span class="comment">// Try again</span></div><div class="line">			scheduleTraversals();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">				mPendingTransitions.get(i).endChangingAnimations();</div><div class="line">			&#125;</div><div class="line">			mPendingTransitions.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mIsInTraversal = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面源码可以看出,<code>performTraversals()</code>方法中会依次做三件事：</p>
<ul>
<li><code>performMeasure()</code>, 内部是<code>mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</code>测量<code>View</code>大小。这里顺便提一下，这个<code>mView</code>是什么？它就是<code>Window</code>最顶成的<code>View(DecorView)</code>,它是<code>FrameLayout</code>的子类。</li>
<li><code>performLayout()</code>, 内部是<code>mView.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</code>视图布局，确定<code>View</code>位置。</li>
<li><code>performDraw()</code>, 内部是<code>draw(fullRedrawNeeded);</code> 绘制界面。</li>
</ul>
<p>至此<code>View</code>绘制的三个过程已经展现：</p>
<h1 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a><code>Measure</code></h1><p><code>performMeasure</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>performMeasure()</code>方法中会调用<code>View.measure()</code>方法， 源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is called to find out how big a view should be. The parent</div><div class="line"> * supplies constraint information in the width and height parameters.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The actual measurement work of a view is performed in</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> oWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> oHeight = insets.top  + insets.bottom;</div><div class="line">		widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</div><div class="line">		heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Suppress sign extension for the low bytes</span></div><div class="line">	<span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</div><div class="line">	<span class="keyword">if</span> (mMeasureCache == <span class="keyword">null</span>) mMeasureCache = <span class="keyword">new</span> LongSparseLongArray(<span class="number">2</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</div><div class="line">			widthMeasureSpec != mOldWidthMeasureSpec ||</div><div class="line">			heightMeasureSpec != mOldHeightMeasureSpec) &#123;</div><div class="line"></div><div class="line">		<span class="comment">// first clears the measured dimension flag</span></div><div class="line">		mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">		resolveRtlPropertiesIfNeeded();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</div><div class="line">				mMeasureCache.indexOfKey(key);</div><div class="line">		<span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</div><div class="line">			<span class="comment">// 调用onMeasure方法</span></div><div class="line">			<span class="comment">// measure ourselves, this should set the measured dimension flag back</span></div><div class="line">			onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">			mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">			<span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></div><div class="line">			setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</div><div class="line">			mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// flag not set, setMeasuredDimension() was not invoked, we raise</span></div><div class="line">		<span class="comment">// an exception to warn the developer</span></div><div class="line">		<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">			<span class="comment">// 重写onMeausre方法的时，必须调用setMeasuredDimension或者super.onMeasure方法，不然就会走到这里报错。</span></div><div class="line">			<span class="comment">// setMeasuredDimension中回去改变mPrivateFlags的值</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"onMeasure() did not set the"</span></div><div class="line">					+ <span class="string">" measured dimension by calling"</span></div><div class="line">					+ <span class="string">" setMeasuredDimension()"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">	mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">	mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</div><div class="line">			(<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>measure</code>方法中会调用<code>onMeasure</code>方法。<code>ViewGroup</code>的子类会重写该方法来进行测量大小，因为<code>mView</code>是<code>DecorView</code>，<br>而<code>DecorView</code>是<code>FrameLayout</code>的子类。所以我们看一下<code>FrameLayout.onMeasure</code>方法：<br><code>FrameLayout.onMeasure</code>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> measureMatchParentChildren =</div><div class="line">			MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">			MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">	mMatchParentChildren.clear();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="comment">// 调用该方法去测量每个子View</span></div><div class="line">			measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">			maxWidth = Math.max(maxWidth,</div><div class="line">					child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">			maxHeight = Math.max(maxHeight,</div><div class="line">					child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">			childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">			<span class="keyword">if</span> (measureMatchParentChildren) &#123;</div><div class="line">				<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">						lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">					mMatchParentChildren.add(child);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Account for padding too</span></div><div class="line">	maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">	maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	<span class="comment">// Check against our minimum height and width</span></div><div class="line">	maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">	maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">	<span class="comment">// Check against our foreground's minimum height and width</span></div><div class="line">	<span class="keyword">final</span> Drawable drawable = getForeground();</div><div class="line">	<span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</div><div class="line">		maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">		maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">			resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">					childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line"></div><div class="line">	count = mMatchParentChildren.size();</div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = mMatchParentChildren.get(i);</div><div class="line"></div><div class="line">			<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec;</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredWidth() -</div><div class="line">						getPaddingLeftWithForeground() - getPaddingRightWithForeground() -</div><div class="line">						lp.leftMargin - lp.rightMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">						getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">						lp.leftMargin + lp.rightMargin,</div><div class="line">						lp.width);</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredHeight() -</div><div class="line">						getPaddingTopWithForeground() - getPaddingBottomWithForeground() -</div><div class="line">						lp.topMargin - lp.bottomMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">						getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">						lp.topMargin + lp.bottomMargin,</div><div class="line">						lp.height);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到内部会调用<code>measureChildWithMargins()</code>方法,该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Ask one of the children of this view to measure itself, taking into</div><div class="line"> * account both the MeasureSpec requirements for this view and its padding</div><div class="line"> * and margins. The child must have MarginLayoutParams The heavy lifting is</div><div class="line"> * done in getChildMeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The child to measure</div><div class="line"> * <span class="doctag">@param</span> parentWidthMeasureSpec The width requirements for this view</div><div class="line"> * <span class="doctag">@param</span> widthUsed Extra space that has been used up by the parent</div><div class="line"> *        horizontally (possibly by other children of the parent)</div><div class="line"> * <span class="doctag">@param</span> parentHeightMeasureSpec The height requirements for this view</div><div class="line"> * <span class="doctag">@param</span> heightUsed Extra space that has been used up by the parent</div><div class="line"> *        vertically (possibly by other children of the parent)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">		<span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">		<span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">	<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">			mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">					+ widthUsed, lp.width);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">			mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">					+ heightUsed, lp.height);</div><div class="line"></div><div class="line">	child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面就是对该子<code>View</code>调用了<code>measure</code>方法，我们假设这个<code>View</code>已经不是<code>ViewGroup</code>了，就会又和上面一样，又调用<code>onMeasure</code>方法，<br>下面我们直接看一下<code>View.onMeasure()</code>方法：<br><code>View.onMeasure()</code>方法的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line"> * should be overriden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass's responsibility to make</div><div class="line"> * sure the measured height and width are at least the view's minimum height</div><div class="line"> * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line"> * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="comment">// 如果不重写onMeasure方法，默认会调用getDefaultSize获取大小，下面会说getDefaultSize这个方法。</span></div><div class="line">	setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">			getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimension()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;This method must be called by &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to store the</div><div class="line"> * measured width and measured height. Failing to do so will trigger an</div><div class="line"> * exception at measurement time.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">		measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">		measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">	&#125;</div><div class="line">	setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimensionRaw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets the measured dimension without extra processing for things like optical bounds.</div><div class="line"> * Useful for reapplying consistent values that have already been cooked with adjustments</div><div class="line"> * for optical bounds, etc. such as those from the measurement cache.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="comment">// 赋值给mMeasuredWidth，getMeasuredWidth就会调用该值。</span></div><div class="line">	mMeasuredWidth = measuredWidth;</div><div class="line">	mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">	<span class="comment">// 这就是重写onMeasure方法时如果不调用setMeasuredDimension方法时为什么会报错的原因。</span></div><div class="line">	mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们接着看一下上面用到的<code>getDefaultSize()</code>方法，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size Default size for this view</div><div class="line"> * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line"> * <span class="doctag">@return</span> The size this view should be.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> result = size;</div><div class="line">	<span class="comment">// measureSpec值用于获取宽度(高度)的规格和大小，解析出对应的size和mode</span></div><div class="line">	<span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">	<span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (specMode) &#123;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">		result = size;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">	<span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">		result = specSize;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>getDefaultSize</code>方法又会使用到<code>MeasureSpec</code>类，文档中对<code>MeasureSpec</code>是这样介绍的<code>A MeasureSpec is comprised of a size and a mode. There are three possible modes:</code></p>
<ul>
<li>MeasureSpec.EXACTLY The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.<br>  理解成MATCH_PARENT或者在布局中指定了宽高值，如layout:width=’50dp’</li>
<li>MeasureSpec.AT_MOST The child can be as large as it wants up to the specified size.理解成WRAP_CONTENT,这是的值是父View可以允许的最大的值，只要不超过这个值都可以。</li>
<li>MeasureSpec.UNSPECIFIED The parent has not imposed any constraint on the child. It can be whatever size it wants. 这种情况比较少，一般用不到。</li>
</ul>
<p>这里简单总结一下上面的过程:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">performMeasure() &#123;</div><div class="line">	- <span class="number">1</span>.调用View.measure方法</div><div class="line">	mView.measure():</div><div class="line">		- <span class="number">2</span>.measure内部会调用onMeasure方法,但是因为这里mView是DecorView，所以会调用FrameLayout的onMeasure方法。</div><div class="line">	        onMeasure(FrameLayout)</div><div class="line">			- <span class="number">3</span>. 内部设置ViewGroup的宽高</div><div class="line">				setMeasuredDimension</div><div class="line">				并且对每个子View进行遍历测量</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					- <span class="number">4</span>. 对每个子View调用measureChildWithMargins方法</div><div class="line">					measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);	</div><div class="line">					    -<span class="number">5</span>. measureChildWithMargins内部调用子View的measure方法</div><div class="line">					        meausre</div><div class="line">							- <span class="number">6</span>. measure方法内部又调用onMeasure方法</div><div class="line">					            onMeasure(View)</div><div class="line">					            - <span class="number">7</span>. onMeasure方法内部调用setMeasuredDimension</div><div class="line">									setMeasuredDimension</div><div class="line">									- <span class="number">8</span>. setMeasuredDimension内部调用setMeasuredDimensionRaw</div><div class="line">									    setMeasuredDimensionRaw</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码中能看到<code>measure</code>是<code>final</code>的，我们可以重写<code>onMeasure</code>来实现<code>measure</code>过程。<br>到这里基本都讲完了，我们在开发中会按照需要重写<code>onMeasure</code>方法，然后调用<code>setMeasuredDimension</code>方法设置大小，<br>ps:譬如我们设置了<code>setMeasuredDimension(10, 10)</code>,那么不管布局中怎么设置这个<code>View</code>的大小<br>都是没用的，最后显示出来大小都是10*10。</p>
<h1 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a><code>Layout</code></h1><p><code>performLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	mLayoutRequested = <span class="keyword">false</span>;</div><div class="line">	mScrollMayChange = <span class="keyword">true</span>;</div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> View host = mView;</div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_LAYOUT) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Laying out "</span> + host + <span class="string">" to ("</span> +</div><div class="line">				host.getMeasuredWidth() + <span class="string">", "</span> + host.getMeasuredHeight() + <span class="string">")"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"layout"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 把刚才测量的宽高设置进来</span></div><div class="line">		host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">		mInLayout = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">		<span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// requestLayout() was called during layout.</span></div><div class="line">			<span class="comment">// If no layout-request flags are set on the requesting views, there is no problem.</span></div><div class="line">			<span class="comment">// If some requests are still pending, then we need to clear those flags and do</span></div><div class="line">			<span class="comment">// a full request/measure/layout pass to handle this situation.</span></div><div class="line">			ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">					<span class="keyword">false</span>);</div><div class="line">			<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Set this flag to indicate that any further requests are happening during</span></div><div class="line">				<span class="comment">// the second pass, which may result in posting those requests to the next</span></div><div class="line">				<span class="comment">// frame instead</span></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Process fresh layout requests, then measure and layout</span></div><div class="line">				<span class="keyword">int</span> numValidRequests = validLayoutRequesters.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">					<span class="keyword">final</span> View view = validLayoutRequesters.get(i);</div><div class="line">					Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">							<span class="string">" during layout: running second layout pass"</span>);</div><div class="line">					view.requestLayout();</div><div class="line">				&#125;</div><div class="line">				measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">						desiredWindowWidth, desiredWindowHeight);</div><div class="line">				mInLayout = <span class="keyword">true</span>;</div><div class="line">				host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Check the valid requests again, this time without checking/clearing the</span></div><div class="line">				<span class="comment">// layout flags, since requests happening during the second pass get noop'd</span></div><div class="line">				validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">					<span class="comment">// Post second-pass requests to the next frame</span></div><div class="line">					getRunQueue().post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">						<span class="meta">@Override</span></div><div class="line">						<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">							<span class="keyword">int</span> numValidRequests = finalRequesters.size();</div><div class="line">							<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">								<span class="keyword">final</span> View view = finalRequesters.get(i);</div><div class="line">								Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">										<span class="string">" during second layout pass: posting in next frame"</span>);</div><div class="line">								view.requestLayout();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>layout()</code>方法，因为<code>host</code>是<code>mView</code>，<code>ViewGroup</code>中重写了<code>layout</code>方法，并调用了<code>super.layout</code>.<br>所以我们直接看<code>View.layout()</code>方法，该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Assign a size and position to a view and all of its</div><div class="line"> * descendants</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line"> * (The first is measuring). In this phase, each parent calls</div><div class="line"> * layout on all of its children to position them.</div><div class="line"> * This is typically done using the child measurements</div><div class="line"> * that were stored in the measure pass().&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Derived classes should not override this method.</div><div class="line"> * Derived classes with children should override</div><div class="line"> * onLayout. In that method, they should</div><div class="line"> * call layout on each of their children.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> t Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> r Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> b Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">		onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">		mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> oldL = mLeft;</div><div class="line">	<span class="keyword">int</span> oldT = mTop;</div><div class="line">	<span class="keyword">int</span> oldB = mBottom;</div><div class="line">	<span class="keyword">int</span> oldR = mRight;</div><div class="line"></div><div class="line">	<span class="comment">// 这部分是判断这个View的大小是否已经发生了变化，来判断是否需要重绘。</span></div><div class="line">	<span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">			setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">		<span class="comment">// 内部调用onLayout方法</span></div><div class="line">		onLayout(changed, l, t, r, b);</div><div class="line">		mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">			ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">					(ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">			<span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">				listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">	mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里会调用<code>onLayout</code>方法，同样因为<code>mView</code>是<code>FrameLayout</code>的子类，所以我们要看<code>FrameLayout</code>的<code>onLayout</code>方法，<br>这里我们先看一下<code>ViewGroup.onLayout</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></div><div class="line">		<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b);</div></pre></td></tr></table></figure></p>
<p>是个抽象方法，所以<code>ViewGroup</code>的子类都需要实现该方法。<br>我们看一下<code>FrameLayout.onLayout</code>方法,源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">	layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">							  <span class="keyword">boolean</span> forceLeftGravity) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	mForegroundBoundsChanged = <span class="keyword">true</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</div><div class="line"></div><div class="line">			<span class="keyword">int</span> childLeft;</div><div class="line">			<span class="keyword">int</span> childTop;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">			<span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</div><div class="line">				gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">					childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</div><div class="line">					lp.leftMargin - lp.rightMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">					<span class="keyword">if</span> (!forceLeftGravity) &#123;</div><div class="line">						childLeft = parentRight - width - lp.rightMargin;</div><div class="line">						<span class="keyword">break</span>;</div><div class="line">					&#125;</div><div class="line">				<span class="keyword">case</span> Gravity.LEFT:</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childLeft = parentLeft + lp.leftMargin;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.TOP:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">					childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">					lp.topMargin - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">					childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//调用子View的layout方法</span></div><div class="line">			child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>View.layout</code>方法，又会调用到<code>View.onLayout</code>方法，我们假设这个子<code>View</code>不是<code>ViewGroup</code>.<br>看一下<code>View.onLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called from layout when this view should</div><div class="line"> * assign a size and position to each of its children.</div><div class="line"> *</div><div class="line"> * Derived classes with children should override</div><div class="line"> * this method and call layout on each of</div><div class="line"> * their children.</div><div class="line"> * <span class="doctag">@param</span> changed This is a new size or position for this view</div><div class="line"> * <span class="doctag">@param</span> left Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> top Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> right Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> bottom Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是一个空方法，这是因为<code>Layout</code>需要<code>ViewGroup</code>来控制进行。      </p>
<p>这里也总结一下<code>layout</code>的过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	- <span class="number">1</span>. host.layout</div><div class="line">	host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">		-<span class="number">2</span>. layout方法会分别调用setFrame()和onLayout()方法</div><div class="line">			setFrame()</div><div class="line">			onLayout()</div><div class="line">			-<span class="number">3</span>. 因为host是mView也就是DecorView也就是FrameLayout的子类。FrameLayout的onLayout方法如下</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">					    -<span class="number">4</span>. 遍历每个子View，并分别调用layout方法。</div><div class="line">						child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a><code>Draw</code></h1><p>绘制阶段是从<code>ViewRootImpl</code>中的<code>performDraw</code>方法开始的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">	mFullRedrawNeeded = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mIsDrawing = <span class="keyword">true</span>;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"draw"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 开始draw了</span></div><div class="line">		draw(fullRedrawNeeded);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		mIsDrawing = <span class="keyword">false</span>;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// For whatever reason we didn't create a HardwareRenderer, end any</span></div><div class="line">	<span class="comment">// hardware animations that are now dangling</span></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mPendingAnimatingRenderNodes != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mAttachInfo.mPendingAnimatingRenderNodes.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</div><div class="line">		&#125;</div><div class="line">		mAttachInfo.mPendingAnimatingRenderNodes.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mReportNextDraw) &#123;</div><div class="line">		mReportNextDraw = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span>) &#123;</div><div class="line">			mAttachInfo.mHardwareRenderer.fence();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"FINISHED DRAWING: "</span> + mWindowAttributes.getTitle());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span> &amp;&amp; mSurface.isValid()) &#123;</div><div class="line">			mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">			SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</div><div class="line">			<span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (SurfaceHolder.Callback c : callbacks) &#123;</div><div class="line">					<span class="keyword">if</span> (c <span class="keyword">instanceof</span> SurfaceHolder.Callback2) &#123;</div><div class="line">						((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(</div><div class="line">								mSurfaceHolder);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			mWindowSession.finishDrawing(mWindow);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>draw</code>方法，<code>draw</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</div><div class="line">	Surface surface = mSurface;</div><div class="line">	<span class="keyword">if</span> (!surface.isValid()) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_FPS) &#123;</div><div class="line">		trackFPS();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!sFirstDrawComplete) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (sFirstDrawHandlers) &#123;</div><div class="line">			sFirstDrawComplete = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = sFirstDrawHandlers.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; count; i++) &#123;</div><div class="line">				mHandler.post(sFirstDrawHandlers.get(i));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	scrollToRectOrFocus(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mViewScrollChanged) &#123;</div><div class="line">		mAttachInfo.mViewScrollChanged = <span class="keyword">false</span>;</div><div class="line">		mAttachInfo.mTreeObserver.dispatchOnScrollChanged();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> animating = mScroller != <span class="keyword">null</span> &amp;&amp; mScroller.computeScrollOffset();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> curScrollY;</div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		curScrollY = mScroller.getCurrY();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		curScrollY = mScrollY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mCurScrollY != curScrollY) &#123;</div><div class="line">		mCurScrollY = curScrollY;</div><div class="line">		fullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> appScale = mAttachInfo.mApplicationScale;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> scalingRequired = mAttachInfo.mScalingRequired;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> resizeAlpha = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mResizeBuffer != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">long</span> deltaTime = SystemClock.uptimeMillis() - mResizeBufferStartTime;</div><div class="line">		<span class="keyword">if</span> (deltaTime &lt; mResizeBufferDuration) &#123;</div><div class="line">			<span class="keyword">float</span> amt = deltaTime/(<span class="keyword">float</span>) mResizeBufferDuration;</div><div class="line">			amt = mResizeInterpolator.getInterpolation(amt);</div><div class="line">			animating = <span class="keyword">true</span>;</div><div class="line">			resizeAlpha = <span class="number">255</span> - (<span class="keyword">int</span>)(amt*<span class="number">255</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect dirty = mDirty;</div><div class="line">	<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The app owns the surface, we won't draw.</span></div><div class="line">		dirty.setEmpty();</div><div class="line">		<span class="keyword">if</span> (animating) &#123;</div><div class="line">			<span class="keyword">if</span> (mScroller != <span class="keyword">null</span>) &#123;</div><div class="line">				mScroller.abortAnimation();</div><div class="line">			&#125;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (fullRedrawNeeded) &#123;</div><div class="line">		mAttachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		dirty.set(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">int</span>) (mWidth * appScale + <span class="number">0.5f</span>), (<span class="keyword">int</span>) (mHeight * appScale + <span class="number">0.5f</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Draw "</span> + mView + <span class="string">"/"</span></div><div class="line">				+ mWindowAttributes.getTitle()</div><div class="line">				+ <span class="string">": dirty=&#123;"</span> + dirty.left + <span class="string">","</span> + dirty.top</div><div class="line">				+ <span class="string">","</span> + dirty.right + <span class="string">","</span> + dirty.bottom + <span class="string">"&#125; surface="</span></div><div class="line">				+ surface + <span class="string">" surface.isValid()="</span> + surface.isValid() + <span class="string">", appScale:"</span> +</div><div class="line">				appScale + <span class="string">", width="</span> + mWidth + <span class="string">", height="</span> + mHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mAttachInfo.mTreeObserver.dispatchOnDraw();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> xOffset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> yOffset = curScrollY;</div><div class="line">	<span class="keyword">final</span> WindowManager.LayoutParams params = mWindowAttributes;</div><div class="line">	<span class="keyword">final</span> Rect surfaceInsets = params != <span class="keyword">null</span> ? params.surfaceInsets : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (surfaceInsets != <span class="keyword">null</span>) &#123;</div><div class="line">		xOffset -= surfaceInsets.left;</div><div class="line">		yOffset -= surfaceInsets.top;</div><div class="line"></div><div class="line">		<span class="comment">// Offset dirty rect for surface insets.</span></div><div class="line">		dirty.offset(surfaceInsets.left, surfaceInsets.right);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating) &#123;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</div><div class="line">			<span class="comment">// Draw with hardware renderer.</span></div><div class="line">			mIsAnimating = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">boolean</span> invalidateRoot = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</div><div class="line">				mHardwareYOffset = yOffset;</div><div class="line">				mHardwareXOffset = xOffset;</div><div class="line">				mAttachInfo.mHardwareRenderer.invalidateRoot();</div><div class="line">			&#125;</div><div class="line">			mResizeAlpha = resizeAlpha;</div><div class="line"></div><div class="line">			dirty.setEmpty();</div><div class="line"></div><div class="line">			mBlockResizeBuffer = <span class="keyword">false</span>;</div><div class="line">			mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// If we get here with a disabled &amp; requested hardware renderer, something went</span></div><div class="line">			<span class="comment">// wrong (an invalidate posted right before we destroyed the hardware surface</span></div><div class="line">			<span class="comment">// for instance) so we should just bail out. Locking the surface with software</span></div><div class="line">			<span class="comment">// rendering at this point would lock it forever and prevent hardware renderer</span></div><div class="line">			<span class="comment">// from doing its job when it comes back.</span></div><div class="line">			<span class="comment">// Before we request a new frame we must however attempt to reinitiliaze the</span></div><div class="line">			<span class="comment">// hardware renderer if it's in requested state. This would happen after an</span></div><div class="line">			<span class="comment">// eglTerminate() for instance.</span></div><div class="line">			<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp;</div><div class="line">					!mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</div><div class="line">					mAttachInfo.mHardwareRenderer.isRequested()) &#123;</div><div class="line"></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mAttachInfo.mHardwareRenderer.initializeIfNeeded(</div><div class="line">							mWidth, mHeight, mSurface, surfaceInsets);</div><div class="line">				&#125; <span class="keyword">catch</span> (OutOfResourcesException e) &#123;</div><div class="line">					handleOutOfResourcesException(e);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				scheduleTraversals();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="comment">// draw的部分在这里。。。内部会用canvas去画</span></div><div class="line">			<span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">		scheduleTraversals();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>drawSoftware</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@return</span> true if drawing was successful, false if an error occurred</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></div><div class="line">		<span class="keyword">boolean</span> scalingRequired, Rect dirty) &#123;</div><div class="line"></div><div class="line">	<span class="comment">// Draw with software renderer.</span></div><div class="line">	<span class="keyword">final</span> Canvas canvas;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> left = dirty.left;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> top = dirty.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> right = dirty.right;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> bottom = dirty.bottom;</div><div class="line"></div><div class="line">		canvas = mSurface.lockCanvas(dirty);</div><div class="line"></div><div class="line">		<span class="comment">// The dirty rectangle can be modified by Surface.lockCanvas()</span></div><div class="line">		<span class="comment">//noinspection ConstantConditions</span></div><div class="line">		<span class="keyword">if</span> (left != dirty.left || top != dirty.top || right != dirty.right</div><div class="line">				|| bottom != dirty.bottom) &#123;</div><div class="line">			attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> Do this in native</span></div><div class="line">		canvas.setDensity(mDensity);</div><div class="line">	&#125; <span class="keyword">catch</span> (Surface.OutOfResourcesException e) &#123;</div><div class="line">		handleOutOfResourcesException(e);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">		Log.e(TAG, <span class="string">"Could not lock surface"</span>, e);</div><div class="line">		<span class="comment">// Don't assume this is due to out of memory, it could be</span></div><div class="line">		<span class="comment">// something else, and if it is something else then we could</span></div><div class="line">		<span class="comment">// kill stuff (or ourself) for no reason.</span></div><div class="line">		mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" drawing to bitmap w="</span></div><div class="line">					+ canvas.getWidth() + <span class="string">", h="</span> + canvas.getHeight());</div><div class="line">			<span class="comment">//canvas.drawARGB(255, 255, 0, 0);</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// If this bitmap's format includes an alpha channel, we</span></div><div class="line">		<span class="comment">// need to clear it before drawing so that the child will</span></div><div class="line">		<span class="comment">// properly re-composite its drawing on a transparent</span></div><div class="line">		<span class="comment">// background. This automatically respects the clip/dirty region</span></div><div class="line">		<span class="comment">// or</span></div><div class="line">		<span class="comment">// If we are applying an offset, we need to clear the area</span></div><div class="line">		<span class="comment">// where the offset doesn't appear to avoid having garbage</span></div><div class="line">		<span class="comment">// left in the blank areas.</span></div><div class="line">		<span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</div><div class="line">			canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		dirty.setEmpty();</div><div class="line">		mIsAnimating = <span class="keyword">false</span>;</div><div class="line">		attachInfo.mDrawingTime = SystemClock.uptimeMillis();</div><div class="line">		mView.mPrivateFlags |= View.PFLAG_DRAWN;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DEBUG_DRAW) &#123;</div><div class="line">			Context cxt = mView.getContext();</div><div class="line">			Log.i(TAG, <span class="string">"Drawing: package:"</span> + cxt.getPackageName() +</div><div class="line">					<span class="string">", metrics="</span> + cxt.getResources().getDisplayMetrics() +</div><div class="line">					<span class="string">", compatibilityInfo="</span> + cxt.getResources().getCompatibilityInfo());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			canvas.translate(-xoff, -yoff);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateCanvas(canvas);</div><div class="line">			&#125;</div><div class="line">			canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</div><div class="line">			attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			</div><div class="line">			<span class="comment">// 内部会去调用View.draw()；</span></div><div class="line">			mView.draw(canvas);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!attachInfo.mSetIgnoreDirtyState) &#123;</div><div class="line">				<span class="comment">// Only clear the flag if it was not set during the mView.draw() call</span></div><div class="line">				attachInfo.mIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			surface.unlockCanvasAndPost(canvas);</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">			Log.e(TAG, <span class="string">"Could not unlock surface"</span>, e);</div><div class="line">			mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">			<span class="comment">//noinspection ReturnInsideFinallyBlock</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" unlockCanvasAndPost"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码中调用了<code>mView.draw()</code>方法，所以我们看一下<code>FrameLayout.draw()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.draw(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mForeground != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> Drawable foreground = mForeground;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mForegroundBoundsChanged) &#123;</div><div class="line">			mForegroundBoundsChanged = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">final</span> Rect selfBounds = mSelfBounds;</div><div class="line">			<span class="keyword">final</span> Rect overlayBounds = mOverlayBounds;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> w = mRight-mLeft;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> h = mBottom-mTop;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mForegroundInPadding) &#123;</div><div class="line">				selfBounds.set(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				selfBounds.set(mPaddingLeft, mPaddingTop, w - mPaddingRight, h - mPaddingBottom);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			Gravity.apply(mForegroundGravity, foreground.getIntrinsicWidth(),</div><div class="line">					foreground.getIntrinsicHeight(), selfBounds, overlayBounds,</div><div class="line">					layoutDirection);</div><div class="line">			foreground.setBounds(overlayBounds);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		foreground.draw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部调用了<code>super.draw()</code>，而<code>ViewGroup</code>没有重写该方法，所以直接看<code>View</code>的<code>draw()</code>方法.<br><code>View.draw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Manually render this view (and all of its children) to the given Canvas.</div><div class="line"> * The view must have already done a full layout before this function is</div><div class="line"> * called.  When implementing a view, implement</div><div class="line"> * &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line"> * If you do need to override this method, call the superclass version.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The Canvas to which the View is rendered.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">			(mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">	mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">	<span class="comment">// 这里注释说的很明白了，draw的6个步骤。</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Draw traversal performs several drawing steps which must be executed</div><div class="line">	 * in the appropriate order:</div><div class="line">	 *</div><div class="line">	 *      1. Draw the background</div><div class="line">	 *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">	 *      3. Draw view's content, 调用onDraw方法绘制自身</div><div class="line">	 *      4. Draw children, 调用dispatchDraw方法绘制子View</div><div class="line">	 *      5. If necessary, draw the fading edges and restore layers</div><div class="line">	 *      6. Draw decorations (scrollbars for instance)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">	<span class="keyword">int</span> saveCount;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">		drawBackground(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">	<span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">		<span class="comment">// Step 3, draw the content</span></div><div class="line">		<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 4, draw the children</span></div><div class="line">		dispatchDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">		onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">			mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// we're done...</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Here we do the full fledged routine...</div><div class="line">	 * (this is an uncommon case where speed matters less,</div><div class="line">	 * this is why we repeat some of the tests that have been</div><div class="line">	 * done above)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> drawTop = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawBottom = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawLeft = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawRight = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> topFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> bottomFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> leftFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> rightFadeStrength = <span class="number">0.0f</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Step 2, save the canvas' layers</span></div><div class="line">	<span class="keyword">int</span> paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> offsetRequired = isPaddingOffsetRequired();</div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		paddingLeft += getLeftPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> left = mScrollX + paddingLeft;</div><div class="line">	<span class="keyword">int</span> right = left + mRight - mLeft - mPaddingRight - paddingLeft;</div><div class="line">	<span class="keyword">int</span> top = mScrollY + getFadeTop(offsetRequired);</div><div class="line">	<span class="keyword">int</span> bottom = top + getFadeHeight(offsetRequired);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		right += getRightPaddingOffset();</div><div class="line">		bottom += getBottomPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ScrollabilityCache scrollabilityCache = mScrollCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> fadeHeight = scrollabilityCache.fadingEdgeLength;</div><div class="line">	<span class="keyword">int</span> length = (<span class="keyword">int</span>) fadeHeight;</div><div class="line"></div><div class="line">	<span class="comment">// clip the fade length if top and bottom fades overlap</span></div><div class="line">	<span class="comment">// overlapping fades produce odd-looking artifacts</span></div><div class="line">	<span class="keyword">if</span> (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) &#123;</div><div class="line">		length = (bottom - top) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// also clip horizontal fades if necessary</span></div><div class="line">	<span class="keyword">if</span> (horizontalEdges &amp;&amp; (left + length &gt; right - length)) &#123;</div><div class="line">		length = (right - left) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (verticalEdges) &#123;</div><div class="line">		topFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getTopFadingEdgeStrength()));</div><div class="line">		drawTop = topFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		bottomFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getBottomFadingEdgeStrength()));</div><div class="line">		drawBottom = bottomFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (horizontalEdges) &#123;</div><div class="line">		leftFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getLeftFadingEdgeStrength()));</div><div class="line">		drawLeft = leftFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		rightFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getRightFadingEdgeStrength()));</div><div class="line">		drawRight = rightFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	saveCount = canvas.getSaveCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> solidColor = getSolidColor();</div><div class="line">	<span class="keyword">if</span> (solidColor == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">			canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">			canvas.saveLayer(left, bottom - length, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">			canvas.saveLayer(left, top, left + length, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">			canvas.saveLayer(right - length, top, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		scrollabilityCache.setFadeColor(solidColor);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Step 3, draw the content</span></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 4, draw the children</span></div><div class="line">	dispatchDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 5, draw the fade effect and restore layers</span></div><div class="line">	<span class="keyword">final</span> Paint p = scrollabilityCache.paint;</div><div class="line">	<span class="keyword">final</span> Matrix matrix = scrollabilityCache.matrix;</div><div class="line">	<span class="keyword">final</span> Shader fade = scrollabilityCache.shader;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, right, top + length, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * bottomFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">180</span>);</div><div class="line">		matrix.postTranslate(left, bottom);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, bottom - length, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * leftFadeStrength);</div><div class="line">		matrix.postRotate(-<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, left + length, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * rightFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(right, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(right - length, top, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	canvas.restoreToCount(saveCount);</div><div class="line"></div><div class="line">	<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">	onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">		mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面会调用<code>onDraw</code>和<code>dispatchDraw</code>方法。<br>我们先看一下<code>View.onDraw</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this to do your drawing.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas the canvas on which the background will be drawn</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是空方法，这是也很好理解，因为每个<code>View</code>的展现都不一样，例如<code>TextView</code>、<code>ProgressBar</code>等，<br>所以<code>View</code>不会去实现<code>onDraw</code>方法，具体是要子类去根据自己的显示要求实现该方法。</p>
<p>再看一下<code>dispatchDraw</code>方法，这个方法是用来绘制子<code>View</code>的，所以要看<code>ViewGroup.dispatchDraw</code>方法，<code>View.dispatchDraw</code>是空的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">int</span> flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_RUN_ANIMATION) != <span class="number">0</span> &amp;&amp; canAnimate()) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> cache = (mGroupFlags &amp; FLAG_ANIMATION_CACHE) == FLAG_ANIMATION_CACHE;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> buildCache = !isHardwareAccelerated();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = children[i];</div><div class="line">			<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</div><div class="line">				<span class="keyword">final</span> LayoutParams params = child.getLayoutParams();</div><div class="line">				attachLayoutAnimationParameters(child, params, i, childrenCount);</div><div class="line">				bindLayoutAnimation(child);</div><div class="line">				<span class="keyword">if</span> (cache) &#123;</div><div class="line">					child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">					<span class="keyword">if</span> (buildCache) &#123;</div><div class="line">						child.buildDrawingCache(<span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LayoutAnimationController controller = mLayoutAnimationController;</div><div class="line">		<span class="keyword">if</span> (controller.willOverlap()) &#123;</div><div class="line">			mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		controller.start();</div><div class="line"></div><div class="line">		mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;</div><div class="line">		mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (cache) &#123;</div><div class="line">			mGroupFlags |= FLAG_CHILDREN_DRAWN_WITH_CACHE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAnimationListener != <span class="keyword">null</span>) &#123;</div><div class="line">			mAnimationListener.onAnimationStart(controller.getAnimation());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> clipSaveCount = <span class="number">0</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		clipSaveCount = canvas.save();</div><div class="line">		canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</div><div class="line">				mScrollX + mRight - mLeft - mPaddingRight,</div><div class="line">				mScrollY + mBottom - mTop - mPaddingBottom);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// We will draw our child's animation, let's reset the flag</span></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</div><div class="line">	mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> more = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">long</span> drawingTime = getDrawingTime();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertReorderBarrier();</div><div class="line">	<span class="comment">// Only use the preordered list if not HW accelerated, since the HW pipeline will do the</span></div><div class="line">	<span class="comment">// draw reordering internally</span></div><div class="line">	<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</div><div class="line">			? <span class="keyword">null</span> : buildOrderedChildList();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">			&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">		<span class="keyword">int</span> childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">		<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">				? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">		<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 调用drawChild方法</span></div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line"></div><div class="line">	<span class="comment">// Draw any disappearing views that have animations</span></div><div class="line">	<span class="keyword">if</span> (mDisappearingChildren != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> disappearingCount = disappearingChildren.size() - <span class="number">1</span>;</div><div class="line">		<span class="comment">// Go backwards -- we may delete as animations finish</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = disappearingCount; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = disappearingChildren.get(i);</div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (debugDraw()) &#123;</div><div class="line">		onDebugDraw(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		canvas.restoreToCount(clipSaveCount);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// mGroupFlags might have been updated by drawChild()</span></div><div class="line">	flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) &#123;</div><div class="line">		invalidate(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_ANIMATION_DONE) == <span class="number">0</span> &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == <span class="number">0</span> &amp;&amp;</div><div class="line">			mLayoutAnimationController.isDone() &amp;&amp; !more) &#123;</div><div class="line">		<span class="comment">// We want to erase the drawing cache and notify the listener after the</span></div><div class="line">		<span class="comment">// next frame is drawn because one extra invalidate() is caused by</span></div><div class="line">		<span class="comment">// drawChild() after the animation is over</span></div><div class="line">		mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;</div><div class="line">		<span class="keyword">final</span> Runnable end = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">		   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			   notifyAnimationListener();</div><div class="line">		   &#125;</div><div class="line">		&#125;;</div><div class="line">		post(end);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到上面的方法中会调用<code>drawChild</code>方法，该方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Draw one child of this View Group. This method is responsible for getting</div><div class="line"> * the canvas in the right state. This includes clipping, translating so</div><div class="line"> * that the child's scrolled origin is at 0, 0, and applying any animation</div><div class="line"> * transformations.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The canvas on which to draw the child</div><div class="line"> * <span class="doctag">@param</span> child Who to draw</div><div class="line"> * <span class="doctag">@param</span> drawingTime The time at which draw is occurring</div><div class="line"> * <span class="doctag">@return</span> True if an invalidate() was issued</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里也简单总结一下<code>draw</code>的过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. ViewRootImpl.performDraw()</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 2. ViewRootImpl.draw()</span></div><div class="line">	draw(fullRedrawNeeded);	</div><div class="line">		<span class="comment">// 3. ViewRootImpl.drawSoftware</span></div><div class="line">		drawSoftware</div><div class="line">			<span class="comment">// 4. 内部调用mView.draw,也就是FrameLayout.draw(). </span></div><div class="line">			mView.draw()(FrameLayout)</div><div class="line">				<span class="comment">// 5. FrameLayout.draw方法内部会调用super.draw方法，也就是View.draw方法.</span></div><div class="line">				<span class="keyword">super</span>.draw(canvas);</div><div class="line">					<span class="comment">// 6. View.draw方法内部会分别调用onDraw绘制自己以及dispatchDraw绘制子View.</span></div><div class="line">					onDraw</div><div class="line">					<span class="comment">// 绘制子View</span></div><div class="line">					dispatchDraw</div><div class="line">						<span class="comment">// 7. dispatchDraw方法内部会遍历所有子View.</span></div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">							<span class="comment">// 8. 对每个子View分别调用drawChild方法</span></div><div class="line">							drawChild()</div><div class="line">								<span class="comment">// 9. drawChild方法内部会对该子View调用draw方法，进行绘制。然后draw又会调用onDraw等，循环就开始了。 </span></div><div class="line">									child.draw()</div><div class="line">						&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后补充一个小问题： <code>getWidth()</code>与<code>getMeasuredWidth()</code>有什么区别呢？<br>一般情况下这两个的值是相同的，<code>getMeasureWidth()</code>方法在<code>measure()</code>过程结束后就可以获取到了，而<code>getWidth()</code>方法要在<code>layout()</code>过程结束后才能获取到。<br>而且<code>getMeasureWidth()</code>的值是通过<code>setMeasuredDimension()</code>设置的，但是<code>getWidth()</code>的值是通过视图右边的坐标减去左边的坐标计算出来的。如果我们在<code>layout</code>的时候将宽高<br>不传<code>getMeasureWidth</code>的值，那么这时候<code>getWidth()</code>与<code>getMeasuredWidth</code>的值就不会再相同了，当然一般也不会这么干…</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/View绘制过程详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(上)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(上)/">RxJava详解(上)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(上)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-上"><a href="#RxJava详解-上" class="headerlink" title="RxJava详解(上)"></a>RxJava详解(上)</h1><p>年初的时候就想学习下<code>RxJava</code>然后写一些<code>RxJava</code>的教程，无奈发现已经年底了，然而我还么有写。今天有点时间，特别是发布了<code>RxJava 2.0</code>后，我决定动笔开始。</p>
<p>现在<code>RxJava</code>变的越来越流行了，很多项目中都使用了它。特别是大神<code>JakeWharton</code>等的加入，以及<code>RxBinding、Retrofit、RxLifecycle</code>等众多项目的，然开发越来越方便，但是上手比较难，不过一旦你入门后你就会发现真是太棒了。</p>
<h2 id="RxJava简介"><a href="#RxJava简介" class="headerlink" title="RxJava简介"></a><code>RxJava</code>简介</h2><p>在介绍<code>RxJava</code>之前先说一下<code>Rx</code>。<code>Rx</code>的全称是<code>Reactive Extensions</code>，直译过来就是响应式扩展。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rx_logo.png?raw=true" alt="image"></p>
<p><code>Rx</code>基于观察者模式，它是一种编程模型，目标是提供一致的编程接口，帮助开发者更方便的处理异步数据流。<code>ReactiveX.io</code>给的定义是，<code>Rx</code>是一个使用可观察数据流进行异步编程的编程接口，<code>ReactiveX</code>结合了观察者模式、迭代器模式和函数式编程的精华。<code>Rx</code>已经渗透到了各个语言中，有了<code>Rx</code>所以才有了<code>RxJava</code>、<code>Rx.NET</code>、<code>RxJS</code>、<code>RxSwift</code>、<code>Rx.rb</code>、<code>RxPHP</code>等等，</p>
<p>这里先列举一下相关的官网:  </p>
<ul>
<li><a href="http://reactivex.io/" target="_blank" rel="external">Rx</a></li>
<li><a href="https://github.com/ReactiveX/RxJava">RxJava</a>       </li>
<li><a href="https://github.com/ReactiveX/RxAndroid">RxAndroid</a></li>
</ul>
<p><code>RxJava</code>在<code>GitHub</code>上的介绍是：<code>a library for composing asynchronous and event-based programs by using observable sequences for the Java VM.</code><br>翻译过来也就是一个基于事件和程序在<code>Java VM</code>上使用可观测的序列来组成异步的库。<code>RxJava</code>的本质就是一个实现异步操作的库，它的优势就是简洁，随着程序逻辑变得越来越复杂，它依然能够保持简洁。       </p>
<p>其实一句话总结一下<code>RxJava</code>的作用就是：异步   </p>
<p>这里可能会有人想不就是个异步吗，至于辣么矫情么?用<code>AsyncTask</code>、<code>Handler</code>甚至自定义一个<code>BigAsyncTask</code>分分钟搞定。</p>
<p>但是<code>RxJava</code>的好处是简洁。异步操作很关键的一点是程序的简洁性，因为在调度过程比较复杂的情况下，异步代码经常会既难写也难被读懂。 <code>Android</code>创造的<code>AsyncTask</code>和<code>Handler</code>其实都是为了让异步代码更加简洁。虽然<code>RxJava</code>的优势也是简洁，但它的简洁的与众不同之处在于，随着程序逻辑变得越来越复杂，它依然能够保持简洁。</p>
<p>####扩展的观察者模式</p>
<p><code>RxJava</code>的异步实现，是通过一种扩展的观察者模式来实现的。</p>
<p>观察者模式面向的需求是：<code>A</code>对象（观察者）对<code>B</code>对象（被观察者）的某种变化高度敏感，需要在<code>B</code>变化的一瞬间做出反应。举个例子，新闻里喜闻乐见的警察抓小偷，警察需要在小偷伸手作案的时候实施抓捕。在这个例子里，警察是观察者，小偷是被观察者，警察需要时刻盯着小偷的一举一动，才能保证不会漏过任何瞬间。程序的观察者模式和这种真正的『观察』略有不同，观察者不需要时刻盯着被观察者（例如<code>A</code>不需要每过<code>2ms</code>就检查一次<code>B</code>的状态），而是采用注册(<code>Register</code>)或者称为订阅(<code>Subscribe</code>)的方式，告诉被观察者：我需要你的某某状态，你要在它变化的时候通知我。 <code>Android</code>开发中一个比较典型的例子是点击监听器<code>OnClickListener</code>。对设置<code>OnClickListener</code>来说，<code>View</code>是被观察者，<code>OnClickListener</code>是观察者，二者通过 <code>setOnClickListener()</code>方法达成订阅关系。订阅之后用户点击按钮的瞬间，<code>Android Framework</code>就会将点击事件发送给已经注册的<code>OnClickListener</code>。采取这样被动的观察方式，既省去了反复检索状态的资源消耗，也能够得到最高的反馈速度。当然，这也得益于我们可以随意定制自己程序中的观察者和被观察者，而警察叔叔明显无法要求小偷『你在作案的时候务必通知我』。</p>
<p><code>OnClickListener</code>的模式大致如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/btn_onclick.jpg?raw=true" alt="image"></p>
<p>如图所示，通过<code>setOnClickListener()</code>方法，<code>Button</code>持有<code>OnClickListener</code>的引用（这一过程没有在图上画出）；当用户点击时，<code>Button</code>自动调用<code>OnClickListener</code>的<code>onClick()</code> 方法。另外，如果把这张图中的概念抽象出来（<code>Button</code> -&gt; 被观察者、<code>OnClickListener</code> -&gt; 观察者、<code>setOnClickListener()</code> -&gt; 订阅，<code>onClick()</code> -&gt; 事件），就由专用的观察者模式（例如只用于监听控件点击）转变成了通用的观察者模式。如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/btn_rxjava_observable.jpg?raw=true" alt="image"></p>
<p>而<code>RxJava</code>作为一个工具库，使用的就是通用形式的观察者模式。</p>
<p>####<code>RxJava</code>的观察者模式</p>
<p><code>RxJava</code>的基本概念：</p>
<ul>
<li><code>Observable</code>(可观察者，即被观察者)、 </li>
<li><code>Observer</code>(观察者)、 </li>
<li><code>subscribe()</code>(订阅)、事件。<br>  <code>Observable</code>和<code>Observer</code>通过<code>subscribe()</code> 方法实现订阅关系，从而<code>Observable</code>可以在需要的时候发出事件来通知<code>Observer</code>。</li>
</ul>
<p>与传统观察者模式不同，<code>RxJava</code>的事件回调方法除了普通事件<code>onNext()</code>(相当于<code>onClick()</code>/<code>onEvent()</code>)之外，还定义了两个特殊的事件：<code>onCompleted()</code>和<code>onError()</code>:<br>但是<code>RxJava</code>与传统的观察者设计模式有一点明显不同，那就是如果一个<code>Observerble</code>没有任何的的<code>Subscriber</code>，那么这个<code>Observable</code>是不会发出任何事件的。</p>
<ul>
<li><code>onCompleted()</code>: 事件队列完结。<br>  <code>RxJava</code>不仅把每个事件单独处理，还会把它们看做一个队列。<code>RxJava</code>规定，当不会再有新的<code>onNext()</code>发出时，需要触发<code>onCompleted()</code> 方法作为标志。</li>
<li><code>onError()</code>: 事件队列异常。<br>  在事件处理过程中出异常时，<code>onError()</code>会被触发，同时队列自动终止，不允许再有事件发出。</li>
<li>在一个正确运行的事件序列中, <code>onCompleted()</code>和<code>onError()</code>有且只有一个，并且是事件序列中的最后一个。需要注意的是<code>onCompleted()</code>和<code>onError()</code> 二者也是互斥的，即在队列中调用了其中一个，就不应该再调用另一个。</li>
</ul>
<p><code>RxJava</code>的观察者模式大致如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observer_1.jpg?raw=true" alt="image"></p>
<p>####基本实现</p>
<p>基于上面的概念， <code>RxJava</code>的基本实现主要有三点:    </p>
<ul>
<li><p>创建<code>Observable</code><br>  <code>Observable</code>即被观察者，它决定什么时候触发事件以及触发怎样的事件。 <code>RxJava</code>使用<code>Observable.create()</code>方法来创建一个<code>Observable</code>，并为它定义事件触发规则。    </p>
</li>
<li><p>创建<code>Observer</code>即观察者，它决定事件触发的时候将有怎样的行为。<br>  <code>RxJava</code>中的<code>Observer</code>接口的实现方式:    </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Observer&lt;String&gt; observer = <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  除了<code>Observer</code>接口之外，<code>RxJava</code>还内置了一个实现了<code>Observer</code>的抽象类:<code>Subscriber</code>。<code>Subscriber</code>对<code>Observer</code>接口进行了一些扩展，但他们的基本使用方式是完全一样的。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  不仅基本使用方式一样，实质上，在<code>RxJava</code>的<code>subscribe()</code>过程中，<code>Observer</code>也总是会先被转换成一个<code>Subscriber</code>再使用。所以如果你只想使用基本功能，选择<code>Observer</code>和 <code>Subscriber</code>是完全一样的。它们的区别对于使用者来说主要有两点：</p>
<ul>
<li><code>onStart()</code>: 这是<code>Subscriber</code>增加的方法。它会在<code>subscribe()</code>刚开始而事件还未发送之前被调用，可以用于做一些准备工作，例如数据的清零或重置。这是一个可选方法，默认情况下它的实现为空。需要注意的是，如果对准备工作的线程有要求（例如弹出一个显示进度的对话框，这必须在主线程执行）， <code>onStart()</code>就不适用了，因为它总是在<code>subscribe()</code> 所发生的线程被调用，而不能指定线程。要在指定的线程来做准备工作，可以使用<code>doOnSubscribe()</code>方法，具体可以在后面的文中看到。</li>
<li><code>unsubscribe</code>(): 这是<code>Subscriber</code>所实现的另一个接口<code>Subscription</code>的方法，用于取消订阅。在这个方法被调用后，<code>Subscriber</code> 将不再接收事件。一般在这个方法调用前，可以使用<code>isUnsubscribed()</code>先判断一下状态。 <code>unsubscribe()</code>这个方法很重要，因为在<code>subscribe()</code>之后,<code>Observable</code>会持有 <code>Subscriber</code>的引用，这个引用如果不能及时被释放，将有内存泄露的风险。所以最好保持一个原则：要在不再使用的时候尽快在合适的地方（例如<code>onPause()、onStop()</code>等方法中）调用<code>unsubscribe()</code>来解除引用关系，以避免内存泄露的发生。<br>所以后续讲解时我们有时会用<code>Subscriber</code>来代替<code>Observer</code>。</li>
</ul>
</li>
<li><p>调用<code>subscribe()</code>方法(订阅)</p>
<p>  创建了一个<code>Observable</code>和<code>Observer</code>之后，再用<code>subscribe()</code>方法将它们联结起来，整条链子就可以工作了。代码形式很简单：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">observable.subscribe(observer);  </div><div class="line"><span class="comment">// 或者：</span></div><div class="line">observable.subscribe(subscriber);</div></pre></td></tr></table></figure>
<blockquote>
<p>有人可能会注意到，<code>subscribe()</code>这个方法有点怪：它看起来是<code>observalbe</code>订阅了<code>observer/subscriber</code>而不是<code>observer/subscriber</code>订阅了<code>observalbe</code>，这看起来就像『杂志订阅了读者』一样颠倒了对象关系。这让人读起来有点别扭，不过如果把<code>API</code>设计成<code>observer.subscribe(observable)/subscriber.subscribe(observable)</code> ，虽然更加符合思维逻辑，但对流式<code>API</code>的设计就造成影响了，比较起来明显是得不偿失的。</p>
</blockquote>
</li>
</ul>
<h2 id="RxJava入门示例"><a href="#RxJava入门示例" class="headerlink" title="RxJava入门示例"></a><code>RxJava</code>入门示例</h2><p>一个<code>Observable</code>可以发出零个或者多个事件，知道结束或者出错。每发出一个事件，就会调用它的<code>Subscriber</code>的<code>onNext</code>方法，最后调用<code>Subscriber.onComplete()</code>或者<code>Subscriber.onError()</code>结束。</p>
<p>####<code>Hello World</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">compile &apos;io.reactivex:rxandroid:1.2.1&apos;</div><div class="line">// Because RxAndroid releases are few and far between, it is recommended you also</div><div class="line">// explicitly depend on RxJava&apos;s latest version for bug fixes and new features.</div><div class="line">compile &apos;io.reactivex:rxjava:1.2.3&apos;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建被观察者、数据源</span></div><div class="line">Observable&lt;String&gt; observable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber)</span> </span>&#123;</div><div class="line">        <span class="comment">// 可以看到，这里传入了一个 OnSubscribe 对象作为参数。OnSubscribe 会被存储在返回的 Observable 对象中，它的作用相当于一个计划表，当 Observable      </span></div><div class="line">        <span class="comment">//被订阅的时候，OnSubscribe 的 call() 方法会自动被调用，事件序列就会依照设定依次触发（对于上面的代码，就是观察者Subscriber 将会被调用三次 onNext() 和一次 </span></div><div class="line">        <span class="comment">// onCompleted()）。这样，由被观察者调用了观察者的回调方法，就实现了由被观察者向观察者的事件传递，即观察者模式。</span></div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call"</span>);</div><div class="line">        subscriber.onNext(<span class="string">"Hello "</span>);</div><div class="line">        subscriber.onNext(<span class="string">"World !"</span>);</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 创建观察者</span></div><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onCompleted"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onError"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onNext : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 关联或者叫订阅更合适。</span></div><div class="line">observable.subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>一旦<code>subscriber</code>订阅了<code>observable</code>，<code>observable</code>就会调用<code>subscriber</code>对象的<code>onNext</code>和<code>onComplete</code>方法，<code>subscriber</code>就会打印出<code>Hello World</code>.        </p>
<p> <code>Observable.subscribe(Subscriber)</code>的内部实现是这样的（仅核心代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意：这不是`subscribe()`的源码，而是将源码中与性能、兼容性、扩展性有关的代码剔除后的核心代码。</span></div><div class="line"><span class="function"><span class="keyword">public</span> Subscription <span class="title">subscribe</span><span class="params">(Subscriber subscriber)</span> </span>&#123;</div><div class="line">   subscriber.onStart();</div><div class="line">   onSubscribe.call(subscriber);</div><div class="line">   <span class="keyword">return</span> subscriber;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到<code>subscriber()</code>做了3件事：</p>
<ul>
<li>调用<code>Subscriber.onStart()</code>。这个方法在前面已经介绍过，是一个可选的准备方法。</li>
<li>调用<code>Observable</code>中的<code>onSubscribe.call(Subscriber)</code>。在这里，事件发送的逻辑开始运行。从这也可以看出，在<code>RxJava</code>中，<code>Observable</code> 并不是在创建的时候就立即开始发送事件，而是在它被订阅的时候，即当<code>subscribe()</code>方法执行的时候。</li>
<li>将传入的<code>Subscriber</code>作为<code>Subscription</code>返回。这是为了方便<code>unsubscribe()</code>.</li>
</ul>
<p>整个过程中对象间的关系如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observable_list.gif?raw=true" alt="image"></p>
<p>讲到这里很多人肯定会骂傻<code>X</code>,这TM简洁你妹啊…，这里只是个入门<code>Hello World</code>，真正的简洁等你看完全部介绍后就明白了。</p>
<p><code>RxJava</code>内置了很多简化创建<code>Observable</code>对象的函数，比如<code>Observable.just()</code>就是用来创建只发出一个事件就结束的<code>Observable</code>对象，上面创建<code>Observable</code>对象的代码可以简化为一行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; observable = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div></pre></td></tr></table></figure>
<p>接下来看看如何简化<code>Subscriber</code>，上面的例子中，我们其实并不关心<code>onComplete()</code>和<code>onError</code>，我们只需要在<code>onNext</code>的时候做一些处理，这时候就可以使用<code>Action1</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Action1&lt;String&gt; action1 = <span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>Observable.subscribe()</code>方法有一个重载版本，接受三个<code>Action1</code>类型的参数      </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_subscribe_params.png?raw=true" alt="image"></p>
<p>所以上面的代码最终可以写成这样:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里顺便多提一些<code>subscribe()</code>的多个<code>Action</code>参数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Action1&lt;String&gt; onNextAction = <span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="comment">// onNext()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Action1&lt;Throwable&gt; onErrorAction = <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line">    <span class="comment">// onError()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">        <span class="comment">// Error handling</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Action0 onCompletedAction = <span class="keyword">new</span> Action0() &#123;</div><div class="line">    <span class="comment">// onCompleted()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"completed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">observable.subscribe(onNextAction, onErrorAction, onCompletedAction);</div></pre></td></tr></table></figure></p>
<p>简单解释一下这段代码中出现的<code>Action1</code>和<code>Action0</code>。<code>Action0</code>是<code>RxJava</code>的一个接口，它只有一个方法<code>call()</code>，这个方法是无参无返回值的；由于<code>onCompleted()</code> 方法也是无参无返回值的，因此<code>Action0</code>可以被当成一个包装对象，将<code>onCompleted()</code>的内容打包起来将自己作为一个参数传入<code>subscribe()</code>以实现不完整定义的回调。这样其实也可以看做将 <code>onCompleted()</code>方法作为参数传进了<code>subscribe()</code>，相当于其他某些语言中的『闭包』。<code>Action1</code>也是一个接口，它同样只有一个方法<code>call(T param)</code>，这个方法也无返回值，但有一个参数；与<code>Action0</code>同理，由于<code>onNext(T obj)</code>和<code>onError(Throwable error)</code>也是单参数无返回值的，因此<code>Action1</code>可以将<code>onNext(obj)</code>和<code>onError(error)</code>打包起来传入<code>subscribe()</code>以实现不完整定义的回调。事实上，虽然<code>Action0</code>和<code>Action1</code>在<code>API</code>中使用最广泛，但<code>RxJava</code>是提供了多个<code>ActionX</code>形式的接口(例如<code>Action2</code>, <code>Action3</code>)的，它们可以被用以包装不同的无返回值的方法。</p>
<p>假设我们的<code>Observable</code>是第三方提供的，它提供了大量的用户数据给我们，而我们需要从用户数据中筛选部分有用的信息，那我们该怎么办呢？<br>从<code>Observable</code>中去修改肯定是不现实的？那从<code>Subscriber</code>中进行修改呢？ 这样好像是可以完成的。但是这种方式并不好，因为我们希望<code>Subscriber</code>越轻量越好，因为很有可能我们需要<br>在主线程中去执行<code>Subscriber</code>。另外，根据响应式函数编程的概念，<code>Subscribers</code>更应该做的事情是<code>响应</code>，响应<code>Observable</code>发出的事件，而不是去修改。<br>那该怎么办呢？ 这就要用到下面的部分要讲的操作符。  </p>
<h2 id="操作符-Operators"><a href="#操作符-Operators" class="headerlink" title="操作符(Operators)"></a>操作符(<code>Operators</code>)</h2><p><code>RxJava</code>提供了对事件序列进行变换的支持，这是它的核心功能之一.所谓变换，就是将事件序列中的对象或整个序列进行加工处理，转换成不同的事件或事件序列。<br>操作符就是为了解决对<code>Observable</code>对象的变换的问题，操作符用于在<code>Observable</code>和最终的<code>Subscriber</code>之间修改<code>Observable</code>发出的事件。<code>RxJava</code>提供了很多很有用的操作符。<br>比如<code>map</code>操作符，就是用来把把一个事件转换为另一个事件的。</p>
<p>####<code>map</code></p>
<p><code>Returns an Observable that applies a specified function to each item emitted by the source Observable and emits the results of these function applications.</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; just = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div><div class="line">Observable&lt;String&gt; map = just.map(<span class="keyword">new</span> Func1&lt;String, String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s + <span class="string">"@@@"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">map.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的代码打印出的结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12-12 15:51:22.184 472-472/com.charon.rxjavastudydemo I/@@@: Hello @@@</div><div class="line">12-12 15:51:22.184 472-472/com.charon.rxjavastudydemo I/@@@: World !@@@</div></pre></td></tr></table></figure></p>
<p><code>map()</code>操作符就是用于变换<code>Observable</code>对象的，<code>map</code>操作符返回一个<code>Observable</code>对象，这样就可以实现链式调用，在一个<code>Observable</code>对象上多次使用map操作符，最终将最简洁的数据传递给<code>Subscriber</code>对象。</p>
<p><code>map</code>操作符更有趣的一点是它不必返回Observable对象返回的类型，你可以使用<code>map</code>操作符返回一个发出新的数据类型的<code>Observable</code>对象。<br>比如上面的例子中，<code>Subscriber</code>并不关心返回的字符串，而是想要字符串的<code>hash</code>值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; just = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div><div class="line">Observable&lt;Integer&gt; map = just.map(<span class="keyword">new</span> Func1&lt;String, Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s.hashCode();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">map.subscribe(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">""</span> + integer);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面部分的打印结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12-12 15:54:35.515 8521-8521/com.charon.rxjavastudydemo I/@@@: -2137068114</div><div class="line">12-12 15:54:35.516 8521-8521/com.charon.rxjavastudydemo I/@@@: -1105126669</div></pre></td></tr></table></figure></p>
<p><code>map()</code>的示意图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_map.jpg?raw=true" alt="image"></p>
<p>通过上面的部分我们可以得知:   </p>
<ul>
<li><p><code>Observable</code>和<code>Subscriber</code>可以做任何事情<br>  <code>Observable</code>可以是一个数据库查询，<code>Subscriber</code>用来显示查询结果；<code>Observable</code>可以是屏幕上的点击事件，<code>Subscriber</code>用来响应点击事件；<code>Observable</code>可以是一个网络请求，<code>Subscriber</code>用来显示请求结果。</p>
</li>
<li><p><code>Observable</code>和<code>Subscriber</code>是独立于中间的变换过程的。<br>  在<code>Observable</code>和<code>Subscriber</code>中间 可以增减任何数量的<code>map</code>。整个系统是高度可组合的，操作数据是一个很简单的过程。</p>
</li>
</ul>
<p>####<code>flatmap</code></p>
<p><code>Returns an Observable that emits items based on applying a function that you supply to each item emitted 
 by the source Observable, where that function returns an Observable, and then merging those resulting 
 Observables and emitting the results of this merger.</code></p>
<p><code>flatMap()</code>是一个很有用但非常难理解的变换，首先假设这么一种需求：假设有一个数据结构『学生』，现在需要打印出一组学生的名字。实现方式很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        Log.d(tag, name);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .map(<span class="keyword">new</span> Func1&lt;Student, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> student.getName();</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>很简单。那么再假设：如果要打印出每个学生所需要修的所有课程的名称呢?(需求的区别在于，每个学生只有一个名字，但却有多个课程)首先可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;Student&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Student&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">        List&lt;Course&gt; courses = student.getCourses();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; courses.size(); i++) &#123;</div><div class="line">            Course course = courses.get(i);</div><div class="line">            Log.d(tag, course.getName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>依然很简单。那么如果我不想在<code>Subscriber</code>中使用<code>for</code>循环，而是希望<code>Subscriber</code>中直接传入单个的<code>Course</code>对象呢(这对于代码复用很重要),用<code>map()</code>显然是不行的，因为<code>map()</code> 是一对一的转化，而我现在的要求是一对多的转化。那怎么才能把一个<code>Student</code>转化成多个<code>Course</code>呢？</p>
<p>这个时候，就需要用<code>flatMap()</code>了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;Course&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Course&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Course course)</span> </span>&#123;</div><div class="line">        Log.d(tag, course.getName());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .flatMap(<span class="keyword">new</span> Func1&lt;Student, Observable&lt;Course&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;Course&gt; <span class="title">call</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Observable.from(student.getCourses());</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure></p>
<p><code>map</code>与<code>flatmap</code>在功能上是一致的,它也是把传入的参数转化之后返回另一个对象。区别在于<code>flatmap</code>是通过中间<code>Observable</code>来进行，而<code>map</code>是直接执行.<code>flatMap()</code>中返回的是个 <code>Observable</code>对象，并且这个<code>Observable</code>对象并不是被直接发送到了<code>Subscriber</code>的回调方法中。 </p>
<p><code>flatMap()</code>的原理是这样的:  </p>
<ul>
<li>使用传入的事件对象创建一个<code>Observable</code>对象</li>
<li>并不发送这个<code>Observable</code>而是将它激活，于是它开始发送事件</li>
<li>每一个创建出来的<code>Observable</code>发送的事件，都被汇入同一个<code>Observable</code>,而这个<code>Observable</code>负责将这些事件统一交给<code>Subscriber</code> 的回调方法。</li>
</ul>
<p>这三个步骤，把事件拆成了两级，通过一组新创建的<code>Observable</code>将初始的对象『铺平』之后通过统一路径分发了下去。而这个『铺平』就是<code>flatMap()</code>所谓的<code>flat</code>。</p>
<p><code>flatMap()</code>就是根据你的规则，将<code>Observable</code>转换之后再发射出去，注意最后的顺序很可能是错乱的，如果要保证顺序的一致性，要使用<code>concatMap()</code><br>由于可以在嵌套的<code>Observable</code>中添加异步代码<code>flatMap()</code>也常用于嵌套的异步操作，例如嵌套的网络请求<code>(Retrofit + RxJava)</code></p>
<p><code>flatMap()</code>示意图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_flatmap.jpg?raw=true" alt="image"></p>
<p>####<code>throttleFirst()</code></p>
<p>在每次事件触发后的一定时间间隔内丢弃新的事件。常用作去抖动过滤。<br>例如按钮的点击监听器:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RxView.clickEvents(button); <span class="comment">// RxBinding 代码`</span></div><div class="line">    .throttleFirst(<span class="number">500</span>, TimeUnit.MILLISECONDS) <span class="comment">// 设置防抖间隔为 500ms </span></div><div class="line">    .subscribe(subscriber); <span class="comment">// 妈妈再也不怕我的用户手抖点开两个重复的界面啦。</span></div></pre></td></tr></table></figure></p>
<p>####<code>from</code></p>
<p><code>convert various other objects and data types into Observables</code></p>
<p><code>from()</code>接收一个集合作为输入，然后每次输出一个元素给<code>subscriber</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; s = Arrays.asList(<span class="string">"Java"</span>, <span class="string">"Android"</span>, <span class="string">"Ruby"</span>, <span class="string">"Ios"</span>, <span class="string">"Swift"</span>);</div><div class="line">Observable.from(s).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>####<code>filter</code></p>
<p>返回满足过滤条件的数据。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable.from(<span class="keyword">new</span> Integer[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;)</div><div class="line">                .filter(<span class="keyword">new</span> Func1&lt;Integer, Boolean&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> integer &lt; <span class="number">5</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .subscribe(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        Log.i(<span class="string">"@@@"</span>, <span class="string">"integer="</span> + integer); <span class="comment">//1,2,3,4</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>####<code>timer</code></p>
<p><code>Timer</code>会在指定时间后发射一个数字0，该操作符运行在<code>Computation Scheduler</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Observable.timer(<span class="number">3</span>, TimeUnit.SECONDS).observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribe(<span class="keyword">new</span> Action1&lt;Long&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                        Log.i(<span class="string">"@@@"</span>, <span class="string">"aLong="</span> + aLong); <span class="comment">// 延时3s</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>####<code>interval</code></p>
<p>创建一个按固定时间间隔发射整数序列的<code>Observable</code>.<br><code>interval</code>默认在<code>computation</code>调度器上执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS, AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;Long&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                Log.i(<span class="string">"@@@"</span>, <span class="string">"aLong="</span> + aLong); <span class="comment">//从0递增，间隔1s 0,1,2,3....</span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>####<code>Repeat</code></p>
<p>重复执行 </p>
<p>等等…就不继续介绍了，到时候查下文档就好了。</p>
<p>是不是感觉没什么乱用，那就继续看下一部分吧。</p>
<p>更多内容请看下一篇文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/RxJava%E8%AF%A6%E8%A7%A3(%E4%B8%AD">RxJava详解(下)</a>.md)</p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(上)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Volley源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Volley源码分析/">Volley简介</a>
    </h1>
  

        
        <a href="/2015/01/01/Volley源码分析/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Volley源码分析"><a href="#Volley源码分析" class="headerlink" title="Volley源码分析"></a>Volley源码分析</h2><ul>
<li><p>Volley简介    </p>
<p>  <a href="https://android.googlesource.com/platform/frameworks/volley" target="_blank" rel="external">volley官方地址</a><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/volley.png?raw=true" alt="image">                   </p>
<p>  在<code>Google I/0 2013</code>中发布了<code>Volley</code>.<code>Volley</code>是<code>Android</code>平台上的网络通信库，能使网络通信更快，更简单，更健壮。</p>
<p>  这是<code>Volley</code>名称的由来:<code>a burst or emission of many things or a large amount at once</code>.<code>Volley</code>特别适合数据量不大但是通信频繁的场景。   </p>
<p>  <code>Github</code>上面已经有大神做了镜像，使用<code>Gradle</code>更方便。<a href="https://github.com/mcxiaoke/android-volley">Volley On Github</a>            </p>
</li>
<li><p>Volley使用<br>  <code>Volley</code>的使用非常方便。</p>
<ul>
<li>首先就是要构建一个<code>RequestQueue</code>的请求队列，它可以缓存所有<code>Http</code>请求，内部处理的非常完善，通常我们整个应用只需要一个<code>RequestQueue</code>对象即可。</li>
<li>创建<code>StringRequest</code>对象，并且传入相应的请求地址以及添加请求成功和失败的回调方法。这一步的意思就是创建一个新的网络请求。</li>
<li><p>将刚才新创建的<code>StringRequest</code>对象加入到<code>RequestQueue</code>队列中。这样就相当于会去执行该请求。等到执行成功后就可以在<code>StringRequest</code>中设置的回调方法里面获取到相应的结果。<br>总结一下，其实挺像我们浏览器的操作，第一步打开浏览器，第二步输入<code>URL</code>地址第三步按回车去执行。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtil</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HttpUtil instance;</div><div class="line">    <span class="keyword">private</span> RequestQueue mQueue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpUtil</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mQueue = Volley.newRequestQueue(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> HttpUtil <span class="title">getInstance</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">            instance = <span class="keyword">new</span> HttpUtil(context.getApplicationContext());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Request <span class="title">sendGetRequest</span><span class="params">(String url, <span class="keyword">final</span> HttpListener listener)</span> </span>&#123;</div><div class="line">        StringRequest stringRequest = <span class="keyword">new</span> StringRequest(url, <span class="keyword">new</span> Response.Listener&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onResponse(response);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="keyword">new</span> Response.ErrorListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onErrorResponse(error);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mQueue.add(stringRequest);</div><div class="line">        <span class="keyword">return</span> stringRequest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Request <span class="title">sendPostRequest</span><span class="params">(String url, <span class="keyword">final</span> Map&lt;String, String&gt; map, <span class="keyword">final</span> HttpListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> StringRequest stringRequest = <span class="keyword">new</span> StringRequest(Request.Method.POST, url, <span class="keyword">new</span> Response.Listener&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onResponse(response);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="keyword">new</span> Response.ErrorListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onErrorResponse(error);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Map&lt;String, String&gt; <span class="title">getParams</span><span class="params">()</span> <span class="keyword">throws</span> AuthFailureError </span>&#123;</div><div class="line">                <span class="keyword">return</span> map;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        mQueue.add(stringRequest);</div><div class="line">        <span class="keyword">return</span> stringRequest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Response listener of HttpUtil.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpListener</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>到这里我们就简单的介绍了它的使用，当然还有一些其他的<code>Request</code>对象例如<code>JsonRequest</code>等，他们的使用方法都是一样的，这里就不再说明了。当然<code>Volley</code>里面还提供了对图片的处理，例如<code>NetworkImageView</code>空间和<code>ImageRequest</code>等，因为这里图片用到的不太多，所以暂时不去分析了。</p>
<p>接下来我们就从源码的角度去分析一下：<br>这里我们都知道使用的时候最新要初始化一个<code>RequestQueue</code>所以，我们首先看一下<code>Volley.newRequestQueue</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Volley</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** Default on-disk cache directory. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CACHE_DIR = <span class="string">"volley"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     * You may set a maximum size of the disk cache in bytes.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@param</span> stack An &#123;<span class="doctag">@link</span> HttpStack&#125; to use for the network, or null for default.</div><div class="line">     * <span class="doctag">@param</span> maxDiskCacheBytes the maximum size of the disk cache, in bytes. Use -1 for default size.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, HttpStack stack, <span class="keyword">int</span> maxDiskCacheBytes)</span> </span>&#123;</div><div class="line">        File cacheDir = <span class="keyword">new</span> File(context.getCacheDir(), DEFAULT_CACHE_DIR);</div><div class="line"></div><div class="line">        String userAgent = <span class="string">"volley/0"</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String packageName = context.getPackageName();</div><div class="line">            PackageInfo info = context.getPackageManager().getPackageInfo(packageName, <span class="number">0</span>);</div><div class="line">            <span class="comment">// 使用包名和versionCode作为userAgent</span></div><div class="line">            userAgent = packageName + <span class="string">"/"</span> + info.versionCode;</div><div class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (stack == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">9</span>) &#123;</div><div class="line">                <span class="comment">// 在9及以上Volleys使用HttpURLConnection，9一下使用HttpClient。这里是有原因的，因为在9之前HttpURLConnection有Bug。</span></div><div class="line">                <span class="comment">// 那HttpClient那么好为什么不一直使用它，要在9及以后使用HttpURLConnection呢？这里也是有原因的。从9开始HttpURLConnection</span></div><div class="line">                <span class="comment">// 将自动添加`Accept-Encoding:gzip`头字段到`request`请求中，并做相应处理，一般我们请求都是字符串，所以压缩可以使数据大小大幅降低。</span></div><div class="line">                <span class="comment">// 但是这也会带来问题的，之前开发中就遇到过。因为启用了压缩，所以`Content-Lenght`字段返回的是压缩后的大小。使用`getContentLength()`</span></div><div class="line">                <span class="comment">// 方法去分配解压缩后数据大小是错误的。应该从response中读取字节直到`InputStream.read()`返回-1为止。当时我们在开发下载时就遇到过这个</span></div><div class="line">                <span class="comment">// 问题，在下载视频时没有问题，但是在下载小说的时候就会发现`content-length`返回值不对。</span></div><div class="line">                <span class="comment">// 总结一下就是在9之前HttpClient的bug更少，而HttpURLConnection存在严重的Bug。但是从9开始HttpURLConnection更小巧，API更简单，压缩以及</span></div><div class="line">                <span class="comment">// response cache的使用减少了网络流量，提高了网络速度，也就更省电，所以更适合在Android中使用</span></div><div class="line">                stack = <span class="keyword">new</span> HurlStack();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Prior to Gingerbread, HttpUrlConnection was unreliable.</span></div><div class="line">                <span class="comment">// See: http://android-developers.blogspot.com/2011/09/androids-http-clients.html</span></div><div class="line">                stack = <span class="keyword">new</span> HttpClientStack(AndroidHttpClient.newInstance(userAgent));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 创建BasicNetwork对象，下面会介绍BasicNetwork(HttpStack)方法的内部实现</span></div><div class="line">        Network network = <span class="keyword">new</span> BasicNetwork(stack);</div><div class="line">        </div><div class="line">        RequestQueue queue;</div><div class="line">        <span class="keyword">if</span> (maxDiskCacheBytes &lt;= -<span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">                <span class="comment">// 如果不指定大小的话，默认大小为5M</span></div><div class="line">            <span class="comment">// No maximum size specified</span></div><div class="line">        	queue = <span class="keyword">new</span> RequestQueue(<span class="keyword">new</span> DiskBasedCache(cacheDir), network);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">        	<span class="comment">// Disk cache size specified</span></div><div class="line">        	queue = <span class="keyword">new</span> RequestQueue(<span class="keyword">new</span> DiskBasedCache(cacheDir, maxDiskCacheBytes), network);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        queue.start();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> queue;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     * You may set a maximum size of the disk cache in bytes.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@param</span> maxDiskCacheBytes the maximum size of the disk cache, in bytes. Use -1 for default size.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, <span class="keyword">int</span> maxDiskCacheBytes)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> newRequestQueue(context, <span class="keyword">null</span>, maxDiskCacheBytes);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@param</span> stack An &#123;<span class="doctag">@link</span> HttpStack&#125; to use for the network, or null for default.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, HttpStack stack)</span></span></div><div class="line">    &#123;</div><div class="line">    	<span class="keyword">return</span> newRequestQueue(context, stack, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> newRequestQueue(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着来看一上上面提到的new BasicNetwork(HttpStack)方法的实现,可以看到他内部的缓存大小是4k<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_POOL_SIZE = <span class="number">4096</span>;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HttpStack mHttpStack;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ByteArrayPool mPool;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@param</span> httpStack HTTP stack to be used</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasicNetwork</span><span class="params">(HttpStack httpStack)</span> </span>&#123;</div><div class="line">    <span class="comment">// If a pool isn't passed in, then build a small default pool that will give us a lot of</span></div><div class="line">    <span class="comment">// benefit and not use too much memory.</span></div><div class="line">    <span class="keyword">this</span>(httpStack, <span class="keyword">new</span> ByteArrayPool(DEFAULT_POOL_SIZE));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@param</span> httpStack HTTP stack to be used</div><div class="line"> * <span class="doctag">@param</span> pool a buffer pool that improves GC performance in copy operations</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasicNetwork</span><span class="params">(HttpStack httpStack, ByteArrayPool pool)</span> </span>&#123;</div><div class="line">    mHttpStack = httpStack;</div><div class="line">    mPool = pool;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着我们还要分析一下<code>RequestQueue</code>的构造方法以及<code>start()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A request dispatch queue with a thread pool of dispatchers.</div><div class="line"> *</div><div class="line"> * Calling &#123;<span class="doctag">@link</span> #add(Request)&#125; will enqueue the given Request for dispatch,</div><div class="line"> * resolving from either cache or network on a worker thread, and then delivering</div><div class="line"> * a parsed response on the main thread.</div><div class="line"> */<span class="comment">/**</span></div><div class="line"> * A request dispatch queue with a thread pool of dispatchers.</div><div class="line"> *</div><div class="line"> * Calling &#123;<span class="doctag">@link</span> #add(Request)&#125; will enqueue the given Request for dispatch,</div><div class="line"> * resolving from either cache or network on a worker thread, and then delivering</div><div class="line"> * a parsed response on the main thread.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** Used for generating monotonically-increasing sequence numbers for requests. */</span></div><div class="line">    <span class="keyword">private</span> AtomicInteger mSequenceGenerator = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Staging area for requests that already have a duplicate request in flight.</div><div class="line">     *</div><div class="line">     * &lt;ul&gt;</div><div class="line">     *     &lt;li&gt;containsKey(cacheKey) indicates that there is a request in flight for the given cache</div><div class="line">     *          key.&lt;/li&gt;</div><div class="line">     *     &lt;li&gt;get(cacheKey) returns waiting requests for the given cache key. The in flight request</div><div class="line">     *          is &lt;em&gt;not&lt;/em&gt; contained in that list. Is null if no requests are staged.&lt;/li&gt;</div><div class="line">     * &lt;/ul&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Queue&lt;Request&lt;?&gt;&gt;&gt; mWaitingRequests =</div><div class="line">            <span class="keyword">new</span> HashMap&lt;String, Queue&lt;Request&lt;?&gt;&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The set of all requests currently being processed by this RequestQueue. A Request</div><div class="line">     * will be in this set if it is waiting in any queue or currently being processed by</div><div class="line">     * any dispatcher.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Request&lt;?&gt;&gt; mCurrentRequests = <span class="keyword">new</span> HashSet&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">	<span class="comment">// cache队列</span></div><div class="line">    <span class="comment">/** The cache triage queue. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt; mCacheQueue =</div><div class="line">        <span class="keyword">new</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">	<span class="comment">// 网络请求队列</span></div><div class="line">    <span class="comment">/** The queue of requests that are actually going out to the network. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt; mNetworkQueue =</div><div class="line">        <span class="keyword">new</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** Number of network request dispatcher threads to start. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_NETWORK_THREAD_POOL_SIZE = <span class="number">4</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Cache interface for retrieving and storing responses. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line"></div><div class="line">    <span class="comment">/** Network interface for performing requests. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Network mNetwork;</div><div class="line"></div><div class="line">    <span class="comment">/** Response delivery mechanism. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line"></div><div class="line">    <span class="comment">/** The network dispatchers. */</span></div><div class="line">    <span class="keyword">private</span> NetworkDispatcher[] mDispatchers;</div><div class="line"></div><div class="line">    <span class="comment">/** The cache dispatcher. */</span></div><div class="line">    <span class="keyword">private</span> CacheDispatcher mCacheDispatcher;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</div><div class="line">     * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</div><div class="line">     * <span class="doctag">@param</span> threadPoolSize Number of network dispatcher threads to create</div><div class="line">     * <span class="doctag">@param</span> delivery A ResponseDelivery interface for posting responses and errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network, <span class="keyword">int</span> threadPoolSize,</span></span></div><div class="line">            ResponseDelivery delivery) &#123;</div><div class="line">        mCache = cache;</div><div class="line">        mNetwork = network;</div><div class="line">        mDispatchers = <span class="keyword">new</span> NetworkDispatcher[threadPoolSize];</div><div class="line">        mDelivery = delivery;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</div><div class="line">     * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</div><div class="line">     * <span class="doctag">@param</span> threadPoolSize Number of network dispatcher threads to create</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network, <span class="keyword">int</span> threadPoolSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(cache, network, threadPoolSize,</div><div class="line">                <span class="keyword">new</span> ExecutorDelivery(<span class="keyword">new</span> Handler(Looper.getMainLooper())));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</div><div class="line">     * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network)</span> </span>&#123;</div><div class="line">        <span class="comment">// 默认大小为4</span></div><div class="line">        <span class="keyword">this</span>(cache, network, DEFAULT_NETWORK_THREAD_POOL_SIZE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Starts the dispatchers in this queue.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        stop();  <span class="comment">// Make sure any currently running dispatchers are stopped.</span></div><div class="line">        <span class="comment">// Create the cache dispatcher and start it.</span></div><div class="line">        <span class="comment">// 初始化RequestQueue之后就会调用start方法，内部会开启CacheDispatcher,也是Thread的子类，后面再看里面具体的run方法</span></div><div class="line">        mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(mCacheQueue, mNetworkQueue, mCache, mDelivery);</div><div class="line">        mCacheDispatcher.start();</div><div class="line"></div><div class="line">        <span class="comment">// Create network dispatchers (and corresponding threads) up to the pool size.</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</div><div class="line">            <span class="comment">// 创建4个(默认是4个)NetworkDispatcher一直去执行, NetworkDispatcher是Thread的子类，他会不断的去从mNetworkQueue中取出Requet并用</span></div><div class="line">            <span class="comment">// 并用mNetwork去执行，执行完成后再使用mDelivery去分发相应的结果</span></div><div class="line">            NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatcher(mNetworkQueue, mNetwork,</div><div class="line">                    mCache, mDelivery);</div><div class="line">            mDispatchers[i] = networkDispatcher;</div><div class="line">            networkDispatcher.start();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 就好像一个工厂一启动，里面就分配了5个搬运工，一个负责搬运cache里面的的请求，4个负责搬运network中的。启动后他们就开始待命</span></div><div class="line">        <span class="comment">// 一旦有活来了，就开始去取出活开始干。</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Stops the cache and network dispatchers.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mCacheDispatcher != <span class="keyword">null</span>) &#123;</div><div class="line">            mCacheDispatcher.quit();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (mDispatchers[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                mDispatchers[i].quit();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gets a sequence number.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSequenceNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mSequenceGenerator.incrementAndGet();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gets the &#123;<span class="doctag">@link</span> Cache&#125; instance being used.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mCache;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A simple predicate or filter interface for Requests, for use by</div><div class="line">     * &#123;<span class="doctag">@link</span> RequestQueue#cancelAll(RequestFilter)&#125;.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestFilter</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(Request&lt;?&gt; request)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cancels all requests in this queue for which the given filter applies.</div><div class="line">     * <span class="doctag">@param</span> filter The filtering function to use</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(RequestFilter filter)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</div><div class="line">            <span class="keyword">for</span> (Request&lt;?&gt; request : mCurrentRequests) &#123;</div><div class="line">                <span class="keyword">if</span> (filter.apply(request)) &#123;</div><div class="line">                    request.cancel();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cancels all requests in this queue with the given tag. Tag must be non-null</div><div class="line">     * and equality is by identity.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(<span class="keyword">final</span> Object tag)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (tag == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot cancelAll with a null tag"</span>);</div><div class="line">        &#125;</div><div class="line">        cancelAll(<span class="keyword">new</span> RequestFilter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(Request&lt;?&gt; request)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> request.getTag() == tag;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Adds a Request to the dispatch queue.</div><div class="line">     * <span class="doctag">@param</span> request The request to service</div><div class="line">     * <span class="doctag">@return</span> The passed-in request</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">add</span><span class="params">(Request&lt;T&gt; request)</span> </span>&#123;</div><div class="line">        <span class="comment">// Tag the request as belonging to this queue and add it to the set of current requests.</span></div><div class="line">        request.setRequestQueue(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</div><div class="line">            <span class="comment">// 添加到mCurrentRequests中，在执行完后的finish方法中会去移除该请求。</span></div><div class="line">            mCurrentRequests.add(request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Process requests in the order they are added.</span></div><div class="line">        request.setSequence(getSequenceNumber());</div><div class="line">        request.addMarker(<span class="string">"add-to-queue"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 判断一下该请求能否进行缓存，如果不能缓存就直接添加到网络请求的队列中。这个能不能缓存是怎么判断的？其实就是根据Request中的一个变量来判断。</span></div><div class="line">　　　　<span class="comment">// 默认情况下所有的请求都是可以缓存的，可以通过Request.setShouldCache(false)方法，来将其设置为不可缓存状态。</span></div><div class="line">        <span class="comment">// If the request is uncacheable, skip the cache queue and go straight to the network.</span></div><div class="line">        <span class="keyword">if</span> (!request.shouldCache()) &#123;</div><div class="line">            mNetworkQueue.add(request);</div><div class="line">            <span class="keyword">return</span> request;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Insert request into stage if there's already a request with the same cache key in flight.</span></div><div class="line">        <span class="keyword">synchronized</span> (mWaitingRequests) &#123;</div><div class="line">            String cacheKey = request.getCacheKey();</div><div class="line">            <span class="keyword">if</span> (mWaitingRequests.containsKey(cacheKey)) &#123;</div><div class="line">                <span class="comment">// There is already a request in flight. Queue up.</span></div><div class="line">                Queue&lt;Request&lt;?&gt;&gt; stagedRequests = mWaitingRequests.get(cacheKey);</div><div class="line">                <span class="keyword">if</span> (stagedRequests == <span class="keyword">null</span>) &#123;</div><div class="line">                    stagedRequests = <span class="keyword">new</span> LinkedList&lt;Request&lt;?&gt;&gt;();</div><div class="line">                &#125;</div><div class="line">                stagedRequests.add(request);</div><div class="line">                mWaitingRequests.put(cacheKey, stagedRequests);</div><div class="line">                <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</div><div class="line">                    VolleyLog.v(<span class="string">"Request for cacheKey=%s is in flight, putting on hold."</span>, cacheKey);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果能缓存，并且缓存线程中没有的时候就讲该请求添加到缓存队列中</span></div><div class="line">                <span class="comment">// Insert 'null' queue for this cacheKey, indicating there is now a request in</span></div><div class="line">                <span class="comment">// flight.</span></div><div class="line">                mWaitingRequests.put(cacheKey, <span class="keyword">null</span>);</div><div class="line">                mCacheQueue.add(request);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> request;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called from &#123;<span class="doctag">@link</span> Request#finish(String)&#125;, indicating that processing of the given request</div><div class="line">     * has finished.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Releases waiting requests for &lt;code&gt;request.getCacheKey()&lt;/code&gt; if</div><div class="line">     *      &lt;code&gt;request.shouldCache()&lt;/code&gt;.&lt;/p&gt;</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(Request&lt;?&gt; request)</span> </span>&#123;</div><div class="line">        <span class="comment">// Remove from the set of requests currently being processed.</span></div><div class="line">        <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</div><div class="line">            mCurrentRequests.remove(request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.shouldCache()) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (mWaitingRequests) &#123;</div><div class="line">                String cacheKey = request.getCacheKey();</div><div class="line">                Queue&lt;Request&lt;?&gt;&gt; waitingRequests = mWaitingRequests.remove(cacheKey);</div><div class="line">                <span class="keyword">if</span> (waitingRequests != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</div><div class="line">                        VolleyLog.v(<span class="string">"Releasing %d waiting requests for cacheKey=%s."</span>,</div><div class="line">                                waitingRequests.size(), cacheKey);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Process all queued up requests. They won't be considered as in flight, but</span></div><div class="line">                    <span class="comment">// that's not a problem as the cache has been primed by 'request'.</span></div><div class="line">                    mCacheQueue.addAll(waitingRequests);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到这里基本都能看的差不多了。官方文档中有句话说的很好，这里用他来总结一下<code>A RequestQueue needs two things to do its job: a network to perform transport of the requests, and a cache to handle caching.</code><br>顺便再上一张图:       </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/volley-request.png?raw=true" alt="image">                   </p>
<p>总结完之后我们接着进行分析。因为默认情况下请求都是可缓存的，所以都会被添加到mCacheQueue中。添加该队列之后，就会被开始<code>start</code>方法所制定的cache搬运工去执行，所以我们要看一下CacheDispatcher的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides a thread for performing cache triage on a queue of requests.</div><div class="line"> *</div><div class="line"> * Requests added to the specified cache queue are resolved from cache.</div><div class="line"> * Any deliverable response is posted back to the caller via a</div><div class="line"> * &#123;<span class="doctag">@link</span> ResponseDelivery&#125;.  Cache misses and responses that require</div><div class="line"> * refresh are enqueued on the specified network queue for processing</div><div class="line"> * by a &#123;<span class="doctag">@link</span> NetworkDispatcher&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheDispatcher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = VolleyLog.DEBUG;</div><div class="line"></div><div class="line">    <span class="comment">/** The queue of requests coming in for triage. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Request&lt;?&gt;&gt; mCacheQueue;</div><div class="line"></div><div class="line">    <span class="comment">/** The queue of requests going out to the network. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Request&lt;?&gt;&gt; mNetworkQueue;</div><div class="line"></div><div class="line">    <span class="comment">/** The cache to read from. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line"></div><div class="line">    <span class="comment">/** For posting responses. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line"></div><div class="line">    <span class="comment">/** Used for telling us to die. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mQuit = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new cache triage dispatcher thread.  You must call &#123;<span class="doctag">@link</span> #start()&#125;</div><div class="line">     * in order to begin processing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cacheQueue Queue of incoming requests for triage</div><div class="line">     * <span class="doctag">@param</span> networkQueue Queue to post requests that require network to</div><div class="line">     * <span class="doctag">@param</span> cache Cache interface to use for resolution</div><div class="line">     * <span class="doctag">@param</span> delivery Delivery interface to use for posting responses</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CacheDispatcher</span><span class="params">(</span></span></div><div class="line">            BlockingQueue&lt;Request&lt;?&gt;&gt; cacheQueue, BlockingQueue&lt;Request&lt;?&gt;&gt; networkQueue,</div><div class="line">            Cache cache, ResponseDelivery delivery) &#123;</div><div class="line">        <span class="comment">// 将CacheQueue以及networkQueue等传递进来。</span></div><div class="line">        mCacheQueue = cacheQueue;</div><div class="line">        mNetworkQueue = networkQueue;</div><div class="line">        mCache = cache;</div><div class="line">        mDelivery = delivery;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Forces this dispatcher to quit immediately.  If any requests are still in</div><div class="line">     * the queue, they are not guaranteed to be processed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        mQuit = <span class="keyword">true</span>;</div><div class="line">        interrupt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG) VolleyLog.v(<span class="string">"start new dispatcher"</span>);</div><div class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line"></div><div class="line">        <span class="comment">// Make a blocking call to initialize the cache.</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Performs any potentially long-running actions needed to initialize the cache;</div><div class="line">     * will be called from a worker thread.</div><div class="line">     */</div><div class="line">        mCache.initialize();</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 从缓存队列中取出第一个请求</span></div><div class="line">                <span class="comment">// Get a request from the cache triage queue, blocking until</span></div><div class="line">                <span class="comment">// at least one is available.</span></div><div class="line">                <span class="keyword">final</span> Request&lt;?&gt; request = mCacheQueue.take();</div><div class="line">                request.addMarker(<span class="string">"cache-queue-take"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If the request has been canceled, don't bother dispatching it.</span></div><div class="line">                <span class="keyword">if</span> (request.isCanceled()) &#123;</div><div class="line">                    request.finish(<span class="string">"cache-discard-canceled"</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Attempt to retrieve this item from cache.</span></div><div class="line">                Cache.Entry entry = mCache.get(request.getCacheKey());</div><div class="line">                <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// 如果缓存中找不到该请求，就把该请求添加到网络请求队列中。</span></div><div class="line">                    request.addMarker(<span class="string">"cache-miss"</span>);</div><div class="line">                    <span class="comment">// Cache miss; send off to the network dispatcher.</span></div><div class="line">                    mNetworkQueue.put(request);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 如果缓存中找到了该请求，接下来就判断该缓存是否过期。</span></div><div class="line">                <span class="comment">// If it is completely expired, just send it to the network.</span></div><div class="line">                <span class="keyword">if</span> (entry.isExpired()) &#123;</div><div class="line">                    <span class="comment">// 过期了也重新添加到网络请求中</span></div><div class="line">                    request.addMarker(<span class="string">"cache-hit-expired"</span>);</div><div class="line">                    request.setCacheEntry(entry);</div><div class="line">                    mNetworkQueue.put(request);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 没有过期，就不用再请求了，直接从缓存中取出数据返回即可。</span></div><div class="line">                <span class="comment">// We have a cache hit; parse its data for delivery back to the request.</span></div><div class="line">                request.addMarker(<span class="string">"cache-hit"</span>);</div><div class="line">                <span class="comment">// 这里的意思就是对数据进行解析，后面再看Request.parseNetworkResponse方法。</span></div><div class="line">                Response&lt;?&gt; response = request.parseNetworkResponse(</div><div class="line">                        <span class="keyword">new</span> NetworkResponse(entry.data, entry.responseHeaders));</div><div class="line">                request.addMarker(<span class="string">"cache-hit-parsed"</span>);</div><div class="line">		<span class="comment">// 判断缓存数据是否需要刷新，以便使用mDelivery分发结果或者添加到网络请求队列中</span></div><div class="line">                <span class="keyword">if</span> (!entry.refreshNeeded()) &#123;</div><div class="line">                    <span class="comment">// Completely unexpired cache hit. Just deliver the response.</span></div><div class="line">                    mDelivery.postResponse(request, response);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Soft-expired cache hit. We can deliver the cached response,</span></div><div class="line">                    <span class="comment">// but we need to also send the request to the network for</span></div><div class="line">                    <span class="comment">// refreshing.</span></div><div class="line">                    request.addMarker(<span class="string">"cache-hit-refresh-needed"</span>);</div><div class="line">                    request.setCacheEntry(entry);</div><div class="line"></div><div class="line">                    <span class="comment">// Mark the response as intermediate.</span></div><div class="line">                    response.intermediate = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                    <span class="comment">// Post the intermediate response back to the user and have</span></div><div class="line">                    <span class="comment">// the delivery then forward the request along to the network.</span></div><div class="line">                    mDelivery.postResponse(request, response, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                mNetworkQueue.put(request);</div><div class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                                <span class="comment">// Not much we can do about this.</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="comment">// We may have been interrupted because it was time to quit.</span></div><div class="line">                <span class="keyword">if</span> (mQuit) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而对于网络请求队列中的任务该如何执行，这里就要看<code>NetworkDispatcher</code>的具体实现:        </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides a thread for performing network dispatch from a queue of requests.</div><div class="line"> *</div><div class="line"> * Requests added to the specified queue are processed from the network via a</div><div class="line"> * specified &#123;<span class="doctag">@link</span> Network&#125; interface. Responses are committed to cache, if</div><div class="line"> * eligible, using a specified &#123;<span class="doctag">@link</span> Cache&#125; interface. Valid responses and</div><div class="line"> * errors are posted back to the caller via a &#123;<span class="doctag">@link</span> ResponseDelivery&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkDispatcher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="comment">/** The queue of requests to service. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Request&lt;?&gt;&gt; mQueue;</div><div class="line">    <span class="comment">/** The network interface for processing requests. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Network mNetwork;</div><div class="line">    <span class="comment">/** The cache to write to. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line">    <span class="comment">/** For posting responses and errors. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line">    <span class="comment">/** Used for telling us to die. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mQuit = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new network dispatcher thread.  You must call &#123;<span class="doctag">@link</span> #start()&#125;</div><div class="line">     * in order to begin processing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> queue Queue of incoming requests for triage</div><div class="line">     * <span class="doctag">@param</span> network Network interface to use for performing requests</div><div class="line">     * <span class="doctag">@param</span> cache Cache interface to use for writing responses to cache</div><div class="line">     * <span class="doctag">@param</span> delivery Delivery interface to use for posting responses</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetworkDispatcher</span><span class="params">(BlockingQueue&lt;Request&lt;?&gt;&gt; queue,</span></span></div><div class="line">            Network network, Cache cache,</div><div class="line">            ResponseDelivery delivery) &#123;</div><div class="line">        mQueue = queue;</div><div class="line">        mNetwork = network;</div><div class="line">        mCache = cache;</div><div class="line">        mDelivery = delivery;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Forces this dispatcher to quit immediately.  If any requests are still in</div><div class="line">     * the queue, they are not guaranteed to be processed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        mQuit = <span class="keyword">true</span>;</div><div class="line">        interrupt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTrafficStatsTag</span><span class="params">(Request&lt;?&gt; request)</span> </span>&#123;</div><div class="line">        <span class="comment">// Tag the request (if API &gt;= 14)</span></div><div class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">            TrafficStats.setThreadStatsTag(request.getTrafficStatsTag());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">long</span> startTimeMs = SystemClock.elapsedRealtime();</div><div class="line">            Request&lt;?&gt; request;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// Take a request from the queue.</span></div><div class="line">                request = mQueue.take();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="comment">// We may have been interrupted because it was time to quit.</span></div><div class="line">                <span class="keyword">if</span> (mQuit) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                request.addMarker(<span class="string">"network-queue-take"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If the request was cancelled already, do not perform the</span></div><div class="line">                <span class="comment">// network request.</span></div><div class="line">                <span class="keyword">if</span> (request.isCanceled()) &#123;</div><div class="line">                    request.finish(<span class="string">"network-discard-cancelled"</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                addTrafficStatsTag(request);</div><div class="line">                <span class="comment">// mNetwork会去执行对应的request请求，后面再看里面的具体实现</span></div><div class="line">                <span class="comment">// Perform the network request.</span></div><div class="line">                NetworkResponse networkResponse = mNetwork.performRequest(request);</div><div class="line">                request.addMarker(<span class="string">"network-http-complete"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If the server returned 304 AND we delivered a response already,</span></div><div class="line">                <span class="comment">// we're done -- don't deliver a second identical response.</span></div><div class="line">                <span class="keyword">if</span> (networkResponse.notModified &amp;&amp; request.hasHadResponseDelivered()) &#123;</div><div class="line">                    request.finish(<span class="string">"not-modified"</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 将网络请求返回的NetworkResponse交给request.parseNetworkResponse进行处理</span></div><div class="line">                <span class="comment">// Parse the response here on the worker thread.</span></div><div class="line">                Response&lt;?&gt; response = request.parseNetworkResponse(networkResponse);</div><div class="line">                request.addMarker(<span class="string">"network-parse-complete"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// Write to cache if applicable.</span></div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> Only update cache metadata instead of entire record for 304s.</span></div><div class="line">                <span class="keyword">if</span> (request.shouldCache() &amp;&amp; response.cacheEntry != <span class="keyword">null</span>) &#123;</div><div class="line">                    mCache.put(request.getCacheKey(), response.cacheEntry);</div><div class="line">                    request.addMarker(<span class="string">"network-cache-written"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Post the response back.</span></div><div class="line">                request.markDelivered();</div><div class="line">                <span class="comment">// mDelivery进行分发</span></div><div class="line">                mDelivery.postResponse(request, response);</div><div class="line">            &#125; <span class="keyword">catch</span> (VolleyError volleyError) &#123;</div><div class="line">                volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);</div><div class="line">                parseAndDeliverNetworkError(request, volleyError);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                VolleyLog.e(e, <span class="string">"Unhandled exception %s"</span>, e.toString());</div><div class="line">                VolleyError volleyError = <span class="keyword">new</span> VolleyError(e);</div><div class="line">                volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);</div><div class="line">                mDelivery.postError(request, volleyError);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAndDeliverNetworkError</span><span class="params">(Request&lt;?&gt; request, VolleyError error)</span> </span>&#123;</div><div class="line">        error = request.parseNetworkError(error);</div><div class="line">        mDelivery.postError(request, error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面会执行到<code>mNetwork.performRequest</code>方法，而<code>Network</code>是一个接口，具体的实现要看<code>BaseNetwork</code>中的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> NetworkResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request)</span> <span class="keyword">throws</span> VolleyError </span>&#123;</div><div class="line">    <span class="keyword">long</span> requestStart = SystemClock.elapsedRealtime();</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        HttpResponse httpResponse = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">byte</span>[] responseContents = <span class="keyword">null</span>;</div><div class="line">        Map&lt;String, String&gt; responseHeaders = Collections.emptyMap();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Gather headers.</span></div><div class="line">            Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">            addCacheHeaders(headers, request.getCacheEntry());</div><div class="line">            <span class="comment">// 调用mHttpStack.performRequest方法，这里就是newRequestQueue中创建的部分，9及以上为HurlStack，9以下为HttpClientStach,具体就是真正执行网络请求的部分了。</span></div><div class="line">            httpResponse = mHttpStack.performRequest(request, headers);</div><div class="line">            StatusLine statusLine = httpResponse.getStatusLine();</div><div class="line">            <span class="keyword">int</span> statusCode = statusLine.getStatusCode();</div><div class="line"></div><div class="line">            responseHeaders = convertHeaders(httpResponse.getAllHeaders());</div><div class="line">            <span class="comment">// Handle cache validation.</span></div><div class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.SC_NOT_MODIFIED) &#123;</div><div class="line"></div><div class="line">                Entry entry = request.getCacheEntry();</div><div class="line">                <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, <span class="keyword">null</span>,</div><div class="line">                            responseHeaders, <span class="keyword">true</span>,</div><div class="line">                            SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// A HTTP 304 response does not have all header fields. We</span></div><div class="line">                <span class="comment">// have to use the header fields from the cache entry plus</span></div><div class="line">                <span class="comment">// the new ones from the response.</span></div><div class="line">                <span class="comment">// http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5</span></div><div class="line">                entry.responseHeaders.putAll(responseHeaders);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, entry.data,</div><div class="line">                        entry.responseHeaders, <span class="keyword">true</span>,</div><div class="line">                        SystemClock.elapsedRealtime() - requestStart);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// Handle moved resources</span></div><div class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.SC_MOVED_PERMANENTLY || statusCode == HttpStatus.SC_MOVED_TEMPORARILY) &#123;</div><div class="line">            	String newUrl = responseHeaders.get(<span class="string">"Location"</span>);</div><div class="line">            	request.setRedirectUrl(newUrl);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Some responses such as 204s do not have content.  We must check.</span></div><div class="line">            <span class="keyword">if</span> (httpResponse.getEntity() != <span class="keyword">null</span>) &#123;</div><div class="line">              responseContents = entityToBytes(httpResponse.getEntity());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="comment">// Add 0 byte response as a way of honestly representing a</span></div><div class="line">              <span class="comment">// no-content request.</span></div><div class="line">              responseContents = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// if the request is slow, log it.</span></div><div class="line">            <span class="keyword">long</span> requestLifetime = SystemClock.elapsedRealtime() - requestStart;</div><div class="line">            logSlowRequests(requestLifetime, request, responseContents, statusLine);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (statusCode &lt; <span class="number">200</span> || statusCode &gt; <span class="number">299</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(statusCode, responseContents, responseHeaders, <span class="keyword">false</span>,</div><div class="line">                    SystemClock.elapsedRealtime() - requestStart);</div><div class="line">        &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</div><div class="line">            attemptRetryOnException(<span class="string">"socket"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">        &#125; <span class="keyword">catch</span> (ConnectTimeoutException e) &#123;</div><div class="line">            attemptRetryOnException(<span class="string">"connection"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Bad URL "</span> + request.getUrl(), e);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">int</span> statusCode = <span class="number">0</span>;</div><div class="line">            NetworkResponse networkResponse = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (httpResponse != <span class="keyword">null</span>) &#123;</div><div class="line">                statusCode = httpResponse.getStatusLine().getStatusCode();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoConnectionError(e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.SC_MOVED_PERMANENTLY || </div><div class="line">            		statusCode == HttpStatus.SC_MOVED_TEMPORARILY) &#123;</div><div class="line">            	VolleyLog.e(<span class="string">"Request at %s has been redirected to %s"</span>, request.getOriginUrl(), request.getUrl());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">            	VolleyLog.e(<span class="string">"Unexpected response code %d for %s"</span>, statusCode, request.getUrl());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (responseContents != <span class="keyword">null</span>) &#123;</div><div class="line">                networkResponse = <span class="keyword">new</span> NetworkResponse(statusCode, responseContents,</div><div class="line">                        responseHeaders, <span class="keyword">false</span>, SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                <span class="keyword">if</span> (statusCode == HttpStatus.SC_UNAUTHORIZED ||</div><div class="line">                        statusCode == HttpStatus.SC_FORBIDDEN) &#123;</div><div class="line">                    attemptRetryOnException(<span class="string">"auth"</span>,</div><div class="line">                            request, <span class="keyword">new</span> AuthFailureError(networkResponse));</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == HttpStatus.SC_MOVED_PERMANENTLY || </div><div class="line">                			statusCode == HttpStatus.SC_MOVED_TEMPORARILY) &#123;</div><div class="line">                    attemptRetryOnException(<span class="string">"redirect"</span>,</div><div class="line">                            request, <span class="keyword">new</span> AuthFailureError(networkResponse));</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Only throw ServerError for 5xx status codes.</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServerError(networkResponse);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NetworkError(networkResponse);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面调用了mHttpStack.performRequest的方法，这里就以9及以上的HurlStack类来看下源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> HttpResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request, Map&lt;String, String&gt; additionalHeaders)</span></span></div><div class="line">		<span class="keyword">throws</span> IOException, AuthFailureError &#123;</div><div class="line">	String url = request.getUrl();</div><div class="line">	HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">	map.putAll(request.getHeaders());</div><div class="line">	map.putAll(additionalHeaders);</div><div class="line">	<span class="keyword">if</span> (mUrlRewriter != <span class="keyword">null</span>) &#123;</div><div class="line">		String rewritten = mUrlRewriter.rewriteUrl(url);</div><div class="line">		<span class="keyword">if</span> (rewritten == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"URL blocked by rewriter: "</span> + url);</div><div class="line">		&#125;</div><div class="line">		url = rewritten;</div><div class="line">	&#125;</div><div class="line">	URL parsedUrl = <span class="keyword">new</span> URL(url);</div><div class="line">	HttpURLConnection connection = openConnection(parsedUrl, request);</div><div class="line">	<span class="keyword">for</span> (String headerName : map.keySet()) &#123;</div><div class="line">		connection.addRequestProperty(headerName, map.get(headerName));</div><div class="line">	&#125;</div><div class="line">	setConnectionParametersForRequest(connection, request);</div><div class="line">	<span class="comment">// Initialize HttpResponse with data from the HttpURLConnection.</span></div><div class="line">	ProtocolVersion protocolVersion = <span class="keyword">new</span> ProtocolVersion(<span class="string">"HTTP"</span>, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">	<span class="keyword">int</span> responseCode = connection.getResponseCode();</div><div class="line">	<span class="keyword">if</span> (responseCode == -<span class="number">1</span>) &#123;</div><div class="line">		<span class="comment">// -1 is returned by getResponseCode() if the response code could not be retrieved.</span></div><div class="line">		<span class="comment">// Signal to the caller that something was wrong with the connection.</span></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Could not retrieve response code from HttpUrlConnection."</span>);</div><div class="line">	&#125;</div><div class="line">	StatusLine responseStatus = <span class="keyword">new</span> BasicStatusLine(protocolVersion,</div><div class="line">			connection.getResponseCode(), connection.getResponseMessage());</div><div class="line">	BasicHttpResponse response = <span class="keyword">new</span> BasicHttpResponse(responseStatus);</div><div class="line">	response.setEntity(entityFromConnection(connection));</div><div class="line">	<span class="keyword">for</span> (Entry&lt;String, List&lt;String&gt;&gt; header : connection.getHeaderFields().entrySet()) &#123;</div><div class="line">		<span class="keyword">if</span> (header.getKey() != <span class="keyword">null</span>) &#123;</div><div class="line">			Header h = <span class="keyword">new</span> BasicHeader(header.getKey(), header.getValue().get(<span class="number">0</span>));</div><div class="line">			response.addHeader(h);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> response;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来还要看一下<code>mDelivery.postResponse(request, response);</code>这里的,mDelivery就是<code>new ExecutorDelivery(new Handler(Looper.getMainLooper()))</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Delivers responses and errors.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorDelivery</span> <span class="keyword">implements</span> <span class="title">ResponseDelivery</span> </span>&#123;</div><div class="line">    <span class="comment">/** Used for posting responses, typically to the main thread. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor mResponsePoster;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new response delivery interface.</div><div class="line">     * <span class="doctag">@param</span> handler &#123;<span class="doctag">@link</span> Handler&#125; to post responses on</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorDelivery</span><span class="params">(<span class="keyword">final</span> Handler handler)</span> </span>&#123;</div><div class="line">        <span class="comment">// Make an Executor that just wraps the handler.</span></div><div class="line">        mResponsePoster = <span class="keyword">new</span> Executor() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">                handler.post(command);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new response delivery interface, mockable version</div><div class="line">     * for testing.</div><div class="line">     * <span class="doctag">@param</span> executor For running delivery tasks</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorDelivery</span><span class="params">(Executor executor)</span> </span>&#123;</div><div class="line">        mResponsePoster = executor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postResponse</span><span class="params">(Request&lt;?&gt; request, Response&lt;?&gt; response)</span> </span>&#123;</div><div class="line">        postResponse(request, response, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postResponse</span><span class="params">(Request&lt;?&gt; request, Response&lt;?&gt; response, Runnable runnable)</span> </span>&#123;</div><div class="line">        request.markDelivered();</div><div class="line">        request.addMarker(<span class="string">"post-response"</span>);</div><div class="line">        <span class="comment">// 内部会调用execute方法</span></div><div class="line">        mResponsePoster.execute(<span class="keyword">new</span> ResponseDeliveryRunnable(request, response, runnable));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postError</span><span class="params">(Request&lt;?&gt; request, VolleyError error)</span> </span>&#123;</div><div class="line">        request.addMarker(<span class="string">"post-error"</span>);</div><div class="line">        Response&lt;?&gt; response = Response.error(error);</div><div class="line">        mResponsePoster.execute(<span class="keyword">new</span> ResponseDeliveryRunnable(request, response, <span class="keyword">null</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A Runnable used for delivering network responses to a listener on the</div><div class="line">     * main thread.</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseDeliveryRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Request mRequest;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Response mResponse;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Runnable mRunnable;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ResponseDeliveryRunnable</span><span class="params">(Request request, Response response, Runnable runnable)</span> </span>&#123;</div><div class="line">            mRequest = request;</div><div class="line">            mResponse = response;</div><div class="line">            mRunnable = runnable;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// 这里就是重点部分了</span></div><div class="line">            <span class="comment">// If this request has canceled, finish it and don't deliver.</span></div><div class="line">            <span class="keyword">if</span> (mRequest.isCanceled()) &#123;</div><div class="line">                mRequest.finish(<span class="string">"canceled-at-delivery"</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 调用mRequest的deliverResponse或者deliverError进行分发</span></div><div class="line">            <span class="comment">// Deliver a normal response or error, depending.</span></div><div class="line">            <span class="keyword">if</span> (mResponse.isSuccess()) &#123;</div><div class="line">                mRequest.deliverResponse(mResponse.result);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mRequest.deliverError(mResponse.error);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// If this is an intermediate response, add a marker, otherwise we're done</span></div><div class="line">            <span class="comment">// and the request can be finished.</span></div><div class="line">            <span class="keyword">if</span> (mResponse.intermediate) &#123;</div><div class="line">                mRequest.addMarker(<span class="string">"intermediate-response"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 执行finish方法</span></div><div class="line">                mRequest.finish(<span class="string">"done"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// If we have been provided a post-delivery runnable, run it.</span></div><div class="line">            <span class="keyword">if</span> (mRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">                mRunnable.run();</div><div class="line">            &#125;</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里再看一下mRequest的deliverResponse方法。<br>Request接口中没有实现该方法，具体我们以StringRequest为例看一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A canned request for retrieving the response body at a given URL as a String.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringRequest</span> <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Listener&lt;String&gt; mListener;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new request with the given method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> method the request &#123;<span class="doctag">@link</span> Method&#125; to use</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the string at</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the String response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRequest</span><span class="params">(<span class="keyword">int</span> method, String url, Listener&lt;String&gt; listener,</span></span></div><div class="line">            ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(method, url, errorListener);</div><div class="line">        mListener = listener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new GET request.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the string at</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the String response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRequest</span><span class="params">(String url, Listener&lt;String&gt; listener, ErrorListener errorListener)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(Method.GET, url, listener, errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deliverResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">        <span class="comment">// 回调</span></div><div class="line">        mListener.onResponse(response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;String&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        String parsed;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parsed = <span class="keyword">new</span> String(response.data, HttpHeaderParser.parseCharset(response.headers));</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            parsed = <span class="keyword">new</span> String(response.data);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> Response.success(parsed, HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下mRequest.finish方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Notifies the request queue that this request has finished (successfully or with error).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Also dumps all events from this request's event log; for debugging.&lt;/p&gt;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(<span class="keyword">final</span> String tag)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mRequestQueue != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 内部调用了mRequestQueue的finish方法，也就是把请求从请求队列中移除。</span></div><div class="line">        mRequestQueue.finish(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (MarkerLog.ENABLED) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> threadId = Thread.currentThread().getId();</div><div class="line">        <span class="keyword">if</span> (Looper.myLooper() != Looper.getMainLooper()) &#123;</div><div class="line">            <span class="comment">// If we finish marking off of the main thread, we need to</span></div><div class="line">            <span class="comment">// actually do it on the main thread to ensure correct ordering.</span></div><div class="line">            Handler mainThread = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line">            mainThread.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mEventLog.add(tag, threadId);</div><div class="line">                    mEventLog.finish(<span class="keyword">this</span>.toString());</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mEventLog.add(tag, threadId);</div><div class="line">        mEventLog.finish(<span class="keyword">this</span>.toString());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">long</span> requestTime = SystemClock.elapsedRealtime() - mRequestBirthTime;</div><div class="line">        <span class="keyword">if</span> (requestTime &gt;= SLOW_REQUEST_THRESHOLD_MS) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"%d ms: %s"</span>, requestTime, <span class="keyword">this</span>.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里就全部分析完了。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Volley源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android Studio你可能不知道的操作" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android Studio你可能不知道的操作/">Android Studio你可能不知道的操作</a>
    </h1>
  

        
        <a href="/2015/01/01/Android Studio你可能不知道的操作/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Studio你可能不知道的操作"><a href="#Android-Studio你可能不知道的操作" class="headerlink" title="Android Studio你可能不知道的操作"></a>Android Studio你可能不知道的操作</h1><p>今天看在<code>Youtube</code>看视频，看到<code>Reto Meier</code>在讲解<code>Studio</code>，<br>一查才知道他现在是<code>Studio</code>的开发人员。<br>想起刚开始学<code>Android</code>时买的他写的书<code>Professional Android 4 Application Development</code>，<br>当时很多内容没看懂。不过看了这个视频才发现大神写代码如此之快…</p>
<p>现在天天用着大神开发的工具，没有理由不去好好学习下。</p>
<p>工欲善其事必先利其器，一个好的开发工具可以让你事半功倍。<code>Android Studio</code>是一个非常好的开发工具，但是虽然都在用，你可能还是了解的不全面，今天就来说一下一些你可能不知道的功能。</p>
<p>熟练使用快捷键是非常有必要的:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/use_shortcut.gif?raw=true" alt="image">  </p>
<ul>
<li><p>自动导入<br>经常听到同事抱怨，<code>Studio</code>怎么没有<code>Eclipse</code>那种批量导包啊，那么多类要到，费劲了。其实不用一个个导的。<br>使用<code>Command+Shift+A(Windows或Linux是Ctrl+Shift+A)</code>快速的查找设置命令。我们输入<code>auto import</code>后将<code>Add unambiguous imports on fly</code>选项开启就好了，很爽有木有？你的是不是也没开啊？<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/auto_import.gif?raw=true" alt="image"><br>你可以快速打开一些设置，例如你想在<code>finder</code>中查看该文件，直接输入<code>find</code>就好了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/action_find.png?raw=true" alt="image">        </p>
</li>
<li><p>在自动完成代码时使用<code>Tab</code>键来替换已存在的方法和参数。<br>经常如我们想要修改一个已经存在的方法时，我们移动到对象的<code>.</code>的提示区域，如果使用<code>Command+Space</code>来补充代码选择后按<code>enter</code>的话，会把之前已经存在的代码往后移动，这样还要再去删除，很不方便。但是如果我们直接使用<code>Tag</code>键，那就会直接替换当前已经存在的方法。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/tab_tip.gif?raw=true" alt="image">  </p>
</li>
<li><p>内容选择技巧<br>使用<code>Control+↑或↓</code>能在方法间移动。使用<code>Shift+↑或↓</code>来选择至上一行或者至下一行代码的代码？那么使用<code>option++↑或↓(Windows或Linux是alt++↑或↓)</code>呢？它能选择或者取消选择和你鼠标所在位置的代码区域。同时使用`option+shift++↑或↓(Windows或Linux是alt+shift++↑或↓)可以交换选中代码块与上一行的位置。这样我们就不需要剪切和粘贴了。</p>
</li>
<li><p>使用模板补全代码<br>你可以在代码后加用后缀的方式补充代码块，也可以用<code>Command+J(Windows是Ctrl+J)</code>来提示。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/command_j.gif?raw=true" alt="image"><br>对于一些更多的模式，在代码自动完成时也支持生成对应的模板，例如使用<code>Toast</code>的快捷键可以很方便的生成一个新的<code>toast</code>对象，你只需要指定文字就可以了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/toast_autocomp.gif?raw=true" alt="image"><br>用<code>Command+Shift+A</code>然后输入<code>live template</code>然后打开对应的页面，可以看到目前已经存在的模板。当然你也可以添加新的模板。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/live_templete.png?raw=true" alt="image">  </p>
</li>
<li><p>在<code>Evaluating Expressions</code>中为<code>Object</code>对象指定显示内容<br>如果我们在<code>debug</code>的时候查看断点处的变量值或者<code>evaluating expressions</code>，你会发现<code>objects</code>会显示他们的<code>toString()</code>值。如果你的变量是<code>String</code>类型或者基础类型那不会有问题，但是大多数其他对象，这样没有什么意义。<br>尤其是在集合对象时，你看的是一个<code>CallsName:HashValue</code>的列表。而为了需要看清数据，我们需要知道每个对象的内容。<br>你当然可以去对每个对象类型指定索要显示的内容。在对应的对象上邮件<code>View as</code>然后创建你想要显示的内容就可以了。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/debug_eva.gif?raw=true" alt="image">  </p>
</li>
<li><p>结构性的搜索、替换、和检查<br><code>Command+shift+A</code>然后输入<code>structural</code>后选择<code>search structurally</code>或者<code>replace structurally</code>，然后可以对应的结构性搜索的模板，完成之后所有符合该模板的代码都会提示<code>warning</code>。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/structural_search.gif?raw=true" alt="image"><br>更有用的是可以使用快速修复来替换一些代码，例如一些废弃的代码或者你在<code>review</code>时发现的其他团队成员提交的一些普遍的错误。</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android Studio你可能不知道的操作/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio提高Build速度" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio提高Build速度/">AndroidStudio提高Build速度</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio提高Build速度/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio提高Build速度"><a href="#AndroidStudio提高Build速度" class="headerlink" title="AndroidStudio提高Build速度"></a>AndroidStudio提高Build速度</h1><p><code>Android Studio</code>自动发布以来，凭借其强大的功能，很快让开发者都投入到它的阵营下。但是也问题，就是<code>Build</code>速度太慢了。</p>
<p>之前也根据网上的资料，修改了一些配置，但是一次二分多种有时候还是让人抓狂。今天索性记录一下。首先看一下<a href="https://plus.google.com/+AndroidDevelopers/posts/ECrb9VQW9XP" target="_blank" rel="external">Google+</a>关于该问题的讨论。</p>
<ul>
<li><p>使用<code>daemon</code>及<code>parallel</code>模式</p>
<p>  在下面的目录中创建一个名为<code>gradle.properties</code>的文件:     </p>
<ul>
<li><code>/home/&lt;username&gt;/.gradle/ (Linux)</code></li>
<li><code>/Users/&lt;username&gt;/.gradle/ (Mac)</code></li>
<li><p><code>C:\Users\&lt;username&gt;\.gradle (Windows)</code></p>
<p>文件的内容为: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.gradle.daemon=true</div><div class="line">org.gradle.parallel=true</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>经过上面的这一步修改是对所有工程都有效果的，如果你只想对某一个工程配置的话，那就在该工程目录下的`gralde.properties`中进行配置。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line"># Default value: -Xmx10248m -XX:MaxPermSize=256m</div><div class="line"># org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div></pre></td></tr></table></figure>

打开时默认如上。我们给加添加上面的配置就好。

当然你也可以通过`Studio`的设置中进行修改。        
![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_speed.png?raw=true)
</code></pre><ul>
<li><p>使用<code>offline</code>模式      </p>
<p>  下一步就是开始<code>offline</code>模式，因为我们经常会在<code>gradle</code>中使用一下依赖库时用<code>+</code>这样的话就能保证你的依赖库是最新的版本，但是这样在每次<code>build</code>的时候都会去检查是不是最新的版本，所以就会耗时。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_offline.png?raw=true" alt="image"></p>
<p>  在开发过程中是不建议使用动态版本的，在<code>Studio</code>中使用动态版本的<code>gradle</code>中间中使用<code>ALT+ENTER</code>键进行修复。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_daymaic_version_tip.png?raw=true" alt="image"><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_dymaic_version_fix.png?raw=true" alt="image"><br>  详细有关为什么不要使用动态版本的介绍，请参考<a href="http://blog.danlew.net/2015/09/09/dont-use-dynamic-versions-for-your-dependencies/" target="_blank" rel="external">Don’t use dynamic versions for your dependencies</a></p>
</li>
<li><p>增加内存使用<code>SSD</code><br>  首先是增大内存,    <code>Mac</code>中在<code>Applications</code>中找到<code>Sutio</code>然后右键显示包内容<code>Contents/bin/studio.vmoptions</code>。<br>  打开该文件后修改就可以了，我是的是:     </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># *DO NOT* modify this file directly. If there is a value that you would like to override,</div><div class="line"># please add it to your user specific configuration file.</div><div class="line">#</div><div class="line"># See http://tools.android.com/tech-docs/configuration</div><div class="line">#</div><div class="line">-Xms1024m</div><div class="line">-Xmx4096m</div><div class="line">-XX:MaxPermSize=768m</div><div class="line">-XX:ReservedCodeCacheSize=768m</div><div class="line">-XX:+UseCompressedOops</div></pre></td></tr></table></figure>
<p>  我没看见<code>DO NOT</code>的提示- -!</p>
<ul>
<li>Xms 是JVN启动起始时的堆内存，堆内存是分配给对象的内容。</li>
<li>Xmx 是能使用的最大堆内存。</li>
</ul>
</li>
</ul>
<ul>
<li><p>使用<code>Instant Run</code>   </p>
<p>  <code>Instantt Run</code>放在这里说可能不合适，但是用他确实能大大的减少运行时间。<br>  如果还不了解的话可以参考<a href="http://tools.android.com/tech-docs/instant-run" target="_blank" rel="external">Instant Run</a><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_instantrun.png?raw=true" alt="image"></p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio提高Build速度/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-如何让Service常驻内存" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/如何让Service常驻内存/">如何让Service常驻内存</a>
    </h1>
  

        
        <a href="/2015/01/01/如何让Service常驻内存/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="如何让Service常驻内存"><a href="#如何让Service常驻内存" class="headerlink" title="如何让Service常驻内存"></a>如何让Service常驻内存</h1><p>我非常鄙视这种行文，一个公司应该想到如何把产品做的更完善，而不是用这些技术来损害用户的利益，来获取自己肮脏的所谓的功能。</p>
<ul>
<li>Service设置成START_STICKY，kill 后会被重启（等待5秒左右），重传Intent，保持与重启前一样</li>
<li>​通过 startForeground将进程设置为前台进程，做前台服务，优先级和前台应用一个级别​，除非在系统内存非常缺，否则此进程不会被 kill</li>
<li>双进程Service：让2个进程互相保护，其中一个Service被清理后，另外没被清理的进程可以立即重启进程</li>
<li>QQ黑科技:在应用退到后台后，另起一个只有 1 像素的页面停留在桌面上，让自己保持前台状态，保护自己不被后台清理工具杀死</li>
<li>在已经root的设备下，修改相应的权限文件，将App伪装成系统级的应用（Android4.0系列的一个漏洞，已经确认可行）</li>
<li><p>Android系统中当前进程(Process)fork出来的子进程，被系统认为是两个不同的进程。当父进程被杀死的时候，子进程仍然可以存活，并不受影响。<br>  鉴于目前提到的在Android-Service层做双守护都会失败，我们可以fork出c进程，多进程守护。死循环在那检查是否还存在，<br>  具体的思路如下（Android5.0以下可行）</p>
<ul>
<li>用C编写守护进程(即子进程)，守护进程做的事情就是循环检查目标进程是否存在，不存在则启动它。</li>
<li>在NDK环境中将1中编写的C代码编译打包成可执行文件(BUILD_EXECUTABLE)。</li>
<li>主进程启动时将守护进程放入私有目录下，赋予可执行权限，启动它即可。</li>
</ul>
</li>
<li><p>联系厂商，加入白名单</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/如何让Service常驻内存/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>