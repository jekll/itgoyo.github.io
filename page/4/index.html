<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/4/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=270 src="//music.163.com/outchain/player?type=0&id=120897804&auto=1&height=430"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 100%"><a href="/">主页</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-ART与Dalvik" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/ART与Dalvik/">ART与Dalvik</a>
    </h1>
  

        
        <a href="/2015/01/01/ART与Dalvik/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ART与Dalvik"><a href="#ART与Dalvik" class="headerlink" title="ART与Dalvik"></a>ART与Dalvik</h1><h2 id="ART"><a href="#ART" class="headerlink" title="ART"></a>ART</h2><p><code>Android 4.4</code>提供了一种与<code>Dalvik</code>截然不同的运行环境<code>ART</code>支持,<code>ART</code>源于<code>google</code>收购的<code>Flexycore</code>的公司。<br><code>ART</code>模式与<code>Dalvik</code>模式最大的不同在于，启用<code>ART</code>模式后，系统在安装应用的时候会进行一次预编译，将字节码转换为机器语言存储在本地，<br>这样在运行程序时就不会每次都进行一次编译了，执行效率也大大提升。<br><code>ART</code>代表<code>Android Runtime</code>，其处理应用程序执行的方式完全不同于<code>Dalvik</code>，<code>Dalvik</code>是依靠一个<code>Just-In-Time</code> (<code>JIT</code>)编译器去解释字节码。<br>开发者编译后的应用代码需要通过一个解释器在用户的设备上运行，这一机制并不高效，但让应用能更容易在不同硬件和架构上运行。<br><code>ART</code>则完全改变了这套做法，在应用安装时就预编译字节码到机器语言，这一机制叫<code>Ahead-Of-Time</code>(<code>AOT</code>）编译。<br>在移除解释代码这一过程后，应用程序执行将更有效率，启动更快。总体的理念就是空间换时间。</p>
<h2 id="Dalvik"><a href="#Dalvik" class="headerlink" title="Dalvik"></a>Dalvik</h2><p><code>Dalvik</code>是<code>Google</code>公司自己设计用于<code>Android</code>平台的<code>Java</code>虚拟机。它可以支持已转换为<code>.dex</code>（即<code>Dalvik Executable</code>）格式的<code>Java</code>应用程序的运行，<br><code>.dex</code>格式是专为<code>Dalvik</code>设计的一种压缩格式，适合内存和处理器速度有限的系统。<code>Dalvik</code>经过优化，允许在有限的内存中同时运行多个虚拟机的实例，<br>并且每一个<code>Dalvik</code>应用作为一个独立的<code>Linux</code>进程执行。独立的进程可以防止在虚拟机崩溃的时候所有程序都被关闭。</p>
<p><code>AOT</code>的编译器分两种模式：            </p>
<ul>
<li>在开发机上编译预装应用；</li>
<li>在设备上编译新安装的应用,在应用安装时将dex字节码翻译成本地机器码。</li>
</ul>
<p>ART优点:     </p>
<ul>
<li>系统性能的显著提升。</li>
<li>应用启动更快、运行更快、体验更流畅、触感反馈更及时。</li>
<li>更长的电池续航能力。</li>
<li>支持更低的硬件。</li>
</ul>
<p>ART缺点:       </p>
<ul>
<li>更大的存储空间占用，可能会增加10%-20%。</li>
<li>更长的应用安装时间。</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/ART与Dalvik/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Markdown学习手册" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Markdown学习手册/">Markdown学习手册</a>
    </h1>
  

        
        <a href="/2015/01/01/Markdown学习手册/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Markdown学习手册"><a href="#Markdown学习手册" class="headerlink" title="Markdown学习手册"></a>Markdown学习手册</h1><h4 id="一-简单功能"><a href="#一-简单功能" class="headerlink" title="一. 简单功能"></a>一. 简单功能</h4><table>
<thead>
<tr>
<th style="text-align:left">功能</th>
<th style="text-align:left">效果</th>
<th style="text-align:left">Markdown代码</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">粗体</td>
<td style="text-align:left"><strong>粗体</strong></td>
<td style="text-align:left"><code>**粗体**</code></td>
<td style="text-align:left">两边加**</td>
</tr>
<tr>
<td style="text-align:left">斜体</td>
<td style="text-align:left"><em>斜体</em></td>
<td style="text-align:left"><code>_斜体_</code></td>
<td style="text-align:left">两边加_</td>
</tr>
<tr>
<td style="text-align:left">中划线</td>
<td style="text-align:left"><del>中划线</del></td>
<td style="text-align:left"><code>~~中划线~~</code></td>
<td style="text-align:left">两边加~~</td>
</tr>
<tr>
<td style="text-align:left">单行代码</td>
<td style="text-align:left"><code>Log.i(&quot;Hello World!&quot;)</code></td>
<td style="text-align:left">`Log.i(“Hello World!”)`</td>
<td style="text-align:left">两边加`</td>
</tr>
<tr>
<td style="text-align:left">插入图片</td>
<td style="text-align:left"><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rss.png?raw=true" alt="Image"></td>
<td style="text-align:left"><code>![Image](https://raw.githubusercontent.com/CharonChui/Pictures/master/rss.png?raw=true)</code></td>
<td style="text-align:left">[] 中间为占位符,() 中间为图片链接</td>
</tr>
<tr>
<td style="text-align:left">链接</td>
<td style="text-align:left"><a href="http://www.github.com" target="_blank" rel="external">Visit Github</a></td>
<td style="text-align:left"><code>[Visit Github](http://www.github.com)</code></td>
<td style="text-align:left">[] 中间为显示文字,() 中间为链接</td>
</tr>
</tbody>
</table>
<h4 id="二-其他功能"><a href="#二-其他功能" class="headerlink" title="二. 其他功能"></a>二. 其他功能</h4><h5 id="1-换行"><a href="#1-换行" class="headerlink" title="1. 换行"></a>1. 换行</h5><p>在需要换行的地方敲击两次空格和一个回车键即可，如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">这是第一行(空格)(空格)(回车)</div><div class="line">这是第二行</div></pre></td></tr></table></figure>
<p>Tip: 多条新行都会被视为一行</p>
<h5 id="2-标题"><a href="#2-标题" class="headerlink" title="2. 标题"></a>2. 标题</h5><p>Markdown 提供了六种规格的标题，分别对应 Html 标签中的<code>&lt;h1&gt;</code>-<code>&lt;h6&gt;</code>，通过添加不同数量的<code>#</code>字符可以实现不同大小的标题，如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 最大的标题(相当于一个&lt;h1&gt;标签)</div><div class="line">## 次大的标题(相当于一个&lt;h2&gt;标签)</div><div class="line">...</div><div class="line">###### 最小的标题(相当于一个&lt;h6&gt;标签)</div></pre></td></tr></table></figure></p>
<p>Tip: # 越多，标题越小  </p>
<p>或者利用 = （最高阶标题）和 - （第二阶标题），任何数量的 = 和 - 都可以有效果。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">H1</div><div class="line">===</div><div class="line"></div><div class="line">H2</div><div class="line">---</div><div class="line">```     </div><div class="line">效果为:</div><div class="line">H1</div><div class="line">===</div><div class="line"></div><div class="line">H2</div><div class="line">---</div><div class="line"></div><div class="line">##### 3. 列表   </div><div class="line">###### 3.1 有序列表</div><div class="line">数字 + . + 空格即可，以下代码：</div></pre></td></tr></table></figure></p>
<ol>
<li>项目1  </li>
<li>项目2  </li>
<li>项目3  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">效果为：  </div><div class="line">1. 项目1  </div><div class="line">2. 项目2  </div><div class="line">3. 项目3  </div><div class="line"></div><div class="line">###### 3.2 无序列表  </div><div class="line">以 * 和空格开头即可，以下代码:</div></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>项目1</li>
<li>项目2</li>
<li><p>项目3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">效果为：  </div><div class="line">* 项目1</div><div class="line">* 项目2</div><div class="line">* 项目3</div><div class="line"></div><div class="line">###### 3.3 子项目表示： </div><div class="line">子项目缩进一个 tab 并加 * 和 空格表示，以下代码：</div></pre></td></tr></table></figure>
</li>
<li><p>项目1</p>
<ul>
<li>子项目1</li>
<li>子项目2</li>
</ul>
</li>
<li>项目2<ul>
<li>子项目1<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">效果为：  </div><div class="line">* 项目1</div><div class="line">    * 子项目1</div><div class="line">    * 子项目2</div><div class="line">* 项目2</div><div class="line">    * 子项目1</div><div class="line"></div><div class="line">##### 4. 代码块</div><div class="line">以 \`\`\` 和 \`\`\` 包含，以下代码：  </div><div class="line">&lt;pre&gt;&lt;code&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>def hello():<br>    print ‘Hello World!’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;/code&gt;&lt;/pre&gt;</div><div class="line">效果为：</div></pre></td></tr></table></figure></p>
<p>def hello():<br>    print ‘Hello World!’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">GFM 扩展了 Markdown 的代码块功能，通过在上面第一个 \`\`\` 后添加语言名称，使不同语言展现不同的代码高亮风格，以下代码:  </div><div class="line">&lt;pre&gt;&lt;code&gt;</div><div class="line">```java</div><div class="line">public static void main(String[] args)&#123;</div><div class="line">    System.out.println(&quot;Hello World!&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><br>效果为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello World!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以下代码：  </p>
<pre><code>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Hello World!'</span></div></pre></td></tr></table></figure>

</code></pre>

<p>效果为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Hello World!'</span></div></pre></td></tr></table></figure></p>
<h5 id="5-表格"><a href="#5-表格" class="headerlink" title="5. 表格"></a>5. 表格</h5><p>标准的 Markdown 中并不支持表格，但 GFM 可以，表头前空一行，以 <code>---</code>  做为表头分隔，以 <code>|</code> 做为列分隔，以下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">表头1|表头2</div><div class="line">---|---</div><div class="line">单元格1|单元格2</div><div class="line">单元格3|单元格4</div></pre></td></tr></table></figure></p>
<p>效果为：  </p>
<table>
<thead>
<tr>
<th>表头1</th>
<th>表头2</th>
</tr>
</thead>
<tbody>
<tr>
<td>单元格1</td>
<td>单元格2</td>
</tr>
<tr>
<td>单元格3</td>
<td>单元格4</td>
</tr>
</tbody>
</table>
<p>而且还可以通过在表头分隔符中添加 <code>:</code> 来决定单元格的对齐方向，以下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">表头1|表头2|表头3</div><div class="line">:--|:--:|--:</div><div class="line">左1|中1|右1</div><div class="line">左2|中2|右2</div></pre></td></tr></table></figure></p>
<p>效果为：  </p>
<table>
<thead>
<tr>
<th style="text-align:left">表头1</th>
<th style="text-align:center">表头2</th>
<th style="text-align:right">表头3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">左1</td>
<td style="text-align:center">中1</td>
<td style="text-align:right">右1</td>
</tr>
<tr>
<td style="text-align:left">左2</td>
<td style="text-align:center">中2</td>
<td style="text-align:right">右2</td>
</tr>
</tbody>
</table>
<h5 id="6-特殊字符转义"><a href="#6-特殊字符转义" class="headerlink" title="6. 特殊字符转义"></a>6. 特殊字符转义</h5><p>如果需要在正文里使用特殊字符的话，可以用 <code>\</code> 来转义  </p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Markdown学习手册/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-MaterialDesign使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/MaterialDesign使用/">MaterialDesign使用</a>
    </h1>
  

        
        <a href="/2015/01/01/MaterialDesign使用/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MaterialDesign使用"><a href="#MaterialDesign使用" class="headerlink" title="MaterialDesign使用"></a>MaterialDesign使用</h1><ul>
<li><code>Material Design</code>是<code>Google</code>在<code>2014</code>年的<code>I/O</code>大会上推出的全新设计语言。                        </li>
<li><code>Material Design</code>是基于<code>Android 5.0``(API level 21)</code>的，兼容5.0以下的设备时需要使用版本号<code>v21.0.0</code>以上的<br><code>support v7</code>包中的<code>appcpmpat</code>，不过遗憾的是<code>support</code>包只支持<code>Material Design</code>的部分特性。<br>使用<code>eclipse</code>或<code>Android Studio</code>进行开发时，直接在<code>Android SDK Manager</code>中将<code>Extras-&gt;Android Support Library</code><br>升级至最新版即可。</li>
</ul>
<p>下面我就简单讲解一下如何通过<code>support v7</code>包来使用<code>Material Design</code>进行开发。</p>
<h2 id="Material-Design-Theme"><a href="#Material-Design-Theme" class="headerlink" title="Material Design Theme"></a>Material Design Theme</h2><p><code>Material</code>主题:                         </p>
<ul>
<li>@android:style/Theme.Material (dark version)             –               Theme.AppCompat                           </li>
<li>@android:style/Theme.Material.Light (light version)      –               Theme.AppCompat.Light                 </li>
<li>@android:style/Theme.Material.Light.DarkActionBar        –               Theme.AppCompat.Light.DarkActionBar                 </li>
</ul>
<p>对应的效果分别如下:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/Material_theme.png?raw=true" alt="Image">    </p>
<h2 id="使用ToolBar"><a href="#使用ToolBar" class="headerlink" title="使用ToolBar"></a>使用ToolBar</h2><ul>
<li>禁止Action Bar<br>  可以通过使用<code>Material theme</code>来让应用使用<code>Material Design</code>。想要使用<code>ToolBar</code>需要先禁用<code>ActionBar</code>。<br>  可以通过自定义<code>theme</code>继承<code>Theme.AppCompat.Light.NoActionBar</code>或者在<code>theme</code>中通过以下配置来进行。  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"windowActionBar"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowNoTitle"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>下面我通过第二种方式来看一下具体的实现:   

在`style.xml`中自定义`AppTheme`:    

<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Base application theme. --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme"</span> <span class="attr">parent</span>=<span class="string">"AppTheme.Base"</span>/&gt;</span><span class="xml"></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme.Base"</span> <span class="attr">parent</span>=<span class="string">"Theme.AppCompat.Light.DarkActionBar"</span>&gt;</span><span class="xml"></span></div><div class="line">	<span class="comment">&lt;!-- Tell Android System that we will use ToolBar instead of ActionBar --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"windowNoTitle"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"windowActionBar"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- colorPrimary is used for the default action bar background --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimary"</span>&gt;</span>@color/colorPrimary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- colorPrimaryDark is used for the status bar --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimaryDark"</span>&gt;</span>@color/colorPrimaryDark<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- colorAccent is used as the default value for colorControlActivated</span></div><div class="line">		 which is used to tint widgets --&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorAccent"</span>&gt;</span>@color/colorAccent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure>


配置的这几种颜色分别如下图所示:    
![Image](https://raw.githubusercontent.com/CharonChui/Pictures/master/material_color.png?raw=true)           
里面没有`colorAccent`的颜色，这个颜色是设置`Checkbox`等控件选中时的颜色。

在`values-v21`中的`style.xml`中同样自定义`AppTheme`主题: 
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTheme"</span> <span class="attr">parent</span>=<span class="string">"AppTheme.Base"</span>&gt;</span><span class="xml"></span></div><div class="line">    <span class="comment">&lt;!-- Customize your theme using Material Design here. --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowContentTransitions"</span> &gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowAllowEnterTransitionOverlap"</span> &gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowAllowReturnTransitionOverlap"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowSharedElementEnterTransition"</span>&gt;</span>@android:transition/move<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowSharedElementExitTransition"</span>&gt;</span>@android:transition/move<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>在<code>Manifest</code>文件中设置<code>AppTheme</code>主题:   </p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;application</div><div class="line">	android:allowBackup="true"</div><div class="line">	android:icon="@mipmap/ic_launcher"</div><div class="line">	android:label="@string/app_name"</div><div class="line">	android:theme="@style/AppTheme" &gt;</div><div class="line">	&lt;activity</div><div class="line">		...</div><div class="line">	&lt;/activity&gt;</div><div class="line">	&lt;activity android:name="com.charon.materialsample.FriendsActivity"&gt;&lt;/activity&gt;</div><div class="line">&lt;/application&gt;</div></pre></td></tr></table></figure>
<p>  这里说一下为什么要在<code>values-v21</code>中也自定义个主题，这是为了能让在<code>21</code>以上的版本能更好的使用<code>Material Design</code>，<br>在21以上的版本中会有更多的动画、特效等。</p>
</li>
<li><p>让Activity继承AppCompatActivity</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在布局文件中进行声明</p>
<p>  声明<code>toolbar.xml</code>，我们把他单独放到一个文件中，方便多布局使用:    </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:local</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"?attr/colorPrimary"</span></div><div class="line">    <span class="attr">android:minHeight</span>=<span class="string">"?attr/actionBarSize"</span></div><div class="line">    <span class="attr">local:popupTheme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Light"</span></div><div class="line">    <span class="attr">local:theme</span>=<span class="string">"@style/ThemeOverlay.AppCompat.Dark.ActionBar"</span> /&gt;</div></pre></td></tr></table></figure>
<p>  在<code>Activity</code>的布局中使用<code>ToolBar</code>:    </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">include</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">		<span class="attr">layout</span>=<span class="string">"@layout/toolbar"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">com.charon.materialsample.view.PagerSlidingTabStrip</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/psts_main"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"48dip"</span></div><div class="line">		<span class="attr">android:background</span>=<span class="string">"@color/colorPrimary"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/vp_main"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;<span class="tag">&lt;/<span class="name">android.support.v4.view.ViewPager</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>在Activity中设置ToolBar</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> Toolbar mToolbar;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContext = <span class="keyword">this</span>;</div><div class="line">		mToolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">		mToolbar.setTitle(R.string.app_name);</div><div class="line">		<span class="comment">// 将ToolBar设置为ActionBar，这样一设置后他就能像ActionBar一样直接显示menu目录中的菜单资源</span></div><div class="line">		<span class="comment">// 如果不用该方法，那ToolBar就只是一个普通的View，对menu要用inflateMenu去加载布局。</span></div><div class="line">		setSupportActionBar(mToolbar);</div><div class="line">		getSupportActionBar().setDisplayShowHomeEnabled(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>到这里运行项目就可以了，就可以看到一个简单的<code>ToolBar</code>实现。</p>
<p>接下来我们看一下<code>ToolBar</code>中具体有哪些内容:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/ToolBar_content.jpg?raw=true" alt="Image">                  </p>
<p>我们可以通过对应的方法来修改他们的属性:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/toolbarCode.png?raw=true" alt="Image">               </p>
<p>对于<code>ToolBar</code>中的<code>Menu</code>部分我们可以通过一下方法来设置:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">toolbar.inflateMenu(R.menu.menu_main);</div><div class="line">toolbar.setOnMenuItemClickListener();</div></pre></td></tr></table></figure></p>
<p>或者也可以直接在<code>Activity</code>的<code>onCreateOptionsMenu</code>及<code>onOptionsItemSelected</code>来处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">	<span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></div><div class="line">	getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">	<span class="comment">// Handle action bar item clicks here. The action bar will</span></div><div class="line">	<span class="comment">// automatically handle clicks on the Home/Up button, so long</span></div><div class="line">	<span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></div><div class="line">	<span class="keyword">int</span> id = item.getItemId();</div><div class="line"></div><div class="line">	<span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">	<span class="keyword">if</span> (id == R.id.action_settings) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (id == R.id.action_search) &#123;</div><div class="line">		Toast.makeText(getApplicationContext(), <span class="string">"Search action is selected!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>menu</code>的实现如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span> <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">item</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/action_search"</span></div><div class="line">            <span class="attr">android:title</span>=<span class="string">"@string/action_search"</span></div><div class="line">            <span class="attr">android:orderInCategory</span>=<span class="string">"100"</span></div><div class="line">            <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_action_search"</span></div><div class="line">            <span class="attr">app:showAsAction</span>=<span class="string">"ifRoom"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">item</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/action_settings"</span></div><div class="line">            <span class="attr">android:title</span>=<span class="string">"@string/action_settings"</span></div><div class="line">            <span class="attr">android:orderInCategory</span>=<span class="string">"100"</span></div><div class="line">            <span class="attr">app:showAsAction</span>=<span class="string">"never"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果想要对<code>NavigationIcon</code>添加点击实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">toolbar.setNavigationOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">		onBackPressed();</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>运行后发现我们强大的<code>Activity</code>切换动画怎么在<code>5.0</code>一下系统上实现呢？<code>support v7</code>包也帮我们考虑到了。使用<code>ActivityOptionsCompat</code><br>及<code>ActivityCompat.startActivity</code>，但是悲剧了，他对4.0一下基本都无效，而且就算在4.0上很多动画也不行，具体还是用其他<br>大神在<code>github</code>写的开源项目吧。</p>
<ul>
<li><p>动态取色Palette </p>
<p>  <code>Palette</code>这个类中可以提取一下集中颜色：　　</p>
<ul>
<li>Vibrant （有活力）</li>
<li>Vibrant dark（有活力 暗色）</li>
<li>Vibrant light（有活力 亮色）</li>
<li>Muted （柔和）</li>
<li>Muted dark（柔和 暗色）</li>
<li><p>Muted light（柔和 亮色）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//目标bitmap，代码片段</span></div><div class="line">Bitmap bm = BitmapFactory.decodeResource(getResources(),</div><div class="line">		R.drawable.kale);</div><div class="line">Palette palette = Palette.generate(bm);</div><div class="line"><span class="keyword">if</span> (palette.getLightVibrantSwatch() != <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="comment">//得到不同的样本，设置给imageview进行显示</span></div><div class="line">	iv.setBackgroundColor(palette.getLightVibrantSwatch().getRgb());</div><div class="line">	iv1.setBackgroundColor(palette.getDarkVibrantSwatch().getRgb());</div><div class="line">	iv2.setBackgroundColor(palette.getLightMutedSwatch().getRgb());</div><div class="line">	iv3.setBackgroundColor(palette.getDarkMutedSwatch().getRgb());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="使用DrawerLayout"><a href="#使用DrawerLayout" class="headerlink" title="使用DrawerLayout"></a>使用DrawerLayout</h2><ul>
<li>布局中的使用</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.DrawerLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/drawer_layout"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!--主页面--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">include</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">            <span class="attr">layout</span>=<span class="string">"@layout/toolbar"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.charon.materialsample.view.PagerSlidingTabStrip</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/psts_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"48dip"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@color/colorPrimary"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/vp_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;<span class="tag">&lt;/<span class="name">android.support.v4.view.ViewPager</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--侧边栏部分--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"com.charon.materialsample.fragment.FragmentDrawer"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"@dimen/nav_drawer_width"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"start"</span></div><div class="line">        <span class="attr">app:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">tools:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.DrawerLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用DrawerLayout后可以实现类似SlidingMenu的效果。但是怎么将DrawerLayout与ToolBar结合起来呢？ 还有再结合Navigation Tabs<br>以及ViewPager。下面我就直接上代码了。</p>
<p>先看布局：　activity_main.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.DrawerLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/drawer_layout"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!--主页面--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">include</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/toolbar"</span></div><div class="line">            <span class="attr">layout</span>=<span class="string">"@layout/toolbar"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.charon.materialsample.view.PagerSlidingTabStrip</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/psts_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"48dip"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@color/colorPrimary"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/vp_main"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--侧边栏部分--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"com.charon.materialsample.fragment.DrawerFragment"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_marginRight</span>=<span class="string">"56dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"start"</span></div><div class="line">        <span class="attr">app:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span></div><div class="line">        <span class="attr">tools:layout</span>=<span class="string">"@layout/fragment_navigation_drawer"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.DrawerLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>MainActivity的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Toolbar mToolbar;</div><div class="line">    <span class="keyword">private</span> PagerSlidingTabStrip mScrollingTabs;</div><div class="line">    <span class="keyword">private</span> ViewPager mViewPager;</div><div class="line">    <span class="keyword">private</span> MainPagerAdapter mPagerAdapter;</div><div class="line">    <span class="keyword">private</span> ActionBarDrawerToggle mDrawerToggle;</div><div class="line">    <span class="keyword">private</span> DrawerLayout mDrawerLayout;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; mTitles;</div><div class="line">    <span class="keyword">private</span> List&lt;Fragment&gt; mFragments;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContext = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">        findView();</div><div class="line">        setToolBar();</div><div class="line">        initView();</div><div class="line">        initDrawerFragment();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mToolbar = (Toolbar) findViewById(R.id.toolbar);</div><div class="line">        mScrollingTabs = (PagerSlidingTabStrip) findViewById(R.id.psts_main);</div><div class="line">        mViewPager = (ViewPager) findViewById(R.id.vp_main);</div><div class="line">        mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setToolBar</span><span class="params">()</span> </span>&#123;</div><div class="line">        mToolbar.setTitle(R.string.app_name);</div><div class="line">        setSupportActionBar(mToolbar);</div><div class="line">        getSupportActionBar().setDisplayShowHomeEnabled(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mFragments = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xxx = <span class="number">0</span>; xxx &lt; <span class="number">5</span>; xxx++) &#123;</div><div class="line">            mFragments.add(<span class="keyword">new</span> FriendsFragment());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mTitles = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xxx = <span class="number">0</span>; xxx &lt; <span class="number">5</span>; xxx++) &#123;</div><div class="line">            mTitles.add(<span class="string">"Tab : "</span> + xxx);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mPagerAdapter = <span class="keyword">new</span> MainPagerAdapter(getSupportFragmentManager(), mFragments, mTitles);</div><div class="line">        mViewPager.setAdapter(mPagerAdapter);</div><div class="line">        mScrollingTabs.setDividerColor(Color.TRANSPARENT);</div><div class="line">        mScrollingTabs.setIndicatorHeight(<span class="number">10</span>);</div><div class="line">        mScrollingTabs.setUnderlineHeight(<span class="number">0</span>);</div><div class="line">        mScrollingTabs.setTextSize(<span class="number">50</span>);</div><div class="line">        mScrollingTabs.setTextColor(Color.BLACK);</div><div class="line">        mScrollingTabs.setSelectedTextColor(Color.WHITE);</div><div class="line">        mScrollingTabs.setViewPager(mViewPager);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDrawerFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDrawerToggle = <span class="keyword">new</span> ActionBarDrawerToggle(<span class="keyword">this</span>, mDrawerLayout, mToolbar, R.string.drawer_open, R.string.drawer_close) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawerOpened</span><span class="params">(View drawerView)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onDrawerOpened(drawerView);</div><div class="line">                MainActivity.<span class="keyword">this</span>.invalidateOptionsMenu();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawerClosed</span><span class="params">(View drawerView)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onDrawerClosed(drawerView);</div><div class="line">                MainActivity.<span class="keyword">this</span>.invalidateOptionsMenu();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawerSlide</span><span class="params">(View drawerView, <span class="keyword">float</span> slideOffset)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onDrawerSlide(drawerView, slideOffset);</div><div class="line">                mToolbar.setAlpha(<span class="number">1</span> - slideOffset / <span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        mDrawerLayout.setDrawerListener(mDrawerToggle);</div><div class="line">        mDrawerToggle.syncState();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">        <span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></div><div class="line">        getMenuInflater().inflate(R.menu.menu_main, menu);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">        <span class="comment">// Handle action bar item clicks here. The action bar will</span></div><div class="line">        <span class="comment">// automatically handle clicks on the Home/Up button, so long</span></div><div class="line">        <span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></div><div class="line">        <span class="keyword">int</span> id = item.getItemId();</div><div class="line"></div><div class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (id == R.id.action_search) &#123;</div><div class="line">            Toast.makeText(getApplicationContext(), <span class="string">"Search action is selected!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后再看一下<code>DrawerFragment</code>的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawerFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> NavigationDrawerAdapter mAdapter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] titles = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DrawerFragment</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;NavDrawerItem&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;NavDrawerItem&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// preparing navigation drawer items</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; titles.length; i++) &#123;</div><div class="line">            NavDrawerItem navItem = <span class="keyword">new</span> NavDrawerItem();</div><div class="line">            navItem.setTitle(titles[i]);</div><div class="line">            data.add(navItem);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mContext = getActivity();</div><div class="line">        <span class="comment">// drawer labels</span></div><div class="line">        titles = getActivity().getResources().getStringArray(R.array.nav_drawer_labels);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">                             Bundle savedInstanceState) &#123;</div><div class="line">        <span class="comment">// Inflating view layout</span></div><div class="line">        View layout = inflater.inflate(R.layout.fragment_navigation_drawer, container, <span class="keyword">false</span>);</div><div class="line">        mRecyclerView = (RecyclerView) layout.findViewById(R.id.drawerList);</div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line">        mAdapter = <span class="keyword">new</span> NavigationDrawerAdapter(getActivity(), getData());</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">        mRecyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(getActivity()));</div><div class="line">        mAdapter.setOnRecyclerViewListener(<span class="keyword">new</span> NavigationDrawerAdapter.OnRecyclerViewListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(mContext, getData().get(position).getTitle(), Toast.LENGTH_SHORT).show();</div><div class="line">                startActivity(<span class="keyword">new</span> Intent(getActivity(), FriendsActivity.class));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onItemLongClick</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> layout;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的<code>PagerSlidingTabStrip</code>是开源项目，我改了下，添加了一个选中时的文字颜色改变。</p>
<p><a href="https://github.com/CharonChui/MaterialLibrary">Demo地址</a></p>
<h2 id="Ripple效果"><a href="#Ripple效果" class="headerlink" title="Ripple效果"></a>Ripple效果</h2><p>个人非常喜欢的效果。相当于给点击事件加上了动态的赶脚。。。</p>
<p>假设现在有一个<code>Button</code>的<code>selector</code>，我们想给这个<code>Button</code>加上<code>Ripple</code>效果，肿么办？<br>新建一个<code>xml</code>文件，用<code>ripple</code>包裹<code>selector</code>，然后在<code>Button</code>的<code>backgroud</code>直接引用这个<code>xml</code>就好了。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">&lt;ripple xmlns:android="http://schemas.android.com/apk/res/android"</div><div class="line">android:color="@color/whatever"&gt;</div><div class="line">&lt;selector xmlns:android="http://schemas.android.com/apk/res/android"</div><div class="line">&lt;item android:state_pressed="false" android:state_focused="true"</div><div class="line">android:drawable="@drawable/some_focused_blah"/&gt;</div><div class="line">&lt;item android:state_pressed="true" android:drawable="@drawable/some_pressed_blah"/&gt;</div><div class="line">&lt;item android:drawable="@android:color/whatever"/&gt;</div><div class="line">&lt;/selector&gt;</div><div class="line">&lt;/ripple&gt;</div></pre></td></tr></table></figure></p>
<p>但是很遗憾，<code>ripple</code>是5.0才有的，而且<code>support</code>包中没有实现该功能的扩展。<br><code>5.0</code>的这些效果还是无法在低版本上实现，包括一些<code>TextView</code>等样式，现在可以用大神的开源项目<br><a href="https://github.com/navasmdc/MaterialDesignLibrary">MaterialDesignLibrary</a></p>
<h2 id="RecyclerView"><a href="#RecyclerView" class="headerlink" title="RecyclerView"></a>RecyclerView</h2><p><code>ListView</code>的升级版，还有什么理由不去用呢？ 同样他也在<code>support v7</code>包中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.android.support:recyclerview-v7:21.+&apos;</div></pre></td></tr></table></figure></p>
<p>通过<code>mRecyclerView.setLayoutManager(new LinearLayoutManager(this));</code>设置为<code>LinearLayoutManager</code>来实现水平或者竖直<br>方向的<code>ListView</code>。</p>
<h2 id="阴影"><a href="#阴影" class="headerlink" title="阴影"></a>阴影</h2><p>通过对<code>View</code>设置<code>backgroud</code>后再添加<code>android:elevation=&quot;2dp&quot;</code>来实现背景大小。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/MaterialDesign使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-VideoView源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/VideoView源码分析/">VideoView源码分析</a>
    </h1>
  

        
        <a href="/2015/01/01/VideoView源码分析/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="VideoView源码分析"><a href="#VideoView源码分析" class="headerlink" title="VideoView源码分析"></a>VideoView源码分析</h1><h2 id="VideoView"><a href="#VideoView" class="headerlink" title="VideoView"></a>VideoView</h2><p>基于Android4.4源码进行分析</p>
<ul>
<li><p>简介     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Displays a video file.  The VideoView class</div><div class="line"> * can load images from various sources (such as resources or content</div><div class="line"> * providers), takes care of computing its measurement from the video so that</div><div class="line"> * it can be used in any layout manager, and provides various display options</div><div class="line"> * such as scaling and tinting.&lt;p&gt;</div><div class="line"> *</div><div class="line"> * &lt;em&gt;Note: VideoView does not retain its full state when going into the</div><div class="line"> * background.&lt;/em&gt;  In particular, it does not restore the current play state,</div><div class="line"> * play position, selected tracks, or any subtitle tracks added via</div><div class="line"> * &#123;<span class="doctag">@link</span> #addSubtitleSource addSubtitleSource()&#125;.  Applications should</div><div class="line"> * save and restore these on their own in</div><div class="line"> * &#123;<span class="doctag">@link</span> android.app.Activity#onSaveInstanceState&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> android.app.Activity#onRestoreInstanceState&#125;.&lt;p&gt;</div><div class="line"> * Also note that the audio session id (from &#123;<span class="doctag">@link</span> #getAudioSessionId&#125;) may</div><div class="line"> * change from its previously returned value when the VideoView is restored.</div><div class="line"> */</div></pre></td></tr></table></figure>
</li>
<li><p>关系       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoView</span> <span class="keyword">extends</span> <span class="title">SurfaceView</span></span></div><div class="line">		<span class="keyword">implements</span> <span class="title">MediaPlayerControl</span></div></pre></td></tr></table></figure>
</li>
<li><p>成员</p>
<ul>
<li><p>播放器所有的状态</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// all possible internal states</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ERROR              = -<span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_IDLE               = <span class="number">0</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PREPARING          = <span class="number">1</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PREPARED           = <span class="number">2</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PLAYING            = <span class="number">3</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PAUSED             = <span class="number">4</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PLAYBACK_COMPLETED = <span class="number">5</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>记录播放器状态</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">	<span class="comment">// mCurrentState is a VideoView object's current state.</span></div><div class="line">	<span class="comment">// mTargetState is the state that a method caller intends to reach.</span></div><div class="line">	<span class="comment">// For instance, regardless the VideoView object's current state,</span></div><div class="line">	<span class="comment">// calling pause() intends to bring the object to a target state</span></div><div class="line">	<span class="comment">// of STATE_PAUSED.</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mCurrentState = STATE_IDLE;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mTargetState  = STATE_IDLE;</div><div class="line">	```		</div><div class="line"></div><div class="line">- 主要功能部分</div><div class="line">	```java</div><div class="line">	<span class="keyword">private</span> SurfaceHolder mSurfaceHolder = <span class="keyword">null</span>;<span class="comment">// 显示图像</span></div><div class="line">       <span class="keyword">private</span> MediaPlayer mMediaPlayer = <span class="keyword">null</span>; <span class="comment">// 声音、播放</span></div><div class="line">	<span class="keyword">private</span> MediaController mMediaController; <span class="comment">// 播放控制</span></div></pre></td></tr></table></figure>
</li>
<li><p>其他</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>         mVideoWidth;  <span class="comment">// 视频宽度 在onVideoSizeChanged() 和 onPrepared() 中可以得到具体大小</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>         mVideoHeight;  <span class="comment">//视频高度</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>         mSurfaceWidth; <span class="comment">// Surface宽度  在SurfaceHolder.Callback.surfaceChanged() 中可以得到具体大小</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>         mSurfaceHeight; <span class="comment">// Surface高度</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>         mSeekWhenPrepared;  <span class="comment">// recording the seek position while preparing</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li>具体实现<ul>
<li>构造方法  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">VideoView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>(context);</div><div class="line">	initVideoView();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">VideoView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">	initVideoView();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">VideoView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>(context, attrs, defStyle);</div><div class="line">	initVideoView();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 进行一些必要信息的初始化设置</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initVideoView</span><span class="params">()</span> </span>&#123;</div><div class="line">	mVideoWidth = <span class="number">0</span>;</div><div class="line">	mVideoHeight = <span class="number">0</span>;</div><div class="line">	</div><div class="line">	<span class="comment">// 通过SurfaceHolder去控制SurfaceView</span></div><div class="line">	getHolder().addCallback(mSHCallback);</div><div class="line">	<span class="comment">// Deprecated. this is ignored, this value is set automatically when needed.Android3.0以上会自动设置，但是为了兼容还需设置</span></div><div class="line">	getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);</div><div class="line">	</div><div class="line">	setFocusable(<span class="keyword">true</span>);</div><div class="line">	setFocusableInTouchMode(<span class="keyword">true</span>);</div><div class="line">	requestFocus();</div><div class="line">	</div><div class="line">	<span class="comment">// 字幕相关，用不到</span></div><div class="line">	mPendingSubtitleTracks = <span class="keyword">new</span> Vector&lt;Pair&lt;InputStream, MediaFormat&gt;&gt;();</div><div class="line">	</div><div class="line">	mCurrentState = STATE_IDLE;</div><div class="line">	mTargetState  = STATE_IDLE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    SurfaceHolder.Callback源码
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">SurfaceHolder.Callback mSHCallback = <span class="keyword">new</span> SurfaceHolder.Callback()</div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="keyword">int</span> format,</span></span></div><div class="line">								<span class="keyword">int</span> w, <span class="keyword">int</span> h)</div><div class="line">	&#123;</div><div class="line">		mSurfaceWidth = w;</div><div class="line">		mSurfaceHeight = h;</div><div class="line">		<span class="keyword">boolean</span> isValidState =  (mTargetState == STATE_PLAYING);</div><div class="line">		<span class="keyword">boolean</span> hasValidSize = (mVideoWidth == w &amp;&amp; mVideoHeight == h);</div><div class="line">		<span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span> &amp;&amp; isValidState &amp;&amp; hasValidSize) &#123;</div><div class="line">			<span class="keyword">if</span> (mSeekWhenPrepared != <span class="number">0</span>) &#123;</div><div class="line">				seekTo(mSeekWhenPrepared);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 如果当前已经是播放状态的话就调用mediaplaer.start() 方法，并且把当前状态以及目标状态进行改变</span></div><div class="line">			start();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span></span></div><div class="line">	&#123;</div><div class="line">		mSurfaceHolder = holder;</div><div class="line">		<span class="comment">// Surface创建后就开始调用播放</span></div><div class="line">		openVideo();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// after we return from this we can't use the surface any more</span></div><div class="line">		mSurfaceHolder = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) mMediaController.hide();</div><div class="line">		release(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>


- 重写onMeasure()方法
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">       <span class="keyword">int</span> width = getDefaultSize(mVideoWidth, widthMeasureSpec);</div><div class="line">       <span class="keyword">int</span> height = getDefaultSize(mVideoHeight, heightMeasureSpec);</div><div class="line">	</div><div class="line">	<span class="comment">// ....根据视频的宽高比进行处理， 为了更好的宽展，提供一些用户能自己选择的模式，一般会另外提供方法, 这部分代码可以先不看 start</span></div><div class="line">	<span class="keyword">int</span> width = getDefaultSize(mVideoWidth, widthMeasureSpec);</div><div class="line">       <span class="keyword">int</span> height = getDefaultSize(mVideoHeight, heightMeasureSpec);</div><div class="line">       <span class="keyword">if</span> (mVideoWidth &gt; <span class="number">0</span> &amp;&amp; mVideoHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">	</div><div class="line">           <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">           <span class="keyword">int</span> widthSpecSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">           <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">           <span class="keyword">int</span> heightSpecSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">	</div><div class="line">           <span class="keyword">if</span> (widthSpecMode == MeasureSpec.EXACTLY &amp;&amp; heightSpecMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">               <span class="comment">// the size is fixed</span></div><div class="line">               width = widthSpecSize;</div><div class="line">               height = heightSpecSize;</div><div class="line">	</div><div class="line">               <span class="comment">// for compatibility, we adjust size based on aspect ratio</span></div><div class="line">               <span class="keyword">if</span> ( mVideoWidth * height  &lt; width * mVideoHeight ) &#123;</div><div class="line">                   <span class="comment">//Log.i("@@@", "image too wide, correcting");</span></div><div class="line">                   width = height * mVideoWidth / mVideoHeight;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( mVideoWidth * height  &gt; width * mVideoHeight ) &#123;</div><div class="line">                   <span class="comment">//Log.i("@@@", "image too tall, correcting");</span></div><div class="line">                   height = width * mVideoHeight / mVideoWidth;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">               <span class="comment">// only the width is fixed, adjust the height to match aspect ratio if possible</span></div><div class="line">               width = widthSpecSize;</div><div class="line">               height = width * mVideoHeight / mVideoWidth;</div><div class="line">               <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST &amp;&amp; height &gt; heightSpecSize) &#123;</div><div class="line">                   <span class="comment">// couldn't match aspect ratio within the constraints</span></div><div class="line">                   height = heightSpecSize;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">               <span class="comment">// only the height is fixed, adjust the width to match aspect ratio if possible</span></div><div class="line">               height = heightSpecSize;</div><div class="line">               width = height * mVideoWidth / mVideoHeight;</div><div class="line">               <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; width &gt; widthSpecSize) &#123;</div><div class="line">                   <span class="comment">// couldn't match aspect ratio within the constraints</span></div><div class="line">                   width = widthSpecSize;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// neither the width nor the height are fixed, try to use actual video size</span></div><div class="line">               width = mVideoWidth;</div><div class="line">               height = mVideoHeight;</div><div class="line">               <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST &amp;&amp; height &gt; heightSpecSize) &#123;</div><div class="line">                   <span class="comment">// too tall, decrease both width and height</span></div><div class="line">                   height = heightSpecSize;</div><div class="line">                   width = height * mVideoWidth / mVideoHeight;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; width &gt; widthSpecSize) &#123;</div><div class="line">                   <span class="comment">// too wide, decrease both width and height</span></div><div class="line">                   width = widthSpecSize;</div><div class="line">                   height = width * mVideoHeight / mVideoWidth;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// no size yet, just adopt the given spec sizes</span></div><div class="line">       &#125;</div><div class="line">	<span class="comment">// end</span></div><div class="line">	</div><div class="line">       setMeasuredDimension(width, height);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>


    - 附上getDefaultSize()源码 
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size Default size for this view</div><div class="line"> * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line"> * <span class="doctag">@return</span> The size this view should be.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> result = size;</div><div class="line">	<span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">	<span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (specMode) &#123;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">		result = size;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">	<span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">		result = specSize;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


- 外部进行播放调用
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">	setVideoURI(Uri.parse(path));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoURI</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">	setVideoURI(uri, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoURI</span><span class="params">(Uri uri, Map&lt;String, String&gt; headers)</span> </span>&#123;</div><div class="line">	mUri = uri;</div><div class="line">	mHeaders = headers;</div><div class="line">	mSeekWhenPrepared = <span class="number">0</span>;</div><div class="line">	</div><div class="line">	openVideo();</div><div class="line">	</div><div class="line">	requestLayout();</div><div class="line">	invalidate();</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - openVide() 源码
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openVideo</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mUri == <span class="keyword">null</span> || mSurfaceHolder == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// not ready for playback just yet, will try again later</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// Tell the music playback service to pause</span></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> these constants need to be published somewhere in the framework.</span></div><div class="line">	Intent i = <span class="keyword">new</span> Intent(<span class="string">"com.android.music.musicservicecommand"</span>);</div><div class="line">	i.putExtra(<span class="string">"command"</span>, <span class="string">"pause"</span>);</div><div class="line">	mContext.sendBroadcast(i);</div><div class="line"></div><div class="line">	<span class="comment">// we shouldn't clear the target state, because somebody might have</span></div><div class="line">	<span class="comment">// called start() previously // 先把已经存在的MediaPlayer释放掉，然后重新创建一个, 不一定只在SetVideoPath() 中调用，在其他地方也会调用</span></div><div class="line">	release(<span class="keyword">false</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 创建一个MediaPlayer</span></div><div class="line">		mMediaPlayer = <span class="keyword">new</span> MediaPlayer();</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> create SubtitleController in MediaPlayer, but we need</span></div><div class="line">		<span class="comment">// a context for the subtitle renderers</span></div><div class="line">		<span class="keyword">final</span> Context context = getContext();</div><div class="line">		<span class="keyword">final</span> SubtitleController controller = <span class="keyword">new</span> SubtitleController(</div><div class="line">				context, mMediaPlayer.getMediaTimeProvider(), mMediaPlayer);</div><div class="line">		controller.registerRenderer(<span class="keyword">new</span> WebVttRenderer(context));</div><div class="line">		mMediaPlayer.setSubtitleAnchor(controller, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAudioSession != <span class="number">0</span>) &#123;</div><div class="line">			mMediaPlayer.setAudioSessionId(mAudioSession);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mAudioSession = mMediaPlayer.getAudioSessionId();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// 设置一些必要的监听</span></div><div class="line">		mMediaPlayer.setOnPreparedListener(mPreparedListener);</div><div class="line">		mMediaPlayer.setOnVideoSizeChangedListener(mSizeChangedListener);</div><div class="line">		mMediaPlayer.setOnCompletionListener(mCompletionListener);</div><div class="line">		mMediaPlayer.setOnErrorListener(mErrorListener);</div><div class="line">		mMediaPlayer.setOnInfoListener(mInfoListener);</div><div class="line">		mMediaPlayer.setOnBufferingUpdateListener(mBufferingUpdateListener);</div><div class="line">		mCurrentBufferPercentage = <span class="number">0</span>;</div><div class="line">		<span class="comment">// 让MediaPlayer进行播放</span></div><div class="line">		mMediaPlayer.setDataSource(mContext, mUri, mHeaders);</div><div class="line">		<span class="comment">// 让SurfaceView进行画面显示</span></div><div class="line">		mMediaPlayer.setDisplay(mSurfaceHolder);</div><div class="line">		<span class="comment">// 设置音频类型</span></div><div class="line">		mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);</div><div class="line">		<span class="comment">// 播放时屏幕常亮</span></div><div class="line">		mMediaPlayer.setScreenOnWhilePlaying(<span class="keyword">true</span>);</div><div class="line">		<span class="comment">// Prepares the player for playback, asynchronously. After setting the datasource and the display surface, you need to either call prepare() or prepareAsync(). For streams, you should call prepareAsync(), </span></div><div class="line">		<span class="comment">// which returns immediately, rather than blocking until enough data has been buffered.</span></div><div class="line">		mMediaPlayer.prepareAsync();</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (Pair&lt;InputStream, MediaFormat&gt; pending: mPendingSubtitleTracks) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				mMediaPlayer.addSubtitleSource(pending.first, pending.second);</div><div class="line">			&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">				mInfoListener.onInfo(</div><div class="line">						mMediaPlayer, MediaPlayer.MEDIA_INFO_UNSUPPORTED_SUBTITLE, <span class="number">0</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// we don't set the target state here either, but preserve the</span></div><div class="line">		<span class="comment">// target state that was there before.</span></div><div class="line">		mCurrentState = STATE_PREPARING;</div><div class="line">		<span class="comment">// 如果已经调用过SetMediaController() 方法，这里会直接显示</span></div><div class="line">		attachMediaController();</div><div class="line">	&#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">		Log.w(TAG, <span class="string">"Unable to open content: "</span> + mUri, ex);</div><div class="line">		mCurrentState = STATE_ERROR;</div><div class="line">		mTargetState = STATE_ERROR;</div><div class="line">		mErrorListener.onError(mMediaPlayer, MediaPlayer.MEDIA_ERROR_UNKNOWN, <span class="number">0</span>);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">		Log.w(TAG, <span class="string">"Unable to open content: "</span> + mUri, ex);</div><div class="line">		mCurrentState = STATE_ERROR;</div><div class="line">		mTargetState = STATE_ERROR;</div><div class="line">		mErrorListener.onError(mMediaPlayer, MediaPlayer.MEDIA_ERROR_UNKNOWN, <span class="number">0</span>);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		mPendingSubtitleTracks.clear();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


        release() 方法,在开始播放一个视频的时候会先调用该方法，然后重新创建一个，在SurfaceView销毁的时候也会调用该方法
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * release the media player in any state</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(<span class="keyword">boolean</span> cleartargetstate)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span>) &#123;</div><div class="line">		mMediaPlayer.reset();</div><div class="line">		mMediaPlayer.release();</div><div class="line">		mMediaPlayer = <span class="keyword">null</span>;</div><div class="line">		mPendingSubtitleTracks.clear();</div><div class="line">		mCurrentState = STATE_IDLE;</div><div class="line">		<span class="keyword">if</span> (cleartargetstate) &#123;</div><div class="line">			mTargetState  = STATE_IDLE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - 外部停止播放调用
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopPlayback</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span>) &#123;</div><div class="line">		mMediaPlayer.stop();</div><div class="line">		mMediaPlayer.release();</div><div class="line">		mMediaPlayer = <span class="keyword">null</span>;</div><div class="line">		mCurrentState = STATE_IDLE;</div><div class="line">		mTargetState  = STATE_IDLE;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - 外部设置控制栏部分
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediaController</span><span class="params">(MediaController controller)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">		mMediaController.hide();</div><div class="line">	&#125;</div><div class="line">	mMediaController = controller;</div><div class="line">	attachMediaController();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachMediaController</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span> &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// setMediaPlayer(MediaPlayerControl player), 让MediaPlayer相应的控制部分调用本类中的实现方法</span></div><div class="line">		mMediaController.setMediaPlayer(<span class="keyword">this</span>);</div><div class="line">		View anchorView = <span class="keyword">this</span>.getParent() <span class="keyword">instanceof</span> View ?</div><div class="line">				(View)<span class="keyword">this</span>.getParent() : <span class="keyword">this</span>;</div><div class="line">				</div><div class="line">		<span class="comment">// 创建Controller并且依据AnchorView的位置进行显示</span></div><div class="line">		mMediaController.setAnchorView(anchorView);</div><div class="line">		mMediaController.setEnabled(isInPlaybackState());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - MediaPlayer必要监听
        - OnVideoSizeChangedListener
            <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">MediaPlayer.OnVideoSizeChangedListener mSizeChangedListener =</div><div class="line">	<span class="keyword">new</span> MediaPlayer.OnVideoSizeChangedListener() &#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVideoSizeChanged</span><span class="params">(MediaPlayer mp, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">			mVideoWidth = mp.getVideoWidth();</div><div class="line">			mVideoHeight = mp.getVideoHeight();</div><div class="line">			<span class="keyword">if</span> (mVideoWidth != <span class="number">0</span> &amp;&amp; mVideoHeight != <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// 这个方法是设置Surface分辨率，而不是设置视频播放窗口的大小，视频播放窗口大小是由SurfaceView的布局控制，要分清Surface与SurfaceView的区别，Surface是Window中整个的一个控件(句柄),</span></div><div class="line">				<span class="comment">// 而SurfaceView是一个包含Surface的View，SurfaceView覆盖到Surface上(可以这样理解)，我们只能通过SurfaceView来看Surface中的内容,至于在SurfaceView显示之外的Surface我们是不可见的.</span></div><div class="line">				getHolder().setFixedSize(mVideoWidth, mVideoHeight);</div><div class="line">				requestLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

        - OnPreparedListener
            <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">MediaPlayer.OnPreparedListener mPreparedListener = <span class="keyword">new</span> MediaPlayer.OnPreparedListener() &#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</div><div class="line">		mCurrentState = STATE_PREPARED;</div><div class="line"></div><div class="line">		<span class="comment">// Get the capabilities of the player for this stream</span></div><div class="line">		Metadata data = mp.getMetadata(MediaPlayer.METADATA_ALL,</div><div class="line">								  MediaPlayer.BYPASS_METADATA_FILTER);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</div><div class="line">			mCanPause = !data.has(Metadata.PAUSE_AVAILABLE)</div><div class="line">					|| data.getBoolean(Metadata.PAUSE_AVAILABLE);</div><div class="line">			mCanSeekBack = !data.has(Metadata.SEEK_BACKWARD_AVAILABLE)</div><div class="line">					|| data.getBoolean(Metadata.SEEK_BACKWARD_AVAILABLE);</div><div class="line">			mCanSeekForward = !data.has(Metadata.SEEK_FORWARD_AVAILABLE)</div><div class="line">					|| data.getBoolean(Metadata.SEEK_FORWARD_AVAILABLE);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			mCanPause = mCanSeekBack = mCanSeekForward = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mOnPreparedListener != <span class="keyword">null</span>) &#123;</div><div class="line">			mOnPreparedListener.onPrepared(mMediaPlayer);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">			mMediaController.setEnabled(<span class="keyword">true</span>);</div><div class="line">		&#125;</div><div class="line">		mVideoWidth = mp.getVideoWidth();</div><div class="line">		mVideoHeight = mp.getVideoHeight();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> seekToPosition = mSeekWhenPrepared;  <span class="comment">// mSeekWhenPrepared may be changed after seekTo() call</span></div><div class="line">		<span class="keyword">if</span> (seekToPosition != <span class="number">0</span>) &#123;</div><div class="line">			seekTo(seekToPosition);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mVideoWidth != <span class="number">0</span> &amp;&amp; mVideoHeight != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">//Log.i("@@@@", "video size: " + mVideoWidth +"/"+ mVideoHeight);</span></div><div class="line">			getHolder().setFixedSize(mVideoWidth, mVideoHeight);</div><div class="line">			<span class="keyword">if</span> (mSurfaceWidth == mVideoWidth &amp;&amp; mSurfaceHeight == mVideoHeight) &#123;</div><div class="line">				<span class="comment">// We didn't actually change the size (it was already at the size</span></div><div class="line">				<span class="comment">// we need), so we won't get a "surface changed" callback, so</span></div><div class="line">				<span class="comment">// start the video here instead of in the callback.</span></div><div class="line">				<span class="keyword">if</span> (mTargetState == STATE_PLAYING) &#123;</div><div class="line">					start();</div><div class="line">					<span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">						mMediaController.show();</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isPlaying() &amp;&amp;</div><div class="line">						   (seekToPosition != <span class="number">0</span> || getCurrentPosition() &gt; <span class="number">0</span>)) &#123;</div><div class="line">				   <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">					   <span class="comment">// Show the media controls when we're paused into a video and make 'em stick.</span></div><div class="line">					   mMediaController.show(<span class="number">0</span>);</div><div class="line">				   &#125;</div><div class="line">			   &#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// We don't know the video size yet, but should start anyway.</span></div><div class="line">			<span class="comment">// The video size might be reported to us later.</span></div><div class="line">			<span class="keyword">if</span> (mTargetState == STATE_PLAYING) &#123;</div><div class="line">				start();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>


        - OnCompletionListener
            <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> MediaPlayer.OnCompletionListener mCompletionListener =</div><div class="line">	<span class="keyword">new</span> MediaPlayer.OnCompletionListener() &#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</div><div class="line">		mCurrentState = STATE_PLAYBACK_COMPLETED;</div><div class="line">		mTargetState = STATE_PLAYBACK_COMPLETED;</div><div class="line">		<span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">			mMediaController.hide();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mOnCompletionListener != <span class="keyword">null</span>) &#123;</div><div class="line">			mOnCompletionListener.onCompletion(mMediaPlayer);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>


    - Touch以及Key的监听
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (isInPlaybackState() &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">	    <span class="comment">// 控制MediaController的显示与隐藏</span></div><div class="line">		toggleMediaControlsVisiblity();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

    - toggleMediaControlsVisiblity      
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">toggleMediaControlsVisiblity</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mMediaController.isShowing()) &#123;</div><div class="line">		mMediaController.hide();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mMediaController.show();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - Key
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">boolean</span> isKeyCodeSupported = keyCode != KeyEvent.KEYCODE_BACK &amp;&amp;</div><div class="line">								 keyCode != KeyEvent.KEYCODE_VOLUME_UP &amp;&amp;</div><div class="line">								 keyCode != KeyEvent.KEYCODE_VOLUME_DOWN &amp;&amp;</div><div class="line">								 keyCode != KeyEvent.KEYCODE_VOLUME_MUTE &amp;&amp;</div><div class="line">								 keyCode != KeyEvent.KEYCODE_MENU &amp;&amp;</div><div class="line">								 keyCode != KeyEvent.KEYCODE_CALL &amp;&amp;</div><div class="line">								 keyCode != KeyEvent.KEYCODE_ENDCALL;</div><div class="line">	<span class="keyword">if</span> (isInPlaybackState() &amp;&amp; isKeyCodeSupported &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_HEADSETHOOK ||</div><div class="line">				keyCode == KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE) &#123;</div><div class="line">			<span class="keyword">if</span> (mMediaPlayer.isPlaying()) &#123;</div><div class="line">				pause();</div><div class="line">				mMediaController.show();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				start();</div><div class="line">				mMediaController.hide();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MEDIA_PLAY) &#123;</div><div class="line">			<span class="keyword">if</span> (!mMediaPlayer.isPlaying()) &#123;</div><div class="line">				start();</div><div class="line">				mMediaController.hide();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MEDIA_STOP</div><div class="line">				|| keyCode == KeyEvent.KEYCODE_MEDIA_PAUSE) &#123;</div><div class="line">			<span class="keyword">if</span> (mMediaPlayer.isPlaying()) &#123;</div><div class="line">				pause();</div><div class="line">				mMediaController.show();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			toggleMediaControlsVisiblity();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.onKeyDown(keyCode, event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h1 id="华丽丽的分割线-上源码"><a href="#华丽丽的分割线-上源码" class="headerlink" title="华丽丽的分割线 上源码"></a>华丽丽的分割线 上源码</h1><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Copyright (C) 2006 The Android Open Source Project</div><div class="line"> *</div><div class="line"> * Licensed under the Apache License, Version 2.0 (the "License");</div><div class="line"> * you may not use this file except in compliance with the License.</div><div class="line"> * You may obtain a copy of the License at</div><div class="line"> *</div><div class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</div><div class="line"> *</div><div class="line"> * Unless required by applicable law or agreed to in writing, software</div><div class="line"> * distributed under the License is distributed on an "AS IS" BASIS,</div><div class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line"> * See the License for the specific language governing permissions and</div><div class="line"> * limitations under the License.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Displays a video file.  The VideoView class</div><div class="line"> * can load images from various sources (such as resources or content</div><div class="line"> * providers), takes care of computing its measurement from the video so that</div><div class="line"> * it can be used in any layout manager, and provides various display options</div><div class="line"> * such as scaling and tinting.&lt;p&gt;</div><div class="line"> *</div><div class="line"> * &lt;em&gt;Note: VideoView does not retain its full state when going into the</div><div class="line"> * background.&lt;/em&gt;  In particular, it does not restore the current play state,</div><div class="line"> * play position, selected tracks, or any subtitle tracks added via</div><div class="line"> * &#123;<span class="doctag">@link</span> #addSubtitleSource addSubtitleSource()&#125;.  Applications should</div><div class="line"> * save and restore these on their own in</div><div class="line"> * &#123;<span class="doctag">@link</span> android.app.Activity#onSaveInstanceState&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> android.app.Activity#onRestoreInstanceState&#125;.&lt;p&gt;</div><div class="line"> * Also note that the audio session id (from &#123;<span class="doctag">@link</span> #getAudioSessionId&#125;) may</div><div class="line"> * change from its previously returned value when the VideoView is restored.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoView</span> <span class="keyword">extends</span> <span class="title">SurfaceView</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">MediaPlayerControl</span>, <span class="title">SubtitleController</span>.<span class="title">Anchor</span> &#123;</div><div class="line">    <span class="keyword">private</span> String TAG = <span class="string">"VideoView"</span>;</div><div class="line">    <span class="comment">// settable by the client</span></div><div class="line">    <span class="keyword">private</span> Uri         mUri;</div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; mHeaders;</div><div class="line"></div><div class="line">    <span class="comment">// all possible internal states</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ERROR              = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_IDLE               = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PREPARING          = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PREPARED           = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PLAYING            = <span class="number">3</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PAUSED             = <span class="number">4</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PLAYBACK_COMPLETED = <span class="number">5</span>;</div><div class="line"></div><div class="line">    <span class="comment">// mCurrentState is a VideoView object's current state.</span></div><div class="line">    <span class="comment">// mTargetState is the state that a method caller intends to reach.</span></div><div class="line">    <span class="comment">// For instance, regardless the VideoView object's current state,</span></div><div class="line">    <span class="comment">// calling pause() intends to bring the object to a target state</span></div><div class="line">    <span class="comment">// of STATE_PAUSED.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCurrentState = STATE_IDLE;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTargetState  = STATE_IDLE;</div><div class="line"></div><div class="line">    <span class="comment">// All the stuff we need for playing and showing a video</span></div><div class="line">    <span class="keyword">private</span> SurfaceHolder mSurfaceHolder = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> MediaPlayer mMediaPlayer = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mAudioSession;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mVideoWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mVideoHeight;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mSurfaceWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mSurfaceHeight;</div><div class="line">    <span class="keyword">private</span> MediaController mMediaController;</div><div class="line">    <span class="keyword">private</span> OnCompletionListener mOnCompletionListener;</div><div class="line">    <span class="keyword">private</span> MediaPlayer.OnPreparedListener mOnPreparedListener;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mCurrentBufferPercentage;</div><div class="line">    <span class="keyword">private</span> OnErrorListener mOnErrorListener;</div><div class="line">    <span class="keyword">private</span> OnInfoListener  mOnInfoListener;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>         mSeekWhenPrepared;  <span class="comment">// recording the seek position while preparing</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>     mCanPause;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>     mCanSeekBack;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>     mCanSeekForward;</div><div class="line"></div><div class="line">    <span class="comment">/** Subtitle rendering widget overlaid on top of the video. */</span></div><div class="line">    <span class="keyword">private</span> RenderingWidget mSubtitleWidget;</div><div class="line"></div><div class="line">    <span class="comment">/** Listener for changes to subtitle data, used to redraw when needed. */</span></div><div class="line">    <span class="keyword">private</span> RenderingWidget.OnChangedListener mSubtitlesChangedListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VideoView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        initVideoView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VideoView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">        initVideoView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VideoView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</div><div class="line">        initVideoView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="comment">//Log.i("@@@@", "onMeasure(" + MeasureSpec.toString(widthMeasureSpec) + ", "</span></div><div class="line">        <span class="comment">//        + MeasureSpec.toString(heightMeasureSpec) + ")");</span></div><div class="line"></div><div class="line">        <span class="keyword">int</span> width = getDefaultSize(mVideoWidth, widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> height = getDefaultSize(mVideoHeight, heightMeasureSpec);</div><div class="line">        <span class="keyword">if</span> (mVideoWidth &gt; <span class="number">0</span> &amp;&amp; mVideoHeight &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">            <span class="keyword">int</span> widthSpecSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">            <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">            <span class="keyword">int</span> heightSpecSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (widthSpecMode == MeasureSpec.EXACTLY &amp;&amp; heightSpecMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">                <span class="comment">// the size is fixed</span></div><div class="line">                width = widthSpecSize;</div><div class="line">                height = heightSpecSize;</div><div class="line"></div><div class="line">                <span class="comment">// for compatibility, we adjust size based on aspect ratio</span></div><div class="line">                <span class="keyword">if</span> ( mVideoWidth * height  &lt; width * mVideoHeight ) &#123;</div><div class="line">                    <span class="comment">//Log.i("@@@", "image too wide, correcting");</span></div><div class="line">                    width = height * mVideoWidth / mVideoHeight;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( mVideoWidth * height  &gt; width * mVideoHeight ) &#123;</div><div class="line">                    <span class="comment">//Log.i("@@@", "image too tall, correcting");</span></div><div class="line">                    height = width * mVideoHeight / mVideoWidth;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">                <span class="comment">// only the width is fixed, adjust the height to match aspect ratio if possible</span></div><div class="line">                width = widthSpecSize;</div><div class="line">                height = width * mVideoHeight / mVideoWidth;</div><div class="line">                <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST &amp;&amp; height &gt; heightSpecSize) &#123;</div><div class="line">                    <span class="comment">// couldn't match aspect ratio within the constraints</span></div><div class="line">                    height = heightSpecSize;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">                <span class="comment">// only the height is fixed, adjust the width to match aspect ratio if possible</span></div><div class="line">                height = heightSpecSize;</div><div class="line">                width = height * mVideoWidth / mVideoHeight;</div><div class="line">                <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; width &gt; widthSpecSize) &#123;</div><div class="line">                    <span class="comment">// couldn't match aspect ratio within the constraints</span></div><div class="line">                    width = widthSpecSize;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// neither the width nor the height are fixed, try to use actual video size</span></div><div class="line">                width = mVideoWidth;</div><div class="line">                height = mVideoHeight;</div><div class="line">                <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST &amp;&amp; height &gt; heightSpecSize) &#123;</div><div class="line">                    <span class="comment">// too tall, decrease both width and height</span></div><div class="line">                    height = heightSpecSize;</div><div class="line">                    width = height * mVideoWidth / mVideoHeight;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; width &gt; widthSpecSize) &#123;</div><div class="line">                    <span class="comment">// too wide, decrease both width and height</span></div><div class="line">                    width = widthSpecSize;</div><div class="line">                    height = width * mVideoHeight / mVideoWidth;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// no size yet, just adopt the given spec sizes</span></div><div class="line">        &#125;</div><div class="line">        setMeasuredDimension(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInitializeAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onInitializeAccessibilityEvent(event);</div><div class="line">        event.setClassName(VideoView.class.getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInitializeAccessibilityNodeInfo</span><span class="params">(AccessibilityNodeInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onInitializeAccessibilityNodeInfo(info);</div><div class="line">        info.setClassName(VideoView.class.getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">resolveAdjustedSize</span><span class="params">(<span class="keyword">int</span> desiredSize, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getDefaultSize(desiredSize, measureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initVideoView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mVideoWidth = <span class="number">0</span>;</div><div class="line">        mVideoHeight = <span class="number">0</span>;</div><div class="line">        getHolder().addCallback(mSHCallback);</div><div class="line">        getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);</div><div class="line">        setFocusable(<span class="keyword">true</span>);</div><div class="line">        setFocusableInTouchMode(<span class="keyword">true</span>);</div><div class="line">        requestFocus();</div><div class="line">        mPendingSubtitleTracks = <span class="keyword">new</span> Vector&lt;Pair&lt;InputStream, MediaFormat&gt;&gt;();</div><div class="line">        mCurrentState = STATE_IDLE;</div><div class="line">        mTargetState  = STATE_IDLE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        setVideoURI(Uri.parse(path));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoURI</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">        setVideoURI(uri, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@hide</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVideoURI</span><span class="params">(Uri uri, Map&lt;String, String&gt; headers)</span> </span>&#123;</div><div class="line">        mUri = uri;</div><div class="line">        mHeaders = headers;</div><div class="line">        mSeekWhenPrepared = <span class="number">0</span>;</div><div class="line">        openVideo();</div><div class="line">        requestLayout();</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Adds an external subtitle source file (from the provided input stream.)</div><div class="line">     *</div><div class="line">     * Note that a single external subtitle source may contain multiple or no</div><div class="line">     * supported tracks in it. If the source contained at least one track in</div><div class="line">     * it, one will receive an &#123;<span class="doctag">@link</span> MediaPlayer#MEDIA_INFO_METADATA_UPDATE&#125;</div><div class="line">     * info message. Otherwise, if reading the source takes excessive time,</div><div class="line">     * one will receive a &#123;<span class="doctag">@link</span> MediaPlayer#MEDIA_INFO_SUBTITLE_TIMED_OUT&#125;</div><div class="line">     * message. If the source contained no supported track (including an empty</div><div class="line">     * source file or null input stream), one will receive a &#123;<span class="doctag">@link</span></div><div class="line">     * MediaPlayer#MEDIA_INFO_UNSUPPORTED_SUBTITLE&#125; message. One can find the</div><div class="line">     * total number of available tracks using &#123;<span class="doctag">@link</span> MediaPlayer#getTrackInfo()&#125;</div><div class="line">     * to see what additional tracks become available after this method call.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> is     input stream containing the subtitle data.  It will be</div><div class="line">     *               closed by the media framework.</div><div class="line">     * <span class="doctag">@param</span> format the format of the subtitle track(s).  Must contain at least</div><div class="line">     *               the mime type (&#123;<span class="doctag">@link</span> MediaFormat#KEY_MIME&#125;) and the</div><div class="line">     *               language (&#123;<span class="doctag">@link</span> MediaFormat#KEY_LANGUAGE&#125;) of the file.</div><div class="line">     *               If the file itself contains the language information,</div><div class="line">     *               specify "und" for the language.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSubtitleSource</span><span class="params">(InputStream is, MediaFormat format)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaPlayer == <span class="keyword">null</span>) &#123;</div><div class="line">            mPendingSubtitleTracks.add(Pair.create(is, format));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mMediaPlayer.addSubtitleSource(is, format);</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">                mInfoListener.onInfo(</div><div class="line">                        mMediaPlayer, MediaPlayer.MEDIA_INFO_UNSUPPORTED_SUBTITLE, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Vector&lt;Pair&lt;InputStream, MediaFormat&gt;&gt; mPendingSubtitleTracks;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopPlayback</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span>) &#123;</div><div class="line">            mMediaPlayer.stop();</div><div class="line">            mMediaPlayer.release();</div><div class="line">            mMediaPlayer = <span class="keyword">null</span>;</div><div class="line">            mCurrentState = STATE_IDLE;</div><div class="line">            mTargetState  = STATE_IDLE;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openVideo</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mUri == <span class="keyword">null</span> || mSurfaceHolder == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// not ready for playback just yet, will try again later</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Tell the music playback service to pause</span></div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> these constants need to be published somewhere in the framework.</span></div><div class="line">        Intent i = <span class="keyword">new</span> Intent(<span class="string">"com.android.music.musicservicecommand"</span>);</div><div class="line">        i.putExtra(<span class="string">"command"</span>, <span class="string">"pause"</span>);</div><div class="line">        mContext.sendBroadcast(i);</div><div class="line"></div><div class="line">        <span class="comment">// we shouldn't clear the target state, because somebody might have</span></div><div class="line">        <span class="comment">// called start() previously</span></div><div class="line">        release(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mMediaPlayer = <span class="keyword">new</span> MediaPlayer();</div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> create SubtitleController in MediaPlayer, but we need</span></div><div class="line">            <span class="comment">// a context for the subtitle renderers</span></div><div class="line">            <span class="keyword">final</span> Context context = getContext();</div><div class="line">            <span class="keyword">final</span> SubtitleController controller = <span class="keyword">new</span> SubtitleController(</div><div class="line">                    context, mMediaPlayer.getMediaTimeProvider(), mMediaPlayer);</div><div class="line">            controller.registerRenderer(<span class="keyword">new</span> WebVttRenderer(context));</div><div class="line">            mMediaPlayer.setSubtitleAnchor(controller, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mAudioSession != <span class="number">0</span>) &#123;</div><div class="line">                mMediaPlayer.setAudioSessionId(mAudioSession);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mAudioSession = mMediaPlayer.getAudioSessionId();</div><div class="line">            &#125;</div><div class="line">            mMediaPlayer.setOnPreparedListener(mPreparedListener);</div><div class="line">            mMediaPlayer.setOnVideoSizeChangedListener(mSizeChangedListener);</div><div class="line">            mMediaPlayer.setOnCompletionListener(mCompletionListener);</div><div class="line">            mMediaPlayer.setOnErrorListener(mErrorListener);</div><div class="line">            mMediaPlayer.setOnInfoListener(mInfoListener);</div><div class="line">            mMediaPlayer.setOnBufferingUpdateListener(mBufferingUpdateListener);</div><div class="line">            mCurrentBufferPercentage = <span class="number">0</span>;</div><div class="line">            mMediaPlayer.setDataSource(mContext, mUri, mHeaders);</div><div class="line">            mMediaPlayer.setDisplay(mSurfaceHolder);</div><div class="line">            mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);</div><div class="line">            mMediaPlayer.setScreenOnWhilePlaying(<span class="keyword">true</span>);</div><div class="line">            mMediaPlayer.prepareAsync();</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (Pair&lt;InputStream, MediaFormat&gt; pending: mPendingSubtitleTracks) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    mMediaPlayer.addSubtitleSource(pending.first, pending.second);</div><div class="line">                &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">                    mInfoListener.onInfo(</div><div class="line">                            mMediaPlayer, MediaPlayer.MEDIA_INFO_UNSUPPORTED_SUBTITLE, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// we don't set the target state here either, but preserve the</span></div><div class="line">            <span class="comment">// target state that was there before.</span></div><div class="line">            mCurrentState = STATE_PREPARING;</div><div class="line">            attachMediaController();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"Unable to open content: "</span> + mUri, ex);</div><div class="line">            mCurrentState = STATE_ERROR;</div><div class="line">            mTargetState = STATE_ERROR;</div><div class="line">            mErrorListener.onError(mMediaPlayer, MediaPlayer.MEDIA_ERROR_UNKNOWN, <span class="number">0</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"Unable to open content: "</span> + mUri, ex);</div><div class="line">            mCurrentState = STATE_ERROR;</div><div class="line">            mTargetState = STATE_ERROR;</div><div class="line">            mErrorListener.onError(mMediaPlayer, MediaPlayer.MEDIA_ERROR_UNKNOWN, <span class="number">0</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mPendingSubtitleTracks.clear();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediaController</span><span class="params">(MediaController controller)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">            mMediaController.hide();</div><div class="line">        &#125;</div><div class="line">        mMediaController = controller;</div><div class="line">        attachMediaController();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachMediaController</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span> &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">            mMediaController.setMediaPlayer(<span class="keyword">this</span>);</div><div class="line">            View anchorView = <span class="keyword">this</span>.getParent() <span class="keyword">instanceof</span> View ?</div><div class="line">                    (View)<span class="keyword">this</span>.getParent() : <span class="keyword">this</span>;</div><div class="line">            mMediaController.setAnchorView(anchorView);</div><div class="line">            mMediaController.setEnabled(isInPlaybackState());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    MediaPlayer.OnVideoSizeChangedListener mSizeChangedListener =</div><div class="line">        <span class="keyword">new</span> MediaPlayer.OnVideoSizeChangedListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVideoSizeChanged</span><span class="params">(MediaPlayer mp, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">                mVideoWidth = mp.getVideoWidth();</div><div class="line">                mVideoHeight = mp.getVideoHeight();</div><div class="line">                <span class="keyword">if</span> (mVideoWidth != <span class="number">0</span> &amp;&amp; mVideoHeight != <span class="number">0</span>) &#123;</div><div class="line">                    getHolder().setFixedSize(mVideoWidth, mVideoHeight);</div><div class="line">                    requestLayout();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    MediaPlayer.OnPreparedListener mPreparedListener = <span class="keyword">new</span> MediaPlayer.OnPreparedListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</div><div class="line">            mCurrentState = STATE_PREPARED;</div><div class="line"></div><div class="line">            <span class="comment">// Get the capabilities of the player for this stream</span></div><div class="line">            Metadata data = mp.getMetadata(MediaPlayer.METADATA_ALL,</div><div class="line">                                      MediaPlayer.BYPASS_METADATA_FILTER);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</div><div class="line">                mCanPause = !data.has(Metadata.PAUSE_AVAILABLE)</div><div class="line">                        || data.getBoolean(Metadata.PAUSE_AVAILABLE);</div><div class="line">                mCanSeekBack = !data.has(Metadata.SEEK_BACKWARD_AVAILABLE)</div><div class="line">                        || data.getBoolean(Metadata.SEEK_BACKWARD_AVAILABLE);</div><div class="line">                mCanSeekForward = !data.has(Metadata.SEEK_FORWARD_AVAILABLE)</div><div class="line">                        || data.getBoolean(Metadata.SEEK_FORWARD_AVAILABLE);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mCanPause = mCanSeekBack = mCanSeekForward = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mOnPreparedListener != <span class="keyword">null</span>) &#123;</div><div class="line">                mOnPreparedListener.onPrepared(mMediaPlayer);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">                mMediaController.setEnabled(<span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">            mVideoWidth = mp.getVideoWidth();</div><div class="line">            mVideoHeight = mp.getVideoHeight();</div><div class="line"></div><div class="line">            <span class="keyword">int</span> seekToPosition = mSeekWhenPrepared;  <span class="comment">// mSeekWhenPrepared may be changed after seekTo() call</span></div><div class="line">            <span class="keyword">if</span> (seekToPosition != <span class="number">0</span>) &#123;</div><div class="line">                seekTo(seekToPosition);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mVideoWidth != <span class="number">0</span> &amp;&amp; mVideoHeight != <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">//Log.i("@@@@", "video size: " + mVideoWidth +"/"+ mVideoHeight);</span></div><div class="line">                getHolder().setFixedSize(mVideoWidth, mVideoHeight);</div><div class="line">                <span class="keyword">if</span> (mSurfaceWidth == mVideoWidth &amp;&amp; mSurfaceHeight == mVideoHeight) &#123;</div><div class="line">                    <span class="comment">// We didn't actually change the size (it was already at the size</span></div><div class="line">                    <span class="comment">// we need), so we won't get a "surface changed" callback, so</span></div><div class="line">                    <span class="comment">// start the video here instead of in the callback.</span></div><div class="line">                    <span class="keyword">if</span> (mTargetState == STATE_PLAYING) &#123;</div><div class="line">                        start();</div><div class="line">                        <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">                            mMediaController.show();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isPlaying() &amp;&amp;</div><div class="line">                               (seekToPosition != <span class="number">0</span> || getCurrentPosition() &gt; <span class="number">0</span>)) &#123;</div><div class="line">                       <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">                           <span class="comment">// Show the media controls when we're paused into a video and make 'em stick.</span></div><div class="line">                           mMediaController.show(<span class="number">0</span>);</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// We don't know the video size yet, but should start anyway.</span></div><div class="line">                <span class="comment">// The video size might be reported to us later.</span></div><div class="line">                <span class="keyword">if</span> (mTargetState == STATE_PLAYING) &#123;</div><div class="line">                    start();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MediaPlayer.OnCompletionListener mCompletionListener =</div><div class="line">        <span class="keyword">new</span> MediaPlayer.OnCompletionListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</div><div class="line">            mCurrentState = STATE_PLAYBACK_COMPLETED;</div><div class="line">            mTargetState = STATE_PLAYBACK_COMPLETED;</div><div class="line">            <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">                mMediaController.hide();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mOnCompletionListener != <span class="keyword">null</span>) &#123;</div><div class="line">                mOnCompletionListener.onCompletion(mMediaPlayer);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MediaPlayer.OnInfoListener mInfoListener =</div><div class="line">        <span class="keyword">new</span> MediaPlayer.OnInfoListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">boolean</span> <span class="title">onInfo</span><span class="params">(MediaPlayer mp, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mOnInfoListener != <span class="keyword">null</span>) &#123;</div><div class="line">                mOnInfoListener.onInfo(mp, arg1, arg2);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MediaPlayer.OnErrorListener mErrorListener =</div><div class="line">        <span class="keyword">new</span> MediaPlayer.OnErrorListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onError</span><span class="params">(MediaPlayer mp, <span class="keyword">int</span> framework_err, <span class="keyword">int</span> impl_err)</span> </span>&#123;</div><div class="line">            Log.d(TAG, <span class="string">"Error: "</span> + framework_err + <span class="string">","</span> + impl_err);</div><div class="line">            mCurrentState = STATE_ERROR;</div><div class="line">            mTargetState = STATE_ERROR;</div><div class="line">            <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">                mMediaController.hide();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/* If an error handler has been supplied, use it and finish. */</span></div><div class="line">            <span class="keyword">if</span> (mOnErrorListener != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (mOnErrorListener.onError(mMediaPlayer, framework_err, impl_err)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/* Otherwise, pop up an error dialog so the user knows that</span></div><div class="line">             * something bad has happened. Only try and pop up the dialog</div><div class="line">             * if we're attached to a window. When we're going away and no</div><div class="line">             * longer have a window, don't bother showing the user an error.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">                Resources r = mContext.getResources();</div><div class="line">                <span class="keyword">int</span> messageId;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (framework_err == MediaPlayer.MEDIA_ERROR_NOT_VALID_FOR_PROGRESSIVE_PLAYBACK) &#123;</div><div class="line">                    messageId = com.android.internal.R.string.VideoView_error_text_invalid_progressive_playback;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    messageId = com.android.internal.R.string.VideoView_error_text_unknown;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">new</span> AlertDialog.Builder(mContext)</div><div class="line">                        .setMessage(messageId)</div><div class="line">                        .setPositiveButton(com.android.internal.R.string.VideoView_error_button,</div><div class="line">                                <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> whichButton)</span> </span>&#123;</div><div class="line">                                        <span class="comment">/* If we get here, there is no onError listener, so</span></div><div class="line">                                         * at least inform them that the video is over.</div><div class="line">                                         */</div><div class="line">                                        <span class="keyword">if</span> (mOnCompletionListener != <span class="keyword">null</span>) &#123;</div><div class="line">                                            mOnCompletionListener.onCompletion(mMediaPlayer);</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;</div><div class="line">                                &#125;)</div><div class="line">                        .setCancelable(<span class="keyword">false</span>)</div><div class="line">                        .show();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MediaPlayer.OnBufferingUpdateListener mBufferingUpdateListener =</div><div class="line">        <span class="keyword">new</span> MediaPlayer.OnBufferingUpdateListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBufferingUpdate</span><span class="params">(MediaPlayer mp, <span class="keyword">int</span> percent)</span> </span>&#123;</div><div class="line">            mCurrentBufferPercentage = percent;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Register a callback to be invoked when the media file</div><div class="line">     * is loaded and ready to go.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> l The callback that will be run</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnPreparedListener</span><span class="params">(MediaPlayer.OnPreparedListener l)</span></span></div><div class="line">    &#123;</div><div class="line">        mOnPreparedListener = l;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Register a callback to be invoked when the end of a media file</div><div class="line">     * has been reached during playback.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> l The callback that will be run</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnCompletionListener</span><span class="params">(OnCompletionListener l)</span></span></div><div class="line">    &#123;</div><div class="line">        mOnCompletionListener = l;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Register a callback to be invoked when an error occurs</div><div class="line">     * during playback or setup.  If no listener is specified,</div><div class="line">     * or if the listener returned false, VideoView will inform</div><div class="line">     * the user of any errors.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> l The callback that will be run</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnErrorListener</span><span class="params">(OnErrorListener l)</span></span></div><div class="line">    &#123;</div><div class="line">        mOnErrorListener = l;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Register a callback to be invoked when an informational event</div><div class="line">     * occurs during playback or setup.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> l The callback that will be run</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnInfoListener</span><span class="params">(OnInfoListener l)</span> </span>&#123;</div><div class="line">        mOnInfoListener = l;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SurfaceHolder.Callback mSHCallback = <span class="keyword">new</span> SurfaceHolder.Callback()</div><div class="line">    &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="keyword">int</span> format,</span></span></div><div class="line">                                    <span class="keyword">int</span> w, <span class="keyword">int</span> h)</div><div class="line">        &#123;</div><div class="line">            mSurfaceWidth = w;</div><div class="line">            mSurfaceHeight = h;</div><div class="line">            <span class="keyword">boolean</span> isValidState =  (mTargetState == STATE_PLAYING);</div><div class="line">            <span class="keyword">boolean</span> hasValidSize = (mVideoWidth == w &amp;&amp; mVideoHeight == h);</div><div class="line">            <span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span> &amp;&amp; isValidState &amp;&amp; hasValidSize) &#123;</div><div class="line">                <span class="keyword">if</span> (mSeekWhenPrepared != <span class="number">0</span>) &#123;</div><div class="line">                    seekTo(mSeekWhenPrepared);</div><div class="line">                &#125;</div><div class="line">                start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span></span></div><div class="line">        &#123;</div><div class="line">            mSurfaceHolder = holder;</div><div class="line">            openVideo();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span></span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// after we return from this we can't use the surface any more</span></div><div class="line">            mSurfaceHolder = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (mMediaController != <span class="keyword">null</span>) mMediaController.hide();</div><div class="line">            release(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * release the media player in any state</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(<span class="keyword">boolean</span> cleartargetstate)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span>) &#123;</div><div class="line">            mMediaPlayer.reset();</div><div class="line">            mMediaPlayer.release();</div><div class="line">            mMediaPlayer = <span class="keyword">null</span>;</div><div class="line">            mPendingSubtitleTracks.clear();</div><div class="line">            mCurrentState = STATE_IDLE;</div><div class="line">            <span class="keyword">if</span> (cleartargetstate) &#123;</div><div class="line">                mTargetState  = STATE_IDLE;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState() &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">            toggleMediaControlsVisiblity();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTrackballEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState() &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">            toggleMediaControlsVisiblity();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">boolean</span> isKeyCodeSupported = keyCode != KeyEvent.KEYCODE_BACK &amp;&amp;</div><div class="line">                                     keyCode != KeyEvent.KEYCODE_VOLUME_UP &amp;&amp;</div><div class="line">                                     keyCode != KeyEvent.KEYCODE_VOLUME_DOWN &amp;&amp;</div><div class="line">                                     keyCode != KeyEvent.KEYCODE_VOLUME_MUTE &amp;&amp;</div><div class="line">                                     keyCode != KeyEvent.KEYCODE_MENU &amp;&amp;</div><div class="line">                                     keyCode != KeyEvent.KEYCODE_CALL &amp;&amp;</div><div class="line">                                     keyCode != KeyEvent.KEYCODE_ENDCALL;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState() &amp;&amp; isKeyCodeSupported &amp;&amp; mMediaController != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_HEADSETHOOK ||</div><div class="line">                    keyCode == KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE) &#123;</div><div class="line">                <span class="keyword">if</span> (mMediaPlayer.isPlaying()) &#123;</div><div class="line">                    pause();</div><div class="line">                    mMediaController.show();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    start();</div><div class="line">                    mMediaController.hide();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MEDIA_PLAY) &#123;</div><div class="line">                <span class="keyword">if</span> (!mMediaPlayer.isPlaying()) &#123;</div><div class="line">                    start();</div><div class="line">                    mMediaController.hide();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MEDIA_STOP</div><div class="line">                    || keyCode == KeyEvent.KEYCODE_MEDIA_PAUSE) &#123;</div><div class="line">                <span class="keyword">if</span> (mMediaPlayer.isPlaying()) &#123;</div><div class="line">                    pause();</div><div class="line">                    mMediaController.show();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                toggleMediaControlsVisiblity();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onKeyDown(keyCode, event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">toggleMediaControlsVisiblity</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaController.isShowing()) &#123;</div><div class="line">            mMediaController.hide();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mMediaController.show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</div><div class="line">            mMediaPlayer.start();</div><div class="line">            mCurrentState = STATE_PLAYING;</div><div class="line">        &#125;</div><div class="line">        mTargetState = STATE_PLAYING;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</div><div class="line">            <span class="keyword">if</span> (mMediaPlayer.isPlaying()) &#123;</div><div class="line">                mMediaPlayer.pause();</div><div class="line">                mCurrentState = STATE_PAUSED;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mTargetState = STATE_PAUSED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspend</span><span class="params">()</span> </span>&#123;</div><div class="line">        release(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</div><div class="line">        openVideo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDuration</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</div><div class="line">            <span class="keyword">return</span> mMediaPlayer.getDuration();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrentPosition</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</div><div class="line">            <span class="keyword">return</span> mMediaPlayer.getCurrentPosition();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">seekTo</span><span class="params">(<span class="keyword">int</span> msec)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</div><div class="line">            mMediaPlayer.seekTo(msec);</div><div class="line">            mSeekWhenPrepared = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mSeekWhenPrepared = msec;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPlaying</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> isInPlaybackState() &amp;&amp; mMediaPlayer.isPlaying();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBufferPercentage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMediaPlayer != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> mCurrentBufferPercentage;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInPlaybackState</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (mMediaPlayer != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                mCurrentState != STATE_ERROR &amp;&amp;</div><div class="line">                mCurrentState != STATE_IDLE &amp;&amp;</div><div class="line">                mCurrentState != STATE_PREPARING);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canPause</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mCanPause;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canSeekBackward</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mCanSeekBack;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canSeekForward</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mCanSeekForward;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAudioSessionId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAudioSession == <span class="number">0</span>) &#123;</div><div class="line">            MediaPlayer foo = <span class="keyword">new</span> MediaPlayer();</div><div class="line">            mAudioSession = foo.getAudioSessionId();</div><div class="line">            foo.release();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mAudioSession;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onAttachedToWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onAttachedToWindow();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mSubtitleWidget != <span class="keyword">null</span>) &#123;</div><div class="line">            mSubtitleWidget.onAttachedToWindow();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDetachedFromWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDetachedFromWindow();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mSubtitleWidget != <span class="keyword">null</span>) &#123;</div><div class="line">            mSubtitleWidget.onDetachedFromWindow();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mSubtitleWidget != <span class="keyword">null</span>) &#123;</div><div class="line">            measureAndLayoutSubtitleWidget();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.draw(canvas);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mSubtitleWidget != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> saveCount = canvas.save();</div><div class="line">            canvas.translate(getPaddingLeft(), getPaddingTop());</div><div class="line">            mSubtitleWidget.draw(canvas);</div><div class="line">            canvas.restoreToCount(saveCount);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Forces a measurement and layout pass for all overlaid views.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #setSubtitleWidget(RenderingWidget)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">measureAndLayoutSubtitleWidget</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> width = getWidth() - getPaddingLeft() - getPaddingRight();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - getPaddingTop() - getPaddingBottom();</div><div class="line"></div><div class="line">        mSubtitleWidget.setSize(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSubtitleWidget</span><span class="params">(RenderingWidget subtitleWidget)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mSubtitleWidget == subtitleWidget) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> attachedToWindow = isAttachedToWindow();</div><div class="line">        <span class="keyword">if</span> (mSubtitleWidget != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (attachedToWindow) &#123;</div><div class="line">                mSubtitleWidget.onDetachedFromWindow();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mSubtitleWidget.setOnChangedListener(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mSubtitleWidget = subtitleWidget;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (subtitleWidget != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mSubtitlesChangedListener == <span class="keyword">null</span>) &#123;</div><div class="line">                mSubtitlesChangedListener = <span class="keyword">new</span> RenderingWidget.OnChangedListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(RenderingWidget renderingWidget)</span> </span>&#123;</div><div class="line">                        invalidate();</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            setWillNotDraw(<span class="keyword">false</span>);</div><div class="line">            subtitleWidget.setOnChangedListener(mSubtitlesChangedListener);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (attachedToWindow) &#123;</div><div class="line">                subtitleWidget.onAttachedToWindow();</div><div class="line">                requestLayout();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            setWillNotDraw(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Looper <span class="title">getSubtitleLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Looper.getMainLooper();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="MediaPlayerControl"><a href="#MediaPlayerControl" class="headerlink" title="MediaPlayerControl"></a>MediaPlayerControl</h2><p> 通过该接口来打通MediaController以及VideoView</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MediaPlayerControl</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span>    <span class="title">start</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span>    <span class="title">pause</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">int</span>     <span class="title">getDuration</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">int</span>     <span class="title">getCurrentPosition</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span>    <span class="title">seekTo</span><span class="params">(<span class="keyword">int</span> pos)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isPlaying</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">int</span>     <span class="title">getBufferPercentage</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">canPause</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">canSeekBackward</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">canSeekForward</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the audio session id for the player used by this VideoView. This can be used to</div><div class="line">	 * apply audio effects to the audio track of a video.</div><div class="line">	 * <span class="doctag">@return</span> The audio session, or 0 if there was an error.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">int</span>     <span class="title">getAudioSessionId</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="MediaController"><a href="#MediaController" class="headerlink" title="MediaController"></a>MediaController</h2><ul>
<li><p>简介            </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* A view containing controls for a MediaPlayer. Typically contains the</div><div class="line">* buttons like "Play/Pause", "Rewind", "Fast Forward" and a progress</div><div class="line">* slider. It takes care of synchronizing the controls with the state</div><div class="line">* of the MediaPlayer.</div><div class="line">* &lt;p&gt;</div><div class="line">* The way to use this class is to instantiate it programatically.</div><div class="line">* The MediaController will create a default set of controls</div><div class="line">* and put them in a window floating above your application. Specifically,</div><div class="line">* the controls will float above the view specified with setAnchorView().</div><div class="line">* The window will disappear if left idle for three seconds and reappear</div><div class="line">* when the user touches the anchor view.</div><div class="line">* &lt;p&gt;</div><div class="line">* Functions like show() and hide() have no effect when MediaController</div><div class="line">* is created in an xml layout.</div><div class="line">* </div><div class="line">* MediaController will hide and</div><div class="line">* show the buttons according to these rules:</div><div class="line">* &lt;ul&gt;</div><div class="line">* &lt;li&gt; The "previous" and "next" buttons are hidden until setPrevNextListeners()</div><div class="line">*   has been called</div><div class="line">* &lt;li&gt; The "previous" and "next" buttons are visible but disabled if</div><div class="line">*   setPrevNextListeners() was called with null listeners</div><div class="line">* &lt;li&gt; The "rewind" and "fastforward" buttons are shown unless requested</div><div class="line">*   otherwise by using the MediaController(Context, boolean) constructor</div><div class="line">*   with the boolean set to false</div><div class="line">* &lt;/ul&gt;</div><div class="line">*/</div></pre></td></tr></table></figure>
</li>
<li><p>关系</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaController</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span></span></div></pre></td></tr></table></figure>
</li>
<li><p>成员</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 一些控制功能的接口</span></div><div class="line"><span class="keyword">private</span> MediaPlayerControl  mPlayer;</div><div class="line">   <span class="keyword">private</span> Context             mContext;</div><div class="line"><span class="comment">// VideoView中调用setAnchorView()设置进来的View，MediaController显示的时候会感觉该AnchorView的位置进行显示</span></div><div class="line">   <span class="keyword">private</span> View                mAnchor;</div><div class="line"><span class="comment">// MediaController最外层的根布局</span></div><div class="line">   <span class="keyword">private</span> View                mRoot;</div><div class="line"></div><div class="line"><span class="comment">// 通过Window的方式来显示MediaController，MediaController是一个填充屏幕的布局，但是背景是透明的</span></div><div class="line">   <span class="keyword">private</span> WindowManager       mWindowManager;</div><div class="line">   <span class="keyword">private</span> Window              mWindow;</div><div class="line">   <span class="keyword">private</span> View                mDecor;</div><div class="line"><span class="comment">// 理解为当前整个MediaController的布局</span></div><div class="line">   <span class="keyword">private</span> WindowManager.LayoutParams mDecorLayoutParams;</div><div class="line">   <span class="keyword">private</span> ProgressBar         mProgress;</div><div class="line">   <span class="keyword">private</span> TextView            mEndTime, mCurrentTime;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span>             mShowing;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span>             mDragging;</div><div class="line"><span class="comment">// 默认自动消失的时间</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    sDefaultTimeout = <span class="number">3000</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    FADE_OUT = <span class="number">1</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    SHOW_PROGRESS = <span class="number">2</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span>             mUseFastForward;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span>             mFromXml;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span>             mListenersSet;</div><div class="line">   <span class="keyword">private</span> View.OnClickListener mNextListener, mPrevListener;</div><div class="line">   StringBuilder               mFormatBuilder;</div><div class="line">   Formatter                   mFormatter;</div><div class="line">   <span class="keyword">private</span> ImageButton         mPauseButton;</div><div class="line">   <span class="keyword">private</span> ImageButton         mFfwdButton;</div><div class="line">   <span class="keyword">private</span> ImageButton         mRewButton;</div><div class="line">   <span class="keyword">private</span> ImageButton         mNextButton;</div><div class="line">   <span class="keyword">private</span> ImageButton         mPrevButton;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>构造方法  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MediaController</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>(context, attrs);</div><div class="line">       mRoot = <span class="keyword">this</span>;</div><div class="line">       mContext = context;</div><div class="line">       mUseFastForward = <span class="keyword">true</span>;</div><div class="line">       mFromXml = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mRoot != <span class="keyword">null</span>)</div><div class="line">           initControllerView(mRoot);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MediaController</span><span class="params">(Context context, <span class="keyword">boolean</span> useFastForward)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>(context);</div><div class="line">       mContext = context;</div><div class="line">       mUseFastForward = useFastForward;</div><div class="line">	<span class="comment">// 创建该MediaController的布局</span></div><div class="line">       initFloatingWindowLayout();</div><div class="line">       initFloatingWindow();</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MediaController</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(context, <span class="keyword">true</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>- initFloatingWindowLayout
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Allocate and initialize the static parts of mDecorLayoutParams. Must</span></div><div class="line"><span class="comment">// also call updateFloatingWindowLayout() to fill in the dynamic parts</span></div><div class="line"><span class="comment">// (y and width) before mDecorLayoutParams can be used.</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initFloatingWindowLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">	mDecorLayoutParams = <span class="keyword">new</span> WindowManager.LayoutParams();</div><div class="line">	WindowManager.LayoutParams p = mDecorLayoutParams;</div><div class="line">	p.gravity = Gravity.TOP | Gravity.LEFT;</div><div class="line">	p.height = LayoutParams.WRAP_CONTENT;</div><div class="line">	p.x = <span class="number">0</span>;</div><div class="line">	p.format = PixelFormat.TRANSLUCENT;</div><div class="line">	p.type = WindowManager.LayoutParams.TYPE_APPLICATION_PANEL;</div><div class="line">	p.flags |= WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</div><div class="line">			| WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL</div><div class="line">			| WindowManager.LayoutParams.FLAG_SPLIT_TOUCH;</div><div class="line">	p.token = <span class="keyword">null</span>;</div><div class="line">	p.windowAnimations = <span class="number">0</span>; <span class="comment">// android.R.style.DropDownAnimationDown;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>


- initFloatingWindow
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initFloatingWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Android内核剖析 中有介绍</span></div><div class="line">	mWindowManager = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">	mWindow = PolicyManager.makeNewWindow(mContext);</div><div class="line">	mWindow.setWindowManager(mWindowManager, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">	mWindow.requestFeature(Window.FEATURE_NO_TITLE);</div><div class="line">	<span class="comment">// 通过WindowManager去add该Decor以及remove来实现MediaController的显示与隐藏</span></div><div class="line">	mDecor = mWindow.getDecorView();</div><div class="line">	mDecor.setOnTouchListener(mTouchListener);</div><div class="line">	mWindow.setContentView(<span class="keyword">this</span>);</div><div class="line">	mWindow.setBackgroundDrawableResource(android.R.color.transparent);</div><div class="line">	</div><div class="line">	<span class="comment">// While the media controller is up, the volume control keys should</span></div><div class="line">	<span class="comment">// affect the media stream type</span></div><div class="line">	mWindow.setVolumeControlStream(AudioManager.STREAM_MUSIC);</div><div class="line"></div><div class="line">	setFocusable(<span class="keyword">true</span>);</div><div class="line">	setFocusableInTouchMode(<span class="keyword">true</span>);</div><div class="line">	setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">	requestFocus();</div><div class="line">&#125;</div></pre></td></tr></table></figure>


- mTouchListener        
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> OnTouchListener mTouchListener = <span class="keyword">new</span> OnTouchListener() &#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">			<span class="keyword">if</span> (mShowing) &#123;</div><div class="line">				hide();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

- setMediaPlayer
    VideoView调用setMediaController的时候会调用到该方法
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediaPlayer</span><span class="params">(MediaPlayerControl player)</span> </span>&#123;</div><div class="line">	mPlayer = player;</div><div class="line">	updatePausePlay();</div><div class="line">&#125;</div></pre></td></tr></table></figure>


- setAnchorView
    VideoView调用setMediaController的时候会调用到该方法
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Set the view that acts as the anchor for the control view.</div><div class="line"> * This can for example be a VideoView, or your Activity's main view.</div><div class="line"> * When VideoView calls this method, it will use the VideoView's parent</div><div class="line"> * as the anchor.</div><div class="line"> * <span class="doctag">@param</span> view The view to which to anchor the controller when it is visible.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnchorView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mAnchor != <span class="keyword">null</span>) &#123;</div><div class="line">		mAnchor.removeOnLayoutChangeListener(mLayoutChangeListener);</div><div class="line">	&#125;</div><div class="line">	mAnchor = view;</div><div class="line">	<span class="keyword">if</span> (mAnchor != <span class="keyword">null</span>) &#123;</div><div class="line">		mAnchor.addOnLayoutChangeListener(mLayoutChangeListener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	FrameLayout.LayoutParams frameParams = <span class="keyword">new</span> FrameLayout.LayoutParams(</div><div class="line">			ViewGroup.LayoutParams.MATCH_PARENT,</div><div class="line">			ViewGroup.LayoutParams.MATCH_PARENT</div><div class="line">	);</div><div class="line"></div><div class="line">	removeAllViews();</div><div class="line">	View v = makeControllerView();</div><div class="line">	addView(v, frameParams);</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - mLayoutChangeListener
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is called whenever mAnchor's layout bound changes</span></div><div class="line"><span class="keyword">private</span> OnLayoutChangeListener mLayoutChangeListener =</div><div class="line">		<span class="keyword">new</span> OnLayoutChangeListener() &#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChange</span><span class="params">(View v, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right,</span></span></div><div class="line">			<span class="keyword">int</span> bottom, <span class="keyword">int</span> oldLeft, <span class="keyword">int</span> oldTop, <span class="keyword">int</span> oldRight,</div><div class="line">			<span class="keyword">int</span> oldBottom) &#123;</div><div class="line">		<span class="comment">// 更新布局</span></div><div class="line">		updateFloatingWindowLayout();</div><div class="line">		<span class="keyword">if</span> (mShowing) &#123;</div><div class="line">			mWindowManager.updateViewLayout(mDecor, mDecorLayoutParams);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

        - updateFloatingWindowLayout
            <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Update the dynamic parts of mDecorLayoutParams</span></div><div class="line"><span class="comment">// Must be called with mAnchor != NULL.</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateFloatingWindowLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> [] anchorPos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">	mAnchor.getLocationOnScreen(anchorPos);</div><div class="line"></div><div class="line">	<span class="comment">// we need to know the size of the controller so we can properly position it</span></div><div class="line">	<span class="comment">// within its space</span></div><div class="line">	mDecor.measure(MeasureSpec.makeMeasureSpec(mAnchor.getWidth(), MeasureSpec.AT_MOST),</div><div class="line">			MeasureSpec.makeMeasureSpec(mAnchor.getHeight(), MeasureSpec.AT_MOST));</div><div class="line"></div><div class="line">	WindowManager.LayoutParams p = mDecorLayoutParams;</div><div class="line">	p.width = mAnchor.getWidth();</div><div class="line">	p.x = anchorPos[<span class="number">0</span>] + (mAnchor.getWidth() - p.width) / <span class="number">2</span>;</div><div class="line">	p.y = anchorPos[<span class="number">1</span>] + mAnchor.getHeight() - mDecor.getMeasuredHeight();</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - makeControllerView
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Create the view that holds the widgets that control playback.</div><div class="line"> * Derived classes can override this to create their own.</div><div class="line"> * <span class="doctag">@return</span> The controller view.</div><div class="line"> * <span class="doctag">@hide</span> This doesn't work as advertised</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">makeControllerView</span><span class="params">()</span> </span>&#123;</div><div class="line">	LayoutInflater inflate = (LayoutInflater) mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">	mRoot = inflate.inflate(com.android.internal.R.layout.media_controller, <span class="keyword">null</span>);</div><div class="line">	<span class="comment">// 对Controller中的一些按钮、功能进行事件设置</span></div><div class="line">	initControllerView(mRoot);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> mRoot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


- touch事件处理
    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	show(sDefaultTimeout);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

- 进度的处理
    - seekBar的处理
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// There are two scenarios that can trigger the seekbar listener to trigger:</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// The first is the user using the touchpad to adjust the posititon of the</span></div><div class="line"><span class="comment">// seekbar's thumb. In this case onStartTrackingTouch is called followed by</span></div><div class="line"><span class="comment">// a number of onProgressChanged notifications, concluded by onStopTrackingTouch.</span></div><div class="line"><span class="comment">// We're setting the field "mDragging" to true for the duration of the dragging</span></div><div class="line"><span class="comment">// session to avoid jumps in the position in case of ongoing playback.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// The second scenario involves the user operating the scroll ball, in this</span></div><div class="line"><span class="comment">// case there WON'T BE onStartTrackingTouch/onStopTrackingTouch notifications,</span></div><div class="line"><span class="comment">// we will simply apply the updated position without suspending regular updates.</span></div><div class="line"><span class="keyword">private</span> OnSeekBarChangeListener mSeekListener = <span class="keyword">new</span> OnSeekBarChangeListener() &#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartTrackingTouch</span><span class="params">(SeekBar bar)</span> </span>&#123;</div><div class="line">		show(<span class="number">3600000</span>);</div><div class="line"></div><div class="line">		mDragging = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">		<span class="comment">// By removing these pending progress messages we make sure</span></div><div class="line">		<span class="comment">// that a) we won't update the progress while the user adjusts</span></div><div class="line">		<span class="comment">// the seekbar and b) once the user is done dragging the thumb</span></div><div class="line">		<span class="comment">// we will post one of these messages to the queue again and</span></div><div class="line">		<span class="comment">// this ensures that there will be exactly one message queued up.</span></div><div class="line">		mHandler.removeMessages(SHOW_PROGRESS);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgressChanged</span><span class="params">(SeekBar bar, <span class="keyword">int</span> progress, <span class="keyword">boolean</span> fromuser)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!fromuser) &#123;</div><div class="line">			<span class="comment">// We're not interested in programmatically generated changes to</span></div><div class="line">			<span class="comment">// the progress bar's position.</span></div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">long</span> duration = mPlayer.getDuration();</div><div class="line">		<span class="keyword">long</span> newposition = (duration * progress) / <span class="number">1000L</span>;</div><div class="line">		mPlayer.seekTo( (<span class="keyword">int</span>) newposition);</div><div class="line">		<span class="keyword">if</span> (mCurrentTime != <span class="keyword">null</span>)</div><div class="line">			mCurrentTime.setText(stringForTime( (<span class="keyword">int</span>) newposition));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopTrackingTouch</span><span class="params">(SeekBar bar)</span> </span>&#123;</div><div class="line">		mDragging = <span class="keyword">false</span>;</div><div class="line">		setProgress();</div><div class="line">		updatePausePlay();</div><div class="line">		show(sDefaultTimeout);</div><div class="line"></div><div class="line">		<span class="comment">// Ensure that progress is properly updated in the future,</span></div><div class="line">		<span class="comment">// the call to show() does not guarantee this because it is a</span></div><div class="line">		<span class="comment">// no-op if we are already showing.</span></div><div class="line">		mHandler.sendEmptyMessage(SHOW_PROGRESS);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>


    - SetProgress
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setProgress</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mPlayer == <span class="keyword">null</span> || mDragging) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> position = mPlayer.getCurrentPosition();</div><div class="line">	<span class="keyword">int</span> duration = mPlayer.getDuration();</div><div class="line">	<span class="keyword">if</span> (mProgress != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// use long to avoid overflow</span></div><div class="line">			<span class="keyword">long</span> pos = <span class="number">1000L</span> * position / duration;</div><div class="line">			mProgress.setProgress( (<span class="keyword">int</span>) pos);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> percent = mPlayer.getBufferPercentage();</div><div class="line">		mProgress.setSecondaryProgress(percent * <span class="number">10</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mEndTime != <span class="keyword">null</span>)</div><div class="line">		mEndTime.setText(stringForTime(duration));</div><div class="line">	<span class="keyword">if</span> (mCurrentTime != <span class="keyword">null</span>)</div><div class="line">		mCurrentTime.setText(stringForTime(position));</div><div class="line"></div><div class="line">	<span class="keyword">return</span> position;</div><div class="line">&#125;</div></pre></td></tr></table></figure>


    - show
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Show the controller on screen. It will go away</div><div class="line">    * automatically after 'timeout' milliseconds of inactivity.</div><div class="line">    * <span class="doctag">@param</span> timeout The timeout in milliseconds. Use 0 to show</div><div class="line">    * the controller until hide() is called.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!mShowing &amp;&amp; mAnchor != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 先去设置一下进度</span></div><div class="line">           setProgress();</div><div class="line">           <span class="keyword">if</span> (mPauseButton != <span class="keyword">null</span>) &#123;</div><div class="line">               mPauseButton.requestFocus();</div><div class="line">           &#125;</div><div class="line">           disableUnsupportedButtons();</div><div class="line">           updateFloatingWindowLayout();</div><div class="line">           mWindowManager.addView(mDecor, mDecorLayoutParams);</div><div class="line">           mShowing = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       updatePausePlay();</div><div class="line">       </div><div class="line">       <span class="comment">// cause the progress bar to be updated even if mShowing</span></div><div class="line">       <span class="comment">// was already true.  This happens, for example, if we're</span></div><div class="line">       <span class="comment">// paused with the progress bar showing the user hits play.</span></div><div class="line">	<span class="comment">// 发送定期更新进度的消息</span></div><div class="line">       mHandler.sendEmptyMessage(SHOW_PROGRESS);</div><div class="line">        </div><div class="line">       Message msg = mHandler.obtainMessage(FADE_OUT);</div><div class="line">       <span class="keyword">if</span> (timeout != <span class="number">0</span>) &#123;</div><div class="line">           mHandler.removeMessages(FADE_OUT);</div><div class="line">           mHandler.sendMessageDelayed(msg, timeout);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>

    - hide
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the controller from the screen.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hide</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mAnchor == <span class="keyword">null</span>)</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">    </div><div class="line">	<span class="keyword">if</span> (mShowing) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// 移除定期更新消息</span></div><div class="line">			mHandler.removeMessages(SHOW_PROGRESS);</div><div class="line">			mWindowManager.removeView(mDecor);</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">			Log.w(<span class="string">"MediaController"</span>, <span class="string">"already removed"</span>);</div><div class="line">		&#125;</div><div class="line">		mShowing = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h1 id="上源码"><a href="#上源码" class="headerlink" title="上源码"></a>上源码</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Copyright (C) 2006 The Android Open Source Project</div><div class="line"> *</div><div class="line"> * Licensed under the Apache License, Version 2.0 (the "License");</div><div class="line"> * you may not use this file except in compliance with the License.</div><div class="line"> * You may obtain a copy of the License at</div><div class="line"> *</div><div class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</div><div class="line"> *</div><div class="line"> * Unless required by applicable law or agreed to in writing, software</div><div class="line"> * distributed under the License is distributed on an "AS IS" BASIS,</div><div class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line"> * See the License for the specific language governing permissions and</div><div class="line"> * limitations under the License.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">package</span> android.widget;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.graphics.PixelFormat;</div><div class="line"><span class="keyword">import</span> android.media.AudioManager;</div><div class="line"><span class="keyword">import</span> android.os.Handler;</div><div class="line"><span class="keyword">import</span> android.os.Message;</div><div class="line"><span class="keyword">import</span> android.util.AttributeSet;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.Gravity;</div><div class="line"><span class="keyword">import</span> android.view.KeyEvent;</div><div class="line"><span class="keyword">import</span> android.view.LayoutInflater;</div><div class="line"><span class="keyword">import</span> android.view.MotionEvent;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.view.ViewGroup;</div><div class="line"><span class="keyword">import</span> android.view.Window;</div><div class="line"><span class="keyword">import</span> android.view.WindowManager;</div><div class="line"><span class="keyword">import</span> android.view.accessibility.AccessibilityEvent;</div><div class="line"><span class="keyword">import</span> android.view.accessibility.AccessibilityNodeInfo;</div><div class="line"><span class="keyword">import</span> android.widget.SeekBar.OnSeekBarChangeListener;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.android.internal.policy.PolicyManager;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Formatter;</div><div class="line"><span class="keyword">import</span> java.util.Locale;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A view containing controls for a MediaPlayer. Typically contains the</div><div class="line"> * buttons like "Play/Pause", "Rewind", "Fast Forward" and a progress</div><div class="line"> * slider. It takes care of synchronizing the controls with the state</div><div class="line"> * of the MediaPlayer.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The way to use this class is to instantiate it programatically.</div><div class="line"> * The MediaController will create a default set of controls</div><div class="line"> * and put them in a window floating above your application. Specifically,</div><div class="line"> * the controls will float above the view specified with setAnchorView().</div><div class="line"> * The window will disappear if left idle for three seconds and reappear</div><div class="line"> * when the user touches the anchor view.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Functions like show() and hide() have no effect when MediaController</div><div class="line"> * is created in an xml layout.</div><div class="line"> * </div><div class="line"> * MediaController will hide and</div><div class="line"> * show the buttons according to these rules:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> * &lt;li&gt; The "previous" and "next" buttons are hidden until setPrevNextListeners()</div><div class="line"> *   has been called</div><div class="line"> * &lt;li&gt; The "previous" and "next" buttons are visible but disabled if</div><div class="line"> *   setPrevNextListeners() was called with null listeners</div><div class="line"> * &lt;li&gt; The "rewind" and "fastforward" buttons are shown unless requested</div><div class="line"> *   otherwise by using the MediaController(Context, boolean) constructor</div><div class="line"> *   with the boolean set to false</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaController</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MediaPlayerControl  mPlayer;</div><div class="line">    <span class="keyword">private</span> Context             mContext;</div><div class="line">    <span class="keyword">private</span> View                mAnchor;</div><div class="line">    <span class="keyword">private</span> View                mRoot;</div><div class="line">    <span class="keyword">private</span> WindowManager       mWindowManager;</div><div class="line">    <span class="keyword">private</span> Window              mWindow;</div><div class="line">    <span class="keyword">private</span> View                mDecor;</div><div class="line">    <span class="keyword">private</span> WindowManager.LayoutParams mDecorLayoutParams;</div><div class="line">    <span class="keyword">private</span> ProgressBar         mProgress;</div><div class="line">    <span class="keyword">private</span> TextView            mEndTime, mCurrentTime;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>             mShowing;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>             mDragging;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    sDefaultTimeout = <span class="number">3000</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    FADE_OUT = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    SHOW_PROGRESS = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>             mUseFastForward;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>             mFromXml;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>             mListenersSet;</div><div class="line">    <span class="keyword">private</span> View.OnClickListener mNextListener, mPrevListener;</div><div class="line">    StringBuilder               mFormatBuilder;</div><div class="line">    Formatter                   mFormatter;</div><div class="line">    <span class="keyword">private</span> ImageButton         mPauseButton;</div><div class="line">    <span class="keyword">private</span> ImageButton         mFfwdButton;</div><div class="line">    <span class="keyword">private</span> ImageButton         mRewButton;</div><div class="line">    <span class="keyword">private</span> ImageButton         mNextButton;</div><div class="line">    <span class="keyword">private</span> ImageButton         mPrevButton;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MediaController</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        mRoot = <span class="keyword">this</span>;</div><div class="line">        mContext = context;</div><div class="line">        mUseFastForward = <span class="keyword">true</span>;</div><div class="line">        mFromXml = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mRoot != <span class="keyword">null</span>)</div><div class="line">            initControllerView(mRoot);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MediaController</span><span class="params">(Context context, <span class="keyword">boolean</span> useFastForward)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        mContext = context;</div><div class="line">        mUseFastForward = useFastForward;</div><div class="line">        initFloatingWindowLayout();</div><div class="line">        initFloatingWindow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MediaController</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initFloatingWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">        mWindowManager = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">        mWindow = PolicyManager.makeNewWindow(mContext);</div><div class="line">        mWindow.setWindowManager(mWindowManager, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        mWindow.requestFeature(Window.FEATURE_NO_TITLE);</div><div class="line">        mDecor = mWindow.getDecorView();</div><div class="line">        mDecor.setOnTouchListener(mTouchListener);</div><div class="line">        mWindow.setContentView(<span class="keyword">this</span>);</div><div class="line">        mWindow.setBackgroundDrawableResource(android.R.color.transparent);</div><div class="line">        </div><div class="line">        <span class="comment">// While the media controller is up, the volume control keys should</span></div><div class="line">        <span class="comment">// affect the media stream type</span></div><div class="line">        mWindow.setVolumeControlStream(AudioManager.STREAM_MUSIC);</div><div class="line"></div><div class="line">        setFocusable(<span class="keyword">true</span>);</div><div class="line">        setFocusableInTouchMode(<span class="keyword">true</span>);</div><div class="line">        setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">        requestFocus();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Allocate and initialize the static parts of mDecorLayoutParams. Must</span></div><div class="line">    <span class="comment">// also call updateFloatingWindowLayout() to fill in the dynamic parts</span></div><div class="line">    <span class="comment">// (y and width) before mDecorLayoutParams can be used.</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initFloatingWindowLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDecorLayoutParams = <span class="keyword">new</span> WindowManager.LayoutParams();</div><div class="line">        WindowManager.LayoutParams p = mDecorLayoutParams;</div><div class="line">        p.gravity = Gravity.TOP | Gravity.LEFT;</div><div class="line">        p.height = LayoutParams.WRAP_CONTENT;</div><div class="line">        p.x = <span class="number">0</span>;</div><div class="line">        p.format = PixelFormat.TRANSLUCENT;</div><div class="line">        p.type = WindowManager.LayoutParams.TYPE_APPLICATION_PANEL;</div><div class="line">        p.flags |= WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM</div><div class="line">                | WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL</div><div class="line">                | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH;</div><div class="line">        p.token = <span class="keyword">null</span>;</div><div class="line">        p.windowAnimations = <span class="number">0</span>; <span class="comment">// android.R.style.DropDownAnimationDown;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Update the dynamic parts of mDecorLayoutParams</span></div><div class="line">    <span class="comment">// Must be called with mAnchor != NULL.</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateFloatingWindowLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> [] anchorPos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">        mAnchor.getLocationOnScreen(anchorPos);</div><div class="line"></div><div class="line">        <span class="comment">// we need to know the size of the controller so we can properly position it</span></div><div class="line">        <span class="comment">// within its space</span></div><div class="line">        mDecor.measure(MeasureSpec.makeMeasureSpec(mAnchor.getWidth(), MeasureSpec.AT_MOST),</div><div class="line">                MeasureSpec.makeMeasureSpec(mAnchor.getHeight(), MeasureSpec.AT_MOST));</div><div class="line"></div><div class="line">        WindowManager.LayoutParams p = mDecorLayoutParams;</div><div class="line">        p.width = mAnchor.getWidth();</div><div class="line">        p.x = anchorPos[<span class="number">0</span>] + (mAnchor.getWidth() - p.width) / <span class="number">2</span>;</div><div class="line">        p.y = anchorPos[<span class="number">1</span>] + mAnchor.getHeight() - mDecor.getMeasuredHeight();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// This is called whenever mAnchor's layout bound changes</span></div><div class="line">    <span class="keyword">private</span> OnLayoutChangeListener mLayoutChangeListener =</div><div class="line">            <span class="keyword">new</span> OnLayoutChangeListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChange</span><span class="params">(View v, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right,</span></span></div><div class="line">                <span class="keyword">int</span> bottom, <span class="keyword">int</span> oldLeft, <span class="keyword">int</span> oldTop, <span class="keyword">int</span> oldRight,</div><div class="line">                <span class="keyword">int</span> oldBottom) &#123;</div><div class="line">            updateFloatingWindowLayout();</div><div class="line">            <span class="keyword">if</span> (mShowing) &#123;</div><div class="line">                mWindowManager.updateViewLayout(mDecor, mDecorLayoutParams);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> OnTouchListener mTouchListener = <span class="keyword">new</span> OnTouchListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">                <span class="keyword">if</span> (mShowing) &#123;</div><div class="line">                    hide();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediaPlayer</span><span class="params">(MediaPlayerControl player)</span> </span>&#123;</div><div class="line">        mPlayer = player;</div><div class="line">        updatePausePlay();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Set the view that acts as the anchor for the control view.</div><div class="line">     * This can for example be a VideoView, or your Activity's main view.</div><div class="line">     * When VideoView calls this method, it will use the VideoView's parent</div><div class="line">     * as the anchor.</div><div class="line">     * <span class="doctag">@param</span> view The view to which to anchor the controller when it is visible.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnchorView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAnchor != <span class="keyword">null</span>) &#123;</div><div class="line">            mAnchor.removeOnLayoutChangeListener(mLayoutChangeListener);</div><div class="line">        &#125;</div><div class="line">        mAnchor = view;</div><div class="line">        <span class="keyword">if</span> (mAnchor != <span class="keyword">null</span>) &#123;</div><div class="line">            mAnchor.addOnLayoutChangeListener(mLayoutChangeListener);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        FrameLayout.LayoutParams frameParams = <span class="keyword">new</span> FrameLayout.LayoutParams(</div><div class="line">                ViewGroup.LayoutParams.MATCH_PARENT,</div><div class="line">                ViewGroup.LayoutParams.MATCH_PARENT</div><div class="line">        );</div><div class="line"></div><div class="line">        removeAllViews();</div><div class="line">        View v = makeControllerView();</div><div class="line">        addView(v, frameParams);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Create the view that holds the widgets that control playback.</div><div class="line">     * Derived classes can override this to create their own.</div><div class="line">     * <span class="doctag">@return</span> The controller view.</div><div class="line">     * <span class="doctag">@hide</span> This doesn't work as advertised</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">makeControllerView</span><span class="params">()</span> </span>&#123;</div><div class="line">        LayoutInflater inflate = (LayoutInflater) mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">        mRoot = inflate.inflate(com.android.internal.R.layout.media_controller, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        initControllerView(mRoot);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> mRoot;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initControllerView</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        mPauseButton = (ImageButton) v.findViewById(com.android.internal.R.id.pause);</div><div class="line">        <span class="keyword">if</span> (mPauseButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mPauseButton.requestFocus();</div><div class="line">            mPauseButton.setOnClickListener(mPauseListener);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mFfwdButton = (ImageButton) v.findViewById(com.android.internal.R.id.ffwd);</div><div class="line">        <span class="keyword">if</span> (mFfwdButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mFfwdButton.setOnClickListener(mFfwdListener);</div><div class="line">            <span class="keyword">if</span> (!mFromXml) &#123;</div><div class="line">                mFfwdButton.setVisibility(mUseFastForward ? View.VISIBLE : View.GONE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mRewButton = (ImageButton) v.findViewById(com.android.internal.R.id.rew);</div><div class="line">        <span class="keyword">if</span> (mRewButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mRewButton.setOnClickListener(mRewListener);</div><div class="line">            <span class="keyword">if</span> (!mFromXml) &#123;</div><div class="line">                mRewButton.setVisibility(mUseFastForward ? View.VISIBLE : View.GONE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// By default these are hidden. They will be enabled when setPrevNextListeners() is called </span></div><div class="line">        mNextButton = (ImageButton) v.findViewById(com.android.internal.R.id.next);</div><div class="line">        <span class="keyword">if</span> (mNextButton != <span class="keyword">null</span> &amp;&amp; !mFromXml &amp;&amp; !mListenersSet) &#123;</div><div class="line">            mNextButton.setVisibility(View.GONE);</div><div class="line">        &#125;</div><div class="line">        mPrevButton = (ImageButton) v.findViewById(com.android.internal.R.id.prev);</div><div class="line">        <span class="keyword">if</span> (mPrevButton != <span class="keyword">null</span> &amp;&amp; !mFromXml &amp;&amp; !mListenersSet) &#123;</div><div class="line">            mPrevButton.setVisibility(View.GONE);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mProgress = (ProgressBar) v.findViewById(com.android.internal.R.id.mediacontroller_progress);</div><div class="line">        <span class="keyword">if</span> (mProgress != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mProgress <span class="keyword">instanceof</span> SeekBar) &#123;</div><div class="line">                SeekBar seeker = (SeekBar) mProgress;</div><div class="line">                seeker.setOnSeekBarChangeListener(mSeekListener);</div><div class="line">            &#125;</div><div class="line">            mProgress.setMax(<span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mEndTime = (TextView) v.findViewById(com.android.internal.R.id.time);</div><div class="line">        mCurrentTime = (TextView) v.findViewById(com.android.internal.R.id.time_current);</div><div class="line">        mFormatBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        mFormatter = <span class="keyword">new</span> Formatter(mFormatBuilder, Locale.getDefault());</div><div class="line"></div><div class="line">        installPrevNextListeners();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show the controller on screen. It will go away</div><div class="line">     * automatically after 3 seconds of inactivity.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</div><div class="line">        show(sDefaultTimeout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Disable pause or seek buttons if the stream cannot be paused or seeked.</div><div class="line">     * This requires the control interface to be a MediaPlayerControlExt</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">disableUnsupportedButtons</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mPauseButton != <span class="keyword">null</span> &amp;&amp; !mPlayer.canPause()) &#123;</div><div class="line">                mPauseButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mRewButton != <span class="keyword">null</span> &amp;&amp; !mPlayer.canSeekBackward()) &#123;</div><div class="line">                mRewButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mFfwdButton != <span class="keyword">null</span> &amp;&amp; !mPlayer.canSeekForward()) &#123;</div><div class="line">                mFfwdButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IncompatibleClassChangeError ex) &#123;</div><div class="line">            <span class="comment">// We were given an old version of the interface, that doesn't have</span></div><div class="line">            <span class="comment">// the canPause/canSeekXYZ methods. This is OK, it just means we</span></div><div class="line">            <span class="comment">// assume the media can be paused and seeked, and so we don't disable</span></div><div class="line">            <span class="comment">// the buttons.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show the controller on screen. It will go away</div><div class="line">     * automatically after 'timeout' milliseconds of inactivity.</div><div class="line">     * <span class="doctag">@param</span> timeout The timeout in milliseconds. Use 0 to show</div><div class="line">     * the controller until hide() is called.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mShowing &amp;&amp; mAnchor != <span class="keyword">null</span>) &#123;</div><div class="line">            setProgress();</div><div class="line">            <span class="keyword">if</span> (mPauseButton != <span class="keyword">null</span>) &#123;</div><div class="line">                mPauseButton.requestFocus();</div><div class="line">            &#125;</div><div class="line">            disableUnsupportedButtons();</div><div class="line">            updateFloatingWindowLayout();</div><div class="line">            mWindowManager.addView(mDecor, mDecorLayoutParams);</div><div class="line">            mShowing = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        updatePausePlay();</div><div class="line">        </div><div class="line">        <span class="comment">// cause the progress bar to be updated even if mShowing</span></div><div class="line">        <span class="comment">// was already true.  This happens, for example, if we're</span></div><div class="line">        <span class="comment">// paused with the progress bar showing the user hits play.</span></div><div class="line">        mHandler.sendEmptyMessage(SHOW_PROGRESS);</div><div class="line"></div><div class="line">        Message msg = mHandler.obtainMessage(FADE_OUT);</div><div class="line">        <span class="keyword">if</span> (timeout != <span class="number">0</span>) &#123;</div><div class="line">            mHandler.removeMessages(FADE_OUT);</div><div class="line">            mHandler.sendMessageDelayed(msg, timeout);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShowing</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mShowing;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove the controller from the screen.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hide</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAnchor == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mShowing) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mHandler.removeMessages(SHOW_PROGRESS);</div><div class="line">                mWindowManager.removeView(mDecor);</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">                Log.w(<span class="string">"MediaController"</span>, <span class="string">"already removed"</span>);</div><div class="line">            &#125;</div><div class="line">            mShowing = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">int</span> pos;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> FADE_OUT:</div><div class="line">                    hide();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> SHOW_PROGRESS:</div><div class="line">                    pos = setProgress();</div><div class="line">                    <span class="keyword">if</span> (!mDragging &amp;&amp; mShowing &amp;&amp; mPlayer.isPlaying()) &#123;</div><div class="line">                        msg = obtainMessage(SHOW_PROGRESS);</div><div class="line">                        sendMessageDelayed(msg, <span class="number">1000</span> - (pos % <span class="number">1000</span>));</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">stringForTime</span><span class="params">(<span class="keyword">int</span> timeMs)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> totalSeconds = timeMs / <span class="number">1000</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> seconds = totalSeconds % <span class="number">60</span>;</div><div class="line">        <span class="keyword">int</span> minutes = (totalSeconds / <span class="number">60</span>) % <span class="number">60</span>;</div><div class="line">        <span class="keyword">int</span> hours   = totalSeconds / <span class="number">3600</span>;</div><div class="line"></div><div class="line">        mFormatBuilder.setLength(<span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (hours &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> mFormatter.format(<span class="string">"%d:%02d:%02d"</span>, hours, minutes, seconds).toString();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> mFormatter.format(<span class="string">"%02d:%02d"</span>, minutes, seconds).toString();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setProgress</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPlayer == <span class="keyword">null</span> || mDragging) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> position = mPlayer.getCurrentPosition();</div><div class="line">        <span class="keyword">int</span> duration = mPlayer.getDuration();</div><div class="line">        <span class="keyword">if</span> (mProgress != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// use long to avoid overflow</span></div><div class="line">                <span class="keyword">long</span> pos = <span class="number">1000L</span> * position / duration;</div><div class="line">                mProgress.setProgress( (<span class="keyword">int</span>) pos);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> percent = mPlayer.getBufferPercentage();</div><div class="line">            mProgress.setSecondaryProgress(percent * <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mEndTime != <span class="keyword">null</span>)</div><div class="line">            mEndTime.setText(stringForTime(duration));</div><div class="line">        <span class="keyword">if</span> (mCurrentTime != <span class="keyword">null</span>)</div><div class="line">            mCurrentTime.setText(stringForTime(position));</div><div class="line"></div><div class="line">        <span class="keyword">return</span> position;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        show(sDefaultTimeout);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTrackballEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        show(sDefaultTimeout);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> keyCode = event.getKeyCode();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> uniqueDown = event.getRepeatCount() == <span class="number">0</span></div><div class="line">                &amp;&amp; event.getAction() == KeyEvent.ACTION_DOWN;</div><div class="line">        <span class="keyword">if</span> (keyCode ==  KeyEvent.KEYCODE_HEADSETHOOK</div><div class="line">                || keyCode == KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE</div><div class="line">                || keyCode == KeyEvent.KEYCODE_SPACE) &#123;</div><div class="line">            <span class="keyword">if</span> (uniqueDown) &#123;</div><div class="line">                doPauseResume();</div><div class="line">                show(sDefaultTimeout);</div><div class="line">                <span class="keyword">if</span> (mPauseButton != <span class="keyword">null</span>) &#123;</div><div class="line">                    mPauseButton.requestFocus();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MEDIA_PLAY) &#123;</div><div class="line">            <span class="keyword">if</span> (uniqueDown &amp;&amp; !mPlayer.isPlaying()) &#123;</div><div class="line">                mPlayer.start();</div><div class="line">                updatePausePlay();</div><div class="line">                show(sDefaultTimeout);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MEDIA_STOP</div><div class="line">                || keyCode == KeyEvent.KEYCODE_MEDIA_PAUSE) &#123;</div><div class="line">            <span class="keyword">if</span> (uniqueDown &amp;&amp; mPlayer.isPlaying()) &#123;</div><div class="line">                mPlayer.pause();</div><div class="line">                updatePausePlay();</div><div class="line">                show(sDefaultTimeout);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN</div><div class="line">                || keyCode == KeyEvent.KEYCODE_VOLUME_UP</div><div class="line">                || keyCode == KeyEvent.KEYCODE_VOLUME_MUTE</div><div class="line">                || keyCode == KeyEvent.KEYCODE_CAMERA) &#123;</div><div class="line">            <span class="comment">// don't show the controls for volume adjustment</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.dispatchKeyEvent(event);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK || keyCode == KeyEvent.KEYCODE_MENU) &#123;</div><div class="line">            <span class="keyword">if</span> (uniqueDown) &#123;</div><div class="line">                hide();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        show(sDefaultTimeout);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchKeyEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mPauseListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            doPauseResume();</div><div class="line">            show(sDefaultTimeout);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePausePlay</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mRoot == <span class="keyword">null</span> || mPauseButton == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mPlayer.isPlaying()) &#123;</div><div class="line">            mPauseButton.setImageResource(com.android.internal.R.drawable.ic_media_pause);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mPauseButton.setImageResource(com.android.internal.R.drawable.ic_media_play);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doPauseResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPlayer.isPlaying()) &#123;</div><div class="line">            mPlayer.pause();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mPlayer.start();</div><div class="line">        &#125;</div><div class="line">        updatePausePlay();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// There are two scenarios that can trigger the seekbar listener to trigger:</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The first is the user using the touchpad to adjust the posititon of the</span></div><div class="line">    <span class="comment">// seekbar's thumb. In this case onStartTrackingTouch is called followed by</span></div><div class="line">    <span class="comment">// a number of onProgressChanged notifications, concluded by onStopTrackingTouch.</span></div><div class="line">    <span class="comment">// We're setting the field "mDragging" to true for the duration of the dragging</span></div><div class="line">    <span class="comment">// session to avoid jumps in the position in case of ongoing playback.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The second scenario involves the user operating the scroll ball, in this</span></div><div class="line">    <span class="comment">// case there WON'T BE onStartTrackingTouch/onStopTrackingTouch notifications,</span></div><div class="line">    <span class="comment">// we will simply apply the updated position without suspending regular updates.</span></div><div class="line">    <span class="keyword">private</span> OnSeekBarChangeListener mSeekListener = <span class="keyword">new</span> OnSeekBarChangeListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartTrackingTouch</span><span class="params">(SeekBar bar)</span> </span>&#123;</div><div class="line">            show(<span class="number">3600000</span>);</div><div class="line"></div><div class="line">            mDragging = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">            <span class="comment">// By removing these pending progress messages we make sure</span></div><div class="line">            <span class="comment">// that a) we won't update the progress while the user adjusts</span></div><div class="line">            <span class="comment">// the seekbar and b) once the user is done dragging the thumb</span></div><div class="line">            <span class="comment">// we will post one of these messages to the queue again and</span></div><div class="line">            <span class="comment">// this ensures that there will be exactly one message queued up.</span></div><div class="line">            mHandler.removeMessages(SHOW_PROGRESS);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgressChanged</span><span class="params">(SeekBar bar, <span class="keyword">int</span> progress, <span class="keyword">boolean</span> fromuser)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!fromuser) &#123;</div><div class="line">                <span class="comment">// We're not interested in programmatically generated changes to</span></div><div class="line">                <span class="comment">// the progress bar's position.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">long</span> duration = mPlayer.getDuration();</div><div class="line">            <span class="keyword">long</span> newposition = (duration * progress) / <span class="number">1000L</span>;</div><div class="line">            mPlayer.seekTo( (<span class="keyword">int</span>) newposition);</div><div class="line">            <span class="keyword">if</span> (mCurrentTime != <span class="keyword">null</span>)</div><div class="line">                mCurrentTime.setText(stringForTime( (<span class="keyword">int</span>) newposition));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopTrackingTouch</span><span class="params">(SeekBar bar)</span> </span>&#123;</div><div class="line">            mDragging = <span class="keyword">false</span>;</div><div class="line">            setProgress();</div><div class="line">            updatePausePlay();</div><div class="line">            show(sDefaultTimeout);</div><div class="line"></div><div class="line">            <span class="comment">// Ensure that progress is properly updated in the future,</span></div><div class="line">            <span class="comment">// the call to show() does not guarantee this because it is a</span></div><div class="line">            <span class="comment">// no-op if we are already showing.</span></div><div class="line">            mHandler.sendEmptyMessage(SHOW_PROGRESS);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnabled</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPauseButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mPauseButton.setEnabled(enabled);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mFfwdButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mFfwdButton.setEnabled(enabled);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mRewButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mRewButton.setEnabled(enabled);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mNextButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mNextButton.setEnabled(enabled &amp;&amp; mNextListener != <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mPrevButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mPrevButton.setEnabled(enabled &amp;&amp; mPrevListener != <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mProgress != <span class="keyword">null</span>) &#123;</div><div class="line">            mProgress.setEnabled(enabled);</div><div class="line">        &#125;</div><div class="line">        disableUnsupportedButtons();</div><div class="line">        <span class="keyword">super</span>.setEnabled(enabled);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInitializeAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onInitializeAccessibilityEvent(event);</div><div class="line">        event.setClassName(MediaController.class.getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInitializeAccessibilityNodeInfo</span><span class="params">(AccessibilityNodeInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onInitializeAccessibilityNodeInfo(info);</div><div class="line">        info.setClassName(MediaController.class.getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mRewListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            <span class="keyword">int</span> pos = mPlayer.getCurrentPosition();</div><div class="line">            pos -= <span class="number">5000</span>; <span class="comment">// milliseconds</span></div><div class="line">            mPlayer.seekTo(pos);</div><div class="line">            setProgress();</div><div class="line"></div><div class="line">            show(sDefaultTimeout);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mFfwdListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            <span class="keyword">int</span> pos = mPlayer.getCurrentPosition();</div><div class="line">            pos += <span class="number">15000</span>; <span class="comment">// milliseconds</span></div><div class="line">            mPlayer.seekTo(pos);</div><div class="line">            setProgress();</div><div class="line"></div><div class="line">            show(sDefaultTimeout);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPrevNextListeners</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mNextButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mNextButton.setOnClickListener(mNextListener);</div><div class="line">            mNextButton.setEnabled(mNextListener != <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mPrevButton != <span class="keyword">null</span>) &#123;</div><div class="line">            mPrevButton.setOnClickListener(mPrevListener);</div><div class="line">            mPrevButton.setEnabled(mPrevListener != <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrevNextListeners</span><span class="params">(View.OnClickListener next, View.OnClickListener prev)</span> </span>&#123;</div><div class="line">        mNextListener = next;</div><div class="line">        mPrevListener = prev;</div><div class="line">        mListenersSet = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mRoot != <span class="keyword">null</span>) &#123;</div><div class="line">            installPrevNextListeners();</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (mNextButton != <span class="keyword">null</span> &amp;&amp; !mFromXml) &#123;</div><div class="line">                mNextButton.setVisibility(View.VISIBLE);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mPrevButton != <span class="keyword">null</span> &amp;&amp; !mFromXml) &#123;</div><div class="line">                mPrevButton.setVisibility(View.VISIBLE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MediaPlayerControl</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span>    <span class="title">start</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span>    <span class="title">pause</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">int</span>     <span class="title">getDuration</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">int</span>     <span class="title">getCurrentPosition</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span>    <span class="title">seekTo</span><span class="params">(<span class="keyword">int</span> pos)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isPlaying</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">int</span>     <span class="title">getBufferPercentage</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">canPause</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">canSeekBackward</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">canSeekForward</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Get the audio session id for the player used by this VideoView. This can be used to</div><div class="line">         * apply audio effects to the audio track of a video.</div><div class="line">         * <span class="doctag">@return</span> The audio session, or 0 if there was an error.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">int</span>     <span class="title">getAudioSessionId</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/VideoView源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RecyclerView专题" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RecyclerView专题/">RecyclerView专题</a>
    </h1>
  

        
        <a href="/2015/01/01/RecyclerView专题/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RecyclerView专题"><a href="#RecyclerView专题" class="headerlink" title="RecyclerView专题"></a>RecyclerView专题</h1><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>RecyclerView</code>是<code>Android 5.0</code>提供的新控件，已经用了很长时间了，但是一直没有时间去仔细的梳理一下。现在项目不太紧，决定来整理下。</p>
<p>官方文档中是这样介绍的:<br><code>A flexible view for providing a limited window into a large data set.</code></p>
<p>RecyclerView比listview更先进更灵活，对于很多的视图它就是一个容器，可以有效的重用和滚动。当数据动态变化的时候请使用它。</p>
<p>#####专业术语:</p>
<ul>
<li><code>Adapter</code>: <code>A subclass of RecyclerView.Adapter responsible for providing views that represent items in a data set.</code></li>
<li><code>Position</code>: <code>The position of a data item within an Adapter.</code></li>
<li><code>Index</code>: <code>The index of an attached child view as used in a call to getChildAt(int). Contrast with Position.</code></li>
<li><code>Binding</code>: <code>The process of preparing a child view to display data corresponding to a position within the adapter.</code></li>
<li><code>Recycle (view)</code>: <code>A view previously used to display data for a specific adapter position may be placed in a cache for later reuse to display the same type of data again later. This can drastically improve performance by skipping initial layout inflation or construction.</code></li>
<li><code>Scrap (view)</code>: <code>A child view that has entered into a temporarily detached state during layout. Scrap views may be reused without becoming fully detached from the parent RecyclerView, either unmodified if no rebinding is required or modified by the adapter if the view was considered dirty.</code></li>
<li><code>Dirty (view)</code>: <code>A child view that must be rebound by the adapter before being displayed.</code></li>
</ul>
<p>#####<code>RecyclerView</code>中的位置:      </p>
<p><code>RecyclerView</code>在<code>RecyclerView.Adapter</code>和<code>RecyclerView.LayoutManager</code>中引进了一个抽象的额外中间层来保证在布局计算的过程中能批量的监听到数据变化。这样介绍了<code>LayoutManager</code>追踪<code>adapter</code>数据变化来计算动画的时间。因为所有的<code>View</code>绑定都是在同一时间执行，所以这样也提高了性能和避免了一些非必要的绑定。<br>因为这个原因，在<code>RecylcerView</code>中有两种<code>position</code>类型相关的方法:     </p>
<ul>
<li><code>layout position</code>:  在最近一次<code>layout</code>计算是<code>item</code>的位置。这是<code>LayoutManager</code>角度中的位置。   </li>
<li><code>adapter position</code>: <code>item</code>在<code>adapter</code>中的位置。这是从<code>Adapter</code>的角度中的位置。</li>
</ul>
<p>这两种<code>position</code>除了在分发<code>adapter.notify*</code>事件与之后计算布局更新的这段时间之内外都是相同的。<br>可以通过<code>getLayoutPosition(),findViewHolderForLayoutPosition(int)</code>方法来获取最近一次布局计算的<code>LayoutPosition</code>。这些<code>positions</code>包括从最近一次布局计算的所有改变。你可以根据这些位置来方便的得到用户当前从屏幕上所看到的。例如，如果在屏幕上有一个列表，用户请求的是第五个条目，你可以通过该方法来匹配当前用户正在看的内容。</p>
<p>另一种<code>AdapterPosition</code>相关的方法是<code>getAdapterPosition(),findViewHolderForAdapterPosition(int)</code>，当及时一些数据可能没有来得及被展现到布局上时便需要获取最新的<code>adapter</code>位置可以使用这些相关的方法。例如，如果你想获取一个条目的<code>ViewHOlder</code>的<code>click</code>事件时，你应该使用<code>getAdapterPosition()</code>。需要知道这些方法在<code>notifyDataSetChange()</code>方法被调用和新布局还没有被计算之前是不能使用的。鉴于这个原因，你应该小心的去处理这些方法有可能返回<code>NO_POSITION</code>或者<code>null</code>的情况。</p>
<p>###结构</p>
<ul>
<li><code>RecyclerView.Adapter</code>: 创建View并将数据集合绑定到View上</li>
<li><code>ViewHolder</code>: 持有所有的用于绑定数据或者需要操作的View</li>
<li><code>LayoutManager</code>: 布局管理器，负责摆放视图等相关操作</li>
<li><code>ItemDecoration</code>: 负责绘制<code>Item</code>附近的分割线，通过<code>RecyclerView.addItemDecoration()</code>使用</li>
<li><code>ItemAnimator</code>: 为<code>Item</code>的操作添加动画效果，如，增删条目等，通过<code>RecyclerView.setItemAnimator(new DefaultItemAnimator());</code>使用</li>
</ul>
<p>下图能更直观的了解:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/RecyclerView.png?raw=true" alt="image"></p>
<p>#####<code>RecyclerView</code>提供这些内置布局管理器:    </p>
<ul>
<li><code>LinearLayoutManager</code>: 以垂直或水平滚动列表方式显示项目。</li>
<li><code>GridLayoutManager</code>: 在网格中显示项目。</li>
<li><code>StaggeredGridLayoutManager</code>: 在分散对齐网格中显示项目。</li>
</ul>
<p>#####<code>RecyclerView.ItemDecoration</code>是一个抽象类，可以通过重写以下三个方法，来实现Item之间的偏移量或者装饰效果:     </p>
<ul>
<li><code>public void onDraw(Canvas c, RecyclerView parent)</code> 装饰的绘制在Item条目绘制之前调用，所以这有可能被Item的内容所遮挡</li>
<li><code>public void onDrawOver(Canvas c, RecyclerView parent)</code> 装饰的绘制在Item条目绘制之后调用，因此装饰将浮于Item之上</li>
<li><code>public void getItemOffsets(Rect outRect, int itemPosition, RecyclerView parent)</code> 与padding或margin类似，LayoutManager在测量阶段会调用该方法，计算出每一个Item的正确尺寸并设置偏移量。</li>
</ul>
<p>#####<code>ItemAnimator</code>触发于以下三种事件:    </p>
<ul>
<li>某条数据被插入到数据集合中</li>
<li>从数据集合中移除某条数据</li>
<li>更改数据集合中的某条数据</li>
</ul>
<p>在之前的版本中，当时据集合发生改变时通过调用<code>notifyDataSetChanged()</code>，来刷新列表，因为这样做会触发列表的重绘，所以并不会出现任何动画效果，因此需要调用一些以<code>notifyItem*()</code>作为前缀的特殊方法，比如:    </p>
<ul>
<li><code>public final void notifyItemInserted(int position)</code> 向指定位置插入<code>Item</code></li>
<li><code>public final void notifyItemRemoved(int position)</code> 移除指定位置<code>Item</code></li>
<li><code>public final void notifyItemChanged(int position)</code> 更新指定位置<code>Item</code></li>
</ul>
<p>###使用介绍:     </p>
<ul>
<li><p>添加依赖库           </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:recyclerview-v7:23.4.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>示例代码        </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line">    <span class="keyword">private</span> RecyclerView.Adapter mAdapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String [] mDatas = &#123;<span class="string">"Android"</span>,<span class="string">"ios"</span>,<span class="string">"jack"</span>,<span class="string">"tony"</span>,<span class="string">"window"</span>,<span class="string">"mac"</span>,<span class="string">"1234"</span>,<span class="string">"hehe"</span>,<span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findView();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">        <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use a linear layout manager</span></div><div class="line">        mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">        mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">        mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyHolder</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> String[] mData;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> MyHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="comment">// create a new view</span></div><div class="line">            View v = LayoutInflater.from(parent.getContext()).inflate(</div><div class="line">                    R.layout.item, parent, <span class="keyword">false</span>);</div><div class="line">            MyHolder holder = <span class="keyword">new</span> MyHolder(v);</div><div class="line">            <span class="keyword">return</span> holder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(MyHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            holder.mTitleTv.setText(mData[position]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mData == <span class="keyword">null</span> ? <span class="number">0</span> : mData.length;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> TextView mTitleTv;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            mTitleTv = (TextView) itemView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>`activity_main的内容如下: `     
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/rv"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div></pre></td></tr></table></figure>


`item的内容如下：`     
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:padding</span>=<span class="string">"20dp"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">    <span class="attr">android:textSize</span>=<span class="string">"30dp"</span>&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></div></pre></td></tr></table></figure>
</code></pre><p>###点击事件</p>
<p>之前在使用<code>ListView</code>的时候，设置点击事件是非常方便的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mListView.setOnItemClickListener();</div><div class="line">mListView.setOnItemLongClickListener();</div></pre></td></tr></table></figure></p>
<p>但是<code>RecylcerView</code>确没有提供类似的方法。那我们只能是自己去处理。处理的方式也有两种:       </p>
<ul>
<li><p>通过<code>itemView.onClickListener()</code>以及<code>onLongClickListener()</code>     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line">    <span class="keyword">private</span> MyAdapter mAdapter;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String[] mDatas = &#123;<span class="string">"Android"</span>, <span class="string">"ios"</span>, <span class="string">"jack"</span>, <span class="string">"tony"</span>, <span class="string">"window"</span>, <span class="string">"mac"</span>, <span class="string">"1234"</span>, <span class="string">"hehe"</span>, <span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        findView();</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">        <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">        mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// use a linear layout manager</span></div><div class="line">        mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">        mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">        mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">        mAdapter.setOnItemClickListener(<span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mAdapter.setOnItemLongClickListener(<span class="keyword">new</span> OnItemLongClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"long click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mRecyclerView.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyHolder</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> String[] mData;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">            mData = data;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> MyHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="comment">// create a new view</span></div><div class="line">            View v = LayoutInflater.from(parent.getContext()).inflate(</div><div class="line">                    R.layout.item, parent, <span class="keyword">false</span>);</div><div class="line">            MyHolder holder = <span class="keyword">new</span> MyHolder(v);</div><div class="line">            <span class="keyword">return</span> holder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(<span class="keyword">final</span> MyHolder holder, <span class="keyword">final</span> <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            holder.mTitleTv.setText(mData[position]);</div><div class="line">            <span class="keyword">if</span> (mOnItemClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                holder.itemView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        mOnItemClickListener.onItemClick(holder.itemView, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mOnItemLongClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                holder.itemView.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                        mOnItemLongClickListener.onItemLongClick(holder.itemView, position);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mData == <span class="keyword">null</span> ? <span class="number">0</span> : mData.length;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> OnItemClickListener mOnItemClickListener;</div><div class="line">        <span class="keyword">private</span> OnItemLongClickListener mOnItemLongClickListener;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener mOnItemClickListener)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.mOnItemClickListener = mOnItemClickListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemLongClickListener</span><span class="params">(OnItemLongClickListener mOnItemLongClickListener)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.mOnItemLongClickListener = mOnItemLongClickListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> TextView mTitleTv;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            mTitleTv = (TextView) itemView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemLongClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>使用<code>RecyclerView.OnItemTouchListener</code>           </p>
<p>  虽然没有提供现成的监听器，但是提供了一个内部接口<code>OnItemTouchListener</code>。<br>  先来看看它的介绍:    </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * An OnItemTouchListener allows the application to intercept touch events in progress at the</div><div class="line"> * view hierarchy level of the RecyclerView before those touch events are considered for</div><div class="line"> * RecyclerView&apos;s own scrolling behavior.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This can be useful for applications that wish to implement various forms of gestural</div><div class="line"> * manipulation of item views within the RecyclerView. OnItemTouchListeners may intercept</div><div class="line"> * a touch interaction already in progress even if the RecyclerView is already handling that</div><div class="line"> * gesture stream itself for the purposes of scrolling.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @see SimpleOnItemTouchListener</div><div class="line"> */</div><div class="line">public static interface OnItemTouchListener &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  说的和明白了，而且还让你看<code>SimpleOnItemTouchListener</code>，猜也能猜出来是一个默认的实现类。<br>  好了直接上代码:      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> RecyclerView mRecyclerView;</div><div class="line"><span class="keyword">private</span> LinearLayoutManager mLayoutManager;</div><div class="line"><span class="keyword">private</span> MyAdapter mAdapter;</div><div class="line"></div><div class="line"><span class="keyword">private</span> String[] mDatas = &#123;<span class="string">"Android"</span>, <span class="string">"ios"</span>, <span class="string">"jack"</span>, <span class="string">"tony"</span>, <span class="string">"window"</span>, <span class="string">"mac"</span>, <span class="string">"1234"</span>, <span class="string">"hehe"</span>, <span class="string">"495948"</span>, <span class="string">"89757"</span>, <span class="string">"66666"</span>&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line">    findView();</div><div class="line">    initView();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">()</span> </span>&#123;</div><div class="line">    mRecyclerView = (RecyclerView) findViewById(R.id.rv);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// use this setting to improve performance if you know that changes</span></div><div class="line">    <span class="comment">// in content do not change the layout size of the RecyclerView</span></div><div class="line">    mRecyclerView.setHasFixedSize(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// use a linear layout manager</span></div><div class="line">    mLayoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">    mLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);</div><div class="line">    mRecyclerView.setLayoutManager(mLayoutManager);</div><div class="line">    mAdapter = <span class="keyword">new</span> MyAdapter(mDatas);</div><div class="line">    mRecyclerView.setAdapter(mAdapter);</div><div class="line">    mRecyclerView.addOnItemTouchListener(<span class="keyword">new</span> RecyclerViewClickListener(<span class="keyword">this</span>, mRecyclerView, <span class="keyword">new</span> OnItemClickListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Long Click "</span> + mDatas[position], Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecyclerViewClickListener</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">SimpleOnItemTouchListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> GestureDetector mGestureDetector;</div><div class="line">    <span class="keyword">private</span> OnItemClickListener mListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecyclerViewClickListener</span><span class="params">(Context context, <span class="keyword">final</span> RecyclerView recyclerView, OnItemClickListener listener)</span> </span>&#123;</div><div class="line">        mListener = listener;</div><div class="line">        mGestureDetector = <span class="keyword">new</span> GestureDetector(context,</div><div class="line">                <span class="keyword">new</span> GestureDetector.SimpleOnGestureListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSingleTapUp</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">                        View childView = recyclerView.findChildViewUnder(e.getX(), e.getY());</div><div class="line">                        <span class="keyword">if</span> (childView != <span class="keyword">null</span> &amp;&amp; mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                            mListener.onItemClick(childView, recyclerView.getChildLayoutPosition(childView));</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLongPress</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">                        View childView = recyclerView.findChildViewUnder(e.getX(), e.getY());</div><div class="line">                        <span class="keyword">if</span> (childView != <span class="keyword">null</span> &amp;&amp; mListener != <span class="keyword">null</span>) &#123;</div><div class="line">                            mListener.onItemLongClick(childView, recyclerView.getChildLayoutPosition(childView));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mGestureDetector.onTouchEvent(e)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(rv, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onTouchEvent(rv, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestDisallowInterceptTouchEvent</span><span class="params">(<span class="keyword">boolean</span> disallowIntercept)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestDisallowInterceptTouchEvent(disallowIntercept);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  上面的实现稍微有些缺陷，就是如果我手指按住某个条目一直不抬起，他也会执行<code>Long click</code>事件，这显然是不合理的，至于怎么解决，就是可以不用<code>GestureDetector</code>，自己在<code>DOWN</code>和<code>UP</code>事件中去判断处理。</p>
</li>
</ul>
<h3 id="Headerview-FooterView"><a href="#Headerview-FooterView" class="headerlink" title="Headerview FooterView"></a>Headerview FooterView</h3><p>之前在<code>ListView</code>中提供了<code>addHeaderView()</code>和<code>addFooterView()</code>等方法，但是在<code>RecyclerView</code>中并没有提供类似的方法，那我们该如何添加呢？ 也很简单，就是通过<code>Adapter</code>中去添加，利用不同的<code>itemViewType</code>，然后根据不同的类型去在<code>onCreateViewHOlder</code>中创建不同的视图，通过这种方式来达到<code>headerview</code>和<code>FooterView</code>的效果。</p>
<p>上一段简单的示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecyclerView</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_HEADER = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_ITEM = <span class="number">1</span>;</div><div class="line">    String[] data;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeaderAdapter</span><span class="params">(String[] data)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (viewType == TYPE_ITEM) &#123;</div><div class="line">            <span class="comment">//inflate your layout and pass it to view holder</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> VHItem(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (viewType == TYPE_HEADER) &#123;</div><div class="line">            <span class="comment">//inflate your layout and pass it to view holder</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> VHHeader(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"there is no type that matches the type "</span> + viewType + <span class="string">" + make sure your using types correctly"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (holder <span class="keyword">instanceof</span> VHItem) &#123;</div><div class="line">            String dataItem = getItem(position);</div><div class="line">            <span class="comment">//cast holder to VHItem and set data</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (holder <span class="keyword">instanceof</span> VHHeader) &#123;</div><div class="line">            <span class="comment">//cast holder to VHHeader and set data for header.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> data.length + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isPositionHeader(position))</div><div class="line">            <span class="keyword">return</span> TYPE_HEADER;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> TYPE_ITEM;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPositionHeader</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> position == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> data[position - <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">VHItem</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        TextView title;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VHItem</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">VHHeader</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        Button button;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VHHeader</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的代码对<code>LinearLayoutManger</code>是没问题的，但是使用<code>GridLayoutManager</code>呢？ 如果是两列，那添加的<code>HeaderView</code>并不是占据上第一行，而是<code>HeaderView</code>与第二个<code>ItemView</code>一起占据第一行。那该怎么处理呢？<br>那就是使用<code>setSpanSizeLookup()</code>方法。<br>比如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">recyclerView.setLayoutManager(<span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>, <span class="number">2</span>));</div></pre></td></tr></table></figure></p>
<p>在上面的基本设置中，我们的<code>spanCount</code>为2，每个<code>item</code>的<code>span size</code>为1，因此一个<code>header</code>需要的<code>span size</code>则为2。在我尝试着添加<code>header</code>之前，我想先看看如何设置<code>span size</code>。其实很简单。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> GridLayoutManager manager = <span class="keyword">new</span> GridLayoutManager(<span class="keyword">this</span>, <span class="number">2</span>);</div><div class="line">recyclerView.setLayoutManager(manager);</div><div class="line">manager.setSpanSizeLookup(<span class="keyword">new</span> GridLayoutManager.SpanSizeLookup() &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSpanSize</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> adapter.isHeader(position) ? manager.getSpanCount() : <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="下拉刷新、自动加载"><a href="#下拉刷新、自动加载" class="headerlink" title="下拉刷新、自动加载"></a>下拉刷新、自动加载</h3><p>#####实现下拉刷新<br>实现下拉刷新也很简单了，可以使用<code>SwipeRefrshLayout</code>,<code>SwipeRefrshLayout</code>是<code>Google</code>官方提供的组件，可以实现下拉刷新的功能。已包含到<code>support.v4</code>包中。</p>
<p>主要方法有:      </p>
<ul>
<li><code>setOnRefreshListener(OnRefreshListener)</code>:添加下拉刷新监听器</li>
<li><code>setRefreshing(boolean)</code>:显示或者隐藏刷新进度条</li>
<li><code>isRefreshing()</code>:检查是否处于刷新状态</li>
<li><code>setColorSchemeResources()</code>:设置进度条的颜色主题，最多设置四种。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.SwipeRefreshLayout</span></span></div><div class="line">   <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">   <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:scrollbars</span>=<span class="string">"vertical"</span></div><div class="line">    &gt;</div><div class="line">   <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></div><div class="line">       <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">       <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">       &gt;<span class="tag">&lt;/<span class="name">android.support.v7.widget.RecyclerView</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>具体实现就不写了。</p>
<p>#####实现滑动自动加载更多功能</p>
<p>实现方式和<code>ListView</code>的实现方式类似，就是通过监听<code>scroll</code>时间，然后判断当前显示的<code>item</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//RecyclerView滑动监听</span></div><div class="line">mRecylcerView.setOnScrollListener(<span class="keyword">new</span> RecyclerView.OnScrollListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrollStateChanged</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> newState)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState);</div><div class="line">        <span class="keyword">if</span> (newState ==RecyclerView.SCROLL_STATE_IDLE &amp;&amp; lastVisibleItem + <span class="number">1</span> ==adapter.getItemCount()) &#123;</div><div class="line">            <span class="keyword">new</span> Handler().postDelayed(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    List&lt;String&gt; newDatas = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">                        <span class="keyword">int</span> index = i +<span class="number">1</span>;</div><div class="line">                       newDatas.add(<span class="string">"more item"</span> + index);</div><div class="line">                    &#125;</div><div class="line">                   adapter.addMoreItem(newDatas);</div><div class="line">                &#125;</div><div class="line">            &#125;,<span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrolled</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onScrolled(recyclerView,dx, dy);</div><div class="line">        lastVisibleItem =linearLayoutManager.findLastVisibleItemPosition();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>然后再通过结合<code>FooterView</code>以及增加几种状态就可以实现自动加载更多了。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RecyclerView专题/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-ListView源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/ListView源码分析/">ListView源码分析</a>
    </h1>
  

        
        <a href="/2015/01/01/ListView源码分析/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ListView源码分析"><a href="#ListView源码分析" class="headerlink" title="ListView源码分析"></a>ListView源码分析</h1><p>一直都想写一篇文章分析下<code>ListView</code>的实现，总是忙，一直拖到现在，快到年底了，写出来希望能帮助一些面试跳槽的人。<br>当然写这篇文章也是有原因的，当时有同事在面试的时候，被对方要求当场实现一个<code>ListView</code>，同事简单的答了一些实现原理后，很显然对方不满意，经过几轮PK后，就有了不河蟹的结局。<br>不欢而散，哈哈。听说后当时我想着要把<code>ListView</code>源码仔细分析后，我自己也去面试试试，可是拖到了现在也没机会了。</p>
<p><code>GridView</code>与<code>ListView</code>都继承自<code>AbsListView</code>，他俩的实现也比较类似，这里就不说<code>GridView</code>了。只说一下<code>ListView</code>。<br>首先看一下<code>ListView</code>的文档:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Implementation Notes:</div><div class="line"> *</div><div class="line"> * Some terminology:</div><div class="line"> *</div><div class="line"> *     index    - index of the items that are currently visible</div><div class="line"> *     position - index of the items in the cursor</div><div class="line"> */</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A view that shows items in a vertically scrolling list. The items</div><div class="line"> * come from the &#123;<span class="doctag">@link</span> ListAdapter&#125; associated with this view.</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>然后再说一下<code>ListView</code>的继承关系<code>ListView extends AbsListView extends AdapterView&lt;ListAdapter&gt; extends ViewGroup extends View</code>。<br><code>ListView</code>与其他空间不一样，不是拖到界面上就能用，而是要通过设置适配器来添加条目。这就是<code>AdapterView</code>的主要功能。既然通过适配器来操作数据。<br>这里自然想到的就是<code>MVC</code>设计模式。     </p>
<ul>
<li><code>Data</code>     - <code>M</code>                </li>
<li><code>ListView</code> - <code>V</code></li>
<li><code>Adapter</code>  - <code>C</code></li>
</ul>
<p>到这里我们写罗列一下我们将要分析的内容:      </p>
<ul>
<li><code>ListView</code>与<code>Adapter</code>间的调用。</li>
<li><code>ListView</code>上下滑动时操作及缓存。 </li>
</ul>
<p>我们平时使用<code>ListView</code>的时候都是调用<code>setAdapter()</code>方法，所以我们这里就从该方法入手:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Sets the data behind this ListView.</div><div class="line">    *</div><div class="line">    * The adapter passed to this method may be wrapped by a &#123;<span class="doctag">@link</span> WrapperListAdapter&#125;,</div><div class="line">    * depending on the ListView features currently in use. For instance, adding</div><div class="line">    * headers and/or footers will cause the adapter to be wrapped.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> adapter The ListAdapter which is responsible for maintaining the</div><div class="line">    *        data backing this list and for producing a view to represent an</div><div class="line">    *        item in that data set.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@see</span> #getAdapter() </div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(ListAdapter adapter)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mDataSetObserver != <span class="keyword">null</span>) &#123;</div><div class="line">   	    <span class="comment">// 取消之前注册过的Adapter</span></div><div class="line">           mAdapter.unregisterDataSetObserver(mDataSetObserver);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 清空所有的数据</span></div><div class="line">       resetList();	</div><div class="line">       <span class="comment">// The data set used to store unused views that should be reused during the next layout to avoid creating new ones.</span></div><div class="line">       <span class="comment">// 从注释中可以很明显的看出`View`的复用是通过`RecycleBin`类来实现的。它就决定了为什么`ListView`可以显示很多数据缺不会内存溢出。</span></div><div class="line">       mRecycler.clear();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mHeaderViewInfos.size() &gt; <span class="number">0</span>|| mFooterViewInfos.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">// 如果有HeaderView或者FooterView就把Adapter重新封装下,这是什么设计模式？－装饰</span></div><div class="line">		<span class="comment">// mHeaderViewInfos和mFooterViewInfos分别是header view和foooter view装饰类FixedViewInfo的集合。</span></div><div class="line">		<span class="comment">// 会在addHeaderView()和addFooterView()中进行添加。</span></div><div class="line">           mAdapter = <span class="keyword">new</span> HeaderViewListAdapter(mHeaderViewInfos, mFooterViewInfos, adapter);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           mAdapter = adapter;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mOldSelectedPosition = INVALID_POSITION;</div><div class="line">       mOldSelectedRowId = INVALID_ROW_ID;</div><div class="line"></div><div class="line">       <span class="comment">// AbsListView#setAdapter will update choice mode states.</span></div><div class="line">       <span class="keyword">super</span>.setAdapter(adapter);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">           mAreAllItemsSelectable = mAdapter.areAllItemsEnabled();</div><div class="line">           mOldItemCount = mItemCount;</div><div class="line">           mItemCount = mAdapter.getCount();</div><div class="line">           checkFocus();</div><div class="line"></div><div class="line">           mDataSetObserver = <span class="keyword">new</span> AdapterDataSetObserver();</div><div class="line">           mAdapter.registerDataSetObserver(mDataSetObserver); </div><div class="line">           <span class="comment">// 将viewtypecount设置给RecycleBin</span></div><div class="line">           mRecycler.setViewTypeCount(mAdapter.getViewTypeCount());</div><div class="line"></div><div class="line">           <span class="keyword">int</span> position;</div><div class="line">           <span class="comment">// mStackFromBottom Indicates whether the list is stacked from the bottom edge or the top edge.</span></div><div class="line">           <span class="keyword">if</span> (mStackFromBottom) &#123;</div><div class="line">               position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           setSelectedPositionInt(position);</div><div class="line">           setNextSelectedPositionInt(position);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// Nothing selected</span></div><div class="line">               checkSelectionChanged();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           mAreAllItemsSelectable = <span class="keyword">true</span>;</div><div class="line">           checkFocus();</div><div class="line">           <span class="comment">// Nothing selected</span></div><div class="line">           checkSelectionChanged();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">// 请求layout了，这个就很重要了啊...我们稍后看一下。</span></div><div class="line">       requestLayout();</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">    * The list is empty. Clear everything out.</div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">resetList</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// The parent's resetList() will remove all views from the layout so we need to</span></div><div class="line">       <span class="comment">// cleanup the state of our footers and headers</span></div><div class="line">       clearRecycledState(mHeaderViewInfos);</div><div class="line">       clearRecycledState(mFooterViewInfos);</div><div class="line">       <span class="comment">// The list is empty. Clear everything out.</span></div><div class="line">       <span class="keyword">super</span>.resetList();</div><div class="line"></div><div class="line">       mLayoutMode = LAYOUT_NORMAL;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearRecycledState</span><span class="params">(ArrayList&lt;FixedViewInfo&gt; infos)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (infos != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> count = infos.size();</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">               <span class="keyword">final</span> View child = infos.get(i).view;</div><div class="line">               <span class="keyword">final</span> LayoutParams p = (LayoutParams) child.getLayoutParams();</div><div class="line">               <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">			    <span class="comment">// 这里p就是AbsListView.LayoutParams。对于recycledHeaderFooter在注释中是这样说的. </span></div><div class="line">				<span class="comment">/**</span></div><div class="line">				 * When this boolean is set, the view has been added to the AbsListView</div><div class="line">				 * at least once. It is used to know whether headers/footers have already</div><div class="line">				 * been added to the list view and whether they should be treated as</div><div class="line">				 * recycled views or not.</div><div class="line">				 */</div><div class="line">                   p.recycledHeaderFooter = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>setAdapter()</code>方法中会调用<code>requestLayout()</code>方法。而<code>requestLayout()</code>方法会调用<code>onLayout()</code>方法，但是我们在<code>ListView</code>中找不到<code>onLayout()</code>方法。<br>那就去他的父类<code>AbsListView</code>中找。我们接着来看一下<code>AbsListView.onLayout()</code>方法的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Subclasses should NOT override this method but</div><div class="line"> *  &#123;<span class="doctag">@link</span> #layoutChildren()&#125; instead.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">	<span class="keyword">if</span> (changed) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			getChildAt(i).forceLayout();</div><div class="line">		&#125;</div><div class="line">		mRecycler.markChildrenDirty();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 调用layoutChildren()方法。</span></div><div class="line">	layoutChildren();</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn't belong in onLayout().</span></div><div class="line">	<span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">		mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>AbsListView.layoutChildren()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Subclasses must override this method to layout their children.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实现是空的,文档说的很明白了，子类必须要去实现该方法，这也是应该的，因为<code>ListView</code>和<code>GridView</code>的展现是不一样的.所以我们看一下<code>ListView.layoutChildren()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// When set to true, calls to requestLayout() will not propagate up the parent hierarchy.</span></div><div class="line">    <span class="comment">// This is used to layout the children during a layout pass.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">	<span class="keyword">if</span> (blockLayoutRequests) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 开始了，置为true</span></div><div class="line">	mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">super</span>.layoutChildren();</div><div class="line"></div><div class="line">		invalidate();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">			resetList();</div><div class="line">			invokeOnItemScrollListener();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">		<span class="keyword">int</span> delta = <span class="number">0</span>;</div><div class="line"></div><div class="line">		View sel;</div><div class="line">		View oldSel = <span class="keyword">null</span>;</div><div class="line">		View oldFirst = <span class="keyword">null</span>;</div><div class="line">		View newSel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="comment">// Remember stuff we will need down below</span></div><div class="line">		<span class="comment">// mLayoutMode的注释为Controls how the next layout will happen，默认为LAYOUT_NORMAL</span></div><div class="line">		<span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">			index = mNextSelectedPosition - mFirstPosition;</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">				newSel = getChildAt(index);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">		<span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">		<span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="comment">// Remember the previously selected view</span></div><div class="line">			index = mSelectedPosition - mFirstPosition;</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">				oldSel = getChildAt(index);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Remember the previous first child</span></div><div class="line">			oldFirst = getChildAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Caution: newSel might be null</span></div><div class="line">			newSel = getChildAt(index + delta);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// mDataChanged变量标记Adapter中数据是否发生变化</span></div><div class="line">		<span class="keyword">boolean</span> dataChanged = mDataChanged;</div><div class="line">		<span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">			handleDataChanged();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Handle the empty set by removing all views that are visible</span></div><div class="line">		<span class="comment">// and calling it a day</span></div><div class="line">		<span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">			resetList();</div><div class="line">			invokeOnItemScrollListener();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></div><div class="line">					+ <span class="string">"ListView did not receive a notification. Make sure the content of "</span></div><div class="line">					+ <span class="string">"your adapter is not modified from a background thread, but only from "</span></div><div class="line">					+ <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></div><div class="line">					+ <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</div><div class="line">					+ <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">		AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = <span class="keyword">null</span>;</div><div class="line">		View accessibilityFocusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">int</span> accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">		<span class="comment">// Remember which child, if any, had accessibility focus. This must</span></div><div class="line">		<span class="comment">// occur before recycling any views, since that will clear</span></div><div class="line">		<span class="comment">// accessibility focus.</span></div><div class="line">		<span class="keyword">final</span> ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">		<span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">			<span class="keyword">if</span> (focusHost != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">				<span class="keyword">if</span> (focusChild != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">							|| focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">						<span class="comment">// The views won't be changing, so try to maintain</span></div><div class="line">						<span class="comment">// focus on the current host and virtual view.</span></div><div class="line">						accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">						accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">								.getAccessibilityFocusedVirtualView();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">// If all else fails, maintain focus at the same</span></div><div class="line">					<span class="comment">// position.</span></div><div class="line">					accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		View focusLayoutRestoreDirectChild = <span class="keyword">null</span>;</div><div class="line">		View focusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="comment">// Take focus back to us temporarily to avoid the eventual call to</span></div><div class="line">		<span class="comment">// clear focus when removing the focused child below from messing</span></div><div class="line">		<span class="comment">// things up when ViewAncestor assigns focus back to someone else.</span></div><div class="line">		<span class="keyword">final</span> View focusedChild = getFocusedChild();</div><div class="line">		<span class="keyword">if</span> (focusedChild != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> in some cases focusedChild.getParent() == null</span></div><div class="line"></div><div class="line">			<span class="comment">// We can remember the focused view to restore after re-layout</span></div><div class="line">			<span class="comment">// if the data hasn't changed, or if the focused position is a</span></div><div class="line">			<span class="comment">// header or footer.</span></div><div class="line">			<span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)) &#123;</div><div class="line">				focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">				<span class="comment">// Remember the specific view that had focus.</span></div><div class="line">				focusLayoutRestoreView = findFocus();</div><div class="line">				<span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Tell it we are going to mess with it.</span></div><div class="line">					focusLayoutRestoreView.onStartTemporaryDetach();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			requestFocus();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Pull all children into the RecycleBin.</span></div><div class="line">		<span class="comment">// These views will be reused if possible</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line">		<span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</div><div class="line">		<span class="comment">// RecycleBin控制着整个item的复用，等最后我们再仔细分析下RecycleBin类</span></div><div class="line">		<span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">		    <span class="comment">// 如果数据发生变化，就把现在的View都添加到一个废弃的View进行缓存，RecycleBin.addScrapView()方法就是缓存一些废弃的View</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">				recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">		    <span class="comment">// 调用这个方法后就会根据传入的参数来将ListView中的指定元素存储到mActiveViews数组当中。</span></div><div class="line">			recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Clear out old views</span></div><div class="line">		detachAllViewsFromParent();</div><div class="line">		recycleBin.removeSkippedScrap();</div><div class="line">		<span class="comment">// mLayoutMode默认是LAYOUT_NORMAL</span></div><div class="line">		<span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">			<span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</div><div class="line">				sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">			sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">			sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">			adjustViewsUpOrDown();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">			mFirstPosition = <span class="number">0</span>;</div><div class="line">			sel = fillFromTop(childrenTop);</div><div class="line">			adjustViewsUpOrDown();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">			sel = fillSpecific(reconcileSelectedPosition(), mSpecificTop);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">			sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">		    <span class="comment">// 第一次调用layoutChildren方法的时候是还没有layout的，所以这时候childCount是0</span></div><div class="line">			<span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">			    <span class="comment">// mStackFromBottom的注释Indicates whether the list is stacked from the bottom edge or the top edge.</span></div><div class="line">				<span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">				    <span class="comment">// 默认的布局方式是从上往下的。</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">					setSelectedPositionInt(position);</div><div class="line">					<span class="comment">// 调用fillFromTop方法。</span></div><div class="line">					sel = fillFromTop(childrenTop);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">					setSelectedPositionInt(position);</div><div class="line">					sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			    <span class="comment">// 如果已经有条目了就会走到这里</span></div><div class="line">				<span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">					sel = fillSpecific(mSelectedPosition,</div><div class="line">							oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">				    <span class="comment">// 没有选中的条目</span></div><div class="line">					<span class="comment">// TODO 一会先分析上面的fillFromTop部分，把其全部分析完后再回来分析这里。</span></div><div class="line">					sel = fillSpecific(mFirstPosition,</div><div class="line">							oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					sel = fillSpecific(<span class="number">0</span>, childrenTop);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Flush any cached views that did not get reused above</span></div><div class="line">		recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (sel != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// The current selected item should get focus if items are</span></div><div class="line">			<span class="comment">// focusable.</span></div><div class="line">			<span class="keyword">if</span> (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">boolean</span> focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">						focusLayoutRestoreView != <span class="keyword">null</span> &amp;&amp;</div><div class="line">						focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">				<span class="keyword">if</span> (!focusWasTaken) &#123;</div><div class="line">					<span class="comment">// Selected item didn't take focus, but we still want to</span></div><div class="line">					<span class="comment">// make sure something else outside of the selected view</span></div><div class="line">					<span class="comment">// has focus.</span></div><div class="line">					<span class="keyword">final</span> View focused = getFocusedChild();</div><div class="line">					<span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</div><div class="line">						focused.clearFocus();</div><div class="line">					&#125;</div><div class="line">					positionSelector(INVALID_POSITION, sel);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					sel.setSelected(<span class="keyword">false</span>);</div><div class="line">					mSelectorRect.setEmpty();</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				positionSelector(INVALID_POSITION, sel);</div><div class="line">			&#125;</div><div class="line">			mSelectedTop = sel.getTop();</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">					|| mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">			<span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">				<span class="comment">// If the user's finger is down, select the motion position.</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">				<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">					positionSelector(mMotionPosition, child);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">				<span class="comment">// If we had previously positioned the selector somewhere,</span></div><div class="line">				<span class="comment">// put it back there. It might not match up with the data,</span></div><div class="line">				<span class="comment">// but it's transitioning out so it's not a big deal.</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">				<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">					positionSelector(mSelectorPosition, child);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Otherwise, clear selection.</span></div><div class="line">				mSelectedTop = <span class="number">0</span>;</div><div class="line">				mSelectorRect.setEmpty();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Even if there is not selected position, we may need to</span></div><div class="line">			<span class="comment">// restore focus (i.e. something focusable in touch mode).</span></div><div class="line">			<span class="keyword">if</span> (hasFocus() &amp;&amp; focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">				focusLayoutRestoreView.requestFocus();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Attempt to restore accessibility focus, if necessary.</span></div><div class="line">		<span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">			<span class="keyword">if</span> (newAccessibilityFocusedView == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (accessibilityFocusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">						&amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">					<span class="keyword">final</span> AccessibilityNodeProvider provider =</div><div class="line">							accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">					<span class="keyword">if</span> (accessibilityFocusLayoutRestoreNode != <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">								accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">						provider.performAction(virtualViewId,</div><div class="line">								AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, <span class="keyword">null</span>);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">					<span class="comment">// Bound the position within the visible children.</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = MathUtils.constrain(</div><div class="line">							accessibilityFocusPosition - mFirstPosition, <span class="number">0</span>,</div><div class="line">							getChildCount() - <span class="number">1</span>);</div><div class="line">					<span class="keyword">final</span> View restoreView = getChildAt(position);</div><div class="line">					<span class="keyword">if</span> (restoreView != <span class="keyword">null</span>) &#123;</div><div class="line">						restoreView.requestAccessibilityFocus();</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Tell focus view we are done mucking with it, if it is still in</span></div><div class="line">		<span class="comment">// our view hierarchy.</span></div><div class="line">		<span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">				&amp;&amp; focusLayoutRestoreView.getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">			focusLayoutRestoreView.onFinishTemporaryDetach();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		mLayoutMode = LAYOUT_NORMAL;</div><div class="line">		mDataChanged = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mPositionScrollAfterLayout != <span class="keyword">null</span>) &#123;</div><div class="line">			post(mPositionScrollAfterLayout);</div><div class="line">			mPositionScrollAfterLayout = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		mNeedSync = <span class="keyword">false</span>;</div><div class="line">		setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">		updateScrollIndicators();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			checkSelectionChanged();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		invokeOnItemScrollListener();</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">if</span> (!blockLayoutRequests) &#123;</div><div class="line">			mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面看到会调用<code>fillFromTop()</code>方法，我们看一下该方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the list from top to bottom, starting with mFirstPosition</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> nextTop The location where the top of the first item should be</div><div class="line"> *        drawn</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The view that is currently selected</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillFromTop</span><span class="params">(<span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">	mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</div><div class="line">	mFirstPosition = Math.min(mFirstPosition, mItemCount - <span class="number">1</span>);</div><div class="line">	<span class="keyword">if</span> (mFirstPosition &lt; <span class="number">0</span>) &#123;</div><div class="line">		mFirstPosition = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 调用fillDown()方法。</span></div><div class="line">	<span class="keyword">return</span> fillDown(mFirstPosition, nextTop);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下<code>fillDown()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the list from pos down to the end of the list view.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> pos The first position to put in the list</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> nextTop The location where the top of the item associated with pos</div><div class="line"> *        should be drawn</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The view that is currently selected, if it happens to be in the</div><div class="line"> *         range that we draw.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillDown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">	View selectedView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> end = (mBottom - mTop);</div><div class="line">	<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">		end -= mListPadding.bottom;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 用一个循环一直去填充，nextTop与end的比较来判断是否超过当前屏幕了，这就是为什么ListView就算有一万条最开始载入也不卡，因为他只初始化一屏啊。</span></div><div class="line">	<span class="comment">// 以后都是边滑动边显示啊，说到这里一会我们还要看一下手势部分的处理。pos和mItemCount的比较来判断当前是否已经把所有条目填充完</span></div><div class="line">	<span class="keyword">while</span> (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</div><div class="line">		<span class="comment">// is this the selected item?</span></div><div class="line">		<span class="keyword">boolean</span> selected = pos == mSelectedPosition;</div><div class="line">		<span class="comment">// 调用makeAndAddView方法</span></div><div class="line">		View child = makeAndAddView(pos, nextTop, <span class="keyword">true</span>, mListPadding.left, selected);</div><div class="line"></div><div class="line">		nextTop = child.getBottom() + mDividerHeight;</div><div class="line">		<span class="keyword">if</span> (selected) &#123;</div><div class="line">			selectedView = child;</div><div class="line">		&#125;</div><div class="line">		pos++;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</div><div class="line">	<span class="keyword">return</span> selectedView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来看一下<code>makeAndAddView()</code>方法，文档里面说的非常清楚了:　　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Obtain the view and add it to our list of children. The view can be made</div><div class="line"> * fresh, converted from an unused view, or used as is if it was in the</div><div class="line"> * recycle bin.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position Logical position in the list</div><div class="line"> * <span class="doctag">@param</span> y Top or bottom edge of the view to add</div><div class="line"> * <span class="doctag">@param</span> flow If flow is true, align top edge to y. If false, align bottom</div><div class="line"> *        edge to y.</div><div class="line"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</div><div class="line"> * <span class="doctag">@param</span> selected Is this position selected?</div><div class="line"> * <span class="doctag">@return</span> View that was added</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">		<span class="keyword">boolean</span> selected) &#123;</div><div class="line">	View child;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">		<span class="comment">// Try to use an existing view for this position</span></div><div class="line">		child = mRecycler.getActiveView(position);</div><div class="line">		<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// Found it -- we're using an existing child</span></div><div class="line">			<span class="comment">// This just needs to be positioned</span></div><div class="line">			<span class="comment">// 最后一个参数为true说明是复用的</span></div><div class="line">			setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">			<span class="keyword">return</span> child;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Make a new view for this position, or convert an unused view if possible</span></div><div class="line">	<span class="comment">// 一会我们先看一下obtainView方法，这个方法其实就是创建一个childView</span></div><div class="line">	<span class="comment">// obtainView方法中会更改mIsScrap[0]的值，以便下面setupChild()中使用。</span></div><div class="line">	child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">	<span class="comment">// This needs to be positioned and measured</span></div><div class="line">	<span class="comment">// 把childView添加到listview中，这里最后一个参数会是false</span></div><div class="line">	setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>makeAndAddView()</code>方法里面就是通过<code>RecycleBin</code>来复用<code>View</code>，如果不存在可以复用的<code>View</code>时就创建一个新的。<br>那我们就先看一下`obtainView()方法，这个方法中的注释写的非常清楚，谷歌大神写代码就是规范，不想某些牛逼哄哄的人整天咋呼敏捷开发，一个注释也不写，那能叫敏捷？。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a view and have it show the data associated with the specified</div><div class="line"> * position. This is called when we have already discovered that the view is</div><div class="line"> * not available for reuse in the recycle bin. The only choices left are</div><div class="line"> * converting an old view or making a new one.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position The position to display</div><div class="line"> * <span class="doctag">@param</span> isScrap Array of at least 1 boolean, the first entry will become true if</div><div class="line"> *                the returned view was taken from the scrap heap, false if otherwise.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> A view displaying the data associated with the specified position</div><div class="line"> */</div><div class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] isScrap)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"obtainView"</span>);</div><div class="line"></div><div class="line">	isScrap[<span class="number">0</span>] = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Check whether we have a transient state view. Attempt to re-bind the</span></div><div class="line">	<span class="comment">// data and discard the view if we fail.</span></div><div class="line">	<span class="keyword">final</span> View transientView = mRecycler.getTransientStateView(position);</div><div class="line">	<span class="keyword">if</span> (transientView != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> LayoutParams params = (LayoutParams) transientView.getLayoutParams();</div><div class="line"></div><div class="line">		<span class="comment">// If the view type hasn't changed, attempt to re-bind the data.</span></div><div class="line">		<span class="keyword">if</span> (params.viewType == mAdapter.getItemViewType(position)) &#123;</div><div class="line">			<span class="keyword">final</span> View updatedView = mAdapter.getView(position, transientView, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">			<span class="comment">// If we failed to re-bind the data, scrap the obtained view.</span></div><div class="line">			<span class="keyword">if</span> (updatedView != transientView) &#123;</div><div class="line">				setItemViewLayoutParams(updatedView, position);</div><div class="line">				mRecycler.addScrapView(updatedView, position);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Scrap view implies temporary detachment.</span></div><div class="line">		isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">return</span> transientView;</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// getScrapView()方法会从废弃View的缓存中去取，一旦View移除了屏幕就会被加到该废弃缓存中，所以他就是当View移除屏幕了就加到该缓存中</span></div><div class="line">	<span class="comment">// 显示的时候再从该缓存中取，就这样进行了复用。</span></div><div class="line">	<span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</div><div class="line">	<span class="comment">// 调用Adapter.getView()方法了。并且将scrapView作为converview的参数传入。这个方法都挺熟，就不说了。</span></div><div class="line">	<span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (child != scrapView) &#123;</div><div class="line">			<span class="comment">// Failed to re-bind the data, return scrap to the heap.</span></div><div class="line">			mRecycler.addScrapView(scrapView, position);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">			child.dispatchFinishTemporaryDetach();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;</div><div class="line">		child.setDrawingCacheBackgroundColor(mCacheColorHint);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</div><div class="line">		child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 设置该view的layoutparams</span></div><div class="line">	setItemViewLayoutParams(child, position);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</div><div class="line">		<span class="keyword">if</span> (mAccessibilityDelegate == <span class="keyword">null</span>) &#123;</div><div class="line">			mAccessibilityDelegate = <span class="keyword">new</span> ListItemAccessibilityDelegate();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (child.getAccessibilityDelegate() == <span class="keyword">null</span>) &#123;</div><div class="line">			child.setAccessibilityDelegate(mAccessibilityDelegate);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里我们就把<code>obtainView()</code>方法都看完了，接下来我们再看一下<code>setupChild()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Add a view as a child and make sure it is measured (if necessary) and</div><div class="line"> * positioned properly.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The view to add</div><div class="line"> * <span class="doctag">@param</span> position The position of this child</div><div class="line"> * <span class="doctag">@param</span> y The y position relative to which this view will be positioned</div><div class="line"> * <span class="doctag">@param</span> flowDown If true, align top edge to y. If false, align bottom</div><div class="line"> *        edge to y.</div><div class="line"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</div><div class="line"> * <span class="doctag">@param</span> selected Is this position selected?</div><div class="line"> * <span class="doctag">@param</span> recycled Has this view been pulled from the recycle bin? If so it</div><div class="line"> *        does not need to be remeasured.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">		<span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> recycled) &#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"setupListItem"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isSelected = selected &amp;&amp; shouldShowSelector();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> updateChildSelected = isSelected != child.isSelected();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> mode = mTouchMode;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isPressed = mode &gt; TOUCH_MODE_DOWN &amp;&amp; mode &lt; TOUCH_MODE_SCROLL &amp;&amp;</div><div class="line">			mMotionPosition == position;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> updateChildPressed = isPressed != child.isPressed();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> needToMeasure = !recycled || updateChildSelected || child.isLayoutRequested();</div><div class="line"></div><div class="line">	<span class="comment">// Respect layout params that are already in the view. Otherwise make some up...</span></div><div class="line">	<span class="comment">// noinspection unchecked</span></div><div class="line">	AbsListView.LayoutParams p = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">	<span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">		p = (AbsListView.LayoutParams) generateDefaultLayoutParams();</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 这里就是Adapter中getItemViewType的调用处</span></div><div class="line">	p.viewType = mAdapter.getItemViewType(position);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((recycled &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter &amp;&amp;</div><div class="line">			p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">		<span class="comment">// 复用的或者headerView及footerView等调用attachViewToParent方法，把之前detach的View重新attach到ViewGroup上</span></div><div class="line">		attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		p.forceAdd = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">			p.recycledHeaderFooter = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 第一次都是通过该方法来把View添加到ViewGroup中</span></div><div class="line">		addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (updateChildSelected) &#123;</div><div class="line">		child.setSelected(isSelected);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (updateChildPressed) &#123;</div><div class="line">		child.setPressed(isPressed);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</div><div class="line">			((Checkable) child).setChecked(mCheckStates.get(position));</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</div><div class="line">				&gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">			child.setActivated(mCheckStates.get(position));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">		<span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</div><div class="line">				mListPadding.left + mListPadding.right, p.width);</div><div class="line">		<span class="keyword">int</span> lpHeight = p.height;</div><div class="line">		<span class="keyword">int</span> childHeightSpec;</div><div class="line">		<span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">			childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			childHeightSpec = MeasureSpec.makeMeasureSpec(<span class="number">0</span>, MeasureSpec.UNSPECIFIED);</div><div class="line">		&#125;</div><div class="line">		child.measure(childWidthSpec, childHeightSpec);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		cleanupLayoutState(child);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</div><div class="line">		child.layout(childrenLeft, childTop, childRight, childBottom);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		child.offsetLeftAndRight(childrenLeft - child.getLeft());</div><div class="line">		child.offsetTopAndBottom(childTop - child.getTop());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mCachingStarted &amp;&amp; !child.isDrawingCacheEnabled()) &#123;</div><div class="line">		child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (recycled &amp;&amp; (((AbsListView.LayoutParams)child.getLayoutParams()).scrappedFromPosition)</div><div class="line">			!= position) &#123;</div><div class="line">		child.jumpDrawablesToCurrentState();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过分析我们看到核心的部分就是<code>attachViewToParent()</code>方法和<code>addViewInLayout()</code>方法，这两个方法都是父类<code>ViewGroup</code>中的方法，<br>我们分别来看一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Attaches a view to this view group. Attaching a view assigns this group as the parent,</div><div class="line"> * sets the layout parameters and puts the view in the list of children so that</div><div class="line"> * it can be retrieved by calling &#123;<span class="doctag">@link</span> #getChildAt(int)&#125;.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This method is intended to be lightweight and makes no assumptions about whether the</div><div class="line"> * parent or child should be redrawn. Proper use of this method will include also making</div><div class="line"> * any appropriate &#123;<span class="doctag">@link</span> #requestLayout()&#125; or &#123;<span class="doctag">@link</span> #invalidate()&#125; calls.</div><div class="line"> * For example, callers can &#123;<span class="doctag">@link</span> #post(Runnable) post&#125; a &#123;<span class="doctag">@link</span> Runnable&#125;</div><div class="line"> * which performs a &#123;<span class="doctag">@link</span> #requestLayout()&#125; on the next frame, after all detach/attach</div><div class="line"> * calls are finished, causing layout to be run prior to redrawing the view hierarchy.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This method should be called only for views which were detached from their parent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child the child to attach</div><div class="line"> * <span class="doctag">@param</span> index the index at which the child should be attached</div><div class="line"> * <span class="doctag">@param</span> params the layout parameters of the child</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #removeDetachedView(View, boolean)</div><div class="line"> * <span class="doctag">@see</span> #detachAllViewsFromParent()</div><div class="line"> * <span class="doctag">@see</span> #detachViewFromParent(View)</div><div class="line"> * <span class="doctag">@see</span> #detachViewFromParent(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachViewToParent</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params)</span> </span>&#123;</div><div class="line">	child.mLayoutParams = params;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">		index = mChildrenCount;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 把该view添加到数组中，就像注释所说的为了能够让`getChildAt()`方法能获取到。</span></div><div class="line">	addInArray(child, index);</div><div class="line"></div><div class="line">	child.mParent = <span class="keyword">this</span>;</div><div class="line">	child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK</div><div class="line">					&amp; ~PFLAG_DRAWING_CACHE_VALID)</div><div class="line">			| PFLAG_DRAWN | PFLAG_INVALIDATED;</div><div class="line">	<span class="keyword">this</span>.mPrivateFlags |= PFLAG_INVALIDATED;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (child.hasFocus()) &#123;</div><div class="line">		requestChildFocus(child, child.findFocus());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>复用的处理看完后，我们看一下新创建的childView如何被添加到ListView上，我们看一下<code>addViewInLayout()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adds a view during layout. This is useful if in your onLayout() method,</div><div class="line"> * you need to add more views (as does the list view for example).</div><div class="line"> *</div><div class="line"> * If index is negative, it means put it at the end of the list.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child the view to add to the group</div><div class="line"> * <span class="doctag">@param</span> index the index at which the child must be added</div><div class="line"> * <span class="doctag">@param</span> params the layout parameters to associate with the child</div><div class="line"> * <span class="doctag">@param</span> preventRequestLayout if true, calling this method will not trigger a</div><div class="line"> *        layout request on child</div><div class="line"> * <span class="doctag">@return</span> true if the child was added, false otherwise</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">addViewInLayout</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params,</span></span></div><div class="line">		<span class="keyword">boolean</span> preventRequestLayout) &#123;</div><div class="line">	<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add a null child view to a ViewGroup"</span>);</div><div class="line">	&#125;</div><div class="line">	child.mParent = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 这个方法最终会调用addView方法添加childView</span></div><div class="line">	addViewInner(child, index, params, preventRequestLayout);</div><div class="line">	child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里已经把上面<code>fillFromTop()</code>方法的部分都分析完了。<br>不要忘了我们上面还留了一个TODO的部分，就是对于已经有数据的部分调用<code>fillSpecific()</code>方法，那我们就看一下他的实现:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Put a specific item at a specific location on the screen and then build</div><div class="line"> * up and down from there.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position The reference view to use as the starting point</div><div class="line"> * <span class="doctag">@param</span> top Pixel offset from the top of this view to the top of the</div><div class="line"> *        reference view.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The selected view, or null if the selected view is outside the</div><div class="line"> *         visible area.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillSpecific</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> top)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> tempIsSelected = position == mSelectedPosition;</div><div class="line">	View temp = makeAndAddView(position, top, <span class="keyword">true</span>, mListPadding.left, tempIsSelected);</div><div class="line">	<span class="comment">// Possibly changed again in fillUp if we add rows above this one.</span></div><div class="line">	mFirstPosition = position;</div><div class="line"></div><div class="line">	View above;</div><div class="line">	View below;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> dividerHeight = mDividerHeight;</div><div class="line">	<span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">		above = fillUp(position - <span class="number">1</span>, temp.getTop() - dividerHeight);</div><div class="line">		<span class="comment">// This will correct for the top of the first view not touching the top of the list</span></div><div class="line">		adjustViewsUpOrDown();</div><div class="line">		below = fillDown(position + <span class="number">1</span>, temp.getBottom() + dividerHeight);</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			correctTooHigh(childCount);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		below = fillDown(position + <span class="number">1</span>, temp.getBottom() + dividerHeight);</div><div class="line">		<span class="comment">// This will correct for the bottom of the last view not touching the bottom of the list</span></div><div class="line">		adjustViewsUpOrDown();</div><div class="line">		above = fillUp(position - <span class="number">1</span>, temp.getTop() - dividerHeight);</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			 correctTooLow(childCount);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tempIsSelected) &#123;</div><div class="line">		<span class="keyword">return</span> temp;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (above != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> above;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> below;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就像注释所说的它是让指定位置的View先加载到屏幕上，然后在加载该view往上以及往下位置的其他View，他里面会调用<code>fillUp()</code>和<code>fillDown()</code>方法，又会走上面的流程，所以这里就不分析了。</p>
<p>好了，到这里我们就基本已经分析完了，但是感觉好像好少了点什么？　　　</p>
<p>这里少了不是一点，是两点:      </p>
<ul>
<li>手势滑动过程中ListView的复用处理</li>
<li>RecycleBin中复用的具体实现</li>
</ul>
<p>一个个的来，先看一下手势滑动部分，这个当然是从<code>onTouchEvent()</code>方法看了，<br>手势这一块不太清楚的可以看我之前的一篇文章<br><a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/Android%20Touch%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E8%AF%A6%E8%A7%A3.md">Android Touch事件分发详解</a></p>
<p>发现<code>ListView</code>没有重写<code>onTouchEvent()</code>方法，这也好理解，因为<code>GridView</code>也有类似的滑动功能，所以去父类<code>AbsListView</code>中看.<br>我们看一下<code>AbsListView.onTouchEvent()</code>方法:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!isEnabled()) &#123;</div><div class="line">		<span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">		<span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">		<span class="keyword">return</span> isClickable() || isLongClickable();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mPositionScroller != <span class="keyword">null</span>) &#123;</div><div class="line">		mPositionScroller.stop();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mIsDetaching || !isAttachedToWindow()) &#123;</div><div class="line">		<span class="comment">// Something isn't right.</span></div><div class="line">		<span class="comment">// Since we rely on being attached to get data set change notifications,</span></div><div class="line">		<span class="comment">// don't risk doing anything where we might try to resync and find things</span></div><div class="line">		<span class="comment">// in a bogus state.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	startNestedScroll(SCROLL_AXIS_VERTICAL);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">boolean</span> intercepted = mFastScroll.onTouchEvent(ev);</div><div class="line">		<span class="keyword">if</span> (intercepted) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	initVelocityTrackerIfNotExists();</div><div class="line">	<span class="keyword">final</span> MotionEvent vtev = MotionEvent.obtain(ev);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = ev.getActionMasked();</div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		mNestedYOffset = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	vtev.offsetLocation(<span class="number">0</span>, mNestedYOffset);</div><div class="line">	<span class="keyword">switch</span> (actionMasked) &#123;</div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">			onTouchDown(ev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">		    <span class="comment">// 具体移动的部分就在这里了</span></div><div class="line">			onTouchMove(ev, vtev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">			onTouchUp(ev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">			onTouchCancel();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP: &#123;</div><div class="line">			onSecondaryPointerUp(ev);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> x = mMotionX;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> y = mMotionY;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">			<span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Remember where the motion event started</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = child.getTop();</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN: &#123;</div><div class="line">			<span class="comment">// New pointers take over dragging duties</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> index = ev.getActionIndex();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(index);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX(index);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(index);</div><div class="line">			mMotionCorrection = <span class="number">0</span>;</div><div class="line">			mActivePointerId = id;</div><div class="line">			mMotionX = x;</div><div class="line">			mMotionY = y;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">			<span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Remember where the motion event started</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = child.getTop();</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">		mVelocityTracker.addMovement(vtev);</div><div class="line">	&#125;</div><div class="line">	vtev.recycle();</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>onTouchMove()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTouchMove</span><span class="params">(MotionEvent ev, MotionEvent vtev)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">	<span class="keyword">if</span> (pointerIndex == -<span class="number">1</span>) &#123;</div><div class="line">		pointerIndex = <span class="number">0</span>;</div><div class="line">		mActivePointerId = ev.getPointerId(pointerIndex);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mDataChanged) &#123;</div><div class="line">		<span class="comment">// Re-sync everything if data has been changed</span></div><div class="line">		<span class="comment">// since the scroll operation can query the adapter.</span></div><div class="line">		layoutChildren();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(pointerIndex);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (mTouchMode) &#123;</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_DOWN:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_TAP:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_DONE_WAITING:</div><div class="line">			<span class="comment">// Check if we have moved far enough that it looks more like a</span></div><div class="line">			<span class="comment">// scroll than a tap. If so, we'll enter scrolling mode.</span></div><div class="line">			<span class="keyword">if</span> (startScrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev)) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Otherwise, check containment within list bounds. If we're</span></div><div class="line">			<span class="comment">// outside bounds, cancel any active presses.</span></div><div class="line">			<span class="keyword">final</span> View motionView = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(pointerIndex);</div><div class="line">			<span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">				setPressed(<span class="keyword">false</span>);</div><div class="line">				<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">					motionView.setPressed(<span class="keyword">false</span>);</div><div class="line">				&#125;</div><div class="line">				removeCallbacks(mTouchMode == TOUCH_MODE_DOWN ?</div><div class="line">						mPendingCheckForTap : mPendingCheckForLongPress);</div><div class="line">				mTouchMode = TOUCH_MODE_DONE_WAITING;</div><div class="line">				updateSelectorState();</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Still within bounds, update the hotspot.</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span>[] point = mTmpPoint;</div><div class="line">				point[<span class="number">0</span>] = x;</div><div class="line">				point[<span class="number">1</span>] = y;</div><div class="line">				transformPointToViewLocal(point, motionView);</div><div class="line">				motionView.drawableHotspotChanged(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_SCROLL:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_OVERSCROLL:</div><div class="line">			<span class="comment">// 滑动部分的处理，传入当前位置的x,y坐标</span></div><div class="line">			scrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>scrollIfNeeded()</code>方法的实现:　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrollIfNeeded</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, MotionEvent vtev)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> rawDeltaY = y - mMotionY;</div><div class="line">	<span class="keyword">int</span> scrollOffsetCorrection = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> scrollConsumedCorrection = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mLastY == Integer.MIN_VALUE) &#123;</div><div class="line">		rawDeltaY -= mMotionCorrection;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (dispatchNestedPreScroll(<span class="number">0</span>, mLastY != Integer.MIN_VALUE ? mLastY - y : -rawDeltaY,</div><div class="line">			mScrollConsumed, mScrollOffset)) &#123;</div><div class="line">		rawDeltaY += mScrollConsumed[<span class="number">1</span>];</div><div class="line">		scrollOffsetCorrection = -mScrollOffset[<span class="number">1</span>];</div><div class="line">		scrollConsumedCorrection = mScrollConsumed[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">			vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">			mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> deltaY = rawDeltaY;</div><div class="line">	<span class="keyword">int</span> incrementalDeltaY =</div><div class="line">			mLastY != Integer.MIN_VALUE ? y - mLastY + scrollConsumedCorrection : deltaY;</div><div class="line">	<span class="keyword">int</span> lastYCorrection = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mTouchMode == TOUCH_MODE_SCROLL) &#123;</div><div class="line">		<span class="keyword">if</span> (PROFILE_SCROLLING) &#123;</div><div class="line">			<span class="keyword">if</span> (!mScrollProfilingStarted) &#123;</div><div class="line">				Debug.startMethodTracing(<span class="string">"AbsListViewScroll"</span>);</div><div class="line">				mScrollProfilingStarted = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mScrollStrictSpan == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// If it's non-null, we're already in a scroll.</span></div><div class="line">			mScrollStrictSpan = StrictMode.enterCriticalSpan(<span class="string">"AbsListView-scroll"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">			<span class="comment">// 移动了</span></div><div class="line">			<span class="comment">// We may be here after stopping a fling and continuing to scroll.</span></div><div class="line">			<span class="comment">// If so, we haven't disallowed intercepting touch events yet.</span></div><div class="line">			<span class="comment">// Make sure that we do so in case we're in a parent that can intercept.</span></div><div class="line">			<span class="keyword">if</span> ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) == <span class="number">0</span> &amp;&amp;</div><div class="line">					Math.abs(rawDeltaY) &gt; mTouchSlop) &#123;</div><div class="line">				<span class="keyword">final</span> ViewParent parent = getParent();</div><div class="line">				<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">					parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionIndex;</div><div class="line">			<span class="keyword">if</span> (mMotionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				motionIndex = mMotionPosition - mFirstPosition;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// If we don't have a motion position that we can reliably track,</span></div><div class="line">				<span class="comment">// pick something in the middle to make a best guess at things below.</span></div><div class="line">				motionIndex = getChildCount() / <span class="number">2</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> motionViewPrevTop = <span class="number">0</span>;</div><div class="line">			View motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">			<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				motionViewPrevTop = motionView.getTop();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// No need to do all this work if we're not going to move anyway</span></div><div class="line">			<span class="keyword">boolean</span> atEdge = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">			    <span class="comment">// 移动的过程中不断调用</span></div><div class="line">				atEdge = trackMotionScroll(deltaY, incrementalDeltaY);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Check to see if we have bumped into the scroll limit</span></div><div class="line">			motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">			<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Check if the top of the motion view is where it is</span></div><div class="line">				<span class="comment">// supposed to be</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> motionViewRealTop = motionView.getTop();</div><div class="line">				<span class="keyword">if</span> (atEdge) &#123;</div><div class="line">					<span class="comment">// Apply overscroll</span></div><div class="line"></div><div class="line">					<span class="keyword">int</span> overscroll = -incrementalDeltaY -</div><div class="line">							(motionViewRealTop - motionViewPrevTop);</div><div class="line">					<span class="keyword">if</span> (dispatchNestedScroll(<span class="number">0</span>, overscroll - incrementalDeltaY, <span class="number">0</span>, overscroll,</div><div class="line">							mScrollOffset)) &#123;</div><div class="line">						lastYCorrection -= mScrollOffset[<span class="number">1</span>];</div><div class="line">						<span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">							vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">							mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">boolean</span> atOverscrollEdge = overScrollBy(<span class="number">0</span>, overscroll,</div><div class="line">								<span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">						<span class="keyword">if</span> (atOverscrollEdge &amp;&amp; mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Don't allow overfling if we're at the edge</span></div><div class="line">							mVelocityTracker.clear();</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">						<span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">								(overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">										!contentFits())) &#123;</div><div class="line">							<span class="keyword">if</span> (!atOverscrollEdge) &#123;</div><div class="line">								mDirection = <span class="number">0</span>; <span class="comment">// Reset when entering overscroll.</span></div><div class="line">								mTouchMode = TOUCH_MODE_OVERSCROLL;</div><div class="line">							&#125;</div><div class="line">							<span class="keyword">if</span> (incrementalDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">								mEdgeGlowTop.onPull((<span class="keyword">float</span>) -overscroll / getHeight(),</div><div class="line">										(<span class="keyword">float</span>) x / getWidth());</div><div class="line">								<span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">									mEdgeGlowBottom.onRelease();</div><div class="line">								&#125;</div><div class="line">								invalidate(<span class="number">0</span>, <span class="number">0</span>, getWidth(),</div><div class="line">										mEdgeGlowTop.getMaxHeight() + getPaddingTop());</div><div class="line">							&#125; <span class="keyword">else</span> <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">								mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overscroll / getHeight(),</div><div class="line">										<span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">								<span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">									mEdgeGlowTop.onRelease();</div><div class="line">								&#125;</div><div class="line">								invalidate(<span class="number">0</span>, getHeight() - getPaddingBottom() -</div><div class="line">										mEdgeGlowBottom.getMaxHeight(), getWidth(),</div><div class="line">										getHeight());</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				mMotionY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">			&#125;</div><div class="line">			mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_OVERSCROLL) &#123;</div><div class="line">	    <span class="comment">// 灰起了.</span></div><div class="line">		<span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> oldScroll = mScrollY;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> newScroll = oldScroll - incrementalDeltaY;</div><div class="line">			<span class="keyword">int</span> newDirection = y &gt; mLastY ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mDirection == <span class="number">0</span>) &#123;</div><div class="line">				mDirection = newDirection;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> overScrollDistance = -incrementalDeltaY;</div><div class="line">			<span class="keyword">if</span> ((newScroll &lt; <span class="number">0</span> &amp;&amp; oldScroll &gt;= <span class="number">0</span>) || (newScroll &gt; <span class="number">0</span> &amp;&amp; oldScroll &lt;= <span class="number">0</span>)) &#123;</div><div class="line">				overScrollDistance = -oldScroll;</div><div class="line">				incrementalDeltaY += overScrollDistance;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				incrementalDeltaY = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (overScrollDistance != <span class="number">0</span>) &#123;</div><div class="line">				overScrollBy(<span class="number">0</span>, overScrollDistance, <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">						<span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">				<span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">						(overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">								!contentFits())) &#123;</div><div class="line">					<span class="keyword">if</span> (rawDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">						mEdgeGlowTop.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">								(<span class="keyword">float</span>) x / getWidth());</div><div class="line">						<span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">							mEdgeGlowBottom.onRelease();</div><div class="line">						&#125;</div><div class="line">						invalidate(<span class="number">0</span>, <span class="number">0</span>, getWidth(),</div><div class="line">								mEdgeGlowTop.getMaxHeight() + getPaddingTop());</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">						mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">								<span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">						<span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">							mEdgeGlowTop.onRelease();</div><div class="line">						&#125;</div><div class="line">						invalidate(<span class="number">0</span>, getHeight() - getPaddingBottom() -</div><div class="line">								mEdgeGlowBottom.getMaxHeight(), getWidth(),</div><div class="line">								getHeight());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Coming back to 'real' list scrolling</span></div><div class="line">				<span class="keyword">if</span> (mScrollY != <span class="number">0</span>) &#123;</div><div class="line">					mScrollY = <span class="number">0</span>;</div><div class="line">					invalidateParentIfNeeded();</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 继续处理着</span></div><div class="line">				trackMotionScroll(incrementalDeltaY, incrementalDeltaY);</div><div class="line"></div><div class="line">				mTouchMode = TOUCH_MODE_SCROLL;</div><div class="line"></div><div class="line">				<span class="comment">// We did not scroll the full amount. Treat this essentially like the</span></div><div class="line">				<span class="comment">// start of a new touch scroll</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = findClosestMotionRow(y);</div><div class="line"></div><div class="line">				mMotionCorrection = <span class="number">0</span>;</div><div class="line">				View motionView = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = motionView != <span class="keyword">null</span> ? motionView.getTop() : <span class="number">0</span>;</div><div class="line">				mMotionY =  y + scrollOffsetCorrection;</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">			mDirection = newDirection;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这部分代码逻辑牵扯太多，有点晕呼呼的，记着看一下<code>trackMotionScroll()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Track a motion scroll</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> deltaY Amount to offset mMotionView. This is the accumulated delta since the motion</div><div class="line"> *        began. Positive numbers mean the user's finger is moving down the screen.</div><div class="line"> * <span class="doctag">@param</span> incrementalDeltaY Change in deltaY from the previous event. 通过它的正负来判断是向上还是向下。</div><div class="line"> * <span class="doctag">@return</span> true if we're already at the beginning/end of the list and have nothing to do.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">trackMotionScroll</span><span class="params">(<span class="keyword">int</span> deltaY, <span class="keyword">int</span> incrementalDeltaY)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">	<span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> firstTop = getChildAt(<span class="number">0</span>).getTop();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> lastBottom = getChildAt(childCount - <span class="number">1</span>).getBottom();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect listPadding = mListPadding;</div><div class="line"></div><div class="line">	<span class="comment">// "effective padding" In this case is the amount of padding that affects</span></div><div class="line">	<span class="comment">// how much space should not be filled by items. If we don't clip to padding</span></div><div class="line">	<span class="comment">// there is no effective padding.</span></div><div class="line">	<span class="keyword">int</span> effectivePaddingTop = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> effectivePaddingBottom = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">		effectivePaddingTop = listPadding.top;</div><div class="line">		effectivePaddingBottom = listPadding.bottom;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">// FIXME account for grid vertical spacing too?</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> spaceAbove = effectivePaddingTop - firstTop;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> end = getHeight() - effectivePaddingBottom;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> spaceBelow = lastBottom - end;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - mPaddingBottom - mPaddingTop;</div><div class="line">	<span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">		deltaY = Math.max(-(height - <span class="number">1</span>), deltaY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		deltaY = Math.min(height - <span class="number">1</span>, deltaY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">		incrementalDeltaY = Math.max(-(height - <span class="number">1</span>), incrementalDeltaY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		incrementalDeltaY = Math.min(height - <span class="number">1</span>, incrementalDeltaY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line"></div><div class="line">	<span class="comment">// Update our guesses for where the first and last views are</span></div><div class="line">	<span class="keyword">if</span> (firstPosition == <span class="number">0</span>) &#123;</div><div class="line">		mFirstPositionDistanceGuess = firstTop - listPadding.top;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mFirstPositionDistanceGuess += incrementalDeltaY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (firstPosition + childCount == mItemCount) &#123;</div><div class="line">		mLastPositionDistanceGuess = lastBottom + listPadding.bottom;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mLastPositionDistanceGuess += incrementalDeltaY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollDown = (firstPosition == <span class="number">0</span> &amp;&amp;</div><div class="line">			firstTop &gt;= listPadding.top &amp;&amp; incrementalDeltaY &gt;= <span class="number">0</span>);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollUp = (firstPosition + childCount == mItemCount &amp;&amp;</div><div class="line">			lastBottom &lt;= getHeight() - listPadding.bottom &amp;&amp; incrementalDeltaY &lt;= <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (cannotScrollDown || cannotScrollUp) &#123;</div><div class="line">		<span class="keyword">return</span> incrementalDeltaY != <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 判断向上还是向下</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = isInTouchMode();</div><div class="line">	<span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">		hideSelector();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> headerViewsCount = getHeaderViewsCount();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> footerViewsStart = mItemCount - getFooterViewsCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (down) &#123;</div><div class="line">		<span class="keyword">int</span> top = -incrementalDeltaY;</div><div class="line">		<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">			top += listPadding.top;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getBottom() &gt;= top) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			    <span class="comment">// 如果这个View的底部位置已经小于top值了，说明这个view已经移除屏幕了，不可见了</span></div><div class="line">				count++;</div><div class="line">				<span class="keyword">int</span> position = firstPosition + i;</div><div class="line">				<span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">					<span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">					<span class="comment">// system-managed transient state.</span></div><div class="line">					child.clearAccessibilityFocus();</div><div class="line">					<span class="comment">// 只要该view移除屏幕就把该view添加到废弃的缓存中</span></div><div class="line">					mRecycler.addScrapView(child, position);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">int</span> bottom = getHeight() - incrementalDeltaY;</div><div class="line">		<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">			bottom -= listPadding.bottom;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getTop() &lt;= bottom) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				start = i;</div><div class="line">				count++;</div><div class="line">				<span class="keyword">int</span> position = firstPosition + i;</div><div class="line">				<span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">					<span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">					<span class="comment">// system-managed transient state.</span></div><div class="line">					child.clearAccessibilityFocus();</div><div class="line">					mRecycler.addScrapView(child, position);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mMotionViewNewTop = mMotionViewOriginalTop + deltaY;</div><div class="line"></div><div class="line">	mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="comment">// count记录了当前已经移除屏幕的view个数</span></div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">	    <span class="comment">// 把已经移除的View从ViewGroup总detach掉</span></div><div class="line">		detachViewsFromParent(start, count);</div><div class="line">		mRecycler.removeSkippedScrap();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// invalidate before moving the children to avoid unnecessary invalidate</span></div><div class="line">	<span class="comment">// calls to bubble up from the children all the way to the top</span></div><div class="line">	<span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">	   invalidate();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 这个方法让所有的子view都按照这个参数的距离大小进行改变，这样就实现了移动也就是滑动的功能。</span></div><div class="line">	offsetChildrenTopAndBottom(incrementalDeltaY);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (down) &#123;</div><div class="line">		mFirstPosition += count;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> absIncrementalDeltaY = Math.abs(incrementalDeltaY);</div><div class="line">	<span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) &#123;</div><div class="line">	    <span class="comment">// 第一个View的顶部移入了屏幕或者最后一个View的底部移入了屏幕</span></div><div class="line">		fillGap(down);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!inTouchMode &amp;&amp; mSelectedPosition != INVALID_POSITION) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectedPosition - mFirstPosition;</div><div class="line">		<span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">			positionSelector(mSelectedPosition, getChildAt(childIndex));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectorPosition - mFirstPosition;</div><div class="line">		<span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">			positionSelector(INVALID_POSITION, getChildAt(childIndex));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mSelectorRect.setEmpty();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	invokeOnItemScrollListener();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>offsetChildrenTopAndBottom()</code>方法的，在<code>AbsListView</code>中没有重写该方法，具体要看其父类<code>ViewGroup</code>中的实现:       `<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Offset the vertical location of all children of this view by the specified number of pixels.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> offset the number of pixels to offset</div><div class="line"> *</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offsetChildrenTopAndBottom</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">boolean</span> invalidate = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">	    <span class="comment">// 把所有的view都移动指定的距离</span></div><div class="line">		<span class="keyword">final</span> View v = children[i];</div><div class="line">		v.mTop += offset;</div><div class="line">		v.mBottom += offset;</div><div class="line">		<span class="keyword">if</span> (v.mRenderNode != <span class="keyword">null</span>) &#123;</div><div class="line">			invalidate = <span class="keyword">true</span>;</div><div class="line">			v.mRenderNode.offsetTopAndBottom(offset);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (invalidate) &#123;</div><div class="line">		invalidateViewProperty(<span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">	notifySubtreeAccessibilityStateChangedIfNeeded();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>fillGap()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the gap left open by a touch-scroll. During a touch scroll, children that</div><div class="line"> * remain on screen are shifted and the other ones are discarded. The role of this</div><div class="line"> * method is to fill the gap thus created by performing a partial layout in the</div><div class="line"> * empty space.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> down true if the scroll is going down, false if it is going up</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span></span>;</div></pre></td></tr></table></figure></p>
<p>发现在<code>AbsListView</code>中该方法是抽象的，所以我们要再<code>ListView</code>中找一下他的具体实现类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">    <span class="keyword">if</span> (down) &#123;</div><div class="line">        <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            paddingTop = getListPaddingTop();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(count - <span class="number">1</span>).getBottom() + mDividerHeight :</div><div class="line">                paddingTop;</div><div class="line">        fillDown(mFirstPosition + count, startOffset);</div><div class="line">        correctTooHigh(getChildCount());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            paddingBottom = getListPaddingBottom();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</div><div class="line">                getHeight() - paddingBottom;</div><div class="line">        fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</div><div class="line">        correctTooLow(getChildCount());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到他会分别根据向下滑动还是向上滑动去调用<code>fillDown</code>和<code>fillUp</code>两个方法，这两个方法之前我们都分析过了，就不再继续看了。</p>
<p>到这里基本就把滑动部分的处理都看完了。<br>还剩最后一个问题就是<code>RecycleBin</code>的实现,他是<code>AbsListView</code>中的一个内部类。</p>
<p>直接上代码了，他的注释也说的非常清楚，我就把不好理解的地方简单说一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The RecycleBin facilitates reuse of views across layouts. The RecycleBin has two levels of</div><div class="line"> * storage: ActiveViews and ScrapViews. ActiveViews are those views which were onscreen at the</div><div class="line"> * start of a layout. By construction, they are displaying current information. At the end of</div><div class="line"> * layout, all views in ActiveViews are demoted to ScrapViews. ScrapViews are old views that</div><div class="line"> * could potentially be used by the adapter to avoid allocating views unnecessarily.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> android.widget.AbsListView#setRecyclerListener(android.widget.AbsListView.RecyclerListener)</div><div class="line"> * <span class="doctag">@see</span> android.widget.AbsListView.RecyclerListener</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecycleBin</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> RecyclerListener mRecyclerListener;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * The position of the first view stored in mActiveViews.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mFirstActivePosition;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Views that were on screen at the start of layout. This array is populated at the start of</div><div class="line">	 * layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.</div><div class="line">	 * Views in mActiveViews represent a contiguous range of Views, with position of the first</div><div class="line">	 * view store in mFirstActivePosition.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> View[] mActiveViews = <span class="keyword">new</span> View[<span class="number">0</span>];</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 为什么是个数组呢？因为ListView会有多种不同的ViewType啊。</div><div class="line">	 * Unsorted views that can be used by the adapter as a convert view.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mViewTypeCount;</div><div class="line">	<span class="comment">// mScrapViews数组中的第一个元素，方便在ViewType是1的时候使用</span></div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt; mCurrentScrap;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt; mSkippedScrap;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> SparseArray&lt;View&gt; mTransientStateViews;</div><div class="line">	<span class="keyword">private</span> LongSparseArray&lt;View&gt; mTransientStateViewsById;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewTypeCount</span><span class="params">(<span class="keyword">int</span> viewTypeCount)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (viewTypeCount &lt; <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't have a viewTypeCount &lt; 1"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 根据ViewType的数量来创建，因为ViewType可以有多中类型，每种不同类型的View肯定要分开单独进行缓存和复用的。</span></div><div class="line">		<span class="comment">//noinspection unchecked</span></div><div class="line">		ArrayList&lt;View&gt;[] scrapViews = <span class="keyword">new</span> ArrayList[viewTypeCount];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; i++) &#123;</div><div class="line">			scrapViews[i] = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">		&#125;</div><div class="line">		mViewTypeCount = viewTypeCount;</div><div class="line">		mCurrentScrap = scrapViews[<span class="number">0</span>];</div><div class="line">		mScrapViews = scrapViews;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 方法名说明了一切</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markChildrenDirty</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">				scrap.get(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">					scrap.get(j).forceLayout();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViews.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">				mTransientStateViews.valueAt(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViewsById.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">				mTransientStateViewsById.valueAt(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldRecycleViewType</span><span class="params">(<span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewType &gt;= <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Clears the scrap heap.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			clearScrap(scrap);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				clearScrap(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		clearTransientStateViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Fill ActiveViews with all of the children of the AbsListView.</div><div class="line">	 * 将View存储到mActiveViews数组中</div><div class="line">	 * <span class="doctag">@param</span> childCount The minimum number of views mActiveViews should hold</div><div class="line">	 * <span class="doctag">@param</span> firstActivePosition The position of the first view that will be stored in</div><div class="line">	 *        mActiveViews</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fillActiveViews</span><span class="params">(<span class="keyword">int</span> childCount, <span class="keyword">int</span> firstActivePosition)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mActiveViews.length &lt; childCount) &#123;</div><div class="line">			mActiveViews = <span class="keyword">new</span> View[childCount];</div><div class="line">		&#125;</div><div class="line">		mFirstActivePosition = firstActivePosition;</div><div class="line"></div><div class="line">		<span class="comment">//noinspection MismatchedReadAndWriteOfArray</span></div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			View child = getChildAt(i);</div><div class="line">			AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">			<span class="comment">// Don't put header or footer views into the scrap heap</span></div><div class="line">			<span class="keyword">if</span> (lp != <span class="keyword">null</span> &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">				<span class="comment">// Note:  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</span></div><div class="line">				<span class="comment">//        However, we will NOT place them into scrap views.</span></div><div class="line">				activeViews[i] = child;</div><div class="line">				<span class="comment">// Remember the position so that setupChild() doesn't reset state.</span></div><div class="line">				lp.scrappedFromPosition = firstActivePosition + i;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the view corresponding to the specified position. The view will be removed from</div><div class="line">	 * mActiveViews if it is found.注释说了获取完之后就会从mActiveViews中移除，这是很好理解的</div><div class="line">	 * 因为获取了就是说这个View已经显示到当前的ListView中了，肯定不能再复用他了。</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> position The position to look up in mActiveViews</div><div class="line">	 * <span class="doctag">@return</span> The view if it is found, null otherwise</div><div class="line">	 */</div><div class="line">	<span class="function">View <span class="title">getActiveView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> index = position - mFirstActivePosition;</div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">if</span> (index &gt;=<span class="number">0</span> &amp;&amp; index &lt; activeViews.length) &#123;</div><div class="line">			<span class="keyword">final</span> View match = activeViews[index];</div><div class="line">			activeViews[index] = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">return</span> match;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">View <span class="title">getTransientStateView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds &amp;&amp; mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">			View result = mTransientStateViewsById.get(id);</div><div class="line">			mTransientStateViewsById.remove(id);</div><div class="line">			<span class="keyword">return</span> result;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> index = mTransientStateViews.indexOfKey(position);</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">				View result = mTransientStateViews.valueAt(index);</div><div class="line">				mTransientStateViews.removeAt(index);</div><div class="line">				<span class="keyword">return</span> result;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Dumps and fully detaches any currently saved views with transient</div><div class="line">	 * state.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clearTransientStateViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> SparseArray&lt;View&gt; viewsByPos = mTransientStateViews;</div><div class="line">		<span class="keyword">if</span> (viewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = viewsByPos.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">				removeDetachedView(viewsByPos.valueAt(i), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">			viewsByPos.clear();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LongSparseArray&lt;View&gt; viewsById = mTransientStateViewsById;</div><div class="line">		<span class="keyword">if</span> (viewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = viewsById.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">				removeDetachedView(viewsById.valueAt(i), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">			viewsById.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 从废弃View的缓存中获取，只要移动出屏幕之后就都会被加到废弃View的缓存中 </div><div class="line">	 * <span class="doctag">@return</span> A view from the ScrapViews collection. These are unordered.</div><div class="line">	 */</div><div class="line">	<span class="function">View <span class="title">getScrapView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> retrieveFromScrap(mCurrentScrap, position);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> whichScrap = mAdapter.getItemViewType(position);</div><div class="line">			<span class="keyword">if</span> (whichScrap &gt;= <span class="number">0</span> &amp;&amp; whichScrap &lt; mScrapViews.length) &#123;</div><div class="line">				<span class="keyword">return</span> retrieveFromScrap(mScrapViews[whichScrap], position);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Puts a view into the list of scrap views.</div><div class="line">	 * &lt;p&gt;</div><div class="line">	 * If the list data hasn't changed or the adapter has stable IDs, views</div><div class="line">	 * with transient state will be preserved for later retrieval.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> scrap The view to add</div><div class="line">	 * <span class="doctag">@param</span> position The view's position within its parent</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addScrapView</span><span class="params">(View scrap, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</div><div class="line">		<span class="keyword">if</span> (lp == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		lp.scrappedFromPosition = position;</div><div class="line"></div><div class="line">		<span class="comment">// Remove but don't scrap header or footer views, or views that</span></div><div class="line">		<span class="comment">// should otherwise not be recycled.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> viewType = lp.viewType;</div><div class="line">		<span class="keyword">if</span> (!shouldRecycleViewType(viewType)) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		scrap.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">		<span class="comment">// The the accessibility state of the view may change while temporary</span></div><div class="line">		<span class="comment">// detached and we do not allow detached views to fire accessibility</span></div><div class="line">		<span class="comment">// events. So we are announcing that the subtree changed giving a chance</span></div><div class="line">		<span class="comment">// to clients holding on to a view in this subtree to refresh it.</span></div><div class="line">		notifyViewAccessibilityStateChangedIfNeeded(</div><div class="line">				AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);</div><div class="line">		</div><div class="line">		<span class="comment">// 对一些瞬态View的处理</span></div><div class="line">		<span class="comment">// Don't scrap views that have transient state.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();</div><div class="line">		<span class="keyword">if</span> (scrapHasTransientState) &#123;</div><div class="line">			<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">				<span class="comment">// If the adapter has stable IDs, we can reuse the view for</span></div><div class="line">				<span class="comment">// the same data.</span></div><div class="line">				<span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">					mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mTransientStateViewsById.put(lp.itemId, scrap);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">				<span class="comment">// If the data hasn't changed, we can reuse the views at</span></div><div class="line">				<span class="comment">// their old positions.</span></div><div class="line">				<span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">					mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mTransientStateViews.put(position, scrap);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Otherwise, we'll have to remove the view and start over.</span></div><div class="line">				<span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">					mSkippedScrap = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mSkippedScrap.add(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">				mCurrentScrap.add(scrap);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				mScrapViews[viewType].add(scrap);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mRecyclerListener != <span class="keyword">null</span>) &#123;</div><div class="line">				mRecyclerListener.onMovedToScrapHeap(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Finish the removal of any views that skipped the scrap heap.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeSkippedScrap</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mSkippedScrap.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			removeDetachedView(mSkippedScrap.get(i), <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		mSkippedScrap.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Move all views remaining in mActiveViews to mScrapViews.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">scrapActiveViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> hasListener = mRecyclerListener != <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> multipleScraps = mViewTypeCount &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line">		ArrayList&lt;View&gt; scrapViews = mCurrentScrap;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">			<span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> AbsListView.LayoutParams lp</div><div class="line">						= (AbsListView.LayoutParams) victim.getLayoutParams();</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> whichScrap = lp.viewType;</div><div class="line"></div><div class="line">				activeViews[i] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (victim.hasTransientState()) &#123;</div><div class="line">					<span class="comment">// Store views with transient state for later use.</span></div><div class="line">					victim.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">						<span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">							mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">						&#125;</div><div class="line">						<span class="keyword">long</span> id = mAdapter.getItemId(mFirstActivePosition + i);</div><div class="line">						mTransientStateViewsById.put(id, victim);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">						<span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">							mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">						&#125;</div><div class="line">						mTransientStateViews.put(mFirstActivePosition + i, victim);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">						<span class="comment">// The data has changed, we can't keep this view.</span></div><div class="line">						removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!shouldRecycleViewType(whichScrap)) &#123;</div><div class="line">					<span class="comment">// Discard non-recyclable views except headers/footers.</span></div><div class="line">					<span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">						removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Store everything else on the appropriate scrap heap.</span></div><div class="line">					<span class="keyword">if</span> (multipleScraps) &#123;</div><div class="line">						scrapViews = mScrapViews[whichScrap];</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					victim.dispatchStartTemporaryDetach();</div><div class="line">					lp.scrappedFromPosition = mFirstActivePosition + i;</div><div class="line">					scrapViews.add(victim);</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (hasListener) &#123;</div><div class="line">						mRecyclerListener.onMovedToScrapHeap(victim);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		pruneScrapViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Makes sure that the size of mScrapViews does not exceed the size of</div><div class="line">	 * mActiveViews, which can happen if an adapter does not recycle its</div><div class="line">	 * views. Removes cached transient state views that no longer have</div><div class="line">	 * transient state.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneScrapViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> maxViews = mActiveViews.length;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">			<span class="keyword">int</span> size = scrapPile.size();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> extras = size - maxViews;</div><div class="line">			size--;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; extras; j++) &#123;</div><div class="line">				removeDetachedView(scrapPile.remove(size--), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> SparseArray&lt;View&gt; transViewsByPos = mTransientStateViews;</div><div class="line">		<span class="keyword">if</span> (transViewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsByPos.size(); i++) &#123;</div><div class="line">				<span class="keyword">final</span> View v = transViewsByPos.valueAt(i);</div><div class="line">				<span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">					removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">					transViewsByPos.removeAt(i);</div><div class="line">					i--;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LongSparseArray&lt;View&gt; transViewsById = mTransientStateViewsById;</div><div class="line">		<span class="keyword">if</span> (transViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsById.size(); i++) &#123;</div><div class="line">				<span class="keyword">final</span> View v = transViewsById.valueAt(i);</div><div class="line">				<span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">					removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">					transViewsById.removeAt(i);</div><div class="line">					i--;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Puts all views in the scrap heap into the supplied list.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reclaimScrapViews</span><span class="params">(List&lt;View&gt; views)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			views.addAll(mCurrentScrap);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">				views.addAll(scrapPile);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Updates the cache color hint of all known views.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> color The new cache color hint.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setCacheColorHint</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">				scrap.get(i).setDrawingCacheBackgroundColor(color);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">					scrap.get(j).setDrawingCacheBackgroundColor(color);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Just in case this is called during a layout pass</span></div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">			<span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">			<span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">				victim.setDrawingCacheBackgroundColor(color);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">retrieveFromScrap</span><span class="params">(ArrayList&lt;View&gt; scrapViews, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> size = scrapViews.size();</div><div class="line">		<span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// See if we still have a view for this position or ID.</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">				<span class="keyword">final</span> View view = scrapViews.get(i);</div><div class="line">				<span class="keyword">final</span> AbsListView.LayoutParams params =</div><div class="line">						(AbsListView.LayoutParams) view.getLayoutParams();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (mAdapterHasStableIds) &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">					<span class="keyword">if</span> (id == params.itemId) &#123;</div><div class="line">						<span class="keyword">return</span> scrapViews.remove(i);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.scrappedFromPosition == position) &#123;</div><div class="line">					<span class="keyword">final</span> View scrap = scrapViews.remove(i);</div><div class="line">					clearAccessibilityFromScrap(scrap);</div><div class="line">					<span class="keyword">return</span> scrap;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">final</span> View scrap = scrapViews.remove(size - <span class="number">1</span>);</div><div class="line">			clearAccessibilityFromScrap(scrap);</div><div class="line">			<span class="keyword">return</span> scrap;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearScrap</span><span class="params">(<span class="keyword">final</span> ArrayList&lt;View&gt; scrap)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">			removeDetachedView(scrap.remove(scrapCount - <span class="number">1</span> - j), <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAccessibilityFromScrap</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">		view.clearAccessibilityFocus();</div><div class="line">		view.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeDetachedView</span><span class="params">(View child, <span class="keyword">boolean</span> animate)</span> </span>&#123;</div><div class="line">		child.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">		AbsListView.<span class="keyword">this</span>.removeDetachedView(child, animate);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到此为止。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/ListView源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-RxJava详解(上)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/RxJava详解(上)/">RxJava详解(上)</a>
    </h1>
  

        
        <a href="/2015/01/01/RxJava详解(上)/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RxJava详解-上"><a href="#RxJava详解-上" class="headerlink" title="RxJava详解(上)"></a>RxJava详解(上)</h1><p>年初的时候就想学习下<code>RxJava</code>然后写一些<code>RxJava</code>的教程，无奈发现已经年底了，然而我还么有写。今天有点时间，特别是发布了<code>RxJava 2.0</code>后，我决定动笔开始。</p>
<p>现在<code>RxJava</code>变的越来越流行了，很多项目中都使用了它。特别是大神<code>JakeWharton</code>等的加入，以及<code>RxBinding、Retrofit、RxLifecycle</code>等众多项目的，然开发越来越方便，但是上手比较难，不过一旦你入门后你就会发现真是太棒了。</p>
<h2 id="RxJava简介"><a href="#RxJava简介" class="headerlink" title="RxJava简介"></a><code>RxJava</code>简介</h2><p>在介绍<code>RxJava</code>之前先说一下<code>Rx</code>。<code>Rx</code>的全称是<code>Reactive Extensions</code>，直译过来就是响应式扩展。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rx_logo.png?raw=true" alt="image"></p>
<p><code>Rx</code>基于观察者模式，它是一种编程模型，目标是提供一致的编程接口，帮助开发者更方便的处理异步数据流。<code>ReactiveX.io</code>给的定义是，<code>Rx</code>是一个使用可观察数据流进行异步编程的编程接口，<code>ReactiveX</code>结合了观察者模式、迭代器模式和函数式编程的精华。<code>Rx</code>已经渗透到了各个语言中，有了<code>Rx</code>所以才有了<code>RxJava</code>、<code>Rx.NET</code>、<code>RxJS</code>、<code>RxSwift</code>、<code>Rx.rb</code>、<code>RxPHP</code>等等，</p>
<p>这里先列举一下相关的官网:  </p>
<ul>
<li><a href="http://reactivex.io/" target="_blank" rel="external">Rx</a></li>
<li><a href="https://github.com/ReactiveX/RxJava">RxJava</a>       </li>
<li><a href="https://github.com/ReactiveX/RxAndroid">RxAndroid</a></li>
</ul>
<p><code>RxJava</code>在<code>GitHub</code>上的介绍是：<code>a library for composing asynchronous and event-based programs by using observable sequences for the Java VM.</code><br>翻译过来也就是一个基于事件和程序在<code>Java VM</code>上使用可观测的序列来组成异步的库。<code>RxJava</code>的本质就是一个实现异步操作的库，它的优势就是简洁，随着程序逻辑变得越来越复杂，它依然能够保持简洁。       </p>
<p>其实一句话总结一下<code>RxJava</code>的作用就是：异步   </p>
<p>这里可能会有人想不就是个异步吗，至于辣么矫情么?用<code>AsyncTask</code>、<code>Handler</code>甚至自定义一个<code>BigAsyncTask</code>分分钟搞定。</p>
<p>但是<code>RxJava</code>的好处是简洁。异步操作很关键的一点是程序的简洁性，因为在调度过程比较复杂的情况下，异步代码经常会既难写也难被读懂。 <code>Android</code>创造的<code>AsyncTask</code>和<code>Handler</code>其实都是为了让异步代码更加简洁。虽然<code>RxJava</code>的优势也是简洁，但它的简洁的与众不同之处在于，随着程序逻辑变得越来越复杂，它依然能够保持简洁。</p>
<p>####扩展的观察者模式</p>
<p><code>RxJava</code>的异步实现，是通过一种扩展的观察者模式来实现的。</p>
<p>观察者模式面向的需求是：<code>A</code>对象（观察者）对<code>B</code>对象（被观察者）的某种变化高度敏感，需要在<code>B</code>变化的一瞬间做出反应。举个例子，新闻里喜闻乐见的警察抓小偷，警察需要在小偷伸手作案的时候实施抓捕。在这个例子里，警察是观察者，小偷是被观察者，警察需要时刻盯着小偷的一举一动，才能保证不会漏过任何瞬间。程序的观察者模式和这种真正的『观察』略有不同，观察者不需要时刻盯着被观察者（例如<code>A</code>不需要每过<code>2ms</code>就检查一次<code>B</code>的状态），而是采用注册(<code>Register</code>)或者称为订阅(<code>Subscribe</code>)的方式，告诉被观察者：我需要你的某某状态，你要在它变化的时候通知我。 <code>Android</code>开发中一个比较典型的例子是点击监听器<code>OnClickListener</code>。对设置<code>OnClickListener</code>来说，<code>View</code>是被观察者，<code>OnClickListener</code>是观察者，二者通过 <code>setOnClickListener()</code>方法达成订阅关系。订阅之后用户点击按钮的瞬间，<code>Android Framework</code>就会将点击事件发送给已经注册的<code>OnClickListener</code>。采取这样被动的观察方式，既省去了反复检索状态的资源消耗，也能够得到最高的反馈速度。当然，这也得益于我们可以随意定制自己程序中的观察者和被观察者，而警察叔叔明显无法要求小偷『你在作案的时候务必通知我』。</p>
<p><code>OnClickListener</code>的模式大致如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/btn_onclick.jpg?raw=true" alt="image"></p>
<p>如图所示，通过<code>setOnClickListener()</code>方法，<code>Button</code>持有<code>OnClickListener</code>的引用（这一过程没有在图上画出）；当用户点击时，<code>Button</code>自动调用<code>OnClickListener</code>的<code>onClick()</code> 方法。另外，如果把这张图中的概念抽象出来（<code>Button</code> -&gt; 被观察者、<code>OnClickListener</code> -&gt; 观察者、<code>setOnClickListener()</code> -&gt; 订阅，<code>onClick()</code> -&gt; 事件），就由专用的观察者模式（例如只用于监听控件点击）转变成了通用的观察者模式。如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/btn_rxjava_observable.jpg?raw=true" alt="image"></p>
<p>而<code>RxJava</code>作为一个工具库，使用的就是通用形式的观察者模式。</p>
<p>####<code>RxJava</code>的观察者模式</p>
<p><code>RxJava</code>的基本概念：</p>
<ul>
<li><code>Observable</code>(可观察者，即被观察者)、 </li>
<li><code>Observer</code>(观察者)、 </li>
<li><code>subscribe()</code>(订阅)、事件。<br>  <code>Observable</code>和<code>Observer</code>通过<code>subscribe()</code> 方法实现订阅关系，从而<code>Observable</code>可以在需要的时候发出事件来通知<code>Observer</code>。</li>
</ul>
<p>与传统观察者模式不同，<code>RxJava</code>的事件回调方法除了普通事件<code>onNext()</code>(相当于<code>onClick()</code>/<code>onEvent()</code>)之外，还定义了两个特殊的事件：<code>onCompleted()</code>和<code>onError()</code>:<br>但是<code>RxJava</code>与传统的观察者设计模式有一点明显不同，那就是如果一个<code>Observerble</code>没有任何的的<code>Subscriber</code>，那么这个<code>Observable</code>是不会发出任何事件的。</p>
<ul>
<li><code>onCompleted()</code>: 事件队列完结。<br>  <code>RxJava</code>不仅把每个事件单独处理，还会把它们看做一个队列。<code>RxJava</code>规定，当不会再有新的<code>onNext()</code>发出时，需要触发<code>onCompleted()</code> 方法作为标志。</li>
<li><code>onError()</code>: 事件队列异常。<br>  在事件处理过程中出异常时，<code>onError()</code>会被触发，同时队列自动终止，不允许再有事件发出。</li>
<li>在一个正确运行的事件序列中, <code>onCompleted()</code>和<code>onError()</code>有且只有一个，并且是事件序列中的最后一个。需要注意的是<code>onCompleted()</code>和<code>onError()</code> 二者也是互斥的，即在队列中调用了其中一个，就不应该再调用另一个。</li>
</ul>
<p><code>RxJava</code>的观察者模式大致如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observer_1.jpg?raw=true" alt="image"></p>
<p>####基本实现</p>
<p>基于上面的概念， <code>RxJava</code>的基本实现主要有三点:    </p>
<ul>
<li><p>创建<code>Observable</code><br>  <code>Observable</code>即被观察者，它决定什么时候触发事件以及触发怎样的事件。 <code>RxJava</code>使用<code>Observable.create()</code>方法来创建一个<code>Observable</code>，并为它定义事件触发规则。    </p>
</li>
<li><p>创建<code>Observer</code>即观察者，它决定事件触发的时候将有怎样的行为。<br>  <code>RxJava</code>中的<code>Observer</code>接口的实现方式:    </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Observer&lt;String&gt; observer = <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  除了<code>Observer</code>接口之外，<code>RxJava</code>还内置了一个实现了<code>Observer</code>的抽象类:<code>Subscriber</code>。<code>Subscriber</code>对<code>Observer</code>接口进行了一些扩展，但他们的基本使用方式是完全一样的。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  不仅基本使用方式一样，实质上，在<code>RxJava</code>的<code>subscribe()</code>过程中，<code>Observer</code>也总是会先被转换成一个<code>Subscriber</code>再使用。所以如果你只想使用基本功能，选择<code>Observer</code>和 <code>Subscriber</code>是完全一样的。它们的区别对于使用者来说主要有两点：</p>
<ul>
<li><code>onStart()</code>: 这是<code>Subscriber</code>增加的方法。它会在<code>subscribe()</code>刚开始而事件还未发送之前被调用，可以用于做一些准备工作，例如数据的清零或重置。这是一个可选方法，默认情况下它的实现为空。需要注意的是，如果对准备工作的线程有要求（例如弹出一个显示进度的对话框，这必须在主线程执行）， <code>onStart()</code>就不适用了，因为它总是在<code>subscribe()</code> 所发生的线程被调用，而不能指定线程。要在指定的线程来做准备工作，可以使用<code>doOnSubscribe()</code>方法，具体可以在后面的文中看到。</li>
<li><code>unsubscribe</code>(): 这是<code>Subscriber</code>所实现的另一个接口<code>Subscription</code>的方法，用于取消订阅。在这个方法被调用后，<code>Subscriber</code> 将不再接收事件。一般在这个方法调用前，可以使用<code>isUnsubscribed()</code>先判断一下状态。 <code>unsubscribe()</code>这个方法很重要，因为在<code>subscribe()</code>之后,<code>Observable</code>会持有 <code>Subscriber</code>的引用，这个引用如果不能及时被释放，将有内存泄露的风险。所以最好保持一个原则：要在不再使用的时候尽快在合适的地方（例如<code>onPause()、onStop()</code>等方法中）调用<code>unsubscribe()</code>来解除引用关系，以避免内存泄露的发生。<br>所以后续讲解时我们有时会用<code>Subscriber</code>来代替<code>Observer</code>。</li>
</ul>
</li>
<li><p>调用<code>subscribe()</code>方法(订阅)</p>
<p>  创建了一个<code>Observable</code>和<code>Observer</code>之后，再用<code>subscribe()</code>方法将它们联结起来，整条链子就可以工作了。代码形式很简单：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">observable.subscribe(observer);  </div><div class="line"><span class="comment">// 或者：</span></div><div class="line">observable.subscribe(subscriber);</div></pre></td></tr></table></figure>
<blockquote>
<p>有人可能会注意到，<code>subscribe()</code>这个方法有点怪：它看起来是<code>observalbe</code>订阅了<code>observer/subscriber</code>而不是<code>observer/subscriber</code>订阅了<code>observalbe</code>，这看起来就像『杂志订阅了读者』一样颠倒了对象关系。这让人读起来有点别扭，不过如果把<code>API</code>设计成<code>observer.subscribe(observable)/subscriber.subscribe(observable)</code> ，虽然更加符合思维逻辑，但对流式<code>API</code>的设计就造成影响了，比较起来明显是得不偿失的。</p>
</blockquote>
</li>
</ul>
<h2 id="RxJava入门示例"><a href="#RxJava入门示例" class="headerlink" title="RxJava入门示例"></a><code>RxJava</code>入门示例</h2><p>一个<code>Observable</code>可以发出零个或者多个事件，知道结束或者出错。每发出一个事件，就会调用它的<code>Subscriber</code>的<code>onNext</code>方法，最后调用<code>Subscriber.onComplete()</code>或者<code>Subscriber.onError()</code>结束。</p>
<p>####<code>Hello World</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">compile &apos;io.reactivex:rxandroid:1.2.1&apos;</div><div class="line">// Because RxAndroid releases are few and far between, it is recommended you also</div><div class="line">// explicitly depend on RxJava&apos;s latest version for bug fixes and new features.</div><div class="line">compile &apos;io.reactivex:rxjava:1.2.3&apos;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建被观察者、数据源</span></div><div class="line">Observable&lt;String&gt; observable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber)</span> </span>&#123;</div><div class="line">        <span class="comment">// 可以看到，这里传入了一个 OnSubscribe 对象作为参数。OnSubscribe 会被存储在返回的 Observable 对象中，它的作用相当于一个计划表，当 Observable      </span></div><div class="line">        <span class="comment">//被订阅的时候，OnSubscribe 的 call() 方法会自动被调用，事件序列就会依照设定依次触发（对于上面的代码，就是观察者Subscriber 将会被调用三次 onNext() 和一次 </span></div><div class="line">        <span class="comment">// onCompleted()）。这样，由被观察者调用了观察者的回调方法，就实现了由被观察者向观察者的事件传递，即观察者模式。</span></div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call"</span>);</div><div class="line">        subscriber.onNext(<span class="string">"Hello "</span>);</div><div class="line">        subscriber.onNext(<span class="string">"World !"</span>);</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 创建观察者</span></div><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onCompleted"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onError"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"onNext : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 关联或者叫订阅更合适。</span></div><div class="line">observable.subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>一旦<code>subscriber</code>订阅了<code>observable</code>，<code>observable</code>就会调用<code>subscriber</code>对象的<code>onNext</code>和<code>onComplete</code>方法，<code>subscriber</code>就会打印出<code>Hello World</code>.        </p>
<p> <code>Observable.subscribe(Subscriber)</code>的内部实现是这样的（仅核心代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意：这不是`subscribe()`的源码，而是将源码中与性能、兼容性、扩展性有关的代码剔除后的核心代码。</span></div><div class="line"><span class="function"><span class="keyword">public</span> Subscription <span class="title">subscribe</span><span class="params">(Subscriber subscriber)</span> </span>&#123;</div><div class="line">   subscriber.onStart();</div><div class="line">   onSubscribe.call(subscriber);</div><div class="line">   <span class="keyword">return</span> subscriber;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到<code>subscriber()</code>做了3件事：</p>
<ul>
<li>调用<code>Subscriber.onStart()</code>。这个方法在前面已经介绍过，是一个可选的准备方法。</li>
<li>调用<code>Observable</code>中的<code>onSubscribe.call(Subscriber)</code>。在这里，事件发送的逻辑开始运行。从这也可以看出，在<code>RxJava</code>中，<code>Observable</code> 并不是在创建的时候就立即开始发送事件，而是在它被订阅的时候，即当<code>subscribe()</code>方法执行的时候。</li>
<li>将传入的<code>Subscriber</code>作为<code>Subscription</code>返回。这是为了方便<code>unsubscribe()</code>.</li>
</ul>
<p>整个过程中对象间的关系如下图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_observable_list.gif?raw=true" alt="image"></p>
<p>讲到这里很多人肯定会骂傻<code>X</code>,这TM简洁你妹啊…，这里只是个入门<code>Hello World</code>，真正的简洁等你看完全部介绍后就明白了。</p>
<p><code>RxJava</code>内置了很多简化创建<code>Observable</code>对象的函数，比如<code>Observable.just()</code>就是用来创建只发出一个事件就结束的<code>Observable</code>对象，上面创建<code>Observable</code>对象的代码可以简化为一行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; observable = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div></pre></td></tr></table></figure>
<p>接下来看看如何简化<code>Subscriber</code>，上面的例子中，我们其实并不关心<code>onComplete()</code>和<code>onError</code>，我们只需要在<code>onNext</code>的时候做一些处理，这时候就可以使用<code>Action1</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Action1&lt;String&gt; action1 = <span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>Observable.subscribe()</code>方法有一个重载版本，接受三个<code>Action1</code>类型的参数      </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_subscribe_params.png?raw=true" alt="image"></p>
<p>所以上面的代码最终可以写成这样:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"call : "</span> + s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里顺便多提一些<code>subscribe()</code>的多个<code>Action</code>参数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Action1&lt;String&gt; onNextAction = <span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="comment">// onNext()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, s);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Action1&lt;Throwable&gt; onErrorAction = <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line">    <span class="comment">// onError()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">        <span class="comment">// Error handling</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">Action0 onCompletedAction = <span class="keyword">new</span> Action0() &#123;</div><div class="line">    <span class="comment">// onCompleted()</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"completed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">observable.subscribe(onNextAction, onErrorAction, onCompletedAction);</div></pre></td></tr></table></figure></p>
<p>简单解释一下这段代码中出现的<code>Action1</code>和<code>Action0</code>。<code>Action0</code>是<code>RxJava</code>的一个接口，它只有一个方法<code>call()</code>，这个方法是无参无返回值的；由于<code>onCompleted()</code> 方法也是无参无返回值的，因此<code>Action0</code>可以被当成一个包装对象，将<code>onCompleted()</code>的内容打包起来将自己作为一个参数传入<code>subscribe()</code>以实现不完整定义的回调。这样其实也可以看做将 <code>onCompleted()</code>方法作为参数传进了<code>subscribe()</code>，相当于其他某些语言中的『闭包』。<code>Action1</code>也是一个接口，它同样只有一个方法<code>call(T param)</code>，这个方法也无返回值，但有一个参数；与<code>Action0</code>同理，由于<code>onNext(T obj)</code>和<code>onError(Throwable error)</code>也是单参数无返回值的，因此<code>Action1</code>可以将<code>onNext(obj)</code>和<code>onError(error)</code>打包起来传入<code>subscribe()</code>以实现不完整定义的回调。事实上，虽然<code>Action0</code>和<code>Action1</code>在<code>API</code>中使用最广泛，但<code>RxJava</code>是提供了多个<code>ActionX</code>形式的接口(例如<code>Action2</code>, <code>Action3</code>)的，它们可以被用以包装不同的无返回值的方法。</p>
<p>假设我们的<code>Observable</code>是第三方提供的，它提供了大量的用户数据给我们，而我们需要从用户数据中筛选部分有用的信息，那我们该怎么办呢？<br>从<code>Observable</code>中去修改肯定是不现实的？那从<code>Subscriber</code>中进行修改呢？ 这样好像是可以完成的。但是这种方式并不好，因为我们希望<code>Subscriber</code>越轻量越好，因为很有可能我们需要<br>在主线程中去执行<code>Subscriber</code>。另外，根据响应式函数编程的概念，<code>Subscribers</code>更应该做的事情是<code>响应</code>，响应<code>Observable</code>发出的事件，而不是去修改。<br>那该怎么办呢？ 这就要用到下面的部分要讲的操作符。  </p>
<h2 id="操作符-Operators"><a href="#操作符-Operators" class="headerlink" title="操作符(Operators)"></a>操作符(<code>Operators</code>)</h2><p><code>RxJava</code>提供了对事件序列进行变换的支持，这是它的核心功能之一.所谓变换，就是将事件序列中的对象或整个序列进行加工处理，转换成不同的事件或事件序列。<br>操作符就是为了解决对<code>Observable</code>对象的变换的问题，操作符用于在<code>Observable</code>和最终的<code>Subscriber</code>之间修改<code>Observable</code>发出的事件。<code>RxJava</code>提供了很多很有用的操作符。<br>比如<code>map</code>操作符，就是用来把把一个事件转换为另一个事件的。</p>
<p>####<code>map</code></p>
<p><code>Returns an Observable that applies a specified function to each item emitted by the source Observable and emits the results of these function applications.</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; just = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div><div class="line">Observable&lt;String&gt; map = just.map(<span class="keyword">new</span> Func1&lt;String, String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s + <span class="string">"@@@"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">map.subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的代码打印出的结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12-12 15:51:22.184 472-472/com.charon.rxjavastudydemo I/@@@: Hello @@@</div><div class="line">12-12 15:51:22.184 472-472/com.charon.rxjavastudydemo I/@@@: World !@@@</div></pre></td></tr></table></figure></p>
<p><code>map()</code>操作符就是用于变换<code>Observable</code>对象的，<code>map</code>操作符返回一个<code>Observable</code>对象，这样就可以实现链式调用，在一个<code>Observable</code>对象上多次使用map操作符，最终将最简洁的数据传递给<code>Subscriber</code>对象。</p>
<p><code>map</code>操作符更有趣的一点是它不必返回Observable对象返回的类型，你可以使用<code>map</code>操作符返回一个发出新的数据类型的<code>Observable</code>对象。<br>比如上面的例子中，<code>Subscriber</code>并不关心返回的字符串，而是想要字符串的<code>hash</code>值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable&lt;String&gt; just = Observable.just(<span class="string">"Hello "</span>, <span class="string">"World !"</span>);</div><div class="line">Observable&lt;Integer&gt; map = just.map(<span class="keyword">new</span> Func1&lt;String, Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s.hashCode();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">map.subscribe(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">""</span> + integer);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面部分的打印结果是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">12-12 15:54:35.515 8521-8521/com.charon.rxjavastudydemo I/@@@: -2137068114</div><div class="line">12-12 15:54:35.516 8521-8521/com.charon.rxjavastudydemo I/@@@: -1105126669</div></pre></td></tr></table></figure></p>
<p><code>map()</code>的示意图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_map.jpg?raw=true" alt="image"></p>
<p>通过上面的部分我们可以得知:   </p>
<ul>
<li><p><code>Observable</code>和<code>Subscriber</code>可以做任何事情<br>  <code>Observable</code>可以是一个数据库查询，<code>Subscriber</code>用来显示查询结果；<code>Observable</code>可以是屏幕上的点击事件，<code>Subscriber</code>用来响应点击事件；<code>Observable</code>可以是一个网络请求，<code>Subscriber</code>用来显示请求结果。</p>
</li>
<li><p><code>Observable</code>和<code>Subscriber</code>是独立于中间的变换过程的。<br>  在<code>Observable</code>和<code>Subscriber</code>中间 可以增减任何数量的<code>map</code>。整个系统是高度可组合的，操作数据是一个很简单的过程。</p>
</li>
</ul>
<p>####<code>flatmap</code></p>
<p><code>Returns an Observable that emits items based on applying a function that you supply to each item emitted 
 by the source Observable, where that function returns an Observable, and then merging those resulting 
 Observables and emitting the results of this merger.</code></p>
<p><code>flatMap()</code>是一个很有用但非常难理解的变换，首先假设这么一种需求：假设有一个数据结构『学生』，现在需要打印出一组学生的名字。实现方式很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        Log.d(tag, name);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .map(<span class="keyword">new</span> Func1&lt;Student, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> student.getName();</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>很简单。那么再假设：如果要打印出每个学生所需要修的所有课程的名称呢?(需求的区别在于，每个学生只有一个名字，但却有多个课程)首先可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;Student&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Student&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">        List&lt;Course&gt; courses = student.getCourses();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; courses.size(); i++) &#123;</div><div class="line">            Course course = courses.get(i);</div><div class="line">            Log.d(tag, course.getName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure>
<p>依然很简单。那么如果我不想在<code>Subscriber</code>中使用<code>for</code>循环，而是希望<code>Subscriber</code>中直接传入单个的<code>Course</code>对象呢(这对于代码复用很重要),用<code>map()</code>显然是不行的，因为<code>map()</code> 是一对一的转化，而我现在的要求是一对多的转化。那怎么才能把一个<code>Student</code>转化成多个<code>Course</code>呢？</p>
<p>这个时候，就需要用<code>flatMap()</code>了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student[] students = ...;</div><div class="line">Subscriber&lt;Course&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Course&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Course course)</span> </span>&#123;</div><div class="line">        Log.d(tag, course.getName());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;;</div><div class="line">Observable.from(students)</div><div class="line">    .flatMap(<span class="keyword">new</span> Func1&lt;Student, Observable&lt;Course&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Observable&lt;Course&gt; <span class="title">call</span><span class="params">(Student student)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Observable.from(student.getCourses());</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    .subscribe(subscriber);</div></pre></td></tr></table></figure></p>
<p><code>map</code>与<code>flatmap</code>在功能上是一致的,它也是把传入的参数转化之后返回另一个对象。区别在于<code>flatmap</code>是通过中间<code>Observable</code>来进行，而<code>map</code>是直接执行.<code>flatMap()</code>中返回的是个 <code>Observable</code>对象，并且这个<code>Observable</code>对象并不是被直接发送到了<code>Subscriber</code>的回调方法中。 </p>
<p><code>flatMap()</code>的原理是这样的:  </p>
<ul>
<li>使用传入的事件对象创建一个<code>Observable</code>对象</li>
<li>并不发送这个<code>Observable</code>而是将它激活，于是它开始发送事件</li>
<li>每一个创建出来的<code>Observable</code>发送的事件，都被汇入同一个<code>Observable</code>,而这个<code>Observable</code>负责将这些事件统一交给<code>Subscriber</code> 的回调方法。</li>
</ul>
<p>这三个步骤，把事件拆成了两级，通过一组新创建的<code>Observable</code>将初始的对象『铺平』之后通过统一路径分发了下去。而这个『铺平』就是<code>flatMap()</code>所谓的<code>flat</code>。</p>
<p><code>flatMap()</code>就是根据你的规则，将<code>Observable</code>转换之后再发射出去，注意最后的顺序很可能是错乱的，如果要保证顺序的一致性，要使用<code>concatMap()</code><br>由于可以在嵌套的<code>Observable</code>中添加异步代码<code>flatMap()</code>也常用于嵌套的异步操作，例如嵌套的网络请求<code>(Retrofit + RxJava)</code></p>
<p><code>flatMap()</code>示意图：</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/rxjava_flatmap.jpg?raw=true" alt="image"></p>
<p>####<code>throttleFirst()</code></p>
<p>在每次事件触发后的一定时间间隔内丢弃新的事件。常用作去抖动过滤。<br>例如按钮的点击监听器:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RxView.clickEvents(button); <span class="comment">// RxBinding 代码`</span></div><div class="line">    .throttleFirst(<span class="number">500</span>, TimeUnit.MILLISECONDS) <span class="comment">// 设置防抖间隔为 500ms </span></div><div class="line">    .subscribe(subscriber); <span class="comment">// 妈妈再也不怕我的用户手抖点开两个重复的界面啦。</span></div></pre></td></tr></table></figure></p>
<p>####<code>from</code></p>
<p><code>convert various other objects and data types into Observables</code></p>
<p><code>from()</code>接收一个集合作为输入，然后每次输出一个元素给<code>subscriber</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; s = Arrays.asList(<span class="string">"Java"</span>, <span class="string">"Android"</span>, <span class="string">"Ruby"</span>, <span class="string">"Ios"</span>, <span class="string">"Swift"</span>);</div><div class="line">Observable.from(s).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.i(<span class="string">"@@@"</span>, s);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>####<code>filter</code></p>
<p>返回满足过滤条件的数据。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Observable.from(<span class="keyword">new</span> Integer[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;)</div><div class="line">                .filter(<span class="keyword">new</span> Func1&lt;Integer, Boolean&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> integer &lt; <span class="number">5</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .subscribe(<span class="keyword">new</span> Action1&lt;Integer&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        Log.i(<span class="string">"@@@"</span>, <span class="string">"integer="</span> + integer); <span class="comment">//1,2,3,4</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>####<code>timer</code></p>
<p><code>Timer</code>会在指定时间后发射一个数字0，该操作符运行在<code>Computation Scheduler</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Observable.timer(<span class="number">3</span>, TimeUnit.SECONDS).observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribe(<span class="keyword">new</span> Action1&lt;Long&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                        Log.i(<span class="string">"@@@"</span>, <span class="string">"aLong="</span> + aLong); <span class="comment">// 延时3s</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>####<code>interval</code></p>
<p>创建一个按固定时间间隔发射整数序列的<code>Observable</code>.<br><code>interval</code>默认在<code>computation</code>调度器上执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS, AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;Long&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                Log.i(<span class="string">"@@@"</span>, <span class="string">"aLong="</span> + aLong); <span class="comment">//从0递增，间隔1s 0,1,2,3....</span></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>####<code>Repeat</code></p>
<p>重复执行 </p>
<p>等等…就不继续介绍了，到时候查下文档就好了。</p>
<p>是不是感觉没什么乱用，那就继续看下一部分吧。</p>
<p>更多内容请看下一篇文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/RxJava%E8%AF%A6%E8%A7%A3(%E4%B8%AD">RxJava详解(下)</a>.md)</p>
<p>参考:   </p>
<ul>
<li><a href="https://github.com/ReactiveX/RxJava/wiki">RxJava Wiki</a></li>
<li><a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="external">Grokking RxJava, Part 1: The Basics</a></li>
<li><a href="https://yarikx.github.io/NotRxJava/" target="_blank" rel="external">NotRxJava</a></li>
<li><a href="http://tomstechnicalblog.blogspot.hk/2016/07/when-not-to-use-rxjava.html" target="_blank" rel="external">When Not to Use RxJava</a></li>
<li><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></li>
<li><a href="http://blog.chengyunfeng.com/?p=984" target="_blank" rel="external">Google Agera 从入门到放弃</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/RxJava详解(上)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android Touch事件分发详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android Touch事件分发详解/">Android Touch事件分发详解</a>
    </h1>
  

        
        <a href="/2015/01/01/Android Touch事件分发详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Touch事件分发详解"><a href="#Android-Touch事件分发详解" class="headerlink" title="Android Touch事件分发详解"></a>Android Touch事件分发详解</h1><p>先说一些基本的知识，方便后面分析源码时能更好理解。</p>
<ul>
<li><p>所有<code>Touch</code>事件都被封装成<code>MotionEvent</code>对象，包括<code>Touch</code>的位置、历史记录、第几个手指等.</p>
</li>
<li><p>事件类型分为<code>ACTION_DOWN</code>,<code>ACTION_UP</code>,<code>ACTION_MOVE</code>,<code>ACTION_POINTER_DOWN</code>,<code>ACTION_POINTER_UP</code>,<code>ACTION_CANCEL</code>, 每个<br>一个完整的事件以<code>ACTION_DOWN</code>开始<code>ACTION_UP</code>结束，并且<code>ACTION_CANCEL</code>只能由代码引起.一般对于<code>CANCEL</code>的处理和<code>UP</code>的相同。<br><code>CANCEL</code>的一个简单例子：手指在移动的过程中突然移动到了边界外，那么这时<code>ACTION_UP</code>事件了，所以这是的<code>CANCEL</code>和<code>UP</code>的处理是一致的。</p>
</li>
<li><p>事件的处理分别为<code>dispatchTouchEveent()</code>分发事件(<code>TextView</code>等这种最小的<code>View</code>中不会有该方式)、<code>onInterceptTouchEvent()</code>拦截事件(<code>ViewGroup</code>中拦截事件)、<code>onTouchEvent()</code>消费事件.</p>
</li>
<li><p>事件从<code>Activity.dispatchTouchEveent()</code>开始传递，只要没有停止拦截，就会从最上层(<code>ViewGroup</code>)开始一直往下传递，子<code>View</code>通过<code>onTouchEvent()</code>消费事件。(隧道式向下分发).</p>
</li>
<li><p>如果时间从上往下一直传递到最底层的子<code>View</code>，但是该<code>View</code>没有消费该事件，那么该事件会反序网上传递(从该<code>View</code>传递给自己的<code>ViewGroup</code>，然后再传给更上层的<code>ViewGroup</code>直至传递给<code>Activity.onTouchEvent()</code>).<br>(冒泡式向上处理).</p>
</li>
<li><p>如果<code>View</code>没有消费<code>ACTION_DOWN</code>事件，之后其他的<code>MOVE</code>、<code>UP</code>等事件都不会传递过来.</p>
</li>
<li><p>事件由父<code>View(ViewGroup)</code>传递给子<code>View</code>,<code>ViewGroup</code>可以通过<code>onInterceptTouchEvent()</code>方法对事件进行拦截，停止其往下传递，如果拦截(返回<code>true</code>)后该事件<br>会直接走到该<code>ViewGroup</code>中的<code>onTouchEvent()</code>中，不会再往下传递给子<code>View</code>.如果从<code>DOWN</code>开始，之后的<code>MOVE</code>、<code>UP</code>都会直接在该<code>ViewGroup.onTouchEvent()</code>中进行处理。<br>如果子<code>View</code>之前在处理某个事件，但是后续被<code>ViewGroup</code>拦截，那么子<code>View</code>会接收到<code>ACTION_CANCEL</code>.</p>
</li>
<li><p><code>OnTouchListener</code>优先于<code>onTouchEvent()</code>对事件进行消费。</p>
</li>
<li><p><code>TouchTarget</code>是保存手指点击区域属性的一个类，手指的所有移动过程都会被它记录下来, 包含被<code>touch</code>的<code>View</code>。  </p>
</li>
</ul>
<p>废话不多说，直接上源码，源码妥妥的是最新版5.0：<br>我们先从<code>Activity.dispatchTouchEveent()</code>说起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called to process touch screen events.  You can override this to</div><div class="line"> * intercept all touch screen events before they are dispatched to the</div><div class="line"> * window.  Be sure to call this implementation for touch screen events</div><div class="line"> * that should be handled normally.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> ev The touch screen event.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> boolean Return true if this event was consumed.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		onUserInteraction();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码一看能感觉出来<code>DOWN</code>事件比较特殊。我们继续走到<code>onUserInteraction()</code>代码中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called whenever a key, touch, or trackball event is dispatched to the</div><div class="line"> * activity.  Implement this method if you wish to know that the user has</div><div class="line"> * interacted with the device in some way while your activity is running.</div><div class="line"> * This callback and &#123;<span class="doctag">@link</span> #onUserLeaveHint&#125; are intended to help</div><div class="line"> * activities manage status bar notifications intelligently; specifically,</div><div class="line"> * for helping activities determine the proper time to cancel a notfication.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;All calls to your activity's &#123;<span class="doctag">@link</span> #onUserLeaveHint&#125; callback will</div><div class="line"> * be accompanied by calls to &#123;<span class="doctag">@link</span> #onUserInteraction&#125;.  This</div><div class="line"> * ensures that your activity will be told of relevant user activity such</div><div class="line"> * as pulling down the notification pane and touching an item there.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this callback will be invoked for the touch down action</div><div class="line"> * that begins a touch gesture, but may not be invoked for the touch-moved</div><div class="line"> * and touch-up actions that follow.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onUserLeaveHint()</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserInteraction</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是该方法是空方法，没有具体实现。 我们往下看<code>getWindow().superDispatchTouchEvent(ev)</code>.<br><code>getWindow()</code>获取到当前<code>Window</code>对象，表示顶层窗口，管理界面的显示和事件的响应；每个Activity 均会创建一个PhoneWindow对象，<br>是Activity和整个View系统交互的接口，但是该类是一个抽象类。<br>从文档中可以看到<code>The only existing implementation of this abstract class is android.policy.PhoneWindow, which you should instantiate when needing a Window.</code>，<br>所以我们找到<code>PhoneWindow</code>类，查看它的<code>superDispatchTouchEvent()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>该方法又是调用了<code>mDecor.superDispatchTouchEvent(event)</code>, <code>mDecor</code>是什么呢？ 从名字中我们大概也能猜出来是当前窗口最顶层的<code>DecorView</code>，<br><code>Window</code>界面的最顶层的<code>View</code>对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is the top-level view of the window, containing the window decor.</span></div><div class="line"><span class="keyword">private</span> DecorView mDecor;</div></pre></td></tr></table></figure></p>
<p>讲到这里不妨就提一下<code>DecorView</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它集成子<code>FrameLayout</code>所有很多时候我们在用布局工具查看的时候发现<code>Activity</code>的布局<code>FrameLayout</code>的。就是这个原因。<br>好了，我们接着看<code>DecorView</code>中的<code>superDispatchTouchEvent()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是调用了<code>super.dispatchTouchEveent()</code>，而<code>DecorView</code>的父类是<code>FrameLayout</code>所以我们找到<code>FrameLayout.dispatchTouchEveent()</code>.<br>我们看到<code>FrameLayout</code>中没有重写<code>dispatchTouchEveent()</code>方法，所以我们再找到<code>FrameLayout</code>的父类<code>ViewGroup</code>.看<code>ViewGroup.dispatchTouchEveent()</code>实现。<br>新大陆浮现了…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// Consistency verifier for debugging purposes.是调试使用的，我们不用管这里了。</span></div><div class="line">	<span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onTouchEvent(ev, <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">// onFilterTouchEventForSecurity()用安全机制来过滤触摸事件，true为不过滤分发下去，false则销毁掉该事件。</span></div><div class="line">	<span class="comment">// 方法具体实现是去判断是否被其它窗口遮挡住了，如果遮挡住就要过滤掉该事件。</span></div><div class="line">	<span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">		<span class="comment">// 没有被其它窗口遮住</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</div><div class="line"></div><div class="line">		<span class="comment">// 下面这一块注释说的很清楚了，就是在`Down`的时候把所有的状态都重置，作为一个新事件的开始。</span></div><div class="line">		<span class="comment">// Handle an initial down.</span></div><div class="line">		<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">			<span class="comment">// Throw away all previous state when starting a new touch gesture.</span></div><div class="line">			<span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></div><div class="line">			<span class="comment">// due to an app switch, ANR, or some other state change.</span></div><div class="line">			cancelAndClearTouchTargets(ev);</div><div class="line">			resetTouchState();</div><div class="line">			<span class="comment">// 如果是`Down`，那么`mFirstTouchTarget`到这里肯定是`null`.因为是新一系列手势的开始。</span></div><div class="line">			<span class="comment">// `mFirstTouchTarget`是处理第一个事件的目标。</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 检查是否拦截该事件(如果`onInterceptTouchEvent()`返回true就拦截该事件)</span></div><div class="line">		<span class="comment">// Check for interception.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line">		<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">				|| mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 标记事件不允许被拦截， 默认是`false`， 该值可以通过`requestDisallowInterceptTouchEvent(true)`方法来设置，</span></div><div class="line">			<span class="comment">// 通知父`View`不要拦截该`View`上的事件。</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line">				<span class="comment">// 判断该`ViewGroup`是否要拦截该事件。`onInterceptTouchEvent()`方法默认返回`false`即不拦截。</span></div><div class="line">				intercepted = onInterceptTouchEvent(ev);</div><div class="line">				ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// 子`View`通知父`View`不要拦截。这样就不会走到上面`onInterceptTouchEvent()`方法中了，</span></div><div class="line">				<span class="comment">// 所以父`View`就不会拦截该事件。</span></div><div class="line">				intercepted = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 注释比较清楚了，就是没有目标来处理该事件，而且也不是一个新的事件`Down`事件(新事件的开始), </span></div><div class="line">			<span class="comment">// 我们应该拦截下他。</span></div><div class="line">			<span class="comment">// There are no touch targets and this action is not an initial down</span></div><div class="line">			<span class="comment">// so this view group continues to intercept touches.</span></div><div class="line">			intercepted = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Check for cancelation.检查当前是否是`Cancel`事件或者是有`Cancel`标记。</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</div><div class="line">				|| actionMasked == MotionEvent.ACTION_CANCEL;</div><div class="line"></div><div class="line">		<span class="comment">// Update list of touch targets for pointer down, if needed. 这行代码为是否需要将当前的触摸事件分发给多个子`View`，</span></div><div class="line">		<span class="comment">// 默认为`true`，分发给多个`View`（比如几个子`View`位置重叠）。默认是true</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 保存当前要分发给的目标</span></div><div class="line">		TouchTarget newTouchTarget = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 如果没取消也不拦截，进入方法内部</span></div><div class="line">		<span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line">		</div><div class="line">			<span class="comment">// 下面这部分代码的意思其实就是找到该事件位置下的`View`(可见或者是在动画中的View), 并且与`pointID`关联。</span></div><div class="line">			<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">					|| (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</div><div class="line">					|| actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</div><div class="line">						: TouchTarget.ALL_POINTER_IDS;</div><div class="line"></div><div class="line">				<span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></div><div class="line">				<span class="comment">// have become out of sync.</span></div><div class="line">				removePointersFromTouchTargets(idBitsToAssign);</div><div class="line"></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">					<span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line">					<span class="comment">// Find a child that can receive the event.</span></div><div class="line">					<span class="comment">// Scan children from front to back.</span></div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</div><div class="line">					<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">							&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">					<span class="comment">// 遍历找子`View`进行分发了。</span></div><div class="line">					<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</div><div class="line">								? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">						<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">								? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">								</div><div class="line">						<span class="comment">// `canViewReceivePointerEvents()`方法会去判断这个`View`是否可见或者在播放动画，</span></div><div class="line">						<span class="comment">// 只有这两种情况下可以接受事件的分发</span></div><div class="line">						</div><div class="line">						<span class="comment">// `isTransformedTouchPointInView`判断这个事件的坐标值是否在该`View`内。</span></div><div class="line">						<span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line">								|| !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line">							<span class="keyword">continue</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="comment">// 找到该`View`对应的在`mFristTouchTarget`中的存储的目标， 判断这个`View`可能已经不是之前`mFristTouchTarget`中的`View`了。</span></div><div class="line">						<span class="comment">// 如果找不到就返回null, 这种情况是用于多点触摸， 比如在同一个`View`上按下了多跟手指。</span></div><div class="line">						newTouchTarget = getTouchTarget(child);</div><div class="line">						<span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Child View已经接受了这个事件了</span></div><div class="line">							<span class="comment">// Child is already receiving touch within its bounds.</span></div><div class="line">							<span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></div><div class="line">							newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">							<span class="comment">// 找到该View了，不用再循环找了</span></div><div class="line">							<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						resetCancelNextUpFlag(child);</div><div class="line">						<span class="comment">// 如果上面没有break，只有newTouchTarget为null，说明上面我们找到的Child View和之前的肯定不是同一个了， </span></div><div class="line">						<span class="comment">// 是新增的， 比如多点触摸的时候，一个手指按在了这个`View`上，另一个手指按在了另一个`View`上。</span></div><div class="line">						<span class="comment">// 这时候我们就看child是否分发该事件。dispatchTransformedTouchEvent如果child为null，就直接该ViewGroup出来事件</span></div><div class="line">						<span class="comment">// 如果child不为null，就调用child.dispatchTouchEvent</span></div><div class="line">						<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">							<span class="comment">// 如果这个Child View能分发，那我们就要把之前存储的值改变成现在的Child View。</span></div><div class="line">							<span class="comment">// Child wants to receive touch within its bounds.</span></div><div class="line">							mLastTouchDownTime = ev.getDownTime();</div><div class="line">							<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</div><div class="line">								<span class="comment">// childIndex points into presorted list, find original index</span></div><div class="line">								<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</div><div class="line">									<span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</div><div class="line">										mLastTouchDownIndex = j;</div><div class="line">										<span class="keyword">break</span>;</div><div class="line">									&#125;</div><div class="line">								&#125;</div><div class="line">							&#125; <span class="keyword">else</span> &#123;</div><div class="line">								mLastTouchDownIndex = childIndex;</div><div class="line">							&#125;</div><div class="line">							mLastTouchDownX = ev.getX();</div><div class="line">							mLastTouchDownY = ev.getY();</div><div class="line">							<span class="comment">// 赋值成现在的Child View对应的值，并且会把`mFirstTouchTarget`也改成该值(mFristTouchTarget`与`newTouchTarget`是一样的)。</span></div><div class="line">							newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">							<span class="comment">// 分发给子`View`了，不用再继续循环了</span></div><div class="line">							alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line">							<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// `newTouchTarget == null`就是没有找到新的可以分发该事件的子`View`，那我们只能用上一次的分发对象了。</span></div><div class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Did not find a child to receive the event.</span></div><div class="line">					<span class="comment">// Assign the pointer to the least recently added target.</span></div><div class="line">					newTouchTarget = mFirstTouchTarget;</div><div class="line">					<span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</div><div class="line">						newTouchTarget = newTouchTarget.next;</div><div class="line">					&#125;</div><div class="line">					newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// DOWN事件在上面会去找touch target</span></div><div class="line">		<span class="comment">// Dispatch to touch targets.</span></div><div class="line">		<span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// dispatchTransformedTouchEvent方法中如果child为null，那么就调用super.dispatchTouchEvent(transformedEvent);否则调用child.dispatchTouchEvent(transformedEvent)。</span></div><div class="line">			<span class="comment">// `super.dispatchTouchEvent()`也就是说，此时`Viewgroup`处理`touch`消息跟普通`view`一致。普通`View`类内部会调用`onTouchEvent()`方法</span></div><div class="line">			<span class="comment">// No touch targets so treat this as an ordinary view. 自己处理</span></div><div class="line">			handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</div><div class="line">					TouchTarget.ALL_POINTER_IDS);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 分发</span></div><div class="line">			<span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></div><div class="line">			<span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></div><div class="line">			TouchTarget predecessor = <span class="keyword">null</span>;</div><div class="line">			TouchTarget target = mFirstTouchTarget;</div><div class="line">			<span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> TouchTarget next = target.next;</div><div class="line">				<span class="comment">// 找到了新的子`View`，并且这个是新加的对象，上面已经处理过了。</span></div><div class="line">				<span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">					handled = <span class="keyword">true</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// 否则都调用dispatchTransformedTouchEvent处理，传递给child</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</div><div class="line">							|| intercepted;</div><div class="line">							</div><div class="line">					<span class="comment">// 正常分发</span></div><div class="line">					<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">							target.child, target.pointerIdBits)) &#123;</div><div class="line">						handled = <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">					<span class="comment">// 如果是onInterceptTouchEvent返回true就会遍历mFirstTouchTarget全部给销毁，这就是为什么onInterceptTouchEvent返回true，之后所有的时间都不会再继续分发的了。</span></div><div class="line">					<span class="keyword">if</span> (cancelChild) &#123;</div><div class="line">						<span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</div><div class="line">							mFirstTouchTarget = next;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							predecessor.next = next;</div><div class="line">						&#125;</div><div class="line">						target.recycle();</div><div class="line">						target = next;</div><div class="line">						<span class="keyword">continue</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				predecessor = target;</div><div class="line">				target = next;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Update list of touch targets for pointer up or cancel, if needed.</span></div><div class="line">		<span class="keyword">if</span> (canceled</div><div class="line">				|| actionMasked == MotionEvent.ACTION_UP</div><div class="line">				|| actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">			resetTouchState();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</div><div class="line">			<span class="comment">// 当某个手指抬起的时候，清除他相关的数据。</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> idBitsToRemove = <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex);</div><div class="line">			removePointersFromTouchTargets(idBitsToRemove);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div><div class="line">```   </div><div class="line"></div><div class="line">接下来还要说说`dispatchTransformedTouchEvent()`方法，虽然上面也说了大体功能，但是看一下源码能说明另一个问题：   </div><div class="line">```java</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Transforms a motion event into the coordinate space of a particular child view,</div><div class="line"> * filters out irrelevant pointer ids, and overrides its action if necessary.</div><div class="line"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></div><div class="line">		View child, <span class="keyword">int</span> desiredPointerIdBits) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> handled;</div><div class="line"></div><div class="line">	<span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></div><div class="line">	<span class="comment">// or filtering.  The important part is the action, not the contents.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</div><div class="line">	</div><div class="line">	<span class="comment">// 这就是为什么时间被拦截之后，之前处理过该事件的`View`会收到`CANCEL`.</span></div><div class="line">	<span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</div><div class="line">		event.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">		<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">			handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 子`View`去处理，如果子`View`仍然是`ViewGroup`那还是同样的处理，如果子`View`是普通`View`，普通`View`的`dispatchTouchEveent()`会调用`onTouchEvent()`.</span></div><div class="line">			handled = child.dispatchTouchEvent(event);</div><div class="line">		&#125;</div><div class="line">		event.setAction(oldAction);</div><div class="line">		<span class="keyword">return</span> handled;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Calculate the number of pointers to deliver.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> oldPointerIdBits = event.getPointerIdBits();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</div><div class="line"></div><div class="line">	<span class="comment">// If for some reason we ended up in an inconsistent state where it looks like we</span></div><div class="line">	<span class="comment">// might produce a motion event with no pointers in it, then drop the event.</span></div><div class="line">	<span class="keyword">if</span> (newPointerIdBits == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// If the number of pointers is the same and we don't need to perform any fancy</span></div><div class="line">	<span class="comment">// irreversible transformations, then we can reuse the motion event for this</span></div><div class="line">	<span class="comment">// dispatch as long as we are careful to revert any changes we make.</span></div><div class="line">	<span class="comment">// Otherwise we need to make a copy.</span></div><div class="line">	<span class="keyword">final</span> MotionEvent transformedEvent;</div><div class="line">	<span class="keyword">if</span> (newPointerIdBits == oldPointerIdBits) &#123;</div><div class="line">		<span class="keyword">if</span> (child == <span class="keyword">null</span> || child.hasIdentityMatrix()) &#123;</div><div class="line">			<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">				handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</div><div class="line">				event.offsetLocation(offsetX, offsetY);</div><div class="line"></div><div class="line">				handled = child.dispatchTouchEvent(event);</div><div class="line"></div><div class="line">				event.offsetLocation(-offsetX, -offsetY);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> handled;</div><div class="line">		&#125;</div><div class="line">		transformedEvent = MotionEvent.obtain(event);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		transformedEvent = event.split(newPointerIdBits);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Perform any necessary transformations and dispatch.</span></div><div class="line">	<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">		handled = <span class="keyword">super</span>.dispatchTouchEvent(transformedEvent);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</div><div class="line">		transformedEvent.offsetLocation(offsetX, offsetY);</div><div class="line">		<span class="keyword">if</span> (! child.hasIdentityMatrix()) &#123;</div><div class="line">			transformedEvent.transform(child.getInverseMatrix());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		handled = child.dispatchTouchEvent(transformedEvent);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Done.</span></div><div class="line">	transformedEvent.recycle();</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲了<code>ViewGroup</code>的<code>dispatchTouchEveent()</code>有些地方会调用<code>super.dispatchTouchEveent()</code>，而<code>ViewGroup</code>的父类就是<code>View</code>，接下来我们看一下<code>View.dispatchTouchEveent()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Pass the touch screen motion event down to the target view, or this</div><div class="line"> * view if it is the target.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> event The motion event to be dispatched.</div><div class="line"> * <span class="doctag">@return</span> True if the event was handled by the view, false otherwise.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">// 调试用</span></div><div class="line">	<span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		<span class="comment">// Defensive cleanup for new gesture</span></div><div class="line">		stopNestedScroll();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 判断该`View`是否被其它`View`遮盖住。</span></div><div class="line">	<span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">		<span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line">				&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">				&amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">			<span class="comment">// 先执行`listener`.</span></div><div class="line">			result = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">			<span class="comment">// 执行`onTouchEvent()`.</span></div><div class="line">			result = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">		mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></div><div class="line">	<span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span></div><div class="line">	<span class="comment">// of the gesture.</span></div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||</div><div class="line">			actionMasked == MotionEvent.ACTION_CANCEL ||</div><div class="line">			(actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</div><div class="line">		stopNestedScroll();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过上面的分析我们看到<code>View.dispatchTouchEvent()</code>里面会调用到<code>onTouchEvent()</code>来消耗事件。那么<code>onTouchEvent()</code>是如何处理的呢？下面我们看一下<br><code>View.onTouchEvent()</code>源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this method to handle touch screen motion events.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is used to detect click actions, it is recommended that</div><div class="line"> * the actions be performed by implementing and calling</div><div class="line"> * &#123;<span class="doctag">@link</span> #performClick()&#125;. This will ensure consistent system behavior,</div><div class="line"> * including:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> * &lt;li&gt;obeying click sound preferences</div><div class="line"> * &lt;li&gt;dispatching OnClickListener calls</div><div class="line"> * &lt;li&gt;handling &#123;<span class="doctag">@link</span> AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</div><div class="line"> * accessibility features are enabled</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> event The motion event.</div><div class="line"> * <span class="doctag">@return</span> True if the event was handled, false otherwise.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line"></div><div class="line">	<span class="comment">// 对disable按钮的处理，注释说的比较明白，一个disable但是clickable的view仍然会消耗事件,只是不响应而已。</span></div><div class="line">	<span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">		<span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">			setPressed(<span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">		<span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">		<span class="keyword">return</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">				(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 关于TouchDelegate,文档中是这样说的The delegate to handle touch events that are physically in this view</span></div><div class="line">    <span class="comment">// but should be handled by another view. 就是说如果两个View, View2在View1中，View1比较大，如果我们想点击</span></div><div class="line">	<span class="comment">// View1的时候，让View2去响应点击事件，这时候就需要使用TouchDelegate来设置。</span></div><div class="line">	<span class="comment">// 简单的理解就是如果这个View有自己的时间委托处理人，就交给委托人处理。</span></div><div class="line">	<span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">			(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)) &#123;</div><div class="line">	    <span class="comment">// 这个View可点击</span></div><div class="line">		<span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">			    <span class="comment">// 最好先看DOWN后再看MOVE最后看UP。</span></div><div class="line">				<span class="comment">// PFLAG_PREPRESSED 表示在一个可滚动的容器中,要稍后才能确定是按下还是滚动.</span></div><div class="line">                <span class="comment">// PFLAG_PRESSED 表示不是在一个可滚动的容器中,已经可以确定按下这一操作.</span></div><div class="line">				<span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</div><div class="line">				<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</div><div class="line">					<span class="comment">// 处理点击或长按事件</span></div><div class="line">					<span class="comment">// take focus if we don't have it already and we should in</span></div><div class="line">					<span class="comment">// touch mode.</span></div><div class="line">					<span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</div><div class="line">					<span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) </div><div class="line">						<span class="comment">// 如果现在还没获取到焦点，就再获取一次焦点</span></div><div class="line">						focusTaken = requestFocus();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">// 在前面`DOWN`事件的时候会延迟显示`View`的`pressed`状态,用户可能在我们还没有显示按下状态效果时就不按了.我们还是得在进行实际的点击操作时,让用户看到效果。</span></div><div class="line">					<span class="keyword">if</span> (prepressed) &#123;</div><div class="line">						<span class="comment">// The button is being released before we actually</span></div><div class="line">						<span class="comment">// showed it as pressed.  Make it show the pressed</span></div><div class="line">						<span class="comment">// state now (before scheduling the click) to ensure</span></div><div class="line">						<span class="comment">// the user sees it.</span></div><div class="line">						setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">				   &#125;</div><div class="line">					</div><div class="line">					</div><div class="line">					<span class="keyword">if</span> (!mHasPerformedLongPress) &#123;</div><div class="line">						<span class="comment">// 判断不是长按</span></div><div class="line">						</div><div class="line">						<span class="comment">// This is a tap, so remove the longpress check</span></div><div class="line">						removeLongPressCallback();</div><div class="line"></div><div class="line">						<span class="comment">// Only perform take click actions if we were in the pressed state</span></div><div class="line">						<span class="keyword">if</span> (!focusTaken) &#123;</div><div class="line">							<span class="comment">// Use a Runnable and post this rather than calling</span></div><div class="line">							<span class="comment">// performClick directly. This lets other visual state</span></div><div class="line">							<span class="comment">// of the view update before click actions start.</span></div><div class="line">							<span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</div><div class="line">								mPerformClick = <span class="keyword">new</span> PerformClick();</div><div class="line">							&#125;</div><div class="line">							<span class="comment">// PerformClick就是个Runnable,里面执行performClick()方法。performClick()方法中怎么执行呢？我们在后面再说。</span></div><div class="line">							<span class="keyword">if</span> (!post(mPerformClick)) &#123;</div><div class="line">								performClick();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</div><div class="line">						mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</div><div class="line">					&#125;</div><div class="line">					<span class="comment">// 取消按下状态，UnsetPressedState也是个Runnable,里面执行setPressed(false)</span></div><div class="line">					<span class="keyword">if</span> (prepressed) &#123;</div><div class="line">						postDelayed(mUnsetPressedState,</div><div class="line">								ViewConfiguration.getPressedStateDuration());</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</div><div class="line">						<span class="comment">// If the post failed, unpress right now</span></div><div class="line">						mUnsetPressedState.run();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					removeTapCallback();</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">				mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line">				<span class="comment">// performButtonActionOnTouchDown()处理鼠标右键菜单，有些View显示右键菜单就直接弹菜单.一般设备用不到鼠标，所以返回false。</span></div><div class="line">				<span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// Walk up the hierarchy to determine if we're inside a scrolling container.</span></div><div class="line">				<span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</div><div class="line"></div><div class="line">				<span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></div><div class="line">				<span class="comment">// a short period in case this is a scroll.</span></div><div class="line">				<span class="comment">// 就是遍历下View层级，判断这个View是不是在一个能scroll的View中。</span></div><div class="line">				<span class="keyword">if</span> (isInScrollingContainer) &#123;</div><div class="line">				    <span class="comment">// 因为用户可能是点击或者是滚动，所以我们不能立马判断，先给用户设置一个要点击的事件。</span></div><div class="line">					mPrivateFlags |= PFLAG_PREPRESSED;</div><div class="line">					<span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</div><div class="line">						mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</div><div class="line">					&#125;</div><div class="line">					mPendingCheckForTap.x = event.getX();</div><div class="line">					mPendingCheckForTap.y = event.getY();</div><div class="line">					<span class="comment">// 发送一个延时的操作，用于判断用户到底是点击还是滚动。其实就是在tapTimeout中如果用户没有滚动，那就是点击了。</span></div><div class="line">					postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">				    <span class="comment">// 设置成点击状态</span></div><div class="line">					<span class="comment">// Not inside a scrolling container, so show the feedback right away</span></div><div class="line">					setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">					<span class="comment">// 检查是否是长按，就是过一段时间后如果还在按住，那就是长按了。长按的时间是ViewConfiguration.getLongPressTimeout()</span></div><div class="line">					<span class="comment">// 也就是500毫秒</span></div><div class="line">					checkForLongClick(<span class="number">0</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">				<span class="comment">// 取消按下状态，移动点击消息，移动长按消息。</span></div><div class="line">				setPressed(<span class="keyword">false</span>);</div><div class="line">				removeTapCallback();</div><div class="line">				removeLongPressCallback();</div><div class="line">				<span class="keyword">break</span>;</div><div class="line"></div><div class="line">			<span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">				drawableHotspotChanged(x, y);</div><div class="line">				</div><div class="line">				<span class="comment">// Be lenient about moving outside of buttons， 检查是否移动到View外面了。</span></div><div class="line">				<span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">				    <span class="comment">// 移动到区域外面去了，就要取消点击。</span></div><div class="line">					<span class="comment">// Outside button</span></div><div class="line">					removeTapCallback();</div><div class="line">					<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">						<span class="comment">// Remove any future long press/tap checks</span></div><div class="line">						removeLongPressCallback();</div><div class="line"></div><div class="line">						setPressed(<span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲了<code>Touch</code>事件的分发和处理，随便说一下点击事件:<br>我们平时使用的时候都知道给<code>View</code>设置点击事件是<code>setOnClickListener()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Register a callback to be invoked when this view is clicked. If this view is not</div><div class="line"> * clickable, it becomes clickable.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l The callback that will run</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #setClickable(boolean)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(OnClickListener l)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!isClickable()) &#123;</div><div class="line">		setClickable(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// `getListenerInfo()`就是判断成员变量`mListenerInfo`是否是null，不是就返回，是的话就初始化一个。</span></div><div class="line">	getListenerInfo().mOnClickListener = l;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那什么地方会调用<code>mListenerInfo.mOnClickListener</code>呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Call this view's OnClickListener, if it is defined.  Performs all normal</div><div class="line"> * actions associated with clicking: reporting accessibility event, playing</div><div class="line"> * a sound, etc.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> True there was an assigned OnClickListener that was called, false</div><div class="line"> *         otherwise is returned.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> result;</div><div class="line">	<span class="keyword">final</span> ListenerInfo li = mListenerInfo;</div><div class="line">	<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">		playSoundEffect(SoundEffectConstants.CLICK);</div><div class="line">		li.mOnClickListener.onClick(<span class="keyword">this</span>);</div><div class="line">		result = <span class="keyword">true</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		result = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>讲到这里就明白了。<code>onTouchEvent()</code>中的<code>ACTION_UP</code>中会调用<code>performClick()</code>方法。</p>
<p>到这里，就全部分析完了，这一块还是比较麻烦的，中间查了很多资料，有些地方自己可能也理解的不太对，如果有哪里理解的不对的地方，还请大家指出来。谢谢。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android Touch事件分发详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android6.0权限系统" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android6.0权限系统/">Android6.0权限系统</a>
    </h1>
  

        
        <a href="/2015/01/01/Android6.0权限系统/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android6-0权限系统"><a href="#Android6-0权限系统" class="headerlink" title="Android6.0权限系统"></a>Android6.0权限系统</h1><p><code>Android</code>权限系统是一个非常重要的安全问题，因为它只有在安装时会询问一次。一旦软件本安装之后，应用程序可以在用户毫不知情的情况下使用这些权限来获取所有的内容。     </p>
<p>很多坏蛋会通过这个安全缺陷来收集用户的个人信息并使用它们来做坏事的情况就不足为奇了。    </p>
<p><code>Android</code>团队也意识到了这个问题。在经过了7年后，权限系统终于被重新设置了。从<code>Anroid 6.0(API Level 23)</code>开始，应用程序在安装时不会被授予任何权限，取而代之的是在运行时应用回去请求用户授予对应的权限。这样可以让用户能更好的去控制应用功能。例如，一个用户可能会同一个拍照应用使用摄像头的权限，但是不同授权它获取设备位置的权限。用户可以在任何时候通过去应用的设置页面来撤销授权。    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/runtimepermission.jpg?raw=true" alt="image">  </p>
<p><strong>注意:</strong>上面请求权限的对话框不会自动弹出。开发者需要手动的调用。如果开发者调用了一些需要权限的功能，但是用户又拒绝授权的话，应用就会<code>crash</code>。   </p>
<p>系统权限被分为两类，<code>normal</code>和<code>dangerous</code>:    </p>
<ul>
<li><code>Normal Permissions</code>不需要用户直接授权，如果你的应用在清单文件中声明了Normal Permissions`，系统会自动授权该权限。    </li>
<li><code>Dangerous Permissions</code>可以让应用获取用户的私人数据。如果你的应用在清单文件中申请了<code>Dangerous Permissions</code>，那就必须要用户来授权给应用。   </li>
</ul>
<p><code>Normal Permissions</code>:<br><code>Normal Permission</code>是当用户安装或更新应用时，系统将授予应用所请求的权限，又称为<code>PROTECTION_NORMAL</code>（安装时授权的一类基本权限）。该类权限只需要在<code>manifest</code>文件中声明即可，安装时就授权，不需要每次使用时进行检查，而且用户不能取消以上授权。   </p>
<ul>
<li>ACCESS_LOCATION_EXTRA_COMMANDS</li>
<li>ACCESS_NETWORK_STATE</li>
<li>ACCESS_NOTIFICATION_POLICY</li>
<li>ACCESS_WIFI_STATE</li>
<li>BLUETOOTH</li>
<li>BLUETOOTH_ADMIN</li>
<li>BROADCAST_STICKY</li>
<li>CHANGE_NETWORK_STATE</li>
<li>CHANGE_WIFI_MULTICAST_STATE</li>
<li>CHANGE_WIFI_STATE</li>
<li>DISABLE_KEYGUARD</li>
<li>EXPAND_STATUS_BAR</li>
<li>GET_PACKAGE_SIZE</li>
<li>INSTALL_SHORTCUT</li>
<li>INTERNET</li>
<li>KILL_BACKGROUND_PROCESSES</li>
<li>MODIFY_AUDIO_SETTINGS</li>
<li>NFC</li>
<li>READ_SYNC_SETTINGS</li>
<li>READ_SYNC_STATS</li>
<li>RECEIVE_BOOT_COMPLETED</li>
<li>REORDER_TASKS</li>
<li>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</li>
<li>REQUEST_INSTALL_PACKAGES</li>
<li>SET_ALARM</li>
<li>SET_TIME_ZONE</li>
<li>SET_WALLPAPER</li>
<li>SET_WALLPAPER_HINTS</li>
<li>TRANSMIT_IR</li>
<li>UNINSTALL_SHORTCUT</li>
<li>USE_FINGERPRINT</li>
<li>VIBRATE</li>
<li>WAKE_LOCK</li>
<li>WRITE_SYNC_SETTINGS</li>
</ul>
<p>下图为<code>Dangerous permissions and permission groups</code>:  </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/permgroup.png?raw=true" alt="image">     </p>
<p>在所有的<code>Android</code>版本中，你的应用都需要在<code>manifest</code>文件中声明<code>normal</code>和<code>dangerous</code>权限。然而声明所影响的效果会因系统版本和你应用的<code>target SDK lever</code>有关:     </p>
<ul>
<li>如果设备运行的是<code>Android 5.1</code>或者之前的系统，或者应用的<code>targetSdkVersion</code>是22或者之前版本：如果你在<code>manifest</code>中声明了<code>dangerous permission</code>，用户需要在安装应用时授权这些权限。如果用户不授权这些权限，系统就不会安装该应用。(我试了下发现即使<code>targetSdkVersion</code>是22及以下，在6.0的手机上时，如果你安装时你不同意一些权限，也仍然可以安装的)  </li>
<li>如果设备运行的是<code>Android 6.0</code>或者更高的系统，并且你应用的<code>targetSdkVersion</code>是23或者更高:应用必须在<code>manifest</code>文件中申请这些权限，而且必须要在运行时对所需要的<code>dangerous permission</code>申请授权。用户可以统一或者拒绝授权，并且及时用户拒绝了授权，应用在无法使用一些功能的情况下也要保证能继续运行。     </li>
</ul>
<p>也就是说新的运行时权限仅当我们设置<code>targetSdkVersion</code>是23及以上时才会起作用。<br>如果你的<code>targtSdkVersion</code>低于23，那将被认为该应用没有经过<code>android 6.0</code>的测试，当该应用被安装到了6.0的手机上时，仍然会使用之前的旧权限规则，在安装时会提示所有需要的权限(这样做是有道理的，不然对于之前开发的应用，我们都要立马去修改让它适应6.0，来不及的话就导致6.0的手机都无法使用了，显然Android开发团队不会考虑不到这种情况)，当然用户可以在安装的界面不允许一些权限，那当程序使用到了这些权限时，会崩溃吗？答案是在<code>Android 6.0</code>及以上的手机会直接<code>crash</code>，但是在<code>23</code>之前的手机上不会<code>crash</code>。     </p>
<p>所以如果你的应用没有支持运行时权限的功能，那千万不要讲<code>targetSdkVersion</code>设置为23，否则就麻烦了。  </p>
<blockquote>
<p><strong><em>注意:</em></strong>从<code>Android 6.0(API Level 23)</code>开始，即使应用的<code>targetSdkVersion</code>是比较低的版本，但是用户仍然可以在任何时候撤销对应用的授权。所以不管应用的<code>targetSdkVerison</code>是什么版本，你都要测试你的应用在不能获取权限时能不能正常运行。 </p>
</blockquote>
<p>下面介绍下如何使用<code>Android Support Library</code>来检查和请求权限。<code>Android</code>框架在<code>6.0</code>开始也提供了相同的方法。然而使用<code>support</code>包会比较简单，因为这样你就不需要在请求方法时判断当前的系统版本。(后面说的这几个类都是<code>android.support.v4</code>中的)    </p>
<p>###检查权限    </p>
<p>如果应用需要使用<code>dangerous permission</code>，在任何时候执行需要该权限的操作时你都需要检查是否已经授权。用户可能会经常取消授权，所以即使昨天应用已经使用了摄像头，这也不能保证今天仍然有使用摄像头的权限。    </p>
<p>为了检查是否可以使用该权限，调用<code>ContextCompat.checkSelfPermission()</code>。<br>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Assume thisActivity is the current activity</span></div><div class="line"><span class="keyword">int</span> permissionCheck = ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">        Manifest.permission.WRITE_CALENDAR);</div></pre></td></tr></table></figure></p>
<p>如果应用有该权限，该方法将返回<code>PackageManager.PERMISSION_GRANTED</code>，应用可以进行相关的操作。如果应用不能使用该权限，该方法将返回<code>PERMISSION_DENIED</code>，这是应用将必须要向用户申请该权限。    </p>
<p>###申请使用权限</p>
<p>如果应用需要使用清单文件中申明的<code>dangerous permission</code>，它必须要向用户申请来授权。<code>Android</code>提供了几种申请授权的方法。使用这些方法时将会弹出一个标准的系统对话框，该对话框不能自定义。     </p>
<p>#####说明为什么应用需要使用这些权限      </p>
<p>在一些情况下，你可能需要帮助用力理解为什么需要该权限。例如，一个用户使用了一个照相的应用，用户不会奇怪为什么应用申请使用摄像头的权限，但是用户可能会不理解为什么应用需要获取位置或者联系人的权限。在请求一个权限之前，你需要该用户一个说明。一定要切记不要通过说明来压倒用户。如果你提供了太多的说明，用户可能会感觉沮丧并且会卸载它。   </p>
<p>一个你需要提供说明的合适时机就是在用户之前已经不同意授权该权限的情况下。如果一个用户继续尝试使用需要权限的功能时，但是之前确禁止了该权限的请求，这就可能是因为用户不理解为什么该功能需要使用该权限。在这种情况下，提供一个说明是非常合适的。  </p>
<p>为了能找到用户可能需要说明的情况，<code>android</code>提供了一个工具类方法<code>ActivityCompat.shouldShowRequestPermissionRationale().</code>。如果应用之前申请了该权限但是用户拒绝授权后该方法会返回<code>true</code>。(在Android 6.0之前调用的时候会直接返回false)     </p>
<blockquote>
<p><strong><em>注意：</em></strong>如果用户之前拒绝了权限申请并且选择了请求权限对话框中的<code>Don’t ask again</code>选项，该方法就会返回<code>false</code>。如果设备策略禁止了该应用使用该权限，该方法也会返回<code>false</code>。(我测试的时候发现请求权限的对话框中并没有<code>Don’t asdk again</code>这一项)<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/request_permission_dialog.png?raw=true" alt="image">      </p>
</blockquote>
<p>#####申请需要的权限      </p>
<p>如果应用没有所需的权限时，应用必须调用<code>ActivityCompat.requestPermissions (Activity activity, 
                String[] permissions, 
                int requestCode)</code>方法来申请对用的权限。参数传递对应所需的权限以及一个整数型的<code>request code</code>来标记该权限申请。 该方法是异步的:该方法会立即返回，在用户响应了请求权限的对话框之后，系统会调用对用的回调方法来通知结果，并且会传递在<code>reqeustPermissions()</code>方法中的<code>request code</code>。(在Android 6.0之前调用的时候会直接去调用<code>onRequestPermissionsResult()</code>的回调方法)<br>如图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/requestpermission.jpg?raw=true" alt="image">  </p>
<p>下面是检查是否读取联系人权限，并且在必要时申请权限的代码:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Here, thisActivity is the current activity</span></div><div class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">                Manifest.permission.READ_CONTACTS)</div><div class="line">        != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Should we show an explanation?</span></div><div class="line">    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(thisActivity,</div><div class="line">            Manifest.permission.READ_CONTACTS)) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Show an expanation to the user *asynchronously* -- don't block</span></div><div class="line">        <span class="comment">// this thread waiting for the user's response! After the user</span></div><div class="line">        <span class="comment">// sees the explanation, try again to request the permission.</span></div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// No explanation needed, we can request the permission.</span></div><div class="line"></div><div class="line">        ActivityCompat.requestPermissions(thisActivity,</div><div class="line">                <span class="keyword">new</span> String[]&#123;Manifest.permission.READ_CONTACTS&#125;,</div><div class="line">                MY_PERMISSIONS_REQUEST_READ_CONTACTS);</div><div class="line"></div><div class="line">        <span class="comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span></div><div class="line">        <span class="comment">// app-defined int constant. The callback method gets the</span></div><div class="line">        <span class="comment">// result of the request.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong><em>注意：</em></strong>当调用<code>requestPermissions()</code>方法时，系统会显示一个标准的对话框。应用不能指定或者改变该对话框。如果你想提供一些信息或者说明给用户，你需要在调用<code>requestPermissions()</code>之前处理。    </p>
</blockquote>
<p>#####处理请求权限的的结果     </p>
<p>如果应用申请权限，系统会显示一个对话框。当用户相应后，系统会调用应用中的<code>onRequestPermissionsResult (int requestCode, 
                String[] permissions, 
                int[] grantResults)</code>方法并传递用户的操作结果。在应用中必须要重写该方法来查找授权了什么权限。该回调方法会传递你在<code>requestPermisssions()</code>方法中传递的<code>request code</code>。直接在<code>Activity</code>或者<code>Fragment</code>中重写<code>onRequestPermissionsResult()</code>方法即可。例如，申请<code>READ_CONTACTS</code>的权限可能会有下面的回到方法:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode,</span></span></div><div class="line">        String permissions[], <span class="keyword">int</span>[] grantResults) &#123;</div><div class="line">    <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">        <span class="keyword">case</span> MY_PERMISSIONS_REQUEST_READ_CONTACTS: &#123;</div><div class="line">            <span class="comment">// If request is cancelled, the result arrays are empty.</span></div><div class="line">            <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span></div><div class="line">                &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission was granted, yay! Do the</span></div><div class="line">                <span class="comment">// contacts-related task you need to do.</span></div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission denied, boo! Disable the</span></div><div class="line">                <span class="comment">// functionality that depends on this permission.</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// other 'case' lines to check for other</span></div><div class="line">        <span class="comment">// permissions this app might request</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>系统提示的对话框会描述应用所需的<code>permission groud</code>。它不会列出特定的权限。例如，如果你申请了<code>READ_CONTACTS</code>权限，系统的对话框只会说你的应用需要获取设备的联系人信息。用户只需要授权每个<code>permission group</code>一次。如果你应用需要申请其他任何一个在该<code>permission group</code>中的权限时，系统会自动授权。在申请这些授权时，系统会像用户明确通过系统对话框统一授权时一样去调用<code>onRequestPermissionsResult()</code>方法并且传递<code>PERMISSION_GRANTED</code>参数。    </p>
<blockquote>
<p><strong><em>注意：</em></strong>虽然用户已经授权了同一<code>permission group</code>中其他的任何权限，但是应用仍然需要明确申请每个需要的权限。例外，<code>permission group</code>中的权限在以后可能会发生变化。    </p>
</blockquote>
<p>例如，假设在应用的<code>manifest</code>文件中同时声明了<code>READ_CONTACTS</code>和<code>WRITE_CONTACTS</code>权限。如果你申请<code>READ_CONTACTS</code>权限而且用户同意了该权限，如果你想继续申请<code>WRITE_CONTACTS</code>权限，系统不会与用户有任何交互就会直接进行授权。     </p>
<p>如果用户拒绝了一个权限申请，你的应用进行合适的处理。例如，你的应用可能显示一个对话框来表明无法执行用户请求的需要该权限的操作。</p>
<p>如果系统向用户申请权限授权，用户选择了让系统以后不要再申请该权限。 在这种情况下，应用在任何时间调用<code>reqeustPermissions()</code>方法来再次申请权限时，系统都会直接拒绝该请求。系统会直接调用<code>onRequestPermissionResult()</code>回调方法并且传递<code>PERMISSION_DENIED</code>参数，和用户明确拒绝应用申请该权限时一样。 这就意味着在你调用<code>requestPermissions()</code>方法是，你无法确定是否会和用户有直接的交互操作。   </p>
<p>示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">int</span> REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS = <span class="number">124</span>;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertDummyContactWrapper</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; permissionsNeeded = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">  </div><div class="line">    <span class="keyword">final</span> List&lt;String&gt; permissionsList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.ACCESS_FINE_LOCATION))</div><div class="line">        permissionsNeeded.add(<span class="string">"GPS"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.READ_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Read Contacts"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.WRITE_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Write Contacts"</span>);</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (permissionsList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (permissionsNeeded.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Need Rationale</span></div><div class="line">            String message = <span class="string">"You need to grant access to "</span> + permissionsNeeded.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; permissionsNeeded.size(); i++)</div><div class="line">                message = message + <span class="string">", "</span> + permissionsNeeded.get(i);</div><div class="line">            showMessageOKCancel(message,</div><div class="line">                    <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                            requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                                    REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    insertDummyContact();</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addPermission</span><span class="params">(List&lt;String&gt; permissionsList, String permission)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (checkSelfPermission(permission) != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">        permissionsList.add(permission);</div><div class="line">        <span class="comment">// Check for Rationale Option</span></div><div class="line">        <span class="keyword">if</span> (!shouldShowRequestPermissionRationale(permission))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲到的都是<code>Activity</code>中的使用方法，那<code>Fragment</code>中怎么授权呢？<br>如果在<code>Fragment</code>中使用，用<code>v13</code>包中的<code>FragmentCompat.requestPermissions()</code>和<code>FragmentCompat.shouldShowRequestPermissionRationale()</code>。 </p>
<p>在<code>Fragment</code>中申请权限，不要使用<code>ActivityCompat.requestPermissions</code>, 直接使用<code>Fragment.requestPermissions</code>方法，<br>否则会回调到<code>Activity</code>的<code>onRequestPermissionsResult</code>。但是虽然你使用<code>Fragment.requestPermissions</code>方法，也照样回调不到<code>Fragment.onRequestPermissionsResult</code>中。这是<code>Android</code>的<code>Bug</code>,<a href="https://code.google.com/p/android/issues/detail?can=2&amp;start=0&amp;num=100&amp;q=&amp;colspec=ID%20Status%20Priority%20Owner%20Summary%20Stars%20Reporter%20Opened&amp;groupby=&amp;sort=&amp;id=189121" target="_blank" rel="external">详见</a>，<code>Google</code>已经在<code>23.3.0</code>修复了该问题，所以要尽快升级。</p>
<p>所以升级到<code>23.3.0</code>及以上就没问题了。如果不升级该怎么处理呢？就是在<code>Activity.onRequestPermissionsResult</code>方法中去手动调用每个<code>Fragment</code>的方法(当然你要判断下权限个数，不然申请一个权限的情况下会重复调用).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">    List&lt;Fragment&gt; fragments = getSupportFragmentManager().getFragments();</div><div class="line">    <span class="keyword">if</span> (fragments != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (Fragment fragment : fragments) &#123;</div><div class="line">            fragment.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我简单的写了一个工具类:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionUtil</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在调用需要权限的功能时使用该方法进行检查。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(activity, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在Actvitiy或者Fragment中重写onRequestPermissionsResult方法后调用该方法。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> grantResults</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(activity, requestCode, permissions, grantResults, iPermission);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String... permission)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String s : permission) &#123;</div><div class="line">            permissions.add(s);</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在检查权限后自己处理权限说明的逻辑后调用该方法，直接申请权限。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> t</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (permissions == <span class="keyword">null</span> || permissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSelfPermission</span><span class="params">(Context context, String permission)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || TextUtils.isEmpty(permission)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params: the params is null !"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        context = context.getApplicationContext();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            <span class="keyword">int</span> result = ContextCompat.checkSelfPermission(context, permission);</div><div class="line">            <span class="keyword">if</span> (PackageManager.PERMISSION_DENIED == result) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">handleRequestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            Activity activity = getActivity(t);</div><div class="line">            List&lt;String&gt; deniedPermissions = getDeniedPermissions(activity, permissions);</div><div class="line">            <span class="keyword">if</span> (deniedPermissions != <span class="keyword">null</span> &amp;&amp; deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                List&lt;String&gt; rationalPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                <span class="keyword">for</span> (String deniedPermission : deniedPermissions) &#123;</div><div class="line">                    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(activity,</div><div class="line">                            deniedPermission)) &#123;</div><div class="line">                        rationalPermissions.add(deniedPermission);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> showRational = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    showRational = iPermission.showRational(requestCode);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (rationalPermissions.size() &gt; <span class="number">0</span> &amp;&amp; showRational) &#123;</div><div class="line">                    <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                        iPermission.onRational(requestCode, deniedPermissions);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    requestPermissions(t, requestCode, deniedPermissions);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    iPermission.onGranted(requestCode);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Activity <span class="title">getActivity</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">        Activity activity = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            activity = (Activity) t;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            activity = ((Fragment) t).getActivity();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            activity = ((android.app.Fragment) t).getActivity();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> activity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.M)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; deniedPermissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions == <span class="keyword">null</span> || deniedPermissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// has denied permissions</span></div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            ((Activity) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            ((Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            ((android.app.Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getDeniedPermissions</span><span class="params">(Context context, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        List&lt;String&gt; denyPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String permission : permissions) &#123;</div><div class="line">            <span class="keyword">if</span> (!checkSelfPermission(context, permission)) &#123;</div><div class="line">                denyPermissions.add(permission);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> denyPermissions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestResult</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                          <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        List&lt;String&gt; deniedPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grantResults.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (grantResults[i] != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">                deniedPermissions.add(permissions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onDenied(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPermission</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否需要提示用户该权限的作用，提示后需要再调用requestPermission()方法来申请。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> true 为提示，false为不提示</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Button mReqCameraBt;</div><div class="line">    <span class="keyword">private</span> Button mReqContactsBt;</div><div class="line">    <span class="keyword">private</span> Button mReqMoreBt;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.fragment_main, container, <span class="keyword">false</span>);</div><div class="line">        findView(view);</div><div class="line">        initView();</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        mReqCameraBt = (Button) view.findViewById(R.id.bt_requestCamera);</div><div class="line">        mReqContactsBt = (Button) view.findViewById(R.id.bt_requestContacts);</div><div class="line">        mReqMoreBt = (Button) view.findViewById(R.id.bt_requestMore);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mReqCameraBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqContactsBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqMoreBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CAMERA = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CONTACTS = <span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_MORE = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        PermissionUtil.onRequestPermissionsResult(<span class="keyword">this</span>, requestCode, permissions, grantResults, mPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestCamera</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CAMERA, mPermission, Manifest.permission.CAMERA);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestReadContacts</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CONTACTS, mPermission, Manifest.permission.READ_CONTACTS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestMore</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_MORE, mPermission, Manifest.permission.READ_CONTACTS, Manifest.permission.READ_CALENDAR, Manifest.permission.CALL_PHONE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPermissionTipDialog</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity());</div><div class="line">        builder.setMessage(<span class="string">"I want you permissions"</span>);</div><div class="line">        builder.setTitle(<span class="string">"Hello Permission"</span>);</div><div class="line">        builder.setPositiveButton(<span class="string">"确认"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">                PermissionUtil.requestPermission(MainFragment.<span class="keyword">this</span>, requestCode, permissions);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.setNegativeButton(<span class="string">"取消"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.create().show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> IPermission mPermission = <span class="keyword">new</span> IPermission() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onGranted :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onDenied :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permission)</span> </span>&#123;</div><div class="line">            showPermissionTipDialog(requestCode, permission);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">                <span class="keyword">case</span> REQUEST_CODE_MORE:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> id = v.getId();</div><div class="line">        <span class="keyword">switch</span> (id) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestCamera:</div><div class="line">                requestCamera();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestContacts:</div><div class="line">                requestReadContacts();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestMore:</div><div class="line">                requestMore();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android6.0权限系统/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-View绘制过程详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/View绘制过程详解/">View绘制过程详解</a>
    </h1>
  

        
        <a href="/2015/01/01/View绘制过程详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="View绘制过程详解"><a href="#View绘制过程详解" class="headerlink" title="View绘制过程详解"></a>View绘制过程详解</h1><p>界面窗口的根布局是<code>DecorView</code>，该类继承自<code>FrameLayout</code>.说到<code>View</code>绘制，想到的就是从这里入手，而<code>FrameLayout</code>继承自<code>ViewGroup</code>。感觉绘制肯定会在<code>ViewGroup</code>或者<code>View</code>中，<br>但是木有找到。发现<code>ViewGroup</code>实现<code>ViewParent</code>接口，而<code>ViewParent</code>有一个实现类是<code>ViewRootImpl</code>， <code>ViewGruop</code>中会使用<code>ViewRootImpl</code>…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The top of a view hierarchy, implementing the needed protocol between View</div><div class="line"> * and the WindowManager.  This is for the most part an internal implementation</div><div class="line"> * detail of &#123;<span class="doctag">@link</span> WindowManagerGlobal&#125;.</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"EmptyCatchBlock"</span>, <span class="string">"PointlessBooleanExpression"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></div><div class="line">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">HardwareRenderer</span>.<span class="title">HardwareDrawCallbacks</span> &#123;</div><div class="line">		</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p><code>View</code>的绘制过程从<code>ViewRootImpl.performTraversals()</code>方法开始。<br>首先先说明一下，这部分代码比较多，逻辑也比较麻烦，很容易弄晕，如果感觉看起来费劲，就跳过这一块，直接到下面的Measure、Layout、Draw部分开始看。<br>我也没有全部弄清楚，我只是把里面的步骤标注了下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// ... 此处省略源代码N行</span></div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Measure</span></div><div class="line">	<span class="keyword">if</span> (!mStopped) &#123;</div><div class="line">		<span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</div><div class="line">				(relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</div><div class="line">		<span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</div><div class="line">				|| mHeight != host.getMeasuredHeight() || contentInsetsChanged) &#123;</div><div class="line">			<span class="comment">// 这里是获取widthMeasureSpec,这俩参数不是一般的尺寸数值，而是将模式和尺寸组合在一起的数值.</span></div><div class="line">			<span class="comment">// getRootMeasureSpec方法内部会使用MeasureSpec.makeMeasureSpec()方法来组装一个MeasureSpec，</span></div><div class="line">			<span class="comment">// 当lp.width参数等于MATCH_PARENT的时候，MeasureSpec的specMode就等于EXACTLY，当lp.width等于WRAP_CONTENT的时候，MeasureSpec的specMode就等于AT_MOST。</span></div><div class="line">			<span class="comment">// 并且MATCH_PARENT和WRAP_CONTENT时的specSize都是等于windowSize的，也就意味着根视图总是会充满全屏的。</span></div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG, <span class="string">"Ooops, something changed!  mWidth="</span></div><div class="line">					+ mWidth + <span class="string">" measuredWidth="</span> + host.getMeasuredWidth()</div><div class="line">					+ <span class="string">" mHeight="</span> + mHeight</div><div class="line">					+ <span class="string">" measuredHeight="</span> + host.getMeasuredHeight()</div><div class="line">					+ <span class="string">" coveredInsetsChanged="</span> + contentInsetsChanged);</div><div class="line">			</div><div class="line">			<span class="comment">// 调用PerformMeasure方法。</span></div><div class="line">			 <span class="comment">// Ask host how big it wants to be</span></div><div class="line">			performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">			<span class="comment">// Implementation of weights from WindowManager.LayoutParams</span></div><div class="line">			<span class="comment">// We just grow the dimensions as needed and re-measure if</span></div><div class="line">			<span class="comment">// needs be</span></div><div class="line">			<span class="keyword">int</span> width = host.getMeasuredWidth();</div><div class="line">			<span class="keyword">int</span> height = host.getMeasuredHeight();</div><div class="line">			<span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (measureAgain) &#123;</div><div class="line">				<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG,</div><div class="line">						<span class="string">"And hey let's measure once more: width="</span> + width</div><div class="line">						+ <span class="string">" height="</span> + height);</div><div class="line">				performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			layoutRequested = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; !mStopped;</div><div class="line">	<span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</div><div class="line">			|| mAttachInfo.mRecomputeGlobalAttributes;</div><div class="line">	<span class="comment">// 是否需要Layout</span></div><div class="line">	<span class="keyword">if</span> (didLayout) &#123;</div><div class="line">		<span class="comment">// 调用performLayout方法。</span></div><div class="line">		performLayout(lp, desiredWindowWidth, desiredWindowHeight);</div><div class="line"></div><div class="line">		<span class="comment">// By this point all views have been sized and positioned</span></div><div class="line">		<span class="comment">// We can compute the transparent area</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span> ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// start out transparent</span></div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> AVOID THAT CALL BY CACHING THE RESULT?</span></div><div class="line">			host.getLocationInWindow(mTmpLocation);</div><div class="line">			mTransparentRegion.set(mTmpLocation[<span class="number">0</span>], mTmpLocation[<span class="number">1</span>],</div><div class="line">					mTmpLocation[<span class="number">0</span>] + host.mRight - host.mLeft,</div><div class="line">					mTmpLocation[<span class="number">1</span>] + host.mBottom - host.mTop);</div><div class="line"></div><div class="line">			host.gatherTransparentRegion(mTransparentRegion);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</div><div class="line">				mPreviousTransparentRegion.set(mTransparentRegion);</div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				<span class="comment">// reconfigure window manager</span></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</div><div class="line">				&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DBG) &#123;</div><div class="line">			System.out.println(<span class="string">"======================================"</span>);</div><div class="line">			System.out.println(<span class="string">"performTraversals -- after setFrame"</span>);</div><div class="line">			host.debug();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Draw</span></div><div class="line">	<span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</div><div class="line">		<span class="keyword">if</span> (!skipDraw || mReportNextDraw) &#123;</div><div class="line">			<span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">					mPendingTransitions.get(i).startChangingAnimations();</div><div class="line">				&#125;</div><div class="line">				mPendingTransitions.clear();</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 调用performDraw方法</span></div><div class="line">			performDraw();</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (viewVisibility == View.VISIBLE) &#123;</div><div class="line">			<span class="comment">// Try again</span></div><div class="line">			scheduleTraversals();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">				mPendingTransitions.get(i).endChangingAnimations();</div><div class="line">			&#125;</div><div class="line">			mPendingTransitions.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mIsInTraversal = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面源码可以看出,<code>performTraversals()</code>方法中会依次做三件事：</p>
<ul>
<li><code>performMeasure()</code>, 内部是<code>mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</code>测量<code>View</code>大小。这里顺便提一下，这个<code>mView</code>是什么？它就是<code>Window</code>最顶成的<code>View(DecorView)</code>,它是<code>FrameLayout</code>的子类。</li>
<li><code>performLayout()</code>, 内部是<code>mView.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</code>视图布局，确定<code>View</code>位置。</li>
<li><code>performDraw()</code>, 内部是<code>draw(fullRedrawNeeded);</code> 绘制界面。</li>
</ul>
<p>至此<code>View</code>绘制的三个过程已经展现：</p>
<h1 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a><code>Measure</code></h1><p><code>performMeasure</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>performMeasure()</code>方法中会调用<code>View.measure()</code>方法， 源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is called to find out how big a view should be. The parent</div><div class="line"> * supplies constraint information in the width and height parameters.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The actual measurement work of a view is performed in</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> oWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> oHeight = insets.top  + insets.bottom;</div><div class="line">		widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</div><div class="line">		heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Suppress sign extension for the low bytes</span></div><div class="line">	<span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</div><div class="line">	<span class="keyword">if</span> (mMeasureCache == <span class="keyword">null</span>) mMeasureCache = <span class="keyword">new</span> LongSparseLongArray(<span class="number">2</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</div><div class="line">			widthMeasureSpec != mOldWidthMeasureSpec ||</div><div class="line">			heightMeasureSpec != mOldHeightMeasureSpec) &#123;</div><div class="line"></div><div class="line">		<span class="comment">// first clears the measured dimension flag</span></div><div class="line">		mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">		resolveRtlPropertiesIfNeeded();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</div><div class="line">				mMeasureCache.indexOfKey(key);</div><div class="line">		<span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</div><div class="line">			<span class="comment">// 调用onMeasure方法</span></div><div class="line">			<span class="comment">// measure ourselves, this should set the measured dimension flag back</span></div><div class="line">			onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">			mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">			<span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></div><div class="line">			setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</div><div class="line">			mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// flag not set, setMeasuredDimension() was not invoked, we raise</span></div><div class="line">		<span class="comment">// an exception to warn the developer</span></div><div class="line">		<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">			<span class="comment">// 重写onMeausre方法的时，必须调用setMeasuredDimension或者super.onMeasure方法，不然就会走到这里报错。</span></div><div class="line">			<span class="comment">// setMeasuredDimension中回去改变mPrivateFlags的值</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"onMeasure() did not set the"</span></div><div class="line">					+ <span class="string">" measured dimension by calling"</span></div><div class="line">					+ <span class="string">" setMeasuredDimension()"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">	mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">	mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</div><div class="line">			(<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>measure</code>方法中会调用<code>onMeasure</code>方法。<code>ViewGroup</code>的子类会重写该方法来进行测量大小，因为<code>mView</code>是<code>DecorView</code>，<br>而<code>DecorView</code>是<code>FrameLayout</code>的子类。所以我们看一下<code>FrameLayout.onMeasure</code>方法：<br><code>FrameLayout.onMeasure</code>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> measureMatchParentChildren =</div><div class="line">			MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">			MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">	mMatchParentChildren.clear();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="comment">// 调用该方法去测量每个子View</span></div><div class="line">			measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">			maxWidth = Math.max(maxWidth,</div><div class="line">					child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">			maxHeight = Math.max(maxHeight,</div><div class="line">					child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">			childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">			<span class="keyword">if</span> (measureMatchParentChildren) &#123;</div><div class="line">				<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">						lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">					mMatchParentChildren.add(child);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Account for padding too</span></div><div class="line">	maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">	maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	<span class="comment">// Check against our minimum height and width</span></div><div class="line">	maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">	maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">	<span class="comment">// Check against our foreground's minimum height and width</span></div><div class="line">	<span class="keyword">final</span> Drawable drawable = getForeground();</div><div class="line">	<span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</div><div class="line">		maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">		maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">			resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">					childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line"></div><div class="line">	count = mMatchParentChildren.size();</div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = mMatchParentChildren.get(i);</div><div class="line"></div><div class="line">			<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec;</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredWidth() -</div><div class="line">						getPaddingLeftWithForeground() - getPaddingRightWithForeground() -</div><div class="line">						lp.leftMargin - lp.rightMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">						getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">						lp.leftMargin + lp.rightMargin,</div><div class="line">						lp.width);</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredHeight() -</div><div class="line">						getPaddingTopWithForeground() - getPaddingBottomWithForeground() -</div><div class="line">						lp.topMargin - lp.bottomMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">						getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">						lp.topMargin + lp.bottomMargin,</div><div class="line">						lp.height);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到内部会调用<code>measureChildWithMargins()</code>方法,该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Ask one of the children of this view to measure itself, taking into</div><div class="line"> * account both the MeasureSpec requirements for this view and its padding</div><div class="line"> * and margins. The child must have MarginLayoutParams The heavy lifting is</div><div class="line"> * done in getChildMeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The child to measure</div><div class="line"> * <span class="doctag">@param</span> parentWidthMeasureSpec The width requirements for this view</div><div class="line"> * <span class="doctag">@param</span> widthUsed Extra space that has been used up by the parent</div><div class="line"> *        horizontally (possibly by other children of the parent)</div><div class="line"> * <span class="doctag">@param</span> parentHeightMeasureSpec The height requirements for this view</div><div class="line"> * <span class="doctag">@param</span> heightUsed Extra space that has been used up by the parent</div><div class="line"> *        vertically (possibly by other children of the parent)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">		<span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">		<span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">	<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">			mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">					+ widthUsed, lp.width);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">			mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">					+ heightUsed, lp.height);</div><div class="line"></div><div class="line">	child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面就是对该子<code>View</code>调用了<code>measure</code>方法，我们假设这个<code>View</code>已经不是<code>ViewGroup</code>了，就会又和上面一样，又调用<code>onMeasure</code>方法，<br>下面我们直接看一下<code>View.onMeasure()</code>方法：<br><code>View.onMeasure()</code>方法的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line"> * should be overriden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass's responsibility to make</div><div class="line"> * sure the measured height and width are at least the view's minimum height</div><div class="line"> * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line"> * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="comment">// 如果不重写onMeasure方法，默认会调用getDefaultSize获取大小，下面会说getDefaultSize这个方法。</span></div><div class="line">	setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">			getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimension()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;This method must be called by &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to store the</div><div class="line"> * measured width and measured height. Failing to do so will trigger an</div><div class="line"> * exception at measurement time.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">		measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">		measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">	&#125;</div><div class="line">	setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimensionRaw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets the measured dimension without extra processing for things like optical bounds.</div><div class="line"> * Useful for reapplying consistent values that have already been cooked with adjustments</div><div class="line"> * for optical bounds, etc. such as those from the measurement cache.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="comment">// 赋值给mMeasuredWidth，getMeasuredWidth就会调用该值。</span></div><div class="line">	mMeasuredWidth = measuredWidth;</div><div class="line">	mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">	<span class="comment">// 这就是重写onMeasure方法时如果不调用setMeasuredDimension方法时为什么会报错的原因。</span></div><div class="line">	mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们接着看一下上面用到的<code>getDefaultSize()</code>方法，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size Default size for this view</div><div class="line"> * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line"> * <span class="doctag">@return</span> The size this view should be.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> result = size;</div><div class="line">	<span class="comment">// measureSpec值用于获取宽度(高度)的规格和大小，解析出对应的size和mode</span></div><div class="line">	<span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">	<span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (specMode) &#123;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">		result = size;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">	<span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">		result = specSize;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>getDefaultSize</code>方法又会使用到<code>MeasureSpec</code>类，文档中对<code>MeasureSpec</code>是这样介绍的<code>A MeasureSpec is comprised of a size and a mode. There are three possible modes:</code></p>
<ul>
<li>MeasureSpec.EXACTLY The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.<br>  理解成MATCH_PARENT或者在布局中指定了宽高值，如layout:width=’50dp’</li>
<li>MeasureSpec.AT_MOST The child can be as large as it wants up to the specified size.理解成WRAP_CONTENT,这是的值是父View可以允许的最大的值，只要不超过这个值都可以。</li>
<li>MeasureSpec.UNSPECIFIED The parent has not imposed any constraint on the child. It can be whatever size it wants. 这种情况比较少，一般用不到。</li>
</ul>
<p>这里简单总结一下上面的过程:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">performMeasure() &#123;</div><div class="line">	- <span class="number">1</span>.调用View.measure方法</div><div class="line">	mView.measure():</div><div class="line">		- <span class="number">2</span>.measure内部会调用onMeasure方法,但是因为这里mView是DecorView，所以会调用FrameLayout的onMeasure方法。</div><div class="line">	        onMeasure(FrameLayout)</div><div class="line">			- <span class="number">3</span>. 内部设置ViewGroup的宽高</div><div class="line">				setMeasuredDimension</div><div class="line">				并且对每个子View进行遍历测量</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					- <span class="number">4</span>. 对每个子View调用measureChildWithMargins方法</div><div class="line">					measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);	</div><div class="line">					    -<span class="number">5</span>. measureChildWithMargins内部调用子View的measure方法</div><div class="line">					        meausre</div><div class="line">							- <span class="number">6</span>. measure方法内部又调用onMeasure方法</div><div class="line">					            onMeasure(View)</div><div class="line">					            - <span class="number">7</span>. onMeasure方法内部调用setMeasuredDimension</div><div class="line">									setMeasuredDimension</div><div class="line">									- <span class="number">8</span>. setMeasuredDimension内部调用setMeasuredDimensionRaw</div><div class="line">									    setMeasuredDimensionRaw</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码中能看到<code>measure</code>是<code>final</code>的，我们可以重写<code>onMeasure</code>来实现<code>measure</code>过程。<br>到这里基本都讲完了，我们在开发中会按照需要重写<code>onMeasure</code>方法，然后调用<code>setMeasuredDimension</code>方法设置大小，<br>ps:譬如我们设置了<code>setMeasuredDimension(10, 10)</code>,那么不管布局中怎么设置这个<code>View</code>的大小<br>都是没用的，最后显示出来大小都是10*10。</p>
<h1 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a><code>Layout</code></h1><p><code>performLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	mLayoutRequested = <span class="keyword">false</span>;</div><div class="line">	mScrollMayChange = <span class="keyword">true</span>;</div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> View host = mView;</div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_LAYOUT) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Laying out "</span> + host + <span class="string">" to ("</span> +</div><div class="line">				host.getMeasuredWidth() + <span class="string">", "</span> + host.getMeasuredHeight() + <span class="string">")"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"layout"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 把刚才测量的宽高设置进来</span></div><div class="line">		host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">		mInLayout = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">		<span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// requestLayout() was called during layout.</span></div><div class="line">			<span class="comment">// If no layout-request flags are set on the requesting views, there is no problem.</span></div><div class="line">			<span class="comment">// If some requests are still pending, then we need to clear those flags and do</span></div><div class="line">			<span class="comment">// a full request/measure/layout pass to handle this situation.</span></div><div class="line">			ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">					<span class="keyword">false</span>);</div><div class="line">			<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Set this flag to indicate that any further requests are happening during</span></div><div class="line">				<span class="comment">// the second pass, which may result in posting those requests to the next</span></div><div class="line">				<span class="comment">// frame instead</span></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Process fresh layout requests, then measure and layout</span></div><div class="line">				<span class="keyword">int</span> numValidRequests = validLayoutRequesters.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">					<span class="keyword">final</span> View view = validLayoutRequesters.get(i);</div><div class="line">					Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">							<span class="string">" during layout: running second layout pass"</span>);</div><div class="line">					view.requestLayout();</div><div class="line">				&#125;</div><div class="line">				measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">						desiredWindowWidth, desiredWindowHeight);</div><div class="line">				mInLayout = <span class="keyword">true</span>;</div><div class="line">				host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Check the valid requests again, this time without checking/clearing the</span></div><div class="line">				<span class="comment">// layout flags, since requests happening during the second pass get noop'd</span></div><div class="line">				validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">					<span class="comment">// Post second-pass requests to the next frame</span></div><div class="line">					getRunQueue().post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">						<span class="meta">@Override</span></div><div class="line">						<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">							<span class="keyword">int</span> numValidRequests = finalRequesters.size();</div><div class="line">							<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">								<span class="keyword">final</span> View view = finalRequesters.get(i);</div><div class="line">								Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">										<span class="string">" during second layout pass: posting in next frame"</span>);</div><div class="line">								view.requestLayout();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>layout()</code>方法，因为<code>host</code>是<code>mView</code>，<code>ViewGroup</code>中重写了<code>layout</code>方法，并调用了<code>super.layout</code>.<br>所以我们直接看<code>View.layout()</code>方法，该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Assign a size and position to a view and all of its</div><div class="line"> * descendants</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line"> * (The first is measuring). In this phase, each parent calls</div><div class="line"> * layout on all of its children to position them.</div><div class="line"> * This is typically done using the child measurements</div><div class="line"> * that were stored in the measure pass().&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Derived classes should not override this method.</div><div class="line"> * Derived classes with children should override</div><div class="line"> * onLayout. In that method, they should</div><div class="line"> * call layout on each of their children.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> t Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> r Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> b Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">		onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">		mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> oldL = mLeft;</div><div class="line">	<span class="keyword">int</span> oldT = mTop;</div><div class="line">	<span class="keyword">int</span> oldB = mBottom;</div><div class="line">	<span class="keyword">int</span> oldR = mRight;</div><div class="line"></div><div class="line">	<span class="comment">// 这部分是判断这个View的大小是否已经发生了变化，来判断是否需要重绘。</span></div><div class="line">	<span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">			setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">		<span class="comment">// 内部调用onLayout方法</span></div><div class="line">		onLayout(changed, l, t, r, b);</div><div class="line">		mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">			ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">					(ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">			<span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">				listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">	mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里会调用<code>onLayout</code>方法，同样因为<code>mView</code>是<code>FrameLayout</code>的子类，所以我们要看<code>FrameLayout</code>的<code>onLayout</code>方法，<br>这里我们先看一下<code>ViewGroup.onLayout</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></div><div class="line">		<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b);</div></pre></td></tr></table></figure></p>
<p>是个抽象方法，所以<code>ViewGroup</code>的子类都需要实现该方法。<br>我们看一下<code>FrameLayout.onLayout</code>方法,源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">	layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">							  <span class="keyword">boolean</span> forceLeftGravity) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	mForegroundBoundsChanged = <span class="keyword">true</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</div><div class="line"></div><div class="line">			<span class="keyword">int</span> childLeft;</div><div class="line">			<span class="keyword">int</span> childTop;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">			<span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</div><div class="line">				gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">					childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</div><div class="line">					lp.leftMargin - lp.rightMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">					<span class="keyword">if</span> (!forceLeftGravity) &#123;</div><div class="line">						childLeft = parentRight - width - lp.rightMargin;</div><div class="line">						<span class="keyword">break</span>;</div><div class="line">					&#125;</div><div class="line">				<span class="keyword">case</span> Gravity.LEFT:</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childLeft = parentLeft + lp.leftMargin;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.TOP:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">					childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">					lp.topMargin - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">					childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//调用子View的layout方法</span></div><div class="line">			child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>View.layout</code>方法，又会调用到<code>View.onLayout</code>方法，我们假设这个子<code>View</code>不是<code>ViewGroup</code>.<br>看一下<code>View.onLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called from layout when this view should</div><div class="line"> * assign a size and position to each of its children.</div><div class="line"> *</div><div class="line"> * Derived classes with children should override</div><div class="line"> * this method and call layout on each of</div><div class="line"> * their children.</div><div class="line"> * <span class="doctag">@param</span> changed This is a new size or position for this view</div><div class="line"> * <span class="doctag">@param</span> left Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> top Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> right Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> bottom Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是一个空方法，这是因为<code>Layout</code>需要<code>ViewGroup</code>来控制进行。      </p>
<p>这里也总结一下<code>layout</code>的过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	- <span class="number">1</span>. host.layout</div><div class="line">	host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">		-<span class="number">2</span>. layout方法会分别调用setFrame()和onLayout()方法</div><div class="line">			setFrame()</div><div class="line">			onLayout()</div><div class="line">			-<span class="number">3</span>. 因为host是mView也就是DecorView也就是FrameLayout的子类。FrameLayout的onLayout方法如下</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">					    -<span class="number">4</span>. 遍历每个子View，并分别调用layout方法。</div><div class="line">						child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a><code>Draw</code></h1><p>绘制阶段是从<code>ViewRootImpl</code>中的<code>performDraw</code>方法开始的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">	mFullRedrawNeeded = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mIsDrawing = <span class="keyword">true</span>;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"draw"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 开始draw了</span></div><div class="line">		draw(fullRedrawNeeded);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		mIsDrawing = <span class="keyword">false</span>;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// For whatever reason we didn't create a HardwareRenderer, end any</span></div><div class="line">	<span class="comment">// hardware animations that are now dangling</span></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mPendingAnimatingRenderNodes != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mAttachInfo.mPendingAnimatingRenderNodes.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</div><div class="line">		&#125;</div><div class="line">		mAttachInfo.mPendingAnimatingRenderNodes.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mReportNextDraw) &#123;</div><div class="line">		mReportNextDraw = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span>) &#123;</div><div class="line">			mAttachInfo.mHardwareRenderer.fence();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"FINISHED DRAWING: "</span> + mWindowAttributes.getTitle());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span> &amp;&amp; mSurface.isValid()) &#123;</div><div class="line">			mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">			SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</div><div class="line">			<span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (SurfaceHolder.Callback c : callbacks) &#123;</div><div class="line">					<span class="keyword">if</span> (c <span class="keyword">instanceof</span> SurfaceHolder.Callback2) &#123;</div><div class="line">						((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(</div><div class="line">								mSurfaceHolder);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			mWindowSession.finishDrawing(mWindow);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>draw</code>方法，<code>draw</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</div><div class="line">	Surface surface = mSurface;</div><div class="line">	<span class="keyword">if</span> (!surface.isValid()) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_FPS) &#123;</div><div class="line">		trackFPS();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!sFirstDrawComplete) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (sFirstDrawHandlers) &#123;</div><div class="line">			sFirstDrawComplete = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = sFirstDrawHandlers.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; count; i++) &#123;</div><div class="line">				mHandler.post(sFirstDrawHandlers.get(i));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	scrollToRectOrFocus(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mViewScrollChanged) &#123;</div><div class="line">		mAttachInfo.mViewScrollChanged = <span class="keyword">false</span>;</div><div class="line">		mAttachInfo.mTreeObserver.dispatchOnScrollChanged();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> animating = mScroller != <span class="keyword">null</span> &amp;&amp; mScroller.computeScrollOffset();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> curScrollY;</div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		curScrollY = mScroller.getCurrY();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		curScrollY = mScrollY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mCurScrollY != curScrollY) &#123;</div><div class="line">		mCurScrollY = curScrollY;</div><div class="line">		fullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> appScale = mAttachInfo.mApplicationScale;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> scalingRequired = mAttachInfo.mScalingRequired;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> resizeAlpha = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mResizeBuffer != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">long</span> deltaTime = SystemClock.uptimeMillis() - mResizeBufferStartTime;</div><div class="line">		<span class="keyword">if</span> (deltaTime &lt; mResizeBufferDuration) &#123;</div><div class="line">			<span class="keyword">float</span> amt = deltaTime/(<span class="keyword">float</span>) mResizeBufferDuration;</div><div class="line">			amt = mResizeInterpolator.getInterpolation(amt);</div><div class="line">			animating = <span class="keyword">true</span>;</div><div class="line">			resizeAlpha = <span class="number">255</span> - (<span class="keyword">int</span>)(amt*<span class="number">255</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect dirty = mDirty;</div><div class="line">	<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The app owns the surface, we won't draw.</span></div><div class="line">		dirty.setEmpty();</div><div class="line">		<span class="keyword">if</span> (animating) &#123;</div><div class="line">			<span class="keyword">if</span> (mScroller != <span class="keyword">null</span>) &#123;</div><div class="line">				mScroller.abortAnimation();</div><div class="line">			&#125;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (fullRedrawNeeded) &#123;</div><div class="line">		mAttachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		dirty.set(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">int</span>) (mWidth * appScale + <span class="number">0.5f</span>), (<span class="keyword">int</span>) (mHeight * appScale + <span class="number">0.5f</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Draw "</span> + mView + <span class="string">"/"</span></div><div class="line">				+ mWindowAttributes.getTitle()</div><div class="line">				+ <span class="string">": dirty=&#123;"</span> + dirty.left + <span class="string">","</span> + dirty.top</div><div class="line">				+ <span class="string">","</span> + dirty.right + <span class="string">","</span> + dirty.bottom + <span class="string">"&#125; surface="</span></div><div class="line">				+ surface + <span class="string">" surface.isValid()="</span> + surface.isValid() + <span class="string">", appScale:"</span> +</div><div class="line">				appScale + <span class="string">", width="</span> + mWidth + <span class="string">", height="</span> + mHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mAttachInfo.mTreeObserver.dispatchOnDraw();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> xOffset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> yOffset = curScrollY;</div><div class="line">	<span class="keyword">final</span> WindowManager.LayoutParams params = mWindowAttributes;</div><div class="line">	<span class="keyword">final</span> Rect surfaceInsets = params != <span class="keyword">null</span> ? params.surfaceInsets : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (surfaceInsets != <span class="keyword">null</span>) &#123;</div><div class="line">		xOffset -= surfaceInsets.left;</div><div class="line">		yOffset -= surfaceInsets.top;</div><div class="line"></div><div class="line">		<span class="comment">// Offset dirty rect for surface insets.</span></div><div class="line">		dirty.offset(surfaceInsets.left, surfaceInsets.right);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating) &#123;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</div><div class="line">			<span class="comment">// Draw with hardware renderer.</span></div><div class="line">			mIsAnimating = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">boolean</span> invalidateRoot = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</div><div class="line">				mHardwareYOffset = yOffset;</div><div class="line">				mHardwareXOffset = xOffset;</div><div class="line">				mAttachInfo.mHardwareRenderer.invalidateRoot();</div><div class="line">			&#125;</div><div class="line">			mResizeAlpha = resizeAlpha;</div><div class="line"></div><div class="line">			dirty.setEmpty();</div><div class="line"></div><div class="line">			mBlockResizeBuffer = <span class="keyword">false</span>;</div><div class="line">			mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// If we get here with a disabled &amp; requested hardware renderer, something went</span></div><div class="line">			<span class="comment">// wrong (an invalidate posted right before we destroyed the hardware surface</span></div><div class="line">			<span class="comment">// for instance) so we should just bail out. Locking the surface with software</span></div><div class="line">			<span class="comment">// rendering at this point would lock it forever and prevent hardware renderer</span></div><div class="line">			<span class="comment">// from doing its job when it comes back.</span></div><div class="line">			<span class="comment">// Before we request a new frame we must however attempt to reinitiliaze the</span></div><div class="line">			<span class="comment">// hardware renderer if it's in requested state. This would happen after an</span></div><div class="line">			<span class="comment">// eglTerminate() for instance.</span></div><div class="line">			<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp;</div><div class="line">					!mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</div><div class="line">					mAttachInfo.mHardwareRenderer.isRequested()) &#123;</div><div class="line"></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mAttachInfo.mHardwareRenderer.initializeIfNeeded(</div><div class="line">							mWidth, mHeight, mSurface, surfaceInsets);</div><div class="line">				&#125; <span class="keyword">catch</span> (OutOfResourcesException e) &#123;</div><div class="line">					handleOutOfResourcesException(e);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				scheduleTraversals();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="comment">// draw的部分在这里。。。内部会用canvas去画</span></div><div class="line">			<span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">		scheduleTraversals();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>drawSoftware</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@return</span> true if drawing was successful, false if an error occurred</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></div><div class="line">		<span class="keyword">boolean</span> scalingRequired, Rect dirty) &#123;</div><div class="line"></div><div class="line">	<span class="comment">// Draw with software renderer.</span></div><div class="line">	<span class="keyword">final</span> Canvas canvas;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> left = dirty.left;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> top = dirty.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> right = dirty.right;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> bottom = dirty.bottom;</div><div class="line"></div><div class="line">		canvas = mSurface.lockCanvas(dirty);</div><div class="line"></div><div class="line">		<span class="comment">// The dirty rectangle can be modified by Surface.lockCanvas()</span></div><div class="line">		<span class="comment">//noinspection ConstantConditions</span></div><div class="line">		<span class="keyword">if</span> (left != dirty.left || top != dirty.top || right != dirty.right</div><div class="line">				|| bottom != dirty.bottom) &#123;</div><div class="line">			attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> Do this in native</span></div><div class="line">		canvas.setDensity(mDensity);</div><div class="line">	&#125; <span class="keyword">catch</span> (Surface.OutOfResourcesException e) &#123;</div><div class="line">		handleOutOfResourcesException(e);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">		Log.e(TAG, <span class="string">"Could not lock surface"</span>, e);</div><div class="line">		<span class="comment">// Don't assume this is due to out of memory, it could be</span></div><div class="line">		<span class="comment">// something else, and if it is something else then we could</span></div><div class="line">		<span class="comment">// kill stuff (or ourself) for no reason.</span></div><div class="line">		mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" drawing to bitmap w="</span></div><div class="line">					+ canvas.getWidth() + <span class="string">", h="</span> + canvas.getHeight());</div><div class="line">			<span class="comment">//canvas.drawARGB(255, 255, 0, 0);</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// If this bitmap's format includes an alpha channel, we</span></div><div class="line">		<span class="comment">// need to clear it before drawing so that the child will</span></div><div class="line">		<span class="comment">// properly re-composite its drawing on a transparent</span></div><div class="line">		<span class="comment">// background. This automatically respects the clip/dirty region</span></div><div class="line">		<span class="comment">// or</span></div><div class="line">		<span class="comment">// If we are applying an offset, we need to clear the area</span></div><div class="line">		<span class="comment">// where the offset doesn't appear to avoid having garbage</span></div><div class="line">		<span class="comment">// left in the blank areas.</span></div><div class="line">		<span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</div><div class="line">			canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		dirty.setEmpty();</div><div class="line">		mIsAnimating = <span class="keyword">false</span>;</div><div class="line">		attachInfo.mDrawingTime = SystemClock.uptimeMillis();</div><div class="line">		mView.mPrivateFlags |= View.PFLAG_DRAWN;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DEBUG_DRAW) &#123;</div><div class="line">			Context cxt = mView.getContext();</div><div class="line">			Log.i(TAG, <span class="string">"Drawing: package:"</span> + cxt.getPackageName() +</div><div class="line">					<span class="string">", metrics="</span> + cxt.getResources().getDisplayMetrics() +</div><div class="line">					<span class="string">", compatibilityInfo="</span> + cxt.getResources().getCompatibilityInfo());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			canvas.translate(-xoff, -yoff);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateCanvas(canvas);</div><div class="line">			&#125;</div><div class="line">			canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</div><div class="line">			attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			</div><div class="line">			<span class="comment">// 内部会去调用View.draw()；</span></div><div class="line">			mView.draw(canvas);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!attachInfo.mSetIgnoreDirtyState) &#123;</div><div class="line">				<span class="comment">// Only clear the flag if it was not set during the mView.draw() call</span></div><div class="line">				attachInfo.mIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			surface.unlockCanvasAndPost(canvas);</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">			Log.e(TAG, <span class="string">"Could not unlock surface"</span>, e);</div><div class="line">			mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">			<span class="comment">//noinspection ReturnInsideFinallyBlock</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" unlockCanvasAndPost"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码中调用了<code>mView.draw()</code>方法，所以我们看一下<code>FrameLayout.draw()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.draw(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mForeground != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> Drawable foreground = mForeground;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mForegroundBoundsChanged) &#123;</div><div class="line">			mForegroundBoundsChanged = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">final</span> Rect selfBounds = mSelfBounds;</div><div class="line">			<span class="keyword">final</span> Rect overlayBounds = mOverlayBounds;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> w = mRight-mLeft;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> h = mBottom-mTop;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mForegroundInPadding) &#123;</div><div class="line">				selfBounds.set(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				selfBounds.set(mPaddingLeft, mPaddingTop, w - mPaddingRight, h - mPaddingBottom);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			Gravity.apply(mForegroundGravity, foreground.getIntrinsicWidth(),</div><div class="line">					foreground.getIntrinsicHeight(), selfBounds, overlayBounds,</div><div class="line">					layoutDirection);</div><div class="line">			foreground.setBounds(overlayBounds);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		foreground.draw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部调用了<code>super.draw()</code>，而<code>ViewGroup</code>没有重写该方法，所以直接看<code>View</code>的<code>draw()</code>方法.<br><code>View.draw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Manually render this view (and all of its children) to the given Canvas.</div><div class="line"> * The view must have already done a full layout before this function is</div><div class="line"> * called.  When implementing a view, implement</div><div class="line"> * &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line"> * If you do need to override this method, call the superclass version.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The Canvas to which the View is rendered.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">			(mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">	mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">	<span class="comment">// 这里注释说的很明白了，draw的6个步骤。</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Draw traversal performs several drawing steps which must be executed</div><div class="line">	 * in the appropriate order:</div><div class="line">	 *</div><div class="line">	 *      1. Draw the background</div><div class="line">	 *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">	 *      3. Draw view's content, 调用onDraw方法绘制自身</div><div class="line">	 *      4. Draw children, 调用dispatchDraw方法绘制子View</div><div class="line">	 *      5. If necessary, draw the fading edges and restore layers</div><div class="line">	 *      6. Draw decorations (scrollbars for instance)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">	<span class="keyword">int</span> saveCount;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">		drawBackground(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">	<span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">		<span class="comment">// Step 3, draw the content</span></div><div class="line">		<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 4, draw the children</span></div><div class="line">		dispatchDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">		onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">			mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// we're done...</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Here we do the full fledged routine...</div><div class="line">	 * (this is an uncommon case where speed matters less,</div><div class="line">	 * this is why we repeat some of the tests that have been</div><div class="line">	 * done above)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> drawTop = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawBottom = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawLeft = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawRight = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> topFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> bottomFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> leftFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> rightFadeStrength = <span class="number">0.0f</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Step 2, save the canvas' layers</span></div><div class="line">	<span class="keyword">int</span> paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> offsetRequired = isPaddingOffsetRequired();</div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		paddingLeft += getLeftPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> left = mScrollX + paddingLeft;</div><div class="line">	<span class="keyword">int</span> right = left + mRight - mLeft - mPaddingRight - paddingLeft;</div><div class="line">	<span class="keyword">int</span> top = mScrollY + getFadeTop(offsetRequired);</div><div class="line">	<span class="keyword">int</span> bottom = top + getFadeHeight(offsetRequired);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		right += getRightPaddingOffset();</div><div class="line">		bottom += getBottomPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ScrollabilityCache scrollabilityCache = mScrollCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> fadeHeight = scrollabilityCache.fadingEdgeLength;</div><div class="line">	<span class="keyword">int</span> length = (<span class="keyword">int</span>) fadeHeight;</div><div class="line"></div><div class="line">	<span class="comment">// clip the fade length if top and bottom fades overlap</span></div><div class="line">	<span class="comment">// overlapping fades produce odd-looking artifacts</span></div><div class="line">	<span class="keyword">if</span> (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) &#123;</div><div class="line">		length = (bottom - top) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// also clip horizontal fades if necessary</span></div><div class="line">	<span class="keyword">if</span> (horizontalEdges &amp;&amp; (left + length &gt; right - length)) &#123;</div><div class="line">		length = (right - left) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (verticalEdges) &#123;</div><div class="line">		topFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getTopFadingEdgeStrength()));</div><div class="line">		drawTop = topFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		bottomFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getBottomFadingEdgeStrength()));</div><div class="line">		drawBottom = bottomFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (horizontalEdges) &#123;</div><div class="line">		leftFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getLeftFadingEdgeStrength()));</div><div class="line">		drawLeft = leftFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		rightFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getRightFadingEdgeStrength()));</div><div class="line">		drawRight = rightFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	saveCount = canvas.getSaveCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> solidColor = getSolidColor();</div><div class="line">	<span class="keyword">if</span> (solidColor == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">			canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">			canvas.saveLayer(left, bottom - length, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">			canvas.saveLayer(left, top, left + length, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">			canvas.saveLayer(right - length, top, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		scrollabilityCache.setFadeColor(solidColor);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Step 3, draw the content</span></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 4, draw the children</span></div><div class="line">	dispatchDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 5, draw the fade effect and restore layers</span></div><div class="line">	<span class="keyword">final</span> Paint p = scrollabilityCache.paint;</div><div class="line">	<span class="keyword">final</span> Matrix matrix = scrollabilityCache.matrix;</div><div class="line">	<span class="keyword">final</span> Shader fade = scrollabilityCache.shader;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, right, top + length, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * bottomFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">180</span>);</div><div class="line">		matrix.postTranslate(left, bottom);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, bottom - length, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * leftFadeStrength);</div><div class="line">		matrix.postRotate(-<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, left + length, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * rightFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(right, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(right - length, top, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	canvas.restoreToCount(saveCount);</div><div class="line"></div><div class="line">	<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">	onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">		mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面会调用<code>onDraw</code>和<code>dispatchDraw</code>方法。<br>我们先看一下<code>View.onDraw</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this to do your drawing.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas the canvas on which the background will be drawn</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是空方法，这是也很好理解，因为每个<code>View</code>的展现都不一样，例如<code>TextView</code>、<code>ProgressBar</code>等，<br>所以<code>View</code>不会去实现<code>onDraw</code>方法，具体是要子类去根据自己的显示要求实现该方法。</p>
<p>再看一下<code>dispatchDraw</code>方法，这个方法是用来绘制子<code>View</code>的，所以要看<code>ViewGroup.dispatchDraw</code>方法，<code>View.dispatchDraw</code>是空的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">int</span> flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_RUN_ANIMATION) != <span class="number">0</span> &amp;&amp; canAnimate()) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> cache = (mGroupFlags &amp; FLAG_ANIMATION_CACHE) == FLAG_ANIMATION_CACHE;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> buildCache = !isHardwareAccelerated();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = children[i];</div><div class="line">			<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</div><div class="line">				<span class="keyword">final</span> LayoutParams params = child.getLayoutParams();</div><div class="line">				attachLayoutAnimationParameters(child, params, i, childrenCount);</div><div class="line">				bindLayoutAnimation(child);</div><div class="line">				<span class="keyword">if</span> (cache) &#123;</div><div class="line">					child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">					<span class="keyword">if</span> (buildCache) &#123;</div><div class="line">						child.buildDrawingCache(<span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LayoutAnimationController controller = mLayoutAnimationController;</div><div class="line">		<span class="keyword">if</span> (controller.willOverlap()) &#123;</div><div class="line">			mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		controller.start();</div><div class="line"></div><div class="line">		mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;</div><div class="line">		mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (cache) &#123;</div><div class="line">			mGroupFlags |= FLAG_CHILDREN_DRAWN_WITH_CACHE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAnimationListener != <span class="keyword">null</span>) &#123;</div><div class="line">			mAnimationListener.onAnimationStart(controller.getAnimation());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> clipSaveCount = <span class="number">0</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		clipSaveCount = canvas.save();</div><div class="line">		canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</div><div class="line">				mScrollX + mRight - mLeft - mPaddingRight,</div><div class="line">				mScrollY + mBottom - mTop - mPaddingBottom);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// We will draw our child's animation, let's reset the flag</span></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</div><div class="line">	mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> more = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">long</span> drawingTime = getDrawingTime();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertReorderBarrier();</div><div class="line">	<span class="comment">// Only use the preordered list if not HW accelerated, since the HW pipeline will do the</span></div><div class="line">	<span class="comment">// draw reordering internally</span></div><div class="line">	<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</div><div class="line">			? <span class="keyword">null</span> : buildOrderedChildList();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">			&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">		<span class="keyword">int</span> childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">		<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">				? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">		<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 调用drawChild方法</span></div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line"></div><div class="line">	<span class="comment">// Draw any disappearing views that have animations</span></div><div class="line">	<span class="keyword">if</span> (mDisappearingChildren != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> disappearingCount = disappearingChildren.size() - <span class="number">1</span>;</div><div class="line">		<span class="comment">// Go backwards -- we may delete as animations finish</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = disappearingCount; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = disappearingChildren.get(i);</div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (debugDraw()) &#123;</div><div class="line">		onDebugDraw(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		canvas.restoreToCount(clipSaveCount);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// mGroupFlags might have been updated by drawChild()</span></div><div class="line">	flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) &#123;</div><div class="line">		invalidate(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_ANIMATION_DONE) == <span class="number">0</span> &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == <span class="number">0</span> &amp;&amp;</div><div class="line">			mLayoutAnimationController.isDone() &amp;&amp; !more) &#123;</div><div class="line">		<span class="comment">// We want to erase the drawing cache and notify the listener after the</span></div><div class="line">		<span class="comment">// next frame is drawn because one extra invalidate() is caused by</span></div><div class="line">		<span class="comment">// drawChild() after the animation is over</span></div><div class="line">		mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;</div><div class="line">		<span class="keyword">final</span> Runnable end = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">		   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			   notifyAnimationListener();</div><div class="line">		   &#125;</div><div class="line">		&#125;;</div><div class="line">		post(end);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到上面的方法中会调用<code>drawChild</code>方法，该方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Draw one child of this View Group. This method is responsible for getting</div><div class="line"> * the canvas in the right state. This includes clipping, translating so</div><div class="line"> * that the child's scrolled origin is at 0, 0, and applying any animation</div><div class="line"> * transformations.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The canvas on which to draw the child</div><div class="line"> * <span class="doctag">@param</span> child Who to draw</div><div class="line"> * <span class="doctag">@param</span> drawingTime The time at which draw is occurring</div><div class="line"> * <span class="doctag">@return</span> True if an invalidate() was issued</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里也简单总结一下<code>draw</code>的过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. ViewRootImpl.performDraw()</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 2. ViewRootImpl.draw()</span></div><div class="line">	draw(fullRedrawNeeded);	</div><div class="line">		<span class="comment">// 3. ViewRootImpl.drawSoftware</span></div><div class="line">		drawSoftware</div><div class="line">			<span class="comment">// 4. 内部调用mView.draw,也就是FrameLayout.draw(). </span></div><div class="line">			mView.draw()(FrameLayout)</div><div class="line">				<span class="comment">// 5. FrameLayout.draw方法内部会调用super.draw方法，也就是View.draw方法.</span></div><div class="line">				<span class="keyword">super</span>.draw(canvas);</div><div class="line">					<span class="comment">// 6. View.draw方法内部会分别调用onDraw绘制自己以及dispatchDraw绘制子View.</span></div><div class="line">					onDraw</div><div class="line">					<span class="comment">// 绘制子View</span></div><div class="line">					dispatchDraw</div><div class="line">						<span class="comment">// 7. dispatchDraw方法内部会遍历所有子View.</span></div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">							<span class="comment">// 8. 对每个子View分别调用drawChild方法</span></div><div class="line">							drawChild()</div><div class="line">								<span class="comment">// 9. drawChild方法内部会对该子View调用draw方法，进行绘制。然后draw又会调用onDraw等，循环就开始了。 </span></div><div class="line">									child.draw()</div><div class="line">						&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后补充一个小问题： <code>getWidth()</code>与<code>getMeasuredWidth()</code>有什么区别呢？<br>一般情况下这两个的值是相同的，<code>getMeasureWidth()</code>方法在<code>measure()</code>过程结束后就可以获取到了，而<code>getWidth()</code>方法要在<code>layout()</code>过程结束后才能获取到。<br>而且<code>getMeasureWidth()</code>的值是通过<code>setMeasuredDimension()</code>设置的，但是<code>getWidth()</code>的值是通过视图右边的坐标减去左边的坐标计算出来的。如果我们在<code>layout</code>的时候将宽高<br>不传<code>getMeasureWidth</code>的值，那么这时候<code>getWidth()</code>与<code>getMeasuredWidth</code>的值就不会再相同了，当然一般也不会这么干…</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/View绘制过程详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Lantern</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>