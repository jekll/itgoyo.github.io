<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/5/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=110 src="//music.163.com/outchain/player?type=0&id=120897804&auto=0&height=90"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-如何让Service常驻内存" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/如何让Service常驻内存/">如何让Service常驻内存</a>
    </h1>
  

        
        <a href="/2015/01/01/如何让Service常驻内存/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="如何让Service常驻内存"><a href="#如何让Service常驻内存" class="headerlink" title="如何让Service常驻内存"></a>如何让Service常驻内存</h1><p>我非常鄙视这种行文，一个公司应该想到如何把产品做的更完善，而不是用这些技术来损害用户的利益，来获取自己肮脏的所谓的功能。</p>
<ul>
<li>Service设置成START_STICKY，kill 后会被重启（等待5秒左右），重传Intent，保持与重启前一样</li>
<li>​通过 startForeground将进程设置为前台进程，做前台服务，优先级和前台应用一个级别​，除非在系统内存非常缺，否则此进程不会被 kill</li>
<li>双进程Service：让2个进程互相保护，其中一个Service被清理后，另外没被清理的进程可以立即重启进程</li>
<li>QQ黑科技:在应用退到后台后，另起一个只有 1 像素的页面停留在桌面上，让自己保持前台状态，保护自己不被后台清理工具杀死</li>
<li>在已经root的设备下，修改相应的权限文件，将App伪装成系统级的应用（Android4.0系列的一个漏洞，已经确认可行）</li>
<li><p>Android系统中当前进程(Process)fork出来的子进程，被系统认为是两个不同的进程。当父进程被杀死的时候，子进程仍然可以存活，并不受影响。<br>  鉴于目前提到的在Android-Service层做双守护都会失败，我们可以fork出c进程，多进程守护。死循环在那检查是否还存在，<br>  具体的思路如下（Android5.0以下可行）</p>
<ul>
<li>用C编写守护进程(即子进程)，守护进程做的事情就是循环检查目标进程是否存在，不存在则启动它。</li>
<li>在NDK环境中将1中编写的C代码编译打包成可执行文件(BUILD_EXECUTABLE)。</li>
<li>主进程启动时将守护进程放入私有目录下，赋予可执行权限，启动它即可。</li>
</ul>
</li>
<li><p>联系厂商，加入白名单</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/如何让Service常驻内存/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android6.0权限系统" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android6.0权限系统/">Android6.0权限系统</a>
    </h1>
  

        
        <a href="/2015/01/01/Android6.0权限系统/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android6-0权限系统"><a href="#Android6-0权限系统" class="headerlink" title="Android6.0权限系统"></a>Android6.0权限系统</h1><p><code>Android</code>权限系统是一个非常重要的安全问题，因为它只有在安装时会询问一次。一旦软件本安装之后，应用程序可以在用户毫不知情的情况下使用这些权限来获取所有的内容。     </p>
<p>很多坏蛋会通过这个安全缺陷来收集用户的个人信息并使用它们来做坏事的情况就不足为奇了。    </p>
<p><code>Android</code>团队也意识到了这个问题。在经过了7年后，权限系统终于被重新设置了。从<code>Anroid 6.0(API Level 23)</code>开始，应用程序在安装时不会被授予任何权限，取而代之的是在运行时应用回去请求用户授予对应的权限。这样可以让用户能更好的去控制应用功能。例如，一个用户可能会同一个拍照应用使用摄像头的权限，但是不同授权它获取设备位置的权限。用户可以在任何时候通过去应用的设置页面来撤销授权。    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/runtimepermission.jpg?raw=true" alt="image">  </p>
<p><strong>注意:</strong>上面请求权限的对话框不会自动弹出。开发者需要手动的调用。如果开发者调用了一些需要权限的功能，但是用户又拒绝授权的话，应用就会<code>crash</code>。   </p>
<p>系统权限被分为两类，<code>normal</code>和<code>dangerous</code>:    </p>
<ul>
<li><code>Normal Permissions</code>不需要用户直接授权，如果你的应用在清单文件中声明了Normal Permissions`，系统会自动授权该权限。    </li>
<li><code>Dangerous Permissions</code>可以让应用获取用户的私人数据。如果你的应用在清单文件中申请了<code>Dangerous Permissions</code>，那就必须要用户来授权给应用。   </li>
</ul>
<p><code>Normal Permissions</code>:<br><code>Normal Permission</code>是当用户安装或更新应用时，系统将授予应用所请求的权限，又称为<code>PROTECTION_NORMAL</code>（安装时授权的一类基本权限）。该类权限只需要在<code>manifest</code>文件中声明即可，安装时就授权，不需要每次使用时进行检查，而且用户不能取消以上授权。   </p>
<ul>
<li>ACCESS_LOCATION_EXTRA_COMMANDS</li>
<li>ACCESS_NETWORK_STATE</li>
<li>ACCESS_NOTIFICATION_POLICY</li>
<li>ACCESS_WIFI_STATE</li>
<li>BLUETOOTH</li>
<li>BLUETOOTH_ADMIN</li>
<li>BROADCAST_STICKY</li>
<li>CHANGE_NETWORK_STATE</li>
<li>CHANGE_WIFI_MULTICAST_STATE</li>
<li>CHANGE_WIFI_STATE</li>
<li>DISABLE_KEYGUARD</li>
<li>EXPAND_STATUS_BAR</li>
<li>GET_PACKAGE_SIZE</li>
<li>INSTALL_SHORTCUT</li>
<li>INTERNET</li>
<li>KILL_BACKGROUND_PROCESSES</li>
<li>MODIFY_AUDIO_SETTINGS</li>
<li>NFC</li>
<li>READ_SYNC_SETTINGS</li>
<li>READ_SYNC_STATS</li>
<li>RECEIVE_BOOT_COMPLETED</li>
<li>REORDER_TASKS</li>
<li>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</li>
<li>REQUEST_INSTALL_PACKAGES</li>
<li>SET_ALARM</li>
<li>SET_TIME_ZONE</li>
<li>SET_WALLPAPER</li>
<li>SET_WALLPAPER_HINTS</li>
<li>TRANSMIT_IR</li>
<li>UNINSTALL_SHORTCUT</li>
<li>USE_FINGERPRINT</li>
<li>VIBRATE</li>
<li>WAKE_LOCK</li>
<li>WRITE_SYNC_SETTINGS</li>
</ul>
<p>下图为<code>Dangerous permissions and permission groups</code>:  </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/permgroup.png?raw=true" alt="image">     </p>
<p>在所有的<code>Android</code>版本中，你的应用都需要在<code>manifest</code>文件中声明<code>normal</code>和<code>dangerous</code>权限。然而声明所影响的效果会因系统版本和你应用的<code>target SDK lever</code>有关:     </p>
<ul>
<li>如果设备运行的是<code>Android 5.1</code>或者之前的系统，或者应用的<code>targetSdkVersion</code>是22或者之前版本：如果你在<code>manifest</code>中声明了<code>dangerous permission</code>，用户需要在安装应用时授权这些权限。如果用户不授权这些权限，系统就不会安装该应用。(我试了下发现即使<code>targetSdkVersion</code>是22及以下，在6.0的手机上时，如果你安装时你不同意一些权限，也仍然可以安装的)  </li>
<li>如果设备运行的是<code>Android 6.0</code>或者更高的系统，并且你应用的<code>targetSdkVersion</code>是23或者更高:应用必须在<code>manifest</code>文件中申请这些权限，而且必须要在运行时对所需要的<code>dangerous permission</code>申请授权。用户可以统一或者拒绝授权，并且及时用户拒绝了授权，应用在无法使用一些功能的情况下也要保证能继续运行。     </li>
</ul>
<p>也就是说新的运行时权限仅当我们设置<code>targetSdkVersion</code>是23及以上时才会起作用。<br>如果你的<code>targtSdkVersion</code>低于23，那将被认为该应用没有经过<code>android 6.0</code>的测试，当该应用被安装到了6.0的手机上时，仍然会使用之前的旧权限规则，在安装时会提示所有需要的权限(这样做是有道理的，不然对于之前开发的应用，我们都要立马去修改让它适应6.0，来不及的话就导致6.0的手机都无法使用了，显然Android开发团队不会考虑不到这种情况)，当然用户可以在安装的界面不允许一些权限，那当程序使用到了这些权限时，会崩溃吗？答案是在<code>Android 6.0</code>及以上的手机会直接<code>crash</code>，但是在<code>23</code>之前的手机上不会<code>crash</code>。     </p>
<p>所以如果你的应用没有支持运行时权限的功能，那千万不要讲<code>targetSdkVersion</code>设置为23，否则就麻烦了。  </p>
<blockquote>
<p><strong><em>注意:</em></strong>从<code>Android 6.0(API Level 23)</code>开始，即使应用的<code>targetSdkVersion</code>是比较低的版本，但是用户仍然可以在任何时候撤销对应用的授权。所以不管应用的<code>targetSdkVerison</code>是什么版本，你都要测试你的应用在不能获取权限时能不能正常运行。 </p>
</blockquote>
<p>下面介绍下如何使用<code>Android Support Library</code>来检查和请求权限。<code>Android</code>框架在<code>6.0</code>开始也提供了相同的方法。然而使用<code>support</code>包会比较简单，因为这样你就不需要在请求方法时判断当前的系统版本。(后面说的这几个类都是<code>android.support.v4</code>中的)    </p>
<p>###检查权限    </p>
<p>如果应用需要使用<code>dangerous permission</code>，在任何时候执行需要该权限的操作时你都需要检查是否已经授权。用户可能会经常取消授权，所以即使昨天应用已经使用了摄像头，这也不能保证今天仍然有使用摄像头的权限。    </p>
<p>为了检查是否可以使用该权限，调用<code>ContextCompat.checkSelfPermission()</code>。<br>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Assume thisActivity is the current activity</span></div><div class="line"><span class="keyword">int</span> permissionCheck = ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">        Manifest.permission.WRITE_CALENDAR);</div></pre></td></tr></table></figure></p>
<p>如果应用有该权限，该方法将返回<code>PackageManager.PERMISSION_GRANTED</code>，应用可以进行相关的操作。如果应用不能使用该权限，该方法将返回<code>PERMISSION_DENIED</code>，这是应用将必须要向用户申请该权限。    </p>
<p>###申请使用权限</p>
<p>如果应用需要使用清单文件中申明的<code>dangerous permission</code>，它必须要向用户申请来授权。<code>Android</code>提供了几种申请授权的方法。使用这些方法时将会弹出一个标准的系统对话框，该对话框不能自定义。     </p>
<p>#####说明为什么应用需要使用这些权限      </p>
<p>在一些情况下，你可能需要帮助用力理解为什么需要该权限。例如，一个用户使用了一个照相的应用，用户不会奇怪为什么应用申请使用摄像头的权限，但是用户可能会不理解为什么应用需要获取位置或者联系人的权限。在请求一个权限之前，你需要该用户一个说明。一定要切记不要通过说明来压倒用户。如果你提供了太多的说明，用户可能会感觉沮丧并且会卸载它。   </p>
<p>一个你需要提供说明的合适时机就是在用户之前已经不同意授权该权限的情况下。如果一个用户继续尝试使用需要权限的功能时，但是之前确禁止了该权限的请求，这就可能是因为用户不理解为什么该功能需要使用该权限。在这种情况下，提供一个说明是非常合适的。  </p>
<p>为了能找到用户可能需要说明的情况，<code>android</code>提供了一个工具类方法<code>ActivityCompat.shouldShowRequestPermissionRationale().</code>。如果应用之前申请了该权限但是用户拒绝授权后该方法会返回<code>true</code>。(在Android 6.0之前调用的时候会直接返回false)     </p>
<blockquote>
<p><strong><em>注意：</em></strong>如果用户之前拒绝了权限申请并且选择了请求权限对话框中的<code>Don’t ask again</code>选项，该方法就会返回<code>false</code>。如果设备策略禁止了该应用使用该权限，该方法也会返回<code>false</code>。(我测试的时候发现请求权限的对话框中并没有<code>Don’t asdk again</code>这一项)<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/request_permission_dialog.png?raw=true" alt="image">      </p>
</blockquote>
<p>#####申请需要的权限      </p>
<p>如果应用没有所需的权限时，应用必须调用<code>ActivityCompat.requestPermissions (Activity activity, 
                String[] permissions, 
                int requestCode)</code>方法来申请对用的权限。参数传递对应所需的权限以及一个整数型的<code>request code</code>来标记该权限申请。 该方法是异步的:该方法会立即返回，在用户响应了请求权限的对话框之后，系统会调用对用的回调方法来通知结果，并且会传递在<code>reqeustPermissions()</code>方法中的<code>request code</code>。(在Android 6.0之前调用的时候会直接去调用<code>onRequestPermissionsResult()</code>的回调方法)<br>如图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/requestpermission.jpg?raw=true" alt="image">  </p>
<p>下面是检查是否读取联系人权限，并且在必要时申请权限的代码:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Here, thisActivity is the current activity</span></div><div class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(thisActivity,</div><div class="line">                Manifest.permission.READ_CONTACTS)</div><div class="line">        != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Should we show an explanation?</span></div><div class="line">    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(thisActivity,</div><div class="line">            Manifest.permission.READ_CONTACTS)) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Show an expanation to the user *asynchronously* -- don't block</span></div><div class="line">        <span class="comment">// this thread waiting for the user's response! After the user</span></div><div class="line">        <span class="comment">// sees the explanation, try again to request the permission.</span></div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// No explanation needed, we can request the permission.</span></div><div class="line"></div><div class="line">        ActivityCompat.requestPermissions(thisActivity,</div><div class="line">                <span class="keyword">new</span> String[]&#123;Manifest.permission.READ_CONTACTS&#125;,</div><div class="line">                MY_PERMISSIONS_REQUEST_READ_CONTACTS);</div><div class="line"></div><div class="line">        <span class="comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span></div><div class="line">        <span class="comment">// app-defined int constant. The callback method gets the</span></div><div class="line">        <span class="comment">// result of the request.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong><em>注意：</em></strong>当调用<code>requestPermissions()</code>方法时，系统会显示一个标准的对话框。应用不能指定或者改变该对话框。如果你想提供一些信息或者说明给用户，你需要在调用<code>requestPermissions()</code>之前处理。    </p>
</blockquote>
<p>#####处理请求权限的的结果     </p>
<p>如果应用申请权限，系统会显示一个对话框。当用户相应后，系统会调用应用中的<code>onRequestPermissionsResult (int requestCode, 
                String[] permissions, 
                int[] grantResults)</code>方法并传递用户的操作结果。在应用中必须要重写该方法来查找授权了什么权限。该回调方法会传递你在<code>requestPermisssions()</code>方法中传递的<code>request code</code>。直接在<code>Activity</code>或者<code>Fragment</code>中重写<code>onRequestPermissionsResult()</code>方法即可。例如，申请<code>READ_CONTACTS</code>的权限可能会有下面的回到方法:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode,</span></span></div><div class="line">        String permissions[], <span class="keyword">int</span>[] grantResults) &#123;</div><div class="line">    <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">        <span class="keyword">case</span> MY_PERMISSIONS_REQUEST_READ_CONTACTS: &#123;</div><div class="line">            <span class="comment">// If request is cancelled, the result arrays are empty.</span></div><div class="line">            <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span></div><div class="line">                &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission was granted, yay! Do the</span></div><div class="line">                <span class="comment">// contacts-related task you need to do.</span></div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                <span class="comment">// permission denied, boo! Disable the</span></div><div class="line">                <span class="comment">// functionality that depends on this permission.</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// other 'case' lines to check for other</span></div><div class="line">        <span class="comment">// permissions this app might request</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>系统提示的对话框会描述应用所需的<code>permission groud</code>。它不会列出特定的权限。例如，如果你申请了<code>READ_CONTACTS</code>权限，系统的对话框只会说你的应用需要获取设备的联系人信息。用户只需要授权每个<code>permission group</code>一次。如果你应用需要申请其他任何一个在该<code>permission group</code>中的权限时，系统会自动授权。在申请这些授权时，系统会像用户明确通过系统对话框统一授权时一样去调用<code>onRequestPermissionsResult()</code>方法并且传递<code>PERMISSION_GRANTED</code>参数。    </p>
<blockquote>
<p><strong><em>注意：</em></strong>虽然用户已经授权了同一<code>permission group</code>中其他的任何权限，但是应用仍然需要明确申请每个需要的权限。例外，<code>permission group</code>中的权限在以后可能会发生变化。    </p>
</blockquote>
<p>例如，假设在应用的<code>manifest</code>文件中同时声明了<code>READ_CONTACTS</code>和<code>WRITE_CONTACTS</code>权限。如果你申请<code>READ_CONTACTS</code>权限而且用户同意了该权限，如果你想继续申请<code>WRITE_CONTACTS</code>权限，系统不会与用户有任何交互就会直接进行授权。     </p>
<p>如果用户拒绝了一个权限申请，你的应用进行合适的处理。例如，你的应用可能显示一个对话框来表明无法执行用户请求的需要该权限的操作。</p>
<p>如果系统向用户申请权限授权，用户选择了让系统以后不要再申请该权限。 在这种情况下，应用在任何时间调用<code>reqeustPermissions()</code>方法来再次申请权限时，系统都会直接拒绝该请求。系统会直接调用<code>onRequestPermissionResult()</code>回调方法并且传递<code>PERMISSION_DENIED</code>参数，和用户明确拒绝应用申请该权限时一样。 这就意味着在你调用<code>requestPermissions()</code>方法是，你无法确定是否会和用户有直接的交互操作。   </p>
<p>示例代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">int</span> REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS = <span class="number">124</span>;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertDummyContactWrapper</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;String&gt; permissionsNeeded = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">  </div><div class="line">    <span class="keyword">final</span> List&lt;String&gt; permissionsList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.ACCESS_FINE_LOCATION))</div><div class="line">        permissionsNeeded.add(<span class="string">"GPS"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.READ_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Read Contacts"</span>);</div><div class="line">    <span class="keyword">if</span> (!addPermission(permissionsList, Manifest.permission.WRITE_CONTACTS))</div><div class="line">        permissionsNeeded.add(<span class="string">"Write Contacts"</span>);</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (permissionsList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (permissionsNeeded.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Need Rationale</span></div><div class="line">            String message = <span class="string">"You need to grant access to "</span> + permissionsNeeded.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; permissionsNeeded.size(); i++)</div><div class="line">                message = message + <span class="string">", "</span> + permissionsNeeded.get(i);</div><div class="line">            showMessageOKCancel(message,</div><div class="line">                    <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                            requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                                    REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(permissionsList.toArray(<span class="keyword">new</span> String[permissionsList.size()]),</div><div class="line">                REQUEST_CODE_ASK_MULTIPLE_PERMISSIONS);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    insertDummyContact();</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addPermission</span><span class="params">(List&lt;String&gt; permissionsList, String permission)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (checkSelfPermission(permission) != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">        permissionsList.add(permission);</div><div class="line">        <span class="comment">// Check for Rationale Option</span></div><div class="line">        <span class="keyword">if</span> (!shouldShowRequestPermissionRationale(permission))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面讲到的都是<code>Activity</code>中的使用方法，那<code>Fragment</code>中怎么授权呢？<br>如果在<code>Fragment</code>中使用，用<code>v13</code>包中的<code>FragmentCompat.requestPermissions()</code>和<code>FragmentCompat.shouldShowRequestPermissionRationale()</code>。 </p>
<p>在<code>Fragment</code>中申请权限，不要使用<code>ActivityCompat.requestPermissions</code>, 直接使用<code>Fragment.requestPermissions</code>方法，<br>否则会回调到<code>Activity</code>的<code>onRequestPermissionsResult</code>。但是虽然你使用<code>Fragment.requestPermissions</code>方法，也照样回调不到<code>Fragment.onRequestPermissionsResult</code>中。这是<code>Android</code>的<code>Bug</code>,<a href="https://code.google.com/p/android/issues/detail?can=2&amp;start=0&amp;num=100&amp;q=&amp;colspec=ID%20Status%20Priority%20Owner%20Summary%20Stars%20Reporter%20Opened&amp;groupby=&amp;sort=&amp;id=189121" target="_blank" rel="external">详见</a>，<code>Google</code>已经在<code>23.3.0</code>修复了该问题，所以要尽快升级。</p>
<p>所以升级到<code>23.3.0</code>及以上就没问题了。如果不升级该怎么处理呢？就是在<code>Activity.onRequestPermissionsResult</code>方法中去手动调用每个<code>Fragment</code>的方法(当然你要判断下权限个数，不然申请一个权限的情况下会重复调用).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">    List&lt;Fragment&gt; fragments = getSupportFragmentManager().getFragments();</div><div class="line">    <span class="keyword">if</span> (fragments != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (Fragment fragment : fragments) &#123;</div><div class="line">            fragment.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我简单的写了一个工具类:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionUtil</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在调用需要权限的功能时使用该方法进行检查。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(activity, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        handleRequestPermissions(fragment, requestCode, iPermission, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在Actvitiy或者Fragment中重写onRequestPermissionsResult方法后调用该方法。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> activity</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> grantResults</div><div class="line">     * <span class="doctag">@param</span> iPermission</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(activity, requestCode, permissions, grantResults, iPermission);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(android.app.Fragment fragment, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                                  <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        requestResult(fragment, requestCode, permissions, grantResults, iPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String... permission)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String s : permission) &#123;</div><div class="line">            permissions.add(s);</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 在检查权限后自己处理权限说明的逻辑后调用该方法，直接申请权限。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> t</div><div class="line">     * <span class="doctag">@param</span> requestCode</div><div class="line">     * <span class="doctag">@param</span> permissions</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (permissions == <span class="keyword">null</span> || permissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPermissions(t, requestCode, permissions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSelfPermission</span><span class="params">(Context context, String permission)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || TextUtils.isEmpty(permission)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params: the params is null !"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        context = context.getApplicationContext();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            <span class="keyword">int</span> result = ContextCompat.checkSelfPermission(context, permission);</div><div class="line">            <span class="keyword">if</span> (PackageManager.PERMISSION_DENIED == result) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">handleRequestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, IPermission iPermission, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalidate params"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.M) &#123;</div><div class="line">            Activity activity = getActivity(t);</div><div class="line">            List&lt;String&gt; deniedPermissions = getDeniedPermissions(activity, permissions);</div><div class="line">            <span class="keyword">if</span> (deniedPermissions != <span class="keyword">null</span> &amp;&amp; deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                List&lt;String&gt; rationalPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                <span class="keyword">for</span> (String deniedPermission : deniedPermissions) &#123;</div><div class="line">                    <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(activity,</div><div class="line">                            deniedPermission)) &#123;</div><div class="line">                        rationalPermissions.add(deniedPermission);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> showRational = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    showRational = iPermission.showRational(requestCode);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (rationalPermissions.size() &gt; <span class="number">0</span> &amp;&amp; showRational) &#123;</div><div class="line">                    <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                        iPermission.onRational(requestCode, deniedPermissions);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    requestPermissions(t, requestCode, deniedPermissions);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                    iPermission.onGranted(requestCode);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Activity <span class="title">getActivity</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">        Activity activity = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            activity = (Activity) t;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            activity = ((Fragment) t).getActivity();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            activity = ((android.app.Fragment) t).getActivity();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> activity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.M)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(T t, <span class="keyword">int</span> requestCode, List&lt;String&gt; deniedPermissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions == <span class="keyword">null</span> || deniedPermissions.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// has denied permissions</span></div><div class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">            ((Activity) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Fragment) &#123;</div><div class="line">            ((Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> android.app.Fragment) &#123;</div><div class="line">            ((android.app.Fragment) t).requestPermissions(deniedPermissions.toArray(<span class="keyword">new</span> String[deniedPermissions.size()]), requestCode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getDeniedPermissions</span><span class="params">(Context context, String... permissions)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || permissions == <span class="keyword">null</span> || permissions.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        List&lt;String&gt; denyPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String permission : permissions) &#123;</div><div class="line">            <span class="keyword">if</span> (!checkSelfPermission(context, permission)) &#123;</div><div class="line">                denyPermissions.add(permission);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> denyPermissions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">requestResult</span><span class="params">(T t, <span class="keyword">int</span> requestCode, String[] permissions,</span></span></div><div class="line">                                          <span class="keyword">int</span>[] grantResults, IPermission iPermission) &#123;</div><div class="line">        List&lt;String&gt; deniedPermissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grantResults.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (grantResults[i] != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">                deniedPermissions.add(permissions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (deniedPermissions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onDenied(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (iPermission != <span class="keyword">null</span>) &#123;</div><div class="line">                iPermission.onGranted(requestCode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPermission</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permissions)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否需要提示用户该权限的作用，提示后需要再调用requestPermission()方法来申请。</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> true 为提示，false为不提示</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Button mReqCameraBt;</div><div class="line">    <span class="keyword">private</span> Button mReqContactsBt;</div><div class="line">    <span class="keyword">private</span> Button mReqMoreBt;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.fragment_main, container, <span class="keyword">false</span>);</div><div class="line">        findView(view);</div><div class="line">        initView();</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        mReqCameraBt = (Button) view.findViewById(R.id.bt_requestCamera);</div><div class="line">        mReqContactsBt = (Button) view.findViewById(R.id.bt_requestContacts);</div><div class="line">        mReqMoreBt = (Button) view.findViewById(R.id.bt_requestMore);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</div><div class="line">        mReqCameraBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqContactsBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mReqMoreBt.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CAMERA = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_CONTACTS = <span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_MORE = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, @NonNull String[] permissions, @NonNull <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        PermissionUtil.onRequestPermissionsResult(<span class="keyword">this</span>, requestCode, permissions, grantResults, mPermission);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestCamera</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CAMERA, mPermission, Manifest.permission.CAMERA);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestReadContacts</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_CONTACTS, mPermission, Manifest.permission.READ_CONTACTS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestMore</span><span class="params">()</span> </span>&#123;</div><div class="line">        PermissionUtil.checkPermissions(<span class="keyword">this</span>, REQUEST_CODE_MORE, mPermission, Manifest.permission.READ_CONTACTS, Manifest.permission.READ_CALENDAR, Manifest.permission.CALL_PHONE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPermissionTipDialog</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> List&lt;String&gt; permissions)</span> </span>&#123;</div><div class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity());</div><div class="line">        builder.setMessage(<span class="string">"I want you permissions"</span>);</div><div class="line">        builder.setTitle(<span class="string">"Hello Permission"</span>);</div><div class="line">        builder.setPositiveButton(<span class="string">"确认"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">                PermissionUtil.requestPermission(MainFragment.<span class="keyword">this</span>, requestCode, permissions);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.setNegativeButton(<span class="string">"取消"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</div><div class="line">                dialog.dismiss();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        builder.create().show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> IPermission mPermission = <span class="keyword">new</span> IPermission() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGranted</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onGranted :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDenied</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            Toast.makeText(getActivity(), <span class="string">"onDenied :"</span> + requestCode, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRational</span><span class="params">(<span class="keyword">int</span> requestCode, List&lt;String&gt; permission)</span> </span>&#123;</div><div class="line">            showPermissionTipDialog(requestCode, permission);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">showRational</span><span class="params">(<span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (requestCode) &#123;</div><div class="line">                <span class="keyword">case</span> REQUEST_CODE_MORE:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> id = v.getId();</div><div class="line">        <span class="keyword">switch</span> (id) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestCamera:</div><div class="line">                requestCamera();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestContacts:</div><div class="line">                requestReadContacts();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.bt_requestMore:</div><div class="line">                requestMore();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android6.0权限系统/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-volley-retrofit-okhttp之我们该如何选择网路框架" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/volley-retrofit-okhttp之我们该如何选择网路框架/">volley-retrofit-okhttp之我们该如何选择网路框架</a>
    </h1>
  

        
        <a href="/2015/01/01/volley-retrofit-okhttp之我们该如何选择网路框架/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="volley-retrofit-okhttp之我们该如何选择网路框架"><a href="#volley-retrofit-okhttp之我们该如何选择网路框架" class="headerlink" title="volley-retrofit-okhttp之我们该如何选择网路框架"></a>volley-retrofit-okhttp之我们该如何选择网路框架</h1><p>说起<code>Volley</code>、<code>Retrofit</code>、<code>OkHttp</code>相信基本没有人不知道。当然这里把<code>OkHttp</code>放进来可能有些不恰当。<br>因为<code>OkHttp</code>的官方介绍是<code>An HTTP+HTTP/2 client for Android and Java applications</code>。<br>也就是说<code>OkHttp</code>是基于<code>http</code>协议封装的一套请求客户端。它是真正的网络请求部分，<br>与<code>HttpClient</code>、<code>HttpUrlConnection</code>是一样的，<br>但是显然它的效率非常高(说到这里顺便提一嘴，从<code>Android 4.4</code>开始<code>HttpUrlConnection</code>内部默认使用的也是<code>OkHttp</code>，<br>具体请参考之前的文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/HttpURLConnection%E8%AF%A6%E8%A7%A3.md">HttpUrlConnection详解</a>)。<br>而<code>Volley</code>、<code>Retrofit</code>是控制请求的队列、切换、解析、缓存等逻辑。所以<code>Volley</code>和<code>Retrofit</code>都可以结合<code>OkHttp</code>来使用。 </p>
<p>在<code>Android</code>开发中有很多网络请求框架，但是比较过来比较过去，最后最倾向的就是这两个:    </p>
<ul>
<li><code>Volley</code>:<code>Google</code>发布的网络请求框架，专门为移动设备定制，小而美。     </li>
<li><code>Retrofit</code>:良心企业    <code>Square</code>由大神<code>JakeWharton</code>主导的开源项目,是基于<code>OkHttp</code>封装的一套<code>Resetful</code>网络请求框架。<code>Type-safe HTTP client for Android and Java by Square, Inc.</code></li>
</ul>
<p>有关<code>Volley</code>的介绍请看之前发布的文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/Volley%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md">Volley源码分析</a></p>
<p>这里就不分别介绍他俩了，直接说各自的优缺点:    </p>
<ul>
<li><p><code>Retrofit</code>使用起来更简单。而<code>Volley</code>配置起来会稍微麻烦，因为<code>Volley</code>可以使用<code>HttpClient</code>、<code>HttpUrlConnection</code>、<code>OkHttp</code>我们需要根据自己的需求去配置。而<code>Retrofit</code>只能结合<code>OkHttp</code>使用。   </p>
</li>
<li><p><code>Retrofit</code>依赖于<code>OkHttp</code>，从而会导致它的包大小会比<code>Volley</code>的大。 </p>
</li>
<li><p><code>Volley</code>有很好的内存缓存管理，它在解析之前会将整个相应部分都加载到内存中，所以它对于小的网络请求非常合适，但是不支持<code>post</code>大数据，所以不适合上传文件。而<code>Retrofit</code>使用的是硬盘缓存，所以相比起从缓存这块来讲<code>Retrofit</code>可能会更慢一些。   </p>
</li>
<li><p><code>Retrofit</code>依赖于<code>OkHttp</code>，而<code>OkHttp</code>自身会避免同时两次请求同一个请求。所以<code>Retrofit</code>同样会和<code>Volley</code>一样去避免重复的请求，只不过它是在网络层来处理的。 </p>
</li>
<li><p><code>Volley</code>在网络请求部分默认依赖于<code>Apache HttpClient</code>。而<code>Apache HttpClient</code>从<code>API 23</code>开始已经在<code>Android</code>中被移除并废弃了。这就是为什么很多开发者会认为<code>Volley</code>已经过时了，因为<code>Volley</code>并没有迁移到新的未废弃的代码。    </p>
</li>
<li><p>默认情况下<code>Volley</code>会在<code>DefaultRetryPolicy</code>中会将读取和连接的超时时间设置为<code>2.5s</code>，并且对每次请求失败或者超时都有一次自动重试。 所以对于一些服务器响应可能会超过<code>2s</code>的请求，开发者需要格外的小心下。<code>Retrofit</code>的默认超时时间是<code>10s</code>，而且它对失败或者超时的操作不会自动重试。      </p>
</li>
<li>很多开发者都会说<code>Retrofit</code>会比<code>Volley</code>更快。因为有人专门去测试过，其实这里是不严谨的。因为<code>Volley</code>可以结合使用<code>HttpUrlConnection</code>、<code>HttpClient</code>、<code>OkHttp</code>等来使用，而<code>Retrofit</code>是用<code>OkHttp</code>一起，所以如果你让<code>Volley</code>结合<code>OkHttp</code>之后再来测试你就会发现总体来说其实他们不相上下。    </li>
</ul>
<ul>
<li><code>Volley</code>实现了很完善的<code>Activity</code>声明周期管理。</li>
</ul>
<p>虽然<code>Volley</code>之前也有一些问题，但是它们也都被各个大神修复。</p>
<p>所以综合起来说使用<code>Volley+OKHttp</code>的组合是非常不错的，既可以保证速度又可以满足对缓存、重试等的处理。但是如果你是<code>RxJava</code>的使用者那你可能会更偏向于使用<code>Retrofit</code>，因为<code>Retrofit</code>可以无缝结合<code>RxJava</code>使用。目前主流的一套框架就是<code>Retrofit + OkHttp + RxJava + Dagger2</code>，但是对使用者的要求也相对要高些。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/volley-retrofit-okhttp之我们该如何选择网路框架/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio提高Build速度" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio提高Build速度/">AndroidStudio提高Build速度</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio提高Build速度/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio提高Build速度"><a href="#AndroidStudio提高Build速度" class="headerlink" title="AndroidStudio提高Build速度"></a>AndroidStudio提高Build速度</h1><p><code>Android Studio</code>自动发布以来，凭借其强大的功能，很快让开发者都投入到它的阵营下。但是也问题，就是<code>Build</code>速度太慢了。</p>
<p>之前也根据网上的资料，修改了一些配置，但是一次二分多种有时候还是让人抓狂。今天索性记录一下。首先看一下<a href="https://plus.google.com/+AndroidDevelopers/posts/ECrb9VQW9XP" target="_blank" rel="external">Google+</a>关于该问题的讨论。</p>
<ul>
<li><p>使用<code>daemon</code>及<code>parallel</code>模式</p>
<p>  在下面的目录中创建一个名为<code>gradle.properties</code>的文件:     </p>
<ul>
<li><code>/home/&lt;username&gt;/.gradle/ (Linux)</code></li>
<li><code>/Users/&lt;username&gt;/.gradle/ (Mac)</code></li>
<li><p><code>C:\Users\&lt;username&gt;\.gradle (Windows)</code></p>
<p>文件的内容为: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.gradle.daemon=true</div><div class="line">org.gradle.parallel=true</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>经过上面的这一步修改是对所有工程都有效果的，如果你只想对某一个工程配置的话，那就在该工程目录下的`gralde.properties`中进行配置。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line"># Default value: -Xmx10248m -XX:MaxPermSize=256m</div><div class="line"># org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div></pre></td></tr></table></figure>

打开时默认如上。我们给加添加上面的配置就好。

当然你也可以通过`Studio`的设置中进行修改。        
![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_speed.png?raw=true)
</code></pre><ul>
<li><p>使用<code>offline</code>模式      </p>
<p>  下一步就是开始<code>offline</code>模式，因为我们经常会在<code>gradle</code>中使用一下依赖库时用<code>+</code>这样的话就能保证你的依赖库是最新的版本，但是这样在每次<code>build</code>的时候都会去检查是不是最新的版本，所以就会耗时。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_offline.png?raw=true" alt="image"></p>
<p>  在开发过程中是不建议使用动态版本的，在<code>Studio</code>中使用动态版本的<code>gradle</code>中间中使用<code>ALT+ENTER</code>键进行修复。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_daymaic_version_tip.png?raw=true" alt="image"><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_dymaic_version_fix.png?raw=true" alt="image"><br>  详细有关为什么不要使用动态版本的介绍，请参考<a href="http://blog.danlew.net/2015/09/09/dont-use-dynamic-versions-for-your-dependencies/" target="_blank" rel="external">Don’t use dynamic versions for your dependencies</a></p>
</li>
<li><p>增加内存使用<code>SSD</code><br>  首先是增大内存,    <code>Mac</code>中在<code>Applications</code>中找到<code>Sutio</code>然后右键显示包内容<code>Contents/bin/studio.vmoptions</code>。<br>  打开该文件后修改就可以了，我是的是:     </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># *DO NOT* modify this file directly. If there is a value that you would like to override,</div><div class="line"># please add it to your user specific configuration file.</div><div class="line">#</div><div class="line"># See http://tools.android.com/tech-docs/configuration</div><div class="line">#</div><div class="line">-Xms1024m</div><div class="line">-Xmx4096m</div><div class="line">-XX:MaxPermSize=768m</div><div class="line">-XX:ReservedCodeCacheSize=768m</div><div class="line">-XX:+UseCompressedOops</div></pre></td></tr></table></figure>
<p>  我没看见<code>DO NOT</code>的提示- -!</p>
<ul>
<li>Xms 是JVN启动起始时的堆内存，堆内存是分配给对象的内容。</li>
<li>Xmx 是能使用的最大堆内存。</li>
</ul>
</li>
</ul>
<ul>
<li><p>使用<code>Instant Run</code>   </p>
<p>  <code>Instantt Run</code>放在这里说可能不合适，但是用他确实能大大的减少运行时间。<br>  如果还不了解的话可以参考<a href="http://tools.android.com/tech-docs/instant-run" target="_blank" rel="external">Instant Run</a><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_instantrun.png?raw=true" alt="image"></p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio提高Build速度/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-butterknife源码详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/butterknife源码详解/">butterknife源码详解</a>
    </h1>
  

        
        <a href="/2015/01/01/butterknife源码详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="butterknife源码详解"><a href="#butterknife源码详解" class="headerlink" title="butterknife源码详解"></a>butterknife源码详解</h1><p>作为<code>Android</code>开发者，大家肯定都知道大名鼎鼎的<a href="https://github.com/JakeWharton/butterknife">butterknife</a>。它大大的提高了开发效率，虽然在很早之前就开始使用它了，但是只知道是通过注解的方式实现的，却一直没有仔细的学习下大牛的代码。最近在学习运行时注解，决定今天来系统的分析下<code>butterknife</code>的实现原理。    </p>
<p>如果你之前不了解<code>Annotation</code>，那强烈建议你先看<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a>.</p>
<p>废多看图:  </p>
<p><img src="https://github.com/CharonChui/Pictures/blob/master/butterknife_sample.png?raw=true" alt="image"></p>
<p>从图中可以很直观的看出它的<code>module</code>结构，以及使用示例代码。</p>
<p>它的目录和我们在<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a>这篇文章中介绍的一样，大体也是分为三个部分:   </p>
<ul>
<li>app : butterknife</li>
<li>api : butterknife-annotations</li>
<li>compiler : butterknife-compiler</li>
</ul>
<p>通过示例代码我们大体能预料到对应的功能实现:    </p>
<ul>
<li><p><code>@BindView(R2.id.hello) Button hello;</code><br>  <code>BindView</code>注解的作用就是通过<code>value</code>指定的值然后去调用<code>findViewById()</code>来找到对应的控件，然后将该控件赋值给使用该注解的变量。 </p>
</li>
<li><p><code>@OnClick(R2.id.hello) void sayHello() {...}</code><br>  <code>OnClick</code>注解也是通过指定的<code>id</code>来找到对应控件后，然后对其设置<code>onClickListener</code>并调用使用该注解的方法。   </p>
</li>
<li><p>最后不要忘了<code>ButterKnife.bind(this);</code>该方法也是后面我们要分析的突破点。 </p>
</li>
</ul>
<p>当然<code>Butterknife</code>的功能是非常强大的，我们在这里只是用这两个简单的例子来进行分析说明。    </p>
<p>那我们就来查看<code>BindView</code>和<code>Onclik</code>注解的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(CLASS) <span class="meta">@Target</span>(FIELD)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</div><div class="line">  <span class="comment">/** View ID to which the field will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>作用在变量上的编译时注解。对该注解的值<code>value()</code>使用<code>android.support.annotation</code>中的<code>IdRes</code>注解，来表明该值只能是资源类型的<code>id</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(METHOD)</div><div class="line"><span class="meta">@Retention</span>(CLASS)</div><div class="line"><span class="meta">@ListenerClass</span>(</div><div class="line">    targetType = <span class="string">"android.view.View"</span>,</div><div class="line">    setter = <span class="string">"setOnClickListener"</span>,</div><div class="line">    type = <span class="string">"butterknife.internal.DebouncingOnClickListener"</span>,</div><div class="line">    method = <span class="meta">@ListenerMethod</span>(</div><div class="line">        name = <span class="string">"doClick"</span>,</div><div class="line">        parameters = <span class="string">"android.view.View"</span></div><div class="line">    )</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</div><div class="line">  <span class="comment">/** View IDs to which the method will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作用到方法上的编译时注解。我们发现该<code>注解还使用了</code>ListenerClass<code>注解，当然从上面的声明中可以很容易看出它的作用。   
那我们就继续简单的看一下</code>ListenerClass`注解的实现:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RUNTIME) <span class="meta">@Target</span>(ANNOTATION_TYPE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListenerClass &#123;</div><div class="line">  <span class="function">String <span class="title">targetType</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Name of the setter method on the &#123;<span class="doctag">@linkplain</span> #targetType() target type&#125; for the listener. */</span></div><div class="line">  <span class="function">String <span class="title">setter</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Name of the method on the &#123;<span class="doctag">@linkplain</span> #targetType() target type&#125; to remove the listener. If</div><div class="line">   * empty &#123;<span class="doctag">@link</span> #setter()&#125; will be used by default.</div><div class="line">   */</div><div class="line">  <span class="function">String <span class="title">remover</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Fully-qualified class name of the listener type. */</span></div><div class="line">  <span class="function">String <span class="title">type</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Enum which declares the listener callback methods. Mutually exclusive to &#123;<span class="doctag">@link</span> #method()&#125;. */</span></div><div class="line">  Class&lt;? extends Enum&lt;?&gt;&gt; callbacks() <span class="keyword">default</span> NONE.class;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Method data for single-method listener callbacks. Mutually exclusive with &#123;<span class="doctag">@link</span> #callbacks()&#125;</div><div class="line">   * and an error to specify more than one value.</div><div class="line">   */</div><div class="line">  ListenerMethod[] method() <span class="keyword">default</span> &#123; &#125;;</div><div class="line"></div><div class="line">  <span class="comment">/** Default value for &#123;<span class="doctag">@link</span> #callbacks()&#125;. */</span></div><div class="line">  <span class="keyword">enum</span> NONE &#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作用到注解类型的运行时注解。 </p>
<p>有了之前<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a>这篇文章的基础，我们知道对于编译时注解肯定是要通过自定义<code>AbstractProcessor</code>来解析的，所以接下来我们要去<code>butterknife-compiler module</code>中找一下对应的类。通过名字我们就能很简单的找到:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> butterknife.compiler;</div><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过<code>AutoService</code>注解我们很容易看出来<code>Butterknife</code>也使用了<code>Google Auto</code>。当然它肯定也都用了<code>javaopet</code>和<code>android-apt</code>，这里我们就不去分析了。<br>其他的一些方法我们就不继续看了，我们接下来看一下具体的核心处理方法，也就是<code>ButterKnifeProcessor.process()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</div><div class="line">    <span class="comment">// 查找、解析出所有的注解</span></div><div class="line">    Map&lt;TypeElement, BindingClass&gt; targetClassMap = findAndParseTargets(env);</div><div class="line">    <span class="comment">// 将注解后要生成的相关代码信息保存到BindingClass类中</span></div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</div><div class="line">      TypeElement typeElement = entry.getKey();</div><div class="line">      BindingClass bindingClass = entry.getValue();</div><div class="line">      <span class="comment">// 输出生成的类</span></div><div class="line">      <span class="keyword">for</span> (JavaFile javaFile : bindingClass.brewJava()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          javaFile.writeTo(filer);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">          error(typeElement, <span class="string">"Unable to write view binder for type %s: %s"</span>, typeElement,</div><div class="line">              e.getMessage());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>从<code>process()</code>方法来看，我们需要主要分析两个部分:   </p>
<ul>
<li><code>findAndParseTargets()</code>：查找、解析所有的注解</li>
<li><code>bindingClass.brewJava()</code>：生成代码</li>
</ul>
<p>#####第一步:<code>findAndParseTargets()</code>  </p>
<p>先查看<code>findAndParseTargets()</code>方法的实现,里面解析的类型比较多，我们就以<code>BindView</code>为例进行说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingClass&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">    Map&lt;TypeElement, BindingClass&gt; targetClassMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">    scanForRClasses(env);</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindArray element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceArray(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindArray.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBitmap element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBitmap.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBitmap(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBitmap.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBool element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBool.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBool(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBool.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindColor element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindColor.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceColor(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindColor.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDimen element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDimen.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDimen(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDimen.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDrawable element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDrawable.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDrawable(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDrawable.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindInt element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindInt.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceInt(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindInt.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindString element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindString.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceString(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindString.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindView element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">      <span class="comment">// 检查一下合法性</span></div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 进行解析 </span></div><div class="line">        parseBindView(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindView.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindViews element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindViews.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseBindViews(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindViews.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each annotation that corresponds to a listener.</span></div><div class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</div><div class="line">      findAndParseListener(env, listener, targetClassMap, erasedTargetNames);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Try to find a parent binder for each.</span></div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</div><div class="line">      TypeElement parentType = findParentType(entry.getKey(), erasedTargetNames);</div><div class="line">      <span class="keyword">if</span> (parentType != <span class="keyword">null</span>) &#123;</div><div class="line">        BindingClass bindingClass = entry.getValue();</div><div class="line">        BindingClass parentBindingClass = targetClassMap.get(parentType);</div><div class="line">        bindingClass.setParent(parentBindingClass);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> targetClassMap;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>parseBindView()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingClass&gt; targetClassMap,</span></span></div><div class="line">      Set&lt;TypeElement&gt; erasedTargetNames) &#123;</div><div class="line">    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</div><div class="line"></div><div class="line">    <span class="comment">// Start by verifying common generated code restrictions.</span></div><div class="line">    <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</div><div class="line">        || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">    <span class="comment">// Verify that the target type extends from View.</span></div><div class="line">    TypeMirror elementType = element.asType();</div><div class="line">    <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">      TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">      elementType = typeVariable.getUpperBound();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 必须是View类型或者接口</span></div><div class="line">    <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;</div><div class="line">      error(element, <span class="string">"@%s fields must extend from View or be an interface. (%s.%s)"</span>,</div><div class="line">          BindView.class.getSimpleName(), enclosingElement.getQualifiedName(),</div><div class="line">          element.getSimpleName());</div><div class="line">      hasError = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasError) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 通过注解的value拿到id</span></div><div class="line">    <span class="comment">// Assemble information on the field.</span></div><div class="line">    <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();</div><div class="line"></div><div class="line">    BindingClass bindingClass = targetClassMap.get(enclosingElement);</div><div class="line">    <span class="keyword">if</span> (bindingClass != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">// 之前已经绑定过该id</span></div><div class="line">      ViewBindings viewBindings = bindingClass.getViewBinding(getId(id));</div><div class="line">      <span class="keyword">if</span> (viewBindings != <span class="keyword">null</span> &amp;&amp; viewBindings.getFieldBinding() != <span class="keyword">null</span>) &#123;</div><div class="line">        FieldViewBinding existingBinding = viewBindings.getFieldBinding();</div><div class="line">        error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>,</div><div class="line">            BindView.class.getSimpleName(), id, existingBinding.getName(),</div><div class="line">            enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 没有绑定过该id的话就去生成代码</span></div><div class="line">      bindingClass = getOrCreateTargetClass(targetClassMap, enclosingElement);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String name = element.getSimpleName().toString();</div><div class="line">    TypeName type = TypeName.get(elementType);</div><div class="line">    <span class="keyword">boolean</span> required = isFieldRequired(element);</div><div class="line"></div><div class="line">    FieldViewBinding binding = <span class="keyword">new</span> FieldViewBinding(name, type, required);</div><div class="line">    <span class="comment">// 用BindingClass添加代码</span></div><div class="line">    bindingClass.addField(getId(id), binding);</div><div class="line"></div><div class="line">    <span class="comment">// Add the type-erased version to the valid binding targets set.</span></div><div class="line">    erasedTargetNames.add(enclosingElement);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>终于进入生成代码的阶段了，继续看一下<code>getOrCreateTargetClass()</code>的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> BindingClass <span class="title">getOrCreateTargetClass</span><span class="params">(Map&lt;TypeElement, BindingClass&gt; targetClassMap,</span></span></div><div class="line">      TypeElement enclosingElement) &#123;</div><div class="line">    BindingClass bindingClass = targetClassMap.get(enclosingElement);</div><div class="line">    <span class="keyword">if</span> (bindingClass == <span class="keyword">null</span>) &#123;</div><div class="line">      TypeName targetType = TypeName.get(enclosingElement.asType());</div><div class="line">      <span class="keyword">if</span> (targetType <span class="keyword">instanceof</span> ParameterizedTypeName) &#123;</div><div class="line">        targetType = ((ParameterizedTypeName) targetType).rawType;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 得到包名、类名</span></div><div class="line">      String packageName = getPackageName(enclosingElement);</div><div class="line">      String className = getClassName(enclosingElement, packageName);</div><div class="line">      <span class="comment">// 用包名、类名和_ViewBinder等拼接成要生成的类的全名，这里会有两个类:$$_ViewBinder和$$_ViewBinding</span></div><div class="line">      ClassName binderClassName = ClassName.get(packageName, className + <span class="string">"_ViewBinder"</span>);</div><div class="line">      ClassName unbinderClassName = ClassName.get(packageName, className + <span class="string">"_ViewBinding"</span>);</div><div class="line"></div><div class="line">      <span class="keyword">boolean</span> isFinal = enclosingElement.getModifiers().contains(Modifier.FINAL);</div><div class="line">      <span class="comment">// 将要生成的类名,$$_ViewBinder和$$_ViewBinding封装给BindingClass类</span></div><div class="line">      bindingClass = <span class="keyword">new</span> BindingClass(targetType, binderClassName, unbinderClassName, isFinal);</div><div class="line">      targetClassMap.put(enclosingElement, bindingClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> bindingClass;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>BindingClass.addField()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addField</span><span class="params">(Id id, FieldViewBinding binding)</span> </span>&#123;</div><div class="line">    getOrCreateViewBindings(id).setFieldBinding(binding);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>getOrCreateViewBindings()</code>以及<code>setFieldBinding()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ViewBindings <span class="title">getOrCreateViewBindings</span><span class="params">(Id id)</span> </span>&#123;</div><div class="line">    ViewBindings viewId = viewIdMap.get(id);</div><div class="line">    <span class="keyword">if</span> (viewId == <span class="keyword">null</span>) &#123;</div><div class="line">      viewId = <span class="keyword">new</span> ViewBindings(id);</div><div class="line">      viewIdMap.put(id, viewId);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> viewId;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>然后看<code>ViewBindings.setFieldBinding()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldBinding</span><span class="params">(FieldViewBinding fieldBinding)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fieldBinding != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.fieldBinding = fieldBinding;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看到这里就把<code>findAndParseTargets()</code>方法分析完了。大体总结一下就是把一些变量、参数等初始化到了<code>BindingClass</code>类中。<br>也就是说上面<code>process()</code>方法中的第一步已经分析完了，下面我们来继续看第二部分.</p>
<p>#####第二步:<code>bindingClass.brewJava()</code>  </p>
<p>继续查看<code>BindingClass.brewJava()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">Collection&lt;JavaFile&gt; <span class="title">brewJava</span><span class="params">()</span> </span>&#123;</div><div class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(binderClassName)</div><div class="line">        .addModifiers(PUBLIC, FINAL)</div><div class="line">        .addSuperinterface(ParameterizedTypeName.get(VIEW_BINDER, targetTypeName));</div><div class="line"></div><div class="line">    result.addMethod(createBindMethod(targetTypeName));</div><div class="line"></div><div class="line">    List&lt;JavaFile&gt; files = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">if</span> (isGeneratingUnbinder()) &#123;</div><div class="line">      <span class="comment">// 生成$$_ViewBinding类</span></div><div class="line">      files.add(JavaFile.builder(unbinderClassName.packageName(), createUnbinderClass())</div><div class="line">          .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</div><div class="line">          .build()</div><div class="line">      );</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isFinal) &#123;</div><div class="line">      result.addMethod(createBindToTargetMethod());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 生成$$_ViewBinder类</span></div><div class="line">    files.add(JavaFile.builder(binderClassName.packageName(), result.build())</div><div class="line">        .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</div><div class="line">        .build());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> files;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看到这里感觉不用再继续分析了，该方法就是使用<code>javaopet</code>来生成对应<code>$$_ViewBinder.java</code>类。 </p>
<p>到这里我们已经知道在编译的过程中会去生成一个对应的<code>$$_ViewBinder.java</code>文件，该类实现了<code>ViewBinder</code>接口。它内部会去生成对应<code>findViewByid()</code>以及<code>setOnClickListener()</code>等方法的代码，它生成了该类后如何去调用呢？我们也没有发现<code>new $$_ViewBinder</code>的方法。不要忘了上面我们看到的<code>ButterKnife.bind(this);</code>。接下来我们看一下<code>ButterKnife.bind(this);</code>方法的实现:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> Activity&#125;. The current content</div><div class="line">   * view is used as the view root.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> target Target activity for view binding.</div><div class="line">   */</div><div class="line">  <span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getViewBinder(target).bind(Finder.ACTIVITY, target, target);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> View&#125;. The view and its children</div><div class="line">   * are used as the view root.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> target Target view for view binding.</div><div class="line">   */</div><div class="line">  <span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull View target)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getViewBinder(target).bind(Finder.VIEW, target, target);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>调用了<code>getViewBinder()</code>的<code>bind()</code>方法，继续看<code>getViewBinder()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ViewBinder&lt;Object&gt;&gt; BINDERS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">...</div><div class="line"></div><div class="line"><span class="meta">@NonNull</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">static</span> ViewBinder&lt;Object&gt; <span class="title">getViewBinder</span><span class="params">(@NonNull Object target)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up view binder for "</span> + targetClass.getName());</div><div class="line">    <span class="keyword">return</span> findViewBinderForClass(targetClass);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@NonNull</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ViewBinder&lt;Object&gt; <span class="title">findViewBinderForClass</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</div><div class="line">     <span class="comment">// BINDERS是一个Map集合。也就是说它内部使用Map缓存了一下，先去内存中取</span></div><div class="line">     ViewBinder&lt;Object&gt; viewBinder = BINDERS.get(cls);</div><div class="line">    <span class="keyword">if</span> (viewBinder != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Cached in view binder map."</span>);</div><div class="line">      <span class="keyword">return</span> viewBinder;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 内存中没有缓存该类</span></div><div class="line">    String clsName = cls.getName();</div><div class="line">    <span class="comment">// 通过类名判断下是不是系统的组件</span></div><div class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</div><div class="line">      <span class="keyword">return</span> NOP_VIEW_BINDER;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// 通过反射获取到对应通过编译时注解生成的$_ViewBinder类的实例</span></div><div class="line">      Class&lt;?&gt; viewBindingClass = Class.forName(clsName + <span class="string">"_ViewBinder"</span>);</div><div class="line">      <span class="comment">//noinspection unchecked</span></div><div class="line">      viewBinder = (ViewBinder&lt;Object&gt;) viewBindingClass.newInstance();</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Loaded view binder class."</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</div><div class="line">      viewBinder = findViewBinderForClass(cls.getSuperclass());</div><div class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create view binder for "</span> + clsName, e);</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create view binder for "</span> + clsName, e);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 通过反射来操作毕竟会影响性能，所以这里通过Map缓存的方式来进行优化</span></div><div class="line">    BINDERS.put(cls, viewBinder);</div><div class="line">    <span class="keyword">return</span> viewBinder;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>到这里就彻底分析完了<code>ButterKnife.bind(this);</code>的实现，它其实就相当于<code>new</code>了一个<code>$_ViewBinder</code>类的实例。当然这样用起来是非常方便的，毕竟我们手动的去<code>new</code>类多不合理，虽然他里面用到了反射会影响一点点性能，但是他通过内存缓存的方式优化了，我感觉这种方式是利大于弊的。   </p>
<p>那<code>$_ViewBinder</code>类里面都是什么内容呢？ 我们去看一下该类的代码，但是它生成的代码在哪里呢？<br><img src="https://github.com/CharonChui/Pictures/blob/master/butterknife_apt_genierate_code.png?raw=true" alt="image"></p>
<p>开始看一下<code>SimpleActivity_ViewBinder.bind()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinder</span> <span class="keyword">implements</span> <span class="title">ViewBinder</span>&lt;<span class="title">SimpleActivity</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Unbinder <span class="title">bind</span><span class="params">(Finder finder, SimpleActivity target, Object source)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleActivity_ViewBinding&lt;&gt;(target, finder, source);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看<code>SimpleActivity_ViewBinding</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinding</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> T target;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968578;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968579;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SimpleActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> T target, Finder finder, Object source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    target.title = finder.findRequiredViewAsType(source, R.id.title, <span class="string">"field 'title'"</span>, TextView.class);</div><div class="line">    target.subtitle = finder.findRequiredViewAsType(source, R.id.subtitle, <span class="string">"field 'subtitle'"</span>, TextView.class);</div><div class="line">    view = finder.findRequiredView(source, R.id.hello, <span class="string">"field 'hello', method 'sayHello', and method 'sayGetOffMe'"</span>);</div><div class="line">    target.hello = finder.castView(view, R.id.hello, <span class="string">"field 'hello'"</span>, Button.class);</div><div class="line">    view2130968578 = view;</div><div class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        target.sayHello();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> target.sayGetOffMe();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view = finder.findRequiredView(source, R.id.list_of_things, <span class="string">"field 'listOfThings' and method 'onItemClick'"</span>);</div><div class="line">    target.listOfThings = finder.castView(view, R.id.list_of_things, <span class="string">"field 'listOfThings'"</span>, ListView.class);</div><div class="line">    view2130968579 = view;</div><div class="line">    ((AdapterView&lt;?&gt;) view).setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</div><div class="line">        target.onItemClick(p2);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    target.footer = finder.findRequiredViewAsType(source, R.id.footer, <span class="string">"field 'footer'"</span>, TextView.class);</div><div class="line">    target.headerViews = Utils.listOf(</div><div class="line">        finder.findRequiredView(source, R.id.title, <span class="string">"field 'headerViews'"</span>), </div><div class="line">        finder.findRequiredView(source, R.id.subtitle, <span class="string">"field 'headerViews'"</span>), </div><div class="line">        finder.findRequiredView(source, R.id.hello, <span class="string">"field 'headerViews'"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</div><div class="line">    T target = <span class="keyword">this</span>.target;</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</div><div class="line"></div><div class="line">    target.title = <span class="keyword">null</span>;</div><div class="line">    target.subtitle = <span class="keyword">null</span>;</div><div class="line">    target.hello = <span class="keyword">null</span>;</div><div class="line">    target.listOfThings = <span class="keyword">null</span>;</div><div class="line">    target.footer = <span class="keyword">null</span>;</div><div class="line">    target.headerViews = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    view2130968578.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578.setOnLongClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578 = <span class="keyword">null</span>;</div><div class="line">    ((AdapterView&lt;?&gt;) view2130968579).setOnItemClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968579 = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到他内部会通过<code>findViewByid()</code>等来找到对应的<code>View</code>，然后将其赋值给<code>target.xxxx</code>，所以这样就相当于把所有的控件以及事件都给初始化了，以后就可以直接使用了，通过这里也可以看到我们在使用注解的时候不要把控件或者方法声明为<code>private</code>的。   </p>
<p>总结一下:      </p>
<ul>
<li><code>ButterKnifeProcessor</code>会生成<code>$$_ViewBinder</code>类并实现了<code>ViewBinder</code>接口。</li>
<li><code>$$_ViewBinder</code>类中包含了所有对应的代码，会通过注解去解析到<code>id</code>等，然后通过<code>findViewById()</code>等方法找到对应的控件，并且复制给调用该方法的来中的变量。这样就等同于我们直接<br> 使用<code>View v = findViewByid(R.id.xx)</code>来进行初始化控件。  </li>
<li><p>上面虽然生成了<code>$$_ViewBinder</code>类，但是如何去调用呢？ 就是在调用<code>ButterKnife.bind(this)</code>时执行，该方法会通过反射去实例化对应的<code>$$_ViewBinder</code>类，并且调用该类的<code>bind()</code>方法。 </p>
</li>
<li><p><code>Butterknife</code>除了在<code>Butterknife.bind()</code>方法中使用反射之外，其他注解的处理都是通过编译时注解使用，所以不会影响效率。    </p>
</li>
<li>使用<code>Butterknife</code>是不要将变量声明为<code>private</code>类型，因为<code>$$_ViewBinder</code>类中会去直接调用变量赋值，如果声明为<code>private</code>将无法赋值。     <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindView</span>(R2.id.title) TextView title;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/butterknife源码详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-布局优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/布局优化/">布局优化</a>
    </h1>
  

        
        <a href="/2015/01/01/布局优化/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="布局优化"><a href="#布局优化" class="headerlink" title="布局优化"></a>布局优化</h1><ul>
<li><p>去除不必要的嵌套和节点<br>  这是最基本的一条，但也是最不好做到的一条，往往不注意的时候难免会一些嵌套等。    </p>
<ul>
<li>首次不需要的节点设置为<code>GONE</code>或使用<code>ViewStud</code>.       </li>
<li>使用<code>Relativelayout</code>代替<code>LinearLayout</code>.<br>平时写布局的时候要多注意，写完后可以通过<code>Hierarchy Viewer</code>或在手机上通过开发者选项中的显示布局边界来查看是否有不必要的嵌套。</li>
</ul>
</li>
<li><p>使用<code>include</code><br>  <code>include</code>可以用于将布局中一些公共的部分提取出来。在需要的时候使用即可，比喻一些页面统一的<code>loading</code>页。<br>   <code>include</code>标签的<code>layout</code>属性指定所要包含的布局文件，我们也可以通过<code>android:id</code>或者一些其他的属性来覆盖被引入布局的根节点所对应<br>的属性值。      </p>
   <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">include</span></span></div><div class="line"><span class="attr">layout</span>=<span class="string">"@layout/loading"</span></div><div class="line"><span class="attr">android:id</span>=<span class="string">"@+id/loading_main"</span> /&gt;</div></pre></td></tr></table></figure>
<p>  <code>loading.xml</code>内容为：    </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">ProgressBar</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/pb_loadiing"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"28dip"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"28dip"</span></div><div class="line">		<span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span></div><div class="line">		<span class="attr">android:indeterminateDrawable</span>=<span class="string">"@drawable/progressbar_anim_drawable"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:layout_below</span>=<span class="string">"@id/pb_loadiing"</span></div><div class="line">		<span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></div><div class="line">		<span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:text</span>=<span class="string">"loading..."</span></div><div class="line">		<span class="attr">android:textSize</span>=<span class="string">"15sp"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>使用<code>&lt;merge&gt;</code>标签<br>  <code>merge</code>可以有效的解决布局的层级关系。我们通过一个例子来说明一下：            </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span>&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line"></div><div class="line">		<span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">		<span class="attr">android:src</span>=<span class="string">"@drawable/ic_launcher"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_marginBottom</span>=<span class="string">"20dip"</span></div><div class="line">		<span class="attr">android:textSize</span>=<span class="string">"22sp"</span></div><div class="line">		<span class="attr">android:textColor</span>=<span class="string">"#990000"</span></div><div class="line">		<span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal|bottom"</span></div><div class="line">		<span class="attr">android:text</span>=<span class="string">"TEST"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  我们在一个页面中显示该部分内容，运行后观察<code>Hierarchy Viewer</code>。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/merge_1.png" alt="image"><br>  我们会发现除了我们布局最外层还会有一层<code>FrameLayout</code>，这是因为<code>Activity</code>内容视图的<code>parent view</code>就是一个<code>FrameLayout</code>，所以对于我们来说无意中已经多了一层毫无意义的布局。<br>  接下来<code>merge</code>的功能就能发挥了，修改代码如下。              </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">merge</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">		<span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">		<span class="attr">android:src</span>=<span class="string">"@drawable/ic_launcher"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_marginBottom</span>=<span class="string">"20dip"</span></div><div class="line">		<span class="attr">android:textSize</span>=<span class="string">"22sp"</span></div><div class="line">		<span class="attr">android:textColor</span>=<span class="string">"#990000"</span></div><div class="line">		<span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal|bottom"</span></div><div class="line">		<span class="attr">android:text</span>=<span class="string">"TEST"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">merge</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  接下来我们在用<code>Hierarchy Viewer</code>观察就会发现完美的去掉了一层<code>FrameLayout</code><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/merge_2.png" alt="image"><br>  当然上面我们使用<code>merge</code>是因为跟布局正好是<code>FrameLayout</code>并且没有<code>backgroud</code>和<code>padding</code>等这些属性。如果根本局是<code>LinearLayout</code>等，就没法直接使用<code>merge</code>了。<br>  在<code>include</code>的时候很容易造成布局层级嵌套过多，结合<code>merge</code>使用能有效解决这个问题。</p>
</li>
<li><p>使用<code>ViewStub</code><br>  <code>ViewStub</code>标签与<code>include</code>一样可以用来引入一个外部布局，但是<code>Viewstub</code>引入的布局默认不会解析与显示，宽高为0，<code>View</code>也为<code>null</code>,这样就会在解析<code>layout</code>时节省<code>cpu</code>和内存。简单的理解就是<code>ViewStub</code>是<br><code>include</code>加上<code>GONE</code>.<code>ViewStub</code>常用来引入那些默认不会显示，只在特殊情况下显示的布局，如进度布局、网络失败显示的刷新布局、信息出错出现的提示布局等.</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> &gt;</div><div class="line"></div><div class="line">	……</div><div class="line">	<span class="tag">&lt;<span class="name">ViewStub</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/network_unreachble"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout</span>=<span class="string">"@layout/network_unreachble"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  在代码中通过<code>(ViewStub)findViewById(id)</code>找到<code>ViewStub</code>，使用<code>inflate()</code>展开<code>ViewStub</code>,然后得到子<code>View</code>，如下：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> View mNetErrorView;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNetError</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mNetErrorView != <span class="keyword">null</span>) &#123;</div><div class="line">		mNetErrorView.setVisibility(View.VISIBLE);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ViewStub stub = (ViewStub)findViewById(R.id.network_unreachble);</div><div class="line">	<span class="comment">// 解析并且显示该部分，返回值就是解析后的该`View`</span></div><div class="line">	mNetErrorView = stub.inflate();</div><div class="line">	Button networkSetting = (Button)mNetErrorView.findViewById(R.id.bt_network);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNormal</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mNetErrorView != <span class="keyword">null</span>) &#123;</div><div class="line">		mNetErrorView.setVisibility(View.GONE);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  或者也可以通过第二种方式:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">View viewStub = findViewById(R.id.network_unreachble);</div><div class="line"><span class="comment">// ViewStub被展开后的布局所替换</span></div><div class="line">viewStub.setVisibility(View.VISIBLE);   </div><div class="line"><span class="comment">// 获取展开后的布局</span></div><div class="line">mNetErrorView =  findViewById(R.id.network_unreachble);</div></pre></td></tr></table></figure>
</li>
<li><p>减少不必要的<code>Inflate</code><br>  如上一步中<code>stub.infalte()</code>后将该<code>View</code>进行记录或者是<code>ListView</code>中<code>item inflate</code>的时候。</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/布局优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-性能优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/性能优化/">性能优化</a>
    </h1>
  

        
        <a href="/2015/01/01/性能优化/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><h2 id="代码优化原则"><a href="#代码优化原则" class="headerlink" title="代码优化原则:      "></a>代码优化原则:      </h2><ul>
<li>时间换时间：<br>  如禁用电脑的一些开机启动项，通过减少这些没必要的启动项的时间从而节省开机时间<br>  如网站界面上数据的分批获取，AJAX技术</li>
<li>时间换空间：<br>  如拷贝文件时new一个字节数组当缓冲器，即byte[] buffer = new byte[1024]。<br>  为什么只new一个1024个字节的数组呢，new一个更大的字节数组不是一下就把文件拷贝完了么？这么做就是为了牺牲时间节省有限的内存空间</li>
<li>空间换时间：<br>  如用Windows系统自带的搜索文件的功能搜索文件时会很慢，但是我们牺牲电脑硬盘空间安装一个everything软件来搜索文件就特别快</li>
<li>空间换空间：<br>  如虚拟内存</li>
</ul>
<h2 id="Android开发中的体现"><a href="#Android开发中的体现" class="headerlink" title="Android开发中的体现"></a>Android开发中的体现</h2><ul>
<li>采用硬件加速，在清单文件中<code>application</code>节点添加<code>android:hardwareAccelerated=”true”</code>。不过这个需要在<code>android 3.0</code>才可以使用。<code>android4.0</code>这个选项是默认开启的。</li>
<li><code>View</code>中设置缓存属性<code>setDrawingCache</code>为<code>true</code>.</li>
<li>优化你的布局.</li>
<li>动态加载<code>View</code>. 采用<code>ViewStub</code>避免一些不经常的视图长期握住引用.</li>
<li>将<code>Acitivity</code>中的<code>Window</code>的背景图设置为空。<code>getWindow().setBackgroundDrawable(null);``android</code>的默认背景是不是为空。</li>
<li>采用<code>&lt;merge&gt;</code>优化布局层数。 采用<code>&lt;include&gt;</code>来共享布局。</li>
<li>利用<code>TraceView</code>查看跟踪函数调用。有的放矢的优化。</li>
<li><code>cursor</code>的使用。不过要注意管理好<code>cursor</code>,不要每次打开关闭<code>cursor</code>.因为打开关闭<code>Cursor</code>非常耗时。 <code>Cursor.require</code>用于刷<code>cursor</code>.</li>
<li>采用<code>SurfaceView</code>在子线程刷新<code>UI</code>, 避免手势的处理和绘制在同一<code>UI</code>线程（普通<code>View</code>都这样做）。</li>
<li>采用<code>JNI</code>，将耗时间的处理放到<code>c/c++</code>层来处理。</li>
<li>有些能用文件操作的，尽量采用文件操作，文件操作的速度比数据库的操作要快10倍左右。</li>
<li>避免创建不必要的对象</li>
<li>如果方法用不到成员变量，可以把方法申明为<code>static</code>，性能会提高到15%到20%</li>
<li>避免使用<code>getter/setter</code>存取<code>field</code>，可以把<code>field</code>申明为<code>public</code>，直接访问</li>
<li><code>static</code>的变量如果不需要修改，应该使用<code>static final</code>修饰符定义为常量</li>
<li>使用增强<code>for</code>循环,比普通<code>for</code>循环效率高，但是也有缺点就是在遍历 集合过程中，不能对集合本身进行操作</li>
<li>合理利用浮点数，浮点数比整型慢两倍；</li>
<li>针对ListView的性能优化</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/性能优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-性能优化相关工具" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/性能优化相关工具/">性能优化相关工具</a>
    </h1>
  

        
        <a href="/2015/01/01/性能优化相关工具/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能优化相关工具"><a href="#性能优化相关工具" class="headerlink" title="性能优化相关工具"></a>性能优化相关工具</h1><p>有关性能优化的文章请参考<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.md">性能优化</a>和<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E5%B8%83%E5%B1%80%E4%BC%98%E5%8C%96.md">布局优化</a>    </p>
<p>###DDMS(百宝箱)</p>
<p>#####查看进程的内存使用</p>
<p><code>DDMS</code>可以让你查看到一个进程使用的堆内存。    </p>
<ol>
<li>在<code>Device</code>了表选择你想查看的进程。</li>
<li>点击<code>Update Heap</code>按钮来开启查看进程堆内存信息。</li>
<li>在<code>Heap</code>页面，点击<code>Cause GC</code>来执行垃圾回收。</li>
<li>在列表中点击一个对象类型来查看它所分配的内存大小。   </li>
</ol>
<p>#####追踪对象的内存分配情况     </p>
<ol>
<li>在<code>Device</code>了表选择你想查看的进程。</li>
<li>在<code>Allocation Tracker</code>页面，点击<code>Start Tracking</code>按钮来开始追踪。</li>
<li>点击<code>Get Allocations</code>来查看从你点击<code>Start Tracking</code>之后分配内存的对象列表。 你可以再次点击<code>Get Allocations</code>来添加新分配内存的对象列表。 </li>
<li>停止追踪或者清除数据可以点击<code>Stop Tracking</code>按钮。 </li>
<li>在列表中单独点击一行来查看详细的信息。</li>
</ol>
<p>#####使用文件系统</p>
<p><code>DDMS</code>提供了一个文件浏览器来供你查看、拷贝、删除文件。</p>
<ol>
<li>在<code>Device</code>页面，选中你想要查看的设备。</li>
<li>从设备中拷贝文件，用文件浏览器选择文件后点击<code>Pull file</code>按钮。</li>
<li>拷贝文件到设备中，点击<code>Push file</code>按钮。</li>
</ol>
<p>#####检查线程信息  </p>
<p><code>Thread</code>页面可以显示指定进程中当前正在运行的线程。 </p>
<ol>
<li>在<code>Device</code>页面，选择想要查看的进程。 </li>
<li>点击<code>Update Threads</code>按钮。   </li>
<li>在<code>Thread</code>页面，你可以查看对应的线程信息。 </li>
</ol>
<p>#####启动方法分析</p>
<p>方法分析可以追踪一个方法的特定信息，例如调用数量，执行时间、耗时等。如果想要更精确的控制想要收集的数据，可以使用<code>startMethodTracing()</code>和<code>stopMethodTracing()</code>方法。    </p>
<p>在你开始使用方法分析之前请知晓如下限制:    </p>
<ul>
<li>在<code>Android 2.1</code>及以前的设备必须有<code>SD</code>卡，并且你的应用必须有写入<code>SD</code>卡的权限。 </li>
<li>在<code>Android 2.2</code>及以后的设备中不需要<code>SD</code>卡，<code>trace log</code>文件会直接被导入到开发机上。</li>
</ul>
<p>开启方法分析:    </p>
<ol>
<li>在<code>Device</code>页面，选择想要开启方法分析的进程。</li>
<li>点击<code>Start Method Profiling</code>按钮。</li>
<li>在<code>Android 4.4</code>及以后，可以选择<code>trace_based profiling</code>或者基本的<code>sample-based profiling</code>选项。在之前的版本智能使用<code>trace-based profiling</code>。</li>
<li>在应用中操作界面来执行你想要分析的方法。 </li>
<li>点击<code>Stop Method Profiling</code>按钮。<code>DDMS</code>会停止分析并且将在<code>Start Method Profiling</code>和<code>Stop Method Profiling</code>中间手机的方法分析数据使用<code>Traceview</code>打开。   </li>
</ol>
<h5 id="使用网络流量工具"><a href="#使用网络流量工具" class="headerlink" title="使用网络流量工具"></a>使用网络流量工具</h5><p>从<code>Android 4.0</code>开始,<code>DDMS</code>包含了一个网络使用情况的页面来支持跟踪应用的网络请求。</p>
<p>如图:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/ddms-network.png?raw=true" alt="image">。 </p>
<p>通过检测数据交互的频繁性以及在每次连接中数据的传递量，你可以知道应用中具体可以做的更好更高效的地方。<br>想要更好的查看引起数据交互的地方，可以使用<code>TrafficsStats</code>这个<code>API</code>，它也可以使用<code>setThreadStatsTag()</code>方法来设置数据使用情况的<code>tag</code>，</p>
<p>首先要讲到的是<code>Systrace</code>，之前在淘宝面试的时候被问到，如有查找<code>UI</code>绘制卡顿的问题，我没答上来。早点知道<code>Systrace</code>就好了(当然只知道工具是不够的，也要懂得里面的原理)。</p>
<h3 id="Systrace"><a href="#Systrace" class="headerlink" title="Systrace"></a>Systrace</h3><p><code>Systrace</code>有什么用呢？官方文档中有一片文章的标题是：使用<code>Systrace</code>进行<code>UI</code>性能分析。    </p>
<p>在应用程序开发的过程中，你需要检查用户交互是否平滑流畅，运行在稳定的60fps。如果中间出了些问题，导致某一帧延迟，我们想要解决该问题的第一步就是理解系统如何操作的。     </p>
<p><code>Systrace</code>工具可以让你来手机和观察整个<code>android</code>设备的时间信息，也称为<code>trace</code>。它会显示每个时间点上的<code>CPU</code>消耗图，显示每个线程在显示的内容以及每个进程当时在做的操作。</p>
<p>在使用<code>Systracv</code>来分析应用之前，你需要手机应用的<code>trace log</code>信息。生成的<code>trace</code>能够让你清晰的观察系统在该时间内所做的任何事情。 </p>
<h5 id="生成Trace"><a href="#生成Trace" class="headerlink" title="生成Trace"></a>生成Trace</h5><p>为了能创建一个<code>trace</code>，你必须要执行如下几个操作。 首先，你要有一个<code>Android 4.1</code>及以上的设备。将该设备设置为<code>debugging</code>，连接你的设备并且安装应用。有些类型的信息，特别是一些硬盘的活动和内核工作队列，需要设备获取<code>root</code>权限才可以。 然而，大多数的<code>Systrace log</code>的数据只需要设备开启开发者<code>debugging</code>就可以了。     </p>
<p><code>Systrace</code>可以通过命令行或者图形化界面的方式来运行，在<code>Studio</code>中打开<code>Android Device Monitor</code>然后选择<code>Systracv</code>图标<img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-button.png?raw=true" alt="image">。 </p>
<p>下面以命令行的方式为例，这里只讲解一下<code>Android 4.3</code>及以上的使用方式:     </p>
<ul>
<li>确保设备已经通过<code>USB</code>连接并且开启了<code>debugging</code>模式。 </li>
<li>设置一些参数并执行<code>trace</code>命令，例如:        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">    $ cd android-sdk/platform-tools/systrace</div><div class="line">    $ python systrace.py --time=10 -o mynewtrace.html sched gfx view wm</div><div class="line">    ```  </div><div class="line">    执行完上面的命令后就会在`sdk/platform-tools/systrace/mynewtrace.html`生成对应的`html`文件。 </div><div class="line">- 在设备上执行一些你想要`trace`的过程。     </div><div class="line"></div><div class="line">悲剧了，生成了对应的`html`文件，但是我死活打不开。打开是白屏，折腾了我半天，最后终于找到了解决方法:   </div><div class="line"></div><div class="line">&gt;  Firstly, if anyone is using Chrome v50.0+ on OS X, just try this please.</div><div class="line"></div><div class="line">&gt; open chrome browser and go to &quot;chrome://tracing&quot;</div><div class="line">&gt; in the tracing page, click load and select the systrace generated html file.</div><div class="line">&gt; Secondly, I think it&apos;s a bug which is confirmed by Google.</div><div class="line"></div><div class="line">`OK`了。 </div><div class="line"></div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace_file.png?raw=true =)。 </div><div class="line"></div><div class="line">看不懂！！！</div><div class="line"></div><div class="line">#####分析Trace</div><div class="line"></div><div class="line">用浏览器打开上面生成的`mynewtrace.html`。    下面为了能明显的说明，我就用官网提供的例子来说明了。   </div><div class="line"></div><div class="line">######查看Frames</div><div class="line">从打开的文件中我们能看到每个应用都有一行`frame`的圆圈来标示渲染的帧，通常都是绿色的。黄色或者红的圆圈标示超过了我们对保障60fps所需的16毫秒绘制时间。。 可以在文件上面按`w`键来放大文件以便能更好的观看查找。   </div><div class="line">&gt; ***提示:***在文件上面按`?`键可以查看对应的快捷键。  </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-unselected.png?raw=true)。 </div><div class="line"></div><div class="line">在`Android 5.0`以上的设备上，显示工作呗分为`UI Thread`和`Render Thread`。在之前的版本，所有工作都是在`UI Thread`进行的。 点击某个单独的`frame`图标来查看它们所需的时间。</div><div class="line"></div><div class="line">######观看Alerts    </div><div class="line"></div><div class="line">`Systracv`会自动分析`trace`过程的时间，并且通过`alerts`提示该展现问题，以及建议如何处理。    </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-selected.png?raw=true) </div><div class="line"></div><div class="line">如上图所示，在你点击一个比较慢的`frame`时，下面就会显示一个`alert`。在这种情况下，它直说可能是`ListView`服用以及重复渲染的问题。 如果你发现`UI Thread`做了太多的工作，你可以使用`TraceView`进行代码分析，来找到具体哪些操作导致了消耗时间。</div><div class="line"></div><div class="line">如下，你也可以通过点击窗口右边的`Alerts`来查看当前所有的`alert`。这样会直接展开`Alert`窗口。   </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-selected-alert-tab.png?raw=true)</div><div class="line"></div><div class="line">下面我们以另外一个例子来分析一下它的`Frame`：    </div><div class="line"></div><div class="line">我们点击某一红色`frame`来查看这一阵的一些相关警告:   </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-frame-zoomin.png?raw=true)</div><div class="line">可以看到这里说耗时32毫秒，这已经远远超过了16毫秒的绘制时间。 我们可以通过`Description`来查看描述内容。   </div><div class="line">下面是另外一个渲染过慢的例子:     </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-frame.png?raw=true)</div><div class="line">从上图，我们发现了`Scheduling delay`的警告，加起来能看到总的绘制时间大约是19毫秒。   </div><div class="line">`Scheduling delay`的意思是调度延迟，也就是说一个县城在处理这部分操作时，在很长时间内没有被分配到`CPU`上面进行运算，这样就导致了很长时间内没有完成操作。    我们选择这一帧中最长的一块，来观察下:    </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-slice.png?raw=true)</div><div class="line"></div><div class="line">我们在上图看到了`Wall duration`，他代表着这一块开始到结束的总耗时。而在`CPU Duration`这里显示了`CPU`在处理该部分消耗的时间。 很明显，真个区域用了18毫秒，但是`CPU`实际处理只用了4毫秒，也就是说剩下的14毫秒就可能有问题了。     </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-cpu.png?raw=true)</div><div class="line"></div><div class="line">可以看到，4个线程都比较忙。  </div><div class="line"></div><div class="line">选择其中一个线程来查看是哪个应用在使用它，这里看到了一个包名为`com.udinic.keepbusyapp`的应用。也就是说由于另外一个应用占用了`CPU`,，导致了我们的应用未能获取到足够的`CPU`资源。      </div><div class="line"></div><div class="line"></div><div class="line">#####追踪代码</div><div class="line"></div><div class="line">在`Android 4.3`以上你可以使用`Trace`类来在代码中添加(很熟悉有木有，在看源码的时候经常看到)。这样能查看到此时你的应用线程都做了哪些操作。 </div><div class="line">下面的代码展示了如何使用`Trace`类来追踪两个代码块部分:   </div><div class="line">```java</div><div class="line">public void ProcessPeople() &#123;</div><div class="line">    Trace.beginSection(&quot;ProcessPeople&quot;);</div><div class="line">    try &#123;</div><div class="line">        Trace.beginSection(&quot;Processing Jane&quot;);</div><div class="line">        try &#123;</div><div class="line">            // code for Jane task...</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.endSection(); // ends &quot;Processing Jane&quot;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.beginSection(&quot;Processing John&quot;);</div><div class="line">        try &#123;</div><div class="line">            // code for John task...</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.endSection(); // ends &quot;Processing John&quot;</div><div class="line">        &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">        Trace.endSection(); // ends &quot;ProcessPeople&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###Traceview</p>
<p><code>Traceview</code>是一个性能测试工具，展示了所有方法的运行时间。    </p>
<blockquote>
<p>Traceview is a graphical viewer for execution logs that you create by using the Debug class to log tracing information in your code. Traceview can help you debug your application and profile its performance.</p>
</blockquote>
<p>#####创建Trace文件  </p>
<p>想要使用<code>Traceview</code>你需要创建一个包含你想分析部分的<code>trace</code>信息的<code>log</code>文件。<br>有两种方式来生成<code>trace logs</code>：    </p>
<ul>
<li><p>在你测试的类中添加<code>startMethodTracing()</code>和<code>stopMethodTracing()</code>的代码，来指定开始和结束获取<code>trace</code>信息。这种方式是非常精确的，因为你可以在代码中指定开始和结束的位置。     </p>
</li>
<li><p>使用<code>DDMS</code>中的方法来生成。这种方式就不太精确。虽然这种方式不能精确的指定起始和结束位置，但是如果在你无法修改源代码或者不需要精确时间的时候是非常有用的。 </p>
</li>
</ul>
<p>在开始生成<code>trace log</code>信息时，你需要知道如下的限制条件:    </p>
<ul>
<li>如果你在测试代码中使用，你的应用必须要用<code>WRITE_EXTERNAL_STORAGE</code>的权限。 </li>
<li><p>如果你使用<code>DDMS</code>生成:     </p>
<ul>
<li><code>Android 2.1</code>之前必须有<code>SD</code>卡，并且你的应用也要有写入<code>SD</code>卡的权限。 </li>
<li><code>Android 2.2</code>之后不需要<code>SD</code>卡，<code>trace log</code>文件会直接生成到你的开发机上。   </li>
</ul>
</li>
</ul>
<p>在测试代码中调用<code>startMethodTracing()</code>方法的时候，你可以指定系统生成<code>trace</code>文件的名字。结束的时候调用<code>stopMethodTracing()</code>方法。这些方法开始和结束时贯穿整个虚拟中的。例如你可以在你<code>activity</code>的<code>onCreate()</code>方法中调用<code>startMethodTracing()</code>方法，然后在<code>activity</code>的<code>onDestroy()</code>方法中调用<code>stopMethodTracing()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// start tracing to "/sdcard/calc.trace"</span></div><div class="line">Debug.startMethodTracing(<span class="string">"calc"</span>);</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// stop tracing</span></div><div class="line">Debug.stopMethodTracing();</div></pre></td></tr></table></figure></p>
<p>在调用<code>startMethodTracing()</code>方法的时候，系统创建一个名为<code>&lt;trace-base-name&gt;.trace</code>的文件。它包含方法的二进制<code>trace</code>数据和一个线程与方法名的对应集合。<br>然后系统就开始生成<code>trace</code>数据，直到调用<code>stopMethodTracing()</code>方法。如果在你调用<code>stopMethodTracing()</code>方法之前系统已经达到了最大的缓冲大小，系统就会停止<code>trace</code>并且在控制台发出一个通知。     </p>
<p>#####拷贝Trace文件到电脑上</p>
<p>在模拟器或者机器上生成<code>&lt;trace-base-name&gt;.trace</code>文件后，你需要拷贝他们到你的电脑上，你可以使用<code>adb pull</code>命令来拷贝：<br><code>adb pull /sdcard/calc.trace /tmp</code></p>
<p>#####在Traceview中查看trace文件    </p>
<p>运行<code>Traceview</code>并且查看<code>trace</code>文件:     </p>
<ol>
<li>打开<code>Android Device Monitor</code>。</li>
<li>在<code>Android Device Monitor</code>的状态栏中点击<code>DDMS</code>并且选择一个进程。 </li>
<li>点击<code>Start Method Profiling</code>图标开始查看。</li>
<li>在查看完后点击<code>Stop Method Profiling</code>图标来显示<code>traceview</code>。  </li>
</ol>
<p>大体的样子如下:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_1.png?raw=true" alt="image"> </p>
<p>#####Traceview Layout     </p>
<p>如果你有一个<code>trace log</code>文件(通过添加<code>tracing</code>代码或者用DDMS生成)，你可以把该文件加载到<code>Traceview</code>中，这将会把<code>log</code>数据显示为两部分:    </p>
<ul>
<li><code>timeline panel</code>-展示了每个线程和方法的起始和结束</li>
<li><code>profile panel</code>-提供了一个方法中的执行内容的简述</li>
</ul>
<p>#####Timeline Panel</p>
<p>每个线程都会以时间从左往右递增的方式在单独的一行中显示它的执行情况，</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_timeline.png?raw=true" alt="image"></p>
<p>#####Profile Panel</p>
<p>显示了一个方法所消耗的时间的概要情况。在表格中会同时显示<code>inclusive</code>和<code>exclusive</code>的时间。<code>Exclusive</code>的时间是该方法所消耗的时间。<code>InClusive</code>的时间是该方法消耗的时间加上任何调的方法所消耗的时间。我们简单的将调用的方法叫做<code>parents</code>，被调用的方法叫做<code>children</code>。如果一个方法被调用，它会显示对应的<code>parents</code>和<code>children</code>。<code>parents</code>会显示一个紫色的背景，<code>children</code>会显示一个黄色的背景。最后一列显示了该方法所调用的总数的调用数。在下面的图中我们能看到一共有14个地方调用了<code>LoadListener.nativeFinished()</code> . </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_profile.png?raw=true" alt="image"></p>
<ul>
<li>Name 方法名</li>
<li>Inclusive CPU Time， CPU在处理该方法以及所有子方法(被它调用的所有方法)所消耗的时间。</li>
<li>Exlusive CPU Time, CPU在处理该方法的耗时。</li>
<li>Inclusive/Exclusive Real Time， 从方法开始执行到执行结束的耗时。 </li>
<li>Cal+Rec, 这个方法被调用的次数，以及递归被调用的次数。 </li>
<li>CPU/Real time per Call, 在处理这个方法时的<code>CPU</code>耗时的平均值。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview-getview.png?raw=true" alt="image"></p>
<p>上图中<code>getView</code>方法被调用了12次，每次<code>CPU</code>消耗2.8秒，但是每次调用的总耗时是162秒，这里肯定有问题。<br>而看看这个方法的children，我们可以看到这其中的每个方法在耗时方面是如何分布的。Thread.join()方法战局了98%的inclusive real time。这个方法在等待另一个线程结束的时候被调用。在Children中另外一个方法就是Tread.start()方法，而之所以整个方法耗时很长，我猜测是因为在getView()方法中启动了线程并且在等待它的结束。</p>
<p>但是这个线程在哪儿？</p>
<p>我们在getView()方法中并不能看到这个线程做了什么，因为这段逻辑不在getView()方法之中。于是我找到了Thread.run()方法，就是在线程被创建出来时候所运行的方法。而跟随这个方法一路向下，我找到了问题的元凶。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview-thread.png?raw=true" alt="image"></p>
<p>我发现了BgService.doWork()方法的每次调用花费了将近14毫秒，并且有四十个这东西！而且getView()中还有可能调用多次这个方法，这就解释了为什么getView()方法执行时间如此之长。这个方法让CPU长时间的保持在了繁忙状态。而看看Exclusive CPU time，我们可以看到他占据了80%的CPU时间！此外，根据Exclusive CPU time排序，可以帮我们更好的定位那些耗时很长的方法，而他们很有可能就是造成性能问题的罪魁祸首。</p>
<p>关注这些耗时方法，例如getView()，View#onDraw()等方法，可以很好的帮助我们寻找为什么应用运行缓慢的原因。但有些时候，还会有一些其他的东西来占用宝贵的CPU资源，而这些资源如果被运用在UI的绘制上，也许我们的应用会更加流畅。Garbage Collector垃圾回收机制会不时的运行，回收那些没用的对象，通常来讲这不会影响我们在前台运行的程序。但如果GC被运行的过于频繁，他同样可以影响我们应用的执行效率。而我们该如何知道回收的是否过于频繁了呢…</p>
<p>###Monitors</p>
<p>在<code>Android Studio</code>中下方的<code>Android Monitor</code>中可以看到<code>Monitors</code>工具栏，它能不断的去检测内存、网络、CPU的消耗情况。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/monitor.png?raw=true" alt="image"></p>
<p>我们可以直接点击<code>Dump Java Heap</code>或者<code>Call GC</code>等按钮，以便更好的去观察内存的使用情况。点击后会生成一个<code>.hprof</code>的文件。生成后直接使用<code>Studio</code>打开<code>.hprof</code>文件即可。  </p>
<p>说到这里插一嘴,<a href="https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6.md">有关Java垃圾回收机制请参考</a></p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/dump_href.png?raw=true" alt="image"><br>在左边能看到所有堆内存中的实例。后面会显示他所占用的内存大小。</p>
<p>对于内存泄漏的分析可以使用<code>MAT</code>或者<code>LeakCanary</code>来进行。这里就不仔细说了。   </p>
<p>#####不同虚拟机的内存管理 </p>
<p><code>Android Monitor</code>使用的<code>Virtual Machine(VM)</code>:    </p>
<ul>
<li><code>Android 4.3(API Level 18)</code>及以前的版本使用<code>Dalvik VM</code> .</li>
<li><code>Android 4.4(API Level 19)</code>默认使用<code>Dalvik VM</code>，<code>Android RunTime(ART)</code>是可选的。</li>
<li><code>Android 4.3(API Level 18)</code>及更高的版本使用<code>ART VM</code>.</li>
</ul>
<p>虚拟之执行垃圾回收。Dalvik虚拟机使用一个标记和清除垃圾收集方案。<code>ART</code>虚拟机使用分代收集算法与标记和清楚手机算法相结合的方式。 <code>Logcat</code>会显示一些垃圾回收相关的信息。     </p>
<p>#####GPU使用情况</p>
<p>上面也显示了<code>GPU</code>的使用情况，这里要说一句，如果想要显示它，必须要在手机的开发者中心中开启<code>GPU显示配置文件</code>选项，将其设置为显示与<code>adb shell dumpsys gfxinfo</code>。然后再点击<code>Studio</code>中的按钮重新开始就可以看到了。 每一条线意味着一帧被绘制出来了。而线的颜色又代表不同的阶段：    </p>
<ul>
<li>Draw(蓝色)代表着<code>View.onDraw()</code>方法。如果这个值很高就说明可能是该<code>View</code>比较复杂。 在这个环节会创建/刷新DisplayList中的对象，这些对象在后面会被转换成GPU可以明白的OpenGL命令。而这个值比较高可能是因为view比较复杂，需要更多的时间去创建他们的display list，或者是因为有太多的view在很短的时间内被创建。</li>
<li><p>Prepare(紫色)，从<code>Android 6.0</code>开始，一个新的线程被引进来帮助<code>UI</code>线程进行绘制。 这个线程叫做<code>Render Thread</code>。它负责转换它负责转换display list到OpenGL命令并且送至GPU。在这过程中，UI线程可以继续开始处理后面的帧。而在UI线程将所有资源传递给RenderThread过程中所消耗的时间，就是紫色阶段所消耗的时间。如果在这过程中有很多的资源都要进行传递，display list会变得过多过于沉重，从而导致在这一阶段过长的耗时。</p>
</li>
<li><p>Process(红色) 执行Display list中的内容并创建OpenGL命令。如果有过多或者过于复杂的display list需要执行的话，那么这阶段会消耗较长的时间，因为这样的话会有很多的view被重绘。而重绘往往发生在界面的刷新或是被移动出了被覆盖的区域。</p>
</li>
<li><p>Execute (黄色) – 发送OpenGL命令到GPU。这个阶段是一个阻塞调用，因为CPU在这里只会发送一个含有一些OpenGL命令的缓冲区给GPU，并且等待GPU返回空的缓冲区以便再次传递下一帧的OpenGL命令。而这些缓冲区的总量是一定的，如果GPU太过于繁忙，那么CPU则会去等待下一个空缓冲区。所以，如果我们看到这一阶段耗时比较长，那可能是因为GPU过于繁忙的绘制UI，而造成这个的原因则可能是在短时间内绘制了过于复杂的view。</p>
</li>
<li><p>Measure/Layout(绿色) 代表<code>Measure</code>和<code>Layout</code>的时间。 </p>
</li>
</ul>
<p>###Hierarchy Viewer</p>
<p>布局分析工具，非常常用。</p>
<p>在<code>Android Device Monitor</code>中打开<code>Hierarchy Viewer</code>即可。</p>
<ul>
<li>连接你的手机或者模拟器。<br>  出于安全性考虑，<code>Hierarchy Viewer</code>只能连接开发者版的系统的手机。 </li>
<li>运行程序，并且让界面显示出来。</li>
<li>启动<code>hierarchy view</code>工具，接着就能看到左边栏显示出了对应的设备，展开后可以看到一些组件的名称。这个页面包含了应用的界面以及系统的界面。选择你的应用中想要查看的界面直接双击就可以了。    </li>
</ul>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/gettingstarted_image005.png?raw=true" alt="image"><br>如果你的界面显示的不是这个样子，少一些东西的话，你可以使用<code>Window&gt;Reset Perspective</code>来重置样式。 </p>
<p>但是我并打不开。<br>如果你的手机是<code>Android 4.1</code>及以上版本你必须要在你的电脑上设置一个<code>ANDROID_HVPROTO</code>DE 环境变量才可以。</p>
<ul>
<li>Windows<br>  增加一个名为<code>ANDROID_HVPROTO</code>值为<code>ddm</code>的环境变量就可以了。 </li>
<li><p>Mac </p>
<ul>
<li>打开<code>.bash_profile</code><ul>
<li><code>touch .bash_profile</code>创建</li>
<li><code>open -e .bash_profile</code>打开</li>
</ul>
</li>
<li><p>添加    </p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#Hierarchy Viewer Variable              </div><div class="line">export ANDROID_HVPROTO=ddm</div></pre></td></tr></table></figure>
</li>
<li><p><code>source .bash_profile</code></p>
</li>
</ul>
</li>
</ul>
<p>如果配置完成后仍然不能用的话，你可以:   </p>
<ul>
<li>关闭<code>Android Studio</code>.</li>
<li>执行<code>add kill-server</code>，然后<code>adb start-server</code>.</li>
<li>通过命令行开始<code>hierarchyviewer</code>.</li>
</ul>
<p>好了，我们直接打开自己的页面进行查看布局吧(有点慢)。<br>它是介个样子滴 ：<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/hierarchy_vierwe_page.png?raw=true" alt="image"></p>
<p>我们可以看到所有结构，点击对一个的节点，能直接看到该界面的<code>UI</code>效果，并展示该布局包含多少个<code>View</code>，以及该布局<code>measure,draw,layout</code>所消耗的时间。选中<code>Show Extras</code>选项可以看到在右下角看到界面效果。   </p>
<p>选中要查看的节点后点击<code>Profile Node</code>选项，可以看到如下界面:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/hierarchy_profile_node.png?raw=true" alt="image"></p>
<p>可以看到每个布局都出现了三个点。有不同的颜色,从左到右这三个点分别表示:   </p>
<ul>
<li>左边的点代表<code>Draw</code>阶段。</li>
<li>中间的点代表了<code>Layout</code>阶段。</li>
<li>右边的点代表了<code>Execute</code>阶段。</li>
</ul>
<p>这三个点有分别对应了<code>pipeline</code>中的不同阶段，如下图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/gettingstarted_image015.png?raw=true" alt="image"></p>
<p>不同的颜色代表不同的性能:    </p>
<ul>
<li>绿色代表渲染的非常快，至少是其他<code>View</code>的一半。</li>
<li>黄色代表<code>View</code>渲染比最后那一半的<code>View</code>快。</li>
<li>红色代表<code>View</code>渲染是几乎是在最慢的那部分中间。</li>
</ul>
<p><code>Hierarchy Viewer</code>测量的是相对的表现能力，所以总会有一个红色的节点，它并不意味者该<code>View</code>一定是绘制的太慢。 </p>
<p>###过度绘制</p>
<p>在开发者选项中将调试GPU过度绘制设置为显示过度绘制区域，就能看到程序的绘制情况。<br>过度绘制往往发生在我们需要在一个东西上面绘制另外一个东西，例如在一个红色的背景上画一个黄色的按钮。那么GPU就需要先画出红色背景，再在他上面绘制黄色按钮，此时过度绘制就是不可避免的了。如果我们有太多层需要绘制，那么则会过度的占用GPU导致我们每帧消耗的时间超过16毫秒。<br>这些过度绘制可能发生在我们给Activity或Fragment设置了全屏的背景，同时又给ListView以及ListView的条目设置了背景色。而通过只设置一次背景色即可解决这样的问题。</p>
<p>注意：默认的主题会为你指定一个默认的全屏背景色，如果你的activity又一个不透平的背景盖住了默认的背景色，那么你可以移除主题默认的背景色，这样也会移除一层的过度绘制。这可以通过配置主题配置或是通过代码的方法，在onCreate()方法中调用getWindow().setBackgroundDrawable(null)方法来实现。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/overdraw-gif.gif?raw=true" alt="image"></p>
<p>###Hardware Acceleration</p>
<p>在Honeycomb版本中引入了硬件加速（Hardware Accleration）后，我们的应用在绘制的时候就有了全新的绘制模型。它引入了DisplayList结构，用来记录View的绘制命令，以便更快的进行渲染。但还有一些很好的功能开发者们往往会忽略或者使用不当——View layers。</p>
<p>使用View layers（硬件层），我们可以将view渲染入一个非屏幕区域缓冲区（off-screen buffer，前面透明度部分提到过），并且根据我们的需求来操控它。这个功能主要是针对动画，因为它能让复杂的动画效果更加的流畅。而不使用硬件层的话，View会在动画属性（例如coordinate, scale, alpha值等）改变之后进行一次刷新。而对于相对复杂的view，这一次刷新又会连带它所有的子view进行刷新，并各自重新绘制，相当的耗费性能。使用View layers，通过调用硬件层，GPU直接为我们的view创建一个结构，并且不会造成view的刷新。而我们可以在避免刷新的情况下对这个结构进行进行很多种的操作，例如x/y位置变换，旋转，透明度等等。总之，这意味着我们可以对一个让一个复杂view执行动画的同时，又不会刷新！这会让动画看起来更加的流畅。<br>在阅读了ViewPager的源码后，我发现了在滑动的时候会自动为左右两页启动一个硬件层，并且在滑动结束后移除掉。</p>
<p>在两页间滑动的时候创建硬件层也是可以理解的，但对我来说小有不幸。通常来讲加入硬件层是为了让ViewPager的滑动更加流畅，毕竟它们相对复杂。</p>
<p>是的，但是再使用硬件layers的时候还是有几点要牢记在心：</p>
<ul>
<li>回收 – 硬件层会占用GPU中的一块内存。只在必要的时候使用他们，比如动画，并且事后注意回收。例如在上面ObjectAnimator的例子中，我们增加了一个动画结束监听以便在动画结束后可以移除硬件层。而在Property animator的例子中，我们使用了withLayers()，这会在动画开始时候自动创建硬件层并且在结束的时候自动移除。</li>
<li>如果你在调用了硬件View layers后改变了View，那么会造成硬件硬件层的刷新并且再次重头渲染一遍view到非屏幕区域缓存中。这种情况通常发生在我们使用了硬件层暂时还不支持的属性（目前为止，硬件层只针对以下几种属性做了优化：otation、scale、x/y、translation、pivot和alpha）。例如，如果你另一个view执行动画，并且使用硬件层，在屏幕滑动他们的同时改变他的背景颜色，这就会造成硬件层的持续刷新。而以硬件层的持续刷新所造成的性能消耗来说，可能让它在这里的使用变得并不那么值。</li>
</ul>
<p>有关如何使用<code>Hardware Layer</code>请参考之前写的文章:<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E9%80%9A%E8%BF%87Hardware%20Layer%E6%8F%90%E9%AB%98%E5%8A%A8%E7%94%BB%E6%80%A7%E8%83%BD.md">通过Hardware Layer提高动画性能</a></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/性能优化相关工具/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio中进行ndk开发" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio中进行ndk开发/">AndroidStudio中进行ndk开发</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio中进行ndk开发/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio中进行ndk开发"><a href="#AndroidStudio中进行ndk开发" class="headerlink" title="AndroidStudio中进行ndk开发"></a>AndroidStudio中进行ndk开发</h1><ul>
<li>创建工程，声明<code>native</code>方法。                 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startDaemon</span><span class="params">(String serviceName, <span class="keyword">int</span> sdkVersion)</span></span>;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> &#123;</div><div class="line">       System.loadLibrary(<span class="string">"daemon"</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>生成<code>class</code>文件。<br>  执行<code>Build-Make Project</code>命令，生成<code>class</code>文件。所在目录为<code>app_path/build/intermediates/classes/debug</code></li>
</ul>
<ul>
<li><p>执行<code>javah</code>生成<code>.h文件</code>                    </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">	C:\Users\Administrator&gt;javah -help</div><div class="line">	用法:</div><div class="line">	  javah [options] &lt;classes&gt;</div><div class="line">	其中, [options] 包括:</div><div class="line">	  -o &lt;file&gt;                输出文件 (只能使用 -d 或 -o 之一)</div><div class="line">	  -d &lt;dir&gt;                 输出目录</div><div class="line">	  -v  -verbose             启用详细输出</div><div class="line">	  -h  --help  -?           输出此消息</div><div class="line">	  -version                 输出版本信息</div><div class="line">	  -jni                     生成 JNI 样式的标头文件 (默认值)</div><div class="line">	  -force                   始终写入输出文件</div><div class="line">	  -classpath &lt;path&gt;        从中加载类的路径</div><div class="line">	  -cp &lt;path&gt;               从中加载类的路径</div><div class="line">	  -bootclasspath &lt;path&gt;    从中加载引导类的路径</div><div class="line">	```	</div><div class="line">	在`Studio Terminal`中进入到`src/main`目录下执行`javah`命令:       </div><div class="line">	`javah -d jni -classpath &lt;SDK_android.jar&gt;;&lt;APP_classes&gt; &lt;class&gt;`</div><div class="line">	</div><div class="line">	`F:\DaemonService\app\src\main&gt;javah -d jni -classpath C:\develop\android-sdk-windows\platforms\android-22\android.jar;..\..\build\intermediates\classes\debug com.charonchui.daemonservice.service.DaemonService`</div><div class="line">	执行完成后就会在`src/main/jni`目录下生成`com_charonchui_daemonservice_service_DaemonService.h`文件。</div><div class="line"></div><div class="line">- 在`module/src/main/jni`目录下创建对应的`.c`文件。</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">- 配置`ndk`路径，在项目右键`Moudle Setting`中设置。              </div><div class="line">    ![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_ndk_jni.png?raw=true)    </div><div class="line">	</div><div class="line">- 在`build.gradle`中配置`ndk`选项              </div><div class="line"></div><div class="line">    ```java</div><div class="line">	android &#123;</div><div class="line">		compileSdkVersion 23</div><div class="line">		buildToolsVersion &quot;23.0.1&quot;</div><div class="line"></div><div class="line">		defaultConfig &#123;</div><div class="line">			applicationId &quot;com.charonchui.daemonservice&quot;</div><div class="line">			minSdkVersion 8</div><div class="line">			targetSdkVersion 23</div><div class="line">			versionCode 1</div><div class="line">			versionName &quot;1.0&quot;</div><div class="line"></div><div class="line">			ndk &#123;</div><div class="line">				moduleName &quot;uninstall_feedback&quot; // 配置so名字</div><div class="line">				ldLibs &quot;log&quot;</div><div class="line">	//            abiFilters &quot;armeabi&quot;, &quot;x86&quot;  // 默认就是全部的，加了配置才会生成选中的</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buildTypes &#123;</div><div class="line">			release &#123;</div><div class="line">				minifyEnabled false</div><div class="line">				proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>  这里可能会出现错误:      </p>
<ul>
<li><code>Error: NDK integration is deprecated in the current plugin. Consider trying the new experimental plugin. For details, see http://tools.android.com/tech-docs/new-build-system/gradle-experimental. Set &quot;android.useDeprecatedNdk=true&quot; in gradle.properties to continue using the current NDK integration.</code><br>  解决方法就是在<code>gradle.properties</code>文件中添加<code>android:useDeprecatedNdk=true</code>就可以了。</li>
<li>`Error:Execution failed for task ‘:app:compileDebugNdk’.<blockquote>
<p>com.android.ide.common.process.ProcessException: org.gradle.process.internal.ExecException: Process ‘command ‘E:\android-ndk-r10\ndk-build.cmd’’ finished with non-zero exit value 2<code>解决方法就是在</code>jni<code>目录建一个任意名字的</code>.c`空文件就可以了。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>执行Build<br>  然后就可以在<code>app/build/intermediates/ndk/debug/obj/local</code>下看到所有架构的<code>so</code>了。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_ndk_build.png?raw=true" alt="image">    </p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio中进行ndk开发/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-屏幕适配之百分比方案详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/屏幕适配之百分比方案详解/">屏幕适配之百分比方案详解</a>
    </h1>
  

        
        <a href="/2015/01/01/屏幕适配之百分比方案详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="屏幕适配之百分比方案详解"><a href="#屏幕适配之百分比方案详解" class="headerlink" title="屏幕适配之百分比方案详解"></a>屏幕适配之百分比方案详解</h1><p><code>Android</code>设备碎片化十分严重，在开发过程中的适配工作也非常很繁琐，有关屏幕适配的介绍请看之前的文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%9F%BA%E7%A1%80/%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D.md">屏幕适配</a>。</p>
<p>最近看到<code>DrawerLayout</code>，<code>support v4</code>中提供的类，想到对<code>google</code>提供的这些支持库，自己一点都不熟悉，想着看看<code>Google</code>提供的支持库都有什么内容。结果看着看着在最后忽然看到了<code>Percent Support Library</code>。寻思怎么还百分比呢？仔细一看介绍，我擦，真是太有用了。</p>
<blockquote>
<p>###Percent Support Library<br>The Percent package provides APIs to support adding and managing percentage based dimensions in your app.</p>
<p>The Percent Support library adds support for the PercentLayoutHelper.PercentLayoutParams interface and various classes, such as PercentFrameLayout and PercentRelativeLayout.</p>
<p>After you download the Android Support Libraries, this library is located in the <sdk>/extras/android/support/percent directory. For more information on how to set up your project, follow the instructions in Adding libraries with resources.</sdk></p>
<p>The Gradle build script dependency identifier for this library is as follows:<br><code>com.android.support:percent:23.3.0</code></p>
</blockquote>
<p>看到了吗？ 说提供了<code>PercentFrameLayout</code>和<code>PercentRelativeLayout</code>来支持百分比了。这样不就完美的解决了适配的问题嘛。啥也不说了，立马配置<code>cradle</code>来瞧瞧。   </p>
<blockquote>
<p>Subclass of FrameLayout that supports percentage based dimensions and margins. You can specify dimension or a margin of child by using attributes with “Percent” suffix. </p>
</blockquote>
<p>上代码:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.percent.PercentFrameLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">app:layout_widthPercent</span>=<span class="string">"50%"</span></div><div class="line">        <span class="attr">app:layout_heightPercent</span>=<span class="string">"50%"</span></div><div class="line">        <span class="attr">app:layout_marginTopPercent</span>=<span class="string">"25%"</span></div><div class="line">        <span class="attr">app:layout_marginLeftPercent</span>=<span class="string">"25%"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.percent.PercentFrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果如下:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/percent_frame.png?raw=true" alt="image"><br>完美.   </p>
<p>支持的属性:    </p>
<ul>
<li><code>layout_widthPercent</code></li>
<li><code>layout_heightPercent</code></li>
<li><code>layout_marginPercent</code></li>
<li><code>layout_marginLeftPercent</code></li>
<li><code>layout_marginTopPercent</code></li>
<li><code>layout_marginRightPercent</code></li>
<li><code>layout_marginBottomPercent</code></li>
<li><code>layout_marginStartPercent</code></li>
<li><code>layout_marginEndPercent</code></li>
<li><code>layout_aspectRatio</code></li>
</ul>
<blockquote>
<p>It is not necessary to specify layout_width/height if you specify layout_widthPercent. However, if you want the view to be able to take up more space than what percentage value permits, you can add layout_width/height=”wrap_content”. In that case if the percentage size is too small for the View’s content, it will be resized using wrap_content rule.</p>
</blockquote>
<p>如果指定了<code>layout_widthPercent</code>就不用指定<code>layout_width/height</code>属性了。(<code>Studio</code>可能会提示错误，设置忽略就好)。然而，如果你想要该<code>View</code>能够占用比设置的百分比值更大的空间时，你可以指定<code>layout_widht/height=“wrap_content”</code>。在这种情况下，如果设置的百分比值在显示内容时太小时，将会使用<code>wrap_content</code>的值重新计算。</p>
<p>就是这个意思:如果指定的百分比太小怕显示不开的话，也可以给它指定<code>wrap_content</code>属性，这样当显示不开的时候就会使用<code>wrap_content</code>的值。<br>如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.percent.PercentFrameLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"顶顶顶顶顶大大大"</span></div><div class="line">        <span class="attr">android:textSize</span>=<span class="string">"30dp"</span></div><div class="line">        <span class="attr">android:singleLine</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">app:layout_widthPercent</span>=<span class="string">"30%"</span></div><div class="line">        <span class="attr">app:layout_heightPercent</span>=<span class="string">"5%"</span></div><div class="line">        <span class="attr">app:layout_marginTopPercent</span>=<span class="string">"25%"</span></div><div class="line">        <span class="attr">app:layout_marginLeftPercent</span>=<span class="string">"25%"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.percent.PercentFrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/percent_wrap.png?raw=true" alt="image">    </p>
<p>加入<code>wrap_content</code>后一点效果也没有啊，还是显示不全啊，和没加<code>wrap_content</code>一样，- -!</p>
<p>你也可以通过只设置<code>width</code>或者<code>height</code>和<code>layout_aspectRatio</code>这种比例值的方式来让第另一个值自动计算。例如，如果你想要使用<code>16:9</code>的比例，你可以使用:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">android:layout_width="300dp"</div><div class="line">app:layout_aspectRatio="178%"</div></pre></td></tr></table></figure></p>
<p>这样将会在宽固定为<code>300dp</code>的基础上以16:9(1.78:1)来计算高度。</p>
<p><code>PercentRelativeLayout</code>的使用都是一样的，这里就不贴了。   </p>
<p>那它是怎么实现的呢？其实就是内部给通过属性换算，把本布局的宽高和百分比去计算每个<code>view</code>的大小和位置。但是还有为什么上面设置的<code>wrap_content</code>无效呢？是我理解错了吗？</p>
<p>带着这两个疑问我们来看下源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PercentFrameLayout</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PercentLayoutHelper mHelper = <span class="keyword">new</span> PercentLayoutHelper(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> LayoutParams <span class="title">generateDefaultLayoutParams</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(getContext(), attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        mHelper.adjustChildren(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="comment">// 从名字上就能看出来下面就是处理如果指定百分比过小不足显示内容时，就去使用`wrap_content`的逻辑</span></div><div class="line">        <span class="keyword">if</span> (mHelper.handleMeasuredStateTooSmall()) &#123;</div><div class="line">            <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">        mHelper.restoreOriginalParams();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LayoutParams</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span>.<span class="title">LayoutParams</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">PercentLayoutHelper</span>.<span class="title">PercentLayoutParams</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> PercentLayoutHelper.PercentLayoutInfo mPercentLayoutInfo;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(Context c, AttributeSet attrs)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(c, attrs);</div><div class="line">            <span class="comment">// PercentLayoutInfo中去解析自定义属性的值</span></div><div class="line">            mPercentLayoutInfo = PercentLayoutHelper.getPercentLayoutInfo(c, attrs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> gravity)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height, gravity);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(ViewGroup.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(MarginLayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(FrameLayout.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>((MarginLayoutParams) source);</div><div class="line">            gravity = source.gravity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>((FrameLayout.LayoutParams) source);</div><div class="line">            mPercentLayoutInfo = source.mPercentLayoutInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> PercentLayoutHelper.<span class="function">PercentLayoutInfo <span class="title">getPercentLayoutInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mPercentLayoutInfo == <span class="keyword">null</span>) &#123;</div><div class="line">                mPercentLayoutInfo = <span class="keyword">new</span> PercentLayoutHelper.PercentLayoutInfo();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> mPercentLayoutInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setBaseAttributes</span><span class="params">(TypedArray a, <span class="keyword">int</span> widthAttr, <span class="keyword">int</span> heightAttr)</span> </span>&#123;</div><div class="line">            PercentLayoutHelper.fetchWidthAndHeight(<span class="keyword">this</span>, a, widthAttr, heightAttr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>源码不长，主要是三个部分:    </p>
<ul>
<li>重写<code>onMeasure</code>，根据百分比转换成对应的尺寸</li>
<li>重写<code>onLayout</code></li>
<li>自定义<code>LayoutParams</code>，在<code>FrameLayout.LayoutParams</code>的基础上多实现了一个接口。包含了<code>PercentLayoutHelper.PercentLayoutInfo</code>属性，而文档中对<code>PercentLayoutInfo</code>的介绍是<code>Container for information about percentage dimensions and margins. It acts as an extension for LayoutParams.</code></li>
</ul>
<p>我们也先一步步的来分析，首先看下<code>mHelper.adjustChildren(widthMeasureSpec, heightMeasureSpec);</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and changes their width and height to one calculated from percentage</div><div class="line"> * values.</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Width MeasureSpec of the parent ViewGroup.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Height MeasureSpec of the parent ViewGroup.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"adjustChildren: "</span> + mHost + <span class="string">" widthMeasureSpec: "</span></div><div class="line">                + View.MeasureSpec.toString(widthMeasureSpec) + <span class="string">" heightMeasureSpec: "</span></div><div class="line">                + View.MeasureSpec.toString(heightMeasureSpec));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> widthHint = View.MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">    <span class="keyword">int</span> heightHint = View.MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">    <span class="comment">// mHost是由构造函数传递过来的，就是PercentFrameLayout自身。</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should adjust "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            <span class="comment">// 通过PercentLayoutParams. getPercentLayoutInfo()方法得到PercentLayoutInfo，至于PercentLayoutInfo类在上面也说过了。</span></div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"using "</span> + info);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">                    <span class="comment">// PercentFrameLayout.LayoutParams继承自FrameLayout.LayoutParams，而FrameLayout.LayoutParams又继承自ViewGroup.MarginLayoutParams</span></div><div class="line">                    info.fillMarginLayoutParams(view, (ViewGroup.MarginLayoutParams) params,</div><div class="line">                            widthHint, heightHint);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    info.fillLayoutParams(params, widthHint, heightHint);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以上面代码的意思就是通过对每个子<code>View</code>调用<code>getLayoutParams</code>方法，然后从该<code>LayoutParams</code>中获取到它的<code>PercentLayoutInfo</code>属性，然后再调用<code>PercentLayoutInfo.fillMarginLayoutParams()</code>方法。</p>
<p>那我们继续看一下<code>PercentLayoutInfo.fillMarginLayoutParams()</code>方法的实现，该方法是根据百分比去设置尺寸和margin:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills &#123;<span class="doctag">@code</span> ViewGroup.MarginLayoutParams&#125; dimensions and margins based on percentage</div><div class="line"> * values.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillMarginLayoutParams</span><span class="params">(View view, ViewGroup.MarginLayoutParams params,</span></span></div><div class="line">        <span class="keyword">int</span> widthHint, <span class="keyword">int</span> heightHint) &#123;</div><div class="line">    <span class="comment">// 根据百分比值设置View的尺寸</span></div><div class="line">    fillLayoutParams(params, widthHint, heightHint);</div><div class="line"></div><div class="line">    <span class="comment">// 从注释中就能知道，fillLayoutParams是计算尺寸，那下面这部分就是处理margin了</span></div><div class="line">    <span class="comment">// mPreservedParams来记录原始的margin值</span></div><div class="line">    <span class="comment">// Preserve the original margins, so we can restore them after the measure step.</span></div><div class="line">    mPreservedParams.leftMargin = params.leftMargin;</div><div class="line">    mPreservedParams.topMargin = params.topMargin;</div><div class="line">    mPreservedParams.rightMargin = params.rightMargin;</div><div class="line">    mPreservedParams.bottomMargin = params.bottomMargin;</div><div class="line">    MarginLayoutParamsCompat.setMarginStart(mPreservedParams,</div><div class="line">            MarginLayoutParamsCompat.getMarginStart(params));</div><div class="line">    MarginLayoutParamsCompat.setMarginEnd(mPreservedParams,</div><div class="line">            MarginLayoutParamsCompat.getMarginEnd(params));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (leftMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.leftMargin = (<span class="keyword">int</span>) (widthHint * leftMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (topMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.topMargin = (<span class="keyword">int</span>) (heightHint * topMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (rightMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.rightMargin = (<span class="keyword">int</span>) (widthHint * rightMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (bottomMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.bottomMargin = (<span class="keyword">int</span>) (heightHint * bottomMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">boolean</span> shouldResolveLayoutDirection = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (startMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        MarginLayoutParamsCompat.setMarginStart(params,</div><div class="line">                (<span class="keyword">int</span>) (widthHint * startMarginPercent));</div><div class="line">        shouldResolveLayoutDirection = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (endMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        MarginLayoutParamsCompat.setMarginEnd(params,</div><div class="line">                (<span class="keyword">int</span>) (widthHint * endMarginPercent));</div><div class="line">        shouldResolveLayoutDirection = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (shouldResolveLayoutDirection &amp;&amp; (view != <span class="keyword">null</span>)) &#123;</div><div class="line">        <span class="comment">// Force the resolve pass so that start / end margins are propagated to the</span></div><div class="line">        <span class="comment">// matching left / right fields</span></div><div class="line">        MarginLayoutParamsCompat.resolveLayoutDirection(params,</div><div class="line">                ViewCompat.getLayoutDirection(view));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"after fillMarginLayoutParams: ("</span> + params.width + <span class="string">", "</span> + params.height</div><div class="line">                + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>PercentLayoutInfo.fillLayoutParams()</code>的实现，该方法是通过百分比设置<code>View</code>的尺寸:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills &#123;<span class="doctag">@code</span> ViewGroup.LayoutParams&#125; dimensions based on percentage values.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillLayoutParams</span><span class="params">(ViewGroup.LayoutParams params, <span class="keyword">int</span> widthHint,</span></span></div><div class="line">        <span class="keyword">int</span> heightHint) &#123;</div><div class="line">    <span class="comment">// mPreservedParams来记录原始的宽高值</span></div><div class="line">    <span class="comment">// Preserve the original layout params, so we can restore them after the measure step.</span></div><div class="line">    mPreservedParams.width = params.width;</div><div class="line">    mPreservedParams.height = params.height;</div><div class="line"></div><div class="line">    <span class="comment">// We assume that width/height set to 0 means that value was unset. This might not</span></div><div class="line">    <span class="comment">// necessarily be true, as the user might explicitly set it to 0. However, we use this</span></div><div class="line">    <span class="comment">// information only for the aspect ratio. If the user set the aspect ratio attribute,</span></div><div class="line">    <span class="comment">// it means they accept or soon discover that it will be disregarded.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> widthNotSet =</div><div class="line">            (mPreservedParams.mIsWidthComputedFromAspectRatio</div><div class="line">                    || mPreservedParams.width == <span class="number">0</span>) &amp;&amp; (widthPercent &lt; <span class="number">0</span>);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> heightNotSet =</div><div class="line">            (mPreservedParams.mIsHeightComputedFromAspectRatio</div><div class="line">                    || mPreservedParams.height == <span class="number">0</span>) &amp;&amp; (heightPercent &lt; <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 如果指定了百分比属性，就用宽高值和百分比去算出具体的宽高</span></div><div class="line">    <span class="keyword">if</span> (widthPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 看到了吗？是根据父`View	`的宽高来乘以百分比，不是根据整个屏幕的宽高，这样可能会有问题，要是ListView这种的高度没法算了</span></div><div class="line">        params.width = (<span class="keyword">int</span>) (widthHint * widthPercent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (heightPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.height = (<span class="keyword">int</span>) (heightHint * heightPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果指定了宽高的比例值，就用比例值去算出宽高，从这里能看出`aspectRatio`的优先级比百分比要高。他可以覆盖百分比之前设置的值。</span></div><div class="line">    <span class="keyword">if</span> (aspectRatio &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (widthNotSet) &#123;</div><div class="line">            params.width = (<span class="keyword">int</span>) (params.height * aspectRatio);</div><div class="line">            <span class="comment">// Keep track that we've filled the width based on the height and aspect ratio.</span></div><div class="line">            mPreservedParams.mIsWidthComputedFromAspectRatio = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (heightNotSet) &#123;</div><div class="line">            params.height = (<span class="keyword">int</span>) (params.width / aspectRatio);</div><div class="line">            <span class="comment">// Keep track that we've filled the height based on the width and aspect ratio.</span></div><div class="line">            mPreservedParams.mIsHeightComputedFromAspectRatio = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"after fillLayoutParams: ("</span> + params.width + <span class="string">", "</span> + params.height + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">```    </div><div class="line"></div><div class="line">到这里`onMeasure`中通过百分比值设置宽高以及`margin`的部分就看完了，那我们接着看一下关于百分比值过小时对`wrap_content`的处理:     </div><div class="line">```<span class="function">java</span></div><div class="line"><span class="title">if</span> <span class="params">(mHelper.handleMeasuredStateTooSmall()</span>) &#123;</div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看一下<code>PercentLayoutHelper.handleMeasuredStateTooSmall()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and checks if any of them would like to get more space than it</div><div class="line"> * received through the percentage dimension.</div><div class="line"> *</div><div class="line"> * If you are building a layout that supports percentage dimensions you are encouraged to take</div><div class="line"> * advantage of this method. The developer should be able to specify that a child should be</div><div class="line"> * remeasured by adding normal dimension attribute with &#123;<span class="doctag">@code</span> wrap_content&#125; value. For example</div><div class="line"> * he might specify child's attributes as &#123;<span class="doctag">@code</span> app:layout_widthPercent="60%p"&#125; and</div><div class="line"> * &#123;<span class="doctag">@code</span> android:layout_width="wrap_content"&#125;. In this case if the child receives too little</div><div class="line"> * space, it will be remeasured with width set to &#123;<span class="doctag">@code</span> WRAP_CONTENT&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> True if the measure phase needs to be rerun because one of the children would like</div><div class="line"> * to receive more space.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMeasuredStateTooSmall</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> needsSecondMeasure = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should handle measured state too small "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// shouldHandleMeasuredWidthTooSmall方法来进行判断</span></div><div class="line">                <span class="keyword">if</span> (shouldHandleMeasuredWidthTooSmall(view, info)) &#123;</div><div class="line">                    needsSecondMeasure = <span class="keyword">true</span>;</div><div class="line">                    params.width = ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (shouldHandleMeasuredHeightTooSmall(view, info)) &#123;</div><div class="line">                    needsSecondMeasure = <span class="keyword">true</span>;</div><div class="line">                    params.height = ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"should trigger second measure pass: "</span> + needsSecondMeasure);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> needsSecondMeasure;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那继续看一下<code>shouldHandleMeasuredWidthTooSmall()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldHandleMeasuredWidthTooSmall</span><span class="params">(View view, PercentLayoutInfo info)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> state = ViewCompat.getMeasuredWidthAndState(view) &amp; ViewCompat.MEASURED_STATE_MASK;</div><div class="line">    <span class="keyword">return</span> state == ViewCompat.MEASURED_STATE_TOO_SMALL &amp;&amp; info.widthPercent &gt;= <span class="number">0</span> &amp;&amp;</div><div class="line">            info.mPreservedParams.width == ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>ViewCompat.getMeasuredWidthAndState()</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMeasuredWidthAndState</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> IMPL.getMeasuredWidthAndState(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续往下看，这个<code>IMPL</code>是什么呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ViewCompatImpl IMPL;</div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> version = android.os.Build.VERSION.SDK_INT;</div><div class="line">    <span class="keyword">if</span> (version &gt;= <span class="number">23</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> MarshmallowViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">21</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> LollipopViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">19</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> KitKatViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">17</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> JbMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">16</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> JBViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">15</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> ICSMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">14</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> ICSViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">11</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> HCViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">9</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> GBViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">7</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> EclairMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> BaseViewCompatImpl();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看，<code>IMPL.getMeasuredWidthAndState()</code>，方法其实最终就是使用的<code>BaseViewCompatImpl.getMeasuredWidthAndState()</code>方法，接着看它的的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMeasuredWidthAndState</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> view.getMeasuredWidth();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>最后就是调用了<code>getMeasuredWidth()</code>方法。  没毛病- -!</p>
<p><code>onMeasure</code>的到这里就分析完了。<br>那接着来看一下<code>onLayout</code>方法,<code>onLayout</code>方法直接调用了<code>PercentLayoutHelper.restoreOriginalParams</code>，:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and restores their original dimensions that were changed for</div><div class="line"> * percentage values. Calling this method only makes sense if you previously called</div><div class="line"> * &#123;<span class="doctag">@link</span> PercentLayoutHelper#adjustChildren(int, int)&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreOriginalParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should restore "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"using "</span> + info);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">                    info.restoreMarginLayoutParams((ViewGroup.MarginLayoutParams) params);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    info.restoreLayoutParams(params);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用了<code>PercentLayoutInfo.restoreMarginLayoutParams()</code>方法，我们看下它的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Restores original dimensions and margins after they were changed for percentage based</div><div class="line"> * values. Calling this method only makes sense if you previously called</div><div class="line"> * &#123;<span class="doctag">@link</span> PercentLayoutHelper.PercentLayoutInfo#fillMarginLayoutParams&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreMarginLayoutParams</span><span class="params">(ViewGroup.MarginLayoutParams params)</span> </span>&#123;</div><div class="line">    restoreLayoutParams(params);</div><div class="line">    <span class="comment">// mPreservedParams的值在之前ad</span></div><div class="line">    params.leftMargin = mPreservedParams.leftMargin;</div><div class="line">    params.topMargin = mPreservedParams.topMargin;</div><div class="line">    params.rightMargin = mPreservedParams.rightMargin;</div><div class="line">    params.bottomMargin = mPreservedParams.bottomMargin;</div><div class="line">    MarginLayoutParamsCompat.setMarginStart(params,</div><div class="line">            MarginLayoutParamsCompat.getMarginStart(mPreservedParams));</div><div class="line">    MarginLayoutParamsCompat.setMarginEnd(params,</div><div class="line">            MarginLayoutParamsCompat.getMarginEnd(mPreservedParams));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>意思是说，再他们被以百分比为基础的数据更改之后恢复成原始的尺寸和margin。<br>然后继续看一下<code>restoreLayoutParams()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Restores original dimensions after they were changed for percentage based values. Calling</div><div class="line">* this method only makes sense if you previously called</div><div class="line">* &#123;<span class="doctag">@link</span> PercentLayoutHelper.PercentLayoutInfo#fillLayoutParams&#125;.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreLayoutParams</span><span class="params">(ViewGroup.LayoutParams params)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mPreservedParams.mIsWidthComputedFromAspectRatio) &#123;</div><div class="line">        <span class="comment">// Only restore the width if we didn't compute it based on the height and</span></div><div class="line">        <span class="comment">// aspect ratio in the fill pass.</span></div><div class="line">        params.width = mPreservedParams.width;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!mPreservedParams.mIsHeightComputedFromAspectRatio) &#123;</div><div class="line">        <span class="comment">// Only restore the height if we didn't compute it based on the width and</span></div><div class="line">        <span class="comment">// aspect ratio in the fill pass.</span></div><div class="line">        params.height = mPreservedParams.height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Reset the tracking flags.</span></div><div class="line">    mPreservedParams.mIsWidthComputedFromAspectRatio = <span class="keyword">false</span>;</div><div class="line">    mPreservedParams.mIsHeightComputedFromAspectRatio = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了到这里也分析完了<code>onLayout</code>的方法，大意就是在<code>onMeasure</code>之前先将原始的宽高和<code>margin</code>都备份一下，然后在<code>onMeasure</code>中根据百分比去设置对应的宽高和<code>margin</code>，等到设置完之后在<code>onLayout</code>方法中再去将这些值恢复到之前备份的起始数据。说实话我没看明白为什么要这样做？</p>
<p>通过上面的代码分析我们知道对布局影响力的优先顺序: <code>app:layout_aspectRatio &gt; app:layout_heightPercent &gt; android:layout_height</code>如果我们同时都设置这三个参数值的话，最终会用<code>app:layout_aspectRatio</code>的值。</p>
<p>遗留问题:     </p>
<ul>
<li>为什么在<code>onLayout</code>方法中去恢复数据，这有什么作用？</li>
<li>看代码在处理如果指定的百分比过小但又指定<code>wrap_content</code>时，会重新根据<code>wrap_content</code>去重新计算的逻辑没有错，但是为什么我在上面测试的时候确没效果？</li>
<li>在上面分析代码时看到<code>fillLayoutParams</code>中是根据父<code>View</code>的宽高来乘以百分比，不是根据整个屏幕的宽高，这样可能会有问题，要是ListView这种的高度没法算了。</li>
</ul>
<hr>
<ul>
<li>邮箱 ：charon.chui@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/屏幕适配之百分比方案详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>