<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/5/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=110 src="//music.163.com/outchain/player?type=0&id=120897804&auto=0&height=90"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-View绘制过程详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/View绘制过程详解/">View绘制过程详解</a>
    </h1>
  

        
        <a href="/2015/01/01/View绘制过程详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="View绘制过程详解"><a href="#View绘制过程详解" class="headerlink" title="View绘制过程详解"></a>View绘制过程详解</h1><p>界面窗口的根布局是<code>DecorView</code>，该类继承自<code>FrameLayout</code>.说到<code>View</code>绘制，想到的就是从这里入手，而<code>FrameLayout</code>继承自<code>ViewGroup</code>。感觉绘制肯定会在<code>ViewGroup</code>或者<code>View</code>中，<br>但是木有找到。发现<code>ViewGroup</code>实现<code>ViewParent</code>接口，而<code>ViewParent</code>有一个实现类是<code>ViewRootImpl</code>， <code>ViewGruop</code>中会使用<code>ViewRootImpl</code>…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The top of a view hierarchy, implementing the needed protocol between View</div><div class="line"> * and the WindowManager.  This is for the most part an internal implementation</div><div class="line"> * detail of &#123;<span class="doctag">@link</span> WindowManagerGlobal&#125;.</div><div class="line"> *</div><div class="line"> * &#123;<span class="doctag">@hide</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"EmptyCatchBlock"</span>, <span class="string">"PointlessBooleanExpression"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></div><div class="line">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">HardwareRenderer</span>.<span class="title">HardwareDrawCallbacks</span> &#123;</div><div class="line">		</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p><code>View</code>的绘制过程从<code>ViewRootImpl.performTraversals()</code>方法开始。<br>首先先说明一下，这部分代码比较多，逻辑也比较麻烦，很容易弄晕，如果感觉看起来费劲，就跳过这一块，直接到下面的Measure、Layout、Draw部分开始看。<br>我也没有全部弄清楚，我只是把里面的步骤标注了下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// ... 此处省略源代码N行</span></div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Measure</span></div><div class="line">	<span class="keyword">if</span> (!mStopped) &#123;</div><div class="line">		<span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</div><div class="line">				(relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</div><div class="line">		<span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</div><div class="line">				|| mHeight != host.getMeasuredHeight() || contentInsetsChanged) &#123;</div><div class="line">			<span class="comment">// 这里是获取widthMeasureSpec,这俩参数不是一般的尺寸数值，而是将模式和尺寸组合在一起的数值.</span></div><div class="line">			<span class="comment">// getRootMeasureSpec方法内部会使用MeasureSpec.makeMeasureSpec()方法来组装一个MeasureSpec，</span></div><div class="line">			<span class="comment">// 当lp.width参数等于MATCH_PARENT的时候，MeasureSpec的specMode就等于EXACTLY，当lp.width等于WRAP_CONTENT的时候，MeasureSpec的specMode就等于AT_MOST。</span></div><div class="line">			<span class="comment">// 并且MATCH_PARENT和WRAP_CONTENT时的specSize都是等于windowSize的，也就意味着根视图总是会充满全屏的。</span></div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG, <span class="string">"Ooops, something changed!  mWidth="</span></div><div class="line">					+ mWidth + <span class="string">" measuredWidth="</span> + host.getMeasuredWidth()</div><div class="line">					+ <span class="string">" mHeight="</span> + mHeight</div><div class="line">					+ <span class="string">" measuredHeight="</span> + host.getMeasuredHeight()</div><div class="line">					+ <span class="string">" coveredInsetsChanged="</span> + contentInsetsChanged);</div><div class="line">			</div><div class="line">			<span class="comment">// 调用PerformMeasure方法。</span></div><div class="line">			 <span class="comment">// Ask host how big it wants to be</span></div><div class="line">			performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">			<span class="comment">// Implementation of weights from WindowManager.LayoutParams</span></div><div class="line">			<span class="comment">// We just grow the dimensions as needed and re-measure if</span></div><div class="line">			<span class="comment">// needs be</span></div><div class="line">			<span class="keyword">int</span> width = host.getMeasuredWidth();</div><div class="line">			<span class="keyword">int</span> height = host.getMeasuredHeight();</div><div class="line">			<span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">				height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">				measureAgain = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (measureAgain) &#123;</div><div class="line">				<span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(TAG,</div><div class="line">						<span class="string">"And hey let's measure once more: width="</span> + width</div><div class="line">						+ <span class="string">" height="</span> + height);</div><div class="line">				performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			layoutRequested = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; !mStopped;</div><div class="line">	<span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</div><div class="line">			|| mAttachInfo.mRecomputeGlobalAttributes;</div><div class="line">	<span class="comment">// 是否需要Layout</span></div><div class="line">	<span class="keyword">if</span> (didLayout) &#123;</div><div class="line">		<span class="comment">// 调用performLayout方法。</span></div><div class="line">		performLayout(lp, desiredWindowWidth, desiredWindowHeight);</div><div class="line"></div><div class="line">		<span class="comment">// By this point all views have been sized and positioned</span></div><div class="line">		<span class="comment">// We can compute the transparent area</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span> ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// start out transparent</span></div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> AVOID THAT CALL BY CACHING THE RESULT?</span></div><div class="line">			host.getLocationInWindow(mTmpLocation);</div><div class="line">			mTransparentRegion.set(mTmpLocation[<span class="number">0</span>], mTmpLocation[<span class="number">1</span>],</div><div class="line">					mTmpLocation[<span class="number">0</span>] + host.mRight - host.mLeft,</div><div class="line">					mTmpLocation[<span class="number">1</span>] + host.mBottom - host.mTop);</div><div class="line"></div><div class="line">			host.gatherTransparentRegion(mTransparentRegion);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</div><div class="line">				mPreviousTransparentRegion.set(mTransparentRegion);</div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				<span class="comment">// reconfigure window manager</span></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</div><div class="line">				&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DBG) &#123;</div><div class="line">			System.out.println(<span class="string">"======================================"</span>);</div><div class="line">			System.out.println(<span class="string">"performTraversals -- after setFrame"</span>);</div><div class="line">			host.debug();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 是否需要Draw</span></div><div class="line">	<span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</div><div class="line">		<span class="keyword">if</span> (!skipDraw || mReportNextDraw) &#123;</div><div class="line">			<span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">					mPendingTransitions.get(i).startChangingAnimations();</div><div class="line">				&#125;</div><div class="line">				mPendingTransitions.clear();</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 调用performDraw方法</span></div><div class="line">			performDraw();</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">if</span> (viewVisibility == View.VISIBLE) &#123;</div><div class="line">			<span class="comment">// Try again</span></div><div class="line">			scheduleTraversals();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</div><div class="line">				mPendingTransitions.get(i).endChangingAnimations();</div><div class="line">			&#125;</div><div class="line">			mPendingTransitions.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mIsInTraversal = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面源码可以看出,<code>performTraversals()</code>方法中会依次做三件事：</p>
<ul>
<li><code>performMeasure()</code>, 内部是<code>mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</code>测量<code>View</code>大小。这里顺便提一下，这个<code>mView</code>是什么？它就是<code>Window</code>最顶成的<code>View(DecorView)</code>,它是<code>FrameLayout</code>的子类。</li>
<li><code>performLayout()</code>, 内部是<code>mView.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</code>视图布局，确定<code>View</code>位置。</li>
<li><code>performDraw()</code>, 内部是<code>draw(fullRedrawNeeded);</code> 绘制界面。</li>
</ul>
<p>至此<code>View</code>绘制的三个过程已经展现：</p>
<h1 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a><code>Measure</code></h1><p><code>performMeasure</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>performMeasure()</code>方法中会调用<code>View.measure()</code>方法， 源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is called to find out how big a view should be. The parent</div><div class="line"> * supplies constraint information in the width and height parameters.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The actual measurement work of a view is performed in</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> oWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> oHeight = insets.top  + insets.bottom;</div><div class="line">		widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</div><div class="line">		heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Suppress sign extension for the low bytes</span></div><div class="line">	<span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</div><div class="line">	<span class="keyword">if</span> (mMeasureCache == <span class="keyword">null</span>) mMeasureCache = <span class="keyword">new</span> LongSparseLongArray(<span class="number">2</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</div><div class="line">			widthMeasureSpec != mOldWidthMeasureSpec ||</div><div class="line">			heightMeasureSpec != mOldHeightMeasureSpec) &#123;</div><div class="line"></div><div class="line">		<span class="comment">// first clears the measured dimension flag</span></div><div class="line">		mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">		resolveRtlPropertiesIfNeeded();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</div><div class="line">				mMeasureCache.indexOfKey(key);</div><div class="line">		<span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</div><div class="line">			<span class="comment">// 调用onMeasure方法</span></div><div class="line">			<span class="comment">// measure ourselves, this should set the measured dimension flag back</span></div><div class="line">			onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">			mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">			<span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></div><div class="line">			setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</div><div class="line">			mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// flag not set, setMeasuredDimension() was not invoked, we raise</span></div><div class="line">		<span class="comment">// an exception to warn the developer</span></div><div class="line">		<span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">			<span class="comment">// 重写onMeausre方法的时，必须调用setMeasuredDimension或者super.onMeasure方法，不然就会走到这里报错。</span></div><div class="line">			<span class="comment">// setMeasuredDimension中回去改变mPrivateFlags的值</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"onMeasure() did not set the"</span></div><div class="line">					+ <span class="string">" measured dimension by calling"</span></div><div class="line">					+ <span class="string">" setMeasuredDimension()"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">	mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">	mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</div><div class="line">			(<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>measure</code>方法中会调用<code>onMeasure</code>方法。<code>ViewGroup</code>的子类会重写该方法来进行测量大小，因为<code>mView</code>是<code>DecorView</code>，<br>而<code>DecorView</code>是<code>FrameLayout</code>的子类。所以我们看一下<code>FrameLayout.onMeasure</code>方法：<br><code>FrameLayout.onMeasure</code>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> measureMatchParentChildren =</div><div class="line">			MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">			MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">	mMatchParentChildren.clear();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="comment">// 调用该方法去测量每个子View</span></div><div class="line">			measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">			maxWidth = Math.max(maxWidth,</div><div class="line">					child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">			maxHeight = Math.max(maxHeight,</div><div class="line">					child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">			childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">			<span class="keyword">if</span> (measureMatchParentChildren) &#123;</div><div class="line">				<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">						lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">					mMatchParentChildren.add(child);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Account for padding too</span></div><div class="line">	maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">	maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	<span class="comment">// Check against our minimum height and width</span></div><div class="line">	maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">	maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">	<span class="comment">// Check against our foreground's minimum height and width</span></div><div class="line">	<span class="keyword">final</span> Drawable drawable = getForeground();</div><div class="line">	<span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</div><div class="line">		maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">		maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">			resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">					childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line"></div><div class="line">	count = mMatchParentChildren.size();</div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = mMatchParentChildren.get(i);</div><div class="line"></div><div class="line">			<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> childWidthMeasureSpec;</div><div class="line">			<span class="keyword">int</span> childHeightMeasureSpec;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredWidth() -</div><div class="line">						getPaddingLeftWithForeground() - getPaddingRightWithForeground() -</div><div class="line">						lp.leftMargin - lp.rightMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">						getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">						lp.leftMargin + lp.rightMargin,</div><div class="line">						lp.width);</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">				childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(getMeasuredHeight() -</div><div class="line">						getPaddingTopWithForeground() - getPaddingBottomWithForeground() -</div><div class="line">						lp.topMargin - lp.bottomMargin,</div><div class="line">						MeasureSpec.EXACTLY);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">						getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">						lp.topMargin + lp.bottomMargin,</div><div class="line">						lp.height);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到内部会调用<code>measureChildWithMargins()</code>方法,该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Ask one of the children of this view to measure itself, taking into</div><div class="line"> * account both the MeasureSpec requirements for this view and its padding</div><div class="line"> * and margins. The child must have MarginLayoutParams The heavy lifting is</div><div class="line"> * done in getChildMeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The child to measure</div><div class="line"> * <span class="doctag">@param</span> parentWidthMeasureSpec The width requirements for this view</div><div class="line"> * <span class="doctag">@param</span> widthUsed Extra space that has been used up by the parent</div><div class="line"> *        horizontally (possibly by other children of the parent)</div><div class="line"> * <span class="doctag">@param</span> parentHeightMeasureSpec The height requirements for this view</div><div class="line"> * <span class="doctag">@param</span> heightUsed Extra space that has been used up by the parent</div><div class="line"> *        vertically (possibly by other children of the parent)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">		<span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">		<span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">	<span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">			mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">					+ widthUsed, lp.width);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">			mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">					+ heightUsed, lp.height);</div><div class="line"></div><div class="line">	child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面就是对该子<code>View</code>调用了<code>measure</code>方法，我们假设这个<code>View</code>已经不是<code>ViewGroup</code>了，就会又和上面一样，又调用<code>onMeasure</code>方法，<br>下面我们直接看一下<code>View.onMeasure()</code>方法：<br><code>View.onMeasure()</code>方法的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line"> * should be overriden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass's responsibility to make</div><div class="line"> * sure the measured height and width are at least the view's minimum height</div><div class="line"> * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line"> * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="comment">// 如果不重写onMeasure方法，默认会调用getDefaultSize获取大小，下面会说getDefaultSize这个方法。</span></div><div class="line">	setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">			getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimension()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;This method must be called by &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to store the</div><div class="line"> * measured width and measured height. Failing to do so will trigger an</div><div class="line"> * exception at measurement time.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">		Insets insets = getOpticalInsets();</div><div class="line">		<span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</div><div class="line">		<span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">		measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">		measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">	&#125;</div><div class="line">	setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setMeasuredDimensionRaw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets the measured dimension without extra processing for things like optical bounds.</div><div class="line"> * Useful for reapplying consistent values that have already been cooked with adjustments</div><div class="line"> * for optical bounds, etc. such as those from the measurement cache.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * <span class="doctag">@param</span> measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">	<span class="comment">// 赋值给mMeasuredWidth，getMeasuredWidth就会调用该值。</span></div><div class="line">	mMeasuredWidth = measuredWidth;</div><div class="line">	mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">	<span class="comment">// 这就是重写onMeasure方法时如果不调用setMeasuredDimension方法时为什么会报错的原因。</span></div><div class="line">	mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们接着看一下上面用到的<code>getDefaultSize()</code>方法，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size Default size for this view</div><div class="line"> * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line"> * <span class="doctag">@return</span> The size this view should be.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> result = size;</div><div class="line">	<span class="comment">// measureSpec值用于获取宽度(高度)的规格和大小，解析出对应的size和mode</span></div><div class="line">	<span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">	<span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (specMode) &#123;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">		result = size;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">	<span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">		result = specSize;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>getDefaultSize</code>方法又会使用到<code>MeasureSpec</code>类，文档中对<code>MeasureSpec</code>是这样介绍的<code>A MeasureSpec is comprised of a size and a mode. There are three possible modes:</code></p>
<ul>
<li>MeasureSpec.EXACTLY The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.<br>  理解成MATCH_PARENT或者在布局中指定了宽高值，如layout:width=’50dp’</li>
<li>MeasureSpec.AT_MOST The child can be as large as it wants up to the specified size.理解成WRAP_CONTENT,这是的值是父View可以允许的最大的值，只要不超过这个值都可以。</li>
<li>MeasureSpec.UNSPECIFIED The parent has not imposed any constraint on the child. It can be whatever size it wants. 这种情况比较少，一般用不到。</li>
</ul>
<p>这里简单总结一下上面的过程:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">performMeasure() &#123;</div><div class="line">	- <span class="number">1</span>.调用View.measure方法</div><div class="line">	mView.measure():</div><div class="line">		- <span class="number">2</span>.measure内部会调用onMeasure方法,但是因为这里mView是DecorView，所以会调用FrameLayout的onMeasure方法。</div><div class="line">	        onMeasure(FrameLayout)</div><div class="line">			- <span class="number">3</span>. 内部设置ViewGroup的宽高</div><div class="line">				setMeasuredDimension</div><div class="line">				并且对每个子View进行遍历测量</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					- <span class="number">4</span>. 对每个子View调用measureChildWithMargins方法</div><div class="line">					measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);	</div><div class="line">					    -<span class="number">5</span>. measureChildWithMargins内部调用子View的measure方法</div><div class="line">					        meausre</div><div class="line">							- <span class="number">6</span>. measure方法内部又调用onMeasure方法</div><div class="line">					            onMeasure(View)</div><div class="line">					            - <span class="number">7</span>. onMeasure方法内部调用setMeasuredDimension</div><div class="line">									setMeasuredDimension</div><div class="line">									- <span class="number">8</span>. setMeasuredDimension内部调用setMeasuredDimensionRaw</div><div class="line">									    setMeasuredDimensionRaw</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码中能看到<code>measure</code>是<code>final</code>的，我们可以重写<code>onMeasure</code>来实现<code>measure</code>过程。<br>到这里基本都讲完了，我们在开发中会按照需要重写<code>onMeasure</code>方法，然后调用<code>setMeasuredDimension</code>方法设置大小，<br>ps:譬如我们设置了<code>setMeasuredDimension(10, 10)</code>,那么不管布局中怎么设置这个<code>View</code>的大小<br>都是没用的，最后显示出来大小都是10*10。</p>
<h1 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a><code>Layout</code></h1><p><code>performLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	mLayoutRequested = <span class="keyword">false</span>;</div><div class="line">	mScrollMayChange = <span class="keyword">true</span>;</div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> View host = mView;</div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_LAYOUT) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Laying out "</span> + host + <span class="string">" to ("</span> +</div><div class="line">				host.getMeasuredWidth() + <span class="string">", "</span> + host.getMeasuredHeight() + <span class="string">")"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"layout"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 把刚才测量的宽高设置进来</span></div><div class="line">		host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">		mInLayout = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">		<span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// requestLayout() was called during layout.</span></div><div class="line">			<span class="comment">// If no layout-request flags are set on the requesting views, there is no problem.</span></div><div class="line">			<span class="comment">// If some requests are still pending, then we need to clear those flags and do</span></div><div class="line">			<span class="comment">// a full request/measure/layout pass to handle this situation.</span></div><div class="line">			ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">					<span class="keyword">false</span>);</div><div class="line">			<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Set this flag to indicate that any further requests are happening during</span></div><div class="line">				<span class="comment">// the second pass, which may result in posting those requests to the next</span></div><div class="line">				<span class="comment">// frame instead</span></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Process fresh layout requests, then measure and layout</span></div><div class="line">				<span class="keyword">int</span> numValidRequests = validLayoutRequesters.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">					<span class="keyword">final</span> View view = validLayoutRequesters.get(i);</div><div class="line">					Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">							<span class="string">" during layout: running second layout pass"</span>);</div><div class="line">					view.requestLayout();</div><div class="line">				&#125;</div><div class="line">				measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">						desiredWindowWidth, desiredWindowHeight);</div><div class="line">				mInLayout = <span class="keyword">true</span>;</div><div class="line">				host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">				mHandlingLayoutInLayoutRequest = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">				<span class="comment">// Check the valid requests again, this time without checking/clearing the</span></div><div class="line">				<span class="comment">// layout flags, since requests happening during the second pass get noop'd</span></div><div class="line">				validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">if</span> (validLayoutRequesters != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">					<span class="comment">// Post second-pass requests to the next frame</span></div><div class="line">					getRunQueue().post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">						<span class="meta">@Override</span></div><div class="line">						<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">							<span class="keyword">int</span> numValidRequests = finalRequesters.size();</div><div class="line">							<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</div><div class="line">								<span class="keyword">final</span> View view = finalRequesters.get(i);</div><div class="line">								Log.w(<span class="string">"View"</span>, <span class="string">"requestLayout() improperly called by "</span> + view +</div><div class="line">										<span class="string">" during second layout pass: posting in next frame"</span>);</div><div class="line">								view.requestLayout();</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>layout()</code>方法，因为<code>host</code>是<code>mView</code>，<code>ViewGroup</code>中重写了<code>layout</code>方法，并调用了<code>super.layout</code>.<br>所以我们直接看<code>View.layout()</code>方法，该方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Assign a size and position to a view and all of its</div><div class="line"> * descendants</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line"> * (The first is measuring). In this phase, each parent calls</div><div class="line"> * layout on all of its children to position them.</div><div class="line"> * This is typically done using the child measurements</div><div class="line"> * that were stored in the measure pass().&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Derived classes should not override this method.</div><div class="line"> * Derived classes with children should override</div><div class="line"> * onLayout. In that method, they should</div><div class="line"> * call layout on each of their children.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> l Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> t Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> r Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> b Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">		onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">		mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> oldL = mLeft;</div><div class="line">	<span class="keyword">int</span> oldT = mTop;</div><div class="line">	<span class="keyword">int</span> oldB = mBottom;</div><div class="line">	<span class="keyword">int</span> oldR = mRight;</div><div class="line"></div><div class="line">	<span class="comment">// 这部分是判断这个View的大小是否已经发生了变化，来判断是否需要重绘。</span></div><div class="line">	<span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">			setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">		<span class="comment">// 内部调用onLayout方法</span></div><div class="line">		onLayout(changed, l, t, r, b);</div><div class="line">		mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">		ListenerInfo li = mListenerInfo;</div><div class="line">		<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">			ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">					(ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">			<span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">				listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">	mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里会调用<code>onLayout</code>方法，同样因为<code>mView</code>是<code>FrameLayout</code>的子类，所以我们要看<code>FrameLayout</code>的<code>onLayout</code>方法，<br>这里我们先看一下<code>ViewGroup.onLayout</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></div><div class="line">		<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b);</div></pre></td></tr></table></figure></p>
<p>是个抽象方法，所以<code>ViewGroup</code>的子类都需要实现该方法。<br>我们看一下<code>FrameLayout.onLayout</code>方法,源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">	layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">							  <span class="keyword">boolean</span> forceLeftGravity) &#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">	mForegroundBoundsChanged = <span class="keyword">true</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">		<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">		<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">			<span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</div><div class="line"></div><div class="line">			<span class="keyword">int</span> childLeft;</div><div class="line">			<span class="keyword">int</span> childTop;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">			<span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</div><div class="line">				gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">					childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</div><div class="line">					lp.leftMargin - lp.rightMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">					<span class="keyword">if</span> (!forceLeftGravity) &#123;</div><div class="line">						childLeft = parentRight - width - lp.rightMargin;</div><div class="line">						<span class="keyword">break</span>;</div><div class="line">					&#125;</div><div class="line">				<span class="keyword">case</span> Gravity.LEFT:</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childLeft = parentLeft + lp.leftMargin;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">				<span class="keyword">case</span> Gravity.TOP:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">					childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">					lp.topMargin - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">					childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">default</span>:</div><div class="line">					childTop = parentTop + lp.topMargin;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//调用子View的layout方法</span></div><div class="line">			child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>View.layout</code>方法，又会调用到<code>View.onLayout</code>方法，我们假设这个子<code>View</code>不是<code>ViewGroup</code>.<br>看一下<code>View.onLayout</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called from layout when this view should</div><div class="line"> * assign a size and position to each of its children.</div><div class="line"> *</div><div class="line"> * Derived classes with children should override</div><div class="line"> * this method and call layout on each of</div><div class="line"> * their children.</div><div class="line"> * <span class="doctag">@param</span> changed This is a new size or position for this view</div><div class="line"> * <span class="doctag">@param</span> left Left position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> top Top position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> right Right position, relative to parent</div><div class="line"> * <span class="doctag">@param</span> bottom Bottom position, relative to parent</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是一个空方法，这是因为<code>Layout</code>需要<code>ViewGroup</code>来控制进行。      </p>
<p>这里也总结一下<code>layout</code>的过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">		<span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">	- <span class="number">1</span>. host.layout</div><div class="line">	host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">		-<span class="number">2</span>. layout方法会分别调用setFrame()和onLayout()方法</div><div class="line">			setFrame()</div><div class="line">			onLayout()</div><div class="line">			-<span class="number">3</span>. 因为host是mView也就是DecorView也就是FrameLayout的子类。FrameLayout的onLayout方法如下</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">					<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">					<span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">					    -<span class="number">4</span>. 遍历每个子View，并分别调用layout方法。</div><div class="line">						child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Draw"><a href="#Draw" class="headerlink" title="Draw"></a><code>Draw</code></h1><p>绘制阶段是从<code>ViewRootImpl</code>中的<code>performDraw</code>方法开始的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">	mFullRedrawNeeded = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mIsDrawing = <span class="keyword">true</span>;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"draw"</span>);</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 开始draw了</span></div><div class="line">		draw(fullRedrawNeeded);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		mIsDrawing = <span class="keyword">false</span>;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// For whatever reason we didn't create a HardwareRenderer, end any</span></div><div class="line">	<span class="comment">// hardware animations that are now dangling</span></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mPendingAnimatingRenderNodes != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mAttachInfo.mPendingAnimatingRenderNodes.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</div><div class="line">		&#125;</div><div class="line">		mAttachInfo.mPendingAnimatingRenderNodes.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mReportNextDraw) &#123;</div><div class="line">		mReportNextDraw = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span>) &#123;</div><div class="line">			mAttachInfo.mHardwareRenderer.fence();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"FINISHED DRAWING: "</span> + mWindowAttributes.getTitle());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span> &amp;&amp; mSurface.isValid()) &#123;</div><div class="line">			mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">			SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</div><div class="line">			<span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">for</span> (SurfaceHolder.Callback c : callbacks) &#123;</div><div class="line">					<span class="keyword">if</span> (c <span class="keyword">instanceof</span> SurfaceHolder.Callback2) &#123;</div><div class="line">						((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(</div><div class="line">								mSurfaceHolder);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			mWindowSession.finishDrawing(mWindow);</div><div class="line">		&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部会调用<code>draw</code>方法，<code>draw</code>方法源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</div><div class="line">	Surface surface = mSurface;</div><div class="line">	<span class="keyword">if</span> (!surface.isValid()) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_FPS) &#123;</div><div class="line">		trackFPS();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!sFirstDrawComplete) &#123;</div><div class="line">		<span class="keyword">synchronized</span> (sFirstDrawHandlers) &#123;</div><div class="line">			sFirstDrawComplete = <span class="keyword">true</span>;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = sFirstDrawHandlers.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; count; i++) &#123;</div><div class="line">				mHandler.post(sFirstDrawHandlers.get(i));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	scrollToRectOrFocus(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mAttachInfo.mViewScrollChanged) &#123;</div><div class="line">		mAttachInfo.mViewScrollChanged = <span class="keyword">false</span>;</div><div class="line">		mAttachInfo.mTreeObserver.dispatchOnScrollChanged();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> animating = mScroller != <span class="keyword">null</span> &amp;&amp; mScroller.computeScrollOffset();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> curScrollY;</div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		curScrollY = mScroller.getCurrY();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		curScrollY = mScrollY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mCurScrollY != curScrollY) &#123;</div><div class="line">		mCurScrollY = curScrollY;</div><div class="line">		fullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> appScale = mAttachInfo.mApplicationScale;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> scalingRequired = mAttachInfo.mScalingRequired;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> resizeAlpha = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mResizeBuffer != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">long</span> deltaTime = SystemClock.uptimeMillis() - mResizeBufferStartTime;</div><div class="line">		<span class="keyword">if</span> (deltaTime &lt; mResizeBufferDuration) &#123;</div><div class="line">			<span class="keyword">float</span> amt = deltaTime/(<span class="keyword">float</span>) mResizeBufferDuration;</div><div class="line">			amt = mResizeInterpolator.getInterpolation(amt);</div><div class="line">			animating = <span class="keyword">true</span>;</div><div class="line">			resizeAlpha = <span class="number">255</span> - (<span class="keyword">int</span>)(amt*<span class="number">255</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect dirty = mDirty;</div><div class="line">	<span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// The app owns the surface, we won't draw.</span></div><div class="line">		dirty.setEmpty();</div><div class="line">		<span class="keyword">if</span> (animating) &#123;</div><div class="line">			<span class="keyword">if</span> (mScroller != <span class="keyword">null</span>) &#123;</div><div class="line">				mScroller.abortAnimation();</div><div class="line">			&#125;</div><div class="line">			disposeResizeBuffer();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (fullRedrawNeeded) &#123;</div><div class="line">		mAttachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		dirty.set(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">int</span>) (mWidth * appScale + <span class="number">0.5f</span>), (<span class="keyword">int</span>) (mHeight * appScale + <span class="number">0.5f</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">		Log.v(TAG, <span class="string">"Draw "</span> + mView + <span class="string">"/"</span></div><div class="line">				+ mWindowAttributes.getTitle()</div><div class="line">				+ <span class="string">": dirty=&#123;"</span> + dirty.left + <span class="string">","</span> + dirty.top</div><div class="line">				+ <span class="string">","</span> + dirty.right + <span class="string">","</span> + dirty.bottom + <span class="string">"&#125; surface="</span></div><div class="line">				+ surface + <span class="string">" surface.isValid()="</span> + surface.isValid() + <span class="string">", appScale:"</span> +</div><div class="line">				appScale + <span class="string">", width="</span> + mWidth + <span class="string">", height="</span> + mHeight);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mAttachInfo.mTreeObserver.dispatchOnDraw();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> xOffset = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> yOffset = curScrollY;</div><div class="line">	<span class="keyword">final</span> WindowManager.LayoutParams params = mWindowAttributes;</div><div class="line">	<span class="keyword">final</span> Rect surfaceInsets = params != <span class="keyword">null</span> ? params.surfaceInsets : <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (surfaceInsets != <span class="keyword">null</span>) &#123;</div><div class="line">		xOffset -= surfaceInsets.left;</div><div class="line">		yOffset -= surfaceInsets.top;</div><div class="line"></div><div class="line">		<span class="comment">// Offset dirty rect for surface insets.</span></div><div class="line">		dirty.offset(surfaceInsets.left, surfaceInsets.right);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating) &#123;</div><div class="line">		<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</div><div class="line">			<span class="comment">// Draw with hardware renderer.</span></div><div class="line">			mIsAnimating = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">boolean</span> invalidateRoot = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</div><div class="line">				mHardwareYOffset = yOffset;</div><div class="line">				mHardwareXOffset = xOffset;</div><div class="line">				mAttachInfo.mHardwareRenderer.invalidateRoot();</div><div class="line">			&#125;</div><div class="line">			mResizeAlpha = resizeAlpha;</div><div class="line"></div><div class="line">			dirty.setEmpty();</div><div class="line"></div><div class="line">			mBlockResizeBuffer = <span class="keyword">false</span>;</div><div class="line">			mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// If we get here with a disabled &amp; requested hardware renderer, something went</span></div><div class="line">			<span class="comment">// wrong (an invalidate posted right before we destroyed the hardware surface</span></div><div class="line">			<span class="comment">// for instance) so we should just bail out. Locking the surface with software</span></div><div class="line">			<span class="comment">// rendering at this point would lock it forever and prevent hardware renderer</span></div><div class="line">			<span class="comment">// from doing its job when it comes back.</span></div><div class="line">			<span class="comment">// Before we request a new frame we must however attempt to reinitiliaze the</span></div><div class="line">			<span class="comment">// hardware renderer if it's in requested state. This would happen after an</span></div><div class="line">			<span class="comment">// eglTerminate() for instance.</span></div><div class="line">			<span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="keyword">null</span> &amp;&amp;</div><div class="line">					!mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</div><div class="line">					mAttachInfo.mHardwareRenderer.isRequested()) &#123;</div><div class="line"></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					mAttachInfo.mHardwareRenderer.initializeIfNeeded(</div><div class="line">							mWidth, mHeight, mSurface, surfaceInsets);</div><div class="line">				&#125; <span class="keyword">catch</span> (OutOfResourcesException e) &#123;</div><div class="line">					handleOutOfResourcesException(e);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">				scheduleTraversals();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="comment">// draw的部分在这里。。。内部会用canvas去画</span></div><div class="line">			<span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (animating) &#123;</div><div class="line">		mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">		scheduleTraversals();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>drawSoftware</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@return</span> true if drawing was successful, false if an error occurred</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></div><div class="line">		<span class="keyword">boolean</span> scalingRequired, Rect dirty) &#123;</div><div class="line"></div><div class="line">	<span class="comment">// Draw with software renderer.</span></div><div class="line">	<span class="keyword">final</span> Canvas canvas;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> left = dirty.left;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> top = dirty.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> right = dirty.right;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> bottom = dirty.bottom;</div><div class="line"></div><div class="line">		canvas = mSurface.lockCanvas(dirty);</div><div class="line"></div><div class="line">		<span class="comment">// The dirty rectangle can be modified by Surface.lockCanvas()</span></div><div class="line">		<span class="comment">//noinspection ConstantConditions</span></div><div class="line">		<span class="keyword">if</span> (left != dirty.left || top != dirty.top || right != dirty.right</div><div class="line">				|| bottom != dirty.bottom) &#123;</div><div class="line">			attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> Do this in native</span></div><div class="line">		canvas.setDensity(mDensity);</div><div class="line">	&#125; <span class="keyword">catch</span> (Surface.OutOfResourcesException e) &#123;</div><div class="line">		handleOutOfResourcesException(e);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">		Log.e(TAG, <span class="string">"Could not lock surface"</span>, e);</div><div class="line">		<span class="comment">// Don't assume this is due to out of memory, it could be</span></div><div class="line">		<span class="comment">// something else, and if it is something else then we could</span></div><div class="line">		<span class="comment">// kill stuff (or ourself) for no reason.</span></div><div class="line">		mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" drawing to bitmap w="</span></div><div class="line">					+ canvas.getWidth() + <span class="string">", h="</span> + canvas.getHeight());</div><div class="line">			<span class="comment">//canvas.drawARGB(255, 255, 0, 0);</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// If this bitmap's format includes an alpha channel, we</span></div><div class="line">		<span class="comment">// need to clear it before drawing so that the child will</span></div><div class="line">		<span class="comment">// properly re-composite its drawing on a transparent</span></div><div class="line">		<span class="comment">// background. This automatically respects the clip/dirty region</span></div><div class="line">		<span class="comment">// or</span></div><div class="line">		<span class="comment">// If we are applying an offset, we need to clear the area</span></div><div class="line">		<span class="comment">// where the offset doesn't appear to avoid having garbage</span></div><div class="line">		<span class="comment">// left in the blank areas.</span></div><div class="line">		<span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</div><div class="line">			canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		dirty.setEmpty();</div><div class="line">		mIsAnimating = <span class="keyword">false</span>;</div><div class="line">		attachInfo.mDrawingTime = SystemClock.uptimeMillis();</div><div class="line">		mView.mPrivateFlags |= View.PFLAG_DRAWN;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (DEBUG_DRAW) &#123;</div><div class="line">			Context cxt = mView.getContext();</div><div class="line">			Log.i(TAG, <span class="string">"Drawing: package:"</span> + cxt.getPackageName() +</div><div class="line">					<span class="string">", metrics="</span> + cxt.getResources().getDisplayMetrics() +</div><div class="line">					<span class="string">", compatibilityInfo="</span> + cxt.getResources().getCompatibilityInfo());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			canvas.translate(-xoff, -yoff);</div><div class="line">			<span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</div><div class="line">				mTranslator.translateCanvas(canvas);</div><div class="line">			&#125;</div><div class="line">			canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</div><div class="line">			attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			</div><div class="line">			<span class="comment">// 内部会去调用View.draw()；</span></div><div class="line">			mView.draw(canvas);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">if</span> (!attachInfo.mSetIgnoreDirtyState) &#123;</div><div class="line">				<span class="comment">// Only clear the flag if it was not set during the mView.draw() call</span></div><div class="line">				attachInfo.mIgnoreDirtyState = <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			surface.unlockCanvasAndPost(canvas);</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">			Log.e(TAG, <span class="string">"Could not unlock surface"</span>, e);</div><div class="line">			mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></div><div class="line">			<span class="comment">//noinspection ReturnInsideFinallyBlock</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOCAL_LOGV) &#123;</div><div class="line">			Log.v(TAG, <span class="string">"Surface "</span> + surface + <span class="string">" unlockCanvasAndPost"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码中调用了<code>mView.draw()</code>方法，所以我们看一下<code>FrameLayout.draw()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.draw(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mForeground != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> Drawable foreground = mForeground;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mForegroundBoundsChanged) &#123;</div><div class="line">			mForegroundBoundsChanged = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">final</span> Rect selfBounds = mSelfBounds;</div><div class="line">			<span class="keyword">final</span> Rect overlayBounds = mOverlayBounds;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> w = mRight-mLeft;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> h = mBottom-mTop;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mForegroundInPadding) &#123;</div><div class="line">				selfBounds.set(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				selfBounds.set(mPaddingLeft, mPaddingTop, w - mPaddingRight, h - mPaddingBottom);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">			Gravity.apply(mForegroundGravity, foreground.getIntrinsicWidth(),</div><div class="line">					foreground.getIntrinsicHeight(), selfBounds, overlayBounds,</div><div class="line">					layoutDirection);</div><div class="line">			foreground.setBounds(overlayBounds);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		foreground.draw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>内部调用了<code>super.draw()</code>，而<code>ViewGroup</code>没有重写该方法，所以直接看<code>View</code>的<code>draw()</code>方法.<br><code>View.draw()</code>方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Manually render this view (and all of its children) to the given Canvas.</div><div class="line"> * The view must have already done a full layout before this function is</div><div class="line"> * called.  When implementing a view, implement</div><div class="line"> * &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line"> * If you do need to override this method, call the superclass version.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The Canvas to which the View is rendered.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">			(mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">	mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">	<span class="comment">// 这里注释说的很明白了，draw的6个步骤。</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Draw traversal performs several drawing steps which must be executed</div><div class="line">	 * in the appropriate order:</div><div class="line">	 *</div><div class="line">	 *      1. Draw the background</div><div class="line">	 *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">	 *      3. Draw view's content, 调用onDraw方法绘制自身</div><div class="line">	 *      4. Draw children, 调用dispatchDraw方法绘制子View</div><div class="line">	 *      5. If necessary, draw the fading edges and restore layers</div><div class="line">	 *      6. Draw decorations (scrollbars for instance)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">	<span class="keyword">int</span> saveCount;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">		drawBackground(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">	<span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">		<span class="comment">// Step 3, draw the content</span></div><div class="line">		<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 4, draw the children</span></div><div class="line">		dispatchDraw(canvas);</div><div class="line"></div><div class="line">		<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">		onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">			mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// we're done...</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Here we do the full fledged routine...</div><div class="line">	 * (this is an uncommon case where speed matters less,</div><div class="line">	 * this is why we repeat some of the tests that have been</div><div class="line">	 * done above)</div><div class="line">	 */</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> drawTop = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawBottom = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawLeft = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">boolean</span> drawRight = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> topFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> bottomFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> leftFadeStrength = <span class="number">0.0f</span>;</div><div class="line">	<span class="keyword">float</span> rightFadeStrength = <span class="number">0.0f</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Step 2, save the canvas' layers</span></div><div class="line">	<span class="keyword">int</span> paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> offsetRequired = isPaddingOffsetRequired();</div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		paddingLeft += getLeftPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> left = mScrollX + paddingLeft;</div><div class="line">	<span class="keyword">int</span> right = left + mRight - mLeft - mPaddingRight - paddingLeft;</div><div class="line">	<span class="keyword">int</span> top = mScrollY + getFadeTop(offsetRequired);</div><div class="line">	<span class="keyword">int</span> bottom = top + getFadeHeight(offsetRequired);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (offsetRequired) &#123;</div><div class="line">		right += getRightPaddingOffset();</div><div class="line">		bottom += getBottomPaddingOffset();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ScrollabilityCache scrollabilityCache = mScrollCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">float</span> fadeHeight = scrollabilityCache.fadingEdgeLength;</div><div class="line">	<span class="keyword">int</span> length = (<span class="keyword">int</span>) fadeHeight;</div><div class="line"></div><div class="line">	<span class="comment">// clip the fade length if top and bottom fades overlap</span></div><div class="line">	<span class="comment">// overlapping fades produce odd-looking artifacts</span></div><div class="line">	<span class="keyword">if</span> (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) &#123;</div><div class="line">		length = (bottom - top) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// also clip horizontal fades if necessary</span></div><div class="line">	<span class="keyword">if</span> (horizontalEdges &amp;&amp; (left + length &gt; right - length)) &#123;</div><div class="line">		length = (right - left) / <span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (verticalEdges) &#123;</div><div class="line">		topFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getTopFadingEdgeStrength()));</div><div class="line">		drawTop = topFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		bottomFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getBottomFadingEdgeStrength()));</div><div class="line">		drawBottom = bottomFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (horizontalEdges) &#123;</div><div class="line">		leftFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getLeftFadingEdgeStrength()));</div><div class="line">		drawLeft = leftFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">		rightFadeStrength = Math.max(<span class="number">0.0f</span>, Math.min(<span class="number">1.0f</span>, getRightFadingEdgeStrength()));</div><div class="line">		drawRight = rightFadeStrength * fadeHeight &gt; <span class="number">1.0f</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	saveCount = canvas.getSaveCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> solidColor = getSolidColor();</div><div class="line">	<span class="keyword">if</span> (solidColor == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">			canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">			canvas.saveLayer(left, bottom - length, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">			canvas.saveLayer(left, top, left + length, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">			canvas.saveLayer(right - length, top, right, bottom, <span class="keyword">null</span>, flags);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		scrollabilityCache.setFadeColor(solidColor);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Step 3, draw the content</span></div><div class="line">	<span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 4, draw the children</span></div><div class="line">	dispatchDraw(canvas);</div><div class="line"></div><div class="line">	<span class="comment">// Step 5, draw the fade effect and restore layers</span></div><div class="line">	<span class="keyword">final</span> Paint p = scrollabilityCache.paint;</div><div class="line">	<span class="keyword">final</span> Matrix matrix = scrollabilityCache.matrix;</div><div class="line">	<span class="keyword">final</span> Shader fade = scrollabilityCache.shader;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawTop) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, right, top + length, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawBottom) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * bottomFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">180</span>);</div><div class="line">		matrix.postTranslate(left, bottom);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, bottom - length, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawLeft) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * leftFadeStrength);</div><div class="line">		matrix.postRotate(-<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(left, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(left, top, left + length, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (drawRight) &#123;</div><div class="line">		matrix.setScale(<span class="number">1</span>, fadeHeight * rightFadeStrength);</div><div class="line">		matrix.postRotate(<span class="number">90</span>);</div><div class="line">		matrix.postTranslate(right, top);</div><div class="line">		fade.setLocalMatrix(matrix);</div><div class="line">		p.setShader(fade);</div><div class="line">		canvas.drawRect(right - length, top, right, bottom, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	canvas.restoreToCount(saveCount);</div><div class="line"></div><div class="line">	<span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">	onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">		mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面会调用<code>onDraw</code>和<code>dispatchDraw</code>方法。<br>我们先看一下<code>View.onDraw</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Implement this to do your drawing.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas the canvas on which the background will be drawn</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是空方法，这是也很好理解，因为每个<code>View</code>的展现都不一样，例如<code>TextView</code>、<code>ProgressBar</code>等，<br>所以<code>View</code>不会去实现<code>onDraw</code>方法，具体是要子类去根据自己的显示要求实现该方法。</p>
<p>再看一下<code>dispatchDraw</code>方法，这个方法是用来绘制子<code>View</code>的，所以要看<code>ViewGroup.dispatchDraw</code>方法，<code>View.dispatchDraw</code>是空的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">int</span> flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_RUN_ANIMATION) != <span class="number">0</span> &amp;&amp; canAnimate()) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> cache = (mGroupFlags &amp; FLAG_ANIMATION_CACHE) == FLAG_ANIMATION_CACHE;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> buildCache = !isHardwareAccelerated();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = children[i];</div><div class="line">			<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</div><div class="line">				<span class="keyword">final</span> LayoutParams params = child.getLayoutParams();</div><div class="line">				attachLayoutAnimationParameters(child, params, i, childrenCount);</div><div class="line">				bindLayoutAnimation(child);</div><div class="line">				<span class="keyword">if</span> (cache) &#123;</div><div class="line">					child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">					<span class="keyword">if</span> (buildCache) &#123;</div><div class="line">						child.buildDrawingCache(<span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LayoutAnimationController controller = mLayoutAnimationController;</div><div class="line">		<span class="keyword">if</span> (controller.willOverlap()) &#123;</div><div class="line">			mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		controller.start();</div><div class="line"></div><div class="line">		mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;</div><div class="line">		mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (cache) &#123;</div><div class="line">			mGroupFlags |= FLAG_CHILDREN_DRAWN_WITH_CACHE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAnimationListener != <span class="keyword">null</span>) &#123;</div><div class="line">			mAnimationListener.onAnimationStart(controller.getAnimation());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> clipSaveCount = <span class="number">0</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		clipSaveCount = canvas.save();</div><div class="line">		canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</div><div class="line">				mScrollX + mRight - mLeft - mPaddingRight,</div><div class="line">				mScrollY + mBottom - mTop - mPaddingBottom);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// We will draw our child's animation, let's reset the flag</span></div><div class="line">	mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</div><div class="line">	mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</div><div class="line"></div><div class="line">	<span class="keyword">boolean</span> more = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">long</span> drawingTime = getDrawingTime();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertReorderBarrier();</div><div class="line">	<span class="comment">// Only use the preordered list if not HW accelerated, since the HW pipeline will do the</span></div><div class="line">	<span class="comment">// draw reordering internally</span></div><div class="line">	<span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</div><div class="line">			? <span class="keyword">null</span> : buildOrderedChildList();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">			&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">		<span class="keyword">int</span> childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">		<span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">				? children[childIndex] : preorderedList.get(childIndex);</div><div class="line">		<span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 调用drawChild方法</span></div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line"></div><div class="line">	<span class="comment">// Draw any disappearing views that have animations</span></div><div class="line">	<span class="keyword">if</span> (mDisappearingChildren != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> disappearingCount = disappearingChildren.size() - <span class="number">1</span>;</div><div class="line">		<span class="comment">// Go backwards -- we may delete as animations finish</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = disappearingCount; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = disappearingChildren.get(i);</div><div class="line">			more |= drawChild(canvas, child, drawingTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (usingRenderNodeProperties) canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (debugDraw()) &#123;</div><div class="line">		onDebugDraw(canvas);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (clipToPadding) &#123;</div><div class="line">		canvas.restoreToCount(clipSaveCount);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// mGroupFlags might have been updated by drawChild()</span></div><div class="line">	flags = mGroupFlags;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) &#123;</div><div class="line">		invalidate(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((flags &amp; FLAG_ANIMATION_DONE) == <span class="number">0</span> &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == <span class="number">0</span> &amp;&amp;</div><div class="line">			mLayoutAnimationController.isDone() &amp;&amp; !more) &#123;</div><div class="line">		<span class="comment">// We want to erase the drawing cache and notify the listener after the</span></div><div class="line">		<span class="comment">// next frame is drawn because one extra invalidate() is caused by</span></div><div class="line">		<span class="comment">// drawChild() after the animation is over</span></div><div class="line">		mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;</div><div class="line">		<span class="keyword">final</span> Runnable end = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">		   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			   notifyAnimationListener();</div><div class="line">		   &#125;</div><div class="line">		&#125;;</div><div class="line">		post(end);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到上面的方法中会调用<code>drawChild</code>方法，该方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Draw one child of this View Group. This method is responsible for getting</div><div class="line"> * the canvas in the right state. This includes clipping, translating so</div><div class="line"> * that the child's scrolled origin is at 0, 0, and applying any animation</div><div class="line"> * transformations.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> canvas The canvas on which to draw the child</div><div class="line"> * <span class="doctag">@param</span> child Who to draw</div><div class="line"> * <span class="doctag">@param</span> drawingTime The time at which draw is occurring</div><div class="line"> * <span class="doctag">@return</span> True if an invalidate() was issued</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里也简单总结一下<code>draw</code>的过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. ViewRootImpl.performDraw()</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 2. ViewRootImpl.draw()</span></div><div class="line">	draw(fullRedrawNeeded);	</div><div class="line">		<span class="comment">// 3. ViewRootImpl.drawSoftware</span></div><div class="line">		drawSoftware</div><div class="line">			<span class="comment">// 4. 内部调用mView.draw,也就是FrameLayout.draw(). </span></div><div class="line">			mView.draw()(FrameLayout)</div><div class="line">				<span class="comment">// 5. FrameLayout.draw方法内部会调用super.draw方法，也就是View.draw方法.</span></div><div class="line">				<span class="keyword">super</span>.draw(canvas);</div><div class="line">					<span class="comment">// 6. View.draw方法内部会分别调用onDraw绘制自己以及dispatchDraw绘制子View.</span></div><div class="line">					onDraw</div><div class="line">					<span class="comment">// 绘制子View</span></div><div class="line">					dispatchDraw</div><div class="line">						<span class="comment">// 7. dispatchDraw方法内部会遍历所有子View.</span></div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</div><div class="line">							<span class="comment">// 8. 对每个子View分别调用drawChild方法</span></div><div class="line">							drawChild()</div><div class="line">								<span class="comment">// 9. drawChild方法内部会对该子View调用draw方法，进行绘制。然后draw又会调用onDraw等，循环就开始了。 </span></div><div class="line">									child.draw()</div><div class="line">						&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后补充一个小问题： <code>getWidth()</code>与<code>getMeasuredWidth()</code>有什么区别呢？<br>一般情况下这两个的值是相同的，<code>getMeasureWidth()</code>方法在<code>measure()</code>过程结束后就可以获取到了，而<code>getWidth()</code>方法要在<code>layout()</code>过程结束后才能获取到。<br>而且<code>getMeasureWidth()</code>的值是通过<code>setMeasuredDimension()</code>设置的，但是<code>getWidth()</code>的值是通过视图右边的坐标减去左边的坐标计算出来的。如果我们在<code>layout</code>的时候将宽高<br>不传<code>getMeasureWidth</code>的值，那么这时候<code>getWidth()</code>与<code>getMeasuredWidth</code>的值就不会再相同了，当然一般也不会这么干…</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/View绘制过程详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-如何让Service常驻内存" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/如何让Service常驻内存/">如何让Service常驻内存</a>
    </h1>
  

        
        <a href="/2015/01/01/如何让Service常驻内存/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="如何让Service常驻内存"><a href="#如何让Service常驻内存" class="headerlink" title="如何让Service常驻内存"></a>如何让Service常驻内存</h1><p>我非常鄙视这种行文，一个公司应该想到如何把产品做的更完善，而不是用这些技术来损害用户的利益，来获取自己肮脏的所谓的功能。</p>
<ul>
<li>Service设置成START_STICKY，kill 后会被重启（等待5秒左右），重传Intent，保持与重启前一样</li>
<li>​通过 startForeground将进程设置为前台进程，做前台服务，优先级和前台应用一个级别​，除非在系统内存非常缺，否则此进程不会被 kill</li>
<li>双进程Service：让2个进程互相保护，其中一个Service被清理后，另外没被清理的进程可以立即重启进程</li>
<li>QQ黑科技:在应用退到后台后，另起一个只有 1 像素的页面停留在桌面上，让自己保持前台状态，保护自己不被后台清理工具杀死</li>
<li>在已经root的设备下，修改相应的权限文件，将App伪装成系统级的应用（Android4.0系列的一个漏洞，已经确认可行）</li>
<li><p>Android系统中当前进程(Process)fork出来的子进程，被系统认为是两个不同的进程。当父进程被杀死的时候，子进程仍然可以存活，并不受影响。<br>  鉴于目前提到的在Android-Service层做双守护都会失败，我们可以fork出c进程，多进程守护。死循环在那检查是否还存在，<br>  具体的思路如下（Android5.0以下可行）</p>
<ul>
<li>用C编写守护进程(即子进程)，守护进程做的事情就是循环检查目标进程是否存在，不存在则启动它。</li>
<li>在NDK环境中将1中编写的C代码编译打包成可执行文件(BUILD_EXECUTABLE)。</li>
<li>主进程启动时将守护进程放入私有目录下，赋予可执行权限，启动它即可。</li>
</ul>
</li>
<li><p>联系厂商，加入白名单</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/如何让Service常驻内存/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-butterknife源码详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/butterknife源码详解/">butterknife源码详解</a>
    </h1>
  

        
        <a href="/2015/01/01/butterknife源码详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="butterknife源码详解"><a href="#butterknife源码详解" class="headerlink" title="butterknife源码详解"></a>butterknife源码详解</h1><p>作为<code>Android</code>开发者，大家肯定都知道大名鼎鼎的<a href="https://github.com/JakeWharton/butterknife">butterknife</a>。它大大的提高了开发效率，虽然在很早之前就开始使用它了，但是只知道是通过注解的方式实现的，却一直没有仔细的学习下大牛的代码。最近在学习运行时注解，决定今天来系统的分析下<code>butterknife</code>的实现原理。    </p>
<p>如果你之前不了解<code>Annotation</code>，那强烈建议你先看<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a>.</p>
<p>废多看图:  </p>
<p><img src="https://github.com/CharonChui/Pictures/blob/master/butterknife_sample.png?raw=true" alt="image"></p>
<p>从图中可以很直观的看出它的<code>module</code>结构，以及使用示例代码。</p>
<p>它的目录和我们在<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a>这篇文章中介绍的一样，大体也是分为三个部分:   </p>
<ul>
<li>app : butterknife</li>
<li>api : butterknife-annotations</li>
<li>compiler : butterknife-compiler</li>
</ul>
<p>通过示例代码我们大体能预料到对应的功能实现:    </p>
<ul>
<li><p><code>@BindView(R2.id.hello) Button hello;</code><br>  <code>BindView</code>注解的作用就是通过<code>value</code>指定的值然后去调用<code>findViewById()</code>来找到对应的控件，然后将该控件赋值给使用该注解的变量。 </p>
</li>
<li><p><code>@OnClick(R2.id.hello) void sayHello() {...}</code><br>  <code>OnClick</code>注解也是通过指定的<code>id</code>来找到对应控件后，然后对其设置<code>onClickListener</code>并调用使用该注解的方法。   </p>
</li>
<li><p>最后不要忘了<code>ButterKnife.bind(this);</code>该方法也是后面我们要分析的突破点。 </p>
</li>
</ul>
<p>当然<code>Butterknife</code>的功能是非常强大的，我们在这里只是用这两个简单的例子来进行分析说明。    </p>
<p>那我们就来查看<code>BindView</code>和<code>Onclik</code>注解的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(CLASS) <span class="meta">@Target</span>(FIELD)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</div><div class="line">  <span class="comment">/** View ID to which the field will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>作用在变量上的编译时注解。对该注解的值<code>value()</code>使用<code>android.support.annotation</code>中的<code>IdRes</code>注解，来表明该值只能是资源类型的<code>id</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(METHOD)</div><div class="line"><span class="meta">@Retention</span>(CLASS)</div><div class="line"><span class="meta">@ListenerClass</span>(</div><div class="line">    targetType = <span class="string">"android.view.View"</span>,</div><div class="line">    setter = <span class="string">"setOnClickListener"</span>,</div><div class="line">    type = <span class="string">"butterknife.internal.DebouncingOnClickListener"</span>,</div><div class="line">    method = <span class="meta">@ListenerMethod</span>(</div><div class="line">        name = <span class="string">"doClick"</span>,</div><div class="line">        parameters = <span class="string">"android.view.View"</span></div><div class="line">    )</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</div><div class="line">  <span class="comment">/** View IDs to which the method will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作用到方法上的编译时注解。我们发现该<code>注解还使用了</code>ListenerClass<code>注解，当然从上面的声明中可以很容易看出它的作用。   
那我们就继续简单的看一下</code>ListenerClass`注解的实现:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RUNTIME) <span class="meta">@Target</span>(ANNOTATION_TYPE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListenerClass &#123;</div><div class="line">  <span class="function">String <span class="title">targetType</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Name of the setter method on the &#123;<span class="doctag">@linkplain</span> #targetType() target type&#125; for the listener. */</span></div><div class="line">  <span class="function">String <span class="title">setter</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Name of the method on the &#123;<span class="doctag">@linkplain</span> #targetType() target type&#125; to remove the listener. If</div><div class="line">   * empty &#123;<span class="doctag">@link</span> #setter()&#125; will be used by default.</div><div class="line">   */</div><div class="line">  <span class="function">String <span class="title">remover</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Fully-qualified class name of the listener type. */</span></div><div class="line">  <span class="function">String <span class="title">type</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/** Enum which declares the listener callback methods. Mutually exclusive to &#123;<span class="doctag">@link</span> #method()&#125;. */</span></div><div class="line">  Class&lt;? extends Enum&lt;?&gt;&gt; callbacks() <span class="keyword">default</span> NONE.class;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Method data for single-method listener callbacks. Mutually exclusive with &#123;<span class="doctag">@link</span> #callbacks()&#125;</div><div class="line">   * and an error to specify more than one value.</div><div class="line">   */</div><div class="line">  ListenerMethod[] method() <span class="keyword">default</span> &#123; &#125;;</div><div class="line"></div><div class="line">  <span class="comment">/** Default value for &#123;<span class="doctag">@link</span> #callbacks()&#125;. */</span></div><div class="line">  <span class="keyword">enum</span> NONE &#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作用到注解类型的运行时注解。 </p>
<p>有了之前<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a>这篇文章的基础，我们知道对于编译时注解肯定是要通过自定义<code>AbstractProcessor</code>来解析的，所以接下来我们要去<code>butterknife-compiler module</code>中找一下对应的类。通过名字我们就能很简单的找到:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> butterknife.compiler;</div><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过<code>AutoService</code>注解我们很容易看出来<code>Butterknife</code>也使用了<code>Google Auto</code>。当然它肯定也都用了<code>javaopet</code>和<code>android-apt</code>，这里我们就不去分析了。<br>其他的一些方法我们就不继续看了，我们接下来看一下具体的核心处理方法，也就是<code>ButterKnifeProcessor.process()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</div><div class="line">    <span class="comment">// 查找、解析出所有的注解</span></div><div class="line">    Map&lt;TypeElement, BindingClass&gt; targetClassMap = findAndParseTargets(env);</div><div class="line">    <span class="comment">// 将注解后要生成的相关代码信息保存到BindingClass类中</span></div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</div><div class="line">      TypeElement typeElement = entry.getKey();</div><div class="line">      BindingClass bindingClass = entry.getValue();</div><div class="line">      <span class="comment">// 输出生成的类</span></div><div class="line">      <span class="keyword">for</span> (JavaFile javaFile : bindingClass.brewJava()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          javaFile.writeTo(filer);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">          error(typeElement, <span class="string">"Unable to write view binder for type %s: %s"</span>, typeElement,</div><div class="line">              e.getMessage());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>从<code>process()</code>方法来看，我们需要主要分析两个部分:   </p>
<ul>
<li><code>findAndParseTargets()</code>：查找、解析所有的注解</li>
<li><code>bindingClass.brewJava()</code>：生成代码</li>
</ul>
<p>#####第一步:<code>findAndParseTargets()</code>  </p>
<p>先查看<code>findAndParseTargets()</code>方法的实现,里面解析的类型比较多，我们就以<code>BindView</code>为例进行说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingClass&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">    Map&lt;TypeElement, BindingClass&gt; targetClassMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">    scanForRClasses(env);</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindArray element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceArray(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindArray.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBitmap element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBitmap.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBitmap(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBitmap.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBool element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBool.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBool(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBool.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindColor element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindColor.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceColor(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindColor.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDimen element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDimen.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDimen(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDimen.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDrawable element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDrawable.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDrawable(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDrawable.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindInt element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindInt.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceInt(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindInt.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindString element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindString.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceString(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindString.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindView element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">      <span class="comment">// 检查一下合法性</span></div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 进行解析 </span></div><div class="line">        parseBindView(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindView.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindViews element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindViews.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseBindViews(element, targetClassMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindViews.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each annotation that corresponds to a listener.</span></div><div class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</div><div class="line">      findAndParseListener(env, listener, targetClassMap, erasedTargetNames);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Try to find a parent binder for each.</span></div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</div><div class="line">      TypeElement parentType = findParentType(entry.getKey(), erasedTargetNames);</div><div class="line">      <span class="keyword">if</span> (parentType != <span class="keyword">null</span>) &#123;</div><div class="line">        BindingClass bindingClass = entry.getValue();</div><div class="line">        BindingClass parentBindingClass = targetClassMap.get(parentType);</div><div class="line">        bindingClass.setParent(parentBindingClass);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> targetClassMap;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>parseBindView()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingClass&gt; targetClassMap,</span></span></div><div class="line">      Set&lt;TypeElement&gt; erasedTargetNames) &#123;</div><div class="line">    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</div><div class="line"></div><div class="line">    <span class="comment">// Start by verifying common generated code restrictions.</span></div><div class="line">    <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</div><div class="line">        || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">    <span class="comment">// Verify that the target type extends from View.</span></div><div class="line">    TypeMirror elementType = element.asType();</div><div class="line">    <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">      TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">      elementType = typeVariable.getUpperBound();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 必须是View类型或者接口</span></div><div class="line">    <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;</div><div class="line">      error(element, <span class="string">"@%s fields must extend from View or be an interface. (%s.%s)"</span>,</div><div class="line">          BindView.class.getSimpleName(), enclosingElement.getQualifiedName(),</div><div class="line">          element.getSimpleName());</div><div class="line">      hasError = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasError) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 通过注解的value拿到id</span></div><div class="line">    <span class="comment">// Assemble information on the field.</span></div><div class="line">    <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();</div><div class="line"></div><div class="line">    BindingClass bindingClass = targetClassMap.get(enclosingElement);</div><div class="line">    <span class="keyword">if</span> (bindingClass != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">// 之前已经绑定过该id</span></div><div class="line">      ViewBindings viewBindings = bindingClass.getViewBinding(getId(id));</div><div class="line">      <span class="keyword">if</span> (viewBindings != <span class="keyword">null</span> &amp;&amp; viewBindings.getFieldBinding() != <span class="keyword">null</span>) &#123;</div><div class="line">        FieldViewBinding existingBinding = viewBindings.getFieldBinding();</div><div class="line">        error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>,</div><div class="line">            BindView.class.getSimpleName(), id, existingBinding.getName(),</div><div class="line">            enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 没有绑定过该id的话就去生成代码</span></div><div class="line">      bindingClass = getOrCreateTargetClass(targetClassMap, enclosingElement);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String name = element.getSimpleName().toString();</div><div class="line">    TypeName type = TypeName.get(elementType);</div><div class="line">    <span class="keyword">boolean</span> required = isFieldRequired(element);</div><div class="line"></div><div class="line">    FieldViewBinding binding = <span class="keyword">new</span> FieldViewBinding(name, type, required);</div><div class="line">    <span class="comment">// 用BindingClass添加代码</span></div><div class="line">    bindingClass.addField(getId(id), binding);</div><div class="line"></div><div class="line">    <span class="comment">// Add the type-erased version to the valid binding targets set.</span></div><div class="line">    erasedTargetNames.add(enclosingElement);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>终于进入生成代码的阶段了，继续看一下<code>getOrCreateTargetClass()</code>的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> BindingClass <span class="title">getOrCreateTargetClass</span><span class="params">(Map&lt;TypeElement, BindingClass&gt; targetClassMap,</span></span></div><div class="line">      TypeElement enclosingElement) &#123;</div><div class="line">    BindingClass bindingClass = targetClassMap.get(enclosingElement);</div><div class="line">    <span class="keyword">if</span> (bindingClass == <span class="keyword">null</span>) &#123;</div><div class="line">      TypeName targetType = TypeName.get(enclosingElement.asType());</div><div class="line">      <span class="keyword">if</span> (targetType <span class="keyword">instanceof</span> ParameterizedTypeName) &#123;</div><div class="line">        targetType = ((ParameterizedTypeName) targetType).rawType;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 得到包名、类名</span></div><div class="line">      String packageName = getPackageName(enclosingElement);</div><div class="line">      String className = getClassName(enclosingElement, packageName);</div><div class="line">      <span class="comment">// 用包名、类名和_ViewBinder等拼接成要生成的类的全名，这里会有两个类:$$_ViewBinder和$$_ViewBinding</span></div><div class="line">      ClassName binderClassName = ClassName.get(packageName, className + <span class="string">"_ViewBinder"</span>);</div><div class="line">      ClassName unbinderClassName = ClassName.get(packageName, className + <span class="string">"_ViewBinding"</span>);</div><div class="line"></div><div class="line">      <span class="keyword">boolean</span> isFinal = enclosingElement.getModifiers().contains(Modifier.FINAL);</div><div class="line">      <span class="comment">// 将要生成的类名,$$_ViewBinder和$$_ViewBinding封装给BindingClass类</span></div><div class="line">      bindingClass = <span class="keyword">new</span> BindingClass(targetType, binderClassName, unbinderClassName, isFinal);</div><div class="line">      targetClassMap.put(enclosingElement, bindingClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> bindingClass;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>BindingClass.addField()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addField</span><span class="params">(Id id, FieldViewBinding binding)</span> </span>&#123;</div><div class="line">    getOrCreateViewBindings(id).setFieldBinding(binding);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>getOrCreateViewBindings()</code>以及<code>setFieldBinding()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ViewBindings <span class="title">getOrCreateViewBindings</span><span class="params">(Id id)</span> </span>&#123;</div><div class="line">    ViewBindings viewId = viewIdMap.get(id);</div><div class="line">    <span class="keyword">if</span> (viewId == <span class="keyword">null</span>) &#123;</div><div class="line">      viewId = <span class="keyword">new</span> ViewBindings(id);</div><div class="line">      viewIdMap.put(id, viewId);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> viewId;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>然后看<code>ViewBindings.setFieldBinding()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldBinding</span><span class="params">(FieldViewBinding fieldBinding)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fieldBinding != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.fieldBinding = fieldBinding;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看到这里就把<code>findAndParseTargets()</code>方法分析完了。大体总结一下就是把一些变量、参数等初始化到了<code>BindingClass</code>类中。<br>也就是说上面<code>process()</code>方法中的第一步已经分析完了，下面我们来继续看第二部分.</p>
<p>#####第二步:<code>bindingClass.brewJava()</code>  </p>
<p>继续查看<code>BindingClass.brewJava()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">Collection&lt;JavaFile&gt; <span class="title">brewJava</span><span class="params">()</span> </span>&#123;</div><div class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(binderClassName)</div><div class="line">        .addModifiers(PUBLIC, FINAL)</div><div class="line">        .addSuperinterface(ParameterizedTypeName.get(VIEW_BINDER, targetTypeName));</div><div class="line"></div><div class="line">    result.addMethod(createBindMethod(targetTypeName));</div><div class="line"></div><div class="line">    List&lt;JavaFile&gt; files = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">if</span> (isGeneratingUnbinder()) &#123;</div><div class="line">      <span class="comment">// 生成$$_ViewBinding类</span></div><div class="line">      files.add(JavaFile.builder(unbinderClassName.packageName(), createUnbinderClass())</div><div class="line">          .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</div><div class="line">          .build()</div><div class="line">      );</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isFinal) &#123;</div><div class="line">      result.addMethod(createBindToTargetMethod());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 生成$$_ViewBinder类</span></div><div class="line">    files.add(JavaFile.builder(binderClassName.packageName(), result.build())</div><div class="line">        .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</div><div class="line">        .build());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> files;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看到这里感觉不用再继续分析了，该方法就是使用<code>javaopet</code>来生成对应<code>$$_ViewBinder.java</code>类。 </p>
<p>到这里我们已经知道在编译的过程中会去生成一个对应的<code>$$_ViewBinder.java</code>文件，该类实现了<code>ViewBinder</code>接口。它内部会去生成对应<code>findViewByid()</code>以及<code>setOnClickListener()</code>等方法的代码，它生成了该类后如何去调用呢？我们也没有发现<code>new $$_ViewBinder</code>的方法。不要忘了上面我们看到的<code>ButterKnife.bind(this);</code>。接下来我们看一下<code>ButterKnife.bind(this);</code>方法的实现:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> Activity&#125;. The current content</div><div class="line">   * view is used as the view root.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> target Target activity for view binding.</div><div class="line">   */</div><div class="line">  <span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getViewBinder(target).bind(Finder.ACTIVITY, target, target);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> View&#125;. The view and its children</div><div class="line">   * are used as the view root.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> target Target view for view binding.</div><div class="line">   */</div><div class="line">  <span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull View target)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getViewBinder(target).bind(Finder.VIEW, target, target);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>调用了<code>getViewBinder()</code>的<code>bind()</code>方法，继续看<code>getViewBinder()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ViewBinder&lt;Object&gt;&gt; BINDERS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">...</div><div class="line"></div><div class="line"><span class="meta">@NonNull</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">static</span> ViewBinder&lt;Object&gt; <span class="title">getViewBinder</span><span class="params">(@NonNull Object target)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up view binder for "</span> + targetClass.getName());</div><div class="line">    <span class="keyword">return</span> findViewBinderForClass(targetClass);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@NonNull</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ViewBinder&lt;Object&gt; <span class="title">findViewBinderForClass</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</div><div class="line">     <span class="comment">// BINDERS是一个Map集合。也就是说它内部使用Map缓存了一下，先去内存中取</span></div><div class="line">     ViewBinder&lt;Object&gt; viewBinder = BINDERS.get(cls);</div><div class="line">    <span class="keyword">if</span> (viewBinder != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Cached in view binder map."</span>);</div><div class="line">      <span class="keyword">return</span> viewBinder;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 内存中没有缓存该类</span></div><div class="line">    String clsName = cls.getName();</div><div class="line">    <span class="comment">// 通过类名判断下是不是系统的组件</span></div><div class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</div><div class="line">      <span class="keyword">return</span> NOP_VIEW_BINDER;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// 通过反射获取到对应通过编译时注解生成的$_ViewBinder类的实例</span></div><div class="line">      Class&lt;?&gt; viewBindingClass = Class.forName(clsName + <span class="string">"_ViewBinder"</span>);</div><div class="line">      <span class="comment">//noinspection unchecked</span></div><div class="line">      viewBinder = (ViewBinder&lt;Object&gt;) viewBindingClass.newInstance();</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Loaded view binder class."</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</div><div class="line">      viewBinder = findViewBinderForClass(cls.getSuperclass());</div><div class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create view binder for "</span> + clsName, e);</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create view binder for "</span> + clsName, e);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 通过反射来操作毕竟会影响性能，所以这里通过Map缓存的方式来进行优化</span></div><div class="line">    BINDERS.put(cls, viewBinder);</div><div class="line">    <span class="keyword">return</span> viewBinder;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>到这里就彻底分析完了<code>ButterKnife.bind(this);</code>的实现，它其实就相当于<code>new</code>了一个<code>$_ViewBinder</code>类的实例。当然这样用起来是非常方便的，毕竟我们手动的去<code>new</code>类多不合理，虽然他里面用到了反射会影响一点点性能，但是他通过内存缓存的方式优化了，我感觉这种方式是利大于弊的。   </p>
<p>那<code>$_ViewBinder</code>类里面都是什么内容呢？ 我们去看一下该类的代码，但是它生成的代码在哪里呢？<br><img src="https://github.com/CharonChui/Pictures/blob/master/butterknife_apt_genierate_code.png?raw=true" alt="image"></p>
<p>开始看一下<code>SimpleActivity_ViewBinder.bind()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinder</span> <span class="keyword">implements</span> <span class="title">ViewBinder</span>&lt;<span class="title">SimpleActivity</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Unbinder <span class="title">bind</span><span class="params">(Finder finder, SimpleActivity target, Object source)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleActivity_ViewBinding&lt;&gt;(target, finder, source);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看<code>SimpleActivity_ViewBinding</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinding</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> T target;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968578;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968579;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SimpleActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> T target, Finder finder, Object source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    target.title = finder.findRequiredViewAsType(source, R.id.title, <span class="string">"field 'title'"</span>, TextView.class);</div><div class="line">    target.subtitle = finder.findRequiredViewAsType(source, R.id.subtitle, <span class="string">"field 'subtitle'"</span>, TextView.class);</div><div class="line">    view = finder.findRequiredView(source, R.id.hello, <span class="string">"field 'hello', method 'sayHello', and method 'sayGetOffMe'"</span>);</div><div class="line">    target.hello = finder.castView(view, R.id.hello, <span class="string">"field 'hello'"</span>, Button.class);</div><div class="line">    view2130968578 = view;</div><div class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        target.sayHello();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> target.sayGetOffMe();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view = finder.findRequiredView(source, R.id.list_of_things, <span class="string">"field 'listOfThings' and method 'onItemClick'"</span>);</div><div class="line">    target.listOfThings = finder.castView(view, R.id.list_of_things, <span class="string">"field 'listOfThings'"</span>, ListView.class);</div><div class="line">    view2130968579 = view;</div><div class="line">    ((AdapterView&lt;?&gt;) view).setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</div><div class="line">        target.onItemClick(p2);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    target.footer = finder.findRequiredViewAsType(source, R.id.footer, <span class="string">"field 'footer'"</span>, TextView.class);</div><div class="line">    target.headerViews = Utils.listOf(</div><div class="line">        finder.findRequiredView(source, R.id.title, <span class="string">"field 'headerViews'"</span>), </div><div class="line">        finder.findRequiredView(source, R.id.subtitle, <span class="string">"field 'headerViews'"</span>), </div><div class="line">        finder.findRequiredView(source, R.id.hello, <span class="string">"field 'headerViews'"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</div><div class="line">    T target = <span class="keyword">this</span>.target;</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</div><div class="line"></div><div class="line">    target.title = <span class="keyword">null</span>;</div><div class="line">    target.subtitle = <span class="keyword">null</span>;</div><div class="line">    target.hello = <span class="keyword">null</span>;</div><div class="line">    target.listOfThings = <span class="keyword">null</span>;</div><div class="line">    target.footer = <span class="keyword">null</span>;</div><div class="line">    target.headerViews = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    view2130968578.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578.setOnLongClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578 = <span class="keyword">null</span>;</div><div class="line">    ((AdapterView&lt;?&gt;) view2130968579).setOnItemClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968579 = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到他内部会通过<code>findViewByid()</code>等来找到对应的<code>View</code>，然后将其赋值给<code>target.xxxx</code>，所以这样就相当于把所有的控件以及事件都给初始化了，以后就可以直接使用了，通过这里也可以看到我们在使用注解的时候不要把控件或者方法声明为<code>private</code>的。   </p>
<p>总结一下:      </p>
<ul>
<li><code>ButterKnifeProcessor</code>会生成<code>$$_ViewBinder</code>类并实现了<code>ViewBinder</code>接口。</li>
<li><code>$$_ViewBinder</code>类中包含了所有对应的代码，会通过注解去解析到<code>id</code>等，然后通过<code>findViewById()</code>等方法找到对应的控件，并且复制给调用该方法的来中的变量。这样就等同于我们直接<br> 使用<code>View v = findViewByid(R.id.xx)</code>来进行初始化控件。  </li>
<li><p>上面虽然生成了<code>$$_ViewBinder</code>类，但是如何去调用呢？ 就是在调用<code>ButterKnife.bind(this)</code>时执行，该方法会通过反射去实例化对应的<code>$$_ViewBinder</code>类，并且调用该类的<code>bind()</code>方法。 </p>
</li>
<li><p><code>Butterknife</code>除了在<code>Butterknife.bind()</code>方法中使用反射之外，其他注解的处理都是通过编译时注解使用，所以不会影响效率。    </p>
</li>
<li>使用<code>Butterknife</code>是不要将变量声明为<code>private</code>类型，因为<code>$$_ViewBinder</code>类中会去直接调用变量赋值，如果声明为<code>private</code>将无法赋值。     <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindView</span>(R2.id.title) TextView title;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/butterknife源码详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Volley源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Volley源码分析/">Volley简介</a>
    </h1>
  

        
        <a href="/2015/01/01/Volley源码分析/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Volley源码分析"><a href="#Volley源码分析" class="headerlink" title="Volley源码分析"></a>Volley源码分析</h2><ul>
<li><p>Volley简介    </p>
<p>  <a href="https://android.googlesource.com/platform/frameworks/volley" target="_blank" rel="external">volley官方地址</a><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/volley.png?raw=true" alt="image">                   </p>
<p>  在<code>Google I/0 2013</code>中发布了<code>Volley</code>.<code>Volley</code>是<code>Android</code>平台上的网络通信库，能使网络通信更快，更简单，更健壮。</p>
<p>  这是<code>Volley</code>名称的由来:<code>a burst or emission of many things or a large amount at once</code>.<code>Volley</code>特别适合数据量不大但是通信频繁的场景。   </p>
<p>  <code>Github</code>上面已经有大神做了镜像，使用<code>Gradle</code>更方便。<a href="https://github.com/mcxiaoke/android-volley">Volley On Github</a>            </p>
</li>
<li><p>Volley使用<br>  <code>Volley</code>的使用非常方便。</p>
<ul>
<li>首先就是要构建一个<code>RequestQueue</code>的请求队列，它可以缓存所有<code>Http</code>请求，内部处理的非常完善，通常我们整个应用只需要一个<code>RequestQueue</code>对象即可。</li>
<li>创建<code>StringRequest</code>对象，并且传入相应的请求地址以及添加请求成功和失败的回调方法。这一步的意思就是创建一个新的网络请求。</li>
<li><p>将刚才新创建的<code>StringRequest</code>对象加入到<code>RequestQueue</code>队列中。这样就相当于会去执行该请求。等到执行成功后就可以在<code>StringRequest</code>中设置的回调方法里面获取到相应的结果。<br>总结一下，其实挺像我们浏览器的操作，第一步打开浏览器，第二步输入<code>URL</code>地址第三步按回车去执行。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtil</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HttpUtil instance;</div><div class="line">    <span class="keyword">private</span> RequestQueue mQueue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpUtil</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mQueue = Volley.newRequestQueue(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> HttpUtil <span class="title">getInstance</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">            instance = <span class="keyword">new</span> HttpUtil(context.getApplicationContext());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Request <span class="title">sendGetRequest</span><span class="params">(String url, <span class="keyword">final</span> HttpListener listener)</span> </span>&#123;</div><div class="line">        StringRequest stringRequest = <span class="keyword">new</span> StringRequest(url, <span class="keyword">new</span> Response.Listener&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onResponse(response);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="keyword">new</span> Response.ErrorListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onErrorResponse(error);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mQueue.add(stringRequest);</div><div class="line">        <span class="keyword">return</span> stringRequest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Request <span class="title">sendPostRequest</span><span class="params">(String url, <span class="keyword">final</span> Map&lt;String, String&gt; map, <span class="keyword">final</span> HttpListener listener)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> StringRequest stringRequest = <span class="keyword">new</span> StringRequest(Request.Method.POST, url, <span class="keyword">new</span> Response.Listener&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onResponse(response);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="keyword">new</span> Response.ErrorListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">                    listener.onErrorResponse(error);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Map&lt;String, String&gt; <span class="title">getParams</span><span class="params">()</span> <span class="keyword">throws</span> AuthFailureError </span>&#123;</div><div class="line">                <span class="keyword">return</span> map;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        mQueue.add(stringRequest);</div><div class="line">        <span class="keyword">return</span> stringRequest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Response listener of HttpUtil.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpListener</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response)</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>到这里我们就简单的介绍了它的使用，当然还有一些其他的<code>Request</code>对象例如<code>JsonRequest</code>等，他们的使用方法都是一样的，这里就不再说明了。当然<code>Volley</code>里面还提供了对图片的处理，例如<code>NetworkImageView</code>空间和<code>ImageRequest</code>等，因为这里图片用到的不太多，所以暂时不去分析了。</p>
<p>接下来我们就从源码的角度去分析一下：<br>这里我们都知道使用的时候最新要初始化一个<code>RequestQueue</code>所以，我们首先看一下<code>Volley.newRequestQueue</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Volley</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** Default on-disk cache directory. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CACHE_DIR = <span class="string">"volley"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     * You may set a maximum size of the disk cache in bytes.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@param</span> stack An &#123;<span class="doctag">@link</span> HttpStack&#125; to use for the network, or null for default.</div><div class="line">     * <span class="doctag">@param</span> maxDiskCacheBytes the maximum size of the disk cache, in bytes. Use -1 for default size.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, HttpStack stack, <span class="keyword">int</span> maxDiskCacheBytes)</span> </span>&#123;</div><div class="line">        File cacheDir = <span class="keyword">new</span> File(context.getCacheDir(), DEFAULT_CACHE_DIR);</div><div class="line"></div><div class="line">        String userAgent = <span class="string">"volley/0"</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String packageName = context.getPackageName();</div><div class="line">            PackageInfo info = context.getPackageManager().getPackageInfo(packageName, <span class="number">0</span>);</div><div class="line">            <span class="comment">// 使用包名和versionCode作为userAgent</span></div><div class="line">            userAgent = packageName + <span class="string">"/"</span> + info.versionCode;</div><div class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (stack == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">9</span>) &#123;</div><div class="line">                <span class="comment">// 在9及以上Volleys使用HttpURLConnection，9一下使用HttpClient。这里是有原因的，因为在9之前HttpURLConnection有Bug。</span></div><div class="line">                <span class="comment">// 那HttpClient那么好为什么不一直使用它，要在9及以后使用HttpURLConnection呢？这里也是有原因的。从9开始HttpURLConnection</span></div><div class="line">                <span class="comment">// 将自动添加`Accept-Encoding:gzip`头字段到`request`请求中，并做相应处理，一般我们请求都是字符串，所以压缩可以使数据大小大幅降低。</span></div><div class="line">                <span class="comment">// 但是这也会带来问题的，之前开发中就遇到过。因为启用了压缩，所以`Content-Lenght`字段返回的是压缩后的大小。使用`getContentLength()`</span></div><div class="line">                <span class="comment">// 方法去分配解压缩后数据大小是错误的。应该从response中读取字节直到`InputStream.read()`返回-1为止。当时我们在开发下载时就遇到过这个</span></div><div class="line">                <span class="comment">// 问题，在下载视频时没有问题，但是在下载小说的时候就会发现`content-length`返回值不对。</span></div><div class="line">                <span class="comment">// 总结一下就是在9之前HttpClient的bug更少，而HttpURLConnection存在严重的Bug。但是从9开始HttpURLConnection更小巧，API更简单，压缩以及</span></div><div class="line">                <span class="comment">// response cache的使用减少了网络流量，提高了网络速度，也就更省电，所以更适合在Android中使用</span></div><div class="line">                stack = <span class="keyword">new</span> HurlStack();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Prior to Gingerbread, HttpUrlConnection was unreliable.</span></div><div class="line">                <span class="comment">// See: http://android-developers.blogspot.com/2011/09/androids-http-clients.html</span></div><div class="line">                stack = <span class="keyword">new</span> HttpClientStack(AndroidHttpClient.newInstance(userAgent));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 创建BasicNetwork对象，下面会介绍BasicNetwork(HttpStack)方法的内部实现</span></div><div class="line">        Network network = <span class="keyword">new</span> BasicNetwork(stack);</div><div class="line">        </div><div class="line">        RequestQueue queue;</div><div class="line">        <span class="keyword">if</span> (maxDiskCacheBytes &lt;= -<span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">                <span class="comment">// 如果不指定大小的话，默认大小为5M</span></div><div class="line">            <span class="comment">// No maximum size specified</span></div><div class="line">        	queue = <span class="keyword">new</span> RequestQueue(<span class="keyword">new</span> DiskBasedCache(cacheDir), network);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">        	<span class="comment">// Disk cache size specified</span></div><div class="line">        	queue = <span class="keyword">new</span> RequestQueue(<span class="keyword">new</span> DiskBasedCache(cacheDir, maxDiskCacheBytes), network);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        queue.start();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> queue;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     * You may set a maximum size of the disk cache in bytes.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@param</span> maxDiskCacheBytes the maximum size of the disk cache, in bytes. Use -1 for default size.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, <span class="keyword">int</span> maxDiskCacheBytes)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> newRequestQueue(context, <span class="keyword">null</span>, maxDiskCacheBytes);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@param</span> stack An &#123;<span class="doctag">@link</span> HttpStack&#125; to use for the network, or null for default.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, HttpStack stack)</span></span></div><div class="line">    &#123;</div><div class="line">    	<span class="keyword">return</span> newRequestQueue(context, stack, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a default instance of the worker pool and calls &#123;<span class="doctag">@link</span> RequestQueue#start()&#125; on it.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context A &#123;<span class="doctag">@link</span> Context&#125; to use for creating the cache dir.</div><div class="line">     * <span class="doctag">@return</span> A started &#123;<span class="doctag">@link</span> RequestQueue&#125; instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> newRequestQueue(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着来看一上上面提到的new BasicNetwork(HttpStack)方法的实现,可以看到他内部的缓存大小是4k<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_POOL_SIZE = <span class="number">4096</span>;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HttpStack mHttpStack;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ByteArrayPool mPool;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@param</span> httpStack HTTP stack to be used</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasicNetwork</span><span class="params">(HttpStack httpStack)</span> </span>&#123;</div><div class="line">    <span class="comment">// If a pool isn't passed in, then build a small default pool that will give us a lot of</span></div><div class="line">    <span class="comment">// benefit and not use too much memory.</span></div><div class="line">    <span class="keyword">this</span>(httpStack, <span class="keyword">new</span> ByteArrayPool(DEFAULT_POOL_SIZE));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@param</span> httpStack HTTP stack to be used</div><div class="line"> * <span class="doctag">@param</span> pool a buffer pool that improves GC performance in copy operations</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasicNetwork</span><span class="params">(HttpStack httpStack, ByteArrayPool pool)</span> </span>&#123;</div><div class="line">    mHttpStack = httpStack;</div><div class="line">    mPool = pool;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着我们还要分析一下<code>RequestQueue</code>的构造方法以及<code>start()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A request dispatch queue with a thread pool of dispatchers.</div><div class="line"> *</div><div class="line"> * Calling &#123;<span class="doctag">@link</span> #add(Request)&#125; will enqueue the given Request for dispatch,</div><div class="line"> * resolving from either cache or network on a worker thread, and then delivering</div><div class="line"> * a parsed response on the main thread.</div><div class="line"> */<span class="comment">/**</span></div><div class="line"> * A request dispatch queue with a thread pool of dispatchers.</div><div class="line"> *</div><div class="line"> * Calling &#123;<span class="doctag">@link</span> #add(Request)&#125; will enqueue the given Request for dispatch,</div><div class="line"> * resolving from either cache or network on a worker thread, and then delivering</div><div class="line"> * a parsed response on the main thread.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** Used for generating monotonically-increasing sequence numbers for requests. */</span></div><div class="line">    <span class="keyword">private</span> AtomicInteger mSequenceGenerator = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Staging area for requests that already have a duplicate request in flight.</div><div class="line">     *</div><div class="line">     * &lt;ul&gt;</div><div class="line">     *     &lt;li&gt;containsKey(cacheKey) indicates that there is a request in flight for the given cache</div><div class="line">     *          key.&lt;/li&gt;</div><div class="line">     *     &lt;li&gt;get(cacheKey) returns waiting requests for the given cache key. The in flight request</div><div class="line">     *          is &lt;em&gt;not&lt;/em&gt; contained in that list. Is null if no requests are staged.&lt;/li&gt;</div><div class="line">     * &lt;/ul&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Queue&lt;Request&lt;?&gt;&gt;&gt; mWaitingRequests =</div><div class="line">            <span class="keyword">new</span> HashMap&lt;String, Queue&lt;Request&lt;?&gt;&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The set of all requests currently being processed by this RequestQueue. A Request</div><div class="line">     * will be in this set if it is waiting in any queue or currently being processed by</div><div class="line">     * any dispatcher.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Request&lt;?&gt;&gt; mCurrentRequests = <span class="keyword">new</span> HashSet&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">	<span class="comment">// cache队列</span></div><div class="line">    <span class="comment">/** The cache triage queue. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt; mCacheQueue =</div><div class="line">        <span class="keyword">new</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">	<span class="comment">// 网络请求队列</span></div><div class="line">    <span class="comment">/** The queue of requests that are actually going out to the network. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt; mNetworkQueue =</div><div class="line">        <span class="keyword">new</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/** Number of network request dispatcher threads to start. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_NETWORK_THREAD_POOL_SIZE = <span class="number">4</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Cache interface for retrieving and storing responses. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line"></div><div class="line">    <span class="comment">/** Network interface for performing requests. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Network mNetwork;</div><div class="line"></div><div class="line">    <span class="comment">/** Response delivery mechanism. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line"></div><div class="line">    <span class="comment">/** The network dispatchers. */</span></div><div class="line">    <span class="keyword">private</span> NetworkDispatcher[] mDispatchers;</div><div class="line"></div><div class="line">    <span class="comment">/** The cache dispatcher. */</span></div><div class="line">    <span class="keyword">private</span> CacheDispatcher mCacheDispatcher;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</div><div class="line">     * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</div><div class="line">     * <span class="doctag">@param</span> threadPoolSize Number of network dispatcher threads to create</div><div class="line">     * <span class="doctag">@param</span> delivery A ResponseDelivery interface for posting responses and errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network, <span class="keyword">int</span> threadPoolSize,</span></span></div><div class="line">            ResponseDelivery delivery) &#123;</div><div class="line">        mCache = cache;</div><div class="line">        mNetwork = network;</div><div class="line">        mDispatchers = <span class="keyword">new</span> NetworkDispatcher[threadPoolSize];</div><div class="line">        mDelivery = delivery;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</div><div class="line">     * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</div><div class="line">     * <span class="doctag">@param</span> threadPoolSize Number of network dispatcher threads to create</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network, <span class="keyword">int</span> threadPoolSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(cache, network, threadPoolSize,</div><div class="line">                <span class="keyword">new</span> ExecutorDelivery(<span class="keyword">new</span> Handler(Looper.getMainLooper())));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates the worker pool. Processing will not begin until &#123;<span class="doctag">@link</span> #start()&#125; is called.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cache A Cache to use for persisting responses to disk</div><div class="line">     * <span class="doctag">@param</span> network A Network interface for performing HTTP requests</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestQueue</span><span class="params">(Cache cache, Network network)</span> </span>&#123;</div><div class="line">        <span class="comment">// 默认大小为4</span></div><div class="line">        <span class="keyword">this</span>(cache, network, DEFAULT_NETWORK_THREAD_POOL_SIZE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Starts the dispatchers in this queue.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        stop();  <span class="comment">// Make sure any currently running dispatchers are stopped.</span></div><div class="line">        <span class="comment">// Create the cache dispatcher and start it.</span></div><div class="line">        <span class="comment">// 初始化RequestQueue之后就会调用start方法，内部会开启CacheDispatcher,也是Thread的子类，后面再看里面具体的run方法</span></div><div class="line">        mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(mCacheQueue, mNetworkQueue, mCache, mDelivery);</div><div class="line">        mCacheDispatcher.start();</div><div class="line"></div><div class="line">        <span class="comment">// Create network dispatchers (and corresponding threads) up to the pool size.</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</div><div class="line">            <span class="comment">// 创建4个(默认是4个)NetworkDispatcher一直去执行, NetworkDispatcher是Thread的子类，他会不断的去从mNetworkQueue中取出Requet并用</span></div><div class="line">            <span class="comment">// 并用mNetwork去执行，执行完成后再使用mDelivery去分发相应的结果</span></div><div class="line">            NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatcher(mNetworkQueue, mNetwork,</div><div class="line">                    mCache, mDelivery);</div><div class="line">            mDispatchers[i] = networkDispatcher;</div><div class="line">            networkDispatcher.start();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 就好像一个工厂一启动，里面就分配了5个搬运工，一个负责搬运cache里面的的请求，4个负责搬运network中的。启动后他们就开始待命</span></div><div class="line">        <span class="comment">// 一旦有活来了，就开始去取出活开始干。</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Stops the cache and network dispatchers.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mCacheDispatcher != <span class="keyword">null</span>) &#123;</div><div class="line">            mCacheDispatcher.quit();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (mDispatchers[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                mDispatchers[i].quit();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gets a sequence number.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSequenceNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mSequenceGenerator.incrementAndGet();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gets the &#123;<span class="doctag">@link</span> Cache&#125; instance being used.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mCache;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A simple predicate or filter interface for Requests, for use by</div><div class="line">     * &#123;<span class="doctag">@link</span> RequestQueue#cancelAll(RequestFilter)&#125;.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestFilter</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(Request&lt;?&gt; request)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cancels all requests in this queue for which the given filter applies.</div><div class="line">     * <span class="doctag">@param</span> filter The filtering function to use</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(RequestFilter filter)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</div><div class="line">            <span class="keyword">for</span> (Request&lt;?&gt; request : mCurrentRequests) &#123;</div><div class="line">                <span class="keyword">if</span> (filter.apply(request)) &#123;</div><div class="line">                    request.cancel();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Cancels all requests in this queue with the given tag. Tag must be non-null</div><div class="line">     * and equality is by identity.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">(<span class="keyword">final</span> Object tag)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (tag == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot cancelAll with a null tag"</span>);</div><div class="line">        &#125;</div><div class="line">        cancelAll(<span class="keyword">new</span> RequestFilter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(Request&lt;?&gt; request)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> request.getTag() == tag;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Adds a Request to the dispatch queue.</div><div class="line">     * <span class="doctag">@param</span> request The request to service</div><div class="line">     * <span class="doctag">@return</span> The passed-in request</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">add</span><span class="params">(Request&lt;T&gt; request)</span> </span>&#123;</div><div class="line">        <span class="comment">// Tag the request as belonging to this queue and add it to the set of current requests.</span></div><div class="line">        request.setRequestQueue(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</div><div class="line">            <span class="comment">// 添加到mCurrentRequests中，在执行完后的finish方法中会去移除该请求。</span></div><div class="line">            mCurrentRequests.add(request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Process requests in the order they are added.</span></div><div class="line">        request.setSequence(getSequenceNumber());</div><div class="line">        request.addMarker(<span class="string">"add-to-queue"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 判断一下该请求能否进行缓存，如果不能缓存就直接添加到网络请求的队列中。这个能不能缓存是怎么判断的？其实就是根据Request中的一个变量来判断。</span></div><div class="line">　　　　<span class="comment">// 默认情况下所有的请求都是可以缓存的，可以通过Request.setShouldCache(false)方法，来将其设置为不可缓存状态。</span></div><div class="line">        <span class="comment">// If the request is uncacheable, skip the cache queue and go straight to the network.</span></div><div class="line">        <span class="keyword">if</span> (!request.shouldCache()) &#123;</div><div class="line">            mNetworkQueue.add(request);</div><div class="line">            <span class="keyword">return</span> request;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Insert request into stage if there's already a request with the same cache key in flight.</span></div><div class="line">        <span class="keyword">synchronized</span> (mWaitingRequests) &#123;</div><div class="line">            String cacheKey = request.getCacheKey();</div><div class="line">            <span class="keyword">if</span> (mWaitingRequests.containsKey(cacheKey)) &#123;</div><div class="line">                <span class="comment">// There is already a request in flight. Queue up.</span></div><div class="line">                Queue&lt;Request&lt;?&gt;&gt; stagedRequests = mWaitingRequests.get(cacheKey);</div><div class="line">                <span class="keyword">if</span> (stagedRequests == <span class="keyword">null</span>) &#123;</div><div class="line">                    stagedRequests = <span class="keyword">new</span> LinkedList&lt;Request&lt;?&gt;&gt;();</div><div class="line">                &#125;</div><div class="line">                stagedRequests.add(request);</div><div class="line">                mWaitingRequests.put(cacheKey, stagedRequests);</div><div class="line">                <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</div><div class="line">                    VolleyLog.v(<span class="string">"Request for cacheKey=%s is in flight, putting on hold."</span>, cacheKey);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果能缓存，并且缓存线程中没有的时候就讲该请求添加到缓存队列中</span></div><div class="line">                <span class="comment">// Insert 'null' queue for this cacheKey, indicating there is now a request in</span></div><div class="line">                <span class="comment">// flight.</span></div><div class="line">                mWaitingRequests.put(cacheKey, <span class="keyword">null</span>);</div><div class="line">                mCacheQueue.add(request);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> request;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called from &#123;<span class="doctag">@link</span> Request#finish(String)&#125;, indicating that processing of the given request</div><div class="line">     * has finished.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Releases waiting requests for &lt;code&gt;request.getCacheKey()&lt;/code&gt; if</div><div class="line">     *      &lt;code&gt;request.shouldCache()&lt;/code&gt;.&lt;/p&gt;</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(Request&lt;?&gt; request)</span> </span>&#123;</div><div class="line">        <span class="comment">// Remove from the set of requests currently being processed.</span></div><div class="line">        <span class="keyword">synchronized</span> (mCurrentRequests) &#123;</div><div class="line">            mCurrentRequests.remove(request);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.shouldCache()) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (mWaitingRequests) &#123;</div><div class="line">                String cacheKey = request.getCacheKey();</div><div class="line">                Queue&lt;Request&lt;?&gt;&gt; waitingRequests = mWaitingRequests.remove(cacheKey);</div><div class="line">                <span class="keyword">if</span> (waitingRequests != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (VolleyLog.DEBUG) &#123;</div><div class="line">                        VolleyLog.v(<span class="string">"Releasing %d waiting requests for cacheKey=%s."</span>,</div><div class="line">                                waitingRequests.size(), cacheKey);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Process all queued up requests. They won't be considered as in flight, but</span></div><div class="line">                    <span class="comment">// that's not a problem as the cache has been primed by 'request'.</span></div><div class="line">                    mCacheQueue.addAll(waitingRequests);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到这里基本都能看的差不多了。官方文档中有句话说的很好，这里用他来总结一下<code>A RequestQueue needs two things to do its job: a network to perform transport of the requests, and a cache to handle caching.</code><br>顺便再上一张图:       </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/volley-request.png?raw=true" alt="image">                   </p>
<p>总结完之后我们接着进行分析。因为默认情况下请求都是可缓存的，所以都会被添加到mCacheQueue中。添加该队列之后，就会被开始<code>start</code>方法所制定的cache搬运工去执行，所以我们要看一下CacheDispatcher的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides a thread for performing cache triage on a queue of requests.</div><div class="line"> *</div><div class="line"> * Requests added to the specified cache queue are resolved from cache.</div><div class="line"> * Any deliverable response is posted back to the caller via a</div><div class="line"> * &#123;<span class="doctag">@link</span> ResponseDelivery&#125;.  Cache misses and responses that require</div><div class="line"> * refresh are enqueued on the specified network queue for processing</div><div class="line"> * by a &#123;<span class="doctag">@link</span> NetworkDispatcher&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheDispatcher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = VolleyLog.DEBUG;</div><div class="line"></div><div class="line">    <span class="comment">/** The queue of requests coming in for triage. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Request&lt;?&gt;&gt; mCacheQueue;</div><div class="line"></div><div class="line">    <span class="comment">/** The queue of requests going out to the network. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Request&lt;?&gt;&gt; mNetworkQueue;</div><div class="line"></div><div class="line">    <span class="comment">/** The cache to read from. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line"></div><div class="line">    <span class="comment">/** For posting responses. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line"></div><div class="line">    <span class="comment">/** Used for telling us to die. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mQuit = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new cache triage dispatcher thread.  You must call &#123;<span class="doctag">@link</span> #start()&#125;</div><div class="line">     * in order to begin processing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cacheQueue Queue of incoming requests for triage</div><div class="line">     * <span class="doctag">@param</span> networkQueue Queue to post requests that require network to</div><div class="line">     * <span class="doctag">@param</span> cache Cache interface to use for resolution</div><div class="line">     * <span class="doctag">@param</span> delivery Delivery interface to use for posting responses</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CacheDispatcher</span><span class="params">(</span></span></div><div class="line">            BlockingQueue&lt;Request&lt;?&gt;&gt; cacheQueue, BlockingQueue&lt;Request&lt;?&gt;&gt; networkQueue,</div><div class="line">            Cache cache, ResponseDelivery delivery) &#123;</div><div class="line">        <span class="comment">// 将CacheQueue以及networkQueue等传递进来。</span></div><div class="line">        mCacheQueue = cacheQueue;</div><div class="line">        mNetworkQueue = networkQueue;</div><div class="line">        mCache = cache;</div><div class="line">        mDelivery = delivery;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Forces this dispatcher to quit immediately.  If any requests are still in</div><div class="line">     * the queue, they are not guaranteed to be processed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        mQuit = <span class="keyword">true</span>;</div><div class="line">        interrupt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG) VolleyLog.v(<span class="string">"start new dispatcher"</span>);</div><div class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line"></div><div class="line">        <span class="comment">// Make a blocking call to initialize the cache.</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Performs any potentially long-running actions needed to initialize the cache;</div><div class="line">     * will be called from a worker thread.</div><div class="line">     */</div><div class="line">        mCache.initialize();</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 从缓存队列中取出第一个请求</span></div><div class="line">                <span class="comment">// Get a request from the cache triage queue, blocking until</span></div><div class="line">                <span class="comment">// at least one is available.</span></div><div class="line">                <span class="keyword">final</span> Request&lt;?&gt; request = mCacheQueue.take();</div><div class="line">                request.addMarker(<span class="string">"cache-queue-take"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If the request has been canceled, don't bother dispatching it.</span></div><div class="line">                <span class="keyword">if</span> (request.isCanceled()) &#123;</div><div class="line">                    request.finish(<span class="string">"cache-discard-canceled"</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Attempt to retrieve this item from cache.</span></div><div class="line">                Cache.Entry entry = mCache.get(request.getCacheKey());</div><div class="line">                <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// 如果缓存中找不到该请求，就把该请求添加到网络请求队列中。</span></div><div class="line">                    request.addMarker(<span class="string">"cache-miss"</span>);</div><div class="line">                    <span class="comment">// Cache miss; send off to the network dispatcher.</span></div><div class="line">                    mNetworkQueue.put(request);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 如果缓存中找到了该请求，接下来就判断该缓存是否过期。</span></div><div class="line">                <span class="comment">// If it is completely expired, just send it to the network.</span></div><div class="line">                <span class="keyword">if</span> (entry.isExpired()) &#123;</div><div class="line">                    <span class="comment">// 过期了也重新添加到网络请求中</span></div><div class="line">                    request.addMarker(<span class="string">"cache-hit-expired"</span>);</div><div class="line">                    request.setCacheEntry(entry);</div><div class="line">                    mNetworkQueue.put(request);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 没有过期，就不用再请求了，直接从缓存中取出数据返回即可。</span></div><div class="line">                <span class="comment">// We have a cache hit; parse its data for delivery back to the request.</span></div><div class="line">                request.addMarker(<span class="string">"cache-hit"</span>);</div><div class="line">                <span class="comment">// 这里的意思就是对数据进行解析，后面再看Request.parseNetworkResponse方法。</span></div><div class="line">                Response&lt;?&gt; response = request.parseNetworkResponse(</div><div class="line">                        <span class="keyword">new</span> NetworkResponse(entry.data, entry.responseHeaders));</div><div class="line">                request.addMarker(<span class="string">"cache-hit-parsed"</span>);</div><div class="line">		<span class="comment">// 判断缓存数据是否需要刷新，以便使用mDelivery分发结果或者添加到网络请求队列中</span></div><div class="line">                <span class="keyword">if</span> (!entry.refreshNeeded()) &#123;</div><div class="line">                    <span class="comment">// Completely unexpired cache hit. Just deliver the response.</span></div><div class="line">                    mDelivery.postResponse(request, response);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Soft-expired cache hit. We can deliver the cached response,</span></div><div class="line">                    <span class="comment">// but we need to also send the request to the network for</span></div><div class="line">                    <span class="comment">// refreshing.</span></div><div class="line">                    request.addMarker(<span class="string">"cache-hit-refresh-needed"</span>);</div><div class="line">                    request.setCacheEntry(entry);</div><div class="line"></div><div class="line">                    <span class="comment">// Mark the response as intermediate.</span></div><div class="line">                    response.intermediate = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                    <span class="comment">// Post the intermediate response back to the user and have</span></div><div class="line">                    <span class="comment">// the delivery then forward the request along to the network.</span></div><div class="line">                    mDelivery.postResponse(request, response, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                mNetworkQueue.put(request);</div><div class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                                <span class="comment">// Not much we can do about this.</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="comment">// We may have been interrupted because it was time to quit.</span></div><div class="line">                <span class="keyword">if</span> (mQuit) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而对于网络请求队列中的任务该如何执行，这里就要看<code>NetworkDispatcher</code>的具体实现:        </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides a thread for performing network dispatch from a queue of requests.</div><div class="line"> *</div><div class="line"> * Requests added to the specified queue are processed from the network via a</div><div class="line"> * specified &#123;<span class="doctag">@link</span> Network&#125; interface. Responses are committed to cache, if</div><div class="line"> * eligible, using a specified &#123;<span class="doctag">@link</span> Cache&#125; interface. Valid responses and</div><div class="line"> * errors are posted back to the caller via a &#123;<span class="doctag">@link</span> ResponseDelivery&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkDispatcher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="comment">/** The queue of requests to service. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Request&lt;?&gt;&gt; mQueue;</div><div class="line">    <span class="comment">/** The network interface for processing requests. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Network mNetwork;</div><div class="line">    <span class="comment">/** The cache to write to. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line">    <span class="comment">/** For posting responses and errors. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line">    <span class="comment">/** Used for telling us to die. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mQuit = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new network dispatcher thread.  You must call &#123;<span class="doctag">@link</span> #start()&#125;</div><div class="line">     * in order to begin processing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> queue Queue of incoming requests for triage</div><div class="line">     * <span class="doctag">@param</span> network Network interface to use for performing requests</div><div class="line">     * <span class="doctag">@param</span> cache Cache interface to use for writing responses to cache</div><div class="line">     * <span class="doctag">@param</span> delivery Delivery interface to use for posting responses</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetworkDispatcher</span><span class="params">(BlockingQueue&lt;Request&lt;?&gt;&gt; queue,</span></span></div><div class="line">            Network network, Cache cache,</div><div class="line">            ResponseDelivery delivery) &#123;</div><div class="line">        mQueue = queue;</div><div class="line">        mNetwork = network;</div><div class="line">        mCache = cache;</div><div class="line">        mDelivery = delivery;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Forces this dispatcher to quit immediately.  If any requests are still in</div><div class="line">     * the queue, they are not guaranteed to be processed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        mQuit = <span class="keyword">true</span>;</div><div class="line">        interrupt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTrafficStatsTag</span><span class="params">(Request&lt;?&gt; request)</span> </span>&#123;</div><div class="line">        <span class="comment">// Tag the request (if API &gt;= 14)</span></div><div class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">            TrafficStats.setThreadStatsTag(request.getTrafficStatsTag());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">long</span> startTimeMs = SystemClock.elapsedRealtime();</div><div class="line">            Request&lt;?&gt; request;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// Take a request from the queue.</span></div><div class="line">                request = mQueue.take();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="comment">// We may have been interrupted because it was time to quit.</span></div><div class="line">                <span class="keyword">if</span> (mQuit) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                request.addMarker(<span class="string">"network-queue-take"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If the request was cancelled already, do not perform the</span></div><div class="line">                <span class="comment">// network request.</span></div><div class="line">                <span class="keyword">if</span> (request.isCanceled()) &#123;</div><div class="line">                    request.finish(<span class="string">"network-discard-cancelled"</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                addTrafficStatsTag(request);</div><div class="line">                <span class="comment">// mNetwork会去执行对应的request请求，后面再看里面的具体实现</span></div><div class="line">                <span class="comment">// Perform the network request.</span></div><div class="line">                NetworkResponse networkResponse = mNetwork.performRequest(request);</div><div class="line">                request.addMarker(<span class="string">"network-http-complete"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If the server returned 304 AND we delivered a response already,</span></div><div class="line">                <span class="comment">// we're done -- don't deliver a second identical response.</span></div><div class="line">                <span class="keyword">if</span> (networkResponse.notModified &amp;&amp; request.hasHadResponseDelivered()) &#123;</div><div class="line">                    request.finish(<span class="string">"not-modified"</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 将网络请求返回的NetworkResponse交给request.parseNetworkResponse进行处理</span></div><div class="line">                <span class="comment">// Parse the response here on the worker thread.</span></div><div class="line">                Response&lt;?&gt; response = request.parseNetworkResponse(networkResponse);</div><div class="line">                request.addMarker(<span class="string">"network-parse-complete"</span>);</div><div class="line"></div><div class="line">                <span class="comment">// Write to cache if applicable.</span></div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> Only update cache metadata instead of entire record for 304s.</span></div><div class="line">                <span class="keyword">if</span> (request.shouldCache() &amp;&amp; response.cacheEntry != <span class="keyword">null</span>) &#123;</div><div class="line">                    mCache.put(request.getCacheKey(), response.cacheEntry);</div><div class="line">                    request.addMarker(<span class="string">"network-cache-written"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Post the response back.</span></div><div class="line">                request.markDelivered();</div><div class="line">                <span class="comment">// mDelivery进行分发</span></div><div class="line">                mDelivery.postResponse(request, response);</div><div class="line">            &#125; <span class="keyword">catch</span> (VolleyError volleyError) &#123;</div><div class="line">                volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);</div><div class="line">                parseAndDeliverNetworkError(request, volleyError);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                VolleyLog.e(e, <span class="string">"Unhandled exception %s"</span>, e.toString());</div><div class="line">                VolleyError volleyError = <span class="keyword">new</span> VolleyError(e);</div><div class="line">                volleyError.setNetworkTimeMs(SystemClock.elapsedRealtime() - startTimeMs);</div><div class="line">                mDelivery.postError(request, volleyError);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAndDeliverNetworkError</span><span class="params">(Request&lt;?&gt; request, VolleyError error)</span> </span>&#123;</div><div class="line">        error = request.parseNetworkError(error);</div><div class="line">        mDelivery.postError(request, error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面会执行到<code>mNetwork.performRequest</code>方法，而<code>Network</code>是一个接口，具体的实现要看<code>BaseNetwork</code>中的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> NetworkResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request)</span> <span class="keyword">throws</span> VolleyError </span>&#123;</div><div class="line">    <span class="keyword">long</span> requestStart = SystemClock.elapsedRealtime();</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        HttpResponse httpResponse = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">byte</span>[] responseContents = <span class="keyword">null</span>;</div><div class="line">        Map&lt;String, String&gt; responseHeaders = Collections.emptyMap();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Gather headers.</span></div><div class="line">            Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">            addCacheHeaders(headers, request.getCacheEntry());</div><div class="line">            <span class="comment">// 调用mHttpStack.performRequest方法，这里就是newRequestQueue中创建的部分，9及以上为HurlStack，9以下为HttpClientStach,具体就是真正执行网络请求的部分了。</span></div><div class="line">            httpResponse = mHttpStack.performRequest(request, headers);</div><div class="line">            StatusLine statusLine = httpResponse.getStatusLine();</div><div class="line">            <span class="keyword">int</span> statusCode = statusLine.getStatusCode();</div><div class="line"></div><div class="line">            responseHeaders = convertHeaders(httpResponse.getAllHeaders());</div><div class="line">            <span class="comment">// Handle cache validation.</span></div><div class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.SC_NOT_MODIFIED) &#123;</div><div class="line"></div><div class="line">                Entry entry = request.getCacheEntry();</div><div class="line">                <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, <span class="keyword">null</span>,</div><div class="line">                            responseHeaders, <span class="keyword">true</span>,</div><div class="line">                            SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// A HTTP 304 response does not have all header fields. We</span></div><div class="line">                <span class="comment">// have to use the header fields from the cache entry plus</span></div><div class="line">                <span class="comment">// the new ones from the response.</span></div><div class="line">                <span class="comment">// http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5</span></div><div class="line">                entry.responseHeaders.putAll(responseHeaders);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, entry.data,</div><div class="line">                        entry.responseHeaders, <span class="keyword">true</span>,</div><div class="line">                        SystemClock.elapsedRealtime() - requestStart);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// Handle moved resources</span></div><div class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.SC_MOVED_PERMANENTLY || statusCode == HttpStatus.SC_MOVED_TEMPORARILY) &#123;</div><div class="line">            	String newUrl = responseHeaders.get(<span class="string">"Location"</span>);</div><div class="line">            	request.setRedirectUrl(newUrl);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Some responses such as 204s do not have content.  We must check.</span></div><div class="line">            <span class="keyword">if</span> (httpResponse.getEntity() != <span class="keyword">null</span>) &#123;</div><div class="line">              responseContents = entityToBytes(httpResponse.getEntity());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="comment">// Add 0 byte response as a way of honestly representing a</span></div><div class="line">              <span class="comment">// no-content request.</span></div><div class="line">              responseContents = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// if the request is slow, log it.</span></div><div class="line">            <span class="keyword">long</span> requestLifetime = SystemClock.elapsedRealtime() - requestStart;</div><div class="line">            logSlowRequests(requestLifetime, request, responseContents, statusLine);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (statusCode &lt; <span class="number">200</span> || statusCode &gt; <span class="number">299</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(statusCode, responseContents, responseHeaders, <span class="keyword">false</span>,</div><div class="line">                    SystemClock.elapsedRealtime() - requestStart);</div><div class="line">        &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</div><div class="line">            attemptRetryOnException(<span class="string">"socket"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">        &#125; <span class="keyword">catch</span> (ConnectTimeoutException e) &#123;</div><div class="line">            attemptRetryOnException(<span class="string">"connection"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Bad URL "</span> + request.getUrl(), e);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">int</span> statusCode = <span class="number">0</span>;</div><div class="line">            NetworkResponse networkResponse = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (httpResponse != <span class="keyword">null</span>) &#123;</div><div class="line">                statusCode = httpResponse.getStatusLine().getStatusCode();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoConnectionError(e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.SC_MOVED_PERMANENTLY || </div><div class="line">            		statusCode == HttpStatus.SC_MOVED_TEMPORARILY) &#123;</div><div class="line">            	VolleyLog.e(<span class="string">"Request at %s has been redirected to %s"</span>, request.getOriginUrl(), request.getUrl());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">            	VolleyLog.e(<span class="string">"Unexpected response code %d for %s"</span>, statusCode, request.getUrl());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (responseContents != <span class="keyword">null</span>) &#123;</div><div class="line">                networkResponse = <span class="keyword">new</span> NetworkResponse(statusCode, responseContents,</div><div class="line">                        responseHeaders, <span class="keyword">false</span>, SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                <span class="keyword">if</span> (statusCode == HttpStatus.SC_UNAUTHORIZED ||</div><div class="line">                        statusCode == HttpStatus.SC_FORBIDDEN) &#123;</div><div class="line">                    attemptRetryOnException(<span class="string">"auth"</span>,</div><div class="line">                            request, <span class="keyword">new</span> AuthFailureError(networkResponse));</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == HttpStatus.SC_MOVED_PERMANENTLY || </div><div class="line">                			statusCode == HttpStatus.SC_MOVED_TEMPORARILY) &#123;</div><div class="line">                    attemptRetryOnException(<span class="string">"redirect"</span>,</div><div class="line">                            request, <span class="keyword">new</span> AuthFailureError(networkResponse));</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Only throw ServerError for 5xx status codes.</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServerError(networkResponse);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NetworkError(networkResponse);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面调用了mHttpStack.performRequest的方法，这里就以9及以上的HurlStack类来看下源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> HttpResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request, Map&lt;String, String&gt; additionalHeaders)</span></span></div><div class="line">		<span class="keyword">throws</span> IOException, AuthFailureError &#123;</div><div class="line">	String url = request.getUrl();</div><div class="line">	HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">	map.putAll(request.getHeaders());</div><div class="line">	map.putAll(additionalHeaders);</div><div class="line">	<span class="keyword">if</span> (mUrlRewriter != <span class="keyword">null</span>) &#123;</div><div class="line">		String rewritten = mUrlRewriter.rewriteUrl(url);</div><div class="line">		<span class="keyword">if</span> (rewritten == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"URL blocked by rewriter: "</span> + url);</div><div class="line">		&#125;</div><div class="line">		url = rewritten;</div><div class="line">	&#125;</div><div class="line">	URL parsedUrl = <span class="keyword">new</span> URL(url);</div><div class="line">	HttpURLConnection connection = openConnection(parsedUrl, request);</div><div class="line">	<span class="keyword">for</span> (String headerName : map.keySet()) &#123;</div><div class="line">		connection.addRequestProperty(headerName, map.get(headerName));</div><div class="line">	&#125;</div><div class="line">	setConnectionParametersForRequest(connection, request);</div><div class="line">	<span class="comment">// Initialize HttpResponse with data from the HttpURLConnection.</span></div><div class="line">	ProtocolVersion protocolVersion = <span class="keyword">new</span> ProtocolVersion(<span class="string">"HTTP"</span>, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">	<span class="keyword">int</span> responseCode = connection.getResponseCode();</div><div class="line">	<span class="keyword">if</span> (responseCode == -<span class="number">1</span>) &#123;</div><div class="line">		<span class="comment">// -1 is returned by getResponseCode() if the response code could not be retrieved.</span></div><div class="line">		<span class="comment">// Signal to the caller that something was wrong with the connection.</span></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Could not retrieve response code from HttpUrlConnection."</span>);</div><div class="line">	&#125;</div><div class="line">	StatusLine responseStatus = <span class="keyword">new</span> BasicStatusLine(protocolVersion,</div><div class="line">			connection.getResponseCode(), connection.getResponseMessage());</div><div class="line">	BasicHttpResponse response = <span class="keyword">new</span> BasicHttpResponse(responseStatus);</div><div class="line">	response.setEntity(entityFromConnection(connection));</div><div class="line">	<span class="keyword">for</span> (Entry&lt;String, List&lt;String&gt;&gt; header : connection.getHeaderFields().entrySet()) &#123;</div><div class="line">		<span class="keyword">if</span> (header.getKey() != <span class="keyword">null</span>) &#123;</div><div class="line">			Header h = <span class="keyword">new</span> BasicHeader(header.getKey(), header.getValue().get(<span class="number">0</span>));</div><div class="line">			response.addHeader(h);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> response;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来还要看一下<code>mDelivery.postResponse(request, response);</code>这里的,mDelivery就是<code>new ExecutorDelivery(new Handler(Looper.getMainLooper()))</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Delivers responses and errors.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorDelivery</span> <span class="keyword">implements</span> <span class="title">ResponseDelivery</span> </span>&#123;</div><div class="line">    <span class="comment">/** Used for posting responses, typically to the main thread. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor mResponsePoster;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new response delivery interface.</div><div class="line">     * <span class="doctag">@param</span> handler &#123;<span class="doctag">@link</span> Handler&#125; to post responses on</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorDelivery</span><span class="params">(<span class="keyword">final</span> Handler handler)</span> </span>&#123;</div><div class="line">        <span class="comment">// Make an Executor that just wraps the handler.</span></div><div class="line">        mResponsePoster = <span class="keyword">new</span> Executor() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">                handler.post(command);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new response delivery interface, mockable version</div><div class="line">     * for testing.</div><div class="line">     * <span class="doctag">@param</span> executor For running delivery tasks</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecutorDelivery</span><span class="params">(Executor executor)</span> </span>&#123;</div><div class="line">        mResponsePoster = executor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postResponse</span><span class="params">(Request&lt;?&gt; request, Response&lt;?&gt; response)</span> </span>&#123;</div><div class="line">        postResponse(request, response, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postResponse</span><span class="params">(Request&lt;?&gt; request, Response&lt;?&gt; response, Runnable runnable)</span> </span>&#123;</div><div class="line">        request.markDelivered();</div><div class="line">        request.addMarker(<span class="string">"post-response"</span>);</div><div class="line">        <span class="comment">// 内部会调用execute方法</span></div><div class="line">        mResponsePoster.execute(<span class="keyword">new</span> ResponseDeliveryRunnable(request, response, runnable));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postError</span><span class="params">(Request&lt;?&gt; request, VolleyError error)</span> </span>&#123;</div><div class="line">        request.addMarker(<span class="string">"post-error"</span>);</div><div class="line">        Response&lt;?&gt; response = Response.error(error);</div><div class="line">        mResponsePoster.execute(<span class="keyword">new</span> ResponseDeliveryRunnable(request, response, <span class="keyword">null</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A Runnable used for delivering network responses to a listener on the</div><div class="line">     * main thread.</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseDeliveryRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Request mRequest;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Response mResponse;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Runnable mRunnable;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ResponseDeliveryRunnable</span><span class="params">(Request request, Response response, Runnable runnable)</span> </span>&#123;</div><div class="line">            mRequest = request;</div><div class="line">            mResponse = response;</div><div class="line">            mRunnable = runnable;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// 这里就是重点部分了</span></div><div class="line">            <span class="comment">// If this request has canceled, finish it and don't deliver.</span></div><div class="line">            <span class="keyword">if</span> (mRequest.isCanceled()) &#123;</div><div class="line">                mRequest.finish(<span class="string">"canceled-at-delivery"</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 调用mRequest的deliverResponse或者deliverError进行分发</span></div><div class="line">            <span class="comment">// Deliver a normal response or error, depending.</span></div><div class="line">            <span class="keyword">if</span> (mResponse.isSuccess()) &#123;</div><div class="line">                mRequest.deliverResponse(mResponse.result);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mRequest.deliverError(mResponse.error);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// If this is an intermediate response, add a marker, otherwise we're done</span></div><div class="line">            <span class="comment">// and the request can be finished.</span></div><div class="line">            <span class="keyword">if</span> (mResponse.intermediate) &#123;</div><div class="line">                mRequest.addMarker(<span class="string">"intermediate-response"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 执行finish方法</span></div><div class="line">                mRequest.finish(<span class="string">"done"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// If we have been provided a post-delivery runnable, run it.</span></div><div class="line">            <span class="keyword">if</span> (mRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">                mRunnable.run();</div><div class="line">            &#125;</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里再看一下mRequest的deliverResponse方法。<br>Request接口中没有实现该方法，具体我们以StringRequest为例看一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A canned request for retrieving the response body at a given URL as a String.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringRequest</span> <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Listener&lt;String&gt; mListener;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new request with the given method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> method the request &#123;<span class="doctag">@link</span> Method&#125; to use</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the string at</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the String response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRequest</span><span class="params">(<span class="keyword">int</span> method, String url, Listener&lt;String&gt; listener,</span></span></div><div class="line">            ErrorListener errorListener) &#123;</div><div class="line">        <span class="keyword">super</span>(method, url, errorListener);</div><div class="line">        mListener = listener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a new GET request.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> url URL to fetch the string at</div><div class="line">     * <span class="doctag">@param</span> listener Listener to receive the String response</div><div class="line">     * <span class="doctag">@param</span> errorListener Error listener, or null to ignore errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringRequest</span><span class="params">(String url, Listener&lt;String&gt; listener, ErrorListener errorListener)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(Method.GET, url, listener, errorListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deliverResponse</span><span class="params">(String response)</span> </span>&#123;</div><div class="line">        <span class="comment">// 回调</span></div><div class="line">        mListener.onResponse(response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;String&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        String parsed;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parsed = <span class="keyword">new</span> String(response.data, HttpHeaderParser.parseCharset(response.headers));</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            parsed = <span class="keyword">new</span> String(response.data);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> Response.success(parsed, HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下mRequest.finish方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Notifies the request queue that this request has finished (successfully or with error).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Also dumps all events from this request's event log; for debugging.&lt;/p&gt;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(<span class="keyword">final</span> String tag)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mRequestQueue != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 内部调用了mRequestQueue的finish方法，也就是把请求从请求队列中移除。</span></div><div class="line">        mRequestQueue.finish(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (MarkerLog.ENABLED) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> threadId = Thread.currentThread().getId();</div><div class="line">        <span class="keyword">if</span> (Looper.myLooper() != Looper.getMainLooper()) &#123;</div><div class="line">            <span class="comment">// If we finish marking off of the main thread, we need to</span></div><div class="line">            <span class="comment">// actually do it on the main thread to ensure correct ordering.</span></div><div class="line">            Handler mainThread = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line">            mainThread.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mEventLog.add(tag, threadId);</div><div class="line">                    mEventLog.finish(<span class="keyword">this</span>.toString());</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mEventLog.add(tag, threadId);</div><div class="line">        mEventLog.finish(<span class="keyword">this</span>.toString());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">long</span> requestTime = SystemClock.elapsedRealtime() - mRequestBirthTime;</div><div class="line">        <span class="keyword">if</span> (requestTime &gt;= SLOW_REQUEST_THRESHOLD_MS) &#123;</div><div class="line">            VolleyLog.d(<span class="string">"%d ms: %s"</span>, requestTime, <span class="keyword">this</span>.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里就全部分析完了。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Volley源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-发布library到Maven仓库" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/发布library到Maven仓库/">发布library到Maven仓库</a>
    </h1>
  

        
        <a href="/2015/01/01/发布library到Maven仓库/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="发布library到Maven仓库"><a href="#发布library到Maven仓库" class="headerlink" title="发布library到Maven仓库"></a>发布library到Maven仓库</h2><p>在<code>Android Studio</code>中想要使用一些第三方类库的时候非常方便，只需要在<code>build.gradle</code>中加入一行代码就可以了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.google.code.gson:gson:2.3.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>刚从<code>Eclipse</code>转过来的时候感觉太方便了，也不用下<code>jar</code>包然后拷贝到<code>libs</code>目录了，重要的是以后升级起来灰常方便，改个数字就好了。<br>那究竟它里面是怎么运转的呢？其实<code>Android Studio</code>是从<code>Maven</code>仓库中下载所配置的<code>libraray</code>。<br>总的来说，<code>Android</code>只有两种存放<code>library</code>的服务器就是<code>jCenter</code>和<code>Maven Central</code>:</p>
<ul>
<li><p><code>jCenter</code><br>  <code>jCenter</code>是由<a href="https://bintray.com/" target="_blank" rel="external">bintray</a>维护的<code>Maven</code>仓库。你可以在<a href="http://jcenter.bintray.com/" target="_blank" rel="external">这里</a>查看它所有的<code>library</code>。<br>  想要在项目中使用<code>jCenter</code>必须要在项目的<code>build.gradle</code>中像如下这样进行声明：    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   allprojects &#123;</div><div class="line">	repositories &#123;</div><div class="line">		jcenter()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>Maven Central</code><br>  <code>Maven Central</code>是由<a href="https://issues.sonatype.org" target="_blank" rel="external">sonatype</a>维护的<code>Maven</code>仓库。想要在项目中使用<code>Maven Central</code>需要在项目的<code>build.gradle</code>文件中像下面这样进行声明:     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">    allprojects &#123;</div><div class="line">        repositories &#123;</div><div class="line">            mavenCentral()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ```	</div><div class="line">	虽然`jCenter`和`Maven Central`都是`Android`标准的`library maven`仓库，但是他俩是由不同提供者维护，并且存放到完全不同的服务器上，所以他俩之间毫无关系。     </div><div class="line">	除了这两个标准的服务器外，如果我们使用的`library`作者把该`library`放到自己的服务器上，我们还可以自己定义特有的`Maven`仓库服务器。例如`Twitter`的`Fabric.io`就是这种情况，它们在[https:<span class="comment">//maven.fabric.io/public](https://maven.fabric.io/public)上维护了一个自己的`Maven`仓库，如果你想使用`Fabric.io`上的`library`你必须要自己定义仓库的`url`:       </span></div><div class="line">	```java</div><div class="line">	repositories &#123;</div><div class="line">		maven &#123; url <span class="string">'https://maven.fabric.io/public'</span> &#125;</div><div class="line">	&#125;</div><div class="line">	然后才能正常使用</div><div class="line">	dependencies &#123;</div><div class="line">		compile <span class="string">'com.crashlytics.sdk.android:crashlytics:2.2.4@aar'</span></div><div class="line">	&#125;</div><div class="line">	```	</div><div class="line"></div><div class="line">	上传到自建服务器需要定义仓库的`url`，所以会比上传到标准的`maven`仓库使用起来要更麻烦。</div><div class="line"></div><div class="line">	至于上传到`jCenter`还是`Maven Central`上面就要看开发者个人的爱好了，当然在这两个上面都上传是最方便的。在`Android Studio`开始的几个版本中，它将`Maven central` 作为默认仓库。新建项目之后`build.gradle`中会自动生成`Maven central`仓库的配置。</div><div class="line">	但是`Maven Central`最大的问题就是上传`library`非常困难，同时还会由安全方面的原因，所以后来`Android Studio`将默认仓库替换成`jCenter`。所以最近的几个版本中创建项目之后,`build.gradle`中会默认定义`jCenter`而不是`Maven Central`。     </div><div class="line"></div><div class="line">`jCenter`相对`Maven Central`来说更好的几个主要原因:    </div><div class="line"></div><div class="line">- `jCenter`通过`CDN`发送`library`，开发者会由更快的下载体验。</div><div class="line">- `jCenter`作为世界最大的`Java`仓库，所以它上面的`library`会更多。</div><div class="line">- `jCenter`上传`library`更简单，不需要像在`Maven Central`上那么复杂。</div><div class="line">- `jCenter`的用户界面更友好。</div><div class="line">- `jCenter`的`bintray`网站上可以通过一键实现将`library`上传到`Maven Central`上。</div><div class="line"></div><div class="line">所以我们后面要讲的就是如何上传`library`到`bintray`的`jCenter`中然后再一键上传到`Maven Central`上。    </div><div class="line"></div><div class="line">说之前先通过`picasso`为例认识一下几个主要的部分:      </div><div class="line">我们在使用`picasso`时，它会告诉我们按照如下使用： </div><div class="line">```java</div><div class="line">compile <span class="string">'com.squareup.picasso:picasso:2.5.2'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>或者<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">  &lt;groupId&gt;com.squareup.picasso&lt;/groupId&gt;</div><div class="line">  &lt;artifactId&gt;picasso&lt;/artifactId&gt;</div><div class="line">  &lt;version&gt;2.5.2&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>这两种方法分别对应了<code>jCenter</code>和<code>Maven Central</code>中的使用方法.<code>jCenter</code>中<code>com.squareup.picasso</code>就是<code>grounId</code>，通常我们以开发者的报名后面紧跟<code>library</code>的名字来命名<code>groupId</code>, <code>picasso</code>是<code>artifactId</code>,<code>artifactId</code>也就是<code>library</code>真实的名称。,后面的<code>2.5.2</code>就是当前的<code>version</code>.</p>
<p>看到这里应该清楚其实就是<code>Android Studio</code>从<code>Maven</code>服务器上去下载我们所配置的<code>library</code>然后与我们项目一起进行编译。从<code>Maven</code>仓库上下载的是该<code>library</code>的<code>jar</code>或者<code>aar</code>文件。</p>
<p>仓库中存储的有两种文件类型的<code>library</code>：<code>jar</code>和<code>aar</code>。<code>jar</code>包大家都知道。那什么是<code>aar</code>呢？<code>aar</code>是在<code>jar</code>的基础上进行开发的，这是因为<code>Androd Library</code>需要植入一些特有的文件，例如资源文件、<code>assets</code>、<code>jni</code>、清单文件等。而这些都不是<code>jar</code>的标准，因为<code>aar</code>就是在<code>jar</code>包的基础上新增了对其他文件的封装。当然他和<code>jar</code>包一样，在本质上都是<code>zip</code>包，下面我们看一下<code>aar</code>的目录结构:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- /AndroidManifest.xml</div><div class="line">- /classes.jar</div><div class="line">- /res/</div><div class="line">- /R.txt</div><div class="line">- /assets/</div><div class="line">- /libs<span class="comment">/*.jar</span></div><div class="line">- /jni/&lt;abi&gt;/*.so</div><div class="line">- /proguard.txt</div><div class="line">- /lint.jar</div></pre></td></tr></table></figure></p>
<p>讲到这里已经清楚了<code>groupId</code>、<code>artifactId</code>以及<code>aar</code>了，那接下来我们就讲一下具体的发布流程了:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/public_jcenter.png?raw=true" alt="image">   </p>
<h2 id="在Bintray上创建一个包"><a href="#在Bintray上创建一个包" class="headerlink" title="在Bintray上创建一个包"></a>在Bintray上创建一个包</h2><ul>
<li>登陆<a href="https://bintray.com/" target="_blank" rel="external">bintray</a>。</li>
<li>选择<code>Maven</code>后进入。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/bintray.png?raw=true" alt="image"></li>
<li>添加新包。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/and_new_package.png?raw=true" alt="image"></li>
<li><p>填写包信息<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/add_package_information.png?raw=true" alt="image"></p>
<p>  包名这里对于单词之间要用<code>-</code>分割。</p>
</li>
<li>然后会提示已经上传。<br>到这里我们已经在<code>bintray</code>上创建了一个<code>Maven</code>仓库，接下来要做的就是上传<code>library</code>。</li>
</ul>
<h2 id="在Sonatype上传件一个Maven-Central账户。"><a href="#在Sonatype上传件一个Maven-Central账户。" class="headerlink" title="在Sonatype上传件一个Maven Central账户。"></a>在Sonatype上传件一个<code>Maven Central</code>账户。</h2><ul>
<li>注册Sonatype账号<br>  在<a href="https://issues.sonatype.org/secure/Dashboard.jspa" target="_blank" rel="external">Sonatype</a>上注册账号。<br>  注册完登陆后需要在<code>JIRA</code>中创建一个<code>issue</code>，这样他就会允许你上传匹配<code>Maven Central</code>提供的<code>GROUP_ID</code>的<code>library</code>。    <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/create_issue.png?raw=true" alt="image"><br>  Project: Community Support - Open Source Project Repository Hosting<br>  Issue Type: New Project<br>  Summary: 你的 library名称的概要，比如The Cheese Library。<br>  Group Id: 输入根GROUP_ID，比如， com.charonchui。一旦批准之后，每个以com.charon开始的library都允许被上传到仓库，比如com.charonchui.xxx。<br>  Project URL: 输入任意一个你想贡献的library的URL，比如， <a href="https://github.com/CharonChui/CyberLink4Android">https://github.com/CharonChui/CyberLink4Android</a>。<br>  SCM URL: 版本控制的URL，比如 <a href="https://github.com/CharonChui/CyberLink4Android.git">https://github.com/CharonChui/CyberLink4Android.git</a>。<br>  其他的都不用管，写完之后创建就可以了。 然后就是开始等，大约一周左右就会获准将自己的<code>library</code>分享到<code>Maven Central</code>。</li>
<li><p>下面就是<code>Bintray</code>中的账户选项中填写<code>Sonatype</code>用户名。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/add_account.png?raw=true" alt="image"></p>
</li>
<li><p>开启自动注册功能，为了能让我们通过<code>jcenter</code>上传的<code>libraray</code>自动发布到<code>Maven Central</code>中  </p>
<ul>
<li><p>使用下面的命令生成一个key。如果是windows用户需要使用cygwin。否则不能执行<br>  <code>gpg --gen-key</code><br>   后面会一步步的进行提示，按照提示输入相应内容就好。</p>
<p>   创建完成后可以使用<code>gpg --list-keys</code>命令来查看创建key的信息.<br>   接下来需要将生成的key上传到keyserver上才能发挥作用。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/list_key.png?raw=true" alt="image"></p>
<p>  如上图所示将<code>key</code>上传到<code>keyserver</code>让它发挥作用，运行如下命令，将下面的PUBLIC_KEY_ID替换成上面2048R/后面的数字，如我的是B861C367<br>  <code>gpg --keyserver hkp://pool.sks-keyservers.net --send-keys PUBLIC_KEY_ID</code></p>
</li>
<li><p>运行以下命令        </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gpg -a --export yourmail<span class="meta">@email</span>.com &gt; public_key_sender.asc</div><div class="line">   gpg -a --export-secret-key yourmail<span class="meta">@email</span>.com &gt; private_key_sender.asc</div></pre></td></tr></table></figure>
<p>运行完上面的两个命令后，会在当前目录分别生成public_key_sender.asc以及private_key_sender.ask两个文件，下面我们就打开这两个文件的内容，填写到Bintray的<code>Edit Profile</code>页面中的<code>GPG</code>注册部分。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/GPG.png?raw=true" alt="image"></p>
</li>
<li>开启自动注册。<br>  在<code>Edit Your Profile</code>页面找到<code>Repositories</code>后，选择<code>maven</code>后的<code>edit</code>。然后将GPG sign uploaded files using Bintray’s public/private key pair.打上勾就可以了。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/maven_edit.png?raw=true" alt="image"><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/maven_gpg.png?raw=true" alt="image"></li>
</ul>
</li>
</ul>
<h2 id="接下来就是如何将Android-Studio中的Library-Module进行上传"><a href="#接下来就是如何将Android-Studio中的Library-Module进行上传" class="headerlink" title="接下来就是如何将Android Studio中的Library Module进行上传"></a>接下来就是如何将<code>Android Studio</code>中的<code>Library Module</code>进行上传</h2><p>首先是修改项目的<code>build.gradle</code>文件。如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        <span class="comment">// 注意gradle版本要再1.1.2以上，之前的版本存在问题。如果在工程中/gradle/wrapper/gradle-wrapper.properties重看到当前的gradle版本为2.4，下面的配置版本就要改为1.3.0</span></div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:1.2.3'</span></div><div class="line">        <span class="comment">// 下面的部分就为新添加的。</span></div><div class="line">        <span class="comment">// 用于上传项目到bintray</span></div><div class="line">        classpath <span class="string">'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.2'</span></div><div class="line">        <span class="comment">// 用于生成javaDoc和jar，如果gradle版本为2.4及以上，下面的版本就要改为1.3，具体可参考https://github.com/dcendents/android-maven-gradle-plugin</span></div><div class="line">        classpath <span class="string">'com.github.dcendents:android-maven-plugin:1.2'</span></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></div><div class="line">        <span class="comment">// in the individual module build.gradle files</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改<code>local.properties</code>文件，在里面配置<code>apikey</code>、用户名以及密码，以便<code>bintray</code>进行验证。之所以要把这些东西配置到该文件中是因为这些信息都比较敏感，不能分享到别处，包括版本控制里面。而在创建项目的时候<code>local.properties</code>已经被添加到<code>.gitignore</code>中了，所以这些数据不会被上传：<br>需要添加如下三行代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bintray.user=YOUR_BINTRAY_USERNAME  <span class="comment">// 这里一定要用小写，不要用CharonChui不然会报错的，因为他会根据该用户名去找指定package，如果是大写他就找不到了。</span></div><div class="line">bintray.apikey=YOUR_BINTRAY_API_KEY</div><div class="line">bintray.gpg.password=YOUR_GPG_PASSWORD</div></pre></td></tr></table></figure></p>
<p><code>Api key</code>可以在<code>Binatry</code>官网上面的<code>Edit Profile</code>页面下的<code>API Key</code>中获取。<br>最后要做的就是修改<code>library module</code>中的<code>build.gradle</code>文件。<br>下面这是最初的状态：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.library'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">22</span></div><div class="line">    buildToolsVersion <span class="string">"22.0.1"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">8</span></div><div class="line">        targetSdkVersion <span class="number">22</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面就是修改之后的文件:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.library'</span></div><div class="line">apply plugin: <span class="string">'com.github.dcendents.android-maven'</span></div><div class="line">apply plugin: <span class="string">"com.jfrog.bintray"</span></div><div class="line"></div><div class="line"><span class="comment">// This is the library version used when deploying the artifact</span></div><div class="line">version = <span class="string">"1.0.0"</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">22</span></div><div class="line">    buildToolsVersion <span class="string">"22.0.1"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">8</span></div><div class="line">        targetSdkVersion <span class="number">22</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">def siteUrl = <span class="string">'https://github.com/CharonChui/CyberLink4Android'</span>      <span class="comment">// Homepage URL of the library</span></div><div class="line">def gitUrl = <span class="string">'https://github.com/CharonChui/CyberLink4Android.git'</span>   <span class="comment">// Git repository URL</span></div><div class="line">group = <span class="string">"com.charonchui.cyberlink"</span>                      <span class="comment">// Maven Group ID for the artifact</span></div><div class="line"></div><div class="line">install &#123;</div><div class="line">    repositories.mavenInstaller &#123;</div><div class="line">        <span class="comment">// This generates POM.xml with proper parameters</span></div><div class="line">        pom &#123;</div><div class="line">            project &#123;</div><div class="line">                packaging <span class="string">'aar'</span></div><div class="line"></div><div class="line">                <span class="comment">// Add your description here</span></div><div class="line">                name <span class="string">'cyberlink-android'</span></div><div class="line">                description = <span class="string">'CyberLink for Android is a development package for UPnP™ developers on Android development.'</span></div><div class="line">                url siteUrl</div><div class="line"></div><div class="line">                <span class="comment">// Set your license</span></div><div class="line">                licenses &#123;</div><div class="line">                    license &#123;</div><div class="line">                        name <span class="string">'The Apache Software License, Version 2.0'</span></div><div class="line">                        url <span class="string">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                developers &#123;</div><div class="line">                    developer &#123;</div><div class="line">                        id <span class="string">'CharonChui'</span></div><div class="line">                        name <span class="string">'Charon Chui'</span></div><div class="line">                        email <span class="string">'charon.chui@gmail.com'</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                scm &#123;</div><div class="line">                    connection gitUrl</div><div class="line">                    developerConnection gitUrl</div><div class="line">                    url siteUrl</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">sourcesJar</span><span class="params">(type: Jar)</span> </span>&#123;</div><div class="line">    from android.sourceSets.main.java.srcDirs</div><div class="line">    classifier = <span class="string">'sources'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">javadoc</span><span class="params">(type: Javadoc)</span> </span>&#123;</div><div class="line">    source = android.sourceSets.main.java.srcDirs</div><div class="line">    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">javadocJar</span><span class="params">(type: Jar, dependsOn: javadoc)</span> </span>&#123;</div><div class="line">    classifier = <span class="string">'javadoc'</span></div><div class="line">    from javadoc.destinationDir</div><div class="line">&#125;</div><div class="line">artifacts &#123;</div><div class="line">    archives javadocJar</div><div class="line">    archives sourcesJar</div><div class="line">&#125;</div><div class="line"></div><div class="line">Properties properties = <span class="keyword">new</span> Properties()</div><div class="line">properties.load(project.rootProject.file(<span class="string">'local.properties'</span>).newDataInputStream())</div><div class="line"></div><div class="line"><span class="comment">// https://github.com/bintray/gradle-bintray-plugin</span></div><div class="line">bintray &#123;</div><div class="line">    user = properties.getProperty(<span class="string">"bintray.user"</span>)</div><div class="line">    key = properties.getProperty(<span class="string">"bintray.apikey"</span>)</div><div class="line"></div><div class="line">    configurations = [<span class="string">'archives'</span>]</div><div class="line">    pkg &#123;</div><div class="line">        repo = <span class="string">"maven"</span></div><div class="line">        <span class="comment">// it is the name that appears in bintray when logged</span></div><div class="line">        name = <span class="string">"cyberlink-android"</span></div><div class="line">        websiteUrl = siteUrl</div><div class="line">        vcsUrl = gitUrl</div><div class="line">        licenses = [<span class="string">"Apache-2.0"</span>]</div><div class="line">        publish = <span class="keyword">true</span></div><div class="line">        version &#123;</div><div class="line">            gpg &#123;</div><div class="line">                sign = <span class="keyword">true</span> <span class="comment">//Determines whether to GPG sign the files. The default is false</span></div><div class="line">                passphrase = properties.getProperty(<span class="string">"bintray.gpg.password"</span>) <span class="comment">//Optional. The passphrase for GPG signing'</span></div><div class="line">            &#125;</div><div class="line"><span class="comment">//            mavenCentralSync &#123;</span></div><div class="line"><span class="comment">//                sync = true //Optional (true by default). Determines whether to sync the version to Maven Central.</span></div><div class="line"><span class="comment">//                user = properties.getProperty("bintray.oss.user") //OSS user token</span></div><div class="line"><span class="comment">//                password = properties.getProperty("bintray.oss.password") //OSS user password</span></div><div class="line"><span class="comment">//                close = '1' //Optional property. By default the staging repository is closed and artifacts are released to Maven Central. You can optionally turn this behaviour off (by puting 0 as value) and release the version manually.</span></div><div class="line"><span class="comment">//            &#125;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这一步就可以开始上传到<code>bintray</code>了，接下来开启<code>Android Studio</code>的<code>Terminal</code>中。</p>
<ul>
<li>检查代码的正确性，以及编译<code>library</code>文件(<code>aar</code>,<code>pom</code>等)。执行如下命令:<br>  <code>./gradlew install</code>如果提示权限不足就用<code>chmod 777 gradlew</code>改下权限就好了，windows下直接运行<code>gradlew install</code><br>  正确的话会提示<code>BUILD SUCCESSFUL</code></li>
<li>上传编译的文件到<code>bintray</code>，使用如下命令:<br>  <code>./gradlew bintrayUpload</code><br>  成功的话会提示<code>SUCCESSFUL</code><br>接下来到<code>bintray</code>上检查一下你得<code>package</code>你会在版本区域发现新上传的版本。点击进去就能发现我们上传的<code>library</code>文件。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/publish_version.png?raw=true" alt="image"></li>
</ul>
<p>点击该版本进入后可以看到所有的文件目录。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/version_list.png?raw=true" alt="image"></p>
<p>到这里你的<code>library</code>就已经上传了，任何人都可以使用，但是别高兴的太早，因为现在只是上传到了你自己的私人<code>Maven</code>仓库，而不是<code>jCenter</code>上，如果别人使用你<code>library</code>，他必须要先定义仓库的<code>url</code>， 如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">repositories &#123;</div><div class="line">    maven &#123;</div><div class="line">        url <span class="string">'https://dl.bintray.com/charonchui/maven/'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">...</div><div class="line">  </div><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.charonchui.cyberlink:cyberlink-android:1.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样终究是不方便的，因为别人还要单独的去配置你仓库的<code>url</code>那么接下来就是怎么将<code>bintray</code>上我们的仓库上传到<code>jCenter</code>中呢？<br>把<code>library</code>同步到<code>jCenter</code>上非常容易。只需要访问<code>bintray</code>，然后点击<code>Add to jCeter</code>然后在新出来的页面直接点击<code>Send</code>即可。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/add_to_jcenter.png?raw=true" alt="image"><br>现在我们就需要等待<code>bintray</code>团队审核我们的请求，一般会在两三个小时左右，如果审核通过，会收到一封邮件通知。通过这一步之后任何开发者都可以不用配置仓库<code>url</code>直接使用了。<br>想检查一下自己的<code>library</code>是否在<code>jCenter</code>上存在，可以直接访问<a href="http://jcenter.bintray.com" target="_blank" rel="external">http://jcenter.bintray.com</a>,然后根据你的<code>groupId</code>直接进入相应的目录查看即可。这里要说一下，这个链接到<code>jCenter</code>是一个只需要做一次的操作，如果以后对你的<code>package</code>做了修改，或者发布新版本等，这些改变会自动同步到<code>jCenter</code>上。同时，如果你要像删除某一个<code>package</code>，但是在<code>jCenter</code>仓库中的<code>library</code>不会被删除。它会一直存在，没法直接删除，因此如果你想要完全删除的时候，最好在移除<code>package</code>之前先在网页上把删除每个版本。<br>如何通过后也可以在<code>bintray</code>上面看到，这里已经不显示<code>Add to jCenter</code>按钮了，他会直接显示出来<code>jCenter</code>.<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/already_add_to_jcenter.png?raw=true" alt="image"></p>
<p>到这里你就可以在项目中直接使用:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.charonchui.cyberlink:cyberlink-android:1.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是，我悲剧了。提示失败了，为什么呢？　<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/library_name_error.png?raw=true" alt="image">　　　　　　　　　　　　　　　　　<br>原因就出来<code>library</code>这个<code>module name</code>这里，因为我这里的<code>module</code>那么是<code>library</code>所以它上传之后的路径就是<code>library</code>而不是<code>cyberlink-android</code>:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/libray_name_error_path.png?raw=true" alt="image">　　<br>所以通过这里能看出来它是使用当前<code>module</code>的名字的。我们只能通过如下方式去使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.charonchui.cyberlink:library:1.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就能正常使用了。 如果有些人感觉这样不好，就想要<code>com.charonchui.cyberlink:cyberlink-android:1.0.0</code>的方式，那就将<code>Android Studio</code>中<code>library</code>的名字修改为<code>cyberlink-android</code>后重新上传发布吧。</p>
<h2 id="最后一步-上传library到Maven-Central"><a href="#最后一步-上传library到Maven-Central" class="headerlink" title="最后一步:上传library到Maven Central      "></a>最后一步:上传library到Maven Central      </h2><p>并不是所有的开发者都使用<code>jCenter</code>。仍然会有一些人在使用<code>Maven Central</code>。因为此我们仍然需要将<code>library</code>上传到<code>Maven Central</code>上。要从<code>jCenter</code>中上传到<code>Maven Central</code>之前需要先完成以下两部分:      </p>
<ul>
<li><code>Bintray</code>上的<code>pacage</code>已经链接到<code>jCenter</code>.</li>
<li><code>Maven Central</code>上的仓库已经认证通过.</li>
</ul>
<p>如果确认已经完成上面的授权后，上传<code>library</code>到<code>Maven Central</code>就非常简单了，只需要在<code>package</code>的详情页面点击<code>Maven Central</code>的链接。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/publish_to_maven_central.png?raw=true" alt="image"><br>直接进入下一个页面:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/send_to_maven.png?raw=true" alt="image"><br>然后再出来的页面输入<code>Maven Central</code>对应的用户名和密码点击<code>Sync</code>就可以了。上传到<code>Maven Central</code>的<code>library</code>是非常严格的，比如<code>+</code>号是不能在<code>library</code>版本的依赖定义中使用的。<br>完成之后，你可以在 <a href="https://oss.sonatype.org/content/repositories/releases/" target="_blank" rel="external">Maven Central Repository</a>中找到你的<code>library</code>。</p>
<p>总结下在使用过程中遇到的错误: </p>
<ul>
<li><p>Maven gradle插件与gradle版本要对应好，如下，不要不对应。</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// Top-level build file where you can add configuration options common to all sub-projects/modules.</div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath 'com.android.tools.build:gradle:1.3.0'</div><div class="line">        // 用于上传项目到bintray</div><div class="line">        classpath 'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.2'</div><div class="line">        // 用于生成javaDoc和jar</div><div class="line">        classpath 'com.github.dcendents:android-maven-gradle-plugin:1.3'</div><div class="line">        // NOTE: Do not place your application dependencies here; they belong</div><div class="line">        // in the individual module build.gradle files</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>windows</code>下执行<code>gradlew install</code>编译<code>javadoc</code>时会提示<code>GBK</code>编码错误，这时候需要修改编译时的编码，具体放狗搜下，当时我改在<code>mac</code>上用了，就没解决。</p>
</li>
<li>编译生成<code>javadoc</code>时提示很多找不到类，不能使用<code>&lt;br/&gt;</code>等错误，这里建议在写注释的时候一定要规范，不要使用汉字，而且不要使用<code>&lt;br/&gt;</code>，<code>&lt;p&gt;</code>等。</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/发布library到Maven仓库/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-布局优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/布局优化/">布局优化</a>
    </h1>
  

        
        <a href="/2015/01/01/布局优化/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="布局优化"><a href="#布局优化" class="headerlink" title="布局优化"></a>布局优化</h1><ul>
<li><p>去除不必要的嵌套和节点<br>  这是最基本的一条，但也是最不好做到的一条，往往不注意的时候难免会一些嵌套等。    </p>
<ul>
<li>首次不需要的节点设置为<code>GONE</code>或使用<code>ViewStud</code>.       </li>
<li>使用<code>Relativelayout</code>代替<code>LinearLayout</code>.<br>平时写布局的时候要多注意，写完后可以通过<code>Hierarchy Viewer</code>或在手机上通过开发者选项中的显示布局边界来查看是否有不必要的嵌套。</li>
</ul>
</li>
<li><p>使用<code>include</code><br>  <code>include</code>可以用于将布局中一些公共的部分提取出来。在需要的时候使用即可，比喻一些页面统一的<code>loading</code>页。<br>   <code>include</code>标签的<code>layout</code>属性指定所要包含的布局文件，我们也可以通过<code>android:id</code>或者一些其他的属性来覆盖被引入布局的根节点所对应<br>的属性值。      </p>
   <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">include</span></span></div><div class="line"><span class="attr">layout</span>=<span class="string">"@layout/loading"</span></div><div class="line"><span class="attr">android:id</span>=<span class="string">"@+id/loading_main"</span> /&gt;</div></pre></td></tr></table></figure>
<p>  <code>loading.xml</code>内容为：    </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">ProgressBar</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/pb_loadiing"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"28dip"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"28dip"</span></div><div class="line">		<span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span></div><div class="line">		<span class="attr">android:indeterminateDrawable</span>=<span class="string">"@drawable/progressbar_anim_drawable"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:layout_below</span>=<span class="string">"@id/pb_loadiing"</span></div><div class="line">		<span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></div><div class="line">		<span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:text</span>=<span class="string">"loading..."</span></div><div class="line">		<span class="attr">android:textSize</span>=<span class="string">"15sp"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>使用<code>&lt;merge&gt;</code>标签<br>  <code>merge</code>可以有效的解决布局的层级关系。我们通过一个例子来说明一下：            </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span>&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line"></div><div class="line">		<span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">		<span class="attr">android:src</span>=<span class="string">"@drawable/ic_launcher"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_marginBottom</span>=<span class="string">"20dip"</span></div><div class="line">		<span class="attr">android:textSize</span>=<span class="string">"22sp"</span></div><div class="line">		<span class="attr">android:textColor</span>=<span class="string">"#990000"</span></div><div class="line">		<span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal|bottom"</span></div><div class="line">		<span class="attr">android:text</span>=<span class="string">"TEST"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  我们在一个页面中显示该部分内容，运行后观察<code>Hierarchy Viewer</code>。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/merge_1.png" alt="image"><br>  我们会发现除了我们布局最外层还会有一层<code>FrameLayout</code>，这是因为<code>Activity</code>内容视图的<code>parent view</code>就是一个<code>FrameLayout</code>，所以对于我们来说无意中已经多了一层毫无意义的布局。<br>  接下来<code>merge</code>的功能就能发挥了，修改代码如下。              </p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">merge</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">		<span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">		<span class="attr">android:src</span>=<span class="string">"@drawable/ic_launcher"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">		<span class="attr">android:layout_marginBottom</span>=<span class="string">"20dip"</span></div><div class="line">		<span class="attr">android:textSize</span>=<span class="string">"22sp"</span></div><div class="line">		<span class="attr">android:textColor</span>=<span class="string">"#990000"</span></div><div class="line">		<span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal|bottom"</span></div><div class="line">		<span class="attr">android:text</span>=<span class="string">"TEST"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">merge</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  接下来我们在用<code>Hierarchy Viewer</code>观察就会发现完美的去掉了一层<code>FrameLayout</code><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/merge_2.png" alt="image"><br>  当然上面我们使用<code>merge</code>是因为跟布局正好是<code>FrameLayout</code>并且没有<code>backgroud</code>和<code>padding</code>等这些属性。如果根本局是<code>LinearLayout</code>等，就没法直接使用<code>merge</code>了。<br>  在<code>include</code>的时候很容易造成布局层级嵌套过多，结合<code>merge</code>使用能有效解决这个问题。</p>
</li>
<li><p>使用<code>ViewStub</code><br>  <code>ViewStub</code>标签与<code>include</code>一样可以用来引入一个外部布局，但是<code>Viewstub</code>引入的布局默认不会解析与显示，宽高为0，<code>View</code>也为<code>null</code>,这样就会在解析<code>layout</code>时节省<code>cpu</code>和内存。简单的理解就是<code>ViewStub</code>是<br><code>include</code>加上<code>GONE</code>.<code>ViewStub</code>常用来引入那些默认不会显示，只在特殊情况下显示的布局，如进度布局、网络失败显示的刷新布局、信息出错出现的提示布局等.</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">	<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">	<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> &gt;</div><div class="line"></div><div class="line">	……</div><div class="line">	<span class="tag">&lt;<span class="name">ViewStub</span></span></div><div class="line">		<span class="attr">android:id</span>=<span class="string">"@+id/network_unreachble"</span></div><div class="line">		<span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">		<span class="attr">android:layout</span>=<span class="string">"@layout/network_unreachble"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  在代码中通过<code>(ViewStub)findViewById(id)</code>找到<code>ViewStub</code>，使用<code>inflate()</code>展开<code>ViewStub</code>,然后得到子<code>View</code>，如下：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> View mNetErrorView;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNetError</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mNetErrorView != <span class="keyword">null</span>) &#123;</div><div class="line">		mNetErrorView.setVisibility(View.VISIBLE);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ViewStub stub = (ViewStub)findViewById(R.id.network_unreachble);</div><div class="line">	<span class="comment">// 解析并且显示该部分，返回值就是解析后的该`View`</span></div><div class="line">	mNetErrorView = stub.inflate();</div><div class="line">	Button networkSetting = (Button)mNetErrorView.findViewById(R.id.bt_network);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNormal</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mNetErrorView != <span class="keyword">null</span>) &#123;</div><div class="line">		mNetErrorView.setVisibility(View.GONE);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  或者也可以通过第二种方式:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">View viewStub = findViewById(R.id.network_unreachble);</div><div class="line"><span class="comment">// ViewStub被展开后的布局所替换</span></div><div class="line">viewStub.setVisibility(View.VISIBLE);   </div><div class="line"><span class="comment">// 获取展开后的布局</span></div><div class="line">mNetErrorView =  findViewById(R.id.network_unreachble);</div></pre></td></tr></table></figure>
</li>
<li><p>减少不必要的<code>Inflate</code><br>  如上一步中<code>stub.infalte()</code>后将该<code>View</code>进行记录或者是<code>ListView</code>中<code>item inflate</code>的时候。</p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/布局优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-屏幕适配之百分比方案详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/屏幕适配之百分比方案详解/">屏幕适配之百分比方案详解</a>
    </h1>
  

        
        <a href="/2015/01/01/屏幕适配之百分比方案详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="屏幕适配之百分比方案详解"><a href="#屏幕适配之百分比方案详解" class="headerlink" title="屏幕适配之百分比方案详解"></a>屏幕适配之百分比方案详解</h1><p><code>Android</code>设备碎片化十分严重，在开发过程中的适配工作也非常很繁琐，有关屏幕适配的介绍请看之前的文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%9F%BA%E7%A1%80/%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D.md">屏幕适配</a>。</p>
<p>最近看到<code>DrawerLayout</code>，<code>support v4</code>中提供的类，想到对<code>google</code>提供的这些支持库，自己一点都不熟悉，想着看看<code>Google</code>提供的支持库都有什么内容。结果看着看着在最后忽然看到了<code>Percent Support Library</code>。寻思怎么还百分比呢？仔细一看介绍，我擦，真是太有用了。</p>
<blockquote>
<p>###Percent Support Library<br>The Percent package provides APIs to support adding and managing percentage based dimensions in your app.</p>
<p>The Percent Support library adds support for the PercentLayoutHelper.PercentLayoutParams interface and various classes, such as PercentFrameLayout and PercentRelativeLayout.</p>
<p>After you download the Android Support Libraries, this library is located in the <sdk>/extras/android/support/percent directory. For more information on how to set up your project, follow the instructions in Adding libraries with resources.</sdk></p>
<p>The Gradle build script dependency identifier for this library is as follows:<br><code>com.android.support:percent:23.3.0</code></p>
</blockquote>
<p>看到了吗？ 说提供了<code>PercentFrameLayout</code>和<code>PercentRelativeLayout</code>来支持百分比了。这样不就完美的解决了适配的问题嘛。啥也不说了，立马配置<code>cradle</code>来瞧瞧。   </p>
<blockquote>
<p>Subclass of FrameLayout that supports percentage based dimensions and margins. You can specify dimension or a margin of child by using attributes with “Percent” suffix. </p>
</blockquote>
<p>上代码:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.percent.PercentFrameLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">app:layout_widthPercent</span>=<span class="string">"50%"</span></div><div class="line">        <span class="attr">app:layout_heightPercent</span>=<span class="string">"50%"</span></div><div class="line">        <span class="attr">app:layout_marginTopPercent</span>=<span class="string">"25%"</span></div><div class="line">        <span class="attr">app:layout_marginLeftPercent</span>=<span class="string">"25%"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.percent.PercentFrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果如下:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/percent_frame.png?raw=true" alt="image"><br>完美.   </p>
<p>支持的属性:    </p>
<ul>
<li><code>layout_widthPercent</code></li>
<li><code>layout_heightPercent</code></li>
<li><code>layout_marginPercent</code></li>
<li><code>layout_marginLeftPercent</code></li>
<li><code>layout_marginTopPercent</code></li>
<li><code>layout_marginRightPercent</code></li>
<li><code>layout_marginBottomPercent</code></li>
<li><code>layout_marginStartPercent</code></li>
<li><code>layout_marginEndPercent</code></li>
<li><code>layout_aspectRatio</code></li>
</ul>
<blockquote>
<p>It is not necessary to specify layout_width/height if you specify layout_widthPercent. However, if you want the view to be able to take up more space than what percentage value permits, you can add layout_width/height=”wrap_content”. In that case if the percentage size is too small for the View’s content, it will be resized using wrap_content rule.</p>
</blockquote>
<p>如果指定了<code>layout_widthPercent</code>就不用指定<code>layout_width/height</code>属性了。(<code>Studio</code>可能会提示错误，设置忽略就好)。然而，如果你想要该<code>View</code>能够占用比设置的百分比值更大的空间时，你可以指定<code>layout_widht/height=“wrap_content”</code>。在这种情况下，如果设置的百分比值在显示内容时太小时，将会使用<code>wrap_content</code>的值重新计算。</p>
<p>就是这个意思:如果指定的百分比太小怕显示不开的话，也可以给它指定<code>wrap_content</code>属性，这样当显示不开的时候就会使用<code>wrap_content</code>的值。<br>如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.percent.PercentFrameLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"顶顶顶顶顶大大大"</span></div><div class="line">        <span class="attr">android:textSize</span>=<span class="string">"30dp"</span></div><div class="line">        <span class="attr">android:singleLine</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">app:layout_widthPercent</span>=<span class="string">"30%"</span></div><div class="line">        <span class="attr">app:layout_heightPercent</span>=<span class="string">"5%"</span></div><div class="line">        <span class="attr">app:layout_marginTopPercent</span>=<span class="string">"25%"</span></div><div class="line">        <span class="attr">app:layout_marginLeftPercent</span>=<span class="string">"25%"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.percent.PercentFrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/percent_wrap.png?raw=true" alt="image">    </p>
<p>加入<code>wrap_content</code>后一点效果也没有啊，还是显示不全啊，和没加<code>wrap_content</code>一样，- -!</p>
<p>你也可以通过只设置<code>width</code>或者<code>height</code>和<code>layout_aspectRatio</code>这种比例值的方式来让第另一个值自动计算。例如，如果你想要使用<code>16:9</code>的比例，你可以使用:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">android:layout_width="300dp"</div><div class="line">app:layout_aspectRatio="178%"</div></pre></td></tr></table></figure></p>
<p>这样将会在宽固定为<code>300dp</code>的基础上以16:9(1.78:1)来计算高度。</p>
<p><code>PercentRelativeLayout</code>的使用都是一样的，这里就不贴了。   </p>
<p>那它是怎么实现的呢？其实就是内部给通过属性换算，把本布局的宽高和百分比去计算每个<code>view</code>的大小和位置。但是还有为什么上面设置的<code>wrap_content</code>无效呢？是我理解错了吗？</p>
<p>带着这两个疑问我们来看下源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PercentFrameLayout</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PercentLayoutHelper mHelper = <span class="keyword">new</span> PercentLayoutHelper(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> LayoutParams <span class="title">generateDefaultLayoutParams</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(getContext(), attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        mHelper.adjustChildren(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="comment">// 从名字上就能看出来下面就是处理如果指定百分比过小不足显示内容时，就去使用`wrap_content`的逻辑</span></div><div class="line">        <span class="keyword">if</span> (mHelper.handleMeasuredStateTooSmall()) &#123;</div><div class="line">            <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">        mHelper.restoreOriginalParams();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LayoutParams</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span>.<span class="title">LayoutParams</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">PercentLayoutHelper</span>.<span class="title">PercentLayoutParams</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> PercentLayoutHelper.PercentLayoutInfo mPercentLayoutInfo;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(Context c, AttributeSet attrs)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(c, attrs);</div><div class="line">            <span class="comment">// PercentLayoutInfo中去解析自定义属性的值</span></div><div class="line">            mPercentLayoutInfo = PercentLayoutHelper.getPercentLayoutInfo(c, attrs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> gravity)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height, gravity);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(ViewGroup.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(MarginLayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(FrameLayout.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>((MarginLayoutParams) source);</div><div class="line">            gravity = source.gravity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>((FrameLayout.LayoutParams) source);</div><div class="line">            mPercentLayoutInfo = source.mPercentLayoutInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> PercentLayoutHelper.<span class="function">PercentLayoutInfo <span class="title">getPercentLayoutInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mPercentLayoutInfo == <span class="keyword">null</span>) &#123;</div><div class="line">                mPercentLayoutInfo = <span class="keyword">new</span> PercentLayoutHelper.PercentLayoutInfo();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> mPercentLayoutInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setBaseAttributes</span><span class="params">(TypedArray a, <span class="keyword">int</span> widthAttr, <span class="keyword">int</span> heightAttr)</span> </span>&#123;</div><div class="line">            PercentLayoutHelper.fetchWidthAndHeight(<span class="keyword">this</span>, a, widthAttr, heightAttr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>源码不长，主要是三个部分:    </p>
<ul>
<li>重写<code>onMeasure</code>，根据百分比转换成对应的尺寸</li>
<li>重写<code>onLayout</code></li>
<li>自定义<code>LayoutParams</code>，在<code>FrameLayout.LayoutParams</code>的基础上多实现了一个接口。包含了<code>PercentLayoutHelper.PercentLayoutInfo</code>属性，而文档中对<code>PercentLayoutInfo</code>的介绍是<code>Container for information about percentage dimensions and margins. It acts as an extension for LayoutParams.</code></li>
</ul>
<p>我们也先一步步的来分析，首先看下<code>mHelper.adjustChildren(widthMeasureSpec, heightMeasureSpec);</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and changes their width and height to one calculated from percentage</div><div class="line"> * values.</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Width MeasureSpec of the parent ViewGroup.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Height MeasureSpec of the parent ViewGroup.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"adjustChildren: "</span> + mHost + <span class="string">" widthMeasureSpec: "</span></div><div class="line">                + View.MeasureSpec.toString(widthMeasureSpec) + <span class="string">" heightMeasureSpec: "</span></div><div class="line">                + View.MeasureSpec.toString(heightMeasureSpec));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> widthHint = View.MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">    <span class="keyword">int</span> heightHint = View.MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">    <span class="comment">// mHost是由构造函数传递过来的，就是PercentFrameLayout自身。</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should adjust "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            <span class="comment">// 通过PercentLayoutParams. getPercentLayoutInfo()方法得到PercentLayoutInfo，至于PercentLayoutInfo类在上面也说过了。</span></div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"using "</span> + info);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">                    <span class="comment">// PercentFrameLayout.LayoutParams继承自FrameLayout.LayoutParams，而FrameLayout.LayoutParams又继承自ViewGroup.MarginLayoutParams</span></div><div class="line">                    info.fillMarginLayoutParams(view, (ViewGroup.MarginLayoutParams) params,</div><div class="line">                            widthHint, heightHint);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    info.fillLayoutParams(params, widthHint, heightHint);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以上面代码的意思就是通过对每个子<code>View</code>调用<code>getLayoutParams</code>方法，然后从该<code>LayoutParams</code>中获取到它的<code>PercentLayoutInfo</code>属性，然后再调用<code>PercentLayoutInfo.fillMarginLayoutParams()</code>方法。</p>
<p>那我们继续看一下<code>PercentLayoutInfo.fillMarginLayoutParams()</code>方法的实现，该方法是根据百分比去设置尺寸和margin:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills &#123;<span class="doctag">@code</span> ViewGroup.MarginLayoutParams&#125; dimensions and margins based on percentage</div><div class="line"> * values.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillMarginLayoutParams</span><span class="params">(View view, ViewGroup.MarginLayoutParams params,</span></span></div><div class="line">        <span class="keyword">int</span> widthHint, <span class="keyword">int</span> heightHint) &#123;</div><div class="line">    <span class="comment">// 根据百分比值设置View的尺寸</span></div><div class="line">    fillLayoutParams(params, widthHint, heightHint);</div><div class="line"></div><div class="line">    <span class="comment">// 从注释中就能知道，fillLayoutParams是计算尺寸，那下面这部分就是处理margin了</span></div><div class="line">    <span class="comment">// mPreservedParams来记录原始的margin值</span></div><div class="line">    <span class="comment">// Preserve the original margins, so we can restore them after the measure step.</span></div><div class="line">    mPreservedParams.leftMargin = params.leftMargin;</div><div class="line">    mPreservedParams.topMargin = params.topMargin;</div><div class="line">    mPreservedParams.rightMargin = params.rightMargin;</div><div class="line">    mPreservedParams.bottomMargin = params.bottomMargin;</div><div class="line">    MarginLayoutParamsCompat.setMarginStart(mPreservedParams,</div><div class="line">            MarginLayoutParamsCompat.getMarginStart(params));</div><div class="line">    MarginLayoutParamsCompat.setMarginEnd(mPreservedParams,</div><div class="line">            MarginLayoutParamsCompat.getMarginEnd(params));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (leftMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.leftMargin = (<span class="keyword">int</span>) (widthHint * leftMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (topMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.topMargin = (<span class="keyword">int</span>) (heightHint * topMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (rightMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.rightMargin = (<span class="keyword">int</span>) (widthHint * rightMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (bottomMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.bottomMargin = (<span class="keyword">int</span>) (heightHint * bottomMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">boolean</span> shouldResolveLayoutDirection = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (startMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        MarginLayoutParamsCompat.setMarginStart(params,</div><div class="line">                (<span class="keyword">int</span>) (widthHint * startMarginPercent));</div><div class="line">        shouldResolveLayoutDirection = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (endMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        MarginLayoutParamsCompat.setMarginEnd(params,</div><div class="line">                (<span class="keyword">int</span>) (widthHint * endMarginPercent));</div><div class="line">        shouldResolveLayoutDirection = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (shouldResolveLayoutDirection &amp;&amp; (view != <span class="keyword">null</span>)) &#123;</div><div class="line">        <span class="comment">// Force the resolve pass so that start / end margins are propagated to the</span></div><div class="line">        <span class="comment">// matching left / right fields</span></div><div class="line">        MarginLayoutParamsCompat.resolveLayoutDirection(params,</div><div class="line">                ViewCompat.getLayoutDirection(view));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"after fillMarginLayoutParams: ("</span> + params.width + <span class="string">", "</span> + params.height</div><div class="line">                + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>PercentLayoutInfo.fillLayoutParams()</code>的实现，该方法是通过百分比设置<code>View</code>的尺寸:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills &#123;<span class="doctag">@code</span> ViewGroup.LayoutParams&#125; dimensions based on percentage values.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillLayoutParams</span><span class="params">(ViewGroup.LayoutParams params, <span class="keyword">int</span> widthHint,</span></span></div><div class="line">        <span class="keyword">int</span> heightHint) &#123;</div><div class="line">    <span class="comment">// mPreservedParams来记录原始的宽高值</span></div><div class="line">    <span class="comment">// Preserve the original layout params, so we can restore them after the measure step.</span></div><div class="line">    mPreservedParams.width = params.width;</div><div class="line">    mPreservedParams.height = params.height;</div><div class="line"></div><div class="line">    <span class="comment">// We assume that width/height set to 0 means that value was unset. This might not</span></div><div class="line">    <span class="comment">// necessarily be true, as the user might explicitly set it to 0. However, we use this</span></div><div class="line">    <span class="comment">// information only for the aspect ratio. If the user set the aspect ratio attribute,</span></div><div class="line">    <span class="comment">// it means they accept or soon discover that it will be disregarded.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> widthNotSet =</div><div class="line">            (mPreservedParams.mIsWidthComputedFromAspectRatio</div><div class="line">                    || mPreservedParams.width == <span class="number">0</span>) &amp;&amp; (widthPercent &lt; <span class="number">0</span>);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> heightNotSet =</div><div class="line">            (mPreservedParams.mIsHeightComputedFromAspectRatio</div><div class="line">                    || mPreservedParams.height == <span class="number">0</span>) &amp;&amp; (heightPercent &lt; <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 如果指定了百分比属性，就用宽高值和百分比去算出具体的宽高</span></div><div class="line">    <span class="keyword">if</span> (widthPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 看到了吗？是根据父`View	`的宽高来乘以百分比，不是根据整个屏幕的宽高，这样可能会有问题，要是ListView这种的高度没法算了</span></div><div class="line">        params.width = (<span class="keyword">int</span>) (widthHint * widthPercent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (heightPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.height = (<span class="keyword">int</span>) (heightHint * heightPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果指定了宽高的比例值，就用比例值去算出宽高，从这里能看出`aspectRatio`的优先级比百分比要高。他可以覆盖百分比之前设置的值。</span></div><div class="line">    <span class="keyword">if</span> (aspectRatio &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (widthNotSet) &#123;</div><div class="line">            params.width = (<span class="keyword">int</span>) (params.height * aspectRatio);</div><div class="line">            <span class="comment">// Keep track that we've filled the width based on the height and aspect ratio.</span></div><div class="line">            mPreservedParams.mIsWidthComputedFromAspectRatio = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (heightNotSet) &#123;</div><div class="line">            params.height = (<span class="keyword">int</span>) (params.width / aspectRatio);</div><div class="line">            <span class="comment">// Keep track that we've filled the height based on the width and aspect ratio.</span></div><div class="line">            mPreservedParams.mIsHeightComputedFromAspectRatio = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"after fillLayoutParams: ("</span> + params.width + <span class="string">", "</span> + params.height + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">```    </div><div class="line"></div><div class="line">到这里`onMeasure`中通过百分比值设置宽高以及`margin`的部分就看完了，那我们接着看一下关于百分比值过小时对`wrap_content`的处理:     </div><div class="line">```<span class="function">java</span></div><div class="line"><span class="title">if</span> <span class="params">(mHelper.handleMeasuredStateTooSmall()</span>) &#123;</div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看一下<code>PercentLayoutHelper.handleMeasuredStateTooSmall()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and checks if any of them would like to get more space than it</div><div class="line"> * received through the percentage dimension.</div><div class="line"> *</div><div class="line"> * If you are building a layout that supports percentage dimensions you are encouraged to take</div><div class="line"> * advantage of this method. The developer should be able to specify that a child should be</div><div class="line"> * remeasured by adding normal dimension attribute with &#123;<span class="doctag">@code</span> wrap_content&#125; value. For example</div><div class="line"> * he might specify child's attributes as &#123;<span class="doctag">@code</span> app:layout_widthPercent="60%p"&#125; and</div><div class="line"> * &#123;<span class="doctag">@code</span> android:layout_width="wrap_content"&#125;. In this case if the child receives too little</div><div class="line"> * space, it will be remeasured with width set to &#123;<span class="doctag">@code</span> WRAP_CONTENT&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> True if the measure phase needs to be rerun because one of the children would like</div><div class="line"> * to receive more space.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMeasuredStateTooSmall</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> needsSecondMeasure = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should handle measured state too small "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// shouldHandleMeasuredWidthTooSmall方法来进行判断</span></div><div class="line">                <span class="keyword">if</span> (shouldHandleMeasuredWidthTooSmall(view, info)) &#123;</div><div class="line">                    needsSecondMeasure = <span class="keyword">true</span>;</div><div class="line">                    params.width = ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (shouldHandleMeasuredHeightTooSmall(view, info)) &#123;</div><div class="line">                    needsSecondMeasure = <span class="keyword">true</span>;</div><div class="line">                    params.height = ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"should trigger second measure pass: "</span> + needsSecondMeasure);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> needsSecondMeasure;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那继续看一下<code>shouldHandleMeasuredWidthTooSmall()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldHandleMeasuredWidthTooSmall</span><span class="params">(View view, PercentLayoutInfo info)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> state = ViewCompat.getMeasuredWidthAndState(view) &amp; ViewCompat.MEASURED_STATE_MASK;</div><div class="line">    <span class="keyword">return</span> state == ViewCompat.MEASURED_STATE_TOO_SMALL &amp;&amp; info.widthPercent &gt;= <span class="number">0</span> &amp;&amp;</div><div class="line">            info.mPreservedParams.width == ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>ViewCompat.getMeasuredWidthAndState()</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMeasuredWidthAndState</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> IMPL.getMeasuredWidthAndState(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续往下看，这个<code>IMPL</code>是什么呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ViewCompatImpl IMPL;</div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> version = android.os.Build.VERSION.SDK_INT;</div><div class="line">    <span class="keyword">if</span> (version &gt;= <span class="number">23</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> MarshmallowViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">21</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> LollipopViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">19</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> KitKatViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">17</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> JbMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">16</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> JBViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">15</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> ICSMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">14</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> ICSViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">11</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> HCViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">9</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> GBViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">7</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> EclairMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> BaseViewCompatImpl();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看，<code>IMPL.getMeasuredWidthAndState()</code>，方法其实最终就是使用的<code>BaseViewCompatImpl.getMeasuredWidthAndState()</code>方法，接着看它的的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMeasuredWidthAndState</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> view.getMeasuredWidth();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>最后就是调用了<code>getMeasuredWidth()</code>方法。  没毛病- -!</p>
<p><code>onMeasure</code>的到这里就分析完了。<br>那接着来看一下<code>onLayout</code>方法,<code>onLayout</code>方法直接调用了<code>PercentLayoutHelper.restoreOriginalParams</code>，:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and restores their original dimensions that were changed for</div><div class="line"> * percentage values. Calling this method only makes sense if you previously called</div><div class="line"> * &#123;<span class="doctag">@link</span> PercentLayoutHelper#adjustChildren(int, int)&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreOriginalParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should restore "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"using "</span> + info);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">                    info.restoreMarginLayoutParams((ViewGroup.MarginLayoutParams) params);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    info.restoreLayoutParams(params);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用了<code>PercentLayoutInfo.restoreMarginLayoutParams()</code>方法，我们看下它的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Restores original dimensions and margins after they were changed for percentage based</div><div class="line"> * values. Calling this method only makes sense if you previously called</div><div class="line"> * &#123;<span class="doctag">@link</span> PercentLayoutHelper.PercentLayoutInfo#fillMarginLayoutParams&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreMarginLayoutParams</span><span class="params">(ViewGroup.MarginLayoutParams params)</span> </span>&#123;</div><div class="line">    restoreLayoutParams(params);</div><div class="line">    <span class="comment">// mPreservedParams的值在之前ad</span></div><div class="line">    params.leftMargin = mPreservedParams.leftMargin;</div><div class="line">    params.topMargin = mPreservedParams.topMargin;</div><div class="line">    params.rightMargin = mPreservedParams.rightMargin;</div><div class="line">    params.bottomMargin = mPreservedParams.bottomMargin;</div><div class="line">    MarginLayoutParamsCompat.setMarginStart(params,</div><div class="line">            MarginLayoutParamsCompat.getMarginStart(mPreservedParams));</div><div class="line">    MarginLayoutParamsCompat.setMarginEnd(params,</div><div class="line">            MarginLayoutParamsCompat.getMarginEnd(mPreservedParams));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>意思是说，再他们被以百分比为基础的数据更改之后恢复成原始的尺寸和margin。<br>然后继续看一下<code>restoreLayoutParams()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Restores original dimensions after they were changed for percentage based values. Calling</div><div class="line">* this method only makes sense if you previously called</div><div class="line">* &#123;<span class="doctag">@link</span> PercentLayoutHelper.PercentLayoutInfo#fillLayoutParams&#125;.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreLayoutParams</span><span class="params">(ViewGroup.LayoutParams params)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mPreservedParams.mIsWidthComputedFromAspectRatio) &#123;</div><div class="line">        <span class="comment">// Only restore the width if we didn't compute it based on the height and</span></div><div class="line">        <span class="comment">// aspect ratio in the fill pass.</span></div><div class="line">        params.width = mPreservedParams.width;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!mPreservedParams.mIsHeightComputedFromAspectRatio) &#123;</div><div class="line">        <span class="comment">// Only restore the height if we didn't compute it based on the width and</span></div><div class="line">        <span class="comment">// aspect ratio in the fill pass.</span></div><div class="line">        params.height = mPreservedParams.height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Reset the tracking flags.</span></div><div class="line">    mPreservedParams.mIsWidthComputedFromAspectRatio = <span class="keyword">false</span>;</div><div class="line">    mPreservedParams.mIsHeightComputedFromAspectRatio = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了到这里也分析完了<code>onLayout</code>的方法，大意就是在<code>onMeasure</code>之前先将原始的宽高和<code>margin</code>都备份一下，然后在<code>onMeasure</code>中根据百分比去设置对应的宽高和<code>margin</code>，等到设置完之后在<code>onLayout</code>方法中再去将这些值恢复到之前备份的起始数据。说实话我没看明白为什么要这样做？</p>
<p>通过上面的代码分析我们知道对布局影响力的优先顺序: <code>app:layout_aspectRatio &gt; app:layout_heightPercent &gt; android:layout_height</code>如果我们同时都设置这三个参数值的话，最终会用<code>app:layout_aspectRatio</code>的值。</p>
<p>遗留问题:     </p>
<ul>
<li>为什么在<code>onLayout</code>方法中去恢复数据，这有什么作用？</li>
<li>看代码在处理如果指定的百分比过小但又指定<code>wrap_content</code>时，会重新根据<code>wrap_content</code>去重新计算的逻辑没有错，但是为什么我在上面测试的时候确没效果？</li>
<li>在上面分析代码时看到<code>fillLayoutParams</code>中是根据父<code>View</code>的宽高来乘以百分比，不是根据整个屏幕的宽高，这样可能会有问题，要是ListView这种的高度没法算了。</li>
</ul>
<hr>
<ul>
<li>邮箱 ：charon.chui@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/屏幕适配之百分比方案详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-AndroidStudio中进行ndk开发" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/AndroidStudio中进行ndk开发/">AndroidStudio中进行ndk开发</a>
    </h1>
  

        
        <a href="/2015/01/01/AndroidStudio中进行ndk开发/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AndroidStudio中进行ndk开发"><a href="#AndroidStudio中进行ndk开发" class="headerlink" title="AndroidStudio中进行ndk开发"></a>AndroidStudio中进行ndk开发</h1><ul>
<li>创建工程，声明<code>native</code>方法。                 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">startDaemon</span><span class="params">(String serviceName, <span class="keyword">int</span> sdkVersion)</span></span>;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> &#123;</div><div class="line">       System.loadLibrary(<span class="string">"daemon"</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>生成<code>class</code>文件。<br>  执行<code>Build-Make Project</code>命令，生成<code>class</code>文件。所在目录为<code>app_path/build/intermediates/classes/debug</code></li>
</ul>
<ul>
<li><p>执行<code>javah</code>生成<code>.h文件</code>                    </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">	C:\Users\Administrator&gt;javah -help</div><div class="line">	用法:</div><div class="line">	  javah [options] &lt;classes&gt;</div><div class="line">	其中, [options] 包括:</div><div class="line">	  -o &lt;file&gt;                输出文件 (只能使用 -d 或 -o 之一)</div><div class="line">	  -d &lt;dir&gt;                 输出目录</div><div class="line">	  -v  -verbose             启用详细输出</div><div class="line">	  -h  --help  -?           输出此消息</div><div class="line">	  -version                 输出版本信息</div><div class="line">	  -jni                     生成 JNI 样式的标头文件 (默认值)</div><div class="line">	  -force                   始终写入输出文件</div><div class="line">	  -classpath &lt;path&gt;        从中加载类的路径</div><div class="line">	  -cp &lt;path&gt;               从中加载类的路径</div><div class="line">	  -bootclasspath &lt;path&gt;    从中加载引导类的路径</div><div class="line">	```	</div><div class="line">	在`Studio Terminal`中进入到`src/main`目录下执行`javah`命令:       </div><div class="line">	`javah -d jni -classpath &lt;SDK_android.jar&gt;;&lt;APP_classes&gt; &lt;class&gt;`</div><div class="line">	</div><div class="line">	`F:\DaemonService\app\src\main&gt;javah -d jni -classpath C:\develop\android-sdk-windows\platforms\android-22\android.jar;..\..\build\intermediates\classes\debug com.charonchui.daemonservice.service.DaemonService`</div><div class="line">	执行完成后就会在`src/main/jni`目录下生成`com_charonchui_daemonservice_service_DaemonService.h`文件。</div><div class="line"></div><div class="line">- 在`module/src/main/jni`目录下创建对应的`.c`文件。</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">- 配置`ndk`路径，在项目右键`Moudle Setting`中设置。              </div><div class="line">    ![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_ndk_jni.png?raw=true)    </div><div class="line">	</div><div class="line">- 在`build.gradle`中配置`ndk`选项              </div><div class="line"></div><div class="line">    ```java</div><div class="line">	android &#123;</div><div class="line">		compileSdkVersion 23</div><div class="line">		buildToolsVersion &quot;23.0.1&quot;</div><div class="line"></div><div class="line">		defaultConfig &#123;</div><div class="line">			applicationId &quot;com.charonchui.daemonservice&quot;</div><div class="line">			minSdkVersion 8</div><div class="line">			targetSdkVersion 23</div><div class="line">			versionCode 1</div><div class="line">			versionName &quot;1.0&quot;</div><div class="line"></div><div class="line">			ndk &#123;</div><div class="line">				moduleName &quot;uninstall_feedback&quot; // 配置so名字</div><div class="line">				ldLibs &quot;log&quot;</div><div class="line">	//            abiFilters &quot;armeabi&quot;, &quot;x86&quot;  // 默认就是全部的，加了配置才会生成选中的</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buildTypes &#123;</div><div class="line">			release &#123;</div><div class="line">				minifyEnabled false</div><div class="line">				proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>  这里可能会出现错误:      </p>
<ul>
<li><code>Error: NDK integration is deprecated in the current plugin. Consider trying the new experimental plugin. For details, see http://tools.android.com/tech-docs/new-build-system/gradle-experimental. Set &quot;android.useDeprecatedNdk=true&quot; in gradle.properties to continue using the current NDK integration.</code><br>  解决方法就是在<code>gradle.properties</code>文件中添加<code>android:useDeprecatedNdk=true</code>就可以了。</li>
<li>`Error:Execution failed for task ‘:app:compileDebugNdk’.<blockquote>
<p>com.android.ide.common.process.ProcessException: org.gradle.process.internal.ExecException: Process ‘command ‘E:\android-ndk-r10\ndk-build.cmd’’ finished with non-zero exit value 2<code>解决方法就是在</code>jni<code>目录建一个任意名字的</code>.c`空文件就可以了。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>执行Build<br>  然后就可以在<code>app/build/intermediates/ndk/debug/obj/local</code>下看到所有架构的<code>so</code>了。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/studio_ndk_build.png?raw=true" alt="image">    </p>
</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/AndroidStudio中进行ndk开发/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-性能优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/性能优化/">性能优化</a>
    </h1>
  

        
        <a href="/2015/01/01/性能优化/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><h2 id="代码优化原则"><a href="#代码优化原则" class="headerlink" title="代码优化原则:      "></a>代码优化原则:      </h2><ul>
<li>时间换时间：<br>  如禁用电脑的一些开机启动项，通过减少这些没必要的启动项的时间从而节省开机时间<br>  如网站界面上数据的分批获取，AJAX技术</li>
<li>时间换空间：<br>  如拷贝文件时new一个字节数组当缓冲器，即byte[] buffer = new byte[1024]。<br>  为什么只new一个1024个字节的数组呢，new一个更大的字节数组不是一下就把文件拷贝完了么？这么做就是为了牺牲时间节省有限的内存空间</li>
<li>空间换时间：<br>  如用Windows系统自带的搜索文件的功能搜索文件时会很慢，但是我们牺牲电脑硬盘空间安装一个everything软件来搜索文件就特别快</li>
<li>空间换空间：<br>  如虚拟内存</li>
</ul>
<h2 id="Android开发中的体现"><a href="#Android开发中的体现" class="headerlink" title="Android开发中的体现"></a>Android开发中的体现</h2><ul>
<li>采用硬件加速，在清单文件中<code>application</code>节点添加<code>android:hardwareAccelerated=”true”</code>。不过这个需要在<code>android 3.0</code>才可以使用。<code>android4.0</code>这个选项是默认开启的。</li>
<li><code>View</code>中设置缓存属性<code>setDrawingCache</code>为<code>true</code>.</li>
<li>优化你的布局.</li>
<li>动态加载<code>View</code>. 采用<code>ViewStub</code>避免一些不经常的视图长期握住引用.</li>
<li>将<code>Acitivity</code>中的<code>Window</code>的背景图设置为空。<code>getWindow().setBackgroundDrawable(null);``android</code>的默认背景是不是为空。</li>
<li>采用<code>&lt;merge&gt;</code>优化布局层数。 采用<code>&lt;include&gt;</code>来共享布局。</li>
<li>利用<code>TraceView</code>查看跟踪函数调用。有的放矢的优化。</li>
<li><code>cursor</code>的使用。不过要注意管理好<code>cursor</code>,不要每次打开关闭<code>cursor</code>.因为打开关闭<code>Cursor</code>非常耗时。 <code>Cursor.require</code>用于刷<code>cursor</code>.</li>
<li>采用<code>SurfaceView</code>在子线程刷新<code>UI</code>, 避免手势的处理和绘制在同一<code>UI</code>线程（普通<code>View</code>都这样做）。</li>
<li>采用<code>JNI</code>，将耗时间的处理放到<code>c/c++</code>层来处理。</li>
<li>有些能用文件操作的，尽量采用文件操作，文件操作的速度比数据库的操作要快10倍左右。</li>
<li>避免创建不必要的对象</li>
<li>如果方法用不到成员变量，可以把方法申明为<code>static</code>，性能会提高到15%到20%</li>
<li>避免使用<code>getter/setter</code>存取<code>field</code>，可以把<code>field</code>申明为<code>public</code>，直接访问</li>
<li><code>static</code>的变量如果不需要修改，应该使用<code>static final</code>修饰符定义为常量</li>
<li>使用增强<code>for</code>循环,比普通<code>for</code>循环效率高，但是也有缺点就是在遍历 集合过程中，不能对集合本身进行操作</li>
<li>合理利用浮点数，浮点数比整型慢两倍；</li>
<li>针对ListView的性能优化</li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/性能优化/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-性能优化相关工具" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/性能优化相关工具/">性能优化相关工具</a>
    </h1>
  

        
        <a href="/2015/01/01/性能优化相关工具/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能优化相关工具"><a href="#性能优化相关工具" class="headerlink" title="性能优化相关工具"></a>性能优化相关工具</h1><p>有关性能优化的文章请参考<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.md">性能优化</a>和<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E5%B8%83%E5%B1%80%E4%BC%98%E5%8C%96.md">布局优化</a>    </p>
<p>###DDMS(百宝箱)</p>
<p>#####查看进程的内存使用</p>
<p><code>DDMS</code>可以让你查看到一个进程使用的堆内存。    </p>
<ol>
<li>在<code>Device</code>了表选择你想查看的进程。</li>
<li>点击<code>Update Heap</code>按钮来开启查看进程堆内存信息。</li>
<li>在<code>Heap</code>页面，点击<code>Cause GC</code>来执行垃圾回收。</li>
<li>在列表中点击一个对象类型来查看它所分配的内存大小。   </li>
</ol>
<p>#####追踪对象的内存分配情况     </p>
<ol>
<li>在<code>Device</code>了表选择你想查看的进程。</li>
<li>在<code>Allocation Tracker</code>页面，点击<code>Start Tracking</code>按钮来开始追踪。</li>
<li>点击<code>Get Allocations</code>来查看从你点击<code>Start Tracking</code>之后分配内存的对象列表。 你可以再次点击<code>Get Allocations</code>来添加新分配内存的对象列表。 </li>
<li>停止追踪或者清除数据可以点击<code>Stop Tracking</code>按钮。 </li>
<li>在列表中单独点击一行来查看详细的信息。</li>
</ol>
<p>#####使用文件系统</p>
<p><code>DDMS</code>提供了一个文件浏览器来供你查看、拷贝、删除文件。</p>
<ol>
<li>在<code>Device</code>页面，选中你想要查看的设备。</li>
<li>从设备中拷贝文件，用文件浏览器选择文件后点击<code>Pull file</code>按钮。</li>
<li>拷贝文件到设备中，点击<code>Push file</code>按钮。</li>
</ol>
<p>#####检查线程信息  </p>
<p><code>Thread</code>页面可以显示指定进程中当前正在运行的线程。 </p>
<ol>
<li>在<code>Device</code>页面，选择想要查看的进程。 </li>
<li>点击<code>Update Threads</code>按钮。   </li>
<li>在<code>Thread</code>页面，你可以查看对应的线程信息。 </li>
</ol>
<p>#####启动方法分析</p>
<p>方法分析可以追踪一个方法的特定信息，例如调用数量，执行时间、耗时等。如果想要更精确的控制想要收集的数据，可以使用<code>startMethodTracing()</code>和<code>stopMethodTracing()</code>方法。    </p>
<p>在你开始使用方法分析之前请知晓如下限制:    </p>
<ul>
<li>在<code>Android 2.1</code>及以前的设备必须有<code>SD</code>卡，并且你的应用必须有写入<code>SD</code>卡的权限。 </li>
<li>在<code>Android 2.2</code>及以后的设备中不需要<code>SD</code>卡，<code>trace log</code>文件会直接被导入到开发机上。</li>
</ul>
<p>开启方法分析:    </p>
<ol>
<li>在<code>Device</code>页面，选择想要开启方法分析的进程。</li>
<li>点击<code>Start Method Profiling</code>按钮。</li>
<li>在<code>Android 4.4</code>及以后，可以选择<code>trace_based profiling</code>或者基本的<code>sample-based profiling</code>选项。在之前的版本智能使用<code>trace-based profiling</code>。</li>
<li>在应用中操作界面来执行你想要分析的方法。 </li>
<li>点击<code>Stop Method Profiling</code>按钮。<code>DDMS</code>会停止分析并且将在<code>Start Method Profiling</code>和<code>Stop Method Profiling</code>中间手机的方法分析数据使用<code>Traceview</code>打开。   </li>
</ol>
<h5 id="使用网络流量工具"><a href="#使用网络流量工具" class="headerlink" title="使用网络流量工具"></a>使用网络流量工具</h5><p>从<code>Android 4.0</code>开始,<code>DDMS</code>包含了一个网络使用情况的页面来支持跟踪应用的网络请求。</p>
<p>如图:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/ddms-network.png?raw=true" alt="image">。 </p>
<p>通过检测数据交互的频繁性以及在每次连接中数据的传递量，你可以知道应用中具体可以做的更好更高效的地方。<br>想要更好的查看引起数据交互的地方，可以使用<code>TrafficsStats</code>这个<code>API</code>，它也可以使用<code>setThreadStatsTag()</code>方法来设置数据使用情况的<code>tag</code>，</p>
<p>首先要讲到的是<code>Systrace</code>，之前在淘宝面试的时候被问到，如有查找<code>UI</code>绘制卡顿的问题，我没答上来。早点知道<code>Systrace</code>就好了(当然只知道工具是不够的，也要懂得里面的原理)。</p>
<h3 id="Systrace"><a href="#Systrace" class="headerlink" title="Systrace"></a>Systrace</h3><p><code>Systrace</code>有什么用呢？官方文档中有一片文章的标题是：使用<code>Systrace</code>进行<code>UI</code>性能分析。    </p>
<p>在应用程序开发的过程中，你需要检查用户交互是否平滑流畅，运行在稳定的60fps。如果中间出了些问题，导致某一帧延迟，我们想要解决该问题的第一步就是理解系统如何操作的。     </p>
<p><code>Systrace</code>工具可以让你来手机和观察整个<code>android</code>设备的时间信息，也称为<code>trace</code>。它会显示每个时间点上的<code>CPU</code>消耗图，显示每个线程在显示的内容以及每个进程当时在做的操作。</p>
<p>在使用<code>Systracv</code>来分析应用之前，你需要手机应用的<code>trace log</code>信息。生成的<code>trace</code>能够让你清晰的观察系统在该时间内所做的任何事情。 </p>
<h5 id="生成Trace"><a href="#生成Trace" class="headerlink" title="生成Trace"></a>生成Trace</h5><p>为了能创建一个<code>trace</code>，你必须要执行如下几个操作。 首先，你要有一个<code>Android 4.1</code>及以上的设备。将该设备设置为<code>debugging</code>，连接你的设备并且安装应用。有些类型的信息，特别是一些硬盘的活动和内核工作队列，需要设备获取<code>root</code>权限才可以。 然而，大多数的<code>Systrace log</code>的数据只需要设备开启开发者<code>debugging</code>就可以了。     </p>
<p><code>Systrace</code>可以通过命令行或者图形化界面的方式来运行，在<code>Studio</code>中打开<code>Android Device Monitor</code>然后选择<code>Systracv</code>图标<img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-button.png?raw=true" alt="image">。 </p>
<p>下面以命令行的方式为例，这里只讲解一下<code>Android 4.3</code>及以上的使用方式:     </p>
<ul>
<li>确保设备已经通过<code>USB</code>连接并且开启了<code>debugging</code>模式。 </li>
<li>设置一些参数并执行<code>trace</code>命令，例如:        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">    $ cd android-sdk/platform-tools/systrace</div><div class="line">    $ python systrace.py --time=10 -o mynewtrace.html sched gfx view wm</div><div class="line">    ```  </div><div class="line">    执行完上面的命令后就会在`sdk/platform-tools/systrace/mynewtrace.html`生成对应的`html`文件。 </div><div class="line">- 在设备上执行一些你想要`trace`的过程。     </div><div class="line"></div><div class="line">悲剧了，生成了对应的`html`文件，但是我死活打不开。打开是白屏，折腾了我半天，最后终于找到了解决方法:   </div><div class="line"></div><div class="line">&gt;  Firstly, if anyone is using Chrome v50.0+ on OS X, just try this please.</div><div class="line"></div><div class="line">&gt; open chrome browser and go to &quot;chrome://tracing&quot;</div><div class="line">&gt; in the tracing page, click load and select the systrace generated html file.</div><div class="line">&gt; Secondly, I think it&apos;s a bug which is confirmed by Google.</div><div class="line"></div><div class="line">`OK`了。 </div><div class="line"></div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace_file.png?raw=true =)。 </div><div class="line"></div><div class="line">看不懂！！！</div><div class="line"></div><div class="line">#####分析Trace</div><div class="line"></div><div class="line">用浏览器打开上面生成的`mynewtrace.html`。    下面为了能明显的说明，我就用官网提供的例子来说明了。   </div><div class="line"></div><div class="line">######查看Frames</div><div class="line">从打开的文件中我们能看到每个应用都有一行`frame`的圆圈来标示渲染的帧，通常都是绿色的。黄色或者红的圆圈标示超过了我们对保障60fps所需的16毫秒绘制时间。。 可以在文件上面按`w`键来放大文件以便能更好的观看查找。   </div><div class="line">&gt; ***提示:***在文件上面按`?`键可以查看对应的快捷键。  </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-unselected.png?raw=true)。 </div><div class="line"></div><div class="line">在`Android 5.0`以上的设备上，显示工作呗分为`UI Thread`和`Render Thread`。在之前的版本，所有工作都是在`UI Thread`进行的。 点击某个单独的`frame`图标来查看它们所需的时间。</div><div class="line"></div><div class="line">######观看Alerts    </div><div class="line"></div><div class="line">`Systracv`会自动分析`trace`过程的时间，并且通过`alerts`提示该展现问题，以及建议如何处理。    </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-selected.png?raw=true) </div><div class="line"></div><div class="line">如上图所示，在你点击一个比较慢的`frame`时，下面就会显示一个`alert`。在这种情况下，它直说可能是`ListView`服用以及重复渲染的问题。 如果你发现`UI Thread`做了太多的工作，你可以使用`TraceView`进行代码分析，来找到具体哪些操作导致了消耗时间。</div><div class="line"></div><div class="line">如下，你也可以通过点击窗口右边的`Alerts`来查看当前所有的`alert`。这样会直接展开`Alert`窗口。   </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-selected-alert-tab.png?raw=true)</div><div class="line"></div><div class="line">下面我们以另外一个例子来分析一下它的`Frame`：    </div><div class="line"></div><div class="line">我们点击某一红色`frame`来查看这一阵的一些相关警告:   </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-frame-zoomin.png?raw=true)</div><div class="line">可以看到这里说耗时32毫秒，这已经远远超过了16毫秒的绘制时间。 我们可以通过`Description`来查看描述内容。   </div><div class="line">下面是另外一个渲染过慢的例子:     </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-frame.png?raw=true)</div><div class="line">从上图，我们发现了`Scheduling delay`的警告，加起来能看到总的绘制时间大约是19毫秒。   </div><div class="line">`Scheduling delay`的意思是调度延迟，也就是说一个县城在处理这部分操作时，在很长时间内没有被分配到`CPU`上面进行运算，这样就导致了很长时间内没有完成操作。    我们选择这一帧中最长的一块，来观察下:    </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-slice.png?raw=true)</div><div class="line"></div><div class="line">我们在上图看到了`Wall duration`，他代表着这一块开始到结束的总耗时。而在`CPU Duration`这里显示了`CPU`在处理该部分消耗的时间。 很明显，真个区域用了18毫秒，但是`CPU`实际处理只用了4毫秒，也就是说剩下的14毫秒就可能有问题了。     </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-cpu.png?raw=true)</div><div class="line"></div><div class="line">可以看到，4个线程都比较忙。  </div><div class="line"></div><div class="line">选择其中一个线程来查看是哪个应用在使用它，这里看到了一个包名为`com.udinic.keepbusyapp`的应用。也就是说由于另外一个应用占用了`CPU`,，导致了我们的应用未能获取到足够的`CPU`资源。      </div><div class="line"></div><div class="line"></div><div class="line">#####追踪代码</div><div class="line"></div><div class="line">在`Android 4.3`以上你可以使用`Trace`类来在代码中添加(很熟悉有木有，在看源码的时候经常看到)。这样能查看到此时你的应用线程都做了哪些操作。 </div><div class="line">下面的代码展示了如何使用`Trace`类来追踪两个代码块部分:   </div><div class="line">```java</div><div class="line">public void ProcessPeople() &#123;</div><div class="line">    Trace.beginSection(&quot;ProcessPeople&quot;);</div><div class="line">    try &#123;</div><div class="line">        Trace.beginSection(&quot;Processing Jane&quot;);</div><div class="line">        try &#123;</div><div class="line">            // code for Jane task...</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.endSection(); // ends &quot;Processing Jane&quot;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.beginSection(&quot;Processing John&quot;);</div><div class="line">        try &#123;</div><div class="line">            // code for John task...</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.endSection(); // ends &quot;Processing John&quot;</div><div class="line">        &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">        Trace.endSection(); // ends &quot;ProcessPeople&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###Traceview</p>
<p><code>Traceview</code>是一个性能测试工具，展示了所有方法的运行时间。    </p>
<blockquote>
<p>Traceview is a graphical viewer for execution logs that you create by using the Debug class to log tracing information in your code. Traceview can help you debug your application and profile its performance.</p>
</blockquote>
<p>#####创建Trace文件  </p>
<p>想要使用<code>Traceview</code>你需要创建一个包含你想分析部分的<code>trace</code>信息的<code>log</code>文件。<br>有两种方式来生成<code>trace logs</code>：    </p>
<ul>
<li><p>在你测试的类中添加<code>startMethodTracing()</code>和<code>stopMethodTracing()</code>的代码，来指定开始和结束获取<code>trace</code>信息。这种方式是非常精确的，因为你可以在代码中指定开始和结束的位置。     </p>
</li>
<li><p>使用<code>DDMS</code>中的方法来生成。这种方式就不太精确。虽然这种方式不能精确的指定起始和结束位置，但是如果在你无法修改源代码或者不需要精确时间的时候是非常有用的。 </p>
</li>
</ul>
<p>在开始生成<code>trace log</code>信息时，你需要知道如下的限制条件:    </p>
<ul>
<li>如果你在测试代码中使用，你的应用必须要用<code>WRITE_EXTERNAL_STORAGE</code>的权限。 </li>
<li><p>如果你使用<code>DDMS</code>生成:     </p>
<ul>
<li><code>Android 2.1</code>之前必须有<code>SD</code>卡，并且你的应用也要有写入<code>SD</code>卡的权限。 </li>
<li><code>Android 2.2</code>之后不需要<code>SD</code>卡，<code>trace log</code>文件会直接生成到你的开发机上。   </li>
</ul>
</li>
</ul>
<p>在测试代码中调用<code>startMethodTracing()</code>方法的时候，你可以指定系统生成<code>trace</code>文件的名字。结束的时候调用<code>stopMethodTracing()</code>方法。这些方法开始和结束时贯穿整个虚拟中的。例如你可以在你<code>activity</code>的<code>onCreate()</code>方法中调用<code>startMethodTracing()</code>方法，然后在<code>activity</code>的<code>onDestroy()</code>方法中调用<code>stopMethodTracing()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// start tracing to "/sdcard/calc.trace"</span></div><div class="line">Debug.startMethodTracing(<span class="string">"calc"</span>);</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// stop tracing</span></div><div class="line">Debug.stopMethodTracing();</div></pre></td></tr></table></figure></p>
<p>在调用<code>startMethodTracing()</code>方法的时候，系统创建一个名为<code>&lt;trace-base-name&gt;.trace</code>的文件。它包含方法的二进制<code>trace</code>数据和一个线程与方法名的对应集合。<br>然后系统就开始生成<code>trace</code>数据，直到调用<code>stopMethodTracing()</code>方法。如果在你调用<code>stopMethodTracing()</code>方法之前系统已经达到了最大的缓冲大小，系统就会停止<code>trace</code>并且在控制台发出一个通知。     </p>
<p>#####拷贝Trace文件到电脑上</p>
<p>在模拟器或者机器上生成<code>&lt;trace-base-name&gt;.trace</code>文件后，你需要拷贝他们到你的电脑上，你可以使用<code>adb pull</code>命令来拷贝：<br><code>adb pull /sdcard/calc.trace /tmp</code></p>
<p>#####在Traceview中查看trace文件    </p>
<p>运行<code>Traceview</code>并且查看<code>trace</code>文件:     </p>
<ol>
<li>打开<code>Android Device Monitor</code>。</li>
<li>在<code>Android Device Monitor</code>的状态栏中点击<code>DDMS</code>并且选择一个进程。 </li>
<li>点击<code>Start Method Profiling</code>图标开始查看。</li>
<li>在查看完后点击<code>Stop Method Profiling</code>图标来显示<code>traceview</code>。  </li>
</ol>
<p>大体的样子如下:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_1.png?raw=true" alt="image"> </p>
<p>#####Traceview Layout     </p>
<p>如果你有一个<code>trace log</code>文件(通过添加<code>tracing</code>代码或者用DDMS生成)，你可以把该文件加载到<code>Traceview</code>中，这将会把<code>log</code>数据显示为两部分:    </p>
<ul>
<li><code>timeline panel</code>-展示了每个线程和方法的起始和结束</li>
<li><code>profile panel</code>-提供了一个方法中的执行内容的简述</li>
</ul>
<p>#####Timeline Panel</p>
<p>每个线程都会以时间从左往右递增的方式在单独的一行中显示它的执行情况，</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_timeline.png?raw=true" alt="image"></p>
<p>#####Profile Panel</p>
<p>显示了一个方法所消耗的时间的概要情况。在表格中会同时显示<code>inclusive</code>和<code>exclusive</code>的时间。<code>Exclusive</code>的时间是该方法所消耗的时间。<code>InClusive</code>的时间是该方法消耗的时间加上任何调的方法所消耗的时间。我们简单的将调用的方法叫做<code>parents</code>，被调用的方法叫做<code>children</code>。如果一个方法被调用，它会显示对应的<code>parents</code>和<code>children</code>。<code>parents</code>会显示一个紫色的背景，<code>children</code>会显示一个黄色的背景。最后一列显示了该方法所调用的总数的调用数。在下面的图中我们能看到一共有14个地方调用了<code>LoadListener.nativeFinished()</code> . </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_profile.png?raw=true" alt="image"></p>
<ul>
<li>Name 方法名</li>
<li>Inclusive CPU Time， CPU在处理该方法以及所有子方法(被它调用的所有方法)所消耗的时间。</li>
<li>Exlusive CPU Time, CPU在处理该方法的耗时。</li>
<li>Inclusive/Exclusive Real Time， 从方法开始执行到执行结束的耗时。 </li>
<li>Cal+Rec, 这个方法被调用的次数，以及递归被调用的次数。 </li>
<li>CPU/Real time per Call, 在处理这个方法时的<code>CPU</code>耗时的平均值。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview-getview.png?raw=true" alt="image"></p>
<p>上图中<code>getView</code>方法被调用了12次，每次<code>CPU</code>消耗2.8秒，但是每次调用的总耗时是162秒，这里肯定有问题。<br>而看看这个方法的children，我们可以看到这其中的每个方法在耗时方面是如何分布的。Thread.join()方法战局了98%的inclusive real time。这个方法在等待另一个线程结束的时候被调用。在Children中另外一个方法就是Tread.start()方法，而之所以整个方法耗时很长，我猜测是因为在getView()方法中启动了线程并且在等待它的结束。</p>
<p>但是这个线程在哪儿？</p>
<p>我们在getView()方法中并不能看到这个线程做了什么，因为这段逻辑不在getView()方法之中。于是我找到了Thread.run()方法，就是在线程被创建出来时候所运行的方法。而跟随这个方法一路向下，我找到了问题的元凶。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview-thread.png?raw=true" alt="image"></p>
<p>我发现了BgService.doWork()方法的每次调用花费了将近14毫秒，并且有四十个这东西！而且getView()中还有可能调用多次这个方法，这就解释了为什么getView()方法执行时间如此之长。这个方法让CPU长时间的保持在了繁忙状态。而看看Exclusive CPU time，我们可以看到他占据了80%的CPU时间！此外，根据Exclusive CPU time排序，可以帮我们更好的定位那些耗时很长的方法，而他们很有可能就是造成性能问题的罪魁祸首。</p>
<p>关注这些耗时方法，例如getView()，View#onDraw()等方法，可以很好的帮助我们寻找为什么应用运行缓慢的原因。但有些时候，还会有一些其他的东西来占用宝贵的CPU资源，而这些资源如果被运用在UI的绘制上，也许我们的应用会更加流畅。Garbage Collector垃圾回收机制会不时的运行，回收那些没用的对象，通常来讲这不会影响我们在前台运行的程序。但如果GC被运行的过于频繁，他同样可以影响我们应用的执行效率。而我们该如何知道回收的是否过于频繁了呢…</p>
<p>###Monitors</p>
<p>在<code>Android Studio</code>中下方的<code>Android Monitor</code>中可以看到<code>Monitors</code>工具栏，它能不断的去检测内存、网络、CPU的消耗情况。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/monitor.png?raw=true" alt="image"></p>
<p>我们可以直接点击<code>Dump Java Heap</code>或者<code>Call GC</code>等按钮，以便更好的去观察内存的使用情况。点击后会生成一个<code>.hprof</code>的文件。生成后直接使用<code>Studio</code>打开<code>.hprof</code>文件即可。  </p>
<p>说到这里插一嘴,<a href="https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6.md">有关Java垃圾回收机制请参考</a></p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/dump_href.png?raw=true" alt="image"><br>在左边能看到所有堆内存中的实例。后面会显示他所占用的内存大小。</p>
<p>对于内存泄漏的分析可以使用<code>MAT</code>或者<code>LeakCanary</code>来进行。这里就不仔细说了。   </p>
<p>#####不同虚拟机的内存管理 </p>
<p><code>Android Monitor</code>使用的<code>Virtual Machine(VM)</code>:    </p>
<ul>
<li><code>Android 4.3(API Level 18)</code>及以前的版本使用<code>Dalvik VM</code> .</li>
<li><code>Android 4.4(API Level 19)</code>默认使用<code>Dalvik VM</code>，<code>Android RunTime(ART)</code>是可选的。</li>
<li><code>Android 4.3(API Level 18)</code>及更高的版本使用<code>ART VM</code>.</li>
</ul>
<p>虚拟之执行垃圾回收。Dalvik虚拟机使用一个标记和清除垃圾收集方案。<code>ART</code>虚拟机使用分代收集算法与标记和清楚手机算法相结合的方式。 <code>Logcat</code>会显示一些垃圾回收相关的信息。     </p>
<p>#####GPU使用情况</p>
<p>上面也显示了<code>GPU</code>的使用情况，这里要说一句，如果想要显示它，必须要在手机的开发者中心中开启<code>GPU显示配置文件</code>选项，将其设置为显示与<code>adb shell dumpsys gfxinfo</code>。然后再点击<code>Studio</code>中的按钮重新开始就可以看到了。 每一条线意味着一帧被绘制出来了。而线的颜色又代表不同的阶段：    </p>
<ul>
<li>Draw(蓝色)代表着<code>View.onDraw()</code>方法。如果这个值很高就说明可能是该<code>View</code>比较复杂。 在这个环节会创建/刷新DisplayList中的对象，这些对象在后面会被转换成GPU可以明白的OpenGL命令。而这个值比较高可能是因为view比较复杂，需要更多的时间去创建他们的display list，或者是因为有太多的view在很短的时间内被创建。</li>
<li><p>Prepare(紫色)，从<code>Android 6.0</code>开始，一个新的线程被引进来帮助<code>UI</code>线程进行绘制。 这个线程叫做<code>Render Thread</code>。它负责转换它负责转换display list到OpenGL命令并且送至GPU。在这过程中，UI线程可以继续开始处理后面的帧。而在UI线程将所有资源传递给RenderThread过程中所消耗的时间，就是紫色阶段所消耗的时间。如果在这过程中有很多的资源都要进行传递，display list会变得过多过于沉重，从而导致在这一阶段过长的耗时。</p>
</li>
<li><p>Process(红色) 执行Display list中的内容并创建OpenGL命令。如果有过多或者过于复杂的display list需要执行的话，那么这阶段会消耗较长的时间，因为这样的话会有很多的view被重绘。而重绘往往发生在界面的刷新或是被移动出了被覆盖的区域。</p>
</li>
<li><p>Execute (黄色) – 发送OpenGL命令到GPU。这个阶段是一个阻塞调用，因为CPU在这里只会发送一个含有一些OpenGL命令的缓冲区给GPU，并且等待GPU返回空的缓冲区以便再次传递下一帧的OpenGL命令。而这些缓冲区的总量是一定的，如果GPU太过于繁忙，那么CPU则会去等待下一个空缓冲区。所以，如果我们看到这一阶段耗时比较长，那可能是因为GPU过于繁忙的绘制UI，而造成这个的原因则可能是在短时间内绘制了过于复杂的view。</p>
</li>
<li><p>Measure/Layout(绿色) 代表<code>Measure</code>和<code>Layout</code>的时间。 </p>
</li>
</ul>
<p>###Hierarchy Viewer</p>
<p>布局分析工具，非常常用。</p>
<p>在<code>Android Device Monitor</code>中打开<code>Hierarchy Viewer</code>即可。</p>
<ul>
<li>连接你的手机或者模拟器。<br>  出于安全性考虑，<code>Hierarchy Viewer</code>只能连接开发者版的系统的手机。 </li>
<li>运行程序，并且让界面显示出来。</li>
<li>启动<code>hierarchy view</code>工具，接着就能看到左边栏显示出了对应的设备，展开后可以看到一些组件的名称。这个页面包含了应用的界面以及系统的界面。选择你的应用中想要查看的界面直接双击就可以了。    </li>
</ul>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/gettingstarted_image005.png?raw=true" alt="image"><br>如果你的界面显示的不是这个样子，少一些东西的话，你可以使用<code>Window&gt;Reset Perspective</code>来重置样式。 </p>
<p>但是我并打不开。<br>如果你的手机是<code>Android 4.1</code>及以上版本你必须要在你的电脑上设置一个<code>ANDROID_HVPROTO</code>DE 环境变量才可以。</p>
<ul>
<li>Windows<br>  增加一个名为<code>ANDROID_HVPROTO</code>值为<code>ddm</code>的环境变量就可以了。 </li>
<li><p>Mac </p>
<ul>
<li>打开<code>.bash_profile</code><ul>
<li><code>touch .bash_profile</code>创建</li>
<li><code>open -e .bash_profile</code>打开</li>
</ul>
</li>
<li><p>添加    </p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#Hierarchy Viewer Variable              </div><div class="line">export ANDROID_HVPROTO=ddm</div></pre></td></tr></table></figure>
</li>
<li><p><code>source .bash_profile</code></p>
</li>
</ul>
</li>
</ul>
<p>如果配置完成后仍然不能用的话，你可以:   </p>
<ul>
<li>关闭<code>Android Studio</code>.</li>
<li>执行<code>add kill-server</code>，然后<code>adb start-server</code>.</li>
<li>通过命令行开始<code>hierarchyviewer</code>.</li>
</ul>
<p>好了，我们直接打开自己的页面进行查看布局吧(有点慢)。<br>它是介个样子滴 ：<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/hierarchy_vierwe_page.png?raw=true" alt="image"></p>
<p>我们可以看到所有结构，点击对一个的节点，能直接看到该界面的<code>UI</code>效果，并展示该布局包含多少个<code>View</code>，以及该布局<code>measure,draw,layout</code>所消耗的时间。选中<code>Show Extras</code>选项可以看到在右下角看到界面效果。   </p>
<p>选中要查看的节点后点击<code>Profile Node</code>选项，可以看到如下界面:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/hierarchy_profile_node.png?raw=true" alt="image"></p>
<p>可以看到每个布局都出现了三个点。有不同的颜色,从左到右这三个点分别表示:   </p>
<ul>
<li>左边的点代表<code>Draw</code>阶段。</li>
<li>中间的点代表了<code>Layout</code>阶段。</li>
<li>右边的点代表了<code>Execute</code>阶段。</li>
</ul>
<p>这三个点有分别对应了<code>pipeline</code>中的不同阶段，如下图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/gettingstarted_image015.png?raw=true" alt="image"></p>
<p>不同的颜色代表不同的性能:    </p>
<ul>
<li>绿色代表渲染的非常快，至少是其他<code>View</code>的一半。</li>
<li>黄色代表<code>View</code>渲染比最后那一半的<code>View</code>快。</li>
<li>红色代表<code>View</code>渲染是几乎是在最慢的那部分中间。</li>
</ul>
<p><code>Hierarchy Viewer</code>测量的是相对的表现能力，所以总会有一个红色的节点，它并不意味者该<code>View</code>一定是绘制的太慢。 </p>
<p>###过度绘制</p>
<p>在开发者选项中将调试GPU过度绘制设置为显示过度绘制区域，就能看到程序的绘制情况。<br>过度绘制往往发生在我们需要在一个东西上面绘制另外一个东西，例如在一个红色的背景上画一个黄色的按钮。那么GPU就需要先画出红色背景，再在他上面绘制黄色按钮，此时过度绘制就是不可避免的了。如果我们有太多层需要绘制，那么则会过度的占用GPU导致我们每帧消耗的时间超过16毫秒。<br>这些过度绘制可能发生在我们给Activity或Fragment设置了全屏的背景，同时又给ListView以及ListView的条目设置了背景色。而通过只设置一次背景色即可解决这样的问题。</p>
<p>注意：默认的主题会为你指定一个默认的全屏背景色，如果你的activity又一个不透平的背景盖住了默认的背景色，那么你可以移除主题默认的背景色，这样也会移除一层的过度绘制。这可以通过配置主题配置或是通过代码的方法，在onCreate()方法中调用getWindow().setBackgroundDrawable(null)方法来实现。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/overdraw-gif.gif?raw=true" alt="image"></p>
<p>###Hardware Acceleration</p>
<p>在Honeycomb版本中引入了硬件加速（Hardware Accleration）后，我们的应用在绘制的时候就有了全新的绘制模型。它引入了DisplayList结构，用来记录View的绘制命令，以便更快的进行渲染。但还有一些很好的功能开发者们往往会忽略或者使用不当——View layers。</p>
<p>使用View layers（硬件层），我们可以将view渲染入一个非屏幕区域缓冲区（off-screen buffer，前面透明度部分提到过），并且根据我们的需求来操控它。这个功能主要是针对动画，因为它能让复杂的动画效果更加的流畅。而不使用硬件层的话，View会在动画属性（例如coordinate, scale, alpha值等）改变之后进行一次刷新。而对于相对复杂的view，这一次刷新又会连带它所有的子view进行刷新，并各自重新绘制，相当的耗费性能。使用View layers，通过调用硬件层，GPU直接为我们的view创建一个结构，并且不会造成view的刷新。而我们可以在避免刷新的情况下对这个结构进行进行很多种的操作，例如x/y位置变换，旋转，透明度等等。总之，这意味着我们可以对一个让一个复杂view执行动画的同时，又不会刷新！这会让动画看起来更加的流畅。<br>在阅读了ViewPager的源码后，我发现了在滑动的时候会自动为左右两页启动一个硬件层，并且在滑动结束后移除掉。</p>
<p>在两页间滑动的时候创建硬件层也是可以理解的，但对我来说小有不幸。通常来讲加入硬件层是为了让ViewPager的滑动更加流畅，毕竟它们相对复杂。</p>
<p>是的，但是再使用硬件layers的时候还是有几点要牢记在心：</p>
<ul>
<li>回收 – 硬件层会占用GPU中的一块内存。只在必要的时候使用他们，比如动画，并且事后注意回收。例如在上面ObjectAnimator的例子中，我们增加了一个动画结束监听以便在动画结束后可以移除硬件层。而在Property animator的例子中，我们使用了withLayers()，这会在动画开始时候自动创建硬件层并且在结束的时候自动移除。</li>
<li>如果你在调用了硬件View layers后改变了View，那么会造成硬件硬件层的刷新并且再次重头渲染一遍view到非屏幕区域缓存中。这种情况通常发生在我们使用了硬件层暂时还不支持的属性（目前为止，硬件层只针对以下几种属性做了优化：otation、scale、x/y、translation、pivot和alpha）。例如，如果你另一个view执行动画，并且使用硬件层，在屏幕滑动他们的同时改变他的背景颜色，这就会造成硬件层的持续刷新。而以硬件层的持续刷新所造成的性能消耗来说，可能让它在这里的使用变得并不那么值。</li>
</ul>
<p>有关如何使用<code>Hardware Layer</code>请参考之前写的文章:<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E9%80%9A%E8%BF%87Hardware%20Layer%E6%8F%90%E9%AB%98%E5%8A%A8%E7%94%BB%E6%80%A7%E8%83%BD.md">通过Hardware Layer提高动画性能</a></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/性能优化相关工具/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>