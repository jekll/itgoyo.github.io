<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/6/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=270 src="//music.163.com/outchain/player?type=0&id=120897804&auto=1&height=430"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 100%"><a href="/">主页</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-屏幕适配之百分比方案详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/屏幕适配之百分比方案详解/">屏幕适配之百分比方案详解</a>
    </h1>
  

        
        <a href="/2015/01/01/屏幕适配之百分比方案详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="屏幕适配之百分比方案详解"><a href="#屏幕适配之百分比方案详解" class="headerlink" title="屏幕适配之百分比方案详解"></a>屏幕适配之百分比方案详解</h1><p><code>Android</code>设备碎片化十分严重，在开发过程中的适配工作也非常很繁琐，有关屏幕适配的介绍请看之前的文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%9F%BA%E7%A1%80/%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D.md">屏幕适配</a>。</p>
<p>最近看到<code>DrawerLayout</code>，<code>support v4</code>中提供的类，想到对<code>google</code>提供的这些支持库，自己一点都不熟悉，想着看看<code>Google</code>提供的支持库都有什么内容。结果看着看着在最后忽然看到了<code>Percent Support Library</code>。寻思怎么还百分比呢？仔细一看介绍，我擦，真是太有用了。</p>
<blockquote>
<p>###Percent Support Library<br>The Percent package provides APIs to support adding and managing percentage based dimensions in your app.</p>
<p>The Percent Support library adds support for the PercentLayoutHelper.PercentLayoutParams interface and various classes, such as PercentFrameLayout and PercentRelativeLayout.</p>
<p>After you download the Android Support Libraries, this library is located in the <sdk>/extras/android/support/percent directory. For more information on how to set up your project, follow the instructions in Adding libraries with resources.</sdk></p>
<p>The Gradle build script dependency identifier for this library is as follows:<br><code>com.android.support:percent:23.3.0</code></p>
</blockquote>
<p>看到了吗？ 说提供了<code>PercentFrameLayout</code>和<code>PercentRelativeLayout</code>来支持百分比了。这样不就完美的解决了适配的问题嘛。啥也不说了，立马配置<code>cradle</code>来瞧瞧。   </p>
<blockquote>
<p>Subclass of FrameLayout that supports percentage based dimensions and margins. You can specify dimension or a margin of child by using attributes with “Percent” suffix. </p>
</blockquote>
<p>上代码:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.percent.PercentFrameLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">app:layout_widthPercent</span>=<span class="string">"50%"</span></div><div class="line">        <span class="attr">app:layout_heightPercent</span>=<span class="string">"50%"</span></div><div class="line">        <span class="attr">app:layout_marginTopPercent</span>=<span class="string">"25%"</span></div><div class="line">        <span class="attr">app:layout_marginLeftPercent</span>=<span class="string">"25%"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.percent.PercentFrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果如下:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/percent_frame.png?raw=true" alt="image"><br>完美.   </p>
<p>支持的属性:    </p>
<ul>
<li><code>layout_widthPercent</code></li>
<li><code>layout_heightPercent</code></li>
<li><code>layout_marginPercent</code></li>
<li><code>layout_marginLeftPercent</code></li>
<li><code>layout_marginTopPercent</code></li>
<li><code>layout_marginRightPercent</code></li>
<li><code>layout_marginBottomPercent</code></li>
<li><code>layout_marginStartPercent</code></li>
<li><code>layout_marginEndPercent</code></li>
<li><code>layout_aspectRatio</code></li>
</ul>
<blockquote>
<p>It is not necessary to specify layout_width/height if you specify layout_widthPercent. However, if you want the view to be able to take up more space than what percentage value permits, you can add layout_width/height=”wrap_content”. In that case if the percentage size is too small for the View’s content, it will be resized using wrap_content rule.</p>
</blockquote>
<p>如果指定了<code>layout_widthPercent</code>就不用指定<code>layout_width/height</code>属性了。(<code>Studio</code>可能会提示错误，设置忽略就好)。然而，如果你想要该<code>View</code>能够占用比设置的百分比值更大的空间时，你可以指定<code>layout_widht/height=“wrap_content”</code>。在这种情况下，如果设置的百分比值在显示内容时太小时，将会使用<code>wrap_content</code>的值重新计算。</p>
<p>就是这个意思:如果指定的百分比太小怕显示不开的话，也可以给它指定<code>wrap_content</code>属性，这样当显示不开的时候就会使用<code>wrap_content</code>的值。<br>如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">android.support.percent.PercentFrameLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"顶顶顶顶顶大大大"</span></div><div class="line">        <span class="attr">android:textSize</span>=<span class="string">"30dp"</span></div><div class="line">        <span class="attr">android:singleLine</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">app:layout_widthPercent</span>=<span class="string">"30%"</span></div><div class="line">        <span class="attr">app:layout_heightPercent</span>=<span class="string">"5%"</span></div><div class="line">        <span class="attr">app:layout_marginTopPercent</span>=<span class="string">"25%"</span></div><div class="line">        <span class="attr">app:layout_marginLeftPercent</span>=<span class="string">"25%"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.percent.PercentFrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/percent_wrap.png?raw=true" alt="image">    </p>
<p>加入<code>wrap_content</code>后一点效果也没有啊，还是显示不全啊，和没加<code>wrap_content</code>一样，- -!</p>
<p>你也可以通过只设置<code>width</code>或者<code>height</code>和<code>layout_aspectRatio</code>这种比例值的方式来让第另一个值自动计算。例如，如果你想要使用<code>16:9</code>的比例，你可以使用:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">android:layout_width="300dp"</div><div class="line">app:layout_aspectRatio="178%"</div></pre></td></tr></table></figure></p>
<p>这样将会在宽固定为<code>300dp</code>的基础上以16:9(1.78:1)来计算高度。</p>
<p><code>PercentRelativeLayout</code>的使用都是一样的，这里就不贴了。   </p>
<p>那它是怎么实现的呢？其实就是内部给通过属性换算，把本布局的宽高和百分比去计算每个<code>view</code>的大小和位置。但是还有为什么上面设置的<code>wrap_content</code>无效呢？是我理解错了吗？</p>
<p>带着这两个疑问我们来看下源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PercentFrameLayout</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PercentLayoutHelper mHelper = <span class="keyword">new</span> PercentLayoutHelper(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PercentFrameLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> LayoutParams <span class="title">generateDefaultLayoutParams</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(getContext(), attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        mHelper.adjustChildren(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="comment">// 从名字上就能看出来下面就是处理如果指定百分比过小不足显示内容时，就去使用`wrap_content`的逻辑</span></div><div class="line">        <span class="keyword">if</span> (mHelper.handleMeasuredStateTooSmall()) &#123;</div><div class="line">            <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">        mHelper.restoreOriginalParams();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LayoutParams</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span>.<span class="title">LayoutParams</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">PercentLayoutHelper</span>.<span class="title">PercentLayoutParams</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> PercentLayoutHelper.PercentLayoutInfo mPercentLayoutInfo;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(Context c, AttributeSet attrs)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(c, attrs);</div><div class="line">            <span class="comment">// PercentLayoutInfo中去解析自定义属性的值</span></div><div class="line">            mPercentLayoutInfo = PercentLayoutHelper.getPercentLayoutInfo(c, attrs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> gravity)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height, gravity);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(ViewGroup.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(MarginLayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(FrameLayout.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>((MarginLayoutParams) source);</div><div class="line">            gravity = source.gravity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>((FrameLayout.LayoutParams) source);</div><div class="line">            mPercentLayoutInfo = source.mPercentLayoutInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> PercentLayoutHelper.<span class="function">PercentLayoutInfo <span class="title">getPercentLayoutInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mPercentLayoutInfo == <span class="keyword">null</span>) &#123;</div><div class="line">                mPercentLayoutInfo = <span class="keyword">new</span> PercentLayoutHelper.PercentLayoutInfo();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> mPercentLayoutInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setBaseAttributes</span><span class="params">(TypedArray a, <span class="keyword">int</span> widthAttr, <span class="keyword">int</span> heightAttr)</span> </span>&#123;</div><div class="line">            PercentLayoutHelper.fetchWidthAndHeight(<span class="keyword">this</span>, a, widthAttr, heightAttr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>源码不长，主要是三个部分:    </p>
<ul>
<li>重写<code>onMeasure</code>，根据百分比转换成对应的尺寸</li>
<li>重写<code>onLayout</code></li>
<li>自定义<code>LayoutParams</code>，在<code>FrameLayout.LayoutParams</code>的基础上多实现了一个接口。包含了<code>PercentLayoutHelper.PercentLayoutInfo</code>属性，而文档中对<code>PercentLayoutInfo</code>的介绍是<code>Container for information about percentage dimensions and margins. It acts as an extension for LayoutParams.</code></li>
</ul>
<p>我们也先一步步的来分析，首先看下<code>mHelper.adjustChildren(widthMeasureSpec, heightMeasureSpec);</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and changes their width and height to one calculated from percentage</div><div class="line"> * values.</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Width MeasureSpec of the parent ViewGroup.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Height MeasureSpec of the parent ViewGroup.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"adjustChildren: "</span> + mHost + <span class="string">" widthMeasureSpec: "</span></div><div class="line">                + View.MeasureSpec.toString(widthMeasureSpec) + <span class="string">" heightMeasureSpec: "</span></div><div class="line">                + View.MeasureSpec.toString(heightMeasureSpec));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> widthHint = View.MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">    <span class="keyword">int</span> heightHint = View.MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">    <span class="comment">// mHost是由构造函数传递过来的，就是PercentFrameLayout自身。</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should adjust "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            <span class="comment">// 通过PercentLayoutParams. getPercentLayoutInfo()方法得到PercentLayoutInfo，至于PercentLayoutInfo类在上面也说过了。</span></div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"using "</span> + info);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">                    <span class="comment">// PercentFrameLayout.LayoutParams继承自FrameLayout.LayoutParams，而FrameLayout.LayoutParams又继承自ViewGroup.MarginLayoutParams</span></div><div class="line">                    info.fillMarginLayoutParams(view, (ViewGroup.MarginLayoutParams) params,</div><div class="line">                            widthHint, heightHint);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    info.fillLayoutParams(params, widthHint, heightHint);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以上面代码的意思就是通过对每个子<code>View</code>调用<code>getLayoutParams</code>方法，然后从该<code>LayoutParams</code>中获取到它的<code>PercentLayoutInfo</code>属性，然后再调用<code>PercentLayoutInfo.fillMarginLayoutParams()</code>方法。</p>
<p>那我们继续看一下<code>PercentLayoutInfo.fillMarginLayoutParams()</code>方法的实现，该方法是根据百分比去设置尺寸和margin:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills &#123;<span class="doctag">@code</span> ViewGroup.MarginLayoutParams&#125; dimensions and margins based on percentage</div><div class="line"> * values.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillMarginLayoutParams</span><span class="params">(View view, ViewGroup.MarginLayoutParams params,</span></span></div><div class="line">        <span class="keyword">int</span> widthHint, <span class="keyword">int</span> heightHint) &#123;</div><div class="line">    <span class="comment">// 根据百分比值设置View的尺寸</span></div><div class="line">    fillLayoutParams(params, widthHint, heightHint);</div><div class="line"></div><div class="line">    <span class="comment">// 从注释中就能知道，fillLayoutParams是计算尺寸，那下面这部分就是处理margin了</span></div><div class="line">    <span class="comment">// mPreservedParams来记录原始的margin值</span></div><div class="line">    <span class="comment">// Preserve the original margins, so we can restore them after the measure step.</span></div><div class="line">    mPreservedParams.leftMargin = params.leftMargin;</div><div class="line">    mPreservedParams.topMargin = params.topMargin;</div><div class="line">    mPreservedParams.rightMargin = params.rightMargin;</div><div class="line">    mPreservedParams.bottomMargin = params.bottomMargin;</div><div class="line">    MarginLayoutParamsCompat.setMarginStart(mPreservedParams,</div><div class="line">            MarginLayoutParamsCompat.getMarginStart(params));</div><div class="line">    MarginLayoutParamsCompat.setMarginEnd(mPreservedParams,</div><div class="line">            MarginLayoutParamsCompat.getMarginEnd(params));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (leftMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.leftMargin = (<span class="keyword">int</span>) (widthHint * leftMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (topMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.topMargin = (<span class="keyword">int</span>) (heightHint * topMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (rightMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.rightMargin = (<span class="keyword">int</span>) (widthHint * rightMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (bottomMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.bottomMargin = (<span class="keyword">int</span>) (heightHint * bottomMarginPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">boolean</span> shouldResolveLayoutDirection = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (startMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        MarginLayoutParamsCompat.setMarginStart(params,</div><div class="line">                (<span class="keyword">int</span>) (widthHint * startMarginPercent));</div><div class="line">        shouldResolveLayoutDirection = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (endMarginPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        MarginLayoutParamsCompat.setMarginEnd(params,</div><div class="line">                (<span class="keyword">int</span>) (widthHint * endMarginPercent));</div><div class="line">        shouldResolveLayoutDirection = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (shouldResolveLayoutDirection &amp;&amp; (view != <span class="keyword">null</span>)) &#123;</div><div class="line">        <span class="comment">// Force the resolve pass so that start / end margins are propagated to the</span></div><div class="line">        <span class="comment">// matching left / right fields</span></div><div class="line">        MarginLayoutParamsCompat.resolveLayoutDirection(params,</div><div class="line">                ViewCompat.getLayoutDirection(view));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"after fillMarginLayoutParams: ("</span> + params.width + <span class="string">", "</span> + params.height</div><div class="line">                + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>PercentLayoutInfo.fillLayoutParams()</code>的实现，该方法是通过百分比设置<code>View</code>的尺寸:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills &#123;<span class="doctag">@code</span> ViewGroup.LayoutParams&#125; dimensions based on percentage values.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillLayoutParams</span><span class="params">(ViewGroup.LayoutParams params, <span class="keyword">int</span> widthHint,</span></span></div><div class="line">        <span class="keyword">int</span> heightHint) &#123;</div><div class="line">    <span class="comment">// mPreservedParams来记录原始的宽高值</span></div><div class="line">    <span class="comment">// Preserve the original layout params, so we can restore them after the measure step.</span></div><div class="line">    mPreservedParams.width = params.width;</div><div class="line">    mPreservedParams.height = params.height;</div><div class="line"></div><div class="line">    <span class="comment">// We assume that width/height set to 0 means that value was unset. This might not</span></div><div class="line">    <span class="comment">// necessarily be true, as the user might explicitly set it to 0. However, we use this</span></div><div class="line">    <span class="comment">// information only for the aspect ratio. If the user set the aspect ratio attribute,</span></div><div class="line">    <span class="comment">// it means they accept or soon discover that it will be disregarded.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> widthNotSet =</div><div class="line">            (mPreservedParams.mIsWidthComputedFromAspectRatio</div><div class="line">                    || mPreservedParams.width == <span class="number">0</span>) &amp;&amp; (widthPercent &lt; <span class="number">0</span>);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> heightNotSet =</div><div class="line">            (mPreservedParams.mIsHeightComputedFromAspectRatio</div><div class="line">                    || mPreservedParams.height == <span class="number">0</span>) &amp;&amp; (heightPercent &lt; <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 如果指定了百分比属性，就用宽高值和百分比去算出具体的宽高</span></div><div class="line">    <span class="keyword">if</span> (widthPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 看到了吗？是根据父`View	`的宽高来乘以百分比，不是根据整个屏幕的宽高，这样可能会有问题，要是ListView这种的高度没法算了</span></div><div class="line">        params.width = (<span class="keyword">int</span>) (widthHint * widthPercent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (heightPercent &gt;= <span class="number">0</span>) &#123;</div><div class="line">        params.height = (<span class="keyword">int</span>) (heightHint * heightPercent);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果指定了宽高的比例值，就用比例值去算出宽高，从这里能看出`aspectRatio`的优先级比百分比要高。他可以覆盖百分比之前设置的值。</span></div><div class="line">    <span class="keyword">if</span> (aspectRatio &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (widthNotSet) &#123;</div><div class="line">            params.width = (<span class="keyword">int</span>) (params.height * aspectRatio);</div><div class="line">            <span class="comment">// Keep track that we've filled the width based on the height and aspect ratio.</span></div><div class="line">            mPreservedParams.mIsWidthComputedFromAspectRatio = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (heightNotSet) &#123;</div><div class="line">            params.height = (<span class="keyword">int</span>) (params.width / aspectRatio);</div><div class="line">            <span class="comment">// Keep track that we've filled the height based on the width and aspect ratio.</span></div><div class="line">            mPreservedParams.mIsHeightComputedFromAspectRatio = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"after fillLayoutParams: ("</span> + params.width + <span class="string">", "</span> + params.height + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">```    </div><div class="line"></div><div class="line">到这里`onMeasure`中通过百分比值设置宽高以及`margin`的部分就看完了，那我们接着看一下关于百分比值过小时对`wrap_content`的处理:     </div><div class="line">```<span class="function">java</span></div><div class="line"><span class="title">if</span> <span class="params">(mHelper.handleMeasuredStateTooSmall()</span>) &#123;</div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看一下<code>PercentLayoutHelper.handleMeasuredStateTooSmall()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and checks if any of them would like to get more space than it</div><div class="line"> * received through the percentage dimension.</div><div class="line"> *</div><div class="line"> * If you are building a layout that supports percentage dimensions you are encouraged to take</div><div class="line"> * advantage of this method. The developer should be able to specify that a child should be</div><div class="line"> * remeasured by adding normal dimension attribute with &#123;<span class="doctag">@code</span> wrap_content&#125; value. For example</div><div class="line"> * he might specify child's attributes as &#123;<span class="doctag">@code</span> app:layout_widthPercent="60%p"&#125; and</div><div class="line"> * &#123;<span class="doctag">@code</span> android:layout_width="wrap_content"&#125;. In this case if the child receives too little</div><div class="line"> * space, it will be remeasured with width set to &#123;<span class="doctag">@code</span> WRAP_CONTENT&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> True if the measure phase needs to be rerun because one of the children would like</div><div class="line"> * to receive more space.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMeasuredStateTooSmall</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> needsSecondMeasure = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should handle measured state too small "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// shouldHandleMeasuredWidthTooSmall方法来进行判断</span></div><div class="line">                <span class="keyword">if</span> (shouldHandleMeasuredWidthTooSmall(view, info)) &#123;</div><div class="line">                    needsSecondMeasure = <span class="keyword">true</span>;</div><div class="line">                    params.width = ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (shouldHandleMeasuredHeightTooSmall(view, info)) &#123;</div><div class="line">                    needsSecondMeasure = <span class="keyword">true</span>;</div><div class="line">                    params.height = ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"should trigger second measure pass: "</span> + needsSecondMeasure);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> needsSecondMeasure;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那继续看一下<code>shouldHandleMeasuredWidthTooSmall()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldHandleMeasuredWidthTooSmall</span><span class="params">(View view, PercentLayoutInfo info)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> state = ViewCompat.getMeasuredWidthAndState(view) &amp; ViewCompat.MEASURED_STATE_MASK;</div><div class="line">    <span class="keyword">return</span> state == ViewCompat.MEASURED_STATE_TOO_SMALL &amp;&amp; info.widthPercent &gt;= <span class="number">0</span> &amp;&amp;</div><div class="line">            info.mPreservedParams.width == ViewGroup.LayoutParams.WRAP_CONTENT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看<code>ViewCompat.getMeasuredWidthAndState()</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMeasuredWidthAndState</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> IMPL.getMeasuredWidthAndState(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续往下看，这个<code>IMPL</code>是什么呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ViewCompatImpl IMPL;</div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> version = android.os.Build.VERSION.SDK_INT;</div><div class="line">    <span class="keyword">if</span> (version &gt;= <span class="number">23</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> MarshmallowViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">21</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> LollipopViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">19</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> KitKatViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">17</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> JbMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">16</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> JBViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">15</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> ICSMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">14</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> ICSViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">11</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> HCViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">9</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> GBViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &gt;= <span class="number">7</span>) &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> EclairMr1ViewCompatImpl();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        IMPL = <span class="keyword">new</span> BaseViewCompatImpl();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看，<code>IMPL.getMeasuredWidthAndState()</code>，方法其实最终就是使用的<code>BaseViewCompatImpl.getMeasuredWidthAndState()</code>方法，接着看它的的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMeasuredWidthAndState</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> view.getMeasuredWidth();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>最后就是调用了<code>getMeasuredWidth()</code>方法。  没毛病- -!</p>
<p><code>onMeasure</code>的到这里就分析完了。<br>那接着来看一下<code>onLayout</code>方法,<code>onLayout</code>方法直接调用了<code>PercentLayoutHelper.restoreOriginalParams</code>，:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Iterates over children and restores their original dimensions that were changed for</div><div class="line"> * percentage values. Calling this method only makes sense if you previously called</div><div class="line"> * &#123;<span class="doctag">@link</span> PercentLayoutHelper#adjustChildren(int, int)&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreOriginalParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = mHost.getChildCount(); i &lt; N; i++) &#123;</div><div class="line">        View view = mHost.getChildAt(i);</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"should restore "</span> + view + <span class="string">" "</span> + params);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> PercentLayoutParams) &#123;</div><div class="line">            PercentLayoutInfo info =</div><div class="line">                    ((PercentLayoutParams) params).getPercentLayoutInfo();</div><div class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"using "</span> + info);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">                    info.restoreMarginLayoutParams((ViewGroup.MarginLayoutParams) params);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    info.restoreLayoutParams(params);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用了<code>PercentLayoutInfo.restoreMarginLayoutParams()</code>方法，我们看下它的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Restores original dimensions and margins after they were changed for percentage based</div><div class="line"> * values. Calling this method only makes sense if you previously called</div><div class="line"> * &#123;<span class="doctag">@link</span> PercentLayoutHelper.PercentLayoutInfo#fillMarginLayoutParams&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreMarginLayoutParams</span><span class="params">(ViewGroup.MarginLayoutParams params)</span> </span>&#123;</div><div class="line">    restoreLayoutParams(params);</div><div class="line">    <span class="comment">// mPreservedParams的值在之前ad</span></div><div class="line">    params.leftMargin = mPreservedParams.leftMargin;</div><div class="line">    params.topMargin = mPreservedParams.topMargin;</div><div class="line">    params.rightMargin = mPreservedParams.rightMargin;</div><div class="line">    params.bottomMargin = mPreservedParams.bottomMargin;</div><div class="line">    MarginLayoutParamsCompat.setMarginStart(params,</div><div class="line">            MarginLayoutParamsCompat.getMarginStart(mPreservedParams));</div><div class="line">    MarginLayoutParamsCompat.setMarginEnd(params,</div><div class="line">            MarginLayoutParamsCompat.getMarginEnd(mPreservedParams));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>意思是说，再他们被以百分比为基础的数据更改之后恢复成原始的尺寸和margin。<br>然后继续看一下<code>restoreLayoutParams()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Restores original dimensions after they were changed for percentage based values. Calling</div><div class="line">* this method only makes sense if you previously called</div><div class="line">* &#123;<span class="doctag">@link</span> PercentLayoutHelper.PercentLayoutInfo#fillLayoutParams&#125;.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreLayoutParams</span><span class="params">(ViewGroup.LayoutParams params)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mPreservedParams.mIsWidthComputedFromAspectRatio) &#123;</div><div class="line">        <span class="comment">// Only restore the width if we didn't compute it based on the height and</span></div><div class="line">        <span class="comment">// aspect ratio in the fill pass.</span></div><div class="line">        params.width = mPreservedParams.width;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!mPreservedParams.mIsHeightComputedFromAspectRatio) &#123;</div><div class="line">        <span class="comment">// Only restore the height if we didn't compute it based on the width and</span></div><div class="line">        <span class="comment">// aspect ratio in the fill pass.</span></div><div class="line">        params.height = mPreservedParams.height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Reset the tracking flags.</span></div><div class="line">    mPreservedParams.mIsWidthComputedFromAspectRatio = <span class="keyword">false</span>;</div><div class="line">    mPreservedParams.mIsHeightComputedFromAspectRatio = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了到这里也分析完了<code>onLayout</code>的方法，大意就是在<code>onMeasure</code>之前先将原始的宽高和<code>margin</code>都备份一下，然后在<code>onMeasure</code>中根据百分比去设置对应的宽高和<code>margin</code>，等到设置完之后在<code>onLayout</code>方法中再去将这些值恢复到之前备份的起始数据。说实话我没看明白为什么要这样做？</p>
<p>通过上面的代码分析我们知道对布局影响力的优先顺序: <code>app:layout_aspectRatio &gt; app:layout_heightPercent &gt; android:layout_height</code>如果我们同时都设置这三个参数值的话，最终会用<code>app:layout_aspectRatio</code>的值。</p>
<p>遗留问题:     </p>
<ul>
<li>为什么在<code>onLayout</code>方法中去恢复数据，这有什么作用？</li>
<li>看代码在处理如果指定的百分比过小但又指定<code>wrap_content</code>时，会重新根据<code>wrap_content</code>去重新计算的逻辑没有错，但是为什么我在上面测试的时候确没效果？</li>
<li>在上面分析代码时看到<code>fillLayoutParams</code>中是根据父<code>View</code>的宽高来乘以百分比，不是根据整个屏幕的宽高，这样可能会有问题，要是ListView这种的高度没法算了。</li>
</ul>
<hr>
<ul>
<li>邮箱 ：charon.chui@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/屏幕适配之百分比方案详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-性能优化相关工具" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/性能优化相关工具/">性能优化相关工具</a>
    </h1>
  

        
        <a href="/2015/01/01/性能优化相关工具/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="性能优化相关工具"><a href="#性能优化相关工具" class="headerlink" title="性能优化相关工具"></a>性能优化相关工具</h1><p>有关性能优化的文章请参考<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.md">性能优化</a>和<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E5%B8%83%E5%B1%80%E4%BC%98%E5%8C%96.md">布局优化</a>    </p>
<p>###DDMS(百宝箱)</p>
<p>#####查看进程的内存使用</p>
<p><code>DDMS</code>可以让你查看到一个进程使用的堆内存。    </p>
<ol>
<li>在<code>Device</code>了表选择你想查看的进程。</li>
<li>点击<code>Update Heap</code>按钮来开启查看进程堆内存信息。</li>
<li>在<code>Heap</code>页面，点击<code>Cause GC</code>来执行垃圾回收。</li>
<li>在列表中点击一个对象类型来查看它所分配的内存大小。   </li>
</ol>
<p>#####追踪对象的内存分配情况     </p>
<ol>
<li>在<code>Device</code>了表选择你想查看的进程。</li>
<li>在<code>Allocation Tracker</code>页面，点击<code>Start Tracking</code>按钮来开始追踪。</li>
<li>点击<code>Get Allocations</code>来查看从你点击<code>Start Tracking</code>之后分配内存的对象列表。 你可以再次点击<code>Get Allocations</code>来添加新分配内存的对象列表。 </li>
<li>停止追踪或者清除数据可以点击<code>Stop Tracking</code>按钮。 </li>
<li>在列表中单独点击一行来查看详细的信息。</li>
</ol>
<p>#####使用文件系统</p>
<p><code>DDMS</code>提供了一个文件浏览器来供你查看、拷贝、删除文件。</p>
<ol>
<li>在<code>Device</code>页面，选中你想要查看的设备。</li>
<li>从设备中拷贝文件，用文件浏览器选择文件后点击<code>Pull file</code>按钮。</li>
<li>拷贝文件到设备中，点击<code>Push file</code>按钮。</li>
</ol>
<p>#####检查线程信息  </p>
<p><code>Thread</code>页面可以显示指定进程中当前正在运行的线程。 </p>
<ol>
<li>在<code>Device</code>页面，选择想要查看的进程。 </li>
<li>点击<code>Update Threads</code>按钮。   </li>
<li>在<code>Thread</code>页面，你可以查看对应的线程信息。 </li>
</ol>
<p>#####启动方法分析</p>
<p>方法分析可以追踪一个方法的特定信息，例如调用数量，执行时间、耗时等。如果想要更精确的控制想要收集的数据，可以使用<code>startMethodTracing()</code>和<code>stopMethodTracing()</code>方法。    </p>
<p>在你开始使用方法分析之前请知晓如下限制:    </p>
<ul>
<li>在<code>Android 2.1</code>及以前的设备必须有<code>SD</code>卡，并且你的应用必须有写入<code>SD</code>卡的权限。 </li>
<li>在<code>Android 2.2</code>及以后的设备中不需要<code>SD</code>卡，<code>trace log</code>文件会直接被导入到开发机上。</li>
</ul>
<p>开启方法分析:    </p>
<ol>
<li>在<code>Device</code>页面，选择想要开启方法分析的进程。</li>
<li>点击<code>Start Method Profiling</code>按钮。</li>
<li>在<code>Android 4.4</code>及以后，可以选择<code>trace_based profiling</code>或者基本的<code>sample-based profiling</code>选项。在之前的版本智能使用<code>trace-based profiling</code>。</li>
<li>在应用中操作界面来执行你想要分析的方法。 </li>
<li>点击<code>Stop Method Profiling</code>按钮。<code>DDMS</code>会停止分析并且将在<code>Start Method Profiling</code>和<code>Stop Method Profiling</code>中间手机的方法分析数据使用<code>Traceview</code>打开。   </li>
</ol>
<h5 id="使用网络流量工具"><a href="#使用网络流量工具" class="headerlink" title="使用网络流量工具"></a>使用网络流量工具</h5><p>从<code>Android 4.0</code>开始,<code>DDMS</code>包含了一个网络使用情况的页面来支持跟踪应用的网络请求。</p>
<p>如图:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/ddms-network.png?raw=true" alt="image">。 </p>
<p>通过检测数据交互的频繁性以及在每次连接中数据的传递量，你可以知道应用中具体可以做的更好更高效的地方。<br>想要更好的查看引起数据交互的地方，可以使用<code>TrafficsStats</code>这个<code>API</code>，它也可以使用<code>setThreadStatsTag()</code>方法来设置数据使用情况的<code>tag</code>，</p>
<p>首先要讲到的是<code>Systrace</code>，之前在淘宝面试的时候被问到，如有查找<code>UI</code>绘制卡顿的问题，我没答上来。早点知道<code>Systrace</code>就好了(当然只知道工具是不够的，也要懂得里面的原理)。</p>
<h3 id="Systrace"><a href="#Systrace" class="headerlink" title="Systrace"></a>Systrace</h3><p><code>Systrace</code>有什么用呢？官方文档中有一片文章的标题是：使用<code>Systrace</code>进行<code>UI</code>性能分析。    </p>
<p>在应用程序开发的过程中，你需要检查用户交互是否平滑流畅，运行在稳定的60fps。如果中间出了些问题，导致某一帧延迟，我们想要解决该问题的第一步就是理解系统如何操作的。     </p>
<p><code>Systrace</code>工具可以让你来手机和观察整个<code>android</code>设备的时间信息，也称为<code>trace</code>。它会显示每个时间点上的<code>CPU</code>消耗图，显示每个线程在显示的内容以及每个进程当时在做的操作。</p>
<p>在使用<code>Systracv</code>来分析应用之前，你需要手机应用的<code>trace log</code>信息。生成的<code>trace</code>能够让你清晰的观察系统在该时间内所做的任何事情。 </p>
<h5 id="生成Trace"><a href="#生成Trace" class="headerlink" title="生成Trace"></a>生成Trace</h5><p>为了能创建一个<code>trace</code>，你必须要执行如下几个操作。 首先，你要有一个<code>Android 4.1</code>及以上的设备。将该设备设置为<code>debugging</code>，连接你的设备并且安装应用。有些类型的信息，特别是一些硬盘的活动和内核工作队列，需要设备获取<code>root</code>权限才可以。 然而，大多数的<code>Systrace log</code>的数据只需要设备开启开发者<code>debugging</code>就可以了。     </p>
<p><code>Systrace</code>可以通过命令行或者图形化界面的方式来运行，在<code>Studio</code>中打开<code>Android Device Monitor</code>然后选择<code>Systracv</code>图标<img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-button.png?raw=true" alt="image">。 </p>
<p>下面以命令行的方式为例，这里只讲解一下<code>Android 4.3</code>及以上的使用方式:     </p>
<ul>
<li>确保设备已经通过<code>USB</code>连接并且开启了<code>debugging</code>模式。 </li>
<li>设置一些参数并执行<code>trace</code>命令，例如:        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">    $ cd android-sdk/platform-tools/systrace</div><div class="line">    $ python systrace.py --time=10 -o mynewtrace.html sched gfx view wm</div><div class="line">    ```  </div><div class="line">    执行完上面的命令后就会在`sdk/platform-tools/systrace/mynewtrace.html`生成对应的`html`文件。 </div><div class="line">- 在设备上执行一些你想要`trace`的过程。     </div><div class="line"></div><div class="line">悲剧了，生成了对应的`html`文件，但是我死活打不开。打开是白屏，折腾了我半天，最后终于找到了解决方法:   </div><div class="line"></div><div class="line">&gt;  Firstly, if anyone is using Chrome v50.0+ on OS X, just try this please.</div><div class="line"></div><div class="line">&gt; open chrome browser and go to &quot;chrome://tracing&quot;</div><div class="line">&gt; in the tracing page, click load and select the systrace generated html file.</div><div class="line">&gt; Secondly, I think it&apos;s a bug which is confirmed by Google.</div><div class="line"></div><div class="line">`OK`了。 </div><div class="line"></div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace_file.png?raw=true =)。 </div><div class="line"></div><div class="line">看不懂！！！</div><div class="line"></div><div class="line">#####分析Trace</div><div class="line"></div><div class="line">用浏览器打开上面生成的`mynewtrace.html`。    下面为了能明显的说明，我就用官网提供的例子来说明了。   </div><div class="line"></div><div class="line">######查看Frames</div><div class="line">从打开的文件中我们能看到每个应用都有一行`frame`的圆圈来标示渲染的帧，通常都是绿色的。黄色或者红的圆圈标示超过了我们对保障60fps所需的16毫秒绘制时间。。 可以在文件上面按`w`键来放大文件以便能更好的观看查找。   </div><div class="line">&gt; ***提示:***在文件上面按`?`键可以查看对应的快捷键。  </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-unselected.png?raw=true)。 </div><div class="line"></div><div class="line">在`Android 5.0`以上的设备上，显示工作呗分为`UI Thread`和`Render Thread`。在之前的版本，所有工作都是在`UI Thread`进行的。 点击某个单独的`frame`图标来查看它们所需的时间。</div><div class="line"></div><div class="line">######观看Alerts    </div><div class="line"></div><div class="line">`Systracv`会自动分析`trace`过程的时间，并且通过`alerts`提示该展现问题，以及建议如何处理。    </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-selected.png?raw=true) </div><div class="line"></div><div class="line">如上图所示，在你点击一个比较慢的`frame`时，下面就会显示一个`alert`。在这种情况下，它直说可能是`ListView`服用以及重复渲染的问题。 如果你发现`UI Thread`做了太多的工作，你可以使用`TraceView`进行代码分析，来找到具体哪些操作导致了消耗时间。</div><div class="line"></div><div class="line">如下，你也可以通过点击窗口右边的`Alerts`来查看当前所有的`alert`。这样会直接展开`Alert`窗口。   </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/frame-selected-alert-tab.png?raw=true)</div><div class="line"></div><div class="line">下面我们以另外一个例子来分析一下它的`Frame`：    </div><div class="line"></div><div class="line">我们点击某一红色`frame`来查看这一阵的一些相关警告:   </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-frame-zoomin.png?raw=true)</div><div class="line">可以看到这里说耗时32毫秒，这已经远远超过了16毫秒的绘制时间。 我们可以通过`Description`来查看描述内容。   </div><div class="line">下面是另外一个渲染过慢的例子:     </div><div class="line"></div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-frame.png?raw=true)</div><div class="line">从上图，我们发现了`Scheduling delay`的警告，加起来能看到总的绘制时间大约是19毫秒。   </div><div class="line">`Scheduling delay`的意思是调度延迟，也就是说一个县城在处理这部分操作时，在很长时间内没有被分配到`CPU`上面进行运算，这样就导致了很长时间内没有完成操作。    我们选择这一帧中最长的一块，来观察下:    </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-slice.png?raw=true)</div><div class="line"></div><div class="line">我们在上图看到了`Wall duration`，他代表着这一块开始到结束的总耗时。而在`CPU Duration`这里显示了`CPU`在处理该部分消耗的时间。 很明显，真个区域用了18毫秒，但是`CPU`实际处理只用了4毫秒，也就是说剩下的14毫秒就可能有问题了。     </div><div class="line">![image](https://raw.githubusercontent.com/CharonChui/Pictures/master/systrace-2-cpu.png?raw=true)</div><div class="line"></div><div class="line">可以看到，4个线程都比较忙。  </div><div class="line"></div><div class="line">选择其中一个线程来查看是哪个应用在使用它，这里看到了一个包名为`com.udinic.keepbusyapp`的应用。也就是说由于另外一个应用占用了`CPU`,，导致了我们的应用未能获取到足够的`CPU`资源。      </div><div class="line"></div><div class="line"></div><div class="line">#####追踪代码</div><div class="line"></div><div class="line">在`Android 4.3`以上你可以使用`Trace`类来在代码中添加(很熟悉有木有，在看源码的时候经常看到)。这样能查看到此时你的应用线程都做了哪些操作。 </div><div class="line">下面的代码展示了如何使用`Trace`类来追踪两个代码块部分:   </div><div class="line">```java</div><div class="line">public void ProcessPeople() &#123;</div><div class="line">    Trace.beginSection(&quot;ProcessPeople&quot;);</div><div class="line">    try &#123;</div><div class="line">        Trace.beginSection(&quot;Processing Jane&quot;);</div><div class="line">        try &#123;</div><div class="line">            // code for Jane task...</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.endSection(); // ends &quot;Processing Jane&quot;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.beginSection(&quot;Processing John&quot;);</div><div class="line">        try &#123;</div><div class="line">            // code for John task...</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.endSection(); // ends &quot;Processing John&quot;</div><div class="line">        &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">        Trace.endSection(); // ends &quot;ProcessPeople&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###Traceview</p>
<p><code>Traceview</code>是一个性能测试工具，展示了所有方法的运行时间。    </p>
<blockquote>
<p>Traceview is a graphical viewer for execution logs that you create by using the Debug class to log tracing information in your code. Traceview can help you debug your application and profile its performance.</p>
</blockquote>
<p>#####创建Trace文件  </p>
<p>想要使用<code>Traceview</code>你需要创建一个包含你想分析部分的<code>trace</code>信息的<code>log</code>文件。<br>有两种方式来生成<code>trace logs</code>：    </p>
<ul>
<li><p>在你测试的类中添加<code>startMethodTracing()</code>和<code>stopMethodTracing()</code>的代码，来指定开始和结束获取<code>trace</code>信息。这种方式是非常精确的，因为你可以在代码中指定开始和结束的位置。     </p>
</li>
<li><p>使用<code>DDMS</code>中的方法来生成。这种方式就不太精确。虽然这种方式不能精确的指定起始和结束位置，但是如果在你无法修改源代码或者不需要精确时间的时候是非常有用的。 </p>
</li>
</ul>
<p>在开始生成<code>trace log</code>信息时，你需要知道如下的限制条件:    </p>
<ul>
<li>如果你在测试代码中使用，你的应用必须要用<code>WRITE_EXTERNAL_STORAGE</code>的权限。 </li>
<li><p>如果你使用<code>DDMS</code>生成:     </p>
<ul>
<li><code>Android 2.1</code>之前必须有<code>SD</code>卡，并且你的应用也要有写入<code>SD</code>卡的权限。 </li>
<li><code>Android 2.2</code>之后不需要<code>SD</code>卡，<code>trace log</code>文件会直接生成到你的开发机上。   </li>
</ul>
</li>
</ul>
<p>在测试代码中调用<code>startMethodTracing()</code>方法的时候，你可以指定系统生成<code>trace</code>文件的名字。结束的时候调用<code>stopMethodTracing()</code>方法。这些方法开始和结束时贯穿整个虚拟中的。例如你可以在你<code>activity</code>的<code>onCreate()</code>方法中调用<code>startMethodTracing()</code>方法，然后在<code>activity</code>的<code>onDestroy()</code>方法中调用<code>stopMethodTracing()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// start tracing to "/sdcard/calc.trace"</span></div><div class="line">Debug.startMethodTracing(<span class="string">"calc"</span>);</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// stop tracing</span></div><div class="line">Debug.stopMethodTracing();</div></pre></td></tr></table></figure></p>
<p>在调用<code>startMethodTracing()</code>方法的时候，系统创建一个名为<code>&lt;trace-base-name&gt;.trace</code>的文件。它包含方法的二进制<code>trace</code>数据和一个线程与方法名的对应集合。<br>然后系统就开始生成<code>trace</code>数据，直到调用<code>stopMethodTracing()</code>方法。如果在你调用<code>stopMethodTracing()</code>方法之前系统已经达到了最大的缓冲大小，系统就会停止<code>trace</code>并且在控制台发出一个通知。     </p>
<p>#####拷贝Trace文件到电脑上</p>
<p>在模拟器或者机器上生成<code>&lt;trace-base-name&gt;.trace</code>文件后，你需要拷贝他们到你的电脑上，你可以使用<code>adb pull</code>命令来拷贝：<br><code>adb pull /sdcard/calc.trace /tmp</code></p>
<p>#####在Traceview中查看trace文件    </p>
<p>运行<code>Traceview</code>并且查看<code>trace</code>文件:     </p>
<ol>
<li>打开<code>Android Device Monitor</code>。</li>
<li>在<code>Android Device Monitor</code>的状态栏中点击<code>DDMS</code>并且选择一个进程。 </li>
<li>点击<code>Start Method Profiling</code>图标开始查看。</li>
<li>在查看完后点击<code>Stop Method Profiling</code>图标来显示<code>traceview</code>。  </li>
</ol>
<p>大体的样子如下:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_1.png?raw=true" alt="image"> </p>
<p>#####Traceview Layout     </p>
<p>如果你有一个<code>trace log</code>文件(通过添加<code>tracing</code>代码或者用DDMS生成)，你可以把该文件加载到<code>Traceview</code>中，这将会把<code>log</code>数据显示为两部分:    </p>
<ul>
<li><code>timeline panel</code>-展示了每个线程和方法的起始和结束</li>
<li><code>profile panel</code>-提供了一个方法中的执行内容的简述</li>
</ul>
<p>#####Timeline Panel</p>
<p>每个线程都会以时间从左往右递增的方式在单独的一行中显示它的执行情况，</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_timeline.png?raw=true" alt="image"></p>
<p>#####Profile Panel</p>
<p>显示了一个方法所消耗的时间的概要情况。在表格中会同时显示<code>inclusive</code>和<code>exclusive</code>的时间。<code>Exclusive</code>的时间是该方法所消耗的时间。<code>InClusive</code>的时间是该方法消耗的时间加上任何调的方法所消耗的时间。我们简单的将调用的方法叫做<code>parents</code>，被调用的方法叫做<code>children</code>。如果一个方法被调用，它会显示对应的<code>parents</code>和<code>children</code>。<code>parents</code>会显示一个紫色的背景，<code>children</code>会显示一个黄色的背景。最后一列显示了该方法所调用的总数的调用数。在下面的图中我们能看到一共有14个地方调用了<code>LoadListener.nativeFinished()</code> . </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview_profile.png?raw=true" alt="image"></p>
<ul>
<li>Name 方法名</li>
<li>Inclusive CPU Time， CPU在处理该方法以及所有子方法(被它调用的所有方法)所消耗的时间。</li>
<li>Exlusive CPU Time, CPU在处理该方法的耗时。</li>
<li>Inclusive/Exclusive Real Time， 从方法开始执行到执行结束的耗时。 </li>
<li>Cal+Rec, 这个方法被调用的次数，以及递归被调用的次数。 </li>
<li>CPU/Real time per Call, 在处理这个方法时的<code>CPU</code>耗时的平均值。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview-getview.png?raw=true" alt="image"></p>
<p>上图中<code>getView</code>方法被调用了12次，每次<code>CPU</code>消耗2.8秒，但是每次调用的总耗时是162秒，这里肯定有问题。<br>而看看这个方法的children，我们可以看到这其中的每个方法在耗时方面是如何分布的。Thread.join()方法战局了98%的inclusive real time。这个方法在等待另一个线程结束的时候被调用。在Children中另外一个方法就是Tread.start()方法，而之所以整个方法耗时很长，我猜测是因为在getView()方法中启动了线程并且在等待它的结束。</p>
<p>但是这个线程在哪儿？</p>
<p>我们在getView()方法中并不能看到这个线程做了什么，因为这段逻辑不在getView()方法之中。于是我找到了Thread.run()方法，就是在线程被创建出来时候所运行的方法。而跟随这个方法一路向下，我找到了问题的元凶。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/traceview-thread.png?raw=true" alt="image"></p>
<p>我发现了BgService.doWork()方法的每次调用花费了将近14毫秒，并且有四十个这东西！而且getView()中还有可能调用多次这个方法，这就解释了为什么getView()方法执行时间如此之长。这个方法让CPU长时间的保持在了繁忙状态。而看看Exclusive CPU time，我们可以看到他占据了80%的CPU时间！此外，根据Exclusive CPU time排序，可以帮我们更好的定位那些耗时很长的方法，而他们很有可能就是造成性能问题的罪魁祸首。</p>
<p>关注这些耗时方法，例如getView()，View#onDraw()等方法，可以很好的帮助我们寻找为什么应用运行缓慢的原因。但有些时候，还会有一些其他的东西来占用宝贵的CPU资源，而这些资源如果被运用在UI的绘制上，也许我们的应用会更加流畅。Garbage Collector垃圾回收机制会不时的运行，回收那些没用的对象，通常来讲这不会影响我们在前台运行的程序。但如果GC被运行的过于频繁，他同样可以影响我们应用的执行效率。而我们该如何知道回收的是否过于频繁了呢…</p>
<p>###Monitors</p>
<p>在<code>Android Studio</code>中下方的<code>Android Monitor</code>中可以看到<code>Monitors</code>工具栏，它能不断的去检测内存、网络、CPU的消耗情况。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/monitor.png?raw=true" alt="image"></p>
<p>我们可以直接点击<code>Dump Java Heap</code>或者<code>Call GC</code>等按钮，以便更好的去观察内存的使用情况。点击后会生成一个<code>.hprof</code>的文件。生成后直接使用<code>Studio</code>打开<code>.hprof</code>文件即可。  </p>
<p>说到这里插一嘴,<a href="https://github.com/CharonChui/AndroidNote/blob/master/Java%E5%9F%BA%E7%A1%80/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6.md">有关Java垃圾回收机制请参考</a></p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/dump_href.png?raw=true" alt="image"><br>在左边能看到所有堆内存中的实例。后面会显示他所占用的内存大小。</p>
<p>对于内存泄漏的分析可以使用<code>MAT</code>或者<code>LeakCanary</code>来进行。这里就不仔细说了。   </p>
<p>#####不同虚拟机的内存管理 </p>
<p><code>Android Monitor</code>使用的<code>Virtual Machine(VM)</code>:    </p>
<ul>
<li><code>Android 4.3(API Level 18)</code>及以前的版本使用<code>Dalvik VM</code> .</li>
<li><code>Android 4.4(API Level 19)</code>默认使用<code>Dalvik VM</code>，<code>Android RunTime(ART)</code>是可选的。</li>
<li><code>Android 4.3(API Level 18)</code>及更高的版本使用<code>ART VM</code>.</li>
</ul>
<p>虚拟之执行垃圾回收。Dalvik虚拟机使用一个标记和清除垃圾收集方案。<code>ART</code>虚拟机使用分代收集算法与标记和清楚手机算法相结合的方式。 <code>Logcat</code>会显示一些垃圾回收相关的信息。     </p>
<p>#####GPU使用情况</p>
<p>上面也显示了<code>GPU</code>的使用情况，这里要说一句，如果想要显示它，必须要在手机的开发者中心中开启<code>GPU显示配置文件</code>选项，将其设置为显示与<code>adb shell dumpsys gfxinfo</code>。然后再点击<code>Studio</code>中的按钮重新开始就可以看到了。 每一条线意味着一帧被绘制出来了。而线的颜色又代表不同的阶段：    </p>
<ul>
<li>Draw(蓝色)代表着<code>View.onDraw()</code>方法。如果这个值很高就说明可能是该<code>View</code>比较复杂。 在这个环节会创建/刷新DisplayList中的对象，这些对象在后面会被转换成GPU可以明白的OpenGL命令。而这个值比较高可能是因为view比较复杂，需要更多的时间去创建他们的display list，或者是因为有太多的view在很短的时间内被创建。</li>
<li><p>Prepare(紫色)，从<code>Android 6.0</code>开始，一个新的线程被引进来帮助<code>UI</code>线程进行绘制。 这个线程叫做<code>Render Thread</code>。它负责转换它负责转换display list到OpenGL命令并且送至GPU。在这过程中，UI线程可以继续开始处理后面的帧。而在UI线程将所有资源传递给RenderThread过程中所消耗的时间，就是紫色阶段所消耗的时间。如果在这过程中有很多的资源都要进行传递，display list会变得过多过于沉重，从而导致在这一阶段过长的耗时。</p>
</li>
<li><p>Process(红色) 执行Display list中的内容并创建OpenGL命令。如果有过多或者过于复杂的display list需要执行的话，那么这阶段会消耗较长的时间，因为这样的话会有很多的view被重绘。而重绘往往发生在界面的刷新或是被移动出了被覆盖的区域。</p>
</li>
<li><p>Execute (黄色) – 发送OpenGL命令到GPU。这个阶段是一个阻塞调用，因为CPU在这里只会发送一个含有一些OpenGL命令的缓冲区给GPU，并且等待GPU返回空的缓冲区以便再次传递下一帧的OpenGL命令。而这些缓冲区的总量是一定的，如果GPU太过于繁忙，那么CPU则会去等待下一个空缓冲区。所以，如果我们看到这一阶段耗时比较长，那可能是因为GPU过于繁忙的绘制UI，而造成这个的原因则可能是在短时间内绘制了过于复杂的view。</p>
</li>
<li><p>Measure/Layout(绿色) 代表<code>Measure</code>和<code>Layout</code>的时间。 </p>
</li>
</ul>
<p>###Hierarchy Viewer</p>
<p>布局分析工具，非常常用。</p>
<p>在<code>Android Device Monitor</code>中打开<code>Hierarchy Viewer</code>即可。</p>
<ul>
<li>连接你的手机或者模拟器。<br>  出于安全性考虑，<code>Hierarchy Viewer</code>只能连接开发者版的系统的手机。 </li>
<li>运行程序，并且让界面显示出来。</li>
<li>启动<code>hierarchy view</code>工具，接着就能看到左边栏显示出了对应的设备，展开后可以看到一些组件的名称。这个页面包含了应用的界面以及系统的界面。选择你的应用中想要查看的界面直接双击就可以了。    </li>
</ul>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/gettingstarted_image005.png?raw=true" alt="image"><br>如果你的界面显示的不是这个样子，少一些东西的话，你可以使用<code>Window&gt;Reset Perspective</code>来重置样式。 </p>
<p>但是我并打不开。<br>如果你的手机是<code>Android 4.1</code>及以上版本你必须要在你的电脑上设置一个<code>ANDROID_HVPROTO</code>DE 环境变量才可以。</p>
<ul>
<li>Windows<br>  增加一个名为<code>ANDROID_HVPROTO</code>值为<code>ddm</code>的环境变量就可以了。 </li>
<li><p>Mac </p>
<ul>
<li>打开<code>.bash_profile</code><ul>
<li><code>touch .bash_profile</code>创建</li>
<li><code>open -e .bash_profile</code>打开</li>
</ul>
</li>
<li><p>添加    </p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#Hierarchy Viewer Variable              </div><div class="line">export ANDROID_HVPROTO=ddm</div></pre></td></tr></table></figure>
</li>
<li><p><code>source .bash_profile</code></p>
</li>
</ul>
</li>
</ul>
<p>如果配置完成后仍然不能用的话，你可以:   </p>
<ul>
<li>关闭<code>Android Studio</code>.</li>
<li>执行<code>add kill-server</code>，然后<code>adb start-server</code>.</li>
<li>通过命令行开始<code>hierarchyviewer</code>.</li>
</ul>
<p>好了，我们直接打开自己的页面进行查看布局吧(有点慢)。<br>它是介个样子滴 ：<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/hierarchy_vierwe_page.png?raw=true" alt="image"></p>
<p>我们可以看到所有结构，点击对一个的节点，能直接看到该界面的<code>UI</code>效果，并展示该布局包含多少个<code>View</code>，以及该布局<code>measure,draw,layout</code>所消耗的时间。选中<code>Show Extras</code>选项可以看到在右下角看到界面效果。   </p>
<p>选中要查看的节点后点击<code>Profile Node</code>选项，可以看到如下界面:    </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/hierarchy_profile_node.png?raw=true" alt="image"></p>
<p>可以看到每个布局都出现了三个点。有不同的颜色,从左到右这三个点分别表示:   </p>
<ul>
<li>左边的点代表<code>Draw</code>阶段。</li>
<li>中间的点代表了<code>Layout</code>阶段。</li>
<li>右边的点代表了<code>Execute</code>阶段。</li>
</ul>
<p>这三个点有分别对应了<code>pipeline</code>中的不同阶段，如下图:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/gettingstarted_image015.png?raw=true" alt="image"></p>
<p>不同的颜色代表不同的性能:    </p>
<ul>
<li>绿色代表渲染的非常快，至少是其他<code>View</code>的一半。</li>
<li>黄色代表<code>View</code>渲染比最后那一半的<code>View</code>快。</li>
<li>红色代表<code>View</code>渲染是几乎是在最慢的那部分中间。</li>
</ul>
<p><code>Hierarchy Viewer</code>测量的是相对的表现能力，所以总会有一个红色的节点，它并不意味者该<code>View</code>一定是绘制的太慢。 </p>
<p>###过度绘制</p>
<p>在开发者选项中将调试GPU过度绘制设置为显示过度绘制区域，就能看到程序的绘制情况。<br>过度绘制往往发生在我们需要在一个东西上面绘制另外一个东西，例如在一个红色的背景上画一个黄色的按钮。那么GPU就需要先画出红色背景，再在他上面绘制黄色按钮，此时过度绘制就是不可避免的了。如果我们有太多层需要绘制，那么则会过度的占用GPU导致我们每帧消耗的时间超过16毫秒。<br>这些过度绘制可能发生在我们给Activity或Fragment设置了全屏的背景，同时又给ListView以及ListView的条目设置了背景色。而通过只设置一次背景色即可解决这样的问题。</p>
<p>注意：默认的主题会为你指定一个默认的全屏背景色，如果你的activity又一个不透平的背景盖住了默认的背景色，那么你可以移除主题默认的背景色，这样也会移除一层的过度绘制。这可以通过配置主题配置或是通过代码的方法，在onCreate()方法中调用getWindow().setBackgroundDrawable(null)方法来实现。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/overdraw-gif.gif?raw=true" alt="image"></p>
<p>###Hardware Acceleration</p>
<p>在Honeycomb版本中引入了硬件加速（Hardware Accleration）后，我们的应用在绘制的时候就有了全新的绘制模型。它引入了DisplayList结构，用来记录View的绘制命令，以便更快的进行渲染。但还有一些很好的功能开发者们往往会忽略或者使用不当——View layers。</p>
<p>使用View layers（硬件层），我们可以将view渲染入一个非屏幕区域缓冲区（off-screen buffer，前面透明度部分提到过），并且根据我们的需求来操控它。这个功能主要是针对动画，因为它能让复杂的动画效果更加的流畅。而不使用硬件层的话，View会在动画属性（例如coordinate, scale, alpha值等）改变之后进行一次刷新。而对于相对复杂的view，这一次刷新又会连带它所有的子view进行刷新，并各自重新绘制，相当的耗费性能。使用View layers，通过调用硬件层，GPU直接为我们的view创建一个结构，并且不会造成view的刷新。而我们可以在避免刷新的情况下对这个结构进行进行很多种的操作，例如x/y位置变换，旋转，透明度等等。总之，这意味着我们可以对一个让一个复杂view执行动画的同时，又不会刷新！这会让动画看起来更加的流畅。<br>在阅读了ViewPager的源码后，我发现了在滑动的时候会自动为左右两页启动一个硬件层，并且在滑动结束后移除掉。</p>
<p>在两页间滑动的时候创建硬件层也是可以理解的，但对我来说小有不幸。通常来讲加入硬件层是为了让ViewPager的滑动更加流畅，毕竟它们相对复杂。</p>
<p>是的，但是再使用硬件layers的时候还是有几点要牢记在心：</p>
<ul>
<li>回收 – 硬件层会占用GPU中的一块内存。只在必要的时候使用他们，比如动画，并且事后注意回收。例如在上面ObjectAnimator的例子中，我们增加了一个动画结束监听以便在动画结束后可以移除硬件层。而在Property animator的例子中，我们使用了withLayers()，这会在动画开始时候自动创建硬件层并且在结束的时候自动移除。</li>
<li>如果你在调用了硬件View layers后改变了View，那么会造成硬件硬件层的刷新并且再次重头渲染一遍view到非屏幕区域缓存中。这种情况通常发生在我们使用了硬件层暂时还不支持的属性（目前为止，硬件层只针对以下几种属性做了优化：otation、scale、x/y、translation、pivot和alpha）。例如，如果你另一个view执行动画，并且使用硬件层，在屏幕滑动他们的同时改变他的背景颜色，这就会造成硬件层的持续刷新。而以硬件层的持续刷新所造成的性能消耗来说，可能让它在这里的使用变得并不那么值。</li>
</ul>
<p>有关如何使用<code>Hardware Layer</code>请参考之前写的文章:<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E9%80%9A%E8%BF%87Hardware%20Layer%E6%8F%90%E9%AB%98%E5%8A%A8%E7%94%BB%E6%80%A7%E8%83%BD.md">通过Hardware Layer提高动画性能</a></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/性能优化相关工具/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Android卸载反馈" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/Android卸载反馈/">Android卸载反馈</a>
    </h1>
  

        
        <a href="/2015/01/01/Android卸载反馈/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android卸载反馈"><a href="#Android卸载反馈" class="headerlink" title="Android卸载反馈"></a>Android卸载反馈</h1><p>最初记得是在360安全卫士中出现的，在手机上卸载他的应用之后浏览器就会弹出一个反馈页面，让用户进行反馈，感觉这种功能对于产品改进特别有帮助。<br>但是仔细一想该怎么去实现却犯愁了，最开始想这也简单啊，不就是监听下自身被卸载就可以了，应该系统会有卸载的广播，可惜没有。甚至其他的一些<br>方法也是不行的，因为你程序都被卸载了，你的代码怎么会执行呢？皮之不存，毛将焉附。那360是怎样实现的呢？说句真心话360做的产品还是非常有创新<br>的，虽然有些时候他会损坏用户的利益，不过但从技术方面，着实让人信服。</p>
<p>既然<code>Java</code>实现不了，那就得考虑下其他的了，自然最先想到的就是<code>JNI</code>了，可惜<code>C</code>的部分不懂，上网搜了很多资料和介绍，找得到可以通过一下方式实现:   </p>
<ul>
<li><p>通过<code>c</code>中的<code>fork</code>方法来复制一个子进程。复制出来的子进程在父进程被销毁后，仍然可以存在。<br>  <code>pid_t fpid = fork()</code>被调用前，就一个进程执行该段代码，这条语句执行之后，就会有两个进程执行该代码，两个进程执行没有固定先后顺序，只要看<br>  系统调度策略，<code>fork()</code>函数的特别之处在于调用一次会返回两次结果：   </p>
<pre><code>- 返回值大于0，当前是父进程。
- 返回0，当前是子进程。
- 返回小于0的负值。(出错了，可能是内存不足或者是进程数已经达到系统最大值)
</code></pre></li>
<li><p><code>fork</code>出子进程后让子进程一直去监听<code>/data/data/packageName</code>是否存在，如果不存在了，那就说明程序被卸载了，但是这样一直去轮训判断肯定会浪费<br>  系统资源的，当然也会更加费电，对用户来讲肯定是有损害的。所以这种技术最好也不好用，不然大家的手机以后还能了得。万恶的产品。</p>
</li>
<li><p>得到程序被卸载之后弹出浏览器打开指定反馈页面。这就要用到<code>am</code>命令了，最早知道这个命令是在开发<code>TV</code>版的时候，遥控器找不到了，程序安装后无法<br> 打开了，用该命令就不怕了，哈哈。但是在<code>c</code>中怎么执行<code>am</code>命令呢？这就要用到<code>execlp()</code>函数，该函数就是<code>c</code>中执行系统命令的函数。</p>
</li>
</ul>
<p>好了，主要的内容上面都分析完了，下面上代码。</p>
<ul>
<li><p><code>Java</code>层定义<code>natvie</code>方法。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"@@@"</span>;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.activity_main);</div><div class="line">		String packageDir = <span class="string">"/data/data/"</span> + getPackageName();</div><div class="line">		initUninstallFeedback(packageDir, Build.VERSION.SDK_INT);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">initUninstallFeedback</span><span class="params">(String packagePath, <span class="keyword">int</span> sdkVersion)</span></span>;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		System.loadLibrary(<span class="string">"uninstall_feedback"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建jni目录，增加<code>Android.mk</code>以及<code>uninstall_feedback.c</code>文件。<br><code>Android.mk</code>的内容:</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line"></div><div class="line">include $(CLEAR_VARS)</div><div class="line"></div><div class="line">LOCAL_MODULE    := uninstall_feedback</div><div class="line">LOCAL_SRC_FILES := uninstall_feedback.c</div><div class="line"></div><div class="line">LOCAL_C_INCLUDES := $(LOCAL_PATH)/include</div><div class="line">LOCAL_LDLIBS += -L$(SYSROOT)/usr/lib -llog</div><div class="line"></div><div class="line">include $(BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<p><code>uninstall_feedback.c</code>的实现: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 将Java中的String转换成c中的char字符串</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">Jstring2CStr</span><span class="params">(JNIEnv* env, jstring jstr)</span> </span>&#123;</div><div class="line">	<span class="keyword">char</span>* rtn = <span class="literal">NULL</span>;</div><div class="line">	jclass clsstring = (*env)-&gt;FindClass(env, <span class="string">"java/lang/String"</span>); <span class="comment">//String</span></div><div class="line">	jstring strencode = (*env)-&gt;NewStringUTF(env, <span class="string">"GB2312"</span>); <span class="comment">// 得到一个java字符串 "GB2312"</span></div><div class="line">	jmethodID mid = (*env)-&gt;GetMethodID(env, clsstring, <span class="string">"getBytes"</span>,</div><div class="line">			<span class="string">"(Ljava/lang/String;)[B"</span>); <span class="comment">//[ String.getBytes("gb2312");</span></div><div class="line">	jbyteArray barr = (jbyteArray)(*env)-&gt;CallObjectMethod(env, jstr, mid,</div><div class="line">			strencode); <span class="comment">// String .getByte("GB2312");</span></div><div class="line">	jsize alen = (*env)-&gt;GetArrayLength(env, barr); <span class="comment">// byte数组的长度</span></div><div class="line">	jbyte* ba = (*env)-&gt;GetByteArrayElements(env, barr, JNI_FALSE);</div><div class="line">	<span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</div><div class="line">		rtn = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(alen + <span class="number">1</span>); <span class="comment">//""</span></div><div class="line">		<span class="built_in">memcpy</span>(rtn, ba, alen);</div><div class="line">		rtn[alen] = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	(*env)-&gt;ReleaseByteArrayElements(env, barr, ba, <span class="number">0</span>); <span class="comment">//</span></div><div class="line">	<span class="keyword">return</span> rtn;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Java_com_charon_uninstallfeedback_MainActivity_initUninstallFeedback</span><span class="params">(</span></span></div><div class="line">		JNIEnv* env, jobject thiz, jstring packageDir, jint sdkVersion) &#123;</div><div class="line"></div><div class="line">	<span class="keyword">char</span> * pd = Jstring2CStr(env, packageDir);</div><div class="line"></div><div class="line">	<span class="comment">//fork子进程，以执行轮询任务</span></div><div class="line">	<span class="keyword">pid_t</span> pid = fork();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// fork失败了</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// 可以一直采用一直判断文件是否存在的方式去判断，但是这样效率稍低，下面使用监听的方式，死循环，每个一秒判断一次，这样太浪费资源了。</span></div><div class="line">		<span class="keyword">int</span> check = <span class="number">1</span>;</div><div class="line">		<span class="keyword">while</span> (check) &#123;</div><div class="line">			FILE* file = fopen(pd, <span class="string">"rt"</span>);</div><div class="line">			<span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (sdkVersion &gt;= <span class="number">17</span>) &#123;</div><div class="line">					<span class="comment">// Android4.2系统之后支持多用户操作，所以得指定用户</span></div><div class="line">					execlp(<span class="string">"am"</span>, <span class="string">"am"</span>, <span class="string">"start"</span>, <span class="string">"--user"</span>, <span class="string">"0"</span>, <span class="string">"-a"</span>,</div><div class="line">							<span class="string">"android.intent.action.VIEW"</span>, <span class="string">"-d"</span>,</div><div class="line">							<span class="string">"http://shouji.360.cn/web/uninstall/uninstall.html"</span>,</div><div class="line">							(<span class="keyword">char</span>*) <span class="literal">NULL</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Android4.2以前的版本无需指定用户</span></div><div class="line">					execlp(<span class="string">"am"</span>, <span class="string">"am"</span>, <span class="string">"start"</span>, <span class="string">"-a"</span>,</div><div class="line">						<span class="string">"android.intent.action.VIEW"</span>, <span class="string">"-d"</span>,</div><div class="line">							<span class="string">"http://shouji.360.cn/web/uninstall/uninstall.html"</span>,</div><div class="line">							(<span class="keyword">char</span>*) <span class="literal">NULL</span>);</div><div class="line">				&#125;</div><div class="line">				check = <span class="number">0</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			&#125;</div><div class="line">			sleep(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编译so文件。<code>Windows</code>下要用<code>cygwin</code>来操作。<br>上面的介绍是在<code>Eclipse</code>中进行的，用<code>ndk-build</code>命令来编译<code>so</code>。具体请看之前写的<code>JNI基础</code>这篇文章。</li>
</ul>
<p>有关如何在<code>Android Stuido</code>中进行<code>ndk</code>开发请看另一篇文章。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/Android卸载反馈/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-自定义View详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/自定义View详解/">自定义View详解</a>
    </h1>
  

        
        <a href="/2015/01/01/自定义View详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="自定义View详解"><a href="#自定义View详解" class="headerlink" title="自定义View详解"></a>自定义View详解</h1><p>虽然之前也分析过<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/View%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3.md">View回执过程</a>，但是如果让我自己集成<code>ViewGroup</code>然后自己重新<code>onMeasure,onLayout,onDraw</code>方法自定义<code>View</code>我还是会头疼。今天索性来系统的学习下。</p>
<p>###onMeasure</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * &lt;p&gt;</div><div class="line">     * Measure the view and its content to determine the measured width and the</div><div class="line">     * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line">     * should be overridden by subclasses to provide accurate and efficient</div><div class="line">     * measurement of their contents.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line">     * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line">     * measured width and height of this view. Failure to do so will trigger an</div><div class="line">     * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line">     * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line">     * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * The base class implementation of measure defaults to the background size,</div><div class="line">     * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line">     * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line">     * their content.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * If this method is overridden, it is the subclass's responsibility to make</div><div class="line">     * sure the measured height and width are at least the view's minimum height</div><div class="line">     * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line">     * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line">     *                         The requirements are encoded with</div><div class="line">     *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line">     * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line">     *                         The requirements are encoded with</div><div class="line">     *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line">     * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line">     * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line">     * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line">     * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line">     * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line">     * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line">     */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">                getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>注释说的非常清楚。但是我还是要强调一下这两个参数:<code>widthMeasureSpec</code>和<code>heightMeasureSpec</code>这两个int类型的参数，看名字应该知道是跟宽和高有关系，但它们其实不是宽和高，而是由宽、高和各自方向上对应的模式来合成的一个值：其中，在int类型的32位二进制位中，31-30这两位表示模式，0~29这三十位表示宽和高的实际值.其中模式一共有三种，被定义在Android中的View类的一个内部类中：View.MeasureSpec：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">android.view</div><div class="line">public static class View.MeasureSpec</div><div class="line">extends Object</div><div class="line">A MeasureSpec encapsulates the layout requirements passed from parent to child. Each MeasureSpec represents a requirement for either the width or the height. A MeasureSpec is comprised of a size and a mode. There are three possible modes:</div><div class="line">UNSPECIFIED</div><div class="line">The parent has not imposed any constraint on the child. It can be whatever size it wants.</div><div class="line">EXACTLY</div><div class="line">The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.</div><div class="line">AT_MOST</div><div class="line">The child can be as large as it wants up to the specified size.</div><div class="line">MeasureSpecs are implemented as ints to reduce object allocation. This class is provided to pack and unpack the &lt;size, mode&gt; tuple into the int.</div></pre></td></tr></table></figure>
<ul>
<li>MeasureSpec.UNSPECIFIED The parent has not imposed any constraint on the child. It can be whatever size it wants. 这种情况比较少，一般用不到。标示父控件没有给子View任何显示- - - -对应的二进制表示: 00</li>
<li>MeasureSpec.EXACTLY The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.<br>理解成MATCH_PARENT或者在布局中指定了宽高值，如layout:width=’50dp’. - - - - 对应的二进制表示:01</li>
<li>MeasureSpec.AT_MOST The child can be as large as it wants up to the specified size.理解成WRAP_CONTENT,这是的值是父View可以允许的最大的值，只要不超过这个值都可以。- - - - 对应的二进制表示:10</li>
</ul>
<p>那具体<code>MeasureSpec</code>是怎么把宽和高的实际值以及模式组合起来变成一个int类型的值呢？ 这部分是在<code>MeasureSpce.makeMeasureSpec()</code>方法中处理的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> mode)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (sUseBrokenMakeMeasureSpec) &#123;</div><div class="line">                <span class="keyword">return</span> size + mode;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>那我们如何从MeasureSpec值中提取模式和大小呢？该方法内部是采用位移计算.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Extracts the mode from the supplied measure specification.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measureSpec the measure specification to extract the mode from</div><div class="line"> * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#UNSPECIFIED&#125;,</div><div class="line"> *         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#AT_MOST&#125; or</div><div class="line"> *         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#EXACTLY&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Extracts the size from the supplied measure specification.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measureSpec the measure specification to extract the size from</div><div class="line"> * <span class="doctag">@return</span> the size in pixels defined in the supplied measure specification</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (measureSpec &amp; ~MODE_MASK);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###onLayout</p>
<p>为了能合理的去绘制定义<code>View</code>,你需要制定它的大小。复杂的自定义<code>View</code>通常需要根据屏幕的样式和大小来进行复杂的布局计算。你不应该假设你的屏幕上的<code>View</code>的大小。即使只有一个应用使用你的自定义<code>View</code>，也需要处理不同的屏幕尺寸、屏幕密度和横屏以及竖屏下的多种比率等。</p>
<p>虽然<code>View</code>有很多处理测量的方法，但他们中的大部分都不需要被重写。如果你的<code>View</code>不需要特别的控制它的大小，你只需要重写一个方法:<code>onSizeChanged()</code>。</p>
<p><code>onSizeChanged()</code>方法会在你的<code>View</code>第一次指定大小后调用，在因某些原因改变大小后会再次调用。在上面<code>PieChart</code>的例子中，<code>onSizeChanged()</code>方法就是它需要重新计算表格样式和大小以及其他元素的地方。<br>下面就是<code>PieChart.onSizeChanged()</code>方法的内容:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Account for padding</span></div><div class="line"><span class="keyword">float</span> xpad = (<span class="keyword">float</span>)(getPaddingLeft() + getPaddingRight());</div><div class="line"><span class="keyword">float</span> ypad = (<span class="keyword">float</span>)(getPaddingTop() + getPaddingBottom());</div><div class="line"></div><div class="line"><span class="comment">// Account for the label</span></div><div class="line"><span class="keyword">if</span> (mShowText) xpad += mTextWidth;</div><div class="line"></div><div class="line"><span class="keyword">float</span> ww = (<span class="keyword">float</span>)w - xpad;</div><div class="line"><span class="keyword">float</span> hh = (<span class="keyword">float</span>)h - ypad;</div><div class="line"></div><div class="line"><span class="comment">// Figure out how big we can make the pie.</span></div><div class="line"><span class="keyword">float</span> diameter = Math.min(ww, hh);</div></pre></td></tr></table></figure>
<p>###onDraw</p>
<p>自定义<code>View</code>最重要的就是展现样式。</p>
<p>#####重写<code>onDraw()</code>方法</p>
<p>绘制自定义<code>View</code>最重要的步骤就是重写<code>onDraw()</code>方法。<code>onDraw()</code>方法的参数是<code>Canvas</code>对象。可以用它来绘制自身。<code>Canvas</code>类定义了绘制文字、线、位图和很多其他图形的方法。你可以在<code>onDraw()</code>方法中使用这些方法来指定<code>UI</code>.</p>
<p>在使用任何绘制方法之前，你都必须要创建一个<code>Paint</code>对象。  </p>
<p>#####创建绘制的对象</p>
<p><code>android.graphics</code>框架将绘制分为两步:     </p>
<ul>
<li>绘制什么，由<code>Canvas</code>处理。</li>
<li>怎么去绘制，由<code>Paint</code>处理。</li>
</ul>
<p>#####<code>Canvas</code></p>
<blockquote>
<p>The Canvas class holds the “draw” calls. To draw something, you need 4 basic components: A Bitmap to hold the pixels,<br> a Canvas to host the draw calls (writing into the bitmap), a drawing primitive (e.g. Rect, Path, text, Bitmap),<br>and a paint (to describe the colors and styles for the drawing).  </p>
</blockquote>
<ul>
<li><code>Canvas()</code>:创建一个空的画布，可以使用<code>setBitmap()</code>方法来设置绘制的具体画布； </li>
<li><code>Canvas(Bitmap bitmap)</code>:以<code>bitmap</code>对象创建一个画布，则将内容都绘制在<code>bitmap</code>上，<code>bitmap</code>不得为<code>null</code>; </li>
<li><code>canvas.drawRect(RectF,Paint)</code>方法用于画矩形，第一个参数为图形显示区域，第二个参数为画笔，设置好图形显示区域<code>Rect</code>和画笔<code>Paint</code>后，即可画图； </li>
<li><code>canvas.drawRoundRect(RectF, float, float, Paint)</code>方法用于画圆角矩形，第一个参数为图形显示区域，第二个参数和第三个参数分别是水平圆角半径和垂直圆角半径。 </li>
<li><code>canvas.drawLine(startX, startY, stopX, stopY, paint)</code>：前四个参数的类型均为<code>float</code>，最后一个参数类型为<code>Paint</code>。表示用画笔<code>paint</code>从点<code>（startX,startY）</code>到点<code>（stopX,stopY）</code>画一条直线； </li>
<li><code>canvas.drawLines (float[] pts, Paint paint)``pts</code>:是点的集合，大家下面可以看到，这里不是形成连接线，而是每两个点形成一条直线，<code>pts</code>的组织方式为<code>｛x1,y1,x2,y2,x3,y3,……｝</code>，例如<code>float []pts={10,10,100,100,200,200,400,400};</code>就是有四个点：（10，10）、（100，100），（200，200），（400，400）），两两连成一条直线；</li>
<li><code>canvas.drawArc(oval, startAngle, sweepAngle, useCenter, paint)</code>：第一个参数<code>oval</code>为<code>RectF</code>类型，即圆弧显示区域，<code>startAngle</code>和<code>sweepAngle</code>均为<code>float</code>类型，分别表示圆弧起始角度和圆弧度数,3点钟方向为0度，<code>useCenter</code>设置是否显示圆心，<code>boolean</code>类型，<code>paint</code>为画笔； </li>
<li><code>canvas.drawCircle(float,float, float, Paint)</code>方法用于画圆，前两个参数代表圆心坐标，第三个参数为圆半径，第四个参数是画笔； </li>
<li><code>canvas.drawBitmap(Bitmap bitmap, Rect src, Rect dst, Paint paint)</code> 位图，参数一就是我们常规的<code>Bitmap</code>对象，参数二是源区域(这里是<code>bitmap</code>)，参数三是目标区域(应该在<code>canvas</code>的位置和大小)，参数四是<code>Paint</code>画刷对象，因为用到了缩放和拉伸的可能，当原始<code>Rect</code>不等于目标<code>Rect</code>时性能将会有大幅损失。</li>
<li><code>canvas.drawText(String text, float x, floaty, Paint paint)</code>渲染文本，<code>Canvas</code>类除了上<br>面的还可以描绘文字，参数一是<code>String</code>类型的文本，参数二<code>x</code>轴，参数三<code>y</code>轴，参数四是<code>Paint</code>对象。</li>
<li><code>canvas.drawPath (Path path, Paint paint)</code>，根据<code>Path</code>去画.  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Path path = <span class="keyword">new</span> Path();  </div><div class="line">path.moveTo(<span class="number">10</span>, <span class="number">10</span>); <span class="comment">//设定起始点  </span></div><div class="line">path.lineTo(<span class="number">10</span>, <span class="number">100</span>);<span class="comment">//第一条直线的终点，也是第二条直线的起点  </span></div><div class="line">path.lineTo(<span class="number">300</span>, <span class="number">100</span>);<span class="comment">//画第二条直线  </span></div><div class="line">path.lineTo(<span class="number">500</span>, <span class="number">100</span>);<span class="comment">//第三条直线  </span></div><div class="line">path.close();<span class="comment">//闭环  </span></div><div class="line">canvas.drawPath(path, paint);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>#####<code>Paint</code></p>
<ul>
<li><code>setARGB(int a, int r, int g, int b)</code> 设置<code>Paint</code>对象颜色，参数一为<code>alpha</code>透明值</li>
<li><code>setAlpha(int a)</code> 设置<code>alpha</code>不透明度，范围为0~255</li>
<li><code>setAntiAlias(boolean aa)</code>是否抗锯齿</li>
<li><code>setColor(int color)</code>设置颜色</li>
<li><code>setTextScaleX(float scaleX)</code>设置文本缩放倍数，1.0f为原始</li>
<li><code>setTextSize(float textSize)</code>设置字体大小</li>
<li><code>setUnderlineText(String underlineText)</code>设置下划线</li>
</ul>
<p>例如，<code>Canvas</code>提供了一个画一条线的方法，而<code>Paint</code>提供了指定这条线的颜色的方法。<code>Canvas</code>提供了绘制长方形的方法，而<code>Paint</code>提供了是用颜色填充整个长方形还是空着的方法。简单的说，<code>Canvas</code>指定了你想在屏幕上绘制的形状，而<code>Paint</code>指定了你要绘制的形状的颜色、样式、字体和样式等等。   </p>
<p>所以，在你<code>draw</code>任何东西之前，你都需要创建一个或者多个<code>Paint</code>对象。下面的<code>PieChart</code>例子就是在构造函数中调用的<code>init</code>方法:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   mTextPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">   mTextPaint.setColor(mTextColor);</div><div class="line">   <span class="keyword">if</span> (mTextHeight == <span class="number">0</span>) &#123;</div><div class="line">       mTextHeight = mTextPaint.getTextSize();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       mTextPaint.setTextSize(mTextHeight);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   mPiePaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">   mPiePaint.setStyle(Paint.Style.FILL);</div><div class="line">   mPiePaint.setTextSize(mTextHeight);</div><div class="line"></div><div class="line">   mShadowPaint = <span class="keyword">new</span> Paint(<span class="number">0</span>);</div><div class="line">   mShadowPaint.setColor(<span class="number">0xff101010</span>);</div><div class="line">   mShadowPaint.setMaskFilter(<span class="keyword">new</span> BlurMaskFilter(<span class="number">8</span>, BlurMaskFilter.Blur.NORMAL));</div><div class="line"></div><div class="line">   ...</div></pre></td></tr></table></figure>
<p>下面是<code>PieChart</code>完整的<code>onDraw()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">   <span class="keyword">super</span>.onDraw(canvas);</div><div class="line"></div><div class="line">   <span class="comment">// Draw the shadow</span></div><div class="line">   canvas.drawOval(</div><div class="line">           mShadowBounds,</div><div class="line">           mShadowPaint</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// Draw the label text</span></div><div class="line">   canvas.drawText(mData.get(mCurrentItem).mLabel, mTextX, mTextY, mTextPaint);</div><div class="line"></div><div class="line">   <span class="comment">// Draw the pie slices</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mData.size(); ++i) &#123;</div><div class="line">       Item it = mData.get(i);</div><div class="line">       mPiePaint.setShader(it.mShader);</div><div class="line">       canvas.drawArc(mBounds,</div><div class="line">               <span class="number">360</span> - it.mEndAngle,</div><div class="line">               it.mEndAngle - it.mStartAngle,</div><div class="line">               <span class="keyword">true</span>, mPiePaint);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// Draw the pointer</span></div><div class="line">   canvas.drawLine(mTextX, mPointerY, mPointerX, mPointerY, mTextPaint);</div><div class="line">   canvas.drawCircle(mPointerX, mPointerY, mPointerSize, mTextPaint);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面是一张<code>View</code>绘制过程中框架调用的一些标准方法概要图:<br>    <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/custom_view_methods.png?raw=true" alt="image"></p>
<p>下面来几个例子:    </p>
<p>自定义开关:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToogleView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> Bitmap backgroundBitmap;</div><div class="line">    <span class="keyword">private</span> Bitmap slideButton;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        backgroundBitmap = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_bg);</div><div class="line">        slideButton = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_slide);</div><div class="line">        <span class="keyword">this</span>.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSlideMarginLeft == <span class="number">0</span>) &#123;</div><div class="line">                    mSlideMarginLeft = backgroundBitmap.getWidth() - slideButton.getWidth();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        Paint paint = <span class="keyword">new</span> Paint();</div><div class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        <span class="comment">// 先画背景图</span></div><div class="line">        canvas.drawBitmap(backgroundBitmap, <span class="number">0</span>, <span class="number">0</span>, paint);</div><div class="line">        <span class="comment">// 再画滑块，用mSlideMarginLeft来控制滑块距离左边的距离。</span></div><div class="line">        canvas.drawBitmap(slideButton, mSlideMarginLeft, <span class="number">0</span>, paint);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span> &gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">com.charon.recyclerviewdemo.ToogleView</span></span></div><div class="line">        <span class="attr">android:paddingLeft</span>=<span class="string">"50dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_green_light"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/toogle_1.png?raw=true" alt="image"><br>很明显显示的不对，因为高设置为<code>warp_content</code>了，但是界面显示的确实整个屏幕，而且<code>paddingLeft</code>也没生效，那该怎么做呢？ 当然是重写<code>onMeasure()</code> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToogleView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> Bitmap backgroundBitmap;</div><div class="line">    <span class="keyword">private</span> Bitmap slideButton;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        backgroundBitmap = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_bg);</div><div class="line">        slideButton = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_slide);</div><div class="line">        <span class="keyword">this</span>.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSlideMarginLeft == <span class="number">0</span>) &#123;</div><div class="line">                    mSlideMarginLeft = backgroundBitmap.getWidth() - slideButton.getWidth();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> measureWidth = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> measureWidthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> measureHeight = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> measureHeightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> width;</div><div class="line">        <span class="keyword">int</span> height;</div><div class="line">        <span class="keyword">if</span> (MeasureSpec.EXACTLY == measureWidthMode) &#123;</div><div class="line">            width = measureWidth;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            width = backgroundBitmap.getWidth();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (MeasureSpec.EXACTLY == measureHeightMode) &#123;</div><div class="line">            height = measureHeight;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            height = backgroundBitmap.getHeight();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setMeasuredDimension(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        Paint paint = <span class="keyword">new</span> Paint();</div><div class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        canvas.drawBitmap(backgroundBitmap, getPaddingLeft(), <span class="number">0</span>, paint);</div><div class="line">        canvas.drawBitmap(slideButton, mSlideMarginLeft + getPaddingLeft(), <span class="number">0</span>, paint);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就可以了。简单的说明一下，就是如果当前的模式是<code>EXACTLY</code>那就把父<code>View</code>传递进来的宽高设置进来，如果是<code>AT_MOST</code>或者<code>UNSPECIFIED</code>的话就使用背景图片的宽高。</p>
<p>最后再来一个自定义<code>ViewGroup</code>的例子:       </p>
<p>之前的引导页面都是通过类似<code>ViewPager</code>这种方法左右滑动，现在想让他上下滑动，该怎么弄呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerticalLayout</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerticalLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerticalLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerticalLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继承<code>ViewGroup</code>必须要重写<code>onLayout</code>方法。其实这也很好理解，因为每个<code>ViewGroup</code>的排列方式不一样，所以让子类来自己实现是最好的。<br>当然畜类重写<code>onLayout</code>之外，也要重写<code>onMeasure</code>。<br>代码如下，滑动手势处理的部分就不贴了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> measureSpec = MeasureSpec.makeMeasureSpec(mScreenHeight</div><div class="line">			* getChildCount(), MeasureSpec.getMode(heightMeasureSpec));</div><div class="line">	<span class="keyword">super</span>.onMeasure(widthMeasureSpec, measureSpec);</div><div class="line">	measureChildren(widthMeasureSpec, heightMeasureSpec);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">       <span class="comment">// 就像猴子捞月一样，让他们一个个的从上往下排就好了</span></div><div class="line">	<span class="keyword">if</span> (changed) &#123;</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getVisibility() != View.GONE) &#123;</div><div class="line">				child.layout(l, i * mScreenHeight, r, (i + <span class="number">1</span>)</div><div class="line">						* mScreenHeight);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面介绍了通过继承<code>View</code>以及<code>ViewGroup</code>的方式来自定义<code>View</code>，平时开发过程中有时不需要继承他俩，我们直接继承功能接近<br>的类进行扩展就好，例如:我想自定义一个<code>Meterial Design</code>样式的<code>EditText</code>。那我们该怎么实现呢？ 当然是继承<code>EditText</code>了，它比<code>EditText</code>多了一条底下的线，那我们给它<code>draw</code>上就可以了。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/meterial_edittext.png?raw=true" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetrailEditText</span> <span class="keyword">extends</span> <span class="title">EditText</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> NinePatchDrawable mDrawable;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MetrailEditText</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MetrailEditText</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        setBackgroundResource(<span class="number">0</span>);</div><div class="line">        mDrawable = (NinePatchDrawable) getResources().getDrawable(R.drawable.edittext_meterial_bg_activated);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(<span class="keyword">final</span> Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        mDrawable.setBounds(-getCompoundPaddingLeft(), <span class="number">0</span>, getWidth() + getCompoundPaddingRight(), getHeight());</div><div class="line">        mDrawable.draw(canvas);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到这里你可能会糊涂，这哪行啊？ 我们的<code>edittext_meterial_bg_activated</code>可不是普通的图，当然是<code>9 patch</code>图了。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/meterial_edittext_line.png?raw=true" alt="image"></p>
<p>当然你可以在<code>onDraw()</code>的时候加一个自定义线的颜色<code>mDrawable.setColorFilter(mLineColor, PorterDuff.Mode.SRC_ATOP);</code>等。</p>
<p>参考部分:       </p>
<ul>
<li><a href="http://blog.csdn.net/cyp331203/article/details/40736027" target="_blank" rel="external">http://blog.csdn.net/cyp331203/article/details/40736027</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! I</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/自定义View详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-视频播放相关内容总结" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/视频播放相关内容总结/">视频播放相关内容总结</a>
    </h1>
  

        
        <a href="/2015/01/01/视频播放相关内容总结/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="视频播放相关内容总结"><a href="#视频播放相关内容总结" class="headerlink" title="视频播放相关内容总结"></a>视频播放相关内容总结</h1><h2 id="多媒体常识："><a href="#多媒体常识：" class="headerlink" title="多媒体常识："></a>多媒体常识：</h2><ul>
<li><p>什么是多媒体             </p>
<p>  多媒体是计算机和视频技术的结合，实际上它是两个媒体；声音和图像，或者用现在的术语：音响和电视</p>
</li>
<li><p>常用的视频格式</p>
<p>  Android系统默认：mp4、3gp<br>  常用格式：ts、3gpp、3g2、3gpp2、avi、mkv、flv、divx、f4v、rm、rmvb、rv、wmv、asf、mov、mpg、v8、ram、mpeg、<br>  swf、m2v、asx、ra、ram、ndivx、xvid等     </p>
</li>
<li><p>常用音频格式：</p>
<p>  Android系统：mp3、ogg；<br>  常用格式：wma、mid、m4a、xmf、aac、mpa、midi、ar等</p>
</li>
<li><p>常用图片格式：PNG、GIF、BMP、jpg</p>
</li>
<li><p>国内各个视频网站采用的解码框架：</p>
<ul>
<li>优酷、搜狐、奇艺、pps、暴风影音土豆、56网都是用的ffmpeg.       </li>
<li>pptv已经使用p2p技术<br>  点对点技术（peer-to-peer， 简称P2P）又称对等互联网络技术，是一种网络新技术，依赖网络中参与者的计算能力和带宽，<br>  而不是把依赖都聚集在较少的几台服务器上。P2P网络通常用于通过Ad Hoc连接来连接节点。这类网络可以用于多种用途，<br>  各种档案分享软件已经得到了广泛的使用。P2P技术也被使用在类似VoIP等实时媒体业务的数据通信中。</li>
</ul>
</li>
</ul>
<p>目前常用的开发框架：</p>
<ul>
<li><p>VLC框架：<br>  VLC是一个开源项目，基于ffmpeg框架的自定义播放器。其中LibVLC是VLC的核心部分，就相当于MediaPlayer类<br>  VLC一个最主要的部分，它可以播放各种类型的媒体文件和流媒体文件，并且可以创造媒体流并保存成各种格式的媒体文件<br>  VLC是一种跨平台的媒体播放器和流媒体服务器，最初为videolan的客户端，它是一种非常简便的多媒体播放器，<br>  它可以用来播放各种各样的音视频的格式文件(MPEG-1、MPEG-2、MPEG- 4、DivX、WMV、mp3、OGG、Vorbis、AC3、AAC等等)流媒体协议<br>  最具特色的功能是可以边下载边观看Divx媒体文件，并可以播放不完全的AVI文件。并且支持界面的更改。<br>  缺点：有C/C++代码，还有Java代码，代码太庞大             </p>
</li>
<li><p>ffmpeg框架：<br>  优点：轻量级框架，易于维护<br>  FFmpeg是一个集录制、转换、音/视频编码解码功能为一体的完整的开源解决方案<br>  FFMPEG几乎为你把所有的繁重工作都做了，比如解码、编码、复用和解复用。<br>  这使得多媒体应用程序变得容易编写。它是一个简单的，用C编写的，快速的并且能够解码几乎所有你能用到的格式，当然也包括编码多种格式。<br>  FFmpeg支持MPEG、DivX、MPEG4、AC3、DV、FLV等40多种编码，支持AVI、MPEG、OGG、Matroska、ASF等90多种解码<br>  FFmpeg主目录下主要有libavcodec、libavformat和libavutil等子目录。其中libavcodec用于存放各个encode/decode模块<br>  libavformat用于存放muxer/demuxer模块，libavutil用于存放内存操作等辅助性模块</p>
</li>
<li><p>vitamio框架：<br>  vitamio也是基于ffmpeg开源框架<br>  VPlayer是vitamio的一个产品，vitamio和VPlayer是同一个团队开发的，VPlayer能播放的vitamio也能播放         </p>
</li>
</ul>
<p>##Surface简介</p>
<ul>
<li><code>Surface</code>就是“表面”的意思。在<code>SDK</code>的文档中，对<code>Surface</code>的描述是这样的：“<code>Handle onto a raw buffer that is being managed by the screen compositor</code>”，<br>  翻译成中文就是“由屏幕显示内容合成器<code>(screen compositor)</code>所管理的原生缓冲器的句柄”，    这句话包括下面两个意思：<ul>
<li>通过Surface（因为Surface是句柄）就可以获得原生缓冲器以及其中的内容。就像在C语言中，可以通过一个文件的句柄，就可以获得文件的内容一样；</li>
<li>原生缓冲器（rawbuffer）是用于保存当前窗口的像素数据的。</li>
</ul>
</li>
<li>简单的说<code>Surface</code>对应了一块屏幕缓冲区，每个<code>Window</code>对应一个<code>Surface</code>，任何<code>View</code>都是画在<code>Surface</code>上的，传统的<code>view</code>共享一块屏幕缓冲区，所有的绘制必须在<code>UI</code>线程中进行</li>
<li>我们不能直接操作Surface实例，要通过SurfaceHolder，在SurfaceView中可以通过getHolder()方法获取到SurfaceHolder实例。</li>
<li><code>Surface</code>是一个用来画图形的地方，但是我们知道画图都是在一个<code>Canvas</code>对象上面进行的，<em><code>Surface</code>中的<code>Canvas</code>成员，是专门用于提供画图的地方，就像黑板一样，其中的原始缓冲区是用来保存数据的地方，<br>  <code>Surface</code>本身的作用类似一个句柄，得到了这个句柄就可以得到其中的<code>Canvas</code>、原始缓冲区以及其他方面的内容，所以简单的说<code>Surface</code>是用来管理数据的(句柄)</em>。</li>
</ul>
<p>##SurfaceView简介      </p>
<ul>
<li><p>简单的说<code>SurfaceView</code>就是一个有<code>Surface</code>的<code>View</code>里面内嵌了一个专门用于绘制的<code>Surface</code>,<code>SurfaceView</code>控制这个<code>Surface</code>的格式和尺寸以及绘制位置.<code>SurfaceView</code>是一个<code>View</code>也许不够严谨，<br>  然而从定义中 <code>public class SurfaceView extends View</code>显示<code>SurfaceView</code>确实是派生自<code>View</code>，但是<code>SurfaceView</code>却有着自己的<code>Surface</code>，源码：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">if</span> (mWindow == <span class="keyword">null</span>) &#123;  </div><div class="line">mWindow = <span class="keyword">new</span> MyWindow(<span class="keyword">this</span>);  </div><div class="line">mLayout.type = mWindowType;  </div><div class="line">mLayout.gravity = Gravity.LEFT|Gravity.TOP;  </div><div class="line">mSession.addWithoutInputChannel(mWindow, mWindow.mSeq, mLayout,  </div><div class="line">mVisible ? VISIBLE : GONE, mContentInsets);  </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  很明显，每个<code>SurfaceView</code>创建的时候都会创建一个<code>MyWindow</code>，<code>new MyWindow(this)</code>中的<code>this</code>正是<code>SurfaceView</code>自身，因此将<code>SurfaceView</code>和<code>window</code>绑定在一起，而前面提到过每个<code>window</code>对应一个<code>Surface</code>，<br>  所以<code>SurfaceView</code>也就内嵌了一个自己的<code>Surface</code>，可以认为<code>SurfaceView</code>是来控制<code>Surface</code>的位置和尺寸。传统<code>View</code>及其派生类的更新只能在<code>UI</code>线程，然而<code>UI</code>线程还同时处理其他交互逻辑，<br>  这就无法保证<code>view</code>更新的速度和帧率了，而<code>SurfaceView</code>可以用独立的线程来进行绘制，因此可以提供更高的帧率，例如游戏，摄像头取景等场景就比较适合用<code>SurfaceView</code>来实现。</p>
</li>
<li><p><code>Surface</code>是纵深排序<code>(Z-ordered)</code>的，这表明它总在自己所在窗口的后面。</p>
</li>
<li><code>Surfaceview</code>提供了一个可见区域，只有在这个可见区域内的<code>Surface</code>部分内容才可见，可见区域外的部分不可见，所以可以认为<strong><code>SurfaceView</code>就是展示<code>Surface</code>中数据的地方</strong>,<code>Surface</code>就是管理数据的地方，<br>  <code>SurfaceView</code>就是展示数据的地方，只有通过<code>SurfaceView</code>才能展现<code>Surface</code>中的数据。<br>  <img src="https://github.com/CharonChui/Pictures/master/SurfaceView.png?raw=true" alt="image">   </li>
<li><code>Surface</code>的排版显示受到视图层级关系的影响，它的兄弟视图结点会在顶端显示。这意味者<code>Surface</code>的内容会被它的兄弟视图遮挡，这一特性可以用来放置遮盖物<code>(overlays)</code>(例如，文本和按钮等控件)。<br>  注意，如果<code>Surface</code>上面有透明控件，那么它的每次变化都会引起框架重新计算它和顶层控件的透明效果，这会影响性能。surfaceview变得可见时，surface被创建；surfaceview隐藏前，surface被销毁。<br>  这样能节省资源。如果你要查看 surface被创建和销毁的时机，可以重载surfaceCreated(SurfaceHolder)和 surfaceDestroyed(SurfaceHolder)。<br>  <strong><code>SurfaceView</code>的核心在于提供了两个线程：<code>UI</code>线程和渲染线程</strong>,两个线程通过“双缓冲”机制来达到高效的界面适时更新。</li>
</ul>
<p>##SurfaceHolder简介</p>
<p>显示一个<code>Surface</code>的抽象接口，使你可以控制<code>Surface</code>的大小和格式以及在<code>Surface</code>上编辑像素，和监视<code>Surace</code>的改变。这个接口通常通过<code>SurfaceView</code>类实现。<br>简单的说就是我们无法直接操作<code>Surface</code>只能通过<code>SurfaceHolder</code>这个接口来获取和操作<code>Surface</code>。<br>SurfaceHolder<code>中提供了一些</code>lockCanvas()`：获取一个Canvas对象，并锁定之。所得到的Canvas对象，其实就是Surface中一个成员。加锁的目的其实就是为了在绘制的过程中，<br>Surface中的数据不会被改变。lockCanvas是为了防止同一时刻多个线程对同一canvas写入。</p>
<p><em>从设计模式的角度来看,<code>Surface、SurfaceView、SurfaceHolder</code>实质上就是<code>MVC(Model-View-Controller)</code>，<code>Model</code>就是模型或者说是数据模型，更简单的可以理解成数据，在这里也就是<code>Surface</code>，<br><code>View</code>就是视图，代表用户交互界面，这里就是<code>SurfaceView</code>,<code>SurfaceHolder</code>就是<code>Controller.</code></em></p>
<p>##MediaController</p>
<ul>
<li><code>MediaController</code>继承<code>FrameLayout</code>，通过<code>MediaPlayerControl</code>接口与<code>VideoView</code>进行结合控制，内部是通过<code>PopupWindow</code>将整个控制栏界面显示到界面上，<br>  而该<code>PopupWindow</code>所显示在的位置就是通过<code>setAnchorView()</code>设置进来的<code>Anchor</code>一般可以使当前的<code>VideoView</code>或者是整个<code>Activity</code>的根布局。这里要分为小屏和全屏两种情况来进行设置。<br>  如果当前的<code>MediaController</code>只是播放前下面的控制栏部分(进度条、快进、快退、暂停等)这样我们可以通过对VideoView设置点击事件，控制它的显示和隐藏。<br>  如果<code>MediaController</code>为整个屏幕包括了控制栏部分、上端的信息显示部分、以及左右栏的功能部分、这时候就可以通过对<code>MediaController</code>本身设置点击事件来控制显示和隐藏。         </li>
</ul>
<p><code>Controller</code>可以用<code>PopupWindow</code>来实现,具体有两种方式：     </p>
<pre><code>- 整个控制栏(上面的信息部分、下面的控制部分以及左右边)都在`Controller`中，`setAnchorView()`的时候就会让`Controller`中的`PopupWindow`显示出来(一直显示，但是这个`PopupWindow`是透明的)，
    真正的显示与隐藏是控制在`PopupWindow`中的`View`部分的显示与隐藏来实现。开始的时候我是想用这种方式，当时我想的是播放就播放、控制就控制，分离开来多好，但是没想到，
    一旦有`PopupWindow`显示出来后，Activity是接收不到任何`Touch`事件的，所有的重试界面等都要放到`Controller`中实现(手势处理等)。但是也有好处，就是不管显示还是隐藏都可以去处理手势.

- `PopupWindow`不是全屏的，只包含下面真正的控制部分(快进、快退、暂停等,不包含上面的信息部分和左右边),而且也不是开始就显示，显示隐藏是通过控制`PopupWindow`的显示与隐藏来进行的。
    而对于信息部分、以及左右边都是在`Activity`的布局当中，我们通过接口回调得到`PopupWindow`的显示与隐藏来控制这些布局的显示与隐藏即可。
    这样的话我们就需要将手势等全部放到`Activity`中去处理，但是也有一个问题，就是如果`Controller`正在显示的话`Activity`是接收不到`Touch`事件的，就无法处理手势，只能是让`Controller`消失后才能处理手势。
</code></pre><hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/视频播放相关内容总结/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-视频解码之软解与硬解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/视频解码之软解与硬解/">视频解码之软解与硬解</a>
    </h1>
  

        
        <a href="/2015/01/01/视频解码之软解与硬解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="视频解码之软解与硬解"><a href="#视频解码之软解与硬解" class="headerlink" title="视频解码之软解与硬解"></a>视频解码之软解与硬解</h1><p><strong>硬解</strong>：从字面意思上理解就是用硬件来进行解码，通过显卡的视频加速功能对高清视频进行解码，很明显就是一个专门的电路板(这样好理解…)来进行视频的解码，是依靠显卡<code>GPU</code>的。                    </p>
<p><strong>软解</strong>：字面上理解就是用软件进行解码，这样理解也对，但是实际最总还是要硬件来支持的，这个硬件就是<code>CPU</code>。</p>
<p>既然有这两种不同的解码方式，我们在开发中该如何进行选择？哪个更好？                     </p>
<ul>
<li><p>硬解优缺点：<br>  显卡核心GPU拥有独特的计算方法，解码效率非常高，而且充当解码核心的模块成本并不高。这样不但能够减轻CPU的负担，还有着低功耗、发热少等特点。但是由于硬解码起步比较晚，<br>  软件和驱动对其的支持度低。硬解码内置有什么样的模块就能够解码什么样的视频，面对网络上杂乱无章的视频编码格式，不可能做到完全兼容同。此外，硬解码的滤镜、字母、画质增强方面都做的十分不足。</p>
<p>  优点：低功耗、发热少、效率高。<br>  缺点：视频兼容性差、支持度低。                </p>
</li>
<li><p>软解优缺点：<br>  软解码技术的解码过程中，需要对大量的视频信息进行运算，对CPU性能的要求非常高。尤其是对高清晰度大码率的视频来说，巨大的运算量就会造成转换效率低、发热量大等问题。<br>  但是由于软解码的过程中不需要复杂的硬件支持，兼容性非常高。即使是新出的视频编码格式，只要安装好相应的解码器文件，就能顺利播放。而且软解码拥有丰富的滤镜、字幕、画面处理优化等效果，<br>  如果<code>CPU</code>足够强悍的话，能够实现更加出色的画面效果。</p>
<p>  优点：  兼容强、全解码、效果好<br>  缺点：  对<code>CPU</code>要求高、效率低、发热大                 </p>
</li>
</ul>
<p>关于软解与硬解究竟哪个更好的问题一直是争论的热点，其实我倒是感觉没有好坏之分，各自有各自的优缺点和使用条件，根据需要去选择才是最合适的。<br>播放码率比较大的视频，硬解可能流畅的播放，但是软解可能会出现演示、画面和声音卡顿不同步的问题。但是硬解播放出的视频大多都不允许在解码之后进行软件后处理，比如进行一些降噪锐化之类的后期滤镜，<br>这样可能会让人感觉画质不太好的。当然上面的这种情况也是和<code>CPU</code>及<code>GPU</code>能力的不同而不同的。 总的来说，还是各有春秋，适合你的才是最好的。 </p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/视频解码之软解与硬解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-热修复实现" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/热修复实现/">热修复实现</a>
    </h1>
  

        
        <a href="/2015/01/01/热修复实现/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="热修复实现"><a href="#热修复实现" class="headerlink" title="热修复实现"></a>热修复实现</h1><p>现在的热修复方案已经有很多了，例如<code>alibaba</code>的<a href="https://github.com/alibaba/dexposed">dexposed</a>、<a href="https://github.com/alibaba/AndFix">AndFix</a>以及<code>jasonross</code>的<a href="https://github.com/jasonross/Nuwa">Nuwa</a>等等。原来没有仔细去分析过也没想写这篇文章，但是之前<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android加强/InstantRun详解.md">InstantRun详解</a>这篇文章中介绍了<code>Android Studio Instant Run</code>的<br>实现原理，这不就是活生生的一个热修复吗？ 随心情久久不能平复，我们何不用这种方式来实现。    </p>
<p>方案有很多种，我就只说明下我想到的方式，也就是<code>Instant Run</code>的方式:<br>分拆到不同的<code>dex</code>中，然后通过<code>classloader</code>来进行加载。但是在之前<code>InstantRun详解</code>中只说到会通过内部的<code>server</code>去判断该类是否有更新，如果有的话就去从新的<code>dex</code>中加载该类，否则就从旧的<code>dex</code>中加载，但这是如何实现的呢？ 怎么去从不同的<code>dex</code>中选择最新的那个来进行加载。    </p>
<p>讲到这里需要先介绍一下<code>ClassLoader</code>：       </p>
<p>&lt; <code>A class loader is an object that is responsible for loading classes. The class ClassLoader is an abstract class. Given the binary name of a class, a class loader should attempt to locate or generate data that constitutes a definition for the class. A typical strategy is to transform the name into a file name and then read a &quot;class file&quot; of that name from a file system.</code>     </p>
<p>在一般情况下，应用程序不需要创建一个全新的ClassLoader对象，而是使用当前环境已经存在的ClassLoader。因为Javad的Runtime环境在初始化时，其内部会创建一个ClassLoader对象用于加载Runtime所需的各种Java类。<br>每个ClassLoader必须有一个父ClassLoader，在装载Class文件时，子ClassLoader会先请求父ClassLoader加载该Class文件，只有当其父ClassLoader找不到该Class文件时，子ClassLoader才会继续装载该类，这是一种安全机制。</p>
<p>对于Android的应用程序，本质上虽然也是用Java开发，并且使用标准的Java编译器编译出Class文件，但最终的APK文件中包含的却是dex类型的文件。dex文件是将所需的所有Class文件重新打包，打包的规则不是简单的压缩，而是完全对Class文件内部的各种函数表、变量表等进行优化，并产生一个新的文件，这就是dex文件。由于dex文件是一种经过优化的Class文件，因此要加载这样特殊的Class文件就需要特殊的类装载器，这就是DexClassLoader，Android SDK中提供的DexClassLoader类就是出于这个目的。</p>
<p>总体来说，<code>Android</code> 默认主要有三个<code>ClassLoader</code>:   </p>
<ul>
<li><p><code>BootClassLoader</code>: 系统启动时创建，<br>  &lt; `Provides an explicit representation of the boot class loader. It sits at the</p>
<ul>
<li>head of the class loader chain and delegates requests to the VM’s internal</li>
<li>class loading mechanism.`</li>
</ul>
</li>
<li><p><code>PathClassLoader</code>: 可以加载/data/app目录下的apk，这也意味着，它只能加载已经安装的apk；</p>
</li>
<li><code>DexClassLoader</code>: 可以加载文件系统上的jar、dex、apk；可以从SD卡中加载未安装的apk</li>
</ul>
<p>通过上面的分析知道，如果用多个<code>dex</code>的话肯定会用到<code>DexClassLoader</code>类，我们首先来看一下它的源码(这里<br>插一嘴，源码可以去<a href="https://android.googlesource.com/platform/libcore-snapshot/+/ics-mr1/dalvik/src/main/java/dalvik/system" target="_blank" rel="external">googlesource</a>中找):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A class loader that loads classes from &#123;<span class="doctag">@code</span> .jar&#125; and &#123;<span class="doctag">@code</span> .apk&#125; files</div><div class="line"> * containing a &#123;<span class="doctag">@code</span> classes.dex&#125; entry. This can be used to execute code not</div><div class="line"> * installed as part of an application.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This class loader requires an application-private, writable directory to</div><div class="line"> * cache optimized classes. Use &#123;<span class="doctag">@code</span> Context.getDir(String, int)&#125; to create</div><div class="line"> * such a directory: &lt;pre&gt;   &#123;<span class="doctag">@code</span></div><div class="line"> *   File dexOutputDir = context.getDir("dex", 0);</div><div class="line"> * &#125;&lt;/pre&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;&lt;strong&gt;Do not cache optimized classes on external storage.&lt;/strong&gt;</div><div class="line"> * External storage does not provide access controls necessary to protect your</div><div class="line"> * application from code injection attacks.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a &#123;<span class="doctag">@code</span> DexClassLoader&#125; that finds interpreted and native</div><div class="line">     * code.  Interpreted classes are found in a set of DEX files contained</div><div class="line">     * in Jar or APK files.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;The path lists are separated using the character specified by the</div><div class="line">     * &#123;<span class="doctag">@code</span> path.separator&#125; system property, which defaults to &#123;<span class="doctag">@code</span> :&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</div><div class="line">     *     resources, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;, which</div><div class="line">     *     defaults to &#123;<span class="doctag">@code</span> ":"&#125; on Android</div><div class="line">     * <span class="doctag">@param</span> optimizedDirectory directory where optimized dex files</div><div class="line">     *     should be written; must not be &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> libraryPath the list of directories containing native</div><div class="line">     *     libraries, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;; may be</div><div class="line">     *     &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> parent the parent class loader</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></div><div class="line">            String libraryPath, ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">new</span> File(optimizedDirectory), libraryPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释说的太明白了，这里就不翻译了，但是我们并没有找到加载的代码，去它的父类中查找，<br>因为家在都是从<code>loadClass()</code>方法中，所以我们去<code>ClassLoader</code>类中看一下<code>loadClass()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Loads the class with the specified name. Invoking this method is</div><div class="line">     * equivalent to calling &#123;<span class="doctag">@code</span> loadClass(className, false)&#125;.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;strong&gt;Note:&lt;/strong&gt; In the Android reference implementation, the</div><div class="line">     * second parameter of &#123;<span class="doctag">@link</span> #loadClass(String, boolean)&#125; is ignored</div><div class="line">     * anyway.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the &#123;<span class="doctag">@code</span> Class&#125; object.</div><div class="line">     * <span class="doctag">@param</span> className</div><div class="line">     *            the name of the class to look for.</div><div class="line">     * <span class="doctag">@throws</span> ClassNotFoundException</div><div class="line">     *             if the class can not be found.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String className) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        <span class="keyword">return</span> loadClass(className, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Loads the class with the specified name, optionally linking it after</div><div class="line">     * loading. The following steps are performed:</div><div class="line">     * &lt;ol&gt;</div><div class="line">     * &lt;li&gt; Call &#123;<span class="doctag">@link</span> #findLoadedClass(String)&#125; to determine if the requested</div><div class="line">     * class has already been loaded.&lt;/li&gt;</div><div class="line">     * &lt;li&gt;If the class has not yet been loaded: Invoke this method on the</div><div class="line">     * parent class loader.&lt;/li&gt;</div><div class="line">     * &lt;li&gt;If the class has still not been loaded: Call</div><div class="line">     * &#123;<span class="doctag">@link</span> #findClass(String)&#125; to find the class.&lt;/li&gt;</div><div class="line">     * &lt;/ol&gt;</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;strong&gt;Note:&lt;/strong&gt; In the Android reference implementation, the</div><div class="line">     * &#123;<span class="doctag">@code</span> resolve&#125; parameter is ignored; classes are never linked.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the &#123;<span class="doctag">@code</span> Class&#125; object.</div><div class="line">     * <span class="doctag">@param</span> className</div><div class="line">     *            the name of the class to look for.</div><div class="line">     * <span class="doctag">@param</span> resolve</div><div class="line">     *            Indicates if the class should be resolved after loading. This</div><div class="line">     *            parameter is ignored on the Android reference implementation;</div><div class="line">     *            classes are not resolved.</div><div class="line">     * <span class="doctag">@throws</span> ClassNotFoundException</div><div class="line">     *             if the class can not be found.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        Class&lt;?&gt; clazz = findLoadedClass(className);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            ClassNotFoundException suppressed = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">            	<span class="comment">// 先检查父ClassLoader是否已经家在过该类</span></div><div class="line">                clazz = parent.loadClass(className, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                suppressed = e;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                	<span class="comment">// 调用DexClassLoader.findClass()方法。</span></div><div class="line">                    clazz = findClass(className);</div><div class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                    e.addSuppressed(suppressed);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> clazz;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上面会调用<code>DexClassLoader.findClass()</code>方法，但是<code>DexClassLoader</code>没有实现该方法，所以去它的父类<code>BaseDexClassLoader</code>中看，接着看一下<code>BaseDexClassLoader</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Base class for common functionality between various dex-based</div><div class="line"> * &#123;<span class="doctag">@link</span> ClassLoader&#125; implementations.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line">    <span class="comment">/** originally specified path (just used for &#123;<span class="doctag">@code</span> toString()&#125;) */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String originalPath;</div><div class="line">    <span class="comment">/** structured lists of path elements */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructs an instance.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</div><div class="line">     * resources, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;, which</div><div class="line">     * defaults to &#123;<span class="doctag">@code</span> ":"&#125; on Android</div><div class="line">     * <span class="doctag">@param</span> optimizedDirectory directory where optimized dex files</div><div class="line">     * should be written; may be &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> libraryPath the list of directories containing native</div><div class="line">     * libraries, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;; may be</div><div class="line">     * &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> parent the parent class loader</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></div><div class="line">            String libraryPath, ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(parent);</div><div class="line">        <span class="keyword">this</span>.originalPath = dexPath;</div><div class="line">        <span class="keyword">this</span>.pathList =</div><div class="line">            <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        <span class="comment">// 从DexPathList中找</span></div><div class="line">        Class clazz = pathList.findClass(name);</div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> clazz;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pathList.findResource(name);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pathList.findResources(name);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findLibrary</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pathList.findLibrary(name);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在<code>findClass()</code>方法中我们看到调用了<code>DexPathList.findClass()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A pair of lists of entries, associated with a &#123;<span class="doctag">@code</span> ClassLoader&#125;.</div><div class="line"> * One of the lists is a dex/resource path &amp;mdash; typically referred</div><div class="line"> * to as a "class path" &amp;mdash; list, and the other names directories</div><div class="line"> * containing native code libraries. Class path entries may be any of:</div><div class="line"> * a &#123;<span class="doctag">@code</span> .jar&#125; or &#123;<span class="doctag">@code</span> .zip&#125; file containing an optional</div><div class="line"> * top-level &#123;<span class="doctag">@code</span> classes.dex&#125; file as well as arbitrary resources,</div><div class="line"> * or a plain &#123;<span class="doctag">@code</span> .dex&#125; file (with no possibility of associated</div><div class="line"> * resources).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This class also contains methods to use these lists to look up</div><div class="line"> * classes and resources.&lt;/p&gt;</div><div class="line"> */</div><div class="line"><span class="comment">/*package*/</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEX_SUFFIX = <span class="string">".dex"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAR_SUFFIX = <span class="string">".jar"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZIP_SUFFIX = <span class="string">".zip"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APK_SUFFIX = <span class="string">".apk"</span>;</div><div class="line">    <span class="comment">/** class definition context */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader definingContext;</div><div class="line">    <span class="comment">/** list of dex/resource (class path) elements */</span> </div><div class="line">    <span class="comment">// 把dex封装成一个数组，每个Element代表一个dex</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Element[] dexElements;</div><div class="line">    <span class="comment">/** list of native library directory elements */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File[] nativeLibraryDirectories;</div><div class="line"></div><div class="line">    <span class="comment">// .....</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Finds the named class in one of the dex files pointed at by</div><div class="line">     * this instance. This will find the one in the earliest listed</div><div class="line">     * path element. If the class is found but has not yet been</div><div class="line">     * defined, then this method will define it in the defining</div><div class="line">     * context that this instance was constructed with.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the named class or &#123;<span class="doctag">@code</span> null&#125; if the class is not</div><div class="line">     * found in any of the dex files</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</div><div class="line">            DexFile dex = element.dexFile;</div><div class="line">            <span class="comment">// 遍历数组，拿到第一个就返回</span></div><div class="line">            <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</div><div class="line">                Class clazz = dex.loadClassBinaryName(name, definingContext);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> clazz;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面的源码中分析，我知道系统会把所有相关的<code>dex</code>维护到一个数组中，然后在加载类的时候会从该数组中的第一个元素中取，然后返回。那我们只要保证将我们热修复后的<code>dex</code>对应的<code>Element</code>放到该数组的第一个位置就可以了，这样系统就会加载我们热修复的<code>dex</code>中的类。<br>所以方案出来了，只要把有问题的类修复后，放到一个单独的<code>dex</code>，然后把该<code>Dex</code>转换成对应的<code>Element</code>后再将该<code>Element</code>插入到<code>dexElements</code>数组的第一个位置就可以了。那该如何去将其插入到<code>dexElements</code>数组的第一个位置呢？– 暴力反射。      </p>
<p>到这里我感觉初步的思路已经有了:      </p>
<ul>
<li>将补丁作为<code>dex</code>发布。 </li>
<li>通过反射修改该<code>dex</code>所对应的<code>Element</code>在数组中的位置。 </li>
</ul>
<p>但是我也想到肯定还会有类似下面的问题:     </p>
<ul>
<li>资源文件的处理</li>
<li>四大组件的处理</li>
<li>清单文件的处理</li>
</ul>
<p>虽然我知道没有这么简单，但是我还是决定抱着不作不死的宗旨继续前行。    </p>
<p>好了，<code>demo</code>走起来。    </p>
<p>怎么生成<code>dex</code>文件呢？<br>这要讲过两部分:   </p>
<ul>
<li><code>.class</code>-&gt; <code>.jar</code> : <code>jar  -cvf test.jar com/charon/instantfix_sample/MainActivity.class</code></li>
<li><code>.jar</code>-&gt; <code>.dex</code>: <code>dx --dex --output=target.jar test.jar</code> <code>target.jar</code>就是包含<code>.dex</code>的<code>jar</code>包</li>
</ul>
<p>生成好<code>dex</code>后我们为了模拟先将其放到<code>asset</code>目录下(实际开发中肯定要从接口中去下载，当然还会有一些版本号的判断等)，然后就是将该<code>dex</code>转换成</p>
<p>我的方案中采用的是MultiDex，对其进行一部分改造，具体代码：<br>1、添加dex文件，并执行install<br>/**</p>
<ul>
<li>添加apk包外的dex文件</li>
<li>自动执行install</li>
<li>@param dexFile<br>*/<br>public static void addDexFileAutoInstall(Context context, List<file> dexFile,File optimizedDirectory) {<br>  if (dexFile != null &amp;&amp; !dexFile.isEmpty() &amp;&amp;!dexFiles.contains(dexFile)) {<pre><code>dexFiles.addAll(dexFile);
LogUtil.d(TAG, &quot;add other dexfile&quot;);
installDexFile(context,optimizedDirectory);
</code></pre>   }<br>}<br>2、installDexFile直接调用MultiDex 的installSecondaryDexes方法。<br>/**<ul>
<li>添加apk包外的dex文件，</li>
<li>@param context<br>*/<br>publicstatic void installDexFile(Context context, File optimizedDirectory){<br>if (checkValidZipFiles(dexFiles)) {<pre><code>try {
    installSecondaryDexes(context.getClassLoader(), optimizedDirectory, dexFiles);
} catch (IllegalAccessExceptione){
   e.printStackTrace();
} catch (NoSuchFieldExceptione) {
   e.printStackTrace();
} catch (InvocationTargetExceptione){
   e.printStackTrace();
} catch (NoSuchMethodExceptione) {
   e.printStackTrace();
} catch (IOExceptione) {
   e.printStackTrace();
}
</code></pre>}<br>}<br>3、将patch.dex放在所有dex最前面。<br>private static voidexpandFieldArray(Object instance, String fieldName, Object[]extraElements) throws NoSuchFieldException, IllegalArgumentException,<br>IllegalAccessException {<pre><code>  Field jlrField = findField(instance, fieldName);
  Object[]original = (Object[]) jlrField.get(instance);
  Object[]combined = (Object[]) Array.newInstance(original.getClass().getComponentType(),original.length + extraElements.length);
  // 将后来的dex放在前面，主dex放在最后。
System.arraycopy(extraElements, 0, combined, 0, extraElements.length);
System.arraycopy(original, 0, combined, extraElements.length,original.length);
 // 原始的dex合并，是将主dex放在前面，其他的dex依次放在后面。
 //System.arraycopy(original, 0, combined, 0, original.length);
 //System.arraycopy(extraElements, 0, combined, original.length,extraElements.length);
jlrField.set(instance, combined);
</code></pre>}<br>到此将patch.dex放进了Element，接下来的问题就是加载Class，当加载patch.dex中类的时候，会遇到一个问题，这个问题就是QQ空间团队遇到,Classd的CLASS_ISPREVERIFIED。具体原因是dvmResolveClass这个方法对Class进行了校验。判断这个要Resolve的class是否和其引用来自一个dex。如果不是，就会遇到问题。</li>
</ul>
</file></li>
</ul>
<p>当引用这和被引用者不在同一个dex中就会抛出异常，导致Resolve失败。QQ空间团队的方案是阻止所有的Class类打上CLASS_ISPREVERIFIED来逃过校验，这种方式其实是影响性能。<br>我们的方案是和QQ团队的类似，但是和QQ空间不同的是，我们将fromUnverifiedConstant设置为true，来逃过校验，达到补丁的路径。具体怎么实现呢？<br>要引用Cydia Hook技术来hook Native dalvik中dvmResolveClass这个方法。有关Cydia Hook技术请参考：<br>官网地址：<a href="http://www.cydiasubstrate.com/" target="_blank" rel="external">http://www.cydiasubstrate.com/</a><br>官方教程：<a href="http://www.cydiasubstrate.com/id/38be592b-bda7-4dd2-b049-cec44ef7a73b" target="_blank" rel="external">http://www.cydiasubstrate.com/id/38be592b-bda7-4dd2-b049-cec44ef7a73b</a><br>SDK下载地址：<a href="http://asdk.cydiasubstrate.com/zips/cydia_substrate-r2.zip" target="_blank" rel="external">http://asdk.cydiasubstrate.com/zips/cydia_substrate-r2.zip</a><br>具体代码如下。<br>//指明要hook的lib ：<br>MSConfig(MSFilterLibrary,”/system/lib/libdvm.so”)</p>
<p>// 在初始化的时候进行hook<br>MSInitialize {<br>    LOGD(“Cydia Init”);<br>    MSImageRef image;<br>    //载入lib<br>    image = MSGetImageByName(“/system/lib/libdvm.so”);<br>    if (image != NULL) {<br>        LOGD(“image is not null”);<br>        void <em>dexload=MSFindSymbol(image,”dvmResolveClass”);<br>        if(dexload != NULL) {<br>            LOGD(“dexloadis not null”);<br>            MSHookFunction(dexload, (void</em>)proxyDvmResolveClass, (void<em>*)&amp;dvmResolveClass_Proxy);<br>        } else{<br>            LOGD(“errorfind dvmResolveClass”);<br>        }<br>    }<br>}<br>// 在初始化的时候进行hook//保留原来的地址<br>ClassObject</em> (<em>dvmResolveClass_Proxy)(ClassObject</em> referrer, u4 classIdx, boolfromUnverifiedConstant);<br>// 新方法地址<br>static ClassObject<em> proxyDvmResolveClass(ClassObject</em> referrer, u4 classIdx,bool fromUnverifiedConstant) {<br>        return dvmResolveClass_Proxy(referrer, classIdx,true);<br>}<br>有人可能会担心cydia Hook性能，稳定性问题，但是据我所知，目前有些公司已经用它来实现apk加壳和脱壳防止反编译技术方案。具体可以参考<a href="http://www.gitzx.com/android-cydiasubstrate/" target="_blank" rel="external">http://www.gitzx.com/android-cydiasubstrate/</a></p>
<p>说到此处，似乎已经是一个完整的方案了，但在实践中，会发现运行加载类的时候报preverified错误，原来在DexPrepare.cpp，将dex转化成odex的过程中，会在DexVerify.cpp进行校验，验证如果直接引用到的类和clazz是否在同一个dex，如果是，则会打上CLASS_ISPREVERIFIED标志。通过在所有类（Application除外，当时还没加载自定义类的代码）的构造函数插入一个对在单独的dex的类的引用，就可以解决这个问题。空间使用了javaassist进行编译时字节码插入。</p>
<p>所以为了实现补丁方案，所以必须从这些方法中入手，防止类被打上CLASS_ISPREVERIFIED标志。 最终空间的方案是往所有类的构造函数里面插入了一段代码，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (ClassVerifier.PREVENT_VERIFY) &#123;</div><div class="line">    System.out.println(AntilazyLoad.class);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中AntilazyLoad类会被打包成单独的antilazy.dex，这样当安装apk的时候，classes.dex内的类都会引用一个在不相同dex中的AntilazyLoad类，这样就防止了类被打上CLASS_ISPREVERIFIED的标志了，只要没被打上这个标志的类都可以进行打补丁操作。 然后在应用启动的时候加载进来.AntilazyLoad类所在的dex包必须被先加载进来,不然AntilazyLoad类会被标记为不存在，即使后续加载了hack.dex包，那么他也是不存在的，这样屏幕就会出现茫茫多的类AntilazyLoad找不到的log。 所以Application作为应用的入口不能插入这段代码。（因为载入hack.dex的代码是在Application中onCreate中执行的，如果在Application的构造函数里面插入了这段代码，那么就是在hack.dex加载之前就使用该类，该类一次找不到，会被永远的打上找不到的标志)</p>
<p>如何打包补丁包：<br>１. 空间在正式版本发布的时候，会生成一份缓存文件，里面记录了所有class文件的md5，还有一份mapping混淆文件。<br>２. 在后续的版本中使用-applymapping选项，应用正式版本的mapping文件，然后计算编译完成后的class文件的md5和正式版本进行比较，把不相同的class文件打包成补丁包。<br>备注:该方案现在也应用到我们的编译过程当中,编译不需要重新打包dex,只需要把修改过的类的class文件打包成patch dex,然后放到sdcard下,那么就会让改变的代码生效。</p>
<p>在 Java 中，只有当两个实例的类名、包名以及加载其的 ClassLoader 都相同，才会被认为是同一种类型。上面分别加载的新类和旧类，虽然包名和类名都完全一样，但是由于加载的 ClassLoader 不同，所以并不是同一种类型，在实际使用中可能会出现类型不符异常。<br>同一个 Class = 相同的 ClassName + PackageName + ClassLoader<br>以上问题在采用动态加载功能的开发中容易出现，请注意。</p>
<p>通过上面的分析，我们知道使用ClassLoader动态加载一个外部的类是非常容易的事情，所以很容易就能实现动态加载新的可执行代码的功能，但是比起一般的Java程序，在Android程序中使用动态加载主要有两个麻烦的问题：</p>
<p>Android中许多组件类（如Activity、Service等）是需要在Manifest文件里面注册后才能工作的（系统会检查该组件有没有注册），所以即使动态加载了一个新的组件类进来，没有注册的话还是无法工作；<br>Res资源是Android开发中经常用到的，而Android是把这些资源用对应的R.id注册好，运行时通过这些ID从Resource实例中获取对应的资源。如果是运行时动态加载进来的新类，那类里面用到R.id的地方将会抛出找不到资源或者用错资源的异常，因为新类的资源ID根本和现有的Resource实例中保存的资源ID对不上；<br>说到底，抛开虚拟机的差别不说，一个Android程序和标准的Java程序最大的区别就在于他们的上下文环境（Context）不同。Android中，这个环境可以给程序提供组件需要用到的功能，也可以提供一些主题、Res等资源，其实上面说到的两个问题都可以统一说是这个环境的问题，而现在的各种Android动态加载框架中，核心要解决的东西也正是“如何给外部的新类提供上下文环境”的问题。</p>
<p>DexClassLoader的使用方法一般有两种：<br>从已安装的apk中读取dex<br>从apk文件中读取dex<br>假如有两个APK，一个是宿主APK，叫作HOST，一个是插件APK，叫作Plugin。Plugin中有一个类叫PluginClass，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginClass</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginClass</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"JG"</span>,<span class="string">"初始化PluginClass"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> a+b;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在如果想调用插件APK中PluginClass内的方法，应该怎么办？</p>
<p>####从已安装的apk中读取dex</p>
<p>先来看第一种方法，这种方法必须建一个Activity，在清单文件中配置Action.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;activity android:name=".MainActivity"&gt;</div><div class="line">         &lt;intent-filter&gt;</div><div class="line">             &lt;action android:name="com.maplejaw.plugin"/&gt;</div><div class="line">         &lt;/intent-filter&gt;</div><div class="line">&lt;/activity&gt;</div></pre></td></tr></table></figure></p>
<p>然后在宿主APK中如下使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * 这种方式用于从已安装的apk中读取，必须要有一个activity，且需要配置ACTION</div><div class="line">   */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useDexClassLoader</span><span class="params">()</span></span>&#123;</div><div class="line">      <span class="comment">//创建一个意图，用来找到指定的apk</span></div><div class="line">      Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.maplejaw.plugin"</span>);</div><div class="line">      <span class="comment">//获得包管理器</span></div><div class="line">      PackageManager pm = getPackageManager();</div><div class="line">      List&lt;ResolveInfo&gt; resolveinfoes =  pm.queryIntentActivities(intent, <span class="number">0</span>);</div><div class="line">      <span class="keyword">if</span>(resolveinfoes.size()==<span class="number">0</span>)&#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//获得指定的activity的信息</span></div><div class="line">      ActivityInfo actInfo = resolveinfoes.get(<span class="number">0</span>).activityInfo;</div><div class="line"></div><div class="line">      <span class="comment">//获得包名</span></div><div class="line">      String packageName = actInfo.packageName;</div><div class="line">      <span class="comment">//获得apk的目录或者jar的目录</span></div><div class="line">      String apkPath = actInfo.applicationInfo.sourceDir;</div><div class="line">      <span class="comment">//dex解压后的目录,注意，这个用宿主程序的目录，android中只允许程序读取写自己</span></div><div class="line">      <span class="comment">//目录下的文件</span></div><div class="line">      String dexOutputDir = getApplicationInfo().dataDir;</div><div class="line"></div><div class="line">      <span class="comment">//native代码的目录</span></div><div class="line">      String libPath = actInfo.applicationInfo.nativeLibraryDir;</div><div class="line"></div><div class="line">      <span class="comment">//创建类加载器，把dex加载到虚拟机中</span></div><div class="line">      DexClassLoader calssLoader = <span class="keyword">new</span> DexClassLoader(apkPath, dexOutputDir, libPath,</div><div class="line">              <span class="keyword">this</span>.getClass().getClassLoader());</div><div class="line"></div><div class="line">      <span class="comment">//利用反射调用插件包内的类的方法</span></div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Class&lt;?&gt; clazz = calssLoader.loadClass(packageName+<span class="string">".PluginClass"</span>);</div><div class="line"></div><div class="line">          Object obj = clazz.newInstance();</div><div class="line">          Class[] param = <span class="keyword">new</span> Class[<span class="number">2</span>];</div><div class="line">          param[<span class="number">0</span>] = Integer.TYPE;</div><div class="line">          param[<span class="number">1</span>] = Integer.TYPE;</div><div class="line"></div><div class="line">          Method method = clazz.getMethod(<span class="string">"function"</span>, param);</div><div class="line"></div><div class="line">          Integer ret = (Integer)method.invoke(obj, <span class="number">12</span>,<span class="number">34</span>);</div><div class="line"></div><div class="line">          Log.d(<span class="string">"JG"</span>, <span class="string">"返回的调用结果为:"</span> + ret);</div><div class="line"></div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">      &#125; </div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>我们安装完两个APK后，在宿主中就可以直接调用，调用示例如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">btnClick</span><span class="params">(View view)</span></span>&#123;</div><div class="line">    useDexClassLoader();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>####从apk文件中读取dex</p>
<p>这种方法由于并不需要安装，所以不需要通过Intent从activity中解析信息。换言之，这种方法不需要创建Activity。无需配置清单文件。我们只需要打包一个apk，然后放到SD卡中即可。<br>核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//apk路径</span></div><div class="line">String path=Environment.getExternalStorageDirectory().getAbsolutePath()+<span class="string">"/1.apk"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useDexClassLoader</span><span class="params">(String path)</span></span>&#123;</div><div class="line">  </div><div class="line">    File codeDir=getDir(<span class="string">"dex"</span>, Context.MODE_PRIVATE);</div><div class="line"></div><div class="line">    <span class="comment">//创建类加载器，把dex加载到虚拟机中</span></div><div class="line">    DexClassLoader calssLoader = <span class="keyword">new</span> DexClassLoader(path, codeDir.getAbsolutePath(), <span class="keyword">null</span>,</div><div class="line">            <span class="keyword">this</span>.getClass().getClassLoader());</div><div class="line"></div><div class="line">    <span class="comment">//利用反射调用插件包内的类的方法</span></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class&lt;?&gt; clazz = calssLoader.loadClass(<span class="string">"com.maplejaw.plugin.PluginClass"</span>);</div><div class="line"></div><div class="line">        Object obj = clazz.newInstance();</div><div class="line">        Class[] param = <span class="keyword">new</span> Class[<span class="number">2</span>];</div><div class="line">        param[<span class="number">0</span>] = Integer.TYPE;</div><div class="line">        param[<span class="number">1</span>] = Integer.TYPE;</div><div class="line"></div><div class="line">        Method method = clazz.getMethod(<span class="string">"function"</span>, param);</div><div class="line"></div><div class="line">        Integer ret = (Integer)method.invoke(obj, <span class="number">12</span>,<span class="number">21</span>);</div><div class="line"></div><div class="line">        Log.d(<span class="string">"JG"</span>, <span class="string">"返回的调用结果为: "</span> + ret);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>动态加载的几个关键问题<br>资源访问：无法找到某某id所对应的资源<br>因为将apk加载到宿主程序中去执行，就无法通过宿主程序的Context去取到apk中的资源,比如图片、文本等，这是很好理解的，因为apk已经不存在上下文了，它执行时所采用的上下文是宿主程序的上下文，用别人的Context是无法得到自己的资源的；<br>解决方案一：插件中的资源在宿主程序中也预置一份；<br>缺点：增加了宿主apk的大小；在这种模式下，每次发布一个插件都需要将资源复制到宿主程序中，这意味着每发布一个插件都要更新一下宿主程序；<br>解决方案二：将插件中的资源解压出来，然后通过文件流去读取资源；<br>缺点：实际操作起来还是有很大难度的。首先不同资源有不同的文件流格式，比如图片、XML等，其次针对不同设备加载的资源可能是不一样的，如何选择合适的资源也是一个需要解决的问题；<br>实际解决方案：<br>Activity中有一个叫mBase的成员变量，它的类型就是ContextImpl。注意到Context中有如下两个抽象方法，看起来是和资源有关的，实际上Context就是通过它们来获取资源的。这两个抽象方法的真正实现在ContextImpl中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Return an AssetManager instance for your application's package. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AssetManager <span class="title">getAssets</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Return a Resources instance for your application's package. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Resources <span class="title">getResources</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>具体实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadResources</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AssetManager assetManager = AssetManager.class.newInstance();</div><div class="line">        Method addAssetPath = assetManager.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class);</div><div class="line">        addAssetPath.invoke(assetManager, mDexPath);</div><div class="line">        mAssetManager = assetManager;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    Resources superRes = <span class="keyword">super</span>.getResources();</div><div class="line">    mResources = <span class="keyword">new</span> Resources(mAssetManager, superRes.getDisplayMetrics(),</div><div class="line">            superRes.getConfiguration());</div><div class="line">    mTheme = mResources.newTheme();</div><div class="line">    mTheme.setTo(<span class="keyword">super</span>.getTheme());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>加载资源的方法是通过反射，通过调用AssetManager中的addAssetPath方法，我们可以将一个apk中的资源加载到Resources对象中，由于addAssetPath是隐藏API我们无法直接调用，所以只能通过反射。<br>addAssetPath();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@hide</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">addAssetPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> res = addAssetPathNative(path);</div><div class="line"></div><div class="line">        makeStringBlocks(mStringBlocks);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> res;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Activity生命周期的管理：<br>反射方式和接口方式。<br>反射的方式很好理解，首先通过Java的反射去获取Activity的各种生命周期方法，比如onCreate、onStart、onResume等，然后在代理Activity中去调用插件Activity对应的生命周期方法即可；<br>缺点：一方面是反射代码写起来比较复杂，另一方面是过多使用反射会有一定的性能开销。</p>
<p>反射方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line"></div><div class="line">    Method onResume = mActivityLifecircleMethods.get(<span class="string">"onResume"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (onResume != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            onResume.invoke(mRemoteActivity, <span class="keyword">new</span> Object[] &#123; &#125;);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            e.printStackTrace();</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    Method onPause = mActivityLifecircleMethods.get(<span class="string">"onPause"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (onPause != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            onPause.invoke(mRemoteActivity, <span class="keyword">new</span> Object[] &#123; &#125;);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            e.printStackTrace();</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onPause();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接口方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DLPlugin</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestart</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent</span></span></div><div class="line"></div><div class="line">    data);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProxy</span><span class="params">(Activity proxyActivity, String dexPath)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNewIntent</span><span class="params">(Intent intent)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowAttributesChanged</span><span class="params">(LayoutParams params)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">…</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代理Activity中只需要按如下方式即可调用插件Activity的生命周期方法，这就完成了插件Activity的生命周期的管理;插件Activity需要实现DLPlugin接口；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    mRemoteActivity.onStart();</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onStart();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestart</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    mRemoteActivity.onRestart();</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onRestart();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    mRemoteActivity.onResume();</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://developer.android.com/topic/instant-apps/index.html" target="_blank" rel="external">Google Instant app</a></li>
<li><a href="https://github.com/WeMobileDev/article/blob/master/%E5%BE%AE%E4%BF%A1Android%E7%83%AD%E8%A1%A5%E4%B8%81%E5%AE%9E%E8%B7%B5%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF.md#rd">微信热补丁实现</a></li>
<li><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">多dex分拆</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a" target="_blank" rel="external">QQ空间热修复方案</a></li>
<li><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">Android dex分包方案</a></li>
<li><a href="http://www.maplejaw.com/2016/05/24/Android%E6%8F%92%E4%BB%B6%E5%8C%96%E6%8E%A2%E7%B4%A2%EF%BC%88%E4%B8%80%EF%BC%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8DexClassLoader/" target="_blank" rel="external">类加载器DexClassLoader</a></li>
<li><a href="http://blog.csdn.net/xwl198937/article/details/49801975" target="_blank" rel="external">基于cydia Hook在线热修复补丁方案</a></li>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/49883661" target="_blank" rel="external"></a></li>
<li><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="external"></a></li>
<li><a href="http://kymjs.com/column/plugin.html" target="_blank" rel="external"></a></li>
<li><a href="http://weishu.me/" target="_blank" rel="external"></a></li>
<li><a href="http://www.zjutkz.net/2016/05/23/%E5%BD%93%E4%BD%A0%E5%87%86%E5%A4%87%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%A1%86%E6%9E%B6%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84%E4%B8%80%E5%88%87/" target="_blank" rel="external"></a>        </li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/热修复实现/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-通过Hardware Layer提高动画性能" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/通过Hardware Layer提高动画性能/">通过Hardware Layer提高动画性能</a>
    </h1>
  

        
        <a href="/2015/01/01/通过Hardware Layer提高动画性能/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="通过Hardware-Layer提高动画性能"><a href="#通过Hardware-Layer提高动画性能" class="headerlink" title="通过Hardware Layer提高动画性能"></a>通过Hardware Layer提高动画性能</h1><p>项目中越来越多的动画，越来越多的效果导致了应用性能越来越低。该如何提升。   </p>
<p>###简介 </p>
<p>在<code>View</code>播放动画的过程中每一帧都需要被重绘。如果使用<code>view layers</code>，就不用每帧都去重绘，因为<code>View</code>渲染一旦离开屏幕缓冲区就可以被重用。</p>
<p>而且，<code>hardware layers</code>会在<code>GPU</code>上缓存，这样就会让一些动画过程中的操作变得更快。通过<code>hardware layers</code>可以快速的渲染一些简单的转变(位移、选中、缩放、颜色渐变)。由于很多动画都是这些动作的结合，所以<code>hardware layers</code>可以显著的提高动画性能。</p>
<p>在<code>View</code>当中提供了三种类型的<code>Layer type</code>:    </p>
<ul>
<li><p>LAYER_TYPE_HARDWARE</p>
<blockquote>
<p>Indicates that the view has a hardware layer. A hardware layer is backed by a hardware specific texture (generally Frame Buffer Objects or FBO on OpenGL hardware) and causes the view to be rendered using Android’s hardware rendering pipeline, but only if hardware acceleration is turned on for the view hierarchy. When hardware acceleration is turned off, hardware layers behave exactly as software layers.</p>
<p>A hardware layer is useful to apply a specific color filter and/or blending mode and/or translucency to a view and all its children.</p>
<p>A hardware layer can be used to cache a complex view tree into a texture and reduce the complexity of drawing operations. For instance, when animating a complex view tree with a translation, a hardware layer can be used to render the view tree only once.</p>
<p>A hardware layer can also be used to increase the rendering quality when rotation transformations are applied on a view. It can also be used to prevent potential clipping issues when applying 3D transforms on a view.    </p>
</blockquote>
</li>
</ul>
<ul>
<li><p>LAYER_TYPE_SOFTWARE</p>
<blockquote>
<p>Indicates that the view has a software layer. A software layer is backed by a bitmap and causes the view to be rendered using Android’s software rendering pipeline, even if hardware acceleration is enabled.</p>
<p>Software layers have various usages:</p>
<p>When the application is not using hardware acceleration, a software layer is useful to apply a specific color filter and/or blending mode and/or translucency to a view and all its children.</p>
<p>When the application is using hardware acceleration, a software layer is useful to render drawing primitives not supported by the hardware accelerated pipeline. It can also be used to cache a complex view tree into a texture and reduce the complexity of drawing operations. For instance, when animating a complex view tree with a translation, a software layer can be used to render the view tree only once.</p>
<p>Software layers should be avoided when the affected view tree updates often. Every update will require to re-render the software layer, which can potentially be slow (particularly when hardware acceleration is turned on since the layer will have to be uploaded into a hardware texture after every update.)</p>
</blockquote>
</li>
<li><p>LAYER_TYPE_NONE</p>
<blockquote>
<p>Indicates that the view does not have a layer.<br>  默认值。</p>
</blockquote>
</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>首先使用的前提是在清单文件中开启了硬件加速。否则将无法使用<code>hardware layer</code>。这一点在上面的文档中也有说明。</p>
<p><code>API</code>也是非常简单的，直接使用<code>View.setLayerType()</code>就好。使用时应该只是暂时的设置<code>Hardware Layer</code>，因为它们无法自动释放。<br>基本的使用步骤：    </p>
<ul>
<li>对每个想要在动画过程中进行缓存的<code>view</code>调用<code>View.setLayerType(View.LAYER_TYPE_HARDWARE, null)</code>方法。</li>
<li>执行动画。</li>
<li>在动画执行结束后调用<code>View.setLayerType(View.LAYER_TYPE_NONE, null)</code>方法来进行清除。</li>
</ul>
<p>示例:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mView.setLayerType(View.LAYER_TYPE_HARDWARE, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">animator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;  </div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">    mView.setLayerType(View.LAYER_TYPE_NONE, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">animator.start();</div></pre></td></tr></table></figure></p>
<p>但是如果在<code>4.0.x</code>的版本中使用上面的代码会本亏，必须要把<code>setLayerType</code>放到<code>Runnable</code>中。如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mView.setLayerType(View.LAYER_TYPE_HARDWARE, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">animator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;  </div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">    <span class="comment">//This will work successfully</span></div><div class="line">    post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</div><div class="line">            setLayerType(LAYER_TYPE_NONE, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">animator.start();</div></pre></td></tr></table></figure></p>
<p>如果你基于<code>minSdkVersion 16</code>以上并且使用<code>ViewPropertyAnimator</code>时，你可以使用<code>withLayer()</code>方法替代如上的操作:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mView.animate().translationX(<span class="number">150</span>).withLayer().start();</div></pre></td></tr></table></figure>
<p>或者在<code>api 14</code>以上时使用<code>ViewCompat.animate().withLayer()</code><br>这样做，你的动画就会变得更流畅！</p>
<p>###注意事项  </p>
<p>你应该知道，事情没那么简单。<br><code>Hardware layers</code>有着惊人的提升动画性能的能力。然而，如果滥用，它的危害更大。<strong>不要盲目的使用<code>layers</code></strong></p>
<ul>
<li><p>首先，在有些情况下，<code>hardware layers</code>除了<code>view</code>渲染外还会执行更多的工作。缓存<code>layer</code>将会需要时间，因为首选第一步就需要两个过程: 先将这些<code>view</code>渲染到<code>GPU</code>的一个<code>layer</code>中然后<code>GPU</code>再渲染该<code>layer</code>到<code>Window</code>上。如果要渲染的<code>View</code>非常简单(例如一个纯色值),那么这样在初始化的时候就会增加<code>Hardware Layer</code>不必要的开销。</p>
</li>
<li><p>其次，对所有的缓存来讲，都有一个缓存失效的可能性。任何时候如果在动画过程中调用<code>view.invalidate()</code>，那么<code>layer</code>就必须要重新渲染。经常的废弃<code>hardware layers</code>会比没有<code>layers</code>的情况下更糟糕，因为如同上面讲到的<code>hardware layers</code>在设置缓存时会有额外的开销。如果你需要经常的重新缓存<code>layer</code>，那就会有极大的损害。    </p>
<p>  这个问题也是非常容易出现的，因为动画经常有多个移动的部分。假如现在有一个三个部分移动的动画:     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Parent ViewGroup</div><div class="line">—-&gt; <span class="function">Child <span class="title">View1</span> <span class="params">(往左移动)</span></span></div><div class="line">—-&gt; Child <span class="title">View2</span> <span class="params">(往右移动)</span></div><div class="line">—-&gt; Child <span class="title">View3</span> <span class="params">(往上移动)</span></div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>如果你只在父布局`ViewGroup`上设置一个`layer`，那就将经常的缓存失效，因为`ViewGroup`会随着子`View`不断地改变。然而对每个单独的子`Views`而言，他们只是在位移。这种情况下，最好是对每个子`View上`设置`Hardware Layer`（而不是在父布局上）。

***再次重申，通常是对多个子`View上`适当的设置`Hardware Layer`，这样他们就不会在动画运行时失效。***

在手机开发者选项中的*显示硬件层更新（Show hardware layers updates）*功能是追踪这个问题的开发利器。当`View`渲染`Hardware Layer`的时候闪烁绿色，它应该在动画开始的时候闪烁一次（也就是`Layer`渲染初始化的时候），然而，如果你的`View`在整个动画期间都是绿色，那就是遇到失效的问题了。
</code></pre><ul>
<li>最后，<code>hardware layers</code>使用<code>GPU</code>内存，你当然不想出现内存泄漏的问题。所以你应该在必要的时候再去使用<code>hardware layers</code>，就想播放动画时。  </li>
</ul>
<p>这里也没有硬性规则。<code>Android</code>渲染系统是非常复杂的。就像所有性能问题一样，测试才是关键。通过使用“显示硬件层更新”开发者选项来确定<code>layers</code>是在帮你还是害你。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/通过Hardware Layer提高动画性能/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-注解使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/注解使用/">注解使用</a>
    </h1>
  

        
        <a href="/2015/01/01/注解使用/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="注解使用"><a href="#注解使用" class="headerlink" title="注解使用"></a>注解使用</h1><p>###简介</p>
<blockquote>
<p>Annotations, a form of metadata, provide data about a program that is not part of the program itself. Annotations have no direct effect on the operation of the code they annotate.</p>
</blockquote>
<p>更通俗的意思是为程序的元素（类、方法、成员变量）加上更直观更明了的说明，这些说明信息是与程序的业务逻辑无关，并且是供指定的工具或框架使用的。<br><code>Annontation</code>像一种修饰符一样，应用于包、类型、构造方法、方法、成员变量、参数及本地变量的声明语句中。</p>
<p><code>Annotation</code>其实是一种接口。通过反射来访问<code>annotation</code>信息。相关类（框架或工具中的类）根据这些信息来决定如何使用该程序元素或改变它们的行为。<br><code>Annotation</code>是不会影响程序代码的执行，无论<code>annotation</code>怎么变化，代码都始终如一地执行。<br><code>Java</code>语言解释器在工作时会忽略这些<code>annotation</code>，因此在<code>JVM</code>中这些<code>annotation</code>是“不起作用”的，只能通过配套的工具才能对这些<code>annontaion</code>类型的信息进行访问和处理。</p>
<p>###说明</p>
<ul>
<li><code>Annotation</code>的声明是通过关键字<code>@interface</code>。这个关键字会去继承<code>Annotation</code>接口。</li>
<li><p><code>Annotation</code>的方法定义是独特的、受限制的。<br> <code>Annotation</code>类型的方法必须声明为无参数、无异常的。这些方法定义了<code>Annotation</code>的成员: 方法名代表成员变量名，而方法返回值代表了成员变量的类型。而且方法的返回值类型必须是基本数据类型、<code>Class</code>类型、<code>String类型</code>、枚举类型、<code>Annotation</code>类型或者由前面类型之一作为元素的一维数组。方法的后面可以使用<code>default</code>和一个默认的数值来声明成员变量的默认值，<code>null</code>不能作为成员变量的默认值，这与我们平时的使用有很大的区别。<br>  注解如果只有一个默认属性，可直接用<code>value()</code>函数。一个属性也没有则表示该<code>Annotation</code>为<code>Mark Annotation</code>。<br>  例如:</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public @interface UnitTest &#123;</div><div class="line">     String value();</div><div class="line">&#125;</div><div class="line">```    </div><div class="line">在使用时可以直接使用`@UnitTest("GCD")`，`@UnitTest("GCD"`实际上就是是 `@UnitTest(value="GCD)`的简单写法。  </div><div class="line">例如:</div><div class="line">   </div><div class="line">```java</div><div class="line">@Target(ElementType.METHOD)</div><div class="line">@Retention(RetentionPolicy.RUNTIME)</div><div class="line">public @interface UseCase &#123;</div><div class="line">    public int id();</div><div class="line">    public String description() default "no description";</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###作用</p>
<p><code>Annotation</code>一般作为一种辅助途径，应用在软件框架或者工具中。让这些工具类可以根据不同的<code>Annotation</code>注解信息来采取不同的处理过程或者改变相应程的行为。具有“让编译器进行编译检查的作用”。   </p>
<p>具体可分为如下三类:    </p>
<ul>
<li>标记，用于告诉编译器一些信息</li>
<li>编译时动态处理，如动态生成代码</li>
<li>运行时动态处理，如得到注解信息</li>
</ul>
<p>###Annotation分类    </p>
<p>#####标准的<code>Annotaion</code>    </p>
<p>从<code>jdk 1.5</code>开始，自带了三种标准的<code>annotation</code>类型：   </p>
<ul>
<li><p><code>Override</code><br>  它是一种<code>marker</code>类型的<code>Annotation</code>，用来标注方法，说明被它标注的方法是重载了父类中的方法。如果我们使用了该注解到一个没有覆盖父类方法的方法时，编译器就会提示一个编译错误的警告。   </p>
</li>
<li><p><code>Deprecated</code><br>  它也是一种<code>marker</code>类型的<code>Annotation</code>。当方法或者变量使用该注解时，编译器就会提示该方法已经废弃。</p>
</li>
<li><p><code>SuppressWarnings</code><br>  它不是<code>marker</code>类型的<code>Annotation</code>。用户告诉编译器不要再对该类、方法或者成员变量进行警告提示。   </p>
</li>
</ul>
<p>#####元<code>Annotation</code></p>
<p>元<code>Annotation</code>是指用来定义<code>Annotation</code>的<code>Annotation</code>。  </p>
<ul>
<li><p><code>@Retention</code><br>  保留时间，可为<code>RetentionPolicy.SOURCE(源码时)</code>、<code>RetentionPolicy.CLASS(编译时)</code>、<code>RetentionPolicy.RUNTIME(运行时)</code>，默认为<code>CLASS</code>。如果值为<code>RetentionPolicy.SOURCE</code>那大多都是<code>Mark Annotation</code>，例如:<code>Override</code>、<code>Deprecated</code>、<code>Suppress Warnings</code>。<code>SOURCE</code>表示仅存在于源码中，在<code>class</code>文件中不会包含。<code>CLASS</code>表示会在<code>class</code>文件中存在，但是运行时无法获取。<code>RUNTIME</code>表示会在<code>class</code>文件中存在，并且在运行时可以通过反射获取。    </p>
</li>
<li><p><code>@Target</code><br>  用来标记可进行修饰哪些元素，例如<code>ElementType.TYPE</code>、<code>ElementType.METHOD</code>、<code>ElementType.CONSTRUCTOR</code>、<code>ElementType.FIELD</code>、<code>ElementType.PARAMETER</code>等，如果未指定则默认为可修饰所有。</p>
</li>
<li><p><code>@Inherited</code><br>  子类是否可以继承父类中的该注解。它所标注的<code>Annotation</code>将具有继承性。<br>  例如:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">java.lang.annotation.Inherited</div><div class="line"></div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAnnotation &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MyAnnotation</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySuperClass</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySubClass</span> <span class="keyword">extends</span> <span class="title">MySuperClass</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>

在这个例子中`MySubClass`类继承了`@MyAnnotation`注解，因为`MySubClass`继承了`MySuperClass`类，而`MySuperClass`类使用了`@MyAnnotation`注解。   
</code></pre><ul>
<li><code>@Documented</code><br>  是否会保存到<code>javadoc</code>文档中。  </li>
</ul>
<p>###自定义<code>Annotation</code> </p>
<p>假设现在有个开发团队在每个类的开始都要提供一些信息，例如:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation3List</span> <span class="keyword">extends</span> <span class="title">Generation2List</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">// Author: John Doe</span></div><div class="line">   <span class="comment">// Date: 3/17/2002</span></div><div class="line">   <span class="comment">// Current revision: 6</span></div><div class="line">   <span class="comment">// Last modified: 4/12/2004</span></div><div class="line">   <span class="comment">// By: Jane Doe</span></div><div class="line">   <span class="comment">// Reviewers: Alice, Bill, Cindy</span></div><div class="line"></div><div class="line">   <span class="comment">// class code goes here</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以声明一个注解来保存这些相同的元数据。如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> ClassPreamble &#123;</div><div class="line">   <span class="function">String <span class="title">author</span><span class="params">()</span></span>;</div><div class="line">   <span class="function">String <span class="title">date</span><span class="params">()</span></span>;</div><div class="line">   <span class="function"><span class="keyword">int</span> <span class="title">currentRevision</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</div><div class="line">   <span class="function">String <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">default</span> "N/A"</span>;</div><div class="line">   <span class="function">String <span class="title">lastModifiedBy</span><span class="params">()</span> <span class="keyword">default</span> "N/A"</span>;</div><div class="line">   <span class="comment">// Note use of array</span></div><div class="line">   String[] reviewers();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>声明完注解之后我们就可以填写一些参数来使用它，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ClassPreamble</span> (</div><div class="line">   author = <span class="string">"John Doe"</span>,</div><div class="line">   date = <span class="string">"3/17/2002"</span>,</div><div class="line">   currentRevision = <span class="number">6</span>,</div><div class="line">   lastModified = <span class="string">"4/12/2004"</span>,</div><div class="line">   lastModifiedBy = <span class="string">"Jane Doe"</span>,</div><div class="line">   <span class="comment">// Note array notation</span></div><div class="line">   reviewers = &#123;<span class="string">"Alice"</span>, <span class="string">"Bob"</span>, <span class="string">"Cindy"</span>&#125;</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Generation3List</span> <span class="keyword">extends</span> <span class="title">Generation2List</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">// class code goes here</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###<code>Annotation</code>解析    </p>
<p>当<code>Java</code>源代码被编译时，编译器的一个插件<code>annotation</code>处理器则会处理这些<code>annotation</code>。<br>处理器可以产生报告信息，或者创建附加的<code>Java</code>源文件或资源。<br>如果<code>annotation</code>本身被加上了<code>RententionPolicy</code>的运行时类，<br>则<code>Java</code>编译器则会将<code>annotation</code>的元数据存储到<code>class</code>文件中。然后<code>Java</code>虚拟机或其他的程序可以查找这些元数据并做相应的处理。</p>
<p>当然除了<code>annotation</code>处理器可以处理<code>annotation</code>外，我们也可以使用反射自己来处理<code>annotation</code>。<code>Java SE 5</code>有一个名为<code>AnnotatedElement</code>的接口，<br><code>Java</code>的反射对象类<code>Class</code>,<code>Constructor</code>,<code>Field</code>,<code>Method</code>以及<code>Package</code>都实现了这个接口。<br>这个接口用来表示当前运行在<code>Java</code>虚拟机中的被加上了<code>annotation</code>的程序元素。<br>通过这个接口可以使用反射读取<code>annotation</code>。<code>AnnotatedElement</code>接口可以访问被加上<code>RUNTIME</code>标记的<code>annotation</code>，<br>相应的方法有<code>getAnnotation</code>,<code>getAnnotations</code>,<code>isAnnotationPresent</code>。<br>由于<code>Annotation</code>类型被编译和存储在二进制文件中就像<code>class</code>一样，<br>所以可以像查询普通的<code>Java</code>对象一样查询这些方法返回的<code>Annotation</code>。</p>
<p>#####运行时<code>Annotation</code>解析</p>
<p>该类是指<code>@Retention</code>为<code>RUNTIME</code>的<code>Annotation</code>。<br>该类型的解析其实本质的使用反射。反射执行的效率是很低的<br>如果不是必要，应当尽量减少反射的使用，因为它会大大拖累你应用的执行效率。</p>
<ul>
<li><p>类注解</p>
<p>  可以通过<code>Class</code>、<code>Method</code>、<code>Field</code>类来在运行时获取注解。下面是通过<code>Class</code>类获取注解的示例:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Class aClass = TheClass.class;</div><div class="line">Annotation[] annotations = aClass.getAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  也可以获取一个指定的注解类型:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Class aClass = TheClass.class;</div><div class="line">Annotation annotation = aClass.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <code>JDK</code>提供的主要方法有:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">getAnnotation</span><span class="params">(Class&lt;A&gt; annotationType)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Annotation[] getAnnotations() &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAnnotationPresent</span><span class="params">(Class&lt;? extends Annotation&gt; annotationType)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>方法注解</p>
<p>  下面是一个方法使用注解的例子:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line">  <span class="meta">@MyAnnotation</span>(name=<span class="string">"someName"</span>,  value = <span class="string">"Hello World"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>你可以通过如下方式获取方法注解:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">//obtain method object</span></div><div class="line">Annotation[] annotations = method.getDeclaredAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

也可以获取一个指定的方法注解，如下:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">// obtain method object</span></div><div class="line">Annotation annotation = method.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>参数注解</p>
<p>  在方法的参数中声明注解，如下:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doSomethingElse</span><span class="params">(</span></span></div><div class="line">        @MyAnnotation(name=<span class="string">"aName"</span>, value=<span class="string">"aValue"</span>) String parameter)&#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>可以通过`Method`对象获取到参数的注解，如下:          
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Method method = ... <span class="comment">//obtain method object</span></div><div class="line">Annotation[][] parameterAnnotations = method.getParameterAnnotations();</div><div class="line">Class[] parameterTypes = method.getParameterTypes();</div><div class="line"></div><div class="line"><span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(Annotation[] annotations : parameterAnnotations)&#123;</div><div class="line">  Class parameterType = parameterTypes[i++];</div><div class="line"></div><div class="line">  <span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"param: "</span> + parameterType.getName());</div><div class="line">        System.out.println(<span class="string">"name : "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

注意，`Method.getParameterAnnotations()`方法会返回一个二维的`Annotation`数组，包含每个方法参数的一个注解数组。    
</code></pre><ul>
<li><p>变量注解</p>
<p>  下面是一个变量使用注解的例子:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TheClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@MyAnnotation</span>(name=<span class="string">"someName"</span>,  value = <span class="string">"Hello World"</span>)</div><div class="line">  <span class="keyword">public</span> String myField = <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line"></div><div class="line">你可以像下面这样获取变量的注解:    </div><div class="line">```java</div><div class="line">Field field = ... <span class="comment">//obtain field object</span></div><div class="line">Annotation[] annotations = field.getDeclaredAnnotations();</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">    <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">        MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">        System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">        System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>当然也可以获取一个指定的变量注解，如下:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Field field = ... <span class="comment">// obtain method object</span></div><div class="line">Annotation annotation = field.getAnnotation(MyAnnotation.class);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> MyAnnotation)&#123;</div><div class="line">    MyAnnotation myAnnotation = (MyAnnotation) annotation;</div><div class="line">    System.out.println(<span class="string">"name: "</span> + myAnnotation.name());</div><div class="line">    System.out.println(<span class="string">"value: "</span> + myAnnotation.value());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>记下来我们来举个栗子,运行时注解示例:   </p>
<p>相信很多人都知道<code>Butter Knife</code>。它里面就是使用了注解:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindView</span>(R.id.user) EditText username;</div><div class="line"><span class="meta">@BindView</span>(R.id.pass) EditText password;</div><div class="line"></div><div class="line"><span class="meta">@BindString</span>(R.string.login_error) String loginErrorMessage;</div><div class="line"></div><div class="line"><span class="meta">@OnClick</span>(R.id.submit) <span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO call server...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那我们就以<code>onClick</code>事件为例模仿着他去写一下。   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectorProcessor</span> </span>&#123;    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">final</span> Object object)</span> </span>&#123;        </div><div class="line">        Class class_=object.getClass();        </div><div class="line">        Method[] methods=class_.getDeclaredMethods();        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Method method : methods) &#123;            </div><div class="line">            onClick clickMethod=method.getAnnotation(onClick.class);            </div><div class="line">            <span class="keyword">if</span> (clickMethod!=<span class="keyword">null</span>) &#123;                </div><div class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Activity) &#123;                   </div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> id : clickMethod.value()) &#123;                        </div><div class="line">                        View view=((Activity) object).findViewById(id);                        </div><div class="line">                        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;                            </div><div class="line">                            <span class="meta">@Override</span>                            </div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;                                </div><div class="line">                                <span class="keyword">try</span> &#123;                                    </div><div class="line">                                    method.invoke(object);                                </div><div class="line">                                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;                                    </div><div class="line">                                    e.printStackTrace();                                </div><div class="line">                                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;                                    </div><div class="line">                                    e.printStackTrace();                                </div><div class="line">                                &#125;                            </div><div class="line">                            &#125;                        </div><div class="line">                        &#125;);                    </div><div class="line">                    &#125;                </div><div class="line">                &#125;            </div><div class="line">             &#125;        </div><div class="line">         &#125;    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;    </div><div class="line">    <span class="meta">@Override</span>    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;        </div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);        </div><div class="line">        setContentView(R.layout.activity_main);        </div><div class="line">        InjectorProcessor processor=<span class="keyword">new</span> InjectorProcessor();        </div><div class="line">        processor.process(MainActivity.<span class="keyword">this</span>);    </div><div class="line">    &#125;    </div><div class="line"></div><div class="line">    <span class="meta">@onClick</span>(&#123;R.id.textview&#125;)    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click</span><span class="params">()</span> </span>&#123;        </div><div class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"HHH"</span>, Toast.LENGTH_SHORT).show();    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很显然大神<code>JakeWharton</code>不会这样做的，毕竟反射会影响性能。<br>我们来看一下<code>ButterKnife</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(METHOD)</div><div class="line"><span class="meta">@Retention</span>(CLASS)</div><div class="line"><span class="meta">@ListenerClass</span>(</div><div class="line">    targetType = <span class="string">"android.view.View"</span>,</div><div class="line">    setter = <span class="string">"setOnClickListener"</span>,</div><div class="line">    type = <span class="string">"butterknife.internal.DebouncingOnClickListener"</span>,</div><div class="line">    method = <span class="meta">@ListenerMethod</span>(</div><div class="line">        name = <span class="string">"doClick"</span>,</div><div class="line">        parameters = <span class="string">"android.view.View"</span></div><div class="line">    )</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</div><div class="line">  <span class="comment">/** View IDs to which the method will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到了吗？是编译型的注解。这样不会影响性能。</p>
<p>一张图总结一下:   </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/java_annotation.jpg?raw=true" alt="image"></p>
<p>#####编译时<code>Annotation</code>解析    </p>
<p>在刚才介绍的运行时注解中，很多人肯定会说使用反射会影响性能，那有没有不影响性能的方式呢？当然有了，那就是编译时注解。在编译时会通过注解标示来动态生成一些类或者<code>xml</code>，而在运行时，这里注解是没有的，它会依靠动态生成的类来进行操作。所以它就和直接调用方法一样，当然不会有效率影响了。       </p>
<p>该类型注解值是<code>@Retention</code>为<code>CLASS</code>的<code>Annotation</code>，由<code>APT(Annotaion Processing Tool)</code>自动进行解析。是在编译时注入，所以不会像反射一样影响效率问题。   </p>
<p>根据<code>sun</code>官方的解释，<code>APT（annotation processing tool）</code>是一个命令行工具，<br>它对源代码文件进行检测找出其中的<code>annotation</code>后，使用<code>annotation processors</code>来处理<code>annotation</code>。<br>而<code>annotation processors</code>使用了一套反射<code>API</code>并具备对<code>JSR175</code>规范的支持。</p>
<p><code>annotation processors</code>处理<code>annotation</code>的基本过程如下：</p>
<ul>
<li><code>APT</code>运行<code>annotation processors</code>根据提供的源文件中的<code>annotation</code>生成源代码文件和其它的文件（文件具体内容由<code>annotation processors</code>的编写者决定）</li>
<li>接着<code>APT</code>将生成的源代码文件和提供的源文件进行编译生成类文件。</li>
</ul>
<p><code>APT</code>在编译时自动查找所有继承自<code>AbstractProcessor</code>的类，然后调用他们的<code>process</code>方法去处理，这样就拥有了在编译过程中执行代码的能力</p>
<p>所以我们需要做的是:    </p>
<ul>
<li>自定义类继承<code>AbstractProcessor</code></li>
<li>重写<code>process</code>方法</li>
</ul>
<p>那我们就开始写:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span></span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是在<code>Android Studio</code>死活提示找不到<code>AbstractProcessor</code>类，这是因为注解是<code>javase</code>中<code>javax</code>包里面的，<code>android.jar</code>默认是不包含的，所以会编译报错.<br>解决方法就是新建一个<code>Module</code>，在选择类型时将该<code>Module</code>的类型选为<code>Java Library</code>。<br>然后在该<code>Module</code>中创建就好了<code>Processor</code>就好了，完美解决。 </p>
<p>好，那我们就开始写个编译时处理的<code>demo</code> :  </p>
<ul>
<li><code>Android Studio</code>中创建一个<code>Android</code>工程。</li>
<li>新建一个<code>Module</code>，然后选择<code>Java Library</code>类型(我的名字为<code>annotations</code>)，并且让<code>app</code>依赖该<code>module</code>。</li>
<li><p>在<code>annotations</code>的<code>module</code>中创建注解类:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnnotationTest &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>annotations</code>的<code>module</code>自定义<code>Processor</code>类</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedAnnotationTypes;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedSourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</div><div class="line"></div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(<span class="string">"com.charon.AnnotationTest"</span>)</div><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.RELEASE_7)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"process"</span>);</div><div class="line">        <span class="keyword">for</span> (TypeElement te : annotations) &#123;</div><div class="line">            <span class="keyword">for</span> (Element element : roundEnv.getElementsAnnotatedWith(te)) &#123;</div><div class="line">                AnnotationTest annotation = element.getAnnotation(AnnotationTest.class);</div><div class="line">                String value = annotation.value();</div><div class="line">                System.out.println(<span class="string">"type : "</span> + value);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <strong><em>注意:</em></strong><code>@SupportedAnnotationTypes(&quot;com.charon.AnnotationTest&quot;)</code>来指定要处理的注解类。<br>  <code>@SupportedSourceVersion(SourceVersion.RELEASE_7)</code>指定编译的版本。这种通过注解指定编译版本和类型的方式是从<code>Java 1.7</code>才有的。<br>  对于之前的版本都是通过重写<code>AbstractProcessor</code>中的方法来指定的。   </p>
</li>
<li><p>注册处理器<br>  我们自定义了<code>Processor</code>那如何才能让其生效呢?就是在<code>annotations</code>的<code>java</code>同级目录新建<code>resources/META-INF/services/javax.annotation.processing.Processor</code>文件</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- java</div><div class="line">- META-INF</div><div class="line">    - services</div><div class="line">        - javax.annotation.processing.Processor</div></pre></td></tr></table></figure>
<p>  然后在<code>javax.annotation.processing.Processor</code>文件中指定自定义的处理器，如:      </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.charon.TestProcessor</div></pre></td></tr></table></figure>
<p>  如果多个话就分行写。 </p>
<p>  然后我们<code>Build</code>一下(命令行执行<code>./gradlew build</code>)，就能看到控制台打印出来如下的信息: </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">:app:compileReleaseJavaWithJavac</div><div class="line">:app:compileReleaseJavaWithJavac - <span class="function">is not <span class="title">incremental</span> <span class="params">(e.g. outputs have changed, no previous execution, etc.)</span>.</span></div><div class="line">process</div><div class="line">value : haha</div><div class="line">process</div></pre></td></tr></table></figure>
<p>  <strong><em>注意:</em></strong>千万不要去<code>logcat</code>中找信息，这是编译时注解。<br>  <strong><em>注意:</em></strong>一定要使用<code>jdk1.7</code>，<code>1.8</code>对注解的支持有<code>bug</code>。</p>
</li>
</ul>
<p>上面只是一个简单的例子，如果你想用编译时注解去做一些更高级的事情，例如自动生成一些代码，那你可能就会用到如下几个类库:   </p>
<ul>
<li><a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="external">android-apt</a></li>
<li><a href="https://github.com/google/auto">Google Auto</a>      </li>
<li><a href="https://github.com/square/javapoet">Square javapoet</a></li>
</ul>
<p>这三个库分别的作用为:    </p>
<ul>
<li><p><code>android-apt</code><br>  <code>Android Studio</code>原本是不支持注解处理器的, 但是用<code>android-apt</code>这个插件后, 我们就可以使用注解处理器了,<br>  这个插件可以自动的帮你为生成的代码创建目录, 让生成的代码编译到<code>APK</code>里面去, 而且它还可以让最终编译出来的<code>APK</code>里面不包含注解处理器本身的代码,<br>  因为这部分代码只是编译的时候需要用来生成代码, 最终运行的时候是不需要的。<br>  也就是说它主要有两个目的:    </p>
<ul>
<li>允许配置只在编译时作为注解处理器的依赖，而不添加到最后的APK或library</li>
<li><p>设置源路径，使注解处理器生成的代码能被Android Studio正确的引用</p>
<p>那在什么情况下我们会需要使用它呢？<br>当你需要引入<code>Processor</code>生成的源代码到你的代码中时。例如当你使用<code>Dagger 2</code>或<code>AndroidAnnotaition</code>.<br>该插件使得<code>Android Studio</code>可以配置生成资源的<code>build path</code>,避免<code>IDE</code>报错。<br>当使用<code>apt</code>添加添加依赖，它将不会被包含到最终的<code>APK</code>里。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><code>Auto</code>     </p>
<p>  <code>Google Auto</code>的主要作用是注解<code>Processor</code>类，并对其生成<code>META-INF</code>的配置信息，<br>  可以让你不用去写<code>META-INF</code>这些配置文件，只要在自定义的<code>Processor</code>上面加上<code>@AutoService(Processor.class)</code></p>
</li>
<li><p><code>javapoet</code><br>  <code>javapoet</code>:<code>A Java API for generating .java source files.</code>可以更方便的生成代码，它可以帮助我们通过类调用的形式来生成代码。   </p>
</li>
</ul>
<p>###自定义编译时注解</p>
<p>在自定义注解时，一般来说可能会建三个<code>modules</code>:  </p>
<ul>
<li><code>app module</code>:写一些使用注解的<code>android</code>应用逻辑。</li>
<li><code>api module</code>:定义一些可以在<code>app</code>中使用的注解。它会被<code>app</code>以及<code>compiler</code>使用。</li>
<li><code>compiler module</code>:定义<code>Processor</code>该<code>module</code>不会被包含到应用中，它只会在构建过程中被使用。在编译的过程中它会生成一些<code>java</code>文件，而这些<code>java</code>文件会被打包进<code>apk</code>中。<br>  我们可以在该<code>module</code>中使用<code>auto</code>以及<code>javapoet</code>。  </li>
</ul>
<p>下面开始配置<code>android-apt</code>：   </p>
<ul>
<li><p>配置到<code>app module</code>下的<code>build.gradle</code>中</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.application'</span></div><div class="line"><span class="comment">// apt</span></div><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">23</span></div><div class="line">    buildToolsVersion <span class="string">"23.0.3"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"com.charon.annotationdemo"</span></div><div class="line">        minSdkVersion <span class="number">14</span></div><div class="line">        targetSdkVersion <span class="number">23</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_7</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_7</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        <span class="comment">// 配置apt</span></div><div class="line">        classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">    testCompile 'junit:junit:4.12'</div><div class="line">    compile 'com.android.support:appcompat-v7:23.4.0'</div><div class="line">    compile <span class="title">project</span><span class="params">(<span class="string">':api'</span>)</span></div><div class="line">    apt <span class="title">project</span><span class="params">(<span class="string">':compiler'</span>)</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接下来在<code>compiler module</code>中配置<code>auto</code>以及<code>javapoet</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line">sourceCompatibility = JavaVersion.VERSION_1_7</div><div class="line">targetCompatibility = JavaVersion.VERSION_1_7</div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">project</span> <span class="params">(<span class="string">':api'</span>)</span></span></div><div class="line">    compile 'com.google.auto.service:auto-service:1.0-rc2'</div><div class="line">    compile 'com.squareup:javapoet:1.7.0'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在<code>api module</code>中也加上如下的配置:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'java'</span></div><div class="line">sourceCompatibility = JavaVersion.VERSION_1_7</div><div class="line">targetCompatibility = JavaVersion.VERSION_1_7</div></pre></td></tr></table></figure>
</li>
<li><p>接下来在<code>api module</code>中定义一个注解       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.Target;</div><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnnotationTest &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>compiler module</code>中自定义一个<code>Processor</code>       </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.charon;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.ProcessingEnvironment;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.Processor;</div><div class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</div><div class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</div><div class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</div><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes the processor with the processing environment by</div><div class="line">     * setting the &#123;<span class="doctag">@code</span> processingEnv&#125; field to the value of the</div><div class="line">     * &#123;<span class="doctag">@code</span> processingEnv&#125; argument.  An &#123;<span class="doctag">@code</span></div><div class="line">     * IllegalStateException&#125; will be thrown if this method is called</div><div class="line">     * more than once on the same object.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> processingEnv environment to access facilities the tool framework</div><div class="line">     * provides to the processor</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException if this method is called more than once.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Processes a set of annotation types on type elements originating from the prior round </div><div class="line">     * and returns whether or not these annotations are claimed by this processor. </div><div class="line">     * If true is returned, the annotations are claimed and subsequent processors will </div><div class="line">     * not be asked to process them; </div><div class="line">     * if false is returned, the annotations are unclaimed and subsequent processors may be </div><div class="line">     * asked to process them. A processor may always return the same boolean value </div><div class="line">     * or may vary the result based on chosen criteria.</div><div class="line">     * The input set will be empty if the processor supports "*" and the root elements </div><div class="line">     * have no annotations. A Processor must gracefully handle an empty set of annotations.</div><div class="line">     * <span class="doctag">@param</span> annotations</div><div class="line">     * <span class="doctag">@param</span> roundEnv</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"hello processor"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getSupportedAnnotationTypes();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>这里简单的说一下这几个主要的方法:   

- `init()`:初始化操作的方法，`RoundEnvironment`会提供很多有用的工具类`Elements`、`Types`和`Filer`等。
- `process()`:这相当于每个处理器的主函数`main()`。在该方法中去扫描、评估、处理以及生成`Java`文件。 
- `getSupportedAnnotationTypes()`:这里你必须指定，该注解器是注册给哪个注解的。
- `getSupportedSourceVersion()`:用来指定你使用的`java`版本。通常这里会直接放回`SourceVersion.latestSupported()`即可。  

从`idk 1.7`开始，可以使用如下注解来代替`getSupporedAnnotationTypes()`和`getSupportedSourceVersion()`方法:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.latestSupported())</div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;</div><div class="line">   <span class="comment">// 合法注解全名的集合</span></div><div class="line"> &#125;)</div></pre></td></tr></table></figure>
</code></pre><p>注解相关<code>API</code>:     </p>
<ul>
<li><code>Set&lt;? extends Element&gt; getElementsAnnotatedWith(Class&lt;? extends Annotation&gt; a)</code><br>  返回使用给定注释类型注释的元素。该注释可能直接出现或者被继承。只返回注释处理的此<code>round</code>中包括的<code>package</code>元素和<code>type</code>元素、成员声明、参数或者这些元素中声明的类型参数。</li>
<li><p><code>Element</code><br>  表示一个程序元素，比如包、类或者方法。每个元素都表示一个静态的语言级构造（不表示虚拟机的运行时构造）。<br>  元素应该使用<code>equals(Object)</code>方法进行比较。不保证总是使用相同的对象表示某个特定的元素。<br>  要实现基于<code>Element</code>对象类的操作，可以使用<code>visitor</code>或者使用<code>getKind()</code>方法的结果。使用<code>instanceof</code>确定此建模层次结构中某一对象的有效类未必可靠，因为一个实现可以选择让单个对象实现多个<code>Element</code>子接口。</p>
</li>
<li><p><code>TypeElement</code><br>  表示一个类或接口程序元素。提供对有关类型及其成员的信息的访问。注意，枚举类型是一种类，而注释类型是一种接口。<br>  而<code>DeclaredType</code>表示一个类或接口类型，后者将成为前者的一种使用（或调用）。这种区别对于一般的类型是最明显的，对于这些类型，单个元素可以定义一系列完整的类型。<br>  例如，元素<code>java.util.Set</code>对应于参数化类型<code>java.util.Set&lt;String&gt;</code>和<code>java.util.Set&lt;Number&gt;</code>（以及其他许多类型），还对应于原始类型<code>java.util.Set</code>。</p>
</li>
</ul>
<p>扯远了，那我们就以上面的目录结构和实现方式，通过一个具体的例子要详细说明，例子真的很难找，我在网上找到了一个大神写的，虽然从这个例子中并不能看出注解的强大之处，但是对于讲解来说还是非常有用的: </p>
<p>我们要解决的问题是我们想要实现一个披萨店，该店会提供两种披萨(<code>Margherita</code>和<code>Calzone</code>)和一种甜点(<code>Tiramisu</code>)。</p>
<p>首先我们在<code>app module</code>中创建对应的接口和代码 ，如下:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Meal</span> </span>&#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6.0f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果消费者想要下单，那么它需要输入对应的物品名字:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mealName == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Name of the meal is null!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown meal '"</span> + mealName + <span class="string">"'"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这样的话在<code>order()</code>方法中，会有很多<code>if</code>语句，并且每当我们添加一种新的披萨，我们都要添加一条新的<code>if</code>语句。但是我们可以使用注解和工厂模式，我们就可以让注解来自动生成这些在工厂中的<code>if</code>语句。我们期待的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> factory.create(mealName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>MealFactory</code>的实现应该如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MealFactory</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">create</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"id is null!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown id = "</span> + id);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们要做的就是通过注解来生成<code>MealFactory</code>中的代码。<br>想法是这样的：我们将使用同样的<code>type()</code>注解那些属于同一个工厂的类，并且用注解的<code>id()</code>做一个映射，例如从”Calzone”映射到”ClzonePizza”类。我们使用<code>@Factory</code>注解到我们的类中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Margherita"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Calzone"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Tiramisu"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可能会问你自己，我们是否可以只把<code>@Factory</code>注解应用到<code>Meal</code>接口上？答案是注解是不能继承的。一个类<code>class X</code>被注解，并不意味着它的子类<code>class Y extends X</code>会自动被注解。在我们开始写处理器的代码之前，我们先规定如下一些规则：</p>
<ul>
<li>只有类可以被<code>@Factory</code>注解，因为接口或者抽象类并不能用<code>new</code>操作实例化；</li>
<li>被<code>@Factory</code>注解的类，必须至少提供一个公开的默认构造器（即没有参数的构造函数）。否者我们没法实例化一个对象。</li>
<li>被<code>@Factory</code>注解的类必须直接或者间接的继承于<code>type()</code>指定的类型；</li>
<li>具有相同的<code>type</code>的注解类，将被聚合在一起生成一个工厂类。这个生成的类使用<code>Factory</code>后缀，例如<code>type = Meal.class</code>，将生成<code>MealFactory</code>工厂类；</li>
<li><code>id</code>只能是<code>String</code>类型，并且在同一个<code>type</code>组中必须唯一。</li>
</ul>
<p>那我们接着看一下在<code>compiler module</code>中的自定义的<code>FactoryProcessor</code>类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Types typeUtils;</div><div class="line">  <span class="keyword">private</span> Elements elementUtils;</div><div class="line">  <span class="keyword">private</span> Filer filer;</div><div class="line">  <span class="keyword">private</span> Messager messager;</div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses = <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    typeUtils = processingEnv.getTypeUtils();</div><div class="line">    elementUtils = processingEnv.getElementUtils();</div><div class="line">    filer = processingEnv.getFiler();</div><div class="line">    messager = processingEnv.getMessager();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">    <span class="comment">// 指定支持@Factory注解</span></div><div class="line">    annotataions.add(Factory.class.getCanonicalName());</div><div class="line">    <span class="keyword">return</span> annotataions;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>init()</code>方法中，我们初始化了几个变量:   </p>
<ul>
<li><code>Elements</code>: 处理<code>Element</code>的工具类  </li>
<li><code>Types</code>: 处理<code>TypeMirror</code>的工具类</li>
<li><code>Filer</code>: 用来创建你要创建的文件</li>
<li><code>Messager</code>:提供给注解处理器一个报告错误、警告以及提示信息的途径。</li>
</ul>
<p>在注解的处理过程中会扫描所有的<code>java</code>源文件。源代码中的每一个部分都是一个特定类型的<code>Element</code>。换句话说:<code>Element</code>代表程序的元素，例如包、类或者方法等。每个<code>Element</code>代表一个构建，例如通过下面的例子我们来说明一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example;    <span class="comment">// PackageElement</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;        <span class="comment">// TypeElement</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> a;      <span class="comment">// VariableElement</span></div><div class="line">    <span class="keyword">private</span> Foo other;  <span class="comment">// VariableElement</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span> <span class="params">()</span> </span>&#123;&#125;    <span class="comment">// ExecuteableElement</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span> <span class="params">(  // ExecuteableElement</span></span></div><div class="line">                     <span class="keyword">int</span> newA   // TypeElement</div><div class="line">                     ) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以在注解中我们必须要换一个角度来看待源代码，它只是一个结构化的文本，我们可以像<code>XML</code>中的<code>DOM</code>一样去解析它。<br>例如现在有一个代表<code>public class Foo</code>类的<code>TypeElement</code>元素，你可以遍历它的子元素，如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TypeElement fooClass = ... ;  </div><div class="line"><span class="keyword">for</span> (Element e : fooClass.getEnclosedElements())&#123; <span class="comment">// iterate over children  </span></div><div class="line">    Element parent = e.getEnclosingElement();  <span class="comment">// parent == fooClass</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你所见，<code>Element</code>代表的是源代码。<code>TypeElement</code>代表的是源代码中的类型元素，例如类。然而<code>TypeElement</code>并不包含类本身的信息。你可以从<code>TypeElement</code>中获取类的名字，但是你获取不到类的信息，例如它的父类。这种信息需要通过<code>TypeMirror</code>获取。你可以通过调用<code>elements.asType()</code>获取元素的<code>TypeMirror</code>。</p>
<p>接下来我们来继续实现<code>process()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Types typeUtils;</div><div class="line">    <span class="keyword">private</span> Elements elementUtils;</div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">        typeUtils = processingEnv.getTypeUtils();</div><div class="line">        elementUtils = processingEnv.getElementUtils();</div><div class="line">        filer = processingEnv.getFiler();</div><div class="line">        messager = processingEnv.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">        annotataions.add(Factory.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> annotataions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// roundEnv.getElementsAnnotatedWith(Factory.class))返回所有被注解了@Factory的元素的列表。</span></div><div class="line">        <span class="comment">// 你可能已经注意到，我们并没有说“所有被注解了@Factory的类的列表”，因为它真的是返回Element的列表。</span></div><div class="line">        <span class="comment">// 请记住：Element可以是类、方法、变量等。所以，接下来，我们必须检查这些Element是否是一个类</span></div><div class="line">        <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">            <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">            <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在继续检查被注解<code>@Fractory</code>的类是否满足我们上面说的5条规则之前，我们将介绍一个让我们更方便继续处理的数据结构。有时候，一个问题或者解释器看起来如此简单，以至于程序员倾向于用一个面向过程方式来写整个处理器。但是你知道吗？一个注解处理器仍然是一个<code>Java</code>程序，所以我们需要使用面向对象编程、接口、设计模式，以及任何你将在其他普通<code>Java</code>程序中使用的技巧。</p>
<p>我们的<code>FactoryProcessor</code>非常简单，但是我们仍然想要把一些信息存为对象。在<code>FactoryAnnotatedClass</code>中，我们保存被注解类的数据，比如合法的类的名字，以及<code>@Factory</code>注解本身的一些信息。也就是说每一个使用了<code>@Factory</code>注解的类都对应一个<code>FactoryAnnotatedClass</code>类，所以，我们保存<code>TypeElement</code>和处理过的<code>@Factory</code>注解：</p>
<p>如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryAnnotatedClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> TypeElement annotatedClassElement;</div><div class="line">  <span class="keyword">private</span> String qualifiedSuperClassName;</div><div class="line">  <span class="keyword">private</span> String simpleTypeName;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryAnnotatedClass</span><span class="params">(TypeElement classElement)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</div><div class="line">    <span class="keyword">this</span>.annotatedClassElement = classElement;</div><div class="line">    Factory annotation = classElement.getAnnotation(Factory.class);</div><div class="line">    id = annotation.id();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(id)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">          String.format(<span class="string">"id() in @%s for class %s is null or empty! that's not allowed"</span>,</div><div class="line">              Factory.class.getSimpleName(), classElement.getQualifiedName().toString()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Get the full QualifiedTypeName</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; clazz = annotation.type();</div><div class="line">      <span class="comment">// 返回底层阶级Java语言规范中定义的标准名称。</span></div><div class="line">      qualifiedSuperClassName = clazz.getCanonicalName();</div><div class="line">      simpleTypeName = clazz.getSimpleName();</div><div class="line">    &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">      DeclaredType classTypeMirror = (DeclaredType) mte.getTypeMirror();</div><div class="line">      TypeElement classTypeElement = (TypeElement) classTypeMirror.asElement();</div><div class="line">      qualifiedSuperClassName = classTypeElement.getQualifiedName().toString();</div><div class="line">      simpleTypeName = classTypeElement.getSimpleName().toString();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#id()&#125;中指定的id</div><div class="line">   * return the id</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#type()&#125;指定的类型合法全名</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> qualified name</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getQualifiedFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> qualifiedSuperClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取在&#123;<span class="doctag">@link</span> Factory#type()&#125;&#123;<span class="doctag">@link</span> Factory#type()&#125;指定的类型的简单名字</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> qualified name</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getSimpleFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> simpleTypeName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 获取被<span class="doctag">@Factory</span>注解的原始元素</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> TypeElement <span class="title">getTypeElement</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> annotatedClassElement;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面我们用到了<code>Class</code>,因为这里的类型是一个<code>java.lang.Class</code>。这就意味着，他是一个真正的<code>Class</code>对象。因为注解处理是在编译<code>Java</code>源代码之前。我们需要考虑如下两种情况：</p>
<ul>
<li>这个类已经被编译：这种情况是：如果第三方<code>.jar</code>包含已编译的被<code>@Factory</code>注解<code>.class</code>文件。在这种情况下，可以通过上面的方式在<code>try</code>代码块中直接获取。</li>
<li>这个还没有被编译：这种情况是我们尝试编译被<code>@Fractory</code>注解的源代码。这种情况下，直接获取<code>Class</code>会抛出<code>MirroredTypeException</code>异常。幸运的是，<code>MirroredTypeException</code>包含一个<code>TypeMirror</code>，它表示我们未编译类。因为我们已经知道它必定是一个类类型（我们已经在前面检查过），我们可以直接强制转换为<code>DeclaredType</code>，然后读取<code>TypeElement</code>来获取合法的名字。</li>
</ul>
<p>好了，我们现在还需要一个数据结构类<code>FactoryGroupedClasses</code>，它将简单的组合所有的<code>FactoryAnnotatedClasses</code>到一起。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">      <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> IdAlreadyUsedException </span>&#123;</div><div class="line"></div><div class="line">    FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IdAlreadyUsedException(existing);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如你所见，这是一个基本的<code>Map&lt;String, FactoryAnnotatedClass&gt;</code>，这个映射表用来映射<code>@Factory.id()</code>到<code>FactoryAnnotatedClass</code>。我们选择<code>Map</code>这个数据类型，是因为我们要确保每个<code>id</code>是唯一的，我们可以很容易通过<code>map</code>查找实现。<code>generateCode()</code>方法将被用来生成工厂类代码（将在后面讨论）。</p>
<p>我们继续实现<code>process()</code>方法。接下来我们想要检查被注解的类必须有只要一个公开的构造函数，不是抽象类，继承于特定的类型，以及是一个公开类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Types typeUtils;</div><div class="line">    <span class="keyword">private</span> Elements elementUtils;</div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line">    <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnv);</div><div class="line">        typeUtils = processingEnv.getTypeUtils();</div><div class="line">        elementUtils = processingEnv.getElementUtils();</div><div class="line">        filer = processingEnv.getFiler();</div><div class="line">        messager = processingEnv.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">        annotataions.add(Factory.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> annotataions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// roundEnv.getElementsAnnotatedWith(Factory.class))返回所有被注解了@Factory的元素的列表。</span></div><div class="line">        <span class="comment">// 你可能已经注意到，我们并没有说“所有被注解了@Factory的类的列表”，因为它真的是返回Element的列表。</span></div><div class="line">        <span class="comment">// 请记住：Element可以是类、方法、变量等。所以，接下来，我们必须检查这些Element是否是一个类</span></div><div class="line">        <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">            <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">            <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">                error(annotatedElement, <span class="string">"Only classes can be annotated with @%s"</span>,</div><div class="line">                        Factory.class.getSimpleName());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 退出处理</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="comment">// 因为我们已经知道它是ElementKind.CLASS类型，所以可以直接强制转换</span></div><div class="line">            TypeElement typeElement = (TypeElement) annotatedElement;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                FactoryAnnotatedClass annotatedClass =</div><div class="line">                        <span class="keyword">new</span> FactoryAnnotatedClass(typeElement); <span class="comment">// throws IllegalArgumentException</span></div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!isValidClass(annotatedClass)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 已经打印了错误信息，退出处理过程</span></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 一旦我们检查isValidClass()成功，我们将添加FactoryAnnotatedClass到对应的FactoryGroupedClasses中</span></div><div class="line">                FactoryGroupedClasses factoryClass =</div><div class="line">                        factoryClasses.get(annotatedClass.getQualifiedFactoryGroupName());</div><div class="line">                <span class="keyword">if</span> (factoryClass == <span class="keyword">null</span>) &#123;</div><div class="line">                    String qualifiedGroupName = annotatedClass.getQualifiedFactoryGroupName();</div><div class="line">                    factoryClass = <span class="keyword">new</span> FactoryGroupedClasses(qualifiedGroupName);</div><div class="line">                    factoryClasses.put(qualifiedGroupName, factoryClass);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 如果和其他的@Factory标注的类的id相同冲突，</span></div><div class="line">                <span class="comment">// 抛出IdAlreadyUsedException异常</span></div><div class="line">                factoryClass.add(annotatedClass);</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">                <span class="comment">// @Factory.id()为空 --&gt; 打印错误信息</span></div><div class="line">                error(typeElement, e.getMessage());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (IdAlreadyUsedException e) &#123;</div><div class="line">                FactoryAnnotatedClass existing = e.getExisting();</div><div class="line">                <span class="comment">// 已经存在</span></div><div class="line">                error(annotatedElement,</div><div class="line">                        <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">                        typeElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                        existing.getTypeElement().getQualifiedName().toString());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 为每个工厂生成Java文件</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">                factoryClass.generateCode(elementUtils, filer);</div><div class="line">            &#125;</div><div class="line">        <span class="comment">// TODO ...注意这里会遗留一个问题，我们后面再仔细说。 </span></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Element e, String msg, Object... args)</span> </span>&#123;</div><div class="line">        messager.printMessage(</div><div class="line">                Diagnostic.Kind.ERROR,</div><div class="line">                String.format(msg, args),</div><div class="line">                e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidClass</span><span class="params">(FactoryAnnotatedClass item)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 转换为TypeElement, 含有更多特定的方法</span></div><div class="line">        TypeElement classElement = item.getTypeElement();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!classElement.getModifiers().contains(Modifier.PUBLIC)) &#123;</div><div class="line">            error(classElement, <span class="string">"The class %s is not public."</span>,</div><div class="line">                    classElement.getQualifiedName().toString());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查是否是一个抽象类</span></div><div class="line">        <span class="keyword">if</span> (classElement.getModifiers().contains(Modifier.ABSTRACT)) &#123;</div><div class="line">            error(classElement, <span class="string">"The class %s is abstract. You can't annotate abstract classes with @%"</span>,</div><div class="line">                    classElement.getQualifiedName().toString(), Factory.class.getSimpleName());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查继承关系: 必须是@Factory.type()指定的类型子类</span></div><div class="line">        TypeElement superClassElement =</div><div class="line">                elementUtils.getTypeElement(item.getQualifiedFactoryGroupName());</div><div class="line">        <span class="keyword">if</span> (superClassElement.getKind() == ElementKind.INTERFACE) &#123;</div><div class="line">            <span class="comment">// 检查接口是否实现了</span></div><div class="line">            <span class="keyword">if</span>(!classElement.getInterfaces().contains(superClassElement.asType())) &#123;</div><div class="line">                error(classElement, <span class="string">"The class %s annotated with @%s must implement the interface %s"</span>,</div><div class="line">                        classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                        item.getQualifiedFactoryGroupName());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 检查子类</span></div><div class="line">            TypeElement currentClass = classElement;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                TypeMirror superClassType = currentClass.getSuperclass();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (superClassType.getKind() == TypeKind.NONE) &#123;</div><div class="line">                    <span class="comment">// 到达了基本类型(java.lang.Object), 所以退出</span></div><div class="line">                    error(classElement, <span class="string">"The class %s annotated with @%s must inherit from %s"</span>,</div><div class="line">                            classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                            item.getQualifiedFactoryGroupName());</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (superClassType.toString().equals(item.getQualifiedFactoryGroupName())) &#123;</div><div class="line">                    <span class="comment">// 找到了要求的父类</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 在继承树上继续向上搜寻</span></div><div class="line">                currentClass = (TypeElement) typeUtils.asElement(superClassType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 检查是否提供了默认公开构造函数</span></div><div class="line">        <span class="keyword">for</span> (Element enclosed : classElement.getEnclosedElements()) &#123;</div><div class="line">            <span class="keyword">if</span> (enclosed.getKind() == ElementKind.CONSTRUCTOR) &#123;</div><div class="line">                ExecutableElement constructorElement = (ExecutableElement) enclosed;</div><div class="line">                <span class="keyword">if</span> (constructorElement.getParameters().size() == <span class="number">0</span> &amp;&amp; constructorElement.getModifiers()</div><div class="line">                        .contains(Modifier.PUBLIC)) &#123;</div><div class="line">                    <span class="comment">// 找到了默认构造函数</span></div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 没有找到默认构造函数</span></div><div class="line">        error(classElement, <span class="string">"The class %s must provide an public empty default constructor"</span>,</div><div class="line">                classElement.getQualifiedName().toString());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们这里添加了<code>isValidClass()</code>方法，来检查是否我们所有的规则都被满足了：</p>
<ul>
<li>必须是公开类：<code>classElement.getModifiers().contains(Modifier.PUBLIC)</code></li>
<li>必须是非抽象类：<code>classElement.getModifiers().contains(Modifier.ABSTRACT)</code></li>
<li>必须是<code>@Factoy.type()</code>指定的类型的子类或者接口的实现：首先我们使用<code>elementUtils.getTypeElement(item.getQualifiedFactoryGroupName())</code>创建一个传入的<code>Class(@Factoy.type())</code>的元素。是的，你可以仅仅通过已知的合法类名来直接创建<code>TypeElement</code>（使用<code>TypeMirror</code>）。接下来我们检查它是一个接口还是一个类：<code>superClassElement.getKind() == ElementKind.INTERFACE</code>。所以我们这里有两种情况：如果是接口，就判断<code>classElement.getInterfaces().contains(superClassElement.asType())</code>；如果是类，我们就必须使用<code>currentClass.getSuperclass()</code>扫描继承层级。注意，整个检查也可以使用<code>typeUtils.isSubtype()</code>来实现。</li>
<li>类必须有一个公开的默认构造函数：我们遍历所有的闭元素<code>classElement.getEnclosedElements()</code>，然后检查<code>ElementKind.CONSTRUCTOR</code>、<code>Modifier.PUBLIC</code>以及<code>constructorElement.getParameters().size() == 0</code>。</li>
</ul>
<p>上面都实现完成后下面就是在<code>FactoryGroupedClasses.generateCode()</code>方法中去生成<code>java</code>文件了。<br>写<code>Java</code>文件，和写其他普通文件没有什么两样。使用<code>Filer</code>提供的<code>Writer</code>对象，我们可以连接字符串来写我们生成的<code>Java</code>代码。但是这样是不是非常麻烦啊？还好良心企业<code>Square</code>给我们提供了<code>Javapoet</code>，我们可以用它来非常简单的去生成<code>java</code>文件。那我们接下来就使用<code>javapoet</code>来去生成代码:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 将被添加到生成的工厂类的名字中</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">"Factory"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">            <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> ProcessingException </span>&#123;</div><div class="line"></div><div class="line">        FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">        <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Alredy existing</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ProcessingException(toInsert.getTypeElement(),</div><div class="line">                    <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">                    toInsert.getTypeElement().getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">                    toInsert.getId(), existing.getTypeElement().getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        TypeElement superClassName = elementUtils.getTypeElement(qualifiedClassName);</div><div class="line">        String factoryClassName = superClassName.getSimpleName() + SUFFIX;</div><div class="line">        String qualifiedFactoryClassName = qualifiedClassName + SUFFIX;</div><div class="line">        PackageElement pkg = elementUtils.getPackageOf(superClassName);</div><div class="line">        String packageName = pkg.isUnnamed() ? <span class="keyword">null</span> : pkg.getQualifiedName().toString();</div><div class="line"></div><div class="line">        MethodSpec.Builder method = MethodSpec.methodBuilder(<span class="string">"create"</span>)</div><div class="line">                .addModifiers(Modifier.PUBLIC)</div><div class="line">                .addParameter(String.class, <span class="string">"id"</span>)</div><div class="line">                .returns(TypeName.get(superClassName.asType()));</div><div class="line"></div><div class="line">        <span class="comment">// check if id is null</span></div><div class="line">        method.beginControlFlow(<span class="string">"if (id == null)"</span>)</div><div class="line">                .addStatement(<span class="string">"throw new IllegalArgumentException($S)"</span>, <span class="string">"id is null!"</span>)</div><div class="line">                .endControlFlow();</div><div class="line"></div><div class="line">        <span class="comment">// Generate items map</span></div><div class="line">        <span class="keyword">for</span> (FactoryAnnotatedClass item : itemsMap.values()) &#123;</div><div class="line">            method.beginControlFlow(<span class="string">"if ($S.equals(id))"</span>, item.getId())</div><div class="line">                    .addStatement(<span class="string">"return new $L()"</span>, item.getTypeElement().getQualifiedName().toString())</div><div class="line">                    .endControlFlow();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        method.addStatement(<span class="string">"throw new IllegalArgumentException($S + id)"</span>, <span class="string">"Unknown id = "</span>);</div><div class="line"></div><div class="line">        TypeSpec typeSpec = TypeSpec.classBuilder(factoryClassName).addMethod(method.build()).build();</div><div class="line"></div><div class="line">        <span class="comment">// Write file</span></div><div class="line">        JavaFile.builder(packageName, typeSpec).build().writeTo(filer);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里，我感觉完成了，运行一下，结果发现报错了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:compiler:jar UP-TO-DATE</div><div class="line">:app:compileDebugJavaWithJavac</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line"><span class="number">2</span> 个错误</div><div class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':app:compileDebugJavaWithJavac'</span>.</div><div class="line">&gt; Compilation failed; see the compiler error output <span class="keyword">for</span> details.</div></pre></td></tr></table></figure></p>
<p>那我们继续来解决这个问题，这个问题是由于循环引起的，我们还要处理一个重要的事情就是循环的问题:    </p>
<p>注解处理可能会执行多次，官方文档中是这样介绍的:   </p>
<blockquote>
<p>Annotation processing happens in a sequence of rounds. On each round, a processor may be asked to process a subset of the annotations found on the source and class files produced by a prior round. The inputs to the first round of processing are the initial inputs to a run of the tool; these initial inputs can be regarded as the output of a virtual zeroth round of processing.</p>
</blockquote>
<p>一个简单的定义：一个处理循环是调用一个注解处理器的<code>process()</code>方法。对应到我们的工厂模式的例子中：<code>FactoryProcessor</code>被初始化一次（不是每次循环都会新建处理器对象），然而，如果生成了新的源文件<code>process()</code>能够被调用多次。听起来有点奇怪不是么？原因是这样的，这些生成的文件中也可能包含<code>@Factory</code>注解，它们还将会被<code>FactoryProcessor</code>处理。</p>
<p>例如我们的<code>PizzaStore</code>的例子中将会经过3次循环处理：</p>
<table>
<thead>
<tr>
<th>Round</th>
<th style="text-align:center">Input</th>
<th style="text-align:right">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:center">CalzonePizza.java Tiramisu.java MargheritaPizza.java Meal.java   PizzaStore.java</td>
<td style="text-align:right">MealFactory.java</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:center">MealFactory.java</td>
<td style="text-align:right">none</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:center">none</td>
<td style="text-align:right">none</td>
</tr>
</tbody>
</table>
<p>会循环三次，但是第一次就会生成代码，所以上面会出现两次重复创建文件的错误。   </p>
<p>解释处理循环还有另外一个原因。如果你看一下我们的<code>FactoryProcessor</code>代码你就能注意到，我们收集数据和保存它们在一个私有的域中<code>Map&lt;String, FactoryGroupedClasses&gt; factoryClasses</code>。在第一轮中，我们检测到了<code>MagheritaPizza</code>, <code>CalzonePizza</code>和<code>Tiramisu</code>，然后生成了<code>MealFactory.java</code>。在第二轮中把<code>MealFactory</code>作为输入。因为在<code>MealFactory</code>中没有检测到<code>@Factory</code>注解，我们预期并没有错误，然而我们得到如下的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">:compiler:jar UP-TO-DATE</div><div class="line">:app:compileDebugJavaWithJavac</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line">错误: Attempt to recreate a file <span class="keyword">for</span> type com.charon.annotationdemo.inter.MealFactory</div><div class="line"><span class="number">2</span> 个错误</div><div class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':app:compileDebugJavaWithJavac'</span>.</div><div class="line">&gt; Compilation failed; see the compiler error output <span class="keyword">for</span> details.</div></pre></td></tr></table></figure>
<p>这个问题是因为我们没有清除<code>factoryClasses</code>，这意味着，在第二轮的<code>process()</code>中，任然保存着第一轮的数据，并且会尝试生成在第一轮中已经生成的文件，从而导致这个错误的出现。在我们的这个场景中，我们知道只有在第一轮中检查<code>@Factory</code>注解的类，所以我们可以简单的修复这个问题，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;  </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">        factoryClass.generateCode(elementUtils, filer);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 清除factoryClasses</span></div><div class="line">      factoryClasses.clear();</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong><em>我们要记住注解处理过程是需要经过多轮处理的，并且你不能重载或者重新创建已经生成的源代码。</em></strong></p>
<p>好了，到这里就彻底完成了，运行一下，当然成功了，那生成的文件在哪里呢？ </p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/annotation_ato_create_file.png" alt="image">     </p>
<p>那既然能生成，我们该怎么去调用呢？很简单，像平常一样去用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> View view;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        view = findViewById(R.id.tv);</div><div class="line">        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line">                factory.create(<span class="string">"Calzone"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可能会发现报错，找不到类，你可以不用管它，直接运行，你会发现一切都<code>OK</code>的。当然如果你倒错了包你就当我没说。</p>
<p>作为<code>Android</code>开发者，当然应该很熟悉<code>ButterKnife</code>。在<code>ButterKnife</code>中使用<code>@InjectView</code>注解<code>View</code>。<code>ButterKnifeProcessor</code>生成一个<code>MyActivity$$ViewInjector</code>，但是在<code>ButterKnife</code>你不需要手动调用<code>new MyActivity$$ViewInjector()</code>来实例化一个<code>ButterKnife</code>注入的对象，而是使用<code>Butterknife.inject(activity)</code>。<code>ButterKnife</code>内部使用反射机制来实例化<code>MyActivity$$ViewInjector()</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    Class&lt;?&gt; injector = Class.forName(clsName + <span class="string">"$$ViewInjector"</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123; ... &#125;</div></pre></td></tr></table></figure>
<p>但是反射机制会稍微有些慢，我们使用注解处理来生成本地代码，会不会导致很多的反射性能的问题？的确，反射机制的性能确实是一个问题。然而，它不需要手动去创建对象，确实提高了开发者的开发速度。<code>ButterKnife</code>中有一个哈希表<code>HashMap</code>来缓存实例化过的对象。所以<code>MyActivity$$ViewInjector</code>只是使用反射机制实例化一次，第二次需要<code>MyActivity$$ViewInjector</code>的时候，就直接从哈希表中获得。</p>
<p><code>FragmentArgs</code>非常类似于<code>ButterKnife</code>。它使用反射机制来创建对象，而不需要开发者手动来做这些。<code>FragmentArgs</code>在处理注解的时候生成一个特别的查找表类，它其实就是一种哈希表，所以整个<code>FragmentArgs</code>库只是在第一次使用的时候，执行一次反射调用，一旦整个<code>Class.forName()</code>的<code>Fragemnt</code>的参数对象被创建，后面的都是本地代码运行了。</p>
<p>好了至此例子讲完了。   </p>
<p>最后讲一下按照上面的三层分类:<code>app</code>,<code>api</code>,<code>compiler</code>进行分类的好处。<br>我们这么做是因为想让我们的工厂模式的例子的使用者在他们的工程中只编译注解，而包含处理器模块只是为了编译。有点晕？我们举个例子，如果我们只有一个包。如果另一个开发者想要把我们的工厂模式处理器用于他的项目中，他就必须包含<code>@Factory</code>注解和整个<code>FactoryProcessor</code>的代码（包括<code>FactoryAnnotatedClass</code>和<code>FactoryGroupedClasses</code>）到他们项目中。我非常确定的是，他并不需要在他已经编译好的项目中包含处理器相关的代码。如果你是一个<code>Android</code>的开发者，你肯定听说过<code>65536</code>个方法的限制（即在一个<code>.dex</code>文件中，只能寻址65536个方法）。如果你在<code>FactoryProcessor</code>中使用<code>guava</code>，并且把注解和处理器打包在一个包中，这样的话，<code>Android APK</code>安装包中不只是包含<code>FactoryProcessor</code>的代码，而也包含了整个<code>guava</code>的代码。<code>Guava</code>有大约20000个方法。所以分开注解和处理器是非常有意义的。</p>
<p>###使用注解提高代码的检查性    </p>
<p><code>Google</code>提供了<code>Support-Annotations library</code>来支持更多的注解功能。<br>可以直接在<code>build.gradle</code>中添加如下代码:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &apos;com.android.support:support-annotations:23.3.0&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Android</code>提供了很多注解来支持在方法、参数和返回值上面使用，例如:    </p>
<ul>
<li><code>@Nullable</code><br>  可以为<code>null</code></li>
<li><p><code>@NonNull</code><br>  不能为<code>null</code>  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment">/** Add support for inflating the &lt;fragment&gt; tag. */</span></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, @NonNull Context context,</span></span></div><div class="line">      @NonNull AttributeSet attrs) &#123;</div><div class="line">      ...</div><div class="line">      &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p><code>@StringRes</code><br>  <code>R.string</code>类型的资源。  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.annotation.StringRes;</div><div class="line">...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(@StringRes <span class="keyword">int</span> resId)</span></span>;</div><div class="line">    ...</div><div class="line"></div><div class="line">遇到那种你写了个`setTitle(<span class="keyword">int</span> resId)`他确给你传`setTitle(R.drawable.xxx)`的选手，用这种方式能很好的去提示下。</div></pre></td></tr></table></figure>
</li>
<li><p><code>@DrawableRes</code><br>  <code>Drawable</code>类型的资源。</p>
</li>
<li><code>@ColorRes</code><br>  <code>Color</code>类型的资源。</li>
<li><code>@InterpolatorRes</code><br>  <code>Interpolatro</code>类型。</li>
<li><code>@AnyRes</code><br>  <code>R.</code>类型。</li>
<li><code>@UiThread</code><br>  从<code>UI thread</code>调用。 </li>
<li><p><code>@RequiresPermission</code><br>  来验证该方法的调用者所需要有的权限。检查一个列表中的任何一个权限可以使用<code>anyOf</code>属性。想要检查多个权限时，可以使用<code>allOf</code>属性。如下:  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequiresPermission</span>(Manifest.permission.SET_WALLPAPER)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setWallpaper</span><span class="params">(Bitmap bitmap)</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure>
<p>  检查多个权限:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequiresPermission</span>(allOf = &#123;</div><div class="line">    Manifest.permission.READ_EXTERNAL_STORAGE,</div><div class="line">    Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String dest, String source)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>示例<code>Demo</code>已上传到<code>Github</code>:<a href="https://github.com/CharonChui/AnnotationDemo">AnnotationDemo</a>    </p>
<p>文中例子来自<code>Hannes Dorfmann</code>大神的<code>ANNOTATION PROCESSING 101</code>，我对其重新梳理了下，来让能正常使用，并且上面的示例已经过我实际运行:   </p>
<ul>
<li><a href="http://hannesdorfmann.com/annotation-processing/annotationprocessing101" target="_blank" rel="external">Hannes Dorfmann</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/注解使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Retrofit详解(下)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/02/Retrofit详解(下)/">Retrofit详解(下)</a>
    </h1>
  

        
        <a href="/2014/11/02/Retrofit详解(下)/" class="archive-article-date">
  	<time datetime="2014-11-01T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2014-11-02</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Retrofit详解-下"><a href="#Retrofit详解-下" class="headerlink" title="Retrofit详解(下)"></a>Retrofit详解(下)</h1><p>上一篇文件介绍了<code>Retrofit</code>的基本使用，接下来我们通过从源码的角度分析一下<code>Retrofit</code>的实现。    </p>
<p>首先看一下它的基本使用方法:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1</span></div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">        .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">        .addConverterFactory(GsonConverterFactory.create())</div><div class="line">        .build();</div><div class="line"><span class="comment">// 2</span></div><div class="line">GitHubService gitHubService = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line"><span class="comment">// 3</span></div><div class="line">Call&lt;List&lt;Repo&gt;&gt; call = gitHubService.listRepos(<span class="string">"CharonChui"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 4</span></div><div class="line">call.enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Repo&gt;&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Response&lt;List&lt;Repo&gt;&gt; response)</span> </span>&#123;</div><div class="line">        List&lt;Repo&gt; data = response.body();</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"data size : "</span> + (data == <span class="keyword">null</span> ? <span class="string">"null"</span> : data.size() + <span class="string">""</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Throwable t)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我把上面主要分为4个部分，接下来逐一分析:    </p>
<h2 id="1-创建Retrofit并进行配置。"><a href="#1-创建Retrofit并进行配置。" class="headerlink" title="1. 创建Retrofit并进行配置。"></a>1. 创建<code>Retrofit</code>并进行配置。</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">  .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">  .addConverterFactory(GsonConverterFactory.create())</div><div class="line">  .build();</div></pre></td></tr></table></figure>
<p>简单的一句话，却埋藏了很多。     </p>
<p>这是典型的<strong><em>建造者模式、外观模式</em></strong>      </p>
<p>就想平时我们写的下载模块，作为一个公共的模块，我们可以对外提供一个<code>DownloadManager</code>供外界使用，而对于里面的实现我们完全可以闭门造车。    </p>
<p>具体<code>baseUrl()</code>、<code>addConverterFactory()</code>方法里面的具体实现就不去看了，比较简单。当然这里也用到了<strong><em>工厂设计模式</em></strong>。</p>
<h2 id="2-创建对应的服务类"><a href="#2-创建对应的服务类" class="headerlink" title="2. 创建对应的服务类"></a>2. 创建对应的服务类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GitHubService gitHubService = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure>
<p>这一部分是如何实现的呢？我们看一下<code>retrofit.create()</code>方法的实现:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">    Utils.validateServiceInterface(service);</div><div class="line">    <span class="keyword">if</span> (validateEagerly) &#123;</div><div class="line">      eagerlyValidateMethods(service);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">          <span class="comment">// 这里的Platform主要是为了检测当前的运行平台，是java还是android，会根据当前的平台来返回默认的CallAdapter</span></div><div class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span></span></div><div class="line">              <span class="keyword">throws</span> Throwable &#123;</div><div class="line">            <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></div><div class="line">            <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">              <span class="comment">// 代理调用</span></div><div class="line">              <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</div><div class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 1，根据动态代理的方法去生成ServiceMethod这里动态代理的方法就是listRepos方法</span></div><div class="line">            ServiceMethod serviceMethod = loadServiceMethod(method);</div><div class="line">            <span class="comment">// 2，根绝ServiceMethod和参数去生成OkHttpCall，这里args是CharonChui</span></div><div class="line">            OkHttpCall okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">            <span class="comment">// 3, serviceMethod去进行处理并返回Call对象，拿到这个Call对象才能去执行网络请求。</span></div><div class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>看到<code>Proxy.newProxyInstance()</code>就明白了，这里使用了<strong><em>动态代理</em></strong>。简单的说动态代理是在你要调用某个<code>Class</code>的方法前或后，插入你想要执行的代码。那这里要代理的是什么方法？ <code>Call&lt;List&lt;Repo&gt;&gt; call = gitHubService.listRepos(&quot;CharonChui&quot;);</code>，这里就是<code>listRepos()</code>方法。   就是说在调用<code>listRepos()</code>方法时会被动态代理所拦截，然后执行<code>Proxy.newProxyInstance()</code>里面的<code>InvocationHandler.invoke()</code>中的部分。   而<code>invoke()</code>方法的三个参数分别是啥？ 分别是<code>Object proxy</code>: 代理对象，<code>Method method</code>：调用的方法，就是<code>listRepos()</code>方法，<code>Object... args</code>：方法的参数，这里是<code>CharonChui</code>。   </p>
<p>有关动态代理介绍可以看<a href="">张孝祥老师的java1.5高新技术系列中的动态代理</a></p>
<p>这里就不仔细介绍动态代理了，上面的代码中又分为三部分:    </p>
<ul>
<li><code>loadServiceMethod()</code></li>
<li><code>new OkHttpCall()</code></li>
<li><code>serviceMethod.callAdapter.adapt()</code></li>
</ul>
<p>我们这里分别来进行分析。    </p>
<ul>
<li><p><code>loadServiceMethod()</code><br>  实现如下:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function">ServiceMethod <span class="title">loadServiceMethod</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">    ServiceMethod result;</div><div class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</div><div class="line">      <span class="comment">// ServiceMethod包含了请求的所有相关数据，以及获取请求的request和把请求结果转换成java对象，所以相比较而言较重，用缓存来提高效率。</span></div><div class="line">      result = serviceMethodCache.get(method);</div><div class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// build</span></div><div class="line">        result = <span class="keyword">new</span> ServiceMethod.Builder(<span class="keyword">this</span>, method).build();</div><div class="line">        serviceMethodCache.put(method, result);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>会通过缓存的方式来获取一个`ServiceMethod`类。通过缓存来保证同一个`API`的同一个方法只会创建一次。 
有关`ServiceMethod`类的文档介绍是:     
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Adapts an invocation of an <span class="class"><span class="keyword">interface</span> <span class="title">method</span> <span class="title">into</span> <span class="title">an</span> <span class="title">HTTP</span> <span class="title">call</span>.</span></div></pre></td></tr></table></figure>

大体翻译一下就是将一个请求接口的方法转换到`Http Call`中调用。    

而上面第一次使用的时候会通过`new ServiceMethod.Builder(this, method).build()`创建，那我们看一下它的实现:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// 创建CallAdapter用来代理Call</span></div><div class="line">      callAdapter = createCallAdapter();</div><div class="line">      responseType = callAdapter.responseType();</div><div class="line">      <span class="keyword">if</span> (responseType == Response.class || responseType == okhttp3.Response.class) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"'"</span></div><div class="line">            + Utils.getRawType(responseType).getName()</div><div class="line">            + <span class="string">"' is not a valid response body type. Did you mean ResponseBody?"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// responseConverter用来解析结果将json等返回结果解析成java对象</span></div><div class="line">      responseConverter = createResponseConverter();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">        parseMethodAnnotation(annotation);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (httpMethod == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"HTTP method annotation is required (e.g., @GET, @POST, etc.)."</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!hasBody) &#123;</div><div class="line">        <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">          <span class="keyword">throw</span> methodError(</div><div class="line">              <span class="string">"Multipart can only be specified on HTTP methods with request body (e.g., @POST)."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">          <span class="keyword">throw</span> methodError(<span class="string">"FormUrlEncoded can only be specified on HTTP methods with "</span></div><div class="line">              + <span class="string">"request body (e.g., @POST)."</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">      parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">        Type parameterType = parameterTypes[p];</div><div class="line">        <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</div><div class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"Parameter type must not include a type variable or wildcard: %s"</span>,</div><div class="line">              parameterType);</div><div class="line">        &#125;</div><div class="line">		<span class="comment">//  解析对应method的注解，这里是listRepos方法的注解。</span></div><div class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">        <span class="keyword">if</span> (parameterAnnotations == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 通过注解和参数类型，解析并赋值到parameterHandlers中</span></div><div class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (relativeUrl == <span class="keyword">null</span> &amp;&amp; !gotUrl) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Missing either @%s URL or @Url parameter."</span>, httpMethod);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Non-body HTTP method cannot contain @Body."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (isFormEncoded &amp;&amp; !gotField) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Form-encoded method must contain at least one @Field."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (isMultipart &amp;&amp; !gotPart) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Multipart method must contain at least one @Part."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 创建`ServiceMethod()`对象</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

总起来说，就是创建`CallAdapter`、`responseConverter`、解析注解、设置参数，然后创建`ServiceMethod`对象。   

而`ServiceMethod`的构造函数如下:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ServiceMethod(Builder&lt;T&gt; builder) &#123;</div><div class="line">    <span class="keyword">this</span>.callFactory = builder.retrofit.callFactory();</div><div class="line">    <span class="keyword">this</span>.callAdapter = builder.callAdapter;</div><div class="line">    <span class="keyword">this</span>.baseUrl = builder.retrofit.baseUrl();</div><div class="line">    <span class="keyword">this</span>.responseConverter = builder.responseConverter;</div><div class="line">    <span class="keyword">this</span>.httpMethod = builder.httpMethod;</div><div class="line">    <span class="keyword">this</span>.relativeUrl = builder.relativeUrl;</div><div class="line">    <span class="keyword">this</span>.headers = builder.headers;</div><div class="line">    <span class="keyword">this</span>.contentType = builder.contentType;</div><div class="line">    <span class="keyword">this</span>.hasBody = builder.hasBody;</div><div class="line">    <span class="keyword">this</span>.isFormEncoded = builder.isFormEncoded;</div><div class="line">    <span class="keyword">this</span>.isMultipart = builder.isMultipart;</div><div class="line">    <span class="keyword">this</span>.parameterHandlers = builder.parameterHandlers;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>


看到吗？ 这一部分我们应该都稍微有点印象，因为在上一篇文章介绍使用方法的时候，基本会用到这里。 
</code></pre><p>至于这里的<code>CallAdapter</code>、<code>ResponseConverter</code>、<code>Headers</code>、<code>ParamterHandlers</code>等这里就不分析了，最后我们再简单介绍下。</p>
<ul>
<li><p>创建<code>OkHttpCall</code></p>
<p>  接下来会创建<code>OkHttpCall</code>，而<code>OkHttpCall</code>是<code>Call</code>的子类，那<code>Call</code>是什么鬼？ 它是具体的网络请求类。</p>
<p>  文档中对<code>Call</code>类的介绍如下:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * An invocation of a Retrofit method that sends a request to a webserver and returns a response.</div><div class="line"> * Each call yields its own HTTP request and response pair. Use &#123;<span class="doctag">@link</span> #clone&#125; to make multiple</div><div class="line"> * calls with the same parameters to the same webserver; this may be used to implement polling or</div><div class="line"> * to retry a failed call.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Calls may be executed synchronously with &#123;<span class="doctag">@link</span> #execute&#125;, or asynchronously with &#123;<span class="doctag">@link</span></div><div class="line"> * #enqueue&#125;. In either case the call can be canceled at any time with &#123;<span class="doctag">@link</span> #cancel&#125;. A call that</div><div class="line"> * is busy writing its request or reading its response may receive a &#123;<span class="doctag">@link</span> IOException&#125;; this is</div><div class="line"> * working as designed.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> &lt;T&gt; Successful response body type.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Cloneable</span> </span>&#123;</div><div class="line">	<span class="comment">// 这里我特地把这句话放上，Call集成了Cloneable接口。</span></div><div class="line">	<span class="comment">// 每一个 call 对象实例只能被用一次，所以说 request 和 response 都是一一对应的。你其实可以通过 Clone 方法来创建一个一模一样的实例，这个开销是很小的。比如说：你可以在每次决定发请求前 clone 一个之前的实例。</span></div><div class="line">	....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>`Retrofit`底层默认使用`OkHttp`，所以当然要创建`OkHttpCall`了。    

- `serviceMethod.callAdapter.adapt(okHttpCall)`

这个`CallApdater`是什么鬼？   

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adapts a &#123;<span class="doctag">@link</span> Call&#125; into the type of &#123;<span class="doctag">@code</span> T&#125;. Instances are created by &#123;<span class="doctag">@linkplain</span> Factory a</div><div class="line"> * factory&#125; which is &#123;<span class="doctag">@linkplain</span> Retrofit.Builder#addCallAdapterFactory(Factory) installed&#125; into</div><div class="line"> * the &#123;<span class="doctag">@link</span> Retrofit&#125; instance.</div><div class="line"> */</div></pre></td></tr></table></figure>


可以很简单的看出来这是一个结果类型转换的类。就是`Call`的适配器，作用就是创建/转换`Call`对象，把`Call`转换成预期的格式。`CallAdatper`创建是通过`CallAdapter.factory`工厂类进行的。`DefaultCallAdapter`为`Retrofit2`自带默认`Call`转换器，用来生成`OKHTTP`的`call`请求调用。


而它里面的`adapt()`方法的作用呢？ 

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Returns an instance of &#123;<span class="doctag">@code</span> T&#125; which delegates to &#123;<span class="doctag">@code</span> call&#125;.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * For example, given an instance for a hypothetical utility, &#123;<span class="doctag">@code</span> Async&#125;, this instance would</div><div class="line">   * return a new &#123;<span class="doctag">@code</span> Async&lt;R&gt;&#125; which invoked &#123;<span class="doctag">@code</span> call&#125; when run.</div><div class="line">   * &lt;pre&gt;&lt;code&gt;</div><div class="line">   * &amp;#64;Override</div><div class="line">   * public &amp;lt;R&amp;gt; Async&amp;lt;R&amp;gt; adapt(final Call&amp;lt;R&amp;gt; call) &#123;</div><div class="line">   *   return Async.create(new Callable&amp;lt;Response&amp;lt;R&amp;gt;&amp;gt;() &#123;</div><div class="line">   *     &amp;#64;Override</div><div class="line">   *     public Response&amp;lt;R&amp;gt; call() throws Exception &#123;</div><div class="line">   *       return call.execute();</div><div class="line">   *     &#125;</div><div class="line">   *   &#125;);</div><div class="line">   * &#125;</div><div class="line">   * &lt;/code&gt;&lt;/pre&gt;</div><div class="line">   */</div><div class="line">  &lt;R&gt; <span class="function">T <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span></span>;</div></pre></td></tr></table></figure>


所以分析到这里我们基本明白了`retrofit.create()`方法的作用，就是将请求接口的服务类转换成`Call`，然后将`Call`的结果转换成实体类。
</code></pre><h2 id="3-调用方法，得到Call对象"><a href="#3-调用方法，得到Call对象" class="headerlink" title="3. 调用方法，得到Call对象"></a>3. 调用方法，得到<code>Call</code>对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Call&lt;List&lt;Repo&gt;&gt; call = gitHubService.listRepos(<span class="string">"CharonChui"</span>);</div></pre></td></tr></table></figure>
<p>这个就不分析了，就是在<code>ServiceMethod</code>中返回的<code>Call</code>。</p>
<h2 id="4-调用Call-enqueue"><a href="#4-调用Call-enqueue" class="headerlink" title="4. 调用Call.enqueue()"></a>4. 调用<code>Call.enqueue()</code></h2><p>在上面分析了，这个<code>Call</code>其实是<code>OkHttpCall</code>，那我们来看一下<code>OkHttpCall.enqueue()</code>方法的实现:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line"></div><div class="line">    okhttp3.Call call;</div><div class="line">    Throwable failure;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already executed."</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">      call = rawCall;</div><div class="line">      failure = creationFailure;</div><div class="line">      <span class="keyword">if</span> (call == <span class="keyword">null</span> &amp;&amp; failure == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// 调用createRawCall()方法创建Call</span></div><div class="line">          call = rawCall = createRawCall();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          failure = creationFailure = t;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (failure != <span class="keyword">null</span>) &#123;</div><div class="line">      callback.onFailure(<span class="keyword">this</span>, failure);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (canceled) &#123;</div><div class="line">      call.cancel();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 把请求任务加入到okhttp的请求队列中，执行网络请求，注意这里的Call是okhttp3.Call</span></div><div class="line">    call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span></span></div><div class="line">          <span class="keyword">throws</span> IOException &#123;</div><div class="line">        Response&lt;T&gt; response;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// 解析结果，该方法内部会将OkHttp中Request的执行结果转换成对应的Java对象。</span></div><div class="line">          response = parseResponse(rawResponse);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">          callFailure(e);</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        callSuccess(response);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          t.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callFailure</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          t.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callSuccess</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          callback.onResponse(OkHttpCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          t.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>上面的部分也主要分为三部分:    </p>
<ul>
<li>创建Call</li>
<li>执行网络请求</li>
<li>解析结果 </li>
</ul>
<h4 id="第一部分：创建Call"><a href="#第一部分：创建Call" class="headerlink" title="第一部分：创建Call"></a>第一部分：创建<code>Call</code></h4><p>我们分别进行分析，首先是<code>createRawCall()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="comment">// ServiceMethod.toRequest()方法的作用是将ServiceMethod中的网络请求相关的数据转换成一个OkHttp的网络请求所需要的Request对象。因为之前分析过所有Retrofit解析的网络请求相关的数据都是在ServiceMethod中</span></div><div class="line">  Request request = serviceMethod.toRequest(args);</div><div class="line">  <span class="comment">// 调用Factory.newCall方法</span></div><div class="line">  okhttp3.Call call = serviceMethod.callFactory.newCall(request);</div><div class="line">  <span class="keyword">if</span> (call == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> call;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后看一下<code>Factory.newCall()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">    <span class="function">Call <span class="title">newCall</span><span class="params">(Request request)</span></span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>它的实现类是<code>OkHttpClient</code>类中的<code>newCall()</code>方法，并且创建<code>RealCall</code>对象:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RealCall(<span class="keyword">this</span>, request);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h4 id="第二部分：执行网络请求"><a href="#第二部分：执行网络请求" class="headerlink" title="第二部分：执行网络请求"></a>第二部分：执行网络请求</h4><p>这一部分是在<code>call.enqueue()</code>方法中执行的，上面我们分析了创建的<code>Call</code>最终是<code>RealCall</code>类，所以这里直接到看<code>RealCall.enqueue()</code>方法:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</div><div class="line">    enqueue(responseCallback, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 调用OkHttpClient中的Dispatcher中的enqueue方法</span></div><div class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback, forWebSocket));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们接着看<code>client.dispatcher().enqueue()</code>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(AsyncCall call)</span> </span>&#123;</div><div class="line">    <span class="comment">// maxRequests的个数是64;</span></div><div class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</div><div class="line">      runningAsyncCalls.add(call);</div><div class="line">      <span class="comment">// 线程池执行</span></div><div class="line">      executorService().execute(call);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      readyAsyncCalls.add(call);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">```   </div><div class="line"></div><div class="line">而这个参数`AsyncCall`是什么鬼？ 它是`RealCall`的内部类，它里面的`execute()`方法是如何实现的？ 只要找到该方法的实现就算是完成了。     </div><div class="line"></div><div class="line">首先看一下`AsyncCall`的声明和构造:    </div><div class="line">```java</div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span> <span class="keyword">extends</span> <span class="title">NamedRunnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Callback responseCallback;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AsyncCall</span><span class="params">(Callback responseCallback, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(<span class="string">"OkHttp %s"</span>, redactedUrl().toString());</div><div class="line">      <span class="keyword">this</span>.responseCallback = responseCallback;</div><div class="line">      <span class="keyword">this</span>.forWebSocket = forWebSocket;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><code>NamedRunnable</code>是<code>Runnable</code>的实现类。我们看一下它的<code>execute()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 获取请求结果</span></div><div class="line">        Response response = getResponseWithInterceptorChain(forWebSocket);</div><div class="line">        <span class="keyword">if</span> (canceled) &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          <span class="comment">// 将响应结果设置给之前构造函数传递回来的回调</span></div><div class="line">          responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">          <span class="comment">// Do not signal the callback twice!</span></div><div class="line">          Platform.get().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>RealCall.getResponseWithInterceptorChain()</code>:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Response <span class="title">getResponseWithInterceptorChain</span><span class="params">(<span class="keyword">boolean</span> forWebSocket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Interceptor.Chain chain = <span class="keyword">new</span> ApplicationInterceptorChain(<span class="number">0</span>, originalRequest, forWebSocket);</div><div class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInterceptorChain</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Chain</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Request request;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line"></div><div class="line">    ApplicationInterceptorChain(<span class="keyword">int</span> index, Request request, <span class="keyword">boolean</span> forWebSocket) &#123;</div><div class="line">      <span class="keyword">this</span>.index = index;</div><div class="line">      <span class="keyword">this</span>.request = request;</div><div class="line">      <span class="keyword">this</span>.forWebSocket = forWebSocket;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Connection <span class="title">connection</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      <span class="comment">// If there's another interceptor in the chain, call that.</span></div><div class="line">      <span class="keyword">if</span> (index &lt; client.interceptors().size()) &#123;</div><div class="line">        Interceptor.Chain chain = <span class="keyword">new</span> ApplicationInterceptorChain(index + <span class="number">1</span>, request, forWebSocket);</div><div class="line">        Interceptor interceptor = client.interceptors().get(index);</div><div class="line">        Response interceptedResponse = interceptor.intercept(chain);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (interceptedResponse == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"application interceptor "</span> + interceptor</div><div class="line">              + <span class="string">" returned null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> interceptedResponse;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// No more interceptors. Do HTTP.</span></div><div class="line">      <span class="keyword">return</span> getResponse(request, forWebSocket);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>又会调用<code>getResponse()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Performs the request and returns the response. May return null if this call was canceled.</div><div class="line">   */</div><div class="line">  <span class="function">Response <span class="title">getResponse</span><span class="params">(Request request, <span class="keyword">boolean</span> forWebSocket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// Copy body metadata to the appropriate request headers.</span></div><div class="line">    RequestBody body = request.body();</div><div class="line">    <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</div><div class="line">      Request.Builder requestBuilder = request.newBuilder();</div><div class="line"></div><div class="line">      MediaType contentType = body.contentType();</div><div class="line">      <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Content-Type"</span>, contentType.toString());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">long</span> contentLength = body.contentLength();</div><div class="line">      <span class="keyword">if</span> (contentLength != -<span class="number">1</span>) &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Content-Length"</span>, Long.toString(contentLength));</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>);</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      request = requestBuilder.build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Create the initial HTTP engine. Retries and redirects need new engine for each attempt.</span></div><div class="line">    engine = <span class="keyword">new</span> HttpEngine(client, request, <span class="keyword">false</span>, <span class="keyword">false</span>, forWebSocket, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> followUpCount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (canceled) &#123;</div><div class="line">        engine.releaseStreamAllocation();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">boolean</span> releaseConnection = <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        engine.sendRequest();</div><div class="line">        engine.readResponse();</div><div class="line">        releaseConnection = <span class="keyword">false</span>;</div><div class="line">      &#125; <span class="keyword">catch</span> (RequestException e) &#123;</div><div class="line">        <span class="comment">// The attempt to interpret the request failed. Give up.</span></div><div class="line">        <span class="keyword">throw</span> e.getCause();</div><div class="line">      &#125; <span class="keyword">catch</span> (RouteException e) &#123;</div><div class="line">        <span class="comment">// The attempt to connect via a route failed. The request will not have been sent.</span></div><div class="line">        HttpEngine retryEngine = engine.recover(e.getLastConnectException(), <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (retryEngine != <span class="keyword">null</span>) &#123;</div><div class="line">          releaseConnection = <span class="keyword">false</span>;</div><div class="line">          engine = retryEngine;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Give up; recovery is not possible.</span></div><div class="line">        <span class="keyword">throw</span> e.getLastConnectException();</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="comment">// An attempt to communicate with a server failed. The request may have been sent.</span></div><div class="line">        HttpEngine retryEngine = engine.recover(e, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (retryEngine != <span class="keyword">null</span>) &#123;</div><div class="line">          releaseConnection = <span class="keyword">false</span>;</div><div class="line">          engine = retryEngine;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Give up; recovery is not possible.</span></div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">// We're throwing an unchecked exception. Release any resources.</span></div><div class="line">        <span class="keyword">if</span> (releaseConnection) &#123;</div><div class="line">          StreamAllocation streamAllocation = engine.close();</div><div class="line">          streamAllocation.release();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Response response = engine.getResponse();</div><div class="line">      Request followUp = engine.followUpRequest();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (followUp == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!forWebSocket) &#123;</div><div class="line">          engine.releaseStreamAllocation();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      StreamAllocation streamAllocation = engine.close();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (++followUpCount &gt; MAX_FOLLOW_UPS) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"Too many follow-up requests: "</span> + followUpCount);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!engine.sameConnection(followUp.url())) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        streamAllocation = <span class="keyword">null</span>;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (streamAllocation.stream() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Closing the body of "</span> + response</div><div class="line">            + <span class="string">" didn't close its backing stream. Bad interceptor?"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      request = followUp;</div><div class="line">      engine = <span class="keyword">new</span> HttpEngine(client, request, <span class="keyword">false</span>, <span class="keyword">false</span>, forWebSocket, streamAllocation, <span class="keyword">null</span>,</div><div class="line">          response);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>完了没有？ 完了….</p>
<p>上面只是简单的分析了下大体的调用流程和主要的类，但是好像并没有什么乱用，因为没有具体的去分析里面各部分的实现，如果都分析下来内容太多了。这里就不仔细看了，大体总结一下。    </p>
<p>通过上面的分析，最终的网络请求是在<code>OkHttp</code>的<code>Call</code>中去执行，也就是说<code>Retrofit</code>其实是将一个<code>Java</code>接口通过注解等方式来解析参数等然后转换成一个请求交给<code>OkHttp</code>去执行，然后将执行结果进行解析转换暴露给上层调用者。<br>而这一切是如何实现的呢？<br><code>Retrofit</code>非常巧妙的用注解来描述一个<code>HTTP</code>请求，将一个<code>HTTP</code>请求抽象成一个<code>Java</code>接口，然后用了<code>动态代理</code>的方式，动态的将这个接口的注解转换成一个<code>HTTP</code>请求，然后再将这个<code>Http</code>请求交给<code>OkHttp</code>执行。</p>
<p>动态代理用的太妙，而它的过程中也使用了大量的工厂模式，这里就不分析了。</p>
<p>参考:   </p>
<ul>
<li><a href="https://realm.io/news/droidcon-jake-wharton-simple-http-retrofit-2" target="_blank" rel="external">simple-http-retrofit-2</a></li>
<li><a href="http://square.github.io/retrofit/2.x/retrofit/" target="_blank" rel="external">Retrofit API</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2014/11/02/Retrofit详解(下)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Lantern</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>