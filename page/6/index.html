<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://github.com/itgoyo">
  <title>itgoyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="talk is cheap,show me the girl.">
<meta property="og:type" content="website">
<meta property="og:title" content="itgoyo">
<meta property="og:url" content="https://github.com/itgoyo/page/6/index.html">
<meta property="og:site_name" content="itgoyo">
<meta property="og:description" content="talk is cheap,show me the girl.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="itgoyo">
<meta name="twitter:description" content="talk is cheap,show me the girl.">
  
    <link rel="alternative" href="/atom.xml" title="itgoyo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/main.d221b8.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c16d3c10c9ea6c6fe749d9926d52b0d6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=110 src="//music.163.com/outchain/player?type=0&id=120897804&auto=0&height=90"></iframe>
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">itgoyo</a></h1>
		</hgroup>
		
		<p class="header-subtitle">talk is cheap,show me the girl.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="https://cn.gravatar.com/userimage/109230546/898311ab23eb215d186762d5e93e773d.jpg?size=200" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">itgoyo</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>talk is cheap,show me the girl.<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/itgoyo" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5792513777/profile?topnav=1&wvr=6&is_all=1" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:itgoyo@gmail.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-热修复实现" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/热修复实现/">热修复实现</a>
    </h1>
  

        
        <a href="/2015/01/01/热修复实现/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="热修复实现"><a href="#热修复实现" class="headerlink" title="热修复实现"></a>热修复实现</h1><p>现在的热修复方案已经有很多了，例如<code>alibaba</code>的<a href="https://github.com/alibaba/dexposed">dexposed</a>、<a href="https://github.com/alibaba/AndFix">AndFix</a>以及<code>jasonross</code>的<a href="https://github.com/jasonross/Nuwa">Nuwa</a>等等。原来没有仔细去分析过也没想写这篇文章，但是之前<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android加强/InstantRun详解.md">InstantRun详解</a>这篇文章中介绍了<code>Android Studio Instant Run</code>的<br>实现原理，这不就是活生生的一个热修复吗？ 随心情久久不能平复，我们何不用这种方式来实现。    </p>
<p>方案有很多种，我就只说明下我想到的方式，也就是<code>Instant Run</code>的方式:<br>分拆到不同的<code>dex</code>中，然后通过<code>classloader</code>来进行加载。但是在之前<code>InstantRun详解</code>中只说到会通过内部的<code>server</code>去判断该类是否有更新，如果有的话就去从新的<code>dex</code>中加载该类，否则就从旧的<code>dex</code>中加载，但这是如何实现的呢？ 怎么去从不同的<code>dex</code>中选择最新的那个来进行加载。    </p>
<p>讲到这里需要先介绍一下<code>ClassLoader</code>：       </p>
<p>&lt; <code>A class loader is an object that is responsible for loading classes. The class ClassLoader is an abstract class. Given the binary name of a class, a class loader should attempt to locate or generate data that constitutes a definition for the class. A typical strategy is to transform the name into a file name and then read a &quot;class file&quot; of that name from a file system.</code>     </p>
<p>在一般情况下，应用程序不需要创建一个全新的ClassLoader对象，而是使用当前环境已经存在的ClassLoader。因为Javad的Runtime环境在初始化时，其内部会创建一个ClassLoader对象用于加载Runtime所需的各种Java类。<br>每个ClassLoader必须有一个父ClassLoader，在装载Class文件时，子ClassLoader会先请求父ClassLoader加载该Class文件，只有当其父ClassLoader找不到该Class文件时，子ClassLoader才会继续装载该类，这是一种安全机制。</p>
<p>对于Android的应用程序，本质上虽然也是用Java开发，并且使用标准的Java编译器编译出Class文件，但最终的APK文件中包含的却是dex类型的文件。dex文件是将所需的所有Class文件重新打包，打包的规则不是简单的压缩，而是完全对Class文件内部的各种函数表、变量表等进行优化，并产生一个新的文件，这就是dex文件。由于dex文件是一种经过优化的Class文件，因此要加载这样特殊的Class文件就需要特殊的类装载器，这就是DexClassLoader，Android SDK中提供的DexClassLoader类就是出于这个目的。</p>
<p>总体来说，<code>Android</code> 默认主要有三个<code>ClassLoader</code>:   </p>
<ul>
<li><p><code>BootClassLoader</code>: 系统启动时创建，<br>  &lt; `Provides an explicit representation of the boot class loader. It sits at the</p>
<ul>
<li>head of the class loader chain and delegates requests to the VM’s internal</li>
<li>class loading mechanism.`</li>
</ul>
</li>
<li><p><code>PathClassLoader</code>: 可以加载/data/app目录下的apk，这也意味着，它只能加载已经安装的apk；</p>
</li>
<li><code>DexClassLoader</code>: 可以加载文件系统上的jar、dex、apk；可以从SD卡中加载未安装的apk</li>
</ul>
<p>通过上面的分析知道，如果用多个<code>dex</code>的话肯定会用到<code>DexClassLoader</code>类，我们首先来看一下它的源码(这里<br>插一嘴，源码可以去<a href="https://android.googlesource.com/platform/libcore-snapshot/+/ics-mr1/dalvik/src/main/java/dalvik/system" target="_blank" rel="external">googlesource</a>中找):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A class loader that loads classes from &#123;<span class="doctag">@code</span> .jar&#125; and &#123;<span class="doctag">@code</span> .apk&#125; files</div><div class="line"> * containing a &#123;<span class="doctag">@code</span> classes.dex&#125; entry. This can be used to execute code not</div><div class="line"> * installed as part of an application.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This class loader requires an application-private, writable directory to</div><div class="line"> * cache optimized classes. Use &#123;<span class="doctag">@code</span> Context.getDir(String, int)&#125; to create</div><div class="line"> * such a directory: &lt;pre&gt;   &#123;<span class="doctag">@code</span></div><div class="line"> *   File dexOutputDir = context.getDir("dex", 0);</div><div class="line"> * &#125;&lt;/pre&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;&lt;strong&gt;Do not cache optimized classes on external storage.&lt;/strong&gt;</div><div class="line"> * External storage does not provide access controls necessary to protect your</div><div class="line"> * application from code injection attacks.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a &#123;<span class="doctag">@code</span> DexClassLoader&#125; that finds interpreted and native</div><div class="line">     * code.  Interpreted classes are found in a set of DEX files contained</div><div class="line">     * in Jar or APK files.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;The path lists are separated using the character specified by the</div><div class="line">     * &#123;<span class="doctag">@code</span> path.separator&#125; system property, which defaults to &#123;<span class="doctag">@code</span> :&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</div><div class="line">     *     resources, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;, which</div><div class="line">     *     defaults to &#123;<span class="doctag">@code</span> ":"&#125; on Android</div><div class="line">     * <span class="doctag">@param</span> optimizedDirectory directory where optimized dex files</div><div class="line">     *     should be written; must not be &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> libraryPath the list of directories containing native</div><div class="line">     *     libraries, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;; may be</div><div class="line">     *     &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> parent the parent class loader</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></div><div class="line">            String libraryPath, ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">new</span> File(optimizedDirectory), libraryPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释说的太明白了，这里就不翻译了，但是我们并没有找到加载的代码，去它的父类中查找，<br>因为家在都是从<code>loadClass()</code>方法中，所以我们去<code>ClassLoader</code>类中看一下<code>loadClass()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Loads the class with the specified name. Invoking this method is</div><div class="line">     * equivalent to calling &#123;<span class="doctag">@code</span> loadClass(className, false)&#125;.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;strong&gt;Note:&lt;/strong&gt; In the Android reference implementation, the</div><div class="line">     * second parameter of &#123;<span class="doctag">@link</span> #loadClass(String, boolean)&#125; is ignored</div><div class="line">     * anyway.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the &#123;<span class="doctag">@code</span> Class&#125; object.</div><div class="line">     * <span class="doctag">@param</span> className</div><div class="line">     *            the name of the class to look for.</div><div class="line">     * <span class="doctag">@throws</span> ClassNotFoundException</div><div class="line">     *             if the class can not be found.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String className) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        <span class="keyword">return</span> loadClass(className, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Loads the class with the specified name, optionally linking it after</div><div class="line">     * loading. The following steps are performed:</div><div class="line">     * &lt;ol&gt;</div><div class="line">     * &lt;li&gt; Call &#123;<span class="doctag">@link</span> #findLoadedClass(String)&#125; to determine if the requested</div><div class="line">     * class has already been loaded.&lt;/li&gt;</div><div class="line">     * &lt;li&gt;If the class has not yet been loaded: Invoke this method on the</div><div class="line">     * parent class loader.&lt;/li&gt;</div><div class="line">     * &lt;li&gt;If the class has still not been loaded: Call</div><div class="line">     * &#123;<span class="doctag">@link</span> #findClass(String)&#125; to find the class.&lt;/li&gt;</div><div class="line">     * &lt;/ol&gt;</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;strong&gt;Note:&lt;/strong&gt; In the Android reference implementation, the</div><div class="line">     * &#123;<span class="doctag">@code</span> resolve&#125; parameter is ignored; classes are never linked.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the &#123;<span class="doctag">@code</span> Class&#125; object.</div><div class="line">     * <span class="doctag">@param</span> className</div><div class="line">     *            the name of the class to look for.</div><div class="line">     * <span class="doctag">@param</span> resolve</div><div class="line">     *            Indicates if the class should be resolved after loading. This</div><div class="line">     *            parameter is ignored on the Android reference implementation;</div><div class="line">     *            classes are not resolved.</div><div class="line">     * <span class="doctag">@throws</span> ClassNotFoundException</div><div class="line">     *             if the class can not be found.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        Class&lt;?&gt; clazz = findLoadedClass(className);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            ClassNotFoundException suppressed = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">            	<span class="comment">// 先检查父ClassLoader是否已经家在过该类</span></div><div class="line">                clazz = parent.loadClass(className, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                suppressed = e;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                	<span class="comment">// 调用DexClassLoader.findClass()方法。</span></div><div class="line">                    clazz = findClass(className);</div><div class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                    e.addSuppressed(suppressed);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> clazz;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上面会调用<code>DexClassLoader.findClass()</code>方法，但是<code>DexClassLoader</code>没有实现该方法，所以去它的父类<code>BaseDexClassLoader</code>中看，接着看一下<code>BaseDexClassLoader</code>的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Base class for common functionality between various dex-based</div><div class="line"> * &#123;<span class="doctag">@link</span> ClassLoader&#125; implementations.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line">    <span class="comment">/** originally specified path (just used for &#123;<span class="doctag">@code</span> toString()&#125;) */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String originalPath;</div><div class="line">    <span class="comment">/** structured lists of path elements */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructs an instance.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</div><div class="line">     * resources, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;, which</div><div class="line">     * defaults to &#123;<span class="doctag">@code</span> ":"&#125; on Android</div><div class="line">     * <span class="doctag">@param</span> optimizedDirectory directory where optimized dex files</div><div class="line">     * should be written; may be &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> libraryPath the list of directories containing native</div><div class="line">     * libraries, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;; may be</div><div class="line">     * &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> parent the parent class loader</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></div><div class="line">            String libraryPath, ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(parent);</div><div class="line">        <span class="keyword">this</span>.originalPath = dexPath;</div><div class="line">        <span class="keyword">this</span>.pathList =</div><div class="line">            <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        <span class="comment">// 从DexPathList中找</span></div><div class="line">        Class clazz = pathList.findClass(name);</div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> clazz;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pathList.findResource(name);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pathList.findResources(name);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findLibrary</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pathList.findLibrary(name);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在<code>findClass()</code>方法中我们看到调用了<code>DexPathList.findClass()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A pair of lists of entries, associated with a &#123;<span class="doctag">@code</span> ClassLoader&#125;.</div><div class="line"> * One of the lists is a dex/resource path &amp;mdash; typically referred</div><div class="line"> * to as a "class path" &amp;mdash; list, and the other names directories</div><div class="line"> * containing native code libraries. Class path entries may be any of:</div><div class="line"> * a &#123;<span class="doctag">@code</span> .jar&#125; or &#123;<span class="doctag">@code</span> .zip&#125; file containing an optional</div><div class="line"> * top-level &#123;<span class="doctag">@code</span> classes.dex&#125; file as well as arbitrary resources,</div><div class="line"> * or a plain &#123;<span class="doctag">@code</span> .dex&#125; file (with no possibility of associated</div><div class="line"> * resources).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;This class also contains methods to use these lists to look up</div><div class="line"> * classes and resources.&lt;/p&gt;</div><div class="line"> */</div><div class="line"><span class="comment">/*package*/</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEX_SUFFIX = <span class="string">".dex"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAR_SUFFIX = <span class="string">".jar"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZIP_SUFFIX = <span class="string">".zip"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APK_SUFFIX = <span class="string">".apk"</span>;</div><div class="line">    <span class="comment">/** class definition context */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader definingContext;</div><div class="line">    <span class="comment">/** list of dex/resource (class path) elements */</span> </div><div class="line">    <span class="comment">// 把dex封装成一个数组，每个Element代表一个dex</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Element[] dexElements;</div><div class="line">    <span class="comment">/** list of native library directory elements */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File[] nativeLibraryDirectories;</div><div class="line"></div><div class="line">    <span class="comment">// .....</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Finds the named class in one of the dex files pointed at by</div><div class="line">     * this instance. This will find the one in the earliest listed</div><div class="line">     * path element. If the class is found but has not yet been</div><div class="line">     * defined, then this method will define it in the defining</div><div class="line">     * context that this instance was constructed with.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the named class or &#123;<span class="doctag">@code</span> null&#125; if the class is not</div><div class="line">     * found in any of the dex files</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</div><div class="line">            DexFile dex = element.dexFile;</div><div class="line">            <span class="comment">// 遍历数组，拿到第一个就返回</span></div><div class="line">            <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</div><div class="line">                Class clazz = dex.loadClassBinaryName(name, definingContext);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> clazz;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面的源码中分析，我知道系统会把所有相关的<code>dex</code>维护到一个数组中，然后在加载类的时候会从该数组中的第一个元素中取，然后返回。那我们只要保证将我们热修复后的<code>dex</code>对应的<code>Element</code>放到该数组的第一个位置就可以了，这样系统就会加载我们热修复的<code>dex</code>中的类。<br>所以方案出来了，只要把有问题的类修复后，放到一个单独的<code>dex</code>，然后把该<code>Dex</code>转换成对应的<code>Element</code>后再将该<code>Element</code>插入到<code>dexElements</code>数组的第一个位置就可以了。那该如何去将其插入到<code>dexElements</code>数组的第一个位置呢？– 暴力反射。      </p>
<p>到这里我感觉初步的思路已经有了:      </p>
<ul>
<li>将补丁作为<code>dex</code>发布。 </li>
<li>通过反射修改该<code>dex</code>所对应的<code>Element</code>在数组中的位置。 </li>
</ul>
<p>但是我也想到肯定还会有类似下面的问题:     </p>
<ul>
<li>资源文件的处理</li>
<li>四大组件的处理</li>
<li>清单文件的处理</li>
</ul>
<p>虽然我知道没有这么简单，但是我还是决定抱着不作不死的宗旨继续前行。    </p>
<p>好了，<code>demo</code>走起来。    </p>
<p>怎么生成<code>dex</code>文件呢？<br>这要讲过两部分:   </p>
<ul>
<li><code>.class</code>-&gt; <code>.jar</code> : <code>jar  -cvf test.jar com/charon/instantfix_sample/MainActivity.class</code></li>
<li><code>.jar</code>-&gt; <code>.dex</code>: <code>dx --dex --output=target.jar test.jar</code> <code>target.jar</code>就是包含<code>.dex</code>的<code>jar</code>包</li>
</ul>
<p>生成好<code>dex</code>后我们为了模拟先将其放到<code>asset</code>目录下(实际开发中肯定要从接口中去下载，当然还会有一些版本号的判断等)，然后就是将该<code>dex</code>转换成</p>
<p>我的方案中采用的是MultiDex，对其进行一部分改造，具体代码：<br>1、添加dex文件，并执行install<br>/**</p>
<ul>
<li>添加apk包外的dex文件</li>
<li>自动执行install</li>
<li>@param dexFile<br>*/<br>public static void addDexFileAutoInstall(Context context, List<file> dexFile,File optimizedDirectory) {<br>  if (dexFile != null &amp;&amp; !dexFile.isEmpty() &amp;&amp;!dexFiles.contains(dexFile)) {<pre><code>dexFiles.addAll(dexFile);
LogUtil.d(TAG, &quot;add other dexfile&quot;);
installDexFile(context,optimizedDirectory);
</code></pre>   }<br>}<br>2、installDexFile直接调用MultiDex 的installSecondaryDexes方法。<br>/**<ul>
<li>添加apk包外的dex文件，</li>
<li>@param context<br>*/<br>publicstatic void installDexFile(Context context, File optimizedDirectory){<br>if (checkValidZipFiles(dexFiles)) {<pre><code>try {
    installSecondaryDexes(context.getClassLoader(), optimizedDirectory, dexFiles);
} catch (IllegalAccessExceptione){
   e.printStackTrace();
} catch (NoSuchFieldExceptione) {
   e.printStackTrace();
} catch (InvocationTargetExceptione){
   e.printStackTrace();
} catch (NoSuchMethodExceptione) {
   e.printStackTrace();
} catch (IOExceptione) {
   e.printStackTrace();
}
</code></pre>}<br>}<br>3、将patch.dex放在所有dex最前面。<br>private static voidexpandFieldArray(Object instance, String fieldName, Object[]extraElements) throws NoSuchFieldException, IllegalArgumentException,<br>IllegalAccessException {<pre><code>  Field jlrField = findField(instance, fieldName);
  Object[]original = (Object[]) jlrField.get(instance);
  Object[]combined = (Object[]) Array.newInstance(original.getClass().getComponentType(),original.length + extraElements.length);
  // 将后来的dex放在前面，主dex放在最后。
System.arraycopy(extraElements, 0, combined, 0, extraElements.length);
System.arraycopy(original, 0, combined, extraElements.length,original.length);
 // 原始的dex合并，是将主dex放在前面，其他的dex依次放在后面。
 //System.arraycopy(original, 0, combined, 0, original.length);
 //System.arraycopy(extraElements, 0, combined, original.length,extraElements.length);
jlrField.set(instance, combined);
</code></pre>}<br>到此将patch.dex放进了Element，接下来的问题就是加载Class，当加载patch.dex中类的时候，会遇到一个问题，这个问题就是QQ空间团队遇到,Classd的CLASS_ISPREVERIFIED。具体原因是dvmResolveClass这个方法对Class进行了校验。判断这个要Resolve的class是否和其引用来自一个dex。如果不是，就会遇到问题。</li>
</ul>
</file></li>
</ul>
<p>当引用这和被引用者不在同一个dex中就会抛出异常，导致Resolve失败。QQ空间团队的方案是阻止所有的Class类打上CLASS_ISPREVERIFIED来逃过校验，这种方式其实是影响性能。<br>我们的方案是和QQ团队的类似，但是和QQ空间不同的是，我们将fromUnverifiedConstant设置为true，来逃过校验，达到补丁的路径。具体怎么实现呢？<br>要引用Cydia Hook技术来hook Native dalvik中dvmResolveClass这个方法。有关Cydia Hook技术请参考：<br>官网地址：<a href="http://www.cydiasubstrate.com/" target="_blank" rel="external">http://www.cydiasubstrate.com/</a><br>官方教程：<a href="http://www.cydiasubstrate.com/id/38be592b-bda7-4dd2-b049-cec44ef7a73b" target="_blank" rel="external">http://www.cydiasubstrate.com/id/38be592b-bda7-4dd2-b049-cec44ef7a73b</a><br>SDK下载地址：<a href="http://asdk.cydiasubstrate.com/zips/cydia_substrate-r2.zip" target="_blank" rel="external">http://asdk.cydiasubstrate.com/zips/cydia_substrate-r2.zip</a><br>具体代码如下。<br>//指明要hook的lib ：<br>MSConfig(MSFilterLibrary,”/system/lib/libdvm.so”)</p>
<p>// 在初始化的时候进行hook<br>MSInitialize {<br>    LOGD(“Cydia Init”);<br>    MSImageRef image;<br>    //载入lib<br>    image = MSGetImageByName(“/system/lib/libdvm.so”);<br>    if (image != NULL) {<br>        LOGD(“image is not null”);<br>        void <em>dexload=MSFindSymbol(image,”dvmResolveClass”);<br>        if(dexload != NULL) {<br>            LOGD(“dexloadis not null”);<br>            MSHookFunction(dexload, (void</em>)proxyDvmResolveClass, (void<em>*)&amp;dvmResolveClass_Proxy);<br>        } else{<br>            LOGD(“errorfind dvmResolveClass”);<br>        }<br>    }<br>}<br>// 在初始化的时候进行hook//保留原来的地址<br>ClassObject</em> (<em>dvmResolveClass_Proxy)(ClassObject</em> referrer, u4 classIdx, boolfromUnverifiedConstant);<br>// 新方法地址<br>static ClassObject<em> proxyDvmResolveClass(ClassObject</em> referrer, u4 classIdx,bool fromUnverifiedConstant) {<br>        return dvmResolveClass_Proxy(referrer, classIdx,true);<br>}<br>有人可能会担心cydia Hook性能，稳定性问题，但是据我所知，目前有些公司已经用它来实现apk加壳和脱壳防止反编译技术方案。具体可以参考<a href="http://www.gitzx.com/android-cydiasubstrate/" target="_blank" rel="external">http://www.gitzx.com/android-cydiasubstrate/</a></p>
<p>说到此处，似乎已经是一个完整的方案了，但在实践中，会发现运行加载类的时候报preverified错误，原来在DexPrepare.cpp，将dex转化成odex的过程中，会在DexVerify.cpp进行校验，验证如果直接引用到的类和clazz是否在同一个dex，如果是，则会打上CLASS_ISPREVERIFIED标志。通过在所有类（Application除外，当时还没加载自定义类的代码）的构造函数插入一个对在单独的dex的类的引用，就可以解决这个问题。空间使用了javaassist进行编译时字节码插入。</p>
<p>所以为了实现补丁方案，所以必须从这些方法中入手，防止类被打上CLASS_ISPREVERIFIED标志。 最终空间的方案是往所有类的构造函数里面插入了一段代码，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (ClassVerifier.PREVENT_VERIFY) &#123;</div><div class="line">    System.out.println(AntilazyLoad.class);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中AntilazyLoad类会被打包成单独的antilazy.dex，这样当安装apk的时候，classes.dex内的类都会引用一个在不相同dex中的AntilazyLoad类，这样就防止了类被打上CLASS_ISPREVERIFIED的标志了，只要没被打上这个标志的类都可以进行打补丁操作。 然后在应用启动的时候加载进来.AntilazyLoad类所在的dex包必须被先加载进来,不然AntilazyLoad类会被标记为不存在，即使后续加载了hack.dex包，那么他也是不存在的，这样屏幕就会出现茫茫多的类AntilazyLoad找不到的log。 所以Application作为应用的入口不能插入这段代码。（因为载入hack.dex的代码是在Application中onCreate中执行的，如果在Application的构造函数里面插入了这段代码，那么就是在hack.dex加载之前就使用该类，该类一次找不到，会被永远的打上找不到的标志)</p>
<p>如何打包补丁包：<br>１. 空间在正式版本发布的时候，会生成一份缓存文件，里面记录了所有class文件的md5，还有一份mapping混淆文件。<br>２. 在后续的版本中使用-applymapping选项，应用正式版本的mapping文件，然后计算编译完成后的class文件的md5和正式版本进行比较，把不相同的class文件打包成补丁包。<br>备注:该方案现在也应用到我们的编译过程当中,编译不需要重新打包dex,只需要把修改过的类的class文件打包成patch dex,然后放到sdcard下,那么就会让改变的代码生效。</p>
<p>在 Java 中，只有当两个实例的类名、包名以及加载其的 ClassLoader 都相同，才会被认为是同一种类型。上面分别加载的新类和旧类，虽然包名和类名都完全一样，但是由于加载的 ClassLoader 不同，所以并不是同一种类型，在实际使用中可能会出现类型不符异常。<br>同一个 Class = 相同的 ClassName + PackageName + ClassLoader<br>以上问题在采用动态加载功能的开发中容易出现，请注意。</p>
<p>通过上面的分析，我们知道使用ClassLoader动态加载一个外部的类是非常容易的事情，所以很容易就能实现动态加载新的可执行代码的功能，但是比起一般的Java程序，在Android程序中使用动态加载主要有两个麻烦的问题：</p>
<p>Android中许多组件类（如Activity、Service等）是需要在Manifest文件里面注册后才能工作的（系统会检查该组件有没有注册），所以即使动态加载了一个新的组件类进来，没有注册的话还是无法工作；<br>Res资源是Android开发中经常用到的，而Android是把这些资源用对应的R.id注册好，运行时通过这些ID从Resource实例中获取对应的资源。如果是运行时动态加载进来的新类，那类里面用到R.id的地方将会抛出找不到资源或者用错资源的异常，因为新类的资源ID根本和现有的Resource实例中保存的资源ID对不上；<br>说到底，抛开虚拟机的差别不说，一个Android程序和标准的Java程序最大的区别就在于他们的上下文环境（Context）不同。Android中，这个环境可以给程序提供组件需要用到的功能，也可以提供一些主题、Res等资源，其实上面说到的两个问题都可以统一说是这个环境的问题，而现在的各种Android动态加载框架中，核心要解决的东西也正是“如何给外部的新类提供上下文环境”的问题。</p>
<p>DexClassLoader的使用方法一般有两种：<br>从已安装的apk中读取dex<br>从apk文件中读取dex<br>假如有两个APK，一个是宿主APK，叫作HOST，一个是插件APK，叫作Plugin。Plugin中有一个类叫PluginClass，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginClass</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginClass</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"JG"</span>,<span class="string">"初始化PluginClass"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> a+b;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在如果想调用插件APK中PluginClass内的方法，应该怎么办？</p>
<p>####从已安装的apk中读取dex</p>
<p>先来看第一种方法，这种方法必须建一个Activity，在清单文件中配置Action.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;activity android:name=".MainActivity"&gt;</div><div class="line">         &lt;intent-filter&gt;</div><div class="line">             &lt;action android:name="com.maplejaw.plugin"/&gt;</div><div class="line">         &lt;/intent-filter&gt;</div><div class="line">&lt;/activity&gt;</div></pre></td></tr></table></figure></p>
<p>然后在宿主APK中如下使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * 这种方式用于从已安装的apk中读取，必须要有一个activity，且需要配置ACTION</div><div class="line">   */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useDexClassLoader</span><span class="params">()</span></span>&#123;</div><div class="line">      <span class="comment">//创建一个意图，用来找到指定的apk</span></div><div class="line">      Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.maplejaw.plugin"</span>);</div><div class="line">      <span class="comment">//获得包管理器</span></div><div class="line">      PackageManager pm = getPackageManager();</div><div class="line">      List&lt;ResolveInfo&gt; resolveinfoes =  pm.queryIntentActivities(intent, <span class="number">0</span>);</div><div class="line">      <span class="keyword">if</span>(resolveinfoes.size()==<span class="number">0</span>)&#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//获得指定的activity的信息</span></div><div class="line">      ActivityInfo actInfo = resolveinfoes.get(<span class="number">0</span>).activityInfo;</div><div class="line"></div><div class="line">      <span class="comment">//获得包名</span></div><div class="line">      String packageName = actInfo.packageName;</div><div class="line">      <span class="comment">//获得apk的目录或者jar的目录</span></div><div class="line">      String apkPath = actInfo.applicationInfo.sourceDir;</div><div class="line">      <span class="comment">//dex解压后的目录,注意，这个用宿主程序的目录，android中只允许程序读取写自己</span></div><div class="line">      <span class="comment">//目录下的文件</span></div><div class="line">      String dexOutputDir = getApplicationInfo().dataDir;</div><div class="line"></div><div class="line">      <span class="comment">//native代码的目录</span></div><div class="line">      String libPath = actInfo.applicationInfo.nativeLibraryDir;</div><div class="line"></div><div class="line">      <span class="comment">//创建类加载器，把dex加载到虚拟机中</span></div><div class="line">      DexClassLoader calssLoader = <span class="keyword">new</span> DexClassLoader(apkPath, dexOutputDir, libPath,</div><div class="line">              <span class="keyword">this</span>.getClass().getClassLoader());</div><div class="line"></div><div class="line">      <span class="comment">//利用反射调用插件包内的类的方法</span></div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Class&lt;?&gt; clazz = calssLoader.loadClass(packageName+<span class="string">".PluginClass"</span>);</div><div class="line"></div><div class="line">          Object obj = clazz.newInstance();</div><div class="line">          Class[] param = <span class="keyword">new</span> Class[<span class="number">2</span>];</div><div class="line">          param[<span class="number">0</span>] = Integer.TYPE;</div><div class="line">          param[<span class="number">1</span>] = Integer.TYPE;</div><div class="line"></div><div class="line">          Method method = clazz.getMethod(<span class="string">"function"</span>, param);</div><div class="line"></div><div class="line">          Integer ret = (Integer)method.invoke(obj, <span class="number">12</span>,<span class="number">34</span>);</div><div class="line"></div><div class="line">          Log.d(<span class="string">"JG"</span>, <span class="string">"返回的调用结果为:"</span> + ret);</div><div class="line"></div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">      &#125; </div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>我们安装完两个APK后，在宿主中就可以直接调用，调用示例如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">btnClick</span><span class="params">(View view)</span></span>&#123;</div><div class="line">    useDexClassLoader();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>####从apk文件中读取dex</p>
<p>这种方法由于并不需要安装，所以不需要通过Intent从activity中解析信息。换言之，这种方法不需要创建Activity。无需配置清单文件。我们只需要打包一个apk，然后放到SD卡中即可。<br>核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//apk路径</span></div><div class="line">String path=Environment.getExternalStorageDirectory().getAbsolutePath()+<span class="string">"/1.apk"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useDexClassLoader</span><span class="params">(String path)</span></span>&#123;</div><div class="line">  </div><div class="line">    File codeDir=getDir(<span class="string">"dex"</span>, Context.MODE_PRIVATE);</div><div class="line"></div><div class="line">    <span class="comment">//创建类加载器，把dex加载到虚拟机中</span></div><div class="line">    DexClassLoader calssLoader = <span class="keyword">new</span> DexClassLoader(path, codeDir.getAbsolutePath(), <span class="keyword">null</span>,</div><div class="line">            <span class="keyword">this</span>.getClass().getClassLoader());</div><div class="line"></div><div class="line">    <span class="comment">//利用反射调用插件包内的类的方法</span></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class&lt;?&gt; clazz = calssLoader.loadClass(<span class="string">"com.maplejaw.plugin.PluginClass"</span>);</div><div class="line"></div><div class="line">        Object obj = clazz.newInstance();</div><div class="line">        Class[] param = <span class="keyword">new</span> Class[<span class="number">2</span>];</div><div class="line">        param[<span class="number">0</span>] = Integer.TYPE;</div><div class="line">        param[<span class="number">1</span>] = Integer.TYPE;</div><div class="line"></div><div class="line">        Method method = clazz.getMethod(<span class="string">"function"</span>, param);</div><div class="line"></div><div class="line">        Integer ret = (Integer)method.invoke(obj, <span class="number">12</span>,<span class="number">21</span>);</div><div class="line"></div><div class="line">        Log.d(<span class="string">"JG"</span>, <span class="string">"返回的调用结果为: "</span> + ret);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>动态加载的几个关键问题<br>资源访问：无法找到某某id所对应的资源<br>因为将apk加载到宿主程序中去执行，就无法通过宿主程序的Context去取到apk中的资源,比如图片、文本等，这是很好理解的，因为apk已经不存在上下文了，它执行时所采用的上下文是宿主程序的上下文，用别人的Context是无法得到自己的资源的；<br>解决方案一：插件中的资源在宿主程序中也预置一份；<br>缺点：增加了宿主apk的大小；在这种模式下，每次发布一个插件都需要将资源复制到宿主程序中，这意味着每发布一个插件都要更新一下宿主程序；<br>解决方案二：将插件中的资源解压出来，然后通过文件流去读取资源；<br>缺点：实际操作起来还是有很大难度的。首先不同资源有不同的文件流格式，比如图片、XML等，其次针对不同设备加载的资源可能是不一样的，如何选择合适的资源也是一个需要解决的问题；<br>实际解决方案：<br>Activity中有一个叫mBase的成员变量，它的类型就是ContextImpl。注意到Context中有如下两个抽象方法，看起来是和资源有关的，实际上Context就是通过它们来获取资源的。这两个抽象方法的真正实现在ContextImpl中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Return an AssetManager instance for your application's package. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AssetManager <span class="title">getAssets</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/** Return a Resources instance for your application's package. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Resources <span class="title">getResources</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>具体实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadResources</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AssetManager assetManager = AssetManager.class.newInstance();</div><div class="line">        Method addAssetPath = assetManager.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class);</div><div class="line">        addAssetPath.invoke(assetManager, mDexPath);</div><div class="line">        mAssetManager = assetManager;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    Resources superRes = <span class="keyword">super</span>.getResources();</div><div class="line">    mResources = <span class="keyword">new</span> Resources(mAssetManager, superRes.getDisplayMetrics(),</div><div class="line">            superRes.getConfiguration());</div><div class="line">    mTheme = mResources.newTheme();</div><div class="line">    mTheme.setTo(<span class="keyword">super</span>.getTheme());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>加载资源的方法是通过反射，通过调用AssetManager中的addAssetPath方法，我们可以将一个apk中的资源加载到Resources对象中，由于addAssetPath是隐藏API我们无法直接调用，所以只能通过反射。<br>addAssetPath();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@hide</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">addAssetPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> res = addAssetPathNative(path);</div><div class="line"></div><div class="line">        makeStringBlocks(mStringBlocks);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> res;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Activity生命周期的管理：<br>反射方式和接口方式。<br>反射的方式很好理解，首先通过Java的反射去获取Activity的各种生命周期方法，比如onCreate、onStart、onResume等，然后在代理Activity中去调用插件Activity对应的生命周期方法即可；<br>缺点：一方面是反射代码写起来比较复杂，另一方面是过多使用反射会有一定的性能开销。</p>
<p>反射方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line"></div><div class="line">    Method onResume = mActivityLifecircleMethods.get(<span class="string">"onResume"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (onResume != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            onResume.invoke(mRemoteActivity, <span class="keyword">new</span> Object[] &#123; &#125;);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            e.printStackTrace();</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    Method onPause = mActivityLifecircleMethods.get(<span class="string">"onPause"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (onPause != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            onPause.invoke(mRemoteActivity, <span class="keyword">new</span> Object[] &#123; &#125;);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            e.printStackTrace();</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onPause();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接口方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DLPlugin</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestart</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent</span></span></div><div class="line"></div><div class="line">    data);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProxy</span><span class="params">(Activity proxyActivity, String dexPath)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNewIntent</span><span class="params">(Intent intent)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowAttributesChanged</span><span class="params">(LayoutParams params)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">…</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代理Activity中只需要按如下方式即可调用插件Activity的生命周期方法，这就完成了插件Activity的生命周期的管理;插件Activity需要实现DLPlugin接口；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    mRemoteActivity.onStart();</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onStart();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestart</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    mRemoteActivity.onRestart();</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onRestart();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    mRemoteActivity.onResume();</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://developer.android.com/topic/instant-apps/index.html" target="_blank" rel="external">Google Instant app</a></li>
<li><a href="https://github.com/WeMobileDev/article/blob/master/%E5%BE%AE%E4%BF%A1Android%E7%83%AD%E8%A1%A5%E4%B8%81%E5%AE%9E%E8%B7%B5%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF.md#rd">微信热补丁实现</a></li>
<li><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">多dex分拆</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=400118620&amp;idx=1&amp;sn=b4fdd5055731290eef12ad0d17f39d4a" target="_blank" rel="external">QQ空间热修复方案</a></li>
<li><a href="http://my.oschina.net/853294317/blog/308583" target="_blank" rel="external">Android dex分包方案</a></li>
<li><a href="http://www.maplejaw.com/2016/05/24/Android%E6%8F%92%E4%BB%B6%E5%8C%96%E6%8E%A2%E7%B4%A2%EF%BC%88%E4%B8%80%EF%BC%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8DexClassLoader/" target="_blank" rel="external">类加载器DexClassLoader</a></li>
<li><a href="http://blog.csdn.net/xwl198937/article/details/49801975" target="_blank" rel="external">基于cydia Hook在线热修复补丁方案</a></li>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/49883661" target="_blank" rel="external"></a></li>
<li><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="external"></a></li>
<li><a href="http://kymjs.com/column/plugin.html" target="_blank" rel="external"></a></li>
<li><a href="http://weishu.me/" target="_blank" rel="external"></a></li>
<li><a href="http://www.zjutkz.net/2016/05/23/%E5%BD%93%E4%BD%A0%E5%87%86%E5%A4%87%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%A1%86%E6%9E%B6%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84%E4%B8%80%E5%88%87/" target="_blank" rel="external"></a>        </li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/热修复实现/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-视频解码之软解与硬解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/视频解码之软解与硬解/">视频解码之软解与硬解</a>
    </h1>
  

        
        <a href="/2015/01/01/视频解码之软解与硬解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="视频解码之软解与硬解"><a href="#视频解码之软解与硬解" class="headerlink" title="视频解码之软解与硬解"></a>视频解码之软解与硬解</h1><p><strong>硬解</strong>：从字面意思上理解就是用硬件来进行解码，通过显卡的视频加速功能对高清视频进行解码，很明显就是一个专门的电路板(这样好理解…)来进行视频的解码，是依靠显卡<code>GPU</code>的。                    </p>
<p><strong>软解</strong>：字面上理解就是用软件进行解码，这样理解也对，但是实际最总还是要硬件来支持的，这个硬件就是<code>CPU</code>。</p>
<p>既然有这两种不同的解码方式，我们在开发中该如何进行选择？哪个更好？                     </p>
<ul>
<li><p>硬解优缺点：<br>  显卡核心GPU拥有独特的计算方法，解码效率非常高，而且充当解码核心的模块成本并不高。这样不但能够减轻CPU的负担，还有着低功耗、发热少等特点。但是由于硬解码起步比较晚，<br>  软件和驱动对其的支持度低。硬解码内置有什么样的模块就能够解码什么样的视频，面对网络上杂乱无章的视频编码格式，不可能做到完全兼容同。此外，硬解码的滤镜、字母、画质增强方面都做的十分不足。</p>
<p>  优点：低功耗、发热少、效率高。<br>  缺点：视频兼容性差、支持度低。                </p>
</li>
<li><p>软解优缺点：<br>  软解码技术的解码过程中，需要对大量的视频信息进行运算，对CPU性能的要求非常高。尤其是对高清晰度大码率的视频来说，巨大的运算量就会造成转换效率低、发热量大等问题。<br>  但是由于软解码的过程中不需要复杂的硬件支持，兼容性非常高。即使是新出的视频编码格式，只要安装好相应的解码器文件，就能顺利播放。而且软解码拥有丰富的滤镜、字幕、画面处理优化等效果，<br>  如果<code>CPU</code>足够强悍的话，能够实现更加出色的画面效果。</p>
<p>  优点：  兼容强、全解码、效果好<br>  缺点：  对<code>CPU</code>要求高、效率低、发热大                 </p>
</li>
</ul>
<p>关于软解与硬解究竟哪个更好的问题一直是争论的热点，其实我倒是感觉没有好坏之分，各自有各自的优缺点和使用条件，根据需要去选择才是最合适的。<br>播放码率比较大的视频，硬解可能流畅的播放，但是软解可能会出现演示、画面和声音卡顿不同步的问题。但是硬解播放出的视频大多都不允许在解码之后进行软件后处理，比如进行一些降噪锐化之类的后期滤镜，<br>这样可能会让人感觉画质不太好的。当然上面的这种情况也是和<code>CPU</code>及<code>GPU</code>能力的不同而不同的。 总的来说，还是各有春秋，适合你的才是最好的。 </p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/视频解码之软解与硬解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-发布library到Maven仓库" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/发布library到Maven仓库/">发布library到Maven仓库</a>
    </h1>
  

        
        <a href="/2015/01/01/发布library到Maven仓库/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="发布library到Maven仓库"><a href="#发布library到Maven仓库" class="headerlink" title="发布library到Maven仓库"></a>发布library到Maven仓库</h2><p>在<code>Android Studio</code>中想要使用一些第三方类库的时候非常方便，只需要在<code>build.gradle</code>中加入一行代码就可以了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.google.code.gson:gson:2.3.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>刚从<code>Eclipse</code>转过来的时候感觉太方便了，也不用下<code>jar</code>包然后拷贝到<code>libs</code>目录了，重要的是以后升级起来灰常方便，改个数字就好了。<br>那究竟它里面是怎么运转的呢？其实<code>Android Studio</code>是从<code>Maven</code>仓库中下载所配置的<code>libraray</code>。<br>总的来说，<code>Android</code>只有两种存放<code>library</code>的服务器就是<code>jCenter</code>和<code>Maven Central</code>:</p>
<ul>
<li><p><code>jCenter</code><br>  <code>jCenter</code>是由<a href="https://bintray.com/" target="_blank" rel="external">bintray</a>维护的<code>Maven</code>仓库。你可以在<a href="http://jcenter.bintray.com/" target="_blank" rel="external">这里</a>查看它所有的<code>library</code>。<br>  想要在项目中使用<code>jCenter</code>必须要在项目的<code>build.gradle</code>中像如下这样进行声明：    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   allprojects &#123;</div><div class="line">	repositories &#123;</div><div class="line">		jcenter()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>Maven Central</code><br>  <code>Maven Central</code>是由<a href="https://issues.sonatype.org" target="_blank" rel="external">sonatype</a>维护的<code>Maven</code>仓库。想要在项目中使用<code>Maven Central</code>需要在项目的<code>build.gradle</code>文件中像下面这样进行声明:     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">    allprojects &#123;</div><div class="line">        repositories &#123;</div><div class="line">            mavenCentral()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ```	</div><div class="line">	虽然`jCenter`和`Maven Central`都是`Android`标准的`library maven`仓库，但是他俩是由不同提供者维护，并且存放到完全不同的服务器上，所以他俩之间毫无关系。     </div><div class="line">	除了这两个标准的服务器外，如果我们使用的`library`作者把该`library`放到自己的服务器上，我们还可以自己定义特有的`Maven`仓库服务器。例如`Twitter`的`Fabric.io`就是这种情况，它们在[https:<span class="comment">//maven.fabric.io/public](https://maven.fabric.io/public)上维护了一个自己的`Maven`仓库，如果你想使用`Fabric.io`上的`library`你必须要自己定义仓库的`url`:       </span></div><div class="line">	```java</div><div class="line">	repositories &#123;</div><div class="line">		maven &#123; url <span class="string">'https://maven.fabric.io/public'</span> &#125;</div><div class="line">	&#125;</div><div class="line">	然后才能正常使用</div><div class="line">	dependencies &#123;</div><div class="line">		compile <span class="string">'com.crashlytics.sdk.android:crashlytics:2.2.4@aar'</span></div><div class="line">	&#125;</div><div class="line">	```	</div><div class="line"></div><div class="line">	上传到自建服务器需要定义仓库的`url`，所以会比上传到标准的`maven`仓库使用起来要更麻烦。</div><div class="line"></div><div class="line">	至于上传到`jCenter`还是`Maven Central`上面就要看开发者个人的爱好了，当然在这两个上面都上传是最方便的。在`Android Studio`开始的几个版本中，它将`Maven central` 作为默认仓库。新建项目之后`build.gradle`中会自动生成`Maven central`仓库的配置。</div><div class="line">	但是`Maven Central`最大的问题就是上传`library`非常困难，同时还会由安全方面的原因，所以后来`Android Studio`将默认仓库替换成`jCenter`。所以最近的几个版本中创建项目之后,`build.gradle`中会默认定义`jCenter`而不是`Maven Central`。     </div><div class="line"></div><div class="line">`jCenter`相对`Maven Central`来说更好的几个主要原因:    </div><div class="line"></div><div class="line">- `jCenter`通过`CDN`发送`library`，开发者会由更快的下载体验。</div><div class="line">- `jCenter`作为世界最大的`Java`仓库，所以它上面的`library`会更多。</div><div class="line">- `jCenter`上传`library`更简单，不需要像在`Maven Central`上那么复杂。</div><div class="line">- `jCenter`的用户界面更友好。</div><div class="line">- `jCenter`的`bintray`网站上可以通过一键实现将`library`上传到`Maven Central`上。</div><div class="line"></div><div class="line">所以我们后面要讲的就是如何上传`library`到`bintray`的`jCenter`中然后再一键上传到`Maven Central`上。    </div><div class="line"></div><div class="line">说之前先通过`picasso`为例认识一下几个主要的部分:      </div><div class="line">我们在使用`picasso`时，它会告诉我们按照如下使用： </div><div class="line">```java</div><div class="line">compile <span class="string">'com.squareup.picasso:picasso:2.5.2'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>或者<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">  &lt;groupId&gt;com.squareup.picasso&lt;/groupId&gt;</div><div class="line">  &lt;artifactId&gt;picasso&lt;/artifactId&gt;</div><div class="line">  &lt;version&gt;2.5.2&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>这两种方法分别对应了<code>jCenter</code>和<code>Maven Central</code>中的使用方法.<code>jCenter</code>中<code>com.squareup.picasso</code>就是<code>grounId</code>，通常我们以开发者的报名后面紧跟<code>library</code>的名字来命名<code>groupId</code>, <code>picasso</code>是<code>artifactId</code>,<code>artifactId</code>也就是<code>library</code>真实的名称。,后面的<code>2.5.2</code>就是当前的<code>version</code>.</p>
<p>看到这里应该清楚其实就是<code>Android Studio</code>从<code>Maven</code>服务器上去下载我们所配置的<code>library</code>然后与我们项目一起进行编译。从<code>Maven</code>仓库上下载的是该<code>library</code>的<code>jar</code>或者<code>aar</code>文件。</p>
<p>仓库中存储的有两种文件类型的<code>library</code>：<code>jar</code>和<code>aar</code>。<code>jar</code>包大家都知道。那什么是<code>aar</code>呢？<code>aar</code>是在<code>jar</code>的基础上进行开发的，这是因为<code>Androd Library</code>需要植入一些特有的文件，例如资源文件、<code>assets</code>、<code>jni</code>、清单文件等。而这些都不是<code>jar</code>的标准，因为<code>aar</code>就是在<code>jar</code>包的基础上新增了对其他文件的封装。当然他和<code>jar</code>包一样，在本质上都是<code>zip</code>包，下面我们看一下<code>aar</code>的目录结构:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- /AndroidManifest.xml</div><div class="line">- /classes.jar</div><div class="line">- /res/</div><div class="line">- /R.txt</div><div class="line">- /assets/</div><div class="line">- /libs<span class="comment">/*.jar</span></div><div class="line">- /jni/&lt;abi&gt;/*.so</div><div class="line">- /proguard.txt</div><div class="line">- /lint.jar</div></pre></td></tr></table></figure></p>
<p>讲到这里已经清楚了<code>groupId</code>、<code>artifactId</code>以及<code>aar</code>了，那接下来我们就讲一下具体的发布流程了:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/public_jcenter.png?raw=true" alt="image">   </p>
<h2 id="在Bintray上创建一个包"><a href="#在Bintray上创建一个包" class="headerlink" title="在Bintray上创建一个包"></a>在Bintray上创建一个包</h2><ul>
<li>登陆<a href="https://bintray.com/" target="_blank" rel="external">bintray</a>。</li>
<li>选择<code>Maven</code>后进入。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/bintray.png?raw=true" alt="image"></li>
<li>添加新包。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/and_new_package.png?raw=true" alt="image"></li>
<li><p>填写包信息<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/add_package_information.png?raw=true" alt="image"></p>
<p>  包名这里对于单词之间要用<code>-</code>分割。</p>
</li>
<li>然后会提示已经上传。<br>到这里我们已经在<code>bintray</code>上创建了一个<code>Maven</code>仓库，接下来要做的就是上传<code>library</code>。</li>
</ul>
<h2 id="在Sonatype上传件一个Maven-Central账户。"><a href="#在Sonatype上传件一个Maven-Central账户。" class="headerlink" title="在Sonatype上传件一个Maven Central账户。"></a>在Sonatype上传件一个<code>Maven Central</code>账户。</h2><ul>
<li>注册Sonatype账号<br>  在<a href="https://issues.sonatype.org/secure/Dashboard.jspa" target="_blank" rel="external">Sonatype</a>上注册账号。<br>  注册完登陆后需要在<code>JIRA</code>中创建一个<code>issue</code>，这样他就会允许你上传匹配<code>Maven Central</code>提供的<code>GROUP_ID</code>的<code>library</code>。    <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/create_issue.png?raw=true" alt="image"><br>  Project: Community Support - Open Source Project Repository Hosting<br>  Issue Type: New Project<br>  Summary: 你的 library名称的概要，比如The Cheese Library。<br>  Group Id: 输入根GROUP_ID，比如， com.charonchui。一旦批准之后，每个以com.charon开始的library都允许被上传到仓库，比如com.charonchui.xxx。<br>  Project URL: 输入任意一个你想贡献的library的URL，比如， <a href="https://github.com/CharonChui/CyberLink4Android">https://github.com/CharonChui/CyberLink4Android</a>。<br>  SCM URL: 版本控制的URL，比如 <a href="https://github.com/CharonChui/CyberLink4Android.git">https://github.com/CharonChui/CyberLink4Android.git</a>。<br>  其他的都不用管，写完之后创建就可以了。 然后就是开始等，大约一周左右就会获准将自己的<code>library</code>分享到<code>Maven Central</code>。</li>
<li><p>下面就是<code>Bintray</code>中的账户选项中填写<code>Sonatype</code>用户名。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/add_account.png?raw=true" alt="image"></p>
</li>
<li><p>开启自动注册功能，为了能让我们通过<code>jcenter</code>上传的<code>libraray</code>自动发布到<code>Maven Central</code>中  </p>
<ul>
<li><p>使用下面的命令生成一个key。如果是windows用户需要使用cygwin。否则不能执行<br>  <code>gpg --gen-key</code><br>   后面会一步步的进行提示，按照提示输入相应内容就好。</p>
<p>   创建完成后可以使用<code>gpg --list-keys</code>命令来查看创建key的信息.<br>   接下来需要将生成的key上传到keyserver上才能发挥作用。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/list_key.png?raw=true" alt="image"></p>
<p>  如上图所示将<code>key</code>上传到<code>keyserver</code>让它发挥作用，运行如下命令，将下面的PUBLIC_KEY_ID替换成上面2048R/后面的数字，如我的是B861C367<br>  <code>gpg --keyserver hkp://pool.sks-keyservers.net --send-keys PUBLIC_KEY_ID</code></p>
</li>
<li><p>运行以下命令        </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gpg -a --export yourmail<span class="meta">@email</span>.com &gt; public_key_sender.asc</div><div class="line">   gpg -a --export-secret-key yourmail<span class="meta">@email</span>.com &gt; private_key_sender.asc</div></pre></td></tr></table></figure>
<p>运行完上面的两个命令后，会在当前目录分别生成public_key_sender.asc以及private_key_sender.ask两个文件，下面我们就打开这两个文件的内容，填写到Bintray的<code>Edit Profile</code>页面中的<code>GPG</code>注册部分。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/GPG.png?raw=true" alt="image"></p>
</li>
<li>开启自动注册。<br>  在<code>Edit Your Profile</code>页面找到<code>Repositories</code>后，选择<code>maven</code>后的<code>edit</code>。然后将GPG sign uploaded files using Bintray’s public/private key pair.打上勾就可以了。<br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/maven_edit.png?raw=true" alt="image"><br>  <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/maven_gpg.png?raw=true" alt="image"></li>
</ul>
</li>
</ul>
<h2 id="接下来就是如何将Android-Studio中的Library-Module进行上传"><a href="#接下来就是如何将Android-Studio中的Library-Module进行上传" class="headerlink" title="接下来就是如何将Android Studio中的Library Module进行上传"></a>接下来就是如何将<code>Android Studio</code>中的<code>Library Module</code>进行上传</h2><p>首先是修改项目的<code>build.gradle</code>文件。如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        <span class="comment">// 注意gradle版本要再1.1.2以上，之前的版本存在问题。如果在工程中/gradle/wrapper/gradle-wrapper.properties重看到当前的gradle版本为2.4，下面的配置版本就要改为1.3.0</span></div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:1.2.3'</span></div><div class="line">        <span class="comment">// 下面的部分就为新添加的。</span></div><div class="line">        <span class="comment">// 用于上传项目到bintray</span></div><div class="line">        classpath <span class="string">'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.2'</span></div><div class="line">        <span class="comment">// 用于生成javaDoc和jar，如果gradle版本为2.4及以上，下面的版本就要改为1.3，具体可参考https://github.com/dcendents/android-maven-gradle-plugin</span></div><div class="line">        classpath <span class="string">'com.github.dcendents:android-maven-plugin:1.2'</span></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></div><div class="line">        <span class="comment">// in the individual module build.gradle files</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改<code>local.properties</code>文件，在里面配置<code>apikey</code>、用户名以及密码，以便<code>bintray</code>进行验证。之所以要把这些东西配置到该文件中是因为这些信息都比较敏感，不能分享到别处，包括版本控制里面。而在创建项目的时候<code>local.properties</code>已经被添加到<code>.gitignore</code>中了，所以这些数据不会被上传：<br>需要添加如下三行代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bintray.user=YOUR_BINTRAY_USERNAME  <span class="comment">// 这里一定要用小写，不要用CharonChui不然会报错的，因为他会根据该用户名去找指定package，如果是大写他就找不到了。</span></div><div class="line">bintray.apikey=YOUR_BINTRAY_API_KEY</div><div class="line">bintray.gpg.password=YOUR_GPG_PASSWORD</div></pre></td></tr></table></figure></p>
<p><code>Api key</code>可以在<code>Binatry</code>官网上面的<code>Edit Profile</code>页面下的<code>API Key</code>中获取。<br>最后要做的就是修改<code>library module</code>中的<code>build.gradle</code>文件。<br>下面这是最初的状态：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.library'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">22</span></div><div class="line">    buildToolsVersion <span class="string">"22.0.1"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">8</span></div><div class="line">        targetSdkVersion <span class="number">22</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面就是修改之后的文件:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.library'</span></div><div class="line">apply plugin: <span class="string">'com.github.dcendents.android-maven'</span></div><div class="line">apply plugin: <span class="string">"com.jfrog.bintray"</span></div><div class="line"></div><div class="line"><span class="comment">// This is the library version used when deploying the artifact</span></div><div class="line">version = <span class="string">"1.0.0"</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">22</span></div><div class="line">    buildToolsVersion <span class="string">"22.0.1"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">8</span></div><div class="line">        targetSdkVersion <span class="number">22</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">def siteUrl = <span class="string">'https://github.com/CharonChui/CyberLink4Android'</span>      <span class="comment">// Homepage URL of the library</span></div><div class="line">def gitUrl = <span class="string">'https://github.com/CharonChui/CyberLink4Android.git'</span>   <span class="comment">// Git repository URL</span></div><div class="line">group = <span class="string">"com.charonchui.cyberlink"</span>                      <span class="comment">// Maven Group ID for the artifact</span></div><div class="line"></div><div class="line">install &#123;</div><div class="line">    repositories.mavenInstaller &#123;</div><div class="line">        <span class="comment">// This generates POM.xml with proper parameters</span></div><div class="line">        pom &#123;</div><div class="line">            project &#123;</div><div class="line">                packaging <span class="string">'aar'</span></div><div class="line"></div><div class="line">                <span class="comment">// Add your description here</span></div><div class="line">                name <span class="string">'cyberlink-android'</span></div><div class="line">                description = <span class="string">'CyberLink for Android is a development package for UPnP™ developers on Android development.'</span></div><div class="line">                url siteUrl</div><div class="line"></div><div class="line">                <span class="comment">// Set your license</span></div><div class="line">                licenses &#123;</div><div class="line">                    license &#123;</div><div class="line">                        name <span class="string">'The Apache Software License, Version 2.0'</span></div><div class="line">                        url <span class="string">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                developers &#123;</div><div class="line">                    developer &#123;</div><div class="line">                        id <span class="string">'CharonChui'</span></div><div class="line">                        name <span class="string">'Charon Chui'</span></div><div class="line">                        email <span class="string">'charon.chui@gmail.com'</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                scm &#123;</div><div class="line">                    connection gitUrl</div><div class="line">                    developerConnection gitUrl</div><div class="line">                    url siteUrl</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">sourcesJar</span><span class="params">(type: Jar)</span> </span>&#123;</div><div class="line">    from android.sourceSets.main.java.srcDirs</div><div class="line">    classifier = <span class="string">'sources'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">javadoc</span><span class="params">(type: Javadoc)</span> </span>&#123;</div><div class="line">    source = android.sourceSets.main.java.srcDirs</div><div class="line">    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">javadocJar</span><span class="params">(type: Jar, dependsOn: javadoc)</span> </span>&#123;</div><div class="line">    classifier = <span class="string">'javadoc'</span></div><div class="line">    from javadoc.destinationDir</div><div class="line">&#125;</div><div class="line">artifacts &#123;</div><div class="line">    archives javadocJar</div><div class="line">    archives sourcesJar</div><div class="line">&#125;</div><div class="line"></div><div class="line">Properties properties = <span class="keyword">new</span> Properties()</div><div class="line">properties.load(project.rootProject.file(<span class="string">'local.properties'</span>).newDataInputStream())</div><div class="line"></div><div class="line"><span class="comment">// https://github.com/bintray/gradle-bintray-plugin</span></div><div class="line">bintray &#123;</div><div class="line">    user = properties.getProperty(<span class="string">"bintray.user"</span>)</div><div class="line">    key = properties.getProperty(<span class="string">"bintray.apikey"</span>)</div><div class="line"></div><div class="line">    configurations = [<span class="string">'archives'</span>]</div><div class="line">    pkg &#123;</div><div class="line">        repo = <span class="string">"maven"</span></div><div class="line">        <span class="comment">// it is the name that appears in bintray when logged</span></div><div class="line">        name = <span class="string">"cyberlink-android"</span></div><div class="line">        websiteUrl = siteUrl</div><div class="line">        vcsUrl = gitUrl</div><div class="line">        licenses = [<span class="string">"Apache-2.0"</span>]</div><div class="line">        publish = <span class="keyword">true</span></div><div class="line">        version &#123;</div><div class="line">            gpg &#123;</div><div class="line">                sign = <span class="keyword">true</span> <span class="comment">//Determines whether to GPG sign the files. The default is false</span></div><div class="line">                passphrase = properties.getProperty(<span class="string">"bintray.gpg.password"</span>) <span class="comment">//Optional. The passphrase for GPG signing'</span></div><div class="line">            &#125;</div><div class="line"><span class="comment">//            mavenCentralSync &#123;</span></div><div class="line"><span class="comment">//                sync = true //Optional (true by default). Determines whether to sync the version to Maven Central.</span></div><div class="line"><span class="comment">//                user = properties.getProperty("bintray.oss.user") //OSS user token</span></div><div class="line"><span class="comment">//                password = properties.getProperty("bintray.oss.password") //OSS user password</span></div><div class="line"><span class="comment">//                close = '1' //Optional property. By default the staging repository is closed and artifacts are released to Maven Central. You can optionally turn this behaviour off (by puting 0 as value) and release the version manually.</span></div><div class="line"><span class="comment">//            &#125;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这一步就可以开始上传到<code>bintray</code>了，接下来开启<code>Android Studio</code>的<code>Terminal</code>中。</p>
<ul>
<li>检查代码的正确性，以及编译<code>library</code>文件(<code>aar</code>,<code>pom</code>等)。执行如下命令:<br>  <code>./gradlew install</code>如果提示权限不足就用<code>chmod 777 gradlew</code>改下权限就好了，windows下直接运行<code>gradlew install</code><br>  正确的话会提示<code>BUILD SUCCESSFUL</code></li>
<li>上传编译的文件到<code>bintray</code>，使用如下命令:<br>  <code>./gradlew bintrayUpload</code><br>  成功的话会提示<code>SUCCESSFUL</code><br>接下来到<code>bintray</code>上检查一下你得<code>package</code>你会在版本区域发现新上传的版本。点击进去就能发现我们上传的<code>library</code>文件。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/publish_version.png?raw=true" alt="image"></li>
</ul>
<p>点击该版本进入后可以看到所有的文件目录。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/version_list.png?raw=true" alt="image"></p>
<p>到这里你的<code>library</code>就已经上传了，任何人都可以使用，但是别高兴的太早，因为现在只是上传到了你自己的私人<code>Maven</code>仓库，而不是<code>jCenter</code>上，如果别人使用你<code>library</code>，他必须要先定义仓库的<code>url</code>， 如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">repositories &#123;</div><div class="line">    maven &#123;</div><div class="line">        url <span class="string">'https://dl.bintray.com/charonchui/maven/'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">...</div><div class="line">  </div><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.charonchui.cyberlink:cyberlink-android:1.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样终究是不方便的，因为别人还要单独的去配置你仓库的<code>url</code>那么接下来就是怎么将<code>bintray</code>上我们的仓库上传到<code>jCenter</code>中呢？<br>把<code>library</code>同步到<code>jCenter</code>上非常容易。只需要访问<code>bintray</code>，然后点击<code>Add to jCeter</code>然后在新出来的页面直接点击<code>Send</code>即可。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/add_to_jcenter.png?raw=true" alt="image"><br>现在我们就需要等待<code>bintray</code>团队审核我们的请求，一般会在两三个小时左右，如果审核通过，会收到一封邮件通知。通过这一步之后任何开发者都可以不用配置仓库<code>url</code>直接使用了。<br>想检查一下自己的<code>library</code>是否在<code>jCenter</code>上存在，可以直接访问<a href="http://jcenter.bintray.com" target="_blank" rel="external">http://jcenter.bintray.com</a>,然后根据你的<code>groupId</code>直接进入相应的目录查看即可。这里要说一下，这个链接到<code>jCenter</code>是一个只需要做一次的操作，如果以后对你的<code>package</code>做了修改，或者发布新版本等，这些改变会自动同步到<code>jCenter</code>上。同时，如果你要像删除某一个<code>package</code>，但是在<code>jCenter</code>仓库中的<code>library</code>不会被删除。它会一直存在，没法直接删除，因此如果你想要完全删除的时候，最好在移除<code>package</code>之前先在网页上把删除每个版本。<br>如何通过后也可以在<code>bintray</code>上面看到，这里已经不显示<code>Add to jCenter</code>按钮了，他会直接显示出来<code>jCenter</code>.<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/already_add_to_jcenter.png?raw=true" alt="image"></p>
<p>到这里你就可以在项目中直接使用:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.charonchui.cyberlink:cyberlink-android:1.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是，我悲剧了。提示失败了，为什么呢？　<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/library_name_error.png?raw=true" alt="image">　　　　　　　　　　　　　　　　　<br>原因就出来<code>library</code>这个<code>module name</code>这里，因为我这里的<code>module</code>那么是<code>library</code>所以它上传之后的路径就是<code>library</code>而不是<code>cyberlink-android</code>:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/libray_name_error_path.png?raw=true" alt="image">　　<br>所以通过这里能看出来它是使用当前<code>module</code>的名字的。我们只能通过如下方式去使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.charonchui.cyberlink:library:1.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就能正常使用了。 如果有些人感觉这样不好，就想要<code>com.charonchui.cyberlink:cyberlink-android:1.0.0</code>的方式，那就将<code>Android Studio</code>中<code>library</code>的名字修改为<code>cyberlink-android</code>后重新上传发布吧。</p>
<h2 id="最后一步-上传library到Maven-Central"><a href="#最后一步-上传library到Maven-Central" class="headerlink" title="最后一步:上传library到Maven Central      "></a>最后一步:上传library到Maven Central      </h2><p>并不是所有的开发者都使用<code>jCenter</code>。仍然会有一些人在使用<code>Maven Central</code>。因为此我们仍然需要将<code>library</code>上传到<code>Maven Central</code>上。要从<code>jCenter</code>中上传到<code>Maven Central</code>之前需要先完成以下两部分:      </p>
<ul>
<li><code>Bintray</code>上的<code>pacage</code>已经链接到<code>jCenter</code>.</li>
<li><code>Maven Central</code>上的仓库已经认证通过.</li>
</ul>
<p>如果确认已经完成上面的授权后，上传<code>library</code>到<code>Maven Central</code>就非常简单了，只需要在<code>package</code>的详情页面点击<code>Maven Central</code>的链接。<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/publish_to_maven_central.png?raw=true" alt="image"><br>直接进入下一个页面:<br><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/send_to_maven.png?raw=true" alt="image"><br>然后再出来的页面输入<code>Maven Central</code>对应的用户名和密码点击<code>Sync</code>就可以了。上传到<code>Maven Central</code>的<code>library</code>是非常严格的，比如<code>+</code>号是不能在<code>library</code>版本的依赖定义中使用的。<br>完成之后，你可以在 <a href="https://oss.sonatype.org/content/repositories/releases/" target="_blank" rel="external">Maven Central Repository</a>中找到你的<code>library</code>。</p>
<p>总结下在使用过程中遇到的错误: </p>
<ul>
<li><p>Maven gradle插件与gradle版本要对应好，如下，不要不对应。</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// Top-level build file where you can add configuration options common to all sub-projects/modules.</div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath 'com.android.tools.build:gradle:1.3.0'</div><div class="line">        // 用于上传项目到bintray</div><div class="line">        classpath 'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.2'</div><div class="line">        // 用于生成javaDoc和jar</div><div class="line">        classpath 'com.github.dcendents:android-maven-gradle-plugin:1.3'</div><div class="line">        // NOTE: Do not place your application dependencies here; they belong</div><div class="line">        // in the individual module build.gradle files</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>windows</code>下执行<code>gradlew install</code>编译<code>javadoc</code>时会提示<code>GBK</code>编码错误，这时候需要修改编译时的编码，具体放狗搜下，当时我改在<code>mac</code>上用了，就没解决。</p>
</li>
<li>编译生成<code>javadoc</code>时提示很多找不到类，不能使用<code>&lt;br/&gt;</code>等错误，这里建议在写注释的时候一定要规范，不要使用汉字，而且不要使用<code>&lt;br/&gt;</code>，<code>&lt;p&gt;</code>等。</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/发布library到Maven仓库/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-通过Hardware Layer提高动画性能" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/通过Hardware Layer提高动画性能/">通过Hardware Layer提高动画性能</a>
    </h1>
  

        
        <a href="/2015/01/01/通过Hardware Layer提高动画性能/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="通过Hardware-Layer提高动画性能"><a href="#通过Hardware-Layer提高动画性能" class="headerlink" title="通过Hardware Layer提高动画性能"></a>通过Hardware Layer提高动画性能</h1><p>项目中越来越多的动画，越来越多的效果导致了应用性能越来越低。该如何提升。   </p>
<p>###简介 </p>
<p>在<code>View</code>播放动画的过程中每一帧都需要被重绘。如果使用<code>view layers</code>，就不用每帧都去重绘，因为<code>View</code>渲染一旦离开屏幕缓冲区就可以被重用。</p>
<p>而且，<code>hardware layers</code>会在<code>GPU</code>上缓存，这样就会让一些动画过程中的操作变得更快。通过<code>hardware layers</code>可以快速的渲染一些简单的转变(位移、选中、缩放、颜色渐变)。由于很多动画都是这些动作的结合，所以<code>hardware layers</code>可以显著的提高动画性能。</p>
<p>在<code>View</code>当中提供了三种类型的<code>Layer type</code>:    </p>
<ul>
<li><p>LAYER_TYPE_HARDWARE</p>
<blockquote>
<p>Indicates that the view has a hardware layer. A hardware layer is backed by a hardware specific texture (generally Frame Buffer Objects or FBO on OpenGL hardware) and causes the view to be rendered using Android’s hardware rendering pipeline, but only if hardware acceleration is turned on for the view hierarchy. When hardware acceleration is turned off, hardware layers behave exactly as software layers.</p>
<p>A hardware layer is useful to apply a specific color filter and/or blending mode and/or translucency to a view and all its children.</p>
<p>A hardware layer can be used to cache a complex view tree into a texture and reduce the complexity of drawing operations. For instance, when animating a complex view tree with a translation, a hardware layer can be used to render the view tree only once.</p>
<p>A hardware layer can also be used to increase the rendering quality when rotation transformations are applied on a view. It can also be used to prevent potential clipping issues when applying 3D transforms on a view.    </p>
</blockquote>
</li>
</ul>
<ul>
<li><p>LAYER_TYPE_SOFTWARE</p>
<blockquote>
<p>Indicates that the view has a software layer. A software layer is backed by a bitmap and causes the view to be rendered using Android’s software rendering pipeline, even if hardware acceleration is enabled.</p>
<p>Software layers have various usages:</p>
<p>When the application is not using hardware acceleration, a software layer is useful to apply a specific color filter and/or blending mode and/or translucency to a view and all its children.</p>
<p>When the application is using hardware acceleration, a software layer is useful to render drawing primitives not supported by the hardware accelerated pipeline. It can also be used to cache a complex view tree into a texture and reduce the complexity of drawing operations. For instance, when animating a complex view tree with a translation, a software layer can be used to render the view tree only once.</p>
<p>Software layers should be avoided when the affected view tree updates often. Every update will require to re-render the software layer, which can potentially be slow (particularly when hardware acceleration is turned on since the layer will have to be uploaded into a hardware texture after every update.)</p>
</blockquote>
</li>
<li><p>LAYER_TYPE_NONE</p>
<blockquote>
<p>Indicates that the view does not have a layer.<br>  默认值。</p>
</blockquote>
</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>首先使用的前提是在清单文件中开启了硬件加速。否则将无法使用<code>hardware layer</code>。这一点在上面的文档中也有说明。</p>
<p><code>API</code>也是非常简单的，直接使用<code>View.setLayerType()</code>就好。使用时应该只是暂时的设置<code>Hardware Layer</code>，因为它们无法自动释放。<br>基本的使用步骤：    </p>
<ul>
<li>对每个想要在动画过程中进行缓存的<code>view</code>调用<code>View.setLayerType(View.LAYER_TYPE_HARDWARE, null)</code>方法。</li>
<li>执行动画。</li>
<li>在动画执行结束后调用<code>View.setLayerType(View.LAYER_TYPE_NONE, null)</code>方法来进行清除。</li>
</ul>
<p>示例:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mView.setLayerType(View.LAYER_TYPE_HARDWARE, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">animator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;  </div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">    mView.setLayerType(View.LAYER_TYPE_NONE, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">animator.start();</div></pre></td></tr></table></figure></p>
<p>但是如果在<code>4.0.x</code>的版本中使用上面的代码会本亏，必须要把<code>setLayerType</code>放到<code>Runnable</code>中。如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mView.setLayerType(View.LAYER_TYPE_HARDWARE, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">animator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;  </div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">    <span class="comment">//This will work successfully</span></div><div class="line">    post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</div><div class="line">            setLayerType(LAYER_TYPE_NONE, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">animator.start();</div></pre></td></tr></table></figure></p>
<p>如果你基于<code>minSdkVersion 16</code>以上并且使用<code>ViewPropertyAnimator</code>时，你可以使用<code>withLayer()</code>方法替代如上的操作:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mView.animate().translationX(<span class="number">150</span>).withLayer().start();</div></pre></td></tr></table></figure>
<p>或者在<code>api 14</code>以上时使用<code>ViewCompat.animate().withLayer()</code><br>这样做，你的动画就会变得更流畅！</p>
<p>###注意事项  </p>
<p>你应该知道，事情没那么简单。<br><code>Hardware layers</code>有着惊人的提升动画性能的能力。然而，如果滥用，它的危害更大。<strong>不要盲目的使用<code>layers</code></strong></p>
<ul>
<li><p>首先，在有些情况下，<code>hardware layers</code>除了<code>view</code>渲染外还会执行更多的工作。缓存<code>layer</code>将会需要时间，因为首选第一步就需要两个过程: 先将这些<code>view</code>渲染到<code>GPU</code>的一个<code>layer</code>中然后<code>GPU</code>再渲染该<code>layer</code>到<code>Window</code>上。如果要渲染的<code>View</code>非常简单(例如一个纯色值),那么这样在初始化的时候就会增加<code>Hardware Layer</code>不必要的开销。</p>
</li>
<li><p>其次，对所有的缓存来讲，都有一个缓存失效的可能性。任何时候如果在动画过程中调用<code>view.invalidate()</code>，那么<code>layer</code>就必须要重新渲染。经常的废弃<code>hardware layers</code>会比没有<code>layers</code>的情况下更糟糕，因为如同上面讲到的<code>hardware layers</code>在设置缓存时会有额外的开销。如果你需要经常的重新缓存<code>layer</code>，那就会有极大的损害。    </p>
<p>  这个问题也是非常容易出现的，因为动画经常有多个移动的部分。假如现在有一个三个部分移动的动画:     </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Parent ViewGroup</div><div class="line">—-&gt; <span class="function">Child <span class="title">View1</span> <span class="params">(往左移动)</span></span></div><div class="line">—-&gt; Child <span class="title">View2</span> <span class="params">(往右移动)</span></div><div class="line">—-&gt; Child <span class="title">View3</span> <span class="params">(往上移动)</span></div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>如果你只在父布局`ViewGroup`上设置一个`layer`，那就将经常的缓存失效，因为`ViewGroup`会随着子`View`不断地改变。然而对每个单独的子`Views`而言，他们只是在位移。这种情况下，最好是对每个子`View上`设置`Hardware Layer`（而不是在父布局上）。

***再次重申，通常是对多个子`View上`适当的设置`Hardware Layer`，这样他们就不会在动画运行时失效。***

在手机开发者选项中的*显示硬件层更新（Show hardware layers updates）*功能是追踪这个问题的开发利器。当`View`渲染`Hardware Layer`的时候闪烁绿色，它应该在动画开始的时候闪烁一次（也就是`Layer`渲染初始化的时候），然而，如果你的`View`在整个动画期间都是绿色，那就是遇到失效的问题了。
</code></pre><ul>
<li>最后，<code>hardware layers</code>使用<code>GPU</code>内存，你当然不想出现内存泄漏的问题。所以你应该在必要的时候再去使用<code>hardware layers</code>，就想播放动画时。  </li>
</ul>
<p>这里也没有硬性规则。<code>Android</code>渲染系统是非常复杂的。就像所有性能问题一样，测试才是关键。通过使用“显示硬件层更新”开发者选项来确定<code>layers</code>是在帮你还是害你。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/通过Hardware Layer提高动画性能/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-视频播放相关内容总结" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/视频播放相关内容总结/">视频播放相关内容总结</a>
    </h1>
  

        
        <a href="/2015/01/01/视频播放相关内容总结/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="视频播放相关内容总结"><a href="#视频播放相关内容总结" class="headerlink" title="视频播放相关内容总结"></a>视频播放相关内容总结</h1><h2 id="多媒体常识："><a href="#多媒体常识：" class="headerlink" title="多媒体常识："></a>多媒体常识：</h2><ul>
<li><p>什么是多媒体             </p>
<p>  多媒体是计算机和视频技术的结合，实际上它是两个媒体；声音和图像，或者用现在的术语：音响和电视</p>
</li>
<li><p>常用的视频格式</p>
<p>  Android系统默认：mp4、3gp<br>  常用格式：ts、3gpp、3g2、3gpp2、avi、mkv、flv、divx、f4v、rm、rmvb、rv、wmv、asf、mov、mpg、v8、ram、mpeg、<br>  swf、m2v、asx、ra、ram、ndivx、xvid等     </p>
</li>
<li><p>常用音频格式：</p>
<p>  Android系统：mp3、ogg；<br>  常用格式：wma、mid、m4a、xmf、aac、mpa、midi、ar等</p>
</li>
<li><p>常用图片格式：PNG、GIF、BMP、jpg</p>
</li>
<li><p>国内各个视频网站采用的解码框架：</p>
<ul>
<li>优酷、搜狐、奇艺、pps、暴风影音土豆、56网都是用的ffmpeg.       </li>
<li>pptv已经使用p2p技术<br>  点对点技术（peer-to-peer， 简称P2P）又称对等互联网络技术，是一种网络新技术，依赖网络中参与者的计算能力和带宽，<br>  而不是把依赖都聚集在较少的几台服务器上。P2P网络通常用于通过Ad Hoc连接来连接节点。这类网络可以用于多种用途，<br>  各种档案分享软件已经得到了广泛的使用。P2P技术也被使用在类似VoIP等实时媒体业务的数据通信中。</li>
</ul>
</li>
</ul>
<p>目前常用的开发框架：</p>
<ul>
<li><p>VLC框架：<br>  VLC是一个开源项目，基于ffmpeg框架的自定义播放器。其中LibVLC是VLC的核心部分，就相当于MediaPlayer类<br>  VLC一个最主要的部分，它可以播放各种类型的媒体文件和流媒体文件，并且可以创造媒体流并保存成各种格式的媒体文件<br>  VLC是一种跨平台的媒体播放器和流媒体服务器，最初为videolan的客户端，它是一种非常简便的多媒体播放器，<br>  它可以用来播放各种各样的音视频的格式文件(MPEG-1、MPEG-2、MPEG- 4、DivX、WMV、mp3、OGG、Vorbis、AC3、AAC等等)流媒体协议<br>  最具特色的功能是可以边下载边观看Divx媒体文件，并可以播放不完全的AVI文件。并且支持界面的更改。<br>  缺点：有C/C++代码，还有Java代码，代码太庞大             </p>
</li>
<li><p>ffmpeg框架：<br>  优点：轻量级框架，易于维护<br>  FFmpeg是一个集录制、转换、音/视频编码解码功能为一体的完整的开源解决方案<br>  FFMPEG几乎为你把所有的繁重工作都做了，比如解码、编码、复用和解复用。<br>  这使得多媒体应用程序变得容易编写。它是一个简单的，用C编写的，快速的并且能够解码几乎所有你能用到的格式，当然也包括编码多种格式。<br>  FFmpeg支持MPEG、DivX、MPEG4、AC3、DV、FLV等40多种编码，支持AVI、MPEG、OGG、Matroska、ASF等90多种解码<br>  FFmpeg主目录下主要有libavcodec、libavformat和libavutil等子目录。其中libavcodec用于存放各个encode/decode模块<br>  libavformat用于存放muxer/demuxer模块，libavutil用于存放内存操作等辅助性模块</p>
</li>
<li><p>vitamio框架：<br>  vitamio也是基于ffmpeg开源框架<br>  VPlayer是vitamio的一个产品，vitamio和VPlayer是同一个团队开发的，VPlayer能播放的vitamio也能播放         </p>
</li>
</ul>
<p>##Surface简介</p>
<ul>
<li><code>Surface</code>就是“表面”的意思。在<code>SDK</code>的文档中，对<code>Surface</code>的描述是这样的：“<code>Handle onto a raw buffer that is being managed by the screen compositor</code>”，<br>  翻译成中文就是“由屏幕显示内容合成器<code>(screen compositor)</code>所管理的原生缓冲器的句柄”，    这句话包括下面两个意思：<ul>
<li>通过Surface（因为Surface是句柄）就可以获得原生缓冲器以及其中的内容。就像在C语言中，可以通过一个文件的句柄，就可以获得文件的内容一样；</li>
<li>原生缓冲器（rawbuffer）是用于保存当前窗口的像素数据的。</li>
</ul>
</li>
<li>简单的说<code>Surface</code>对应了一块屏幕缓冲区，每个<code>Window</code>对应一个<code>Surface</code>，任何<code>View</code>都是画在<code>Surface</code>上的，传统的<code>view</code>共享一块屏幕缓冲区，所有的绘制必须在<code>UI</code>线程中进行</li>
<li>我们不能直接操作Surface实例，要通过SurfaceHolder，在SurfaceView中可以通过getHolder()方法获取到SurfaceHolder实例。</li>
<li><code>Surface</code>是一个用来画图形的地方，但是我们知道画图都是在一个<code>Canvas</code>对象上面进行的，<em><code>Surface</code>中的<code>Canvas</code>成员，是专门用于提供画图的地方，就像黑板一样，其中的原始缓冲区是用来保存数据的地方，<br>  <code>Surface</code>本身的作用类似一个句柄，得到了这个句柄就可以得到其中的<code>Canvas</code>、原始缓冲区以及其他方面的内容，所以简单的说<code>Surface</code>是用来管理数据的(句柄)</em>。</li>
</ul>
<p>##SurfaceView简介      </p>
<ul>
<li><p>简单的说<code>SurfaceView</code>就是一个有<code>Surface</code>的<code>View</code>里面内嵌了一个专门用于绘制的<code>Surface</code>,<code>SurfaceView</code>控制这个<code>Surface</code>的格式和尺寸以及绘制位置.<code>SurfaceView</code>是一个<code>View</code>也许不够严谨，<br>  然而从定义中 <code>public class SurfaceView extends View</code>显示<code>SurfaceView</code>确实是派生自<code>View</code>，但是<code>SurfaceView</code>却有着自己的<code>Surface</code>，源码：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">if</span> (mWindow == <span class="keyword">null</span>) &#123;  </div><div class="line">mWindow = <span class="keyword">new</span> MyWindow(<span class="keyword">this</span>);  </div><div class="line">mLayout.type = mWindowType;  </div><div class="line">mLayout.gravity = Gravity.LEFT|Gravity.TOP;  </div><div class="line">mSession.addWithoutInputChannel(mWindow, mWindow.mSeq, mLayout,  </div><div class="line">mVisible ? VISIBLE : GONE, mContentInsets);  </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  很明显，每个<code>SurfaceView</code>创建的时候都会创建一个<code>MyWindow</code>，<code>new MyWindow(this)</code>中的<code>this</code>正是<code>SurfaceView</code>自身，因此将<code>SurfaceView</code>和<code>window</code>绑定在一起，而前面提到过每个<code>window</code>对应一个<code>Surface</code>，<br>  所以<code>SurfaceView</code>也就内嵌了一个自己的<code>Surface</code>，可以认为<code>SurfaceView</code>是来控制<code>Surface</code>的位置和尺寸。传统<code>View</code>及其派生类的更新只能在<code>UI</code>线程，然而<code>UI</code>线程还同时处理其他交互逻辑，<br>  这就无法保证<code>view</code>更新的速度和帧率了，而<code>SurfaceView</code>可以用独立的线程来进行绘制，因此可以提供更高的帧率，例如游戏，摄像头取景等场景就比较适合用<code>SurfaceView</code>来实现。</p>
</li>
<li><p><code>Surface</code>是纵深排序<code>(Z-ordered)</code>的，这表明它总在自己所在窗口的后面。</p>
</li>
<li><code>Surfaceview</code>提供了一个可见区域，只有在这个可见区域内的<code>Surface</code>部分内容才可见，可见区域外的部分不可见，所以可以认为<strong><code>SurfaceView</code>就是展示<code>Surface</code>中数据的地方</strong>,<code>Surface</code>就是管理数据的地方，<br>  <code>SurfaceView</code>就是展示数据的地方，只有通过<code>SurfaceView</code>才能展现<code>Surface</code>中的数据。<br>  <img src="https://github.com/CharonChui/Pictures/master/SurfaceView.png?raw=true" alt="image">   </li>
<li><code>Surface</code>的排版显示受到视图层级关系的影响，它的兄弟视图结点会在顶端显示。这意味者<code>Surface</code>的内容会被它的兄弟视图遮挡，这一特性可以用来放置遮盖物<code>(overlays)</code>(例如，文本和按钮等控件)。<br>  注意，如果<code>Surface</code>上面有透明控件，那么它的每次变化都会引起框架重新计算它和顶层控件的透明效果，这会影响性能。surfaceview变得可见时，surface被创建；surfaceview隐藏前，surface被销毁。<br>  这样能节省资源。如果你要查看 surface被创建和销毁的时机，可以重载surfaceCreated(SurfaceHolder)和 surfaceDestroyed(SurfaceHolder)。<br>  <strong><code>SurfaceView</code>的核心在于提供了两个线程：<code>UI</code>线程和渲染线程</strong>,两个线程通过“双缓冲”机制来达到高效的界面适时更新。</li>
</ul>
<p>##SurfaceHolder简介</p>
<p>显示一个<code>Surface</code>的抽象接口，使你可以控制<code>Surface</code>的大小和格式以及在<code>Surface</code>上编辑像素，和监视<code>Surace</code>的改变。这个接口通常通过<code>SurfaceView</code>类实现。<br>简单的说就是我们无法直接操作<code>Surface</code>只能通过<code>SurfaceHolder</code>这个接口来获取和操作<code>Surface</code>。<br>SurfaceHolder<code>中提供了一些</code>lockCanvas()`：获取一个Canvas对象，并锁定之。所得到的Canvas对象，其实就是Surface中一个成员。加锁的目的其实就是为了在绘制的过程中，<br>Surface中的数据不会被改变。lockCanvas是为了防止同一时刻多个线程对同一canvas写入。</p>
<p><em>从设计模式的角度来看,<code>Surface、SurfaceView、SurfaceHolder</code>实质上就是<code>MVC(Model-View-Controller)</code>，<code>Model</code>就是模型或者说是数据模型，更简单的可以理解成数据，在这里也就是<code>Surface</code>，<br><code>View</code>就是视图，代表用户交互界面，这里就是<code>SurfaceView</code>,<code>SurfaceHolder</code>就是<code>Controller.</code></em></p>
<p>##MediaController</p>
<ul>
<li><code>MediaController</code>继承<code>FrameLayout</code>，通过<code>MediaPlayerControl</code>接口与<code>VideoView</code>进行结合控制，内部是通过<code>PopupWindow</code>将整个控制栏界面显示到界面上，<br>  而该<code>PopupWindow</code>所显示在的位置就是通过<code>setAnchorView()</code>设置进来的<code>Anchor</code>一般可以使当前的<code>VideoView</code>或者是整个<code>Activity</code>的根布局。这里要分为小屏和全屏两种情况来进行设置。<br>  如果当前的<code>MediaController</code>只是播放前下面的控制栏部分(进度条、快进、快退、暂停等)这样我们可以通过对VideoView设置点击事件，控制它的显示和隐藏。<br>  如果<code>MediaController</code>为整个屏幕包括了控制栏部分、上端的信息显示部分、以及左右栏的功能部分、这时候就可以通过对<code>MediaController</code>本身设置点击事件来控制显示和隐藏。         </li>
</ul>
<p><code>Controller</code>可以用<code>PopupWindow</code>来实现,具体有两种方式：     </p>
<pre><code>- 整个控制栏(上面的信息部分、下面的控制部分以及左右边)都在`Controller`中，`setAnchorView()`的时候就会让`Controller`中的`PopupWindow`显示出来(一直显示，但是这个`PopupWindow`是透明的)，
    真正的显示与隐藏是控制在`PopupWindow`中的`View`部分的显示与隐藏来实现。开始的时候我是想用这种方式，当时我想的是播放就播放、控制就控制，分离开来多好，但是没想到，
    一旦有`PopupWindow`显示出来后，Activity是接收不到任何`Touch`事件的，所有的重试界面等都要放到`Controller`中实现(手势处理等)。但是也有好处，就是不管显示还是隐藏都可以去处理手势.

- `PopupWindow`不是全屏的，只包含下面真正的控制部分(快进、快退、暂停等,不包含上面的信息部分和左右边),而且也不是开始就显示，显示隐藏是通过控制`PopupWindow`的显示与隐藏来进行的。
    而对于信息部分、以及左右边都是在`Activity`的布局当中，我们通过接口回调得到`PopupWindow`的显示与隐藏来控制这些布局的显示与隐藏即可。
    这样的话我们就需要将手势等全部放到`Activity`中去处理，但是也有一个问题，就是如果`Controller`正在显示的话`Activity`是接收不到`Touch`事件的，就无法处理手势，只能是让`Controller`消失后才能处理手势。
</code></pre><hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/视频播放相关内容总结/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-自定义View详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/自定义View详解/">自定义View详解</a>
    </h1>
  

        
        <a href="/2015/01/01/自定义View详解/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="自定义View详解"><a href="#自定义View详解" class="headerlink" title="自定义View详解"></a>自定义View详解</h1><p>虽然之前也分析过<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/View%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3.md">View回执过程</a>，但是如果让我自己集成<code>ViewGroup</code>然后自己重新<code>onMeasure,onLayout,onDraw</code>方法自定义<code>View</code>我还是会头疼。今天索性来系统的学习下。</p>
<p>###onMeasure</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * &lt;p&gt;</div><div class="line">     * Measure the view and its content to determine the measured width and the</div><div class="line">     * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line">     * should be overridden by subclasses to provide accurate and efficient</div><div class="line">     * measurement of their contents.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line">     * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line">     * measured width and height of this view. Failure to do so will trigger an</div><div class="line">     * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line">     * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line">     * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * The base class implementation of measure defaults to the background size,</div><div class="line">     * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line">     * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line">     * their content.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * If this method is overridden, it is the subclass's responsibility to make</div><div class="line">     * sure the measured height and width are at least the view's minimum height</div><div class="line">     * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line">     * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line">     *                         The requirements are encoded with</div><div class="line">     *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line">     * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line">     *                         The requirements are encoded with</div><div class="line">     *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line">     * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line">     * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line">     * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line">     * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line">     * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line">     * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line">     */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">                getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>注释说的非常清楚。但是我还是要强调一下这两个参数:<code>widthMeasureSpec</code>和<code>heightMeasureSpec</code>这两个int类型的参数，看名字应该知道是跟宽和高有关系，但它们其实不是宽和高，而是由宽、高和各自方向上对应的模式来合成的一个值：其中，在int类型的32位二进制位中，31-30这两位表示模式，0~29这三十位表示宽和高的实际值.其中模式一共有三种，被定义在Android中的View类的一个内部类中：View.MeasureSpec：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">android.view</div><div class="line">public static class View.MeasureSpec</div><div class="line">extends Object</div><div class="line">A MeasureSpec encapsulates the layout requirements passed from parent to child. Each MeasureSpec represents a requirement for either the width or the height. A MeasureSpec is comprised of a size and a mode. There are three possible modes:</div><div class="line">UNSPECIFIED</div><div class="line">The parent has not imposed any constraint on the child. It can be whatever size it wants.</div><div class="line">EXACTLY</div><div class="line">The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.</div><div class="line">AT_MOST</div><div class="line">The child can be as large as it wants up to the specified size.</div><div class="line">MeasureSpecs are implemented as ints to reduce object allocation. This class is provided to pack and unpack the &lt;size, mode&gt; tuple into the int.</div></pre></td></tr></table></figure>
<ul>
<li>MeasureSpec.UNSPECIFIED The parent has not imposed any constraint on the child. It can be whatever size it wants. 这种情况比较少，一般用不到。标示父控件没有给子View任何显示- - - -对应的二进制表示: 00</li>
<li>MeasureSpec.EXACTLY The parent has determined an exact size for the child. The child is going to be given those bounds regardless of how big it wants to be.<br>理解成MATCH_PARENT或者在布局中指定了宽高值，如layout:width=’50dp’. - - - - 对应的二进制表示:01</li>
<li>MeasureSpec.AT_MOST The child can be as large as it wants up to the specified size.理解成WRAP_CONTENT,这是的值是父View可以允许的最大的值，只要不超过这个值都可以。- - - - 对应的二进制表示:10</li>
</ul>
<p>那具体<code>MeasureSpec</code>是怎么把宽和高的实际值以及模式组合起来变成一个int类型的值呢？ 这部分是在<code>MeasureSpce.makeMeasureSpec()</code>方法中处理的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> mode)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (sUseBrokenMakeMeasureSpec) &#123;</div><div class="line">                <span class="keyword">return</span> size + mode;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>那我们如何从MeasureSpec值中提取模式和大小呢？该方法内部是采用位移计算.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Extracts the mode from the supplied measure specification.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measureSpec the measure specification to extract the mode from</div><div class="line"> * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#UNSPECIFIED&#125;,</div><div class="line"> *         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#AT_MOST&#125; or</div><div class="line"> *         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#EXACTLY&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Extracts the size from the supplied measure specification.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> measureSpec the measure specification to extract the size from</div><div class="line"> * <span class="doctag">@return</span> the size in pixels defined in the supplied measure specification</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (measureSpec &amp; ~MODE_MASK);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###onLayout</p>
<p>为了能合理的去绘制定义<code>View</code>,你需要制定它的大小。复杂的自定义<code>View</code>通常需要根据屏幕的样式和大小来进行复杂的布局计算。你不应该假设你的屏幕上的<code>View</code>的大小。即使只有一个应用使用你的自定义<code>View</code>，也需要处理不同的屏幕尺寸、屏幕密度和横屏以及竖屏下的多种比率等。</p>
<p>虽然<code>View</code>有很多处理测量的方法，但他们中的大部分都不需要被重写。如果你的<code>View</code>不需要特别的控制它的大小，你只需要重写一个方法:<code>onSizeChanged()</code>。</p>
<p><code>onSizeChanged()</code>方法会在你的<code>View</code>第一次指定大小后调用，在因某些原因改变大小后会再次调用。在上面<code>PieChart</code>的例子中，<code>onSizeChanged()</code>方法就是它需要重新计算表格样式和大小以及其他元素的地方。<br>下面就是<code>PieChart.onSizeChanged()</code>方法的内容:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Account for padding</span></div><div class="line"><span class="keyword">float</span> xpad = (<span class="keyword">float</span>)(getPaddingLeft() + getPaddingRight());</div><div class="line"><span class="keyword">float</span> ypad = (<span class="keyword">float</span>)(getPaddingTop() + getPaddingBottom());</div><div class="line"></div><div class="line"><span class="comment">// Account for the label</span></div><div class="line"><span class="keyword">if</span> (mShowText) xpad += mTextWidth;</div><div class="line"></div><div class="line"><span class="keyword">float</span> ww = (<span class="keyword">float</span>)w - xpad;</div><div class="line"><span class="keyword">float</span> hh = (<span class="keyword">float</span>)h - ypad;</div><div class="line"></div><div class="line"><span class="comment">// Figure out how big we can make the pie.</span></div><div class="line"><span class="keyword">float</span> diameter = Math.min(ww, hh);</div></pre></td></tr></table></figure>
<p>###onDraw</p>
<p>自定义<code>View</code>最重要的就是展现样式。</p>
<p>#####重写<code>onDraw()</code>方法</p>
<p>绘制自定义<code>View</code>最重要的步骤就是重写<code>onDraw()</code>方法。<code>onDraw()</code>方法的参数是<code>Canvas</code>对象。可以用它来绘制自身。<code>Canvas</code>类定义了绘制文字、线、位图和很多其他图形的方法。你可以在<code>onDraw()</code>方法中使用这些方法来指定<code>UI</code>.</p>
<p>在使用任何绘制方法之前，你都必须要创建一个<code>Paint</code>对象。  </p>
<p>#####创建绘制的对象</p>
<p><code>android.graphics</code>框架将绘制分为两步:     </p>
<ul>
<li>绘制什么，由<code>Canvas</code>处理。</li>
<li>怎么去绘制，由<code>Paint</code>处理。</li>
</ul>
<p>#####<code>Canvas</code></p>
<blockquote>
<p>The Canvas class holds the “draw” calls. To draw something, you need 4 basic components: A Bitmap to hold the pixels,<br> a Canvas to host the draw calls (writing into the bitmap), a drawing primitive (e.g. Rect, Path, text, Bitmap),<br>and a paint (to describe the colors and styles for the drawing).  </p>
</blockquote>
<ul>
<li><code>Canvas()</code>:创建一个空的画布，可以使用<code>setBitmap()</code>方法来设置绘制的具体画布； </li>
<li><code>Canvas(Bitmap bitmap)</code>:以<code>bitmap</code>对象创建一个画布，则将内容都绘制在<code>bitmap</code>上，<code>bitmap</code>不得为<code>null</code>; </li>
<li><code>canvas.drawRect(RectF,Paint)</code>方法用于画矩形，第一个参数为图形显示区域，第二个参数为画笔，设置好图形显示区域<code>Rect</code>和画笔<code>Paint</code>后，即可画图； </li>
<li><code>canvas.drawRoundRect(RectF, float, float, Paint)</code>方法用于画圆角矩形，第一个参数为图形显示区域，第二个参数和第三个参数分别是水平圆角半径和垂直圆角半径。 </li>
<li><code>canvas.drawLine(startX, startY, stopX, stopY, paint)</code>：前四个参数的类型均为<code>float</code>，最后一个参数类型为<code>Paint</code>。表示用画笔<code>paint</code>从点<code>（startX,startY）</code>到点<code>（stopX,stopY）</code>画一条直线； </li>
<li><code>canvas.drawLines (float[] pts, Paint paint)``pts</code>:是点的集合，大家下面可以看到，这里不是形成连接线，而是每两个点形成一条直线，<code>pts</code>的组织方式为<code>｛x1,y1,x2,y2,x3,y3,……｝</code>，例如<code>float []pts={10,10,100,100,200,200,400,400};</code>就是有四个点：（10，10）、（100，100），（200，200），（400，400）），两两连成一条直线；</li>
<li><code>canvas.drawArc(oval, startAngle, sweepAngle, useCenter, paint)</code>：第一个参数<code>oval</code>为<code>RectF</code>类型，即圆弧显示区域，<code>startAngle</code>和<code>sweepAngle</code>均为<code>float</code>类型，分别表示圆弧起始角度和圆弧度数,3点钟方向为0度，<code>useCenter</code>设置是否显示圆心，<code>boolean</code>类型，<code>paint</code>为画笔； </li>
<li><code>canvas.drawCircle(float,float, float, Paint)</code>方法用于画圆，前两个参数代表圆心坐标，第三个参数为圆半径，第四个参数是画笔； </li>
<li><code>canvas.drawBitmap(Bitmap bitmap, Rect src, Rect dst, Paint paint)</code> 位图，参数一就是我们常规的<code>Bitmap</code>对象，参数二是源区域(这里是<code>bitmap</code>)，参数三是目标区域(应该在<code>canvas</code>的位置和大小)，参数四是<code>Paint</code>画刷对象，因为用到了缩放和拉伸的可能，当原始<code>Rect</code>不等于目标<code>Rect</code>时性能将会有大幅损失。</li>
<li><code>canvas.drawText(String text, float x, floaty, Paint paint)</code>渲染文本，<code>Canvas</code>类除了上<br>面的还可以描绘文字，参数一是<code>String</code>类型的文本，参数二<code>x</code>轴，参数三<code>y</code>轴，参数四是<code>Paint</code>对象。</li>
<li><code>canvas.drawPath (Path path, Paint paint)</code>，根据<code>Path</code>去画.  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Path path = <span class="keyword">new</span> Path();  </div><div class="line">path.moveTo(<span class="number">10</span>, <span class="number">10</span>); <span class="comment">//设定起始点  </span></div><div class="line">path.lineTo(<span class="number">10</span>, <span class="number">100</span>);<span class="comment">//第一条直线的终点，也是第二条直线的起点  </span></div><div class="line">path.lineTo(<span class="number">300</span>, <span class="number">100</span>);<span class="comment">//画第二条直线  </span></div><div class="line">path.lineTo(<span class="number">500</span>, <span class="number">100</span>);<span class="comment">//第三条直线  </span></div><div class="line">path.close();<span class="comment">//闭环  </span></div><div class="line">canvas.drawPath(path, paint);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>#####<code>Paint</code></p>
<ul>
<li><code>setARGB(int a, int r, int g, int b)</code> 设置<code>Paint</code>对象颜色，参数一为<code>alpha</code>透明值</li>
<li><code>setAlpha(int a)</code> 设置<code>alpha</code>不透明度，范围为0~255</li>
<li><code>setAntiAlias(boolean aa)</code>是否抗锯齿</li>
<li><code>setColor(int color)</code>设置颜色</li>
<li><code>setTextScaleX(float scaleX)</code>设置文本缩放倍数，1.0f为原始</li>
<li><code>setTextSize(float textSize)</code>设置字体大小</li>
<li><code>setUnderlineText(String underlineText)</code>设置下划线</li>
</ul>
<p>例如，<code>Canvas</code>提供了一个画一条线的方法，而<code>Paint</code>提供了指定这条线的颜色的方法。<code>Canvas</code>提供了绘制长方形的方法，而<code>Paint</code>提供了是用颜色填充整个长方形还是空着的方法。简单的说，<code>Canvas</code>指定了你想在屏幕上绘制的形状，而<code>Paint</code>指定了你要绘制的形状的颜色、样式、字体和样式等等。   </p>
<p>所以，在你<code>draw</code>任何东西之前，你都需要创建一个或者多个<code>Paint</code>对象。下面的<code>PieChart</code>例子就是在构造函数中调用的<code>init</code>方法:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   mTextPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">   mTextPaint.setColor(mTextColor);</div><div class="line">   <span class="keyword">if</span> (mTextHeight == <span class="number">0</span>) &#123;</div><div class="line">       mTextHeight = mTextPaint.getTextSize();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       mTextPaint.setTextSize(mTextHeight);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   mPiePaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">   mPiePaint.setStyle(Paint.Style.FILL);</div><div class="line">   mPiePaint.setTextSize(mTextHeight);</div><div class="line"></div><div class="line">   mShadowPaint = <span class="keyword">new</span> Paint(<span class="number">0</span>);</div><div class="line">   mShadowPaint.setColor(<span class="number">0xff101010</span>);</div><div class="line">   mShadowPaint.setMaskFilter(<span class="keyword">new</span> BlurMaskFilter(<span class="number">8</span>, BlurMaskFilter.Blur.NORMAL));</div><div class="line"></div><div class="line">   ...</div></pre></td></tr></table></figure>
<p>下面是<code>PieChart</code>完整的<code>onDraw()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">   <span class="keyword">super</span>.onDraw(canvas);</div><div class="line"></div><div class="line">   <span class="comment">// Draw the shadow</span></div><div class="line">   canvas.drawOval(</div><div class="line">           mShadowBounds,</div><div class="line">           mShadowPaint</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// Draw the label text</span></div><div class="line">   canvas.drawText(mData.get(mCurrentItem).mLabel, mTextX, mTextY, mTextPaint);</div><div class="line"></div><div class="line">   <span class="comment">// Draw the pie slices</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mData.size(); ++i) &#123;</div><div class="line">       Item it = mData.get(i);</div><div class="line">       mPiePaint.setShader(it.mShader);</div><div class="line">       canvas.drawArc(mBounds,</div><div class="line">               <span class="number">360</span> - it.mEndAngle,</div><div class="line">               it.mEndAngle - it.mStartAngle,</div><div class="line">               <span class="keyword">true</span>, mPiePaint);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// Draw the pointer</span></div><div class="line">   canvas.drawLine(mTextX, mPointerY, mPointerX, mPointerY, mTextPaint);</div><div class="line">   canvas.drawCircle(mPointerX, mPointerY, mPointerSize, mTextPaint);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面是一张<code>View</code>绘制过程中框架调用的一些标准方法概要图:<br>    <img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/custom_view_methods.png?raw=true" alt="image"></p>
<p>下面来几个例子:    </p>
<p>自定义开关:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToogleView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> Bitmap backgroundBitmap;</div><div class="line">    <span class="keyword">private</span> Bitmap slideButton;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        backgroundBitmap = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_bg);</div><div class="line">        slideButton = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_slide);</div><div class="line">        <span class="keyword">this</span>.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSlideMarginLeft == <span class="number">0</span>) &#123;</div><div class="line">                    mSlideMarginLeft = backgroundBitmap.getWidth() - slideButton.getWidth();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        Paint paint = <span class="keyword">new</span> Paint();</div><div class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        <span class="comment">// 先画背景图</span></div><div class="line">        canvas.drawBitmap(backgroundBitmap, <span class="number">0</span>, <span class="number">0</span>, paint);</div><div class="line">        <span class="comment">// 再画滑块，用mSlideMarginLeft来控制滑块距离左边的距离。</span></div><div class="line">        canvas.drawBitmap(slideButton, mSlideMarginLeft, <span class="number">0</span>, paint);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span> &gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">com.charon.recyclerviewdemo.ToogleView</span></span></div><div class="line">        <span class="attr">android:paddingLeft</span>=<span class="string">"50dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_green_light"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/toogle_1.png?raw=true" alt="image"><br>很明显显示的不对，因为高设置为<code>warp_content</code>了，但是界面显示的确实整个屏幕，而且<code>paddingLeft</code>也没生效，那该怎么做呢？ 当然是重写<code>onMeasure()</code> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToogleView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> Bitmap backgroundBitmap;</div><div class="line">    <span class="keyword">private</span> Bitmap slideButton;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToogleView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        backgroundBitmap = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_bg);</div><div class="line">        slideButton = BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.drawable.toogle_slide);</div><div class="line">        <span class="keyword">this</span>.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSlideMarginLeft == <span class="number">0</span>) &#123;</div><div class="line">                    mSlideMarginLeft = backgroundBitmap.getWidth() - slideButton.getWidth();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mSlideMarginLeft = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> measureWidth = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> measureWidthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> measureHeight = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> measureHeightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> width;</div><div class="line">        <span class="keyword">int</span> height;</div><div class="line">        <span class="keyword">if</span> (MeasureSpec.EXACTLY == measureWidthMode) &#123;</div><div class="line">            width = measureWidth;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            width = backgroundBitmap.getWidth();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (MeasureSpec.EXACTLY == measureHeightMode) &#123;</div><div class="line">            height = measureHeight;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            height = backgroundBitmap.getHeight();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setMeasuredDimension(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        Paint paint = <span class="keyword">new</span> Paint();</div><div class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line">        canvas.drawBitmap(backgroundBitmap, getPaddingLeft(), <span class="number">0</span>, paint);</div><div class="line">        canvas.drawBitmap(slideButton, mSlideMarginLeft + getPaddingLeft(), <span class="number">0</span>, paint);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就可以了。简单的说明一下，就是如果当前的模式是<code>EXACTLY</code>那就把父<code>View</code>传递进来的宽高设置进来，如果是<code>AT_MOST</code>或者<code>UNSPECIFIED</code>的话就使用背景图片的宽高。</p>
<p>最后再来一个自定义<code>ViewGroup</code>的例子:       </p>
<p>之前的引导页面都是通过类似<code>ViewPager</code>这种方法左右滑动，现在想让他上下滑动，该怎么弄呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerticalLayout</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerticalLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerticalLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerticalLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继承<code>ViewGroup</code>必须要重写<code>onLayout</code>方法。其实这也很好理解，因为每个<code>ViewGroup</code>的排列方式不一样，所以让子类来自己实现是最好的。<br>当然畜类重写<code>onLayout</code>之外，也要重写<code>onMeasure</code>。<br>代码如下，滑动手势处理的部分就不贴了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> measureSpec = MeasureSpec.makeMeasureSpec(mScreenHeight</div><div class="line">			* getChildCount(), MeasureSpec.getMode(heightMeasureSpec));</div><div class="line">	<span class="keyword">super</span>.onMeasure(widthMeasureSpec, measureSpec);</div><div class="line">	measureChildren(widthMeasureSpec, heightMeasureSpec);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">       <span class="comment">// 就像猴子捞月一样，让他们一个个的从上往下排就好了</span></div><div class="line">	<span class="keyword">if</span> (changed) &#123;</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getVisibility() != View.GONE) &#123;</div><div class="line">				child.layout(l, i * mScreenHeight, r, (i + <span class="number">1</span>)</div><div class="line">						* mScreenHeight);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面介绍了通过继承<code>View</code>以及<code>ViewGroup</code>的方式来自定义<code>View</code>，平时开发过程中有时不需要继承他俩，我们直接继承功能接近<br>的类进行扩展就好，例如:我想自定义一个<code>Meterial Design</code>样式的<code>EditText</code>。那我们该怎么实现呢？ 当然是继承<code>EditText</code>了，它比<code>EditText</code>多了一条底下的线，那我们给它<code>draw</code>上就可以了。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/meterial_edittext.png?raw=true" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetrailEditText</span> <span class="keyword">extends</span> <span class="title">EditText</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> NinePatchDrawable mDrawable;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MetrailEditText</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MetrailEditText</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        setBackgroundResource(<span class="number">0</span>);</div><div class="line">        mDrawable = (NinePatchDrawable) getResources().getDrawable(R.drawable.edittext_meterial_bg_activated);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(<span class="keyword">final</span> Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        mDrawable.setBounds(-getCompoundPaddingLeft(), <span class="number">0</span>, getWidth() + getCompoundPaddingRight(), getHeight());</div><div class="line">        mDrawable.draw(canvas);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到这里你可能会糊涂，这哪行啊？ 我们的<code>edittext_meterial_bg_activated</code>可不是普通的图，当然是<code>9 patch</code>图了。</p>
<p><img src="https://raw.githubusercontent.com/CharonChui/Pictures/master/meterial_edittext_line.png?raw=true" alt="image"></p>
<p>当然你可以在<code>onDraw()</code>的时候加一个自定义线的颜色<code>mDrawable.setColorFilter(mLineColor, PorterDuff.Mode.SRC_ATOP);</code>等。</p>
<p>参考部分:       </p>
<ul>
<li><a href="http://blog.csdn.net/cyp331203/article/details/40736027" target="_blank" rel="external">http://blog.csdn.net/cyp331203/article/details/40736027</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! I</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/自定义View详解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-ListView源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/01/ListView源码分析/">ListView源码分析</a>
    </h1>
  

        
        <a href="/2015/01/01/ListView源码分析/" class="archive-article-date">
  	<time datetime="2014-12-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-01-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ListView源码分析"><a href="#ListView源码分析" class="headerlink" title="ListView源码分析"></a>ListView源码分析</h1><p>一直都想写一篇文章分析下<code>ListView</code>的实现，总是忙，一直拖到现在，快到年底了，写出来希望能帮助一些面试跳槽的人。<br>当然写这篇文章也是有原因的，当时有同事在面试的时候，被对方要求当场实现一个<code>ListView</code>，同事简单的答了一些实现原理后，很显然对方不满意，经过几轮PK后，就有了不河蟹的结局。<br>不欢而散，哈哈。听说后当时我想着要把<code>ListView</code>源码仔细分析后，我自己也去面试试试，可是拖到了现在也没机会了。</p>
<p><code>GridView</code>与<code>ListView</code>都继承自<code>AbsListView</code>，他俩的实现也比较类似，这里就不说<code>GridView</code>了。只说一下<code>ListView</code>。<br>首先看一下<code>ListView</code>的文档:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Implementation Notes:</div><div class="line"> *</div><div class="line"> * Some terminology:</div><div class="line"> *</div><div class="line"> *     index    - index of the items that are currently visible</div><div class="line"> *     position - index of the items in the cursor</div><div class="line"> */</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A view that shows items in a vertically scrolling list. The items</div><div class="line"> * come from the &#123;<span class="doctag">@link</span> ListAdapter&#125; associated with this view.</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>然后再说一下<code>ListView</code>的继承关系<code>ListView extends AbsListView extends AdapterView&lt;ListAdapter&gt; extends ViewGroup extends View</code>。<br><code>ListView</code>与其他空间不一样，不是拖到界面上就能用，而是要通过设置适配器来添加条目。这就是<code>AdapterView</code>的主要功能。既然通过适配器来操作数据。<br>这里自然想到的就是<code>MVC</code>设计模式。     </p>
<ul>
<li><code>Data</code>     - <code>M</code>                </li>
<li><code>ListView</code> - <code>V</code></li>
<li><code>Adapter</code>  - <code>C</code></li>
</ul>
<p>到这里我们写罗列一下我们将要分析的内容:      </p>
<ul>
<li><code>ListView</code>与<code>Adapter</code>间的调用。</li>
<li><code>ListView</code>上下滑动时操作及缓存。 </li>
</ul>
<p>我们平时使用<code>ListView</code>的时候都是调用<code>setAdapter()</code>方法，所以我们这里就从该方法入手:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Sets the data behind this ListView.</div><div class="line">    *</div><div class="line">    * The adapter passed to this method may be wrapped by a &#123;<span class="doctag">@link</span> WrapperListAdapter&#125;,</div><div class="line">    * depending on the ListView features currently in use. For instance, adding</div><div class="line">    * headers and/or footers will cause the adapter to be wrapped.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> adapter The ListAdapter which is responsible for maintaining the</div><div class="line">    *        data backing this list and for producing a view to represent an</div><div class="line">    *        item in that data set.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@see</span> #getAdapter() </div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(ListAdapter adapter)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mDataSetObserver != <span class="keyword">null</span>) &#123;</div><div class="line">   	    <span class="comment">// 取消之前注册过的Adapter</span></div><div class="line">           mAdapter.unregisterDataSetObserver(mDataSetObserver);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 清空所有的数据</span></div><div class="line">       resetList();	</div><div class="line">       <span class="comment">// The data set used to store unused views that should be reused during the next layout to avoid creating new ones.</span></div><div class="line">       <span class="comment">// 从注释中可以很明显的看出`View`的复用是通过`RecycleBin`类来实现的。它就决定了为什么`ListView`可以显示很多数据缺不会内存溢出。</span></div><div class="line">       mRecycler.clear();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mHeaderViewInfos.size() &gt; <span class="number">0</span>|| mFooterViewInfos.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">// 如果有HeaderView或者FooterView就把Adapter重新封装下,这是什么设计模式？－装饰</span></div><div class="line">		<span class="comment">// mHeaderViewInfos和mFooterViewInfos分别是header view和foooter view装饰类FixedViewInfo的集合。</span></div><div class="line">		<span class="comment">// 会在addHeaderView()和addFooterView()中进行添加。</span></div><div class="line">           mAdapter = <span class="keyword">new</span> HeaderViewListAdapter(mHeaderViewInfos, mFooterViewInfos, adapter);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           mAdapter = adapter;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mOldSelectedPosition = INVALID_POSITION;</div><div class="line">       mOldSelectedRowId = INVALID_ROW_ID;</div><div class="line"></div><div class="line">       <span class="comment">// AbsListView#setAdapter will update choice mode states.</span></div><div class="line">       <span class="keyword">super</span>.setAdapter(adapter);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">           mAreAllItemsSelectable = mAdapter.areAllItemsEnabled();</div><div class="line">           mOldItemCount = mItemCount;</div><div class="line">           mItemCount = mAdapter.getCount();</div><div class="line">           checkFocus();</div><div class="line"></div><div class="line">           mDataSetObserver = <span class="keyword">new</span> AdapterDataSetObserver();</div><div class="line">           mAdapter.registerDataSetObserver(mDataSetObserver); </div><div class="line">           <span class="comment">// 将viewtypecount设置给RecycleBin</span></div><div class="line">           mRecycler.setViewTypeCount(mAdapter.getViewTypeCount());</div><div class="line"></div><div class="line">           <span class="keyword">int</span> position;</div><div class="line">           <span class="comment">// mStackFromBottom Indicates whether the list is stacked from the bottom edge or the top edge.</span></div><div class="line">           <span class="keyword">if</span> (mStackFromBottom) &#123;</div><div class="line">               position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           setSelectedPositionInt(position);</div><div class="line">           setNextSelectedPositionInt(position);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// Nothing selected</span></div><div class="line">               checkSelectionChanged();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           mAreAllItemsSelectable = <span class="keyword">true</span>;</div><div class="line">           checkFocus();</div><div class="line">           <span class="comment">// Nothing selected</span></div><div class="line">           checkSelectionChanged();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">// 请求layout了，这个就很重要了啊...我们稍后看一下。</span></div><div class="line">       requestLayout();</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">    * The list is empty. Clear everything out.</div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">resetList</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// The parent's resetList() will remove all views from the layout so we need to</span></div><div class="line">       <span class="comment">// cleanup the state of our footers and headers</span></div><div class="line">       clearRecycledState(mHeaderViewInfos);</div><div class="line">       clearRecycledState(mFooterViewInfos);</div><div class="line">       <span class="comment">// The list is empty. Clear everything out.</span></div><div class="line">       <span class="keyword">super</span>.resetList();</div><div class="line"></div><div class="line">       mLayoutMode = LAYOUT_NORMAL;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearRecycledState</span><span class="params">(ArrayList&lt;FixedViewInfo&gt; infos)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (infos != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> count = infos.size();</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">               <span class="keyword">final</span> View child = infos.get(i).view;</div><div class="line">               <span class="keyword">final</span> LayoutParams p = (LayoutParams) child.getLayoutParams();</div><div class="line">               <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">			    <span class="comment">// 这里p就是AbsListView.LayoutParams。对于recycledHeaderFooter在注释中是这样说的. </span></div><div class="line">				<span class="comment">/**</span></div><div class="line">				 * When this boolean is set, the view has been added to the AbsListView</div><div class="line">				 * at least once. It is used to know whether headers/footers have already</div><div class="line">				 * been added to the list view and whether they should be treated as</div><div class="line">				 * recycled views or not.</div><div class="line">				 */</div><div class="line">                   p.recycledHeaderFooter = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>setAdapter()</code>方法中会调用<code>requestLayout()</code>方法。而<code>requestLayout()</code>方法会调用<code>onLayout()</code>方法，但是我们在<code>ListView</code>中找不到<code>onLayout()</code>方法。<br>那就去他的父类<code>AbsListView</code>中找。我们接着来看一下<code>AbsListView.onLayout()</code>方法的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Subclasses should NOT override this method but</div><div class="line"> *  &#123;<span class="doctag">@link</span> #layoutChildren()&#125; instead.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">	mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">	<span class="keyword">if</span> (changed) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			getChildAt(i).forceLayout();</div><div class="line">		&#125;</div><div class="line">		mRecycler.markChildrenDirty();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 调用layoutChildren()方法。</span></div><div class="line">	layoutChildren();</div><div class="line">	mInLayout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn't belong in onLayout().</span></div><div class="line">	<span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">		mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>AbsListView.layoutChildren()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Subclasses must override this method to layout their children.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实现是空的,文档说的很明白了，子类必须要去实现该方法，这也是应该的，因为<code>ListView</code>和<code>GridView</code>的展现是不一样的.所以我们看一下<code>ListView.layoutChildren()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// When set to true, calls to requestLayout() will not propagate up the parent hierarchy.</span></div><div class="line">    <span class="comment">// This is used to layout the children during a layout pass.</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">	<span class="keyword">if</span> (blockLayoutRequests) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 开始了，置为true</span></div><div class="line">	mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">super</span>.layoutChildren();</div><div class="line"></div><div class="line">		invalidate();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">			resetList();</div><div class="line">			invokeOnItemScrollListener();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">		<span class="keyword">int</span> delta = <span class="number">0</span>;</div><div class="line"></div><div class="line">		View sel;</div><div class="line">		View oldSel = <span class="keyword">null</span>;</div><div class="line">		View oldFirst = <span class="keyword">null</span>;</div><div class="line">		View newSel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="comment">// Remember stuff we will need down below</span></div><div class="line">		<span class="comment">// mLayoutMode的注释为Controls how the next layout will happen，默认为LAYOUT_NORMAL</span></div><div class="line">		<span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">			index = mNextSelectedPosition - mFirstPosition;</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">				newSel = getChildAt(index);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">		<span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">		<span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="comment">// Remember the previously selected view</span></div><div class="line">			index = mSelectedPosition - mFirstPosition;</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">				oldSel = getChildAt(index);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Remember the previous first child</span></div><div class="line">			oldFirst = getChildAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Caution: newSel might be null</span></div><div class="line">			newSel = getChildAt(index + delta);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// mDataChanged变量标记Adapter中数据是否发生变化</span></div><div class="line">		<span class="keyword">boolean</span> dataChanged = mDataChanged;</div><div class="line">		<span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">			handleDataChanged();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Handle the empty set by removing all views that are visible</span></div><div class="line">		<span class="comment">// and calling it a day</span></div><div class="line">		<span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">			resetList();</div><div class="line">			invokeOnItemScrollListener();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></div><div class="line">					+ <span class="string">"ListView did not receive a notification. Make sure the content of "</span></div><div class="line">					+ <span class="string">"your adapter is not modified from a background thread, but only from "</span></div><div class="line">					+ <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></div><div class="line">					+ <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</div><div class="line">					+ <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">		AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = <span class="keyword">null</span>;</div><div class="line">		View accessibilityFocusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">int</span> accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">		<span class="comment">// Remember which child, if any, had accessibility focus. This must</span></div><div class="line">		<span class="comment">// occur before recycling any views, since that will clear</span></div><div class="line">		<span class="comment">// accessibility focus.</span></div><div class="line">		<span class="keyword">final</span> ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">		<span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">			<span class="keyword">if</span> (focusHost != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">				<span class="keyword">if</span> (focusChild != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">							|| focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">						<span class="comment">// The views won't be changing, so try to maintain</span></div><div class="line">						<span class="comment">// focus on the current host and virtual view.</span></div><div class="line">						accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">						accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">								.getAccessibilityFocusedVirtualView();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">// If all else fails, maintain focus at the same</span></div><div class="line">					<span class="comment">// position.</span></div><div class="line">					accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		View focusLayoutRestoreDirectChild = <span class="keyword">null</span>;</div><div class="line">		View focusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="comment">// Take focus back to us temporarily to avoid the eventual call to</span></div><div class="line">		<span class="comment">// clear focus when removing the focused child below from messing</span></div><div class="line">		<span class="comment">// things up when ViewAncestor assigns focus back to someone else.</span></div><div class="line">		<span class="keyword">final</span> View focusedChild = getFocusedChild();</div><div class="line">		<span class="keyword">if</span> (focusedChild != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> in some cases focusedChild.getParent() == null</span></div><div class="line"></div><div class="line">			<span class="comment">// We can remember the focused view to restore after re-layout</span></div><div class="line">			<span class="comment">// if the data hasn't changed, or if the focused position is a</span></div><div class="line">			<span class="comment">// header or footer.</span></div><div class="line">			<span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)) &#123;</div><div class="line">				focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">				<span class="comment">// Remember the specific view that had focus.</span></div><div class="line">				focusLayoutRestoreView = findFocus();</div><div class="line">				<span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Tell it we are going to mess with it.</span></div><div class="line">					focusLayoutRestoreView.onStartTemporaryDetach();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			requestFocus();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Pull all children into the RecycleBin.</span></div><div class="line">		<span class="comment">// These views will be reused if possible</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line">		<span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</div><div class="line">		<span class="comment">// RecycleBin控制着整个item的复用，等最后我们再仔细分析下RecycleBin类</span></div><div class="line">		<span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">		    <span class="comment">// 如果数据发生变化，就把现在的View都添加到一个废弃的View进行缓存，RecycleBin.addScrapView()方法就是缓存一些废弃的View</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">				recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">		    <span class="comment">// 调用这个方法后就会根据传入的参数来将ListView中的指定元素存储到mActiveViews数组当中。</span></div><div class="line">			recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Clear out old views</span></div><div class="line">		detachAllViewsFromParent();</div><div class="line">		recycleBin.removeSkippedScrap();</div><div class="line">		<span class="comment">// mLayoutMode默认是LAYOUT_NORMAL</span></div><div class="line">		<span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">			<span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</div><div class="line">				sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">			sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">			sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">			adjustViewsUpOrDown();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">			mFirstPosition = <span class="number">0</span>;</div><div class="line">			sel = fillFromTop(childrenTop);</div><div class="line">			adjustViewsUpOrDown();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">			sel = fillSpecific(reconcileSelectedPosition(), mSpecificTop);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">			sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">		    <span class="comment">// 第一次调用layoutChildren方法的时候是还没有layout的，所以这时候childCount是0</span></div><div class="line">			<span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">			    <span class="comment">// mStackFromBottom的注释Indicates whether the list is stacked from the bottom edge or the top edge.</span></div><div class="line">				<span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">				    <span class="comment">// 默认的布局方式是从上往下的。</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">					setSelectedPositionInt(position);</div><div class="line">					<span class="comment">// 调用fillFromTop方法。</span></div><div class="line">					sel = fillFromTop(childrenTop);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">					setSelectedPositionInt(position);</div><div class="line">					sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			    <span class="comment">// 如果已经有条目了就会走到这里</span></div><div class="line">				<span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">					sel = fillSpecific(mSelectedPosition,</div><div class="line">							oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">				    <span class="comment">// 没有选中的条目</span></div><div class="line">					<span class="comment">// TODO 一会先分析上面的fillFromTop部分，把其全部分析完后再回来分析这里。</span></div><div class="line">					sel = fillSpecific(mFirstPosition,</div><div class="line">							oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					sel = fillSpecific(<span class="number">0</span>, childrenTop);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Flush any cached views that did not get reused above</span></div><div class="line">		recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (sel != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// The current selected item should get focus if items are</span></div><div class="line">			<span class="comment">// focusable.</span></div><div class="line">			<span class="keyword">if</span> (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">				<span class="keyword">final</span> <span class="keyword">boolean</span> focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">						focusLayoutRestoreView != <span class="keyword">null</span> &amp;&amp;</div><div class="line">						focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">				<span class="keyword">if</span> (!focusWasTaken) &#123;</div><div class="line">					<span class="comment">// Selected item didn't take focus, but we still want to</span></div><div class="line">					<span class="comment">// make sure something else outside of the selected view</span></div><div class="line">					<span class="comment">// has focus.</span></div><div class="line">					<span class="keyword">final</span> View focused = getFocusedChild();</div><div class="line">					<span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</div><div class="line">						focused.clearFocus();</div><div class="line">					&#125;</div><div class="line">					positionSelector(INVALID_POSITION, sel);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					sel.setSelected(<span class="keyword">false</span>);</div><div class="line">					mSelectorRect.setEmpty();</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				positionSelector(INVALID_POSITION, sel);</div><div class="line">			&#125;</div><div class="line">			mSelectedTop = sel.getTop();</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">					|| mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">			<span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">				<span class="comment">// If the user's finger is down, select the motion position.</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">				<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">					positionSelector(mMotionPosition, child);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">				<span class="comment">// If we had previously positioned the selector somewhere,</span></div><div class="line">				<span class="comment">// put it back there. It might not match up with the data,</span></div><div class="line">				<span class="comment">// but it's transitioning out so it's not a big deal.</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">				<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">					positionSelector(mSelectorPosition, child);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Otherwise, clear selection.</span></div><div class="line">				mSelectedTop = <span class="number">0</span>;</div><div class="line">				mSelectorRect.setEmpty();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Even if there is not selected position, we may need to</span></div><div class="line">			<span class="comment">// restore focus (i.e. something focusable in touch mode).</span></div><div class="line">			<span class="keyword">if</span> (hasFocus() &amp;&amp; focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">				focusLayoutRestoreView.requestFocus();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Attempt to restore accessibility focus, if necessary.</span></div><div class="line">		<span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">			<span class="keyword">if</span> (newAccessibilityFocusedView == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (accessibilityFocusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">						&amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">					<span class="keyword">final</span> AccessibilityNodeProvider provider =</div><div class="line">							accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">					<span class="keyword">if</span> (accessibilityFocusLayoutRestoreNode != <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">								accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">						provider.performAction(virtualViewId,</div><div class="line">								AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, <span class="keyword">null</span>);</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">					<span class="comment">// Bound the position within the visible children.</span></div><div class="line">					<span class="keyword">final</span> <span class="keyword">int</span> position = MathUtils.constrain(</div><div class="line">							accessibilityFocusPosition - mFirstPosition, <span class="number">0</span>,</div><div class="line">							getChildCount() - <span class="number">1</span>);</div><div class="line">					<span class="keyword">final</span> View restoreView = getChildAt(position);</div><div class="line">					<span class="keyword">if</span> (restoreView != <span class="keyword">null</span>) &#123;</div><div class="line">						restoreView.requestAccessibilityFocus();</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Tell focus view we are done mucking with it, if it is still in</span></div><div class="line">		<span class="comment">// our view hierarchy.</span></div><div class="line">		<span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">				&amp;&amp; focusLayoutRestoreView.getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">			focusLayoutRestoreView.onFinishTemporaryDetach();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		mLayoutMode = LAYOUT_NORMAL;</div><div class="line">		mDataChanged = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (mPositionScrollAfterLayout != <span class="keyword">null</span>) &#123;</div><div class="line">			post(mPositionScrollAfterLayout);</div><div class="line">			mPositionScrollAfterLayout = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		mNeedSync = <span class="keyword">false</span>;</div><div class="line">		setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">		updateScrollIndicators();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			checkSelectionChanged();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		invokeOnItemScrollListener();</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">if</span> (!blockLayoutRequests) &#123;</div><div class="line">			mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面看到会调用<code>fillFromTop()</code>方法，我们看一下该方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the list from top to bottom, starting with mFirstPosition</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> nextTop The location where the top of the first item should be</div><div class="line"> *        drawn</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The view that is currently selected</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillFromTop</span><span class="params">(<span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">	mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</div><div class="line">	mFirstPosition = Math.min(mFirstPosition, mItemCount - <span class="number">1</span>);</div><div class="line">	<span class="keyword">if</span> (mFirstPosition &lt; <span class="number">0</span>) &#123;</div><div class="line">		mFirstPosition = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 调用fillDown()方法。</span></div><div class="line">	<span class="keyword">return</span> fillDown(mFirstPosition, nextTop);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下<code>fillDown()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the list from pos down to the end of the list view.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> pos The first position to put in the list</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> nextTop The location where the top of the item associated with pos</div><div class="line"> *        should be drawn</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The view that is currently selected, if it happens to be in the</div><div class="line"> *         range that we draw.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillDown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">	View selectedView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> end = (mBottom - mTop);</div><div class="line">	<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">		end -= mListPadding.bottom;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 用一个循环一直去填充，nextTop与end的比较来判断是否超过当前屏幕了，这就是为什么ListView就算有一万条最开始载入也不卡，因为他只初始化一屏啊。</span></div><div class="line">	<span class="comment">// 以后都是边滑动边显示啊，说到这里一会我们还要看一下手势部分的处理。pos和mItemCount的比较来判断当前是否已经把所有条目填充完</span></div><div class="line">	<span class="keyword">while</span> (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</div><div class="line">		<span class="comment">// is this the selected item?</span></div><div class="line">		<span class="keyword">boolean</span> selected = pos == mSelectedPosition;</div><div class="line">		<span class="comment">// 调用makeAndAddView方法</span></div><div class="line">		View child = makeAndAddView(pos, nextTop, <span class="keyword">true</span>, mListPadding.left, selected);</div><div class="line"></div><div class="line">		nextTop = child.getBottom() + mDividerHeight;</div><div class="line">		<span class="keyword">if</span> (selected) &#123;</div><div class="line">			selectedView = child;</div><div class="line">		&#125;</div><div class="line">		pos++;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</div><div class="line">	<span class="keyword">return</span> selectedView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来看一下<code>makeAndAddView()</code>方法，文档里面说的非常清楚了:　　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Obtain the view and add it to our list of children. The view can be made</div><div class="line"> * fresh, converted from an unused view, or used as is if it was in the</div><div class="line"> * recycle bin.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position Logical position in the list</div><div class="line"> * <span class="doctag">@param</span> y Top or bottom edge of the view to add</div><div class="line"> * <span class="doctag">@param</span> flow If flow is true, align top edge to y. If false, align bottom</div><div class="line"> *        edge to y.</div><div class="line"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</div><div class="line"> * <span class="doctag">@param</span> selected Is this position selected?</div><div class="line"> * <span class="doctag">@return</span> View that was added</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">		<span class="keyword">boolean</span> selected) &#123;</div><div class="line">	View child;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">		<span class="comment">// Try to use an existing view for this position</span></div><div class="line">		child = mRecycler.getActiveView(position);</div><div class="line">		<span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// Found it -- we're using an existing child</span></div><div class="line">			<span class="comment">// This just needs to be positioned</span></div><div class="line">			<span class="comment">// 最后一个参数为true说明是复用的</span></div><div class="line">			setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">			<span class="keyword">return</span> child;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Make a new view for this position, or convert an unused view if possible</span></div><div class="line">	<span class="comment">// 一会我们先看一下obtainView方法，这个方法其实就是创建一个childView</span></div><div class="line">	<span class="comment">// obtainView方法中会更改mIsScrap[0]的值，以便下面setupChild()中使用。</span></div><div class="line">	child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">	<span class="comment">// This needs to be positioned and measured</span></div><div class="line">	<span class="comment">// 把childView添加到listview中，这里最后一个参数会是false</span></div><div class="line">	setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>makeAndAddView()</code>方法里面就是通过<code>RecycleBin</code>来复用<code>View</code>，如果不存在可以复用的<code>View</code>时就创建一个新的。<br>那我们就先看一下`obtainView()方法，这个方法中的注释写的非常清楚，谷歌大神写代码就是规范，不想某些牛逼哄哄的人整天咋呼敏捷开发，一个注释也不写，那能叫敏捷？。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a view and have it show the data associated with the specified</div><div class="line"> * position. This is called when we have already discovered that the view is</div><div class="line"> * not available for reuse in the recycle bin. The only choices left are</div><div class="line"> * converting an old view or making a new one.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position The position to display</div><div class="line"> * <span class="doctag">@param</span> isScrap Array of at least 1 boolean, the first entry will become true if</div><div class="line"> *                the returned view was taken from the scrap heap, false if otherwise.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> A view displaying the data associated with the specified position</div><div class="line"> */</div><div class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] isScrap)</span> </span>&#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"obtainView"</span>);</div><div class="line"></div><div class="line">	isScrap[<span class="number">0</span>] = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="comment">// Check whether we have a transient state view. Attempt to re-bind the</span></div><div class="line">	<span class="comment">// data and discard the view if we fail.</span></div><div class="line">	<span class="keyword">final</span> View transientView = mRecycler.getTransientStateView(position);</div><div class="line">	<span class="keyword">if</span> (transientView != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">final</span> LayoutParams params = (LayoutParams) transientView.getLayoutParams();</div><div class="line"></div><div class="line">		<span class="comment">// If the view type hasn't changed, attempt to re-bind the data.</span></div><div class="line">		<span class="keyword">if</span> (params.viewType == mAdapter.getItemViewType(position)) &#123;</div><div class="line">			<span class="keyword">final</span> View updatedView = mAdapter.getView(position, transientView, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">			<span class="comment">// If we failed to re-bind the data, scrap the obtained view.</span></div><div class="line">			<span class="keyword">if</span> (updatedView != transientView) &#123;</div><div class="line">				setItemViewLayoutParams(updatedView, position);</div><div class="line">				mRecycler.addScrapView(updatedView, position);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Scrap view implies temporary detachment.</span></div><div class="line">		isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">return</span> transientView;</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// getScrapView()方法会从废弃View的缓存中去取，一旦View移除了屏幕就会被加到该废弃缓存中，所以他就是当View移除屏幕了就加到该缓存中</span></div><div class="line">	<span class="comment">// 显示的时候再从该缓存中取，就这样进行了复用。</span></div><div class="line">	<span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</div><div class="line">	<span class="comment">// 调用Adapter.getView()方法了。并且将scrapView作为converview的参数传入。这个方法都挺熟，就不说了。</span></div><div class="line">	<span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (child != scrapView) &#123;</div><div class="line">			<span class="comment">// Failed to re-bind the data, return scrap to the heap.</span></div><div class="line">			mRecycler.addScrapView(scrapView, position);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">			child.dispatchFinishTemporaryDetach();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;</div><div class="line">		child.setDrawingCacheBackgroundColor(mCacheColorHint);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</div><div class="line">		child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 设置该view的layoutparams</span></div><div class="line">	setItemViewLayoutParams(child, position);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</div><div class="line">		<span class="keyword">if</span> (mAccessibilityDelegate == <span class="keyword">null</span>) &#123;</div><div class="line">			mAccessibilityDelegate = <span class="keyword">new</span> ListItemAccessibilityDelegate();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (child.getAccessibilityDelegate() == <span class="keyword">null</span>) &#123;</div><div class="line">			child.setAccessibilityDelegate(mAccessibilityDelegate);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里我们就把<code>obtainView()</code>方法都看完了，接下来我们再看一下<code>setupChild()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Add a view as a child and make sure it is measured (if necessary) and</div><div class="line"> * positioned properly.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child The view to add</div><div class="line"> * <span class="doctag">@param</span> position The position of this child</div><div class="line"> * <span class="doctag">@param</span> y The y position relative to which this view will be positioned</div><div class="line"> * <span class="doctag">@param</span> flowDown If true, align top edge to y. If false, align bottom</div><div class="line"> *        edge to y.</div><div class="line"> * <span class="doctag">@param</span> childrenLeft Left edge where children should be positioned</div><div class="line"> * <span class="doctag">@param</span> selected Is this position selected?</div><div class="line"> * <span class="doctag">@param</span> recycled Has this view been pulled from the recycle bin? If so it</div><div class="line"> *        does not need to be remeasured.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">		<span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> recycled) &#123;</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"setupListItem"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isSelected = selected &amp;&amp; shouldShowSelector();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> updateChildSelected = isSelected != child.isSelected();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> mode = mTouchMode;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> isPressed = mode &gt; TOUCH_MODE_DOWN &amp;&amp; mode &lt; TOUCH_MODE_SCROLL &amp;&amp;</div><div class="line">			mMotionPosition == position;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> updateChildPressed = isPressed != child.isPressed();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> needToMeasure = !recycled || updateChildSelected || child.isLayoutRequested();</div><div class="line"></div><div class="line">	<span class="comment">// Respect layout params that are already in the view. Otherwise make some up...</span></div><div class="line">	<span class="comment">// noinspection unchecked</span></div><div class="line">	AbsListView.LayoutParams p = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">	<span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">		p = (AbsListView.LayoutParams) generateDefaultLayoutParams();</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 这里就是Adapter中getItemViewType的调用处</span></div><div class="line">	p.viewType = mAdapter.getItemViewType(position);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((recycled &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter &amp;&amp;</div><div class="line">			p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">		<span class="comment">// 复用的或者headerView及footerView等调用attachViewToParent方法，把之前detach的View重新attach到ViewGroup上</span></div><div class="line">		attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		p.forceAdd = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">			p.recycledHeaderFooter = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 第一次都是通过该方法来把View添加到ViewGroup中</span></div><div class="line">		addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (updateChildSelected) &#123;</div><div class="line">		child.setSelected(isSelected);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (updateChildPressed) &#123;</div><div class="line">		child.setPressed(isPressed);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</div><div class="line">			((Checkable) child).setChecked(mCheckStates.get(position));</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</div><div class="line">				&gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">			child.setActivated(mCheckStates.get(position));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">		<span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</div><div class="line">				mListPadding.left + mListPadding.right, p.width);</div><div class="line">		<span class="keyword">int</span> lpHeight = p.height;</div><div class="line">		<span class="keyword">int</span> childHeightSpec;</div><div class="line">		<span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">			childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			childHeightSpec = MeasureSpec.makeMeasureSpec(<span class="number">0</span>, MeasureSpec.UNSPECIFIED);</div><div class="line">		&#125;</div><div class="line">		child.measure(childWidthSpec, childHeightSpec);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		cleanupLayoutState(child);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</div><div class="line">		child.layout(childrenLeft, childTop, childRight, childBottom);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		child.offsetLeftAndRight(childrenLeft - child.getLeft());</div><div class="line">		child.offsetTopAndBottom(childTop - child.getTop());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mCachingStarted &amp;&amp; !child.isDrawingCacheEnabled()) &#123;</div><div class="line">		child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (recycled &amp;&amp; (((AbsListView.LayoutParams)child.getLayoutParams()).scrappedFromPosition)</div><div class="line">			!= position) &#123;</div><div class="line">		child.jumpDrawablesToCurrentState();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过分析我们看到核心的部分就是<code>attachViewToParent()</code>方法和<code>addViewInLayout()</code>方法，这两个方法都是父类<code>ViewGroup</code>中的方法，<br>我们分别来看一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Attaches a view to this view group. Attaching a view assigns this group as the parent,</div><div class="line"> * sets the layout parameters and puts the view in the list of children so that</div><div class="line"> * it can be retrieved by calling &#123;<span class="doctag">@link</span> #getChildAt(int)&#125;.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This method is intended to be lightweight and makes no assumptions about whether the</div><div class="line"> * parent or child should be redrawn. Proper use of this method will include also making</div><div class="line"> * any appropriate &#123;<span class="doctag">@link</span> #requestLayout()&#125; or &#123;<span class="doctag">@link</span> #invalidate()&#125; calls.</div><div class="line"> * For example, callers can &#123;<span class="doctag">@link</span> #post(Runnable) post&#125; a &#123;<span class="doctag">@link</span> Runnable&#125;</div><div class="line"> * which performs a &#123;<span class="doctag">@link</span> #requestLayout()&#125; on the next frame, after all detach/attach</div><div class="line"> * calls are finished, causing layout to be run prior to redrawing the view hierarchy.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This method should be called only for views which were detached from their parent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child the child to attach</div><div class="line"> * <span class="doctag">@param</span> index the index at which the child should be attached</div><div class="line"> * <span class="doctag">@param</span> params the layout parameters of the child</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #removeDetachedView(View, boolean)</div><div class="line"> * <span class="doctag">@see</span> #detachAllViewsFromParent()</div><div class="line"> * <span class="doctag">@see</span> #detachViewFromParent(View)</div><div class="line"> * <span class="doctag">@see</span> #detachViewFromParent(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachViewToParent</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params)</span> </span>&#123;</div><div class="line">	child.mLayoutParams = params;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">		index = mChildrenCount;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 把该view添加到数组中，就像注释所说的为了能够让`getChildAt()`方法能获取到。</span></div><div class="line">	addInArray(child, index);</div><div class="line"></div><div class="line">	child.mParent = <span class="keyword">this</span>;</div><div class="line">	child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK</div><div class="line">					&amp; ~PFLAG_DRAWING_CACHE_VALID)</div><div class="line">			| PFLAG_DRAWN | PFLAG_INVALIDATED;</div><div class="line">	<span class="keyword">this</span>.mPrivateFlags |= PFLAG_INVALIDATED;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (child.hasFocus()) &#123;</div><div class="line">		requestChildFocus(child, child.findFocus());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>复用的处理看完后，我们看一下新创建的childView如何被添加到ListView上，我们看一下<code>addViewInLayout()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adds a view during layout. This is useful if in your onLayout() method,</div><div class="line"> * you need to add more views (as does the list view for example).</div><div class="line"> *</div><div class="line"> * If index is negative, it means put it at the end of the list.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> child the view to add to the group</div><div class="line"> * <span class="doctag">@param</span> index the index at which the child must be added</div><div class="line"> * <span class="doctag">@param</span> params the layout parameters to associate with the child</div><div class="line"> * <span class="doctag">@param</span> preventRequestLayout if true, calling this method will not trigger a</div><div class="line"> *        layout request on child</div><div class="line"> * <span class="doctag">@return</span> true if the child was added, false otherwise</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">addViewInLayout</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params,</span></span></div><div class="line">		<span class="keyword">boolean</span> preventRequestLayout) &#123;</div><div class="line">	<span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add a null child view to a ViewGroup"</span>);</div><div class="line">	&#125;</div><div class="line">	child.mParent = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 这个方法最终会调用addView方法添加childView</span></div><div class="line">	addViewInner(child, index, params, preventRequestLayout);</div><div class="line">	child.mPrivateFlags = (child.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里已经把上面<code>fillFromTop()</code>方法的部分都分析完了。<br>不要忘了我们上面还留了一个TODO的部分，就是对于已经有数据的部分调用<code>fillSpecific()</code>方法，那我们就看一下他的实现:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Put a specific item at a specific location on the screen and then build</div><div class="line"> * up and down from there.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> position The reference view to use as the starting point</div><div class="line"> * <span class="doctag">@param</span> top Pixel offset from the top of this view to the top of the</div><div class="line"> *        reference view.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> The selected view, or null if the selected view is outside the</div><div class="line"> *         visible area.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillSpecific</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> top)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> tempIsSelected = position == mSelectedPosition;</div><div class="line">	View temp = makeAndAddView(position, top, <span class="keyword">true</span>, mListPadding.left, tempIsSelected);</div><div class="line">	<span class="comment">// Possibly changed again in fillUp if we add rows above this one.</span></div><div class="line">	mFirstPosition = position;</div><div class="line"></div><div class="line">	View above;</div><div class="line">	View below;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> dividerHeight = mDividerHeight;</div><div class="line">	<span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">		above = fillUp(position - <span class="number">1</span>, temp.getTop() - dividerHeight);</div><div class="line">		<span class="comment">// This will correct for the top of the first view not touching the top of the list</span></div><div class="line">		adjustViewsUpOrDown();</div><div class="line">		below = fillDown(position + <span class="number">1</span>, temp.getBottom() + dividerHeight);</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			correctTooHigh(childCount);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		below = fillDown(position + <span class="number">1</span>, temp.getBottom() + dividerHeight);</div><div class="line">		<span class="comment">// This will correct for the bottom of the last view not touching the bottom of the list</span></div><div class="line">		adjustViewsUpOrDown();</div><div class="line">		above = fillUp(position - <span class="number">1</span>, temp.getTop() - dividerHeight);</div><div class="line">		<span class="keyword">int</span> childCount = getChildCount();</div><div class="line">		<span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			 correctTooLow(childCount);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (tempIsSelected) &#123;</div><div class="line">		<span class="keyword">return</span> temp;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (above != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> above;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> below;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就像注释所说的它是让指定位置的View先加载到屏幕上，然后在加载该view往上以及往下位置的其他View，他里面会调用<code>fillUp()</code>和<code>fillDown()</code>方法，又会走上面的流程，所以这里就不分析了。</p>
<p>好了，到这里我们就基本已经分析完了，但是感觉好像好少了点什么？　　　</p>
<p>这里少了不是一点，是两点:      </p>
<ul>
<li>手势滑动过程中ListView的复用处理</li>
<li>RecycleBin中复用的具体实现</li>
</ul>
<p>一个个的来，先看一下手势滑动部分，这个当然是从<code>onTouchEvent()</code>方法看了，<br>手势这一块不太清楚的可以看我之前的一篇文章<br><a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/Android%20Touch%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E8%AF%A6%E8%A7%A3.md">Android Touch事件分发详解</a></p>
<p>发现<code>ListView</code>没有重写<code>onTouchEvent()</code>方法，这也好理解，因为<code>GridView</code>也有类似的滑动功能，所以去父类<code>AbsListView</code>中看.<br>我们看一下<code>AbsListView.onTouchEvent()</code>方法:　　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!isEnabled()) &#123;</div><div class="line">		<span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">		<span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">		<span class="keyword">return</span> isClickable() || isLongClickable();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mPositionScroller != <span class="keyword">null</span>) &#123;</div><div class="line">		mPositionScroller.stop();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mIsDetaching || !isAttachedToWindow()) &#123;</div><div class="line">		<span class="comment">// Something isn't right.</span></div><div class="line">		<span class="comment">// Since we rely on being attached to get data set change notifications,</span></div><div class="line">		<span class="comment">// don't risk doing anything where we might try to resync and find things</span></div><div class="line">		<span class="comment">// in a bogus state.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	startNestedScroll(SCROLL_AXIS_VERTICAL);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">boolean</span> intercepted = mFastScroll.onTouchEvent(ev);</div><div class="line">		<span class="keyword">if</span> (intercepted) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	initVelocityTrackerIfNotExists();</div><div class="line">	<span class="keyword">final</span> MotionEvent vtev = MotionEvent.obtain(ev);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> actionMasked = ev.getActionMasked();</div><div class="line">	<span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		mNestedYOffset = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	vtev.offsetLocation(<span class="number">0</span>, mNestedYOffset);</div><div class="line">	<span class="keyword">switch</span> (actionMasked) &#123;</div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">			onTouchDown(ev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">		    <span class="comment">// 具体移动的部分就在这里了</span></div><div class="line">			onTouchMove(ev, vtev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">			onTouchUp(ev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">			onTouchCancel();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP: &#123;</div><div class="line">			onSecondaryPointerUp(ev);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> x = mMotionX;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> y = mMotionY;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">			<span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Remember where the motion event started</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = child.getTop();</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN: &#123;</div><div class="line">			<span class="comment">// New pointers take over dragging duties</span></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> index = ev.getActionIndex();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(index);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX(index);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(index);</div><div class="line">			mMotionCorrection = <span class="number">0</span>;</div><div class="line">			mActivePointerId = id;</div><div class="line">			mMotionX = x;</div><div class="line">			mMotionY = y;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">			<span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Remember where the motion event started</span></div><div class="line">				<span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = child.getTop();</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">		mVelocityTracker.addMovement(vtev);</div><div class="line">	&#125;</div><div class="line">	vtev.recycle();</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>onTouchMove()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTouchMove</span><span class="params">(MotionEvent ev, MotionEvent vtev)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">	<span class="keyword">if</span> (pointerIndex == -<span class="number">1</span>) &#123;</div><div class="line">		pointerIndex = <span class="number">0</span>;</div><div class="line">		mActivePointerId = ev.getPointerId(pointerIndex);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mDataChanged) &#123;</div><div class="line">		<span class="comment">// Re-sync everything if data has been changed</span></div><div class="line">		<span class="comment">// since the scroll operation can query the adapter.</span></div><div class="line">		layoutChildren();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(pointerIndex);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span> (mTouchMode) &#123;</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_DOWN:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_TAP:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_DONE_WAITING:</div><div class="line">			<span class="comment">// Check if we have moved far enough that it looks more like a</span></div><div class="line">			<span class="comment">// scroll than a tap. If so, we'll enter scrolling mode.</span></div><div class="line">			<span class="keyword">if</span> (startScrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev)) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Otherwise, check containment within list bounds. If we're</span></div><div class="line">			<span class="comment">// outside bounds, cancel any active presses.</span></div><div class="line">			<span class="keyword">final</span> View motionView = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">			<span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(pointerIndex);</div><div class="line">			<span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">				setPressed(<span class="keyword">false</span>);</div><div class="line">				<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">					motionView.setPressed(<span class="keyword">false</span>);</div><div class="line">				&#125;</div><div class="line">				removeCallbacks(mTouchMode == TOUCH_MODE_DOWN ?</div><div class="line">						mPendingCheckForTap : mPendingCheckForLongPress);</div><div class="line">				mTouchMode = TOUCH_MODE_DONE_WAITING;</div><div class="line">				updateSelectorState();</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Still within bounds, update the hotspot.</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">float</span>[] point = mTmpPoint;</div><div class="line">				point[<span class="number">0</span>] = x;</div><div class="line">				point[<span class="number">1</span>] = y;</div><div class="line">				transformPointToViewLocal(point, motionView);</div><div class="line">				motionView.drawableHotspotChanged(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_SCROLL:</div><div class="line">		<span class="keyword">case</span> TOUCH_MODE_OVERSCROLL:</div><div class="line">			<span class="comment">// 滑动部分的处理，传入当前位置的x,y坐标</span></div><div class="line">			scrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>scrollIfNeeded()</code>方法的实现:　　　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrollIfNeeded</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, MotionEvent vtev)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> rawDeltaY = y - mMotionY;</div><div class="line">	<span class="keyword">int</span> scrollOffsetCorrection = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> scrollConsumedCorrection = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (mLastY == Integer.MIN_VALUE) &#123;</div><div class="line">		rawDeltaY -= mMotionCorrection;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (dispatchNestedPreScroll(<span class="number">0</span>, mLastY != Integer.MIN_VALUE ? mLastY - y : -rawDeltaY,</div><div class="line">			mScrollConsumed, mScrollOffset)) &#123;</div><div class="line">		rawDeltaY += mScrollConsumed[<span class="number">1</span>];</div><div class="line">		scrollOffsetCorrection = -mScrollOffset[<span class="number">1</span>];</div><div class="line">		scrollConsumedCorrection = mScrollConsumed[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">			vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">			mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> deltaY = rawDeltaY;</div><div class="line">	<span class="keyword">int</span> incrementalDeltaY =</div><div class="line">			mLastY != Integer.MIN_VALUE ? y - mLastY + scrollConsumedCorrection : deltaY;</div><div class="line">	<span class="keyword">int</span> lastYCorrection = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (mTouchMode == TOUCH_MODE_SCROLL) &#123;</div><div class="line">		<span class="keyword">if</span> (PROFILE_SCROLLING) &#123;</div><div class="line">			<span class="keyword">if</span> (!mScrollProfilingStarted) &#123;</div><div class="line">				Debug.startMethodTracing(<span class="string">"AbsListViewScroll"</span>);</div><div class="line">				mScrollProfilingStarted = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (mScrollStrictSpan == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// If it's non-null, we're already in a scroll.</span></div><div class="line">			mScrollStrictSpan = StrictMode.enterCriticalSpan(<span class="string">"AbsListView-scroll"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">			<span class="comment">// 移动了</span></div><div class="line">			<span class="comment">// We may be here after stopping a fling and continuing to scroll.</span></div><div class="line">			<span class="comment">// If so, we haven't disallowed intercepting touch events yet.</span></div><div class="line">			<span class="comment">// Make sure that we do so in case we're in a parent that can intercept.</span></div><div class="line">			<span class="keyword">if</span> ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) == <span class="number">0</span> &amp;&amp;</div><div class="line">					Math.abs(rawDeltaY) &gt; mTouchSlop) &#123;</div><div class="line">				<span class="keyword">final</span> ViewParent parent = getParent();</div><div class="line">				<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">					parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> motionIndex;</div><div class="line">			<span class="keyword">if</span> (mMotionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">				motionIndex = mMotionPosition - mFirstPosition;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// If we don't have a motion position that we can reliably track,</span></div><div class="line">				<span class="comment">// pick something in the middle to make a best guess at things below.</span></div><div class="line">				motionIndex = getChildCount() / <span class="number">2</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> motionViewPrevTop = <span class="number">0</span>;</div><div class="line">			View motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">			<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				motionViewPrevTop = motionView.getTop();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// No need to do all this work if we're not going to move anyway</span></div><div class="line">			<span class="keyword">boolean</span> atEdge = <span class="keyword">false</span>;</div><div class="line">			<span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">			    <span class="comment">// 移动的过程中不断调用</span></div><div class="line">				atEdge = trackMotionScroll(deltaY, incrementalDeltaY);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Check to see if we have bumped into the scroll limit</span></div><div class="line">			motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">			<span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// Check if the top of the motion view is where it is</span></div><div class="line">				<span class="comment">// supposed to be</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> motionViewRealTop = motionView.getTop();</div><div class="line">				<span class="keyword">if</span> (atEdge) &#123;</div><div class="line">					<span class="comment">// Apply overscroll</span></div><div class="line"></div><div class="line">					<span class="keyword">int</span> overscroll = -incrementalDeltaY -</div><div class="line">							(motionViewRealTop - motionViewPrevTop);</div><div class="line">					<span class="keyword">if</span> (dispatchNestedScroll(<span class="number">0</span>, overscroll - incrementalDeltaY, <span class="number">0</span>, overscroll,</div><div class="line">							mScrollOffset)) &#123;</div><div class="line">						lastYCorrection -= mScrollOffset[<span class="number">1</span>];</div><div class="line">						<span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">							vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">							mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="keyword">final</span> <span class="keyword">boolean</span> atOverscrollEdge = overScrollBy(<span class="number">0</span>, overscroll,</div><div class="line">								<span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">						<span class="keyword">if</span> (atOverscrollEdge &amp;&amp; mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">							<span class="comment">// Don't allow overfling if we're at the edge</span></div><div class="line">							mVelocityTracker.clear();</div><div class="line">						&#125;</div><div class="line"></div><div class="line">						<span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">						<span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">								(overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">										!contentFits())) &#123;</div><div class="line">							<span class="keyword">if</span> (!atOverscrollEdge) &#123;</div><div class="line">								mDirection = <span class="number">0</span>; <span class="comment">// Reset when entering overscroll.</span></div><div class="line">								mTouchMode = TOUCH_MODE_OVERSCROLL;</div><div class="line">							&#125;</div><div class="line">							<span class="keyword">if</span> (incrementalDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">								mEdgeGlowTop.onPull((<span class="keyword">float</span>) -overscroll / getHeight(),</div><div class="line">										(<span class="keyword">float</span>) x / getWidth());</div><div class="line">								<span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">									mEdgeGlowBottom.onRelease();</div><div class="line">								&#125;</div><div class="line">								invalidate(<span class="number">0</span>, <span class="number">0</span>, getWidth(),</div><div class="line">										mEdgeGlowTop.getMaxHeight() + getPaddingTop());</div><div class="line">							&#125; <span class="keyword">else</span> <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">								mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overscroll / getHeight(),</div><div class="line">										<span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">								<span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">									mEdgeGlowTop.onRelease();</div><div class="line">								&#125;</div><div class="line">								invalidate(<span class="number">0</span>, getHeight() - getPaddingBottom() -</div><div class="line">										mEdgeGlowBottom.getMaxHeight(), getWidth(),</div><div class="line">										getHeight());</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				mMotionY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">			&#125;</div><div class="line">			mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_OVERSCROLL) &#123;</div><div class="line">	    <span class="comment">// 灰起了.</span></div><div class="line">		<span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> oldScroll = mScrollY;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> newScroll = oldScroll - incrementalDeltaY;</div><div class="line">			<span class="keyword">int</span> newDirection = y &gt; mLastY ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mDirection == <span class="number">0</span>) &#123;</div><div class="line">				mDirection = newDirection;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">int</span> overScrollDistance = -incrementalDeltaY;</div><div class="line">			<span class="keyword">if</span> ((newScroll &lt; <span class="number">0</span> &amp;&amp; oldScroll &gt;= <span class="number">0</span>) || (newScroll &gt; <span class="number">0</span> &amp;&amp; oldScroll &lt;= <span class="number">0</span>)) &#123;</div><div class="line">				overScrollDistance = -oldScroll;</div><div class="line">				incrementalDeltaY += overScrollDistance;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				incrementalDeltaY = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (overScrollDistance != <span class="number">0</span>) &#123;</div><div class="line">				overScrollBy(<span class="number">0</span>, overScrollDistance, <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">						<span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">				<span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">						(overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">								!contentFits())) &#123;</div><div class="line">					<span class="keyword">if</span> (rawDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">						mEdgeGlowTop.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">								(<span class="keyword">float</span>) x / getWidth());</div><div class="line">						<span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">							mEdgeGlowBottom.onRelease();</div><div class="line">						&#125;</div><div class="line">						invalidate(<span class="number">0</span>, <span class="number">0</span>, getWidth(),</div><div class="line">								mEdgeGlowTop.getMaxHeight() + getPaddingTop());</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">						mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">								<span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">						<span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">							mEdgeGlowTop.onRelease();</div><div class="line">						&#125;</div><div class="line">						invalidate(<span class="number">0</span>, getHeight() - getPaddingBottom() -</div><div class="line">								mEdgeGlowBottom.getMaxHeight(), getWidth(),</div><div class="line">								getHeight());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">// Coming back to 'real' list scrolling</span></div><div class="line">				<span class="keyword">if</span> (mScrollY != <span class="number">0</span>) &#123;</div><div class="line">					mScrollY = <span class="number">0</span>;</div><div class="line">					invalidateParentIfNeeded();</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 继续处理着</span></div><div class="line">				trackMotionScroll(incrementalDeltaY, incrementalDeltaY);</div><div class="line"></div><div class="line">				mTouchMode = TOUCH_MODE_SCROLL;</div><div class="line"></div><div class="line">				<span class="comment">// We did not scroll the full amount. Treat this essentially like the</span></div><div class="line">				<span class="comment">// start of a new touch scroll</span></div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> motionPosition = findClosestMotionRow(y);</div><div class="line"></div><div class="line">				mMotionCorrection = <span class="number">0</span>;</div><div class="line">				View motionView = getChildAt(motionPosition - mFirstPosition);</div><div class="line">				mMotionViewOriginalTop = motionView != <span class="keyword">null</span> ? motionView.getTop() : <span class="number">0</span>;</div><div class="line">				mMotionY =  y + scrollOffsetCorrection;</div><div class="line">				mMotionPosition = motionPosition;</div><div class="line">			&#125;</div><div class="line">			mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">			mDirection = newDirection;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这部分代码逻辑牵扯太多，有点晕呼呼的，记着看一下<code>trackMotionScroll()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Track a motion scroll</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> deltaY Amount to offset mMotionView. This is the accumulated delta since the motion</div><div class="line"> *        began. Positive numbers mean the user's finger is moving down the screen.</div><div class="line"> * <span class="doctag">@param</span> incrementalDeltaY Change in deltaY from the previous event. 通过它的正负来判断是向上还是向下。</div><div class="line"> * <span class="doctag">@return</span> true if we're already at the beginning/end of the list and have nothing to do.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">trackMotionScroll</span><span class="params">(<span class="keyword">int</span> deltaY, <span class="keyword">int</span> incrementalDeltaY)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">	<span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> firstTop = getChildAt(<span class="number">0</span>).getTop();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> lastBottom = getChildAt(childCount - <span class="number">1</span>).getBottom();</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Rect listPadding = mListPadding;</div><div class="line"></div><div class="line">	<span class="comment">// "effective padding" In this case is the amount of padding that affects</span></div><div class="line">	<span class="comment">// how much space should not be filled by items. If we don't clip to padding</span></div><div class="line">	<span class="comment">// there is no effective padding.</span></div><div class="line">	<span class="keyword">int</span> effectivePaddingTop = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> effectivePaddingBottom = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">		effectivePaddingTop = listPadding.top;</div><div class="line">		effectivePaddingBottom = listPadding.bottom;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">// FIXME account for grid vertical spacing too?</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> spaceAbove = effectivePaddingTop - firstTop;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> end = getHeight() - effectivePaddingBottom;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> spaceBelow = lastBottom - end;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - mPaddingBottom - mPaddingTop;</div><div class="line">	<span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">		deltaY = Math.max(-(height - <span class="number">1</span>), deltaY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		deltaY = Math.min(height - <span class="number">1</span>, deltaY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">		incrementalDeltaY = Math.max(-(height - <span class="number">1</span>), incrementalDeltaY);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		incrementalDeltaY = Math.min(height - <span class="number">1</span>, incrementalDeltaY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line"></div><div class="line">	<span class="comment">// Update our guesses for where the first and last views are</span></div><div class="line">	<span class="keyword">if</span> (firstPosition == <span class="number">0</span>) &#123;</div><div class="line">		mFirstPositionDistanceGuess = firstTop - listPadding.top;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mFirstPositionDistanceGuess += incrementalDeltaY;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (firstPosition + childCount == mItemCount) &#123;</div><div class="line">		mLastPositionDistanceGuess = lastBottom + listPadding.bottom;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mLastPositionDistanceGuess += incrementalDeltaY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollDown = (firstPosition == <span class="number">0</span> &amp;&amp;</div><div class="line">			firstTop &gt;= listPadding.top &amp;&amp; incrementalDeltaY &gt;= <span class="number">0</span>);</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollUp = (firstPosition + childCount == mItemCount &amp;&amp;</div><div class="line">			lastBottom &lt;= getHeight() - listPadding.bottom &amp;&amp; incrementalDeltaY &lt;= <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (cannotScrollDown || cannotScrollUp) &#123;</div><div class="line">		<span class="keyword">return</span> incrementalDeltaY != <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 判断向上还是向下</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = isInTouchMode();</div><div class="line">	<span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">		hideSelector();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> headerViewsCount = getHeaderViewsCount();</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> footerViewsStart = mItemCount - getFooterViewsCount();</div><div class="line"></div><div class="line">	<span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (down) &#123;</div><div class="line">		<span class="keyword">int</span> top = -incrementalDeltaY;</div><div class="line">		<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">			top += listPadding.top;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getBottom() &gt;= top) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">			    <span class="comment">// 如果这个View的底部位置已经小于top值了，说明这个view已经移除屏幕了，不可见了</span></div><div class="line">				count++;</div><div class="line">				<span class="keyword">int</span> position = firstPosition + i;</div><div class="line">				<span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">					<span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">					<span class="comment">// system-managed transient state.</span></div><div class="line">					child.clearAccessibilityFocus();</div><div class="line">					<span class="comment">// 只要该view移除屏幕就把该view添加到废弃的缓存中</span></div><div class="line">					mRecycler.addScrapView(child, position);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">int</span> bottom = getHeight() - incrementalDeltaY;</div><div class="line">		<span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">			bottom -= listPadding.bottom;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">			<span class="keyword">if</span> (child.getTop() &lt;= bottom) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				start = i;</div><div class="line">				count++;</div><div class="line">				<span class="keyword">int</span> position = firstPosition + i;</div><div class="line">				<span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">					<span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">					<span class="comment">// system-managed transient state.</span></div><div class="line">					child.clearAccessibilityFocus();</div><div class="line">					mRecycler.addScrapView(child, position);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mMotionViewNewTop = mMotionViewOriginalTop + deltaY;</div><div class="line"></div><div class="line">	mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="comment">// count记录了当前已经移除屏幕的view个数</span></div><div class="line">	<span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">	    <span class="comment">// 把已经移除的View从ViewGroup总detach掉</span></div><div class="line">		detachViewsFromParent(start, count);</div><div class="line">		mRecycler.removeSkippedScrap();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// invalidate before moving the children to avoid unnecessary invalidate</span></div><div class="line">	<span class="comment">// calls to bubble up from the children all the way to the top</span></div><div class="line">	<span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">	   invalidate();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 这个方法让所有的子view都按照这个参数的距离大小进行改变，这样就实现了移动也就是滑动的功能。</span></div><div class="line">	offsetChildrenTopAndBottom(incrementalDeltaY);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (down) &#123;</div><div class="line">		mFirstPosition += count;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> absIncrementalDeltaY = Math.abs(incrementalDeltaY);</div><div class="line">	<span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) &#123;</div><div class="line">	    <span class="comment">// 第一个View的顶部移入了屏幕或者最后一个View的底部移入了屏幕</span></div><div class="line">		fillGap(down);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!inTouchMode &amp;&amp; mSelectedPosition != INVALID_POSITION) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectedPosition - mFirstPosition;</div><div class="line">		<span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">			positionSelector(mSelectedPosition, getChildAt(childIndex));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectorPosition - mFirstPosition;</div><div class="line">		<span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">			positionSelector(INVALID_POSITION, getChildAt(childIndex));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		mSelectorRect.setEmpty();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	invokeOnItemScrollListener();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看一下<code>offsetChildrenTopAndBottom()</code>方法的，在<code>AbsListView</code>中没有重写该方法，具体要看其父类<code>ViewGroup</code>中的实现:       `<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Offset the vertical location of all children of this view by the specified number of pixels.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> offset the number of pixels to offset</div><div class="line"> *</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offsetChildrenTopAndBottom</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">	<span class="keyword">final</span> View[] children = mChildren;</div><div class="line">	<span class="keyword">boolean</span> invalidate = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">	    <span class="comment">// 把所有的view都移动指定的距离</span></div><div class="line">		<span class="keyword">final</span> View v = children[i];</div><div class="line">		v.mTop += offset;</div><div class="line">		v.mBottom += offset;</div><div class="line">		<span class="keyword">if</span> (v.mRenderNode != <span class="keyword">null</span>) &#123;</div><div class="line">			invalidate = <span class="keyword">true</span>;</div><div class="line">			v.mRenderNode.offsetTopAndBottom(offset);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (invalidate) &#123;</div><div class="line">		invalidateViewProperty(<span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">	notifySubtreeAccessibilityStateChangedIfNeeded();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再看一下<code>fillGap()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Fills the gap left open by a touch-scroll. During a touch scroll, children that</div><div class="line"> * remain on screen are shifted and the other ones are discarded. The role of this</div><div class="line"> * method is to fill the gap thus created by performing a partial layout in the</div><div class="line"> * empty space.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> down true if the scroll is going down, false if it is going up</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span></span>;</div></pre></td></tr></table></figure></p>
<p>发现在<code>AbsListView</code>中该方法是抽象的，所以我们要再<code>ListView</code>中找一下他的具体实现类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">    <span class="keyword">if</span> (down) &#123;</div><div class="line">        <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            paddingTop = getListPaddingTop();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(count - <span class="number">1</span>).getBottom() + mDividerHeight :</div><div class="line">                paddingTop;</div><div class="line">        fillDown(mFirstPosition + count, startOffset);</div><div class="line">        correctTooHigh(getChildCount());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            paddingBottom = getListPaddingBottom();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</div><div class="line">                getHeight() - paddingBottom;</div><div class="line">        fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</div><div class="line">        correctTooLow(getChildCount());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到他会分别根据向下滑动还是向上滑动去调用<code>fillDown</code>和<code>fillUp</code>两个方法，这两个方法之前我们都分析过了，就不再继续看了。</p>
<p>到这里基本就把滑动部分的处理都看完了。<br>还剩最后一个问题就是<code>RecycleBin</code>的实现,他是<code>AbsListView</code>中的一个内部类。</p>
<p>直接上代码了，他的注释也说的非常清楚，我就把不好理解的地方简单说一下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The RecycleBin facilitates reuse of views across layouts. The RecycleBin has two levels of</div><div class="line"> * storage: ActiveViews and ScrapViews. ActiveViews are those views which were onscreen at the</div><div class="line"> * start of a layout. By construction, they are displaying current information. At the end of</div><div class="line"> * layout, all views in ActiveViews are demoted to ScrapViews. ScrapViews are old views that</div><div class="line"> * could potentially be used by the adapter to avoid allocating views unnecessarily.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> android.widget.AbsListView#setRecyclerListener(android.widget.AbsListView.RecyclerListener)</div><div class="line"> * <span class="doctag">@see</span> android.widget.AbsListView.RecyclerListener</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecycleBin</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> RecyclerListener mRecyclerListener;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * The position of the first view stored in mActiveViews.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mFirstActivePosition;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Views that were on screen at the start of layout. This array is populated at the start of</div><div class="line">	 * layout, and at the end of layout all view in mActiveViews are moved to mScrapViews.</div><div class="line">	 * Views in mActiveViews represent a contiguous range of Views, with position of the first</div><div class="line">	 * view store in mFirstActivePosition.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> View[] mActiveViews = <span class="keyword">new</span> View[<span class="number">0</span>];</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 为什么是个数组呢？因为ListView会有多种不同的ViewType啊。</div><div class="line">	 * Unsorted views that can be used by the adapter as a convert view.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> mViewTypeCount;</div><div class="line">	<span class="comment">// mScrapViews数组中的第一个元素，方便在ViewType是1的时候使用</span></div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt; mCurrentScrap;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> ArrayList&lt;View&gt; mSkippedScrap;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> SparseArray&lt;View&gt; mTransientStateViews;</div><div class="line">	<span class="keyword">private</span> LongSparseArray&lt;View&gt; mTransientStateViewsById;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewTypeCount</span><span class="params">(<span class="keyword">int</span> viewTypeCount)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (viewTypeCount &lt; <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't have a viewTypeCount &lt; 1"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 根据ViewType的数量来创建，因为ViewType可以有多中类型，每种不同类型的View肯定要分开单独进行缓存和复用的。</span></div><div class="line">		<span class="comment">//noinspection unchecked</span></div><div class="line">		ArrayList&lt;View&gt;[] scrapViews = <span class="keyword">new</span> ArrayList[viewTypeCount];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; i++) &#123;</div><div class="line">			scrapViews[i] = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">		&#125;</div><div class="line">		mViewTypeCount = viewTypeCount;</div><div class="line">		mCurrentScrap = scrapViews[<span class="number">0</span>];</div><div class="line">		mScrapViews = scrapViews;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 方法名说明了一切</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markChildrenDirty</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">				scrap.get(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">					scrap.get(j).forceLayout();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViews.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">				mTransientStateViews.valueAt(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViewsById.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">				mTransientStateViewsById.valueAt(i).forceLayout();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldRecycleViewType</span><span class="params">(<span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewType &gt;= <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Clears the scrap heap.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			clearScrap(scrap);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				clearScrap(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		clearTransientStateViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Fill ActiveViews with all of the children of the AbsListView.</div><div class="line">	 * 将View存储到mActiveViews数组中</div><div class="line">	 * <span class="doctag">@param</span> childCount The minimum number of views mActiveViews should hold</div><div class="line">	 * <span class="doctag">@param</span> firstActivePosition The position of the first view that will be stored in</div><div class="line">	 *        mActiveViews</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fillActiveViews</span><span class="params">(<span class="keyword">int</span> childCount, <span class="keyword">int</span> firstActivePosition)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mActiveViews.length &lt; childCount) &#123;</div><div class="line">			mActiveViews = <span class="keyword">new</span> View[childCount];</div><div class="line">		&#125;</div><div class="line">		mFirstActivePosition = firstActivePosition;</div><div class="line"></div><div class="line">		<span class="comment">//noinspection MismatchedReadAndWriteOfArray</span></div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">			View child = getChildAt(i);</div><div class="line">			AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">			<span class="comment">// Don't put header or footer views into the scrap heap</span></div><div class="line">			<span class="keyword">if</span> (lp != <span class="keyword">null</span> &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">				<span class="comment">// Note:  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</span></div><div class="line">				<span class="comment">//        However, we will NOT place them into scrap views.</span></div><div class="line">				activeViews[i] = child;</div><div class="line">				<span class="comment">// Remember the position so that setupChild() doesn't reset state.</span></div><div class="line">				lp.scrappedFromPosition = firstActivePosition + i;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Get the view corresponding to the specified position. The view will be removed from</div><div class="line">	 * mActiveViews if it is found.注释说了获取完之后就会从mActiveViews中移除，这是很好理解的</div><div class="line">	 * 因为获取了就是说这个View已经显示到当前的ListView中了，肯定不能再复用他了。</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> position The position to look up in mActiveViews</div><div class="line">	 * <span class="doctag">@return</span> The view if it is found, null otherwise</div><div class="line">	 */</div><div class="line">	<span class="function">View <span class="title">getActiveView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> index = position - mFirstActivePosition;</div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">if</span> (index &gt;=<span class="number">0</span> &amp;&amp; index &lt; activeViews.length) &#123;</div><div class="line">			<span class="keyword">final</span> View match = activeViews[index];</div><div class="line">			activeViews[index] = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">return</span> match;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">View <span class="title">getTransientStateView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds &amp;&amp; mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">			View result = mTransientStateViewsById.get(id);</div><div class="line">			mTransientStateViewsById.remove(id);</div><div class="line">			<span class="keyword">return</span> result;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> index = mTransientStateViews.indexOfKey(position);</div><div class="line">			<span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">				View result = mTransientStateViews.valueAt(index);</div><div class="line">				mTransientStateViews.removeAt(index);</div><div class="line">				<span class="keyword">return</span> result;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Dumps and fully detaches any currently saved views with transient</div><div class="line">	 * state.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clearTransientStateViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> SparseArray&lt;View&gt; viewsByPos = mTransientStateViews;</div><div class="line">		<span class="keyword">if</span> (viewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = viewsByPos.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">				removeDetachedView(viewsByPos.valueAt(i), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">			viewsByPos.clear();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LongSparseArray&lt;View&gt; viewsById = mTransientStateViewsById;</div><div class="line">		<span class="keyword">if</span> (viewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> N = viewsById.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">				removeDetachedView(viewsById.valueAt(i), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">			viewsById.clear();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 从废弃View的缓存中获取，只要移动出屏幕之后就都会被加到废弃View的缓存中 </div><div class="line">	 * <span class="doctag">@return</span> A view from the ScrapViews collection. These are unordered.</div><div class="line">	 */</div><div class="line">	<span class="function">View <span class="title">getScrapView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> retrieveFromScrap(mCurrentScrap, position);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> whichScrap = mAdapter.getItemViewType(position);</div><div class="line">			<span class="keyword">if</span> (whichScrap &gt;= <span class="number">0</span> &amp;&amp; whichScrap &lt; mScrapViews.length) &#123;</div><div class="line">				<span class="keyword">return</span> retrieveFromScrap(mScrapViews[whichScrap], position);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Puts a view into the list of scrap views.</div><div class="line">	 * &lt;p&gt;</div><div class="line">	 * If the list data hasn't changed or the adapter has stable IDs, views</div><div class="line">	 * with transient state will be preserved for later retrieval.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> scrap The view to add</div><div class="line">	 * <span class="doctag">@param</span> position The view's position within its parent</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addScrapView</span><span class="params">(View scrap, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</div><div class="line">		<span class="keyword">if</span> (lp == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		lp.scrappedFromPosition = position;</div><div class="line"></div><div class="line">		<span class="comment">// Remove but don't scrap header or footer views, or views that</span></div><div class="line">		<span class="comment">// should otherwise not be recycled.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> viewType = lp.viewType;</div><div class="line">		<span class="keyword">if</span> (!shouldRecycleViewType(viewType)) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		scrap.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">		<span class="comment">// The the accessibility state of the view may change while temporary</span></div><div class="line">		<span class="comment">// detached and we do not allow detached views to fire accessibility</span></div><div class="line">		<span class="comment">// events. So we are announcing that the subtree changed giving a chance</span></div><div class="line">		<span class="comment">// to clients holding on to a view in this subtree to refresh it.</span></div><div class="line">		notifyViewAccessibilityStateChangedIfNeeded(</div><div class="line">				AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);</div><div class="line">		</div><div class="line">		<span class="comment">// 对一些瞬态View的处理</span></div><div class="line">		<span class="comment">// Don't scrap views that have transient state.</span></div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();</div><div class="line">		<span class="keyword">if</span> (scrapHasTransientState) &#123;</div><div class="line">			<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">				<span class="comment">// If the adapter has stable IDs, we can reuse the view for</span></div><div class="line">				<span class="comment">// the same data.</span></div><div class="line">				<span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">					mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mTransientStateViewsById.put(lp.itemId, scrap);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">				<span class="comment">// If the data hasn't changed, we can reuse the views at</span></div><div class="line">				<span class="comment">// their old positions.</span></div><div class="line">				<span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">					mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mTransientStateViews.put(position, scrap);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Otherwise, we'll have to remove the view and start over.</span></div><div class="line">				<span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">					mSkippedScrap = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">				&#125;</div><div class="line">				mSkippedScrap.add(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">				mCurrentScrap.add(scrap);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				mScrapViews[viewType].add(scrap);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (mRecyclerListener != <span class="keyword">null</span>) &#123;</div><div class="line">				mRecyclerListener.onMovedToScrapHeap(scrap);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Finish the removal of any views that skipped the scrap heap.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeSkippedScrap</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = mSkippedScrap.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			removeDetachedView(mSkippedScrap.get(i), <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		mSkippedScrap.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Move all views remaining in mActiveViews to mScrapViews.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">scrapActiveViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> hasListener = mRecyclerListener != <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> multipleScraps = mViewTypeCount &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line">		ArrayList&lt;View&gt; scrapViews = mCurrentScrap;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">			<span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">			<span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">final</span> AbsListView.LayoutParams lp</div><div class="line">						= (AbsListView.LayoutParams) victim.getLayoutParams();</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> whichScrap = lp.viewType;</div><div class="line"></div><div class="line">				activeViews[i] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (victim.hasTransientState()) &#123;</div><div class="line">					<span class="comment">// Store views with transient state for later use.</span></div><div class="line">					victim.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">						<span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">							mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">						&#125;</div><div class="line">						<span class="keyword">long</span> id = mAdapter.getItemId(mFirstActivePosition + i);</div><div class="line">						mTransientStateViewsById.put(id, victim);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">						<span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">							mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">						&#125;</div><div class="line">						mTransientStateViews.put(mFirstActivePosition + i, victim);</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">						<span class="comment">// The data has changed, we can't keep this view.</span></div><div class="line">						removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!shouldRecycleViewType(whichScrap)) &#123;</div><div class="line">					<span class="comment">// Discard non-recyclable views except headers/footers.</span></div><div class="line">					<span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">						removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// Store everything else on the appropriate scrap heap.</span></div><div class="line">					<span class="keyword">if</span> (multipleScraps) &#123;</div><div class="line">						scrapViews = mScrapViews[whichScrap];</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					victim.dispatchStartTemporaryDetach();</div><div class="line">					lp.scrappedFromPosition = mFirstActivePosition + i;</div><div class="line">					scrapViews.add(victim);</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (hasListener) &#123;</div><div class="line">						mRecyclerListener.onMovedToScrapHeap(victim);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		pruneScrapViews();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Makes sure that the size of mScrapViews does not exceed the size of</div><div class="line">	 * mActiveViews, which can happen if an adapter does not recycle its</div><div class="line">	 * views. Removes cached transient state views that no longer have</div><div class="line">	 * transient state.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneScrapViews</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> maxViews = mActiveViews.length;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">		<span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">			<span class="keyword">int</span> size = scrapPile.size();</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> extras = size - maxViews;</div><div class="line">			size--;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; extras; j++) &#123;</div><div class="line">				removeDetachedView(scrapPile.remove(size--), <span class="keyword">false</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> SparseArray&lt;View&gt; transViewsByPos = mTransientStateViews;</div><div class="line">		<span class="keyword">if</span> (transViewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsByPos.size(); i++) &#123;</div><div class="line">				<span class="keyword">final</span> View v = transViewsByPos.valueAt(i);</div><div class="line">				<span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">					removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">					transViewsByPos.removeAt(i);</div><div class="line">					i--;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> LongSparseArray&lt;View&gt; transViewsById = mTransientStateViewsById;</div><div class="line">		<span class="keyword">if</span> (transViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsById.size(); i++) &#123;</div><div class="line">				<span class="keyword">final</span> View v = transViewsById.valueAt(i);</div><div class="line">				<span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">					removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">					transViewsById.removeAt(i);</div><div class="line">					i--;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Puts all views in the scrap heap into the supplied list.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reclaimScrapViews</span><span class="params">(List&lt;View&gt; views)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			views.addAll(mCurrentScrap);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">				views.addAll(scrapPile);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Updates the cache color hint of all known views.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> color The new cache color hint.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setCacheColorHint</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">				scrap.get(i).setDrawingCacheBackgroundColor(color);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">				<span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">				<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">					scrap.get(j).setDrawingCacheBackgroundColor(color);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Just in case this is called during a layout pass</span></div><div class="line">		<span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">			<span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">			<span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">				victim.setDrawingCacheBackgroundColor(color);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">retrieveFromScrap</span><span class="params">(ArrayList&lt;View&gt; scrapViews, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> size = scrapViews.size();</div><div class="line">		<span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// See if we still have a view for this position or ID.</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">				<span class="keyword">final</span> View view = scrapViews.get(i);</div><div class="line">				<span class="keyword">final</span> AbsListView.LayoutParams params =</div><div class="line">						(AbsListView.LayoutParams) view.getLayoutParams();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (mAdapterHasStableIds) &#123;</div><div class="line">					<span class="keyword">final</span> <span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">					<span class="keyword">if</span> (id == params.itemId) &#123;</div><div class="line">						<span class="keyword">return</span> scrapViews.remove(i);</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.scrappedFromPosition == position) &#123;</div><div class="line">					<span class="keyword">final</span> View scrap = scrapViews.remove(i);</div><div class="line">					clearAccessibilityFromScrap(scrap);</div><div class="line">					<span class="keyword">return</span> scrap;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">final</span> View scrap = scrapViews.remove(size - <span class="number">1</span>);</div><div class="line">			clearAccessibilityFromScrap(scrap);</div><div class="line">			<span class="keyword">return</span> scrap;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearScrap</span><span class="params">(<span class="keyword">final</span> ArrayList&lt;View&gt; scrap)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">			removeDetachedView(scrap.remove(scrapCount - <span class="number">1</span> - j), <span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAccessibilityFromScrap</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">		view.clearAccessibilityFocus();</div><div class="line">		view.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeDetachedView</span><span class="params">(View child, <span class="keyword">boolean</span> animate)</span> </span>&#123;</div><div class="line">		child.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">		AbsListView.<span class="keyword">this</span>.removeDetachedView(child, animate);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到此为止。</p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2015/01/01/ListView源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Retrofit详解(下)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/02/Retrofit详解(下)/">Retrofit详解(下)</a>
    </h1>
  

        
        <a href="/2014/11/02/Retrofit详解(下)/" class="archive-article-date">
  	<time datetime="2014-11-01T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2014-11-02</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Retrofit详解-下"><a href="#Retrofit详解-下" class="headerlink" title="Retrofit详解(下)"></a>Retrofit详解(下)</h1><p>上一篇文件介绍了<code>Retrofit</code>的基本使用，接下来我们通过从源码的角度分析一下<code>Retrofit</code>的实现。    </p>
<p>首先看一下它的基本使用方法:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1</span></div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">        .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">        .addConverterFactory(GsonConverterFactory.create())</div><div class="line">        .build();</div><div class="line"><span class="comment">// 2</span></div><div class="line">GitHubService gitHubService = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line"><span class="comment">// 3</span></div><div class="line">Call&lt;List&lt;Repo&gt;&gt; call = gitHubService.listRepos(<span class="string">"CharonChui"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 4</span></div><div class="line">call.enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Repo&gt;&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Response&lt;List&lt;Repo&gt;&gt; response)</span> </span>&#123;</div><div class="line">        List&lt;Repo&gt; data = response.body();</div><div class="line">        Log.i(<span class="string">"@@@"</span>, <span class="string">"data size : "</span> + (data == <span class="keyword">null</span> ? <span class="string">"null"</span> : data.size() + <span class="string">""</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Throwable t)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我把上面主要分为4个部分，接下来逐一分析:    </p>
<h2 id="1-创建Retrofit并进行配置。"><a href="#1-创建Retrofit并进行配置。" class="headerlink" title="1. 创建Retrofit并进行配置。"></a>1. 创建<code>Retrofit</code>并进行配置。</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">  .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">  .addConverterFactory(GsonConverterFactory.create())</div><div class="line">  .build();</div></pre></td></tr></table></figure>
<p>简单的一句话，却埋藏了很多。     </p>
<p>这是典型的<strong><em>建造者模式、外观模式</em></strong>      </p>
<p>就想平时我们写的下载模块，作为一个公共的模块，我们可以对外提供一个<code>DownloadManager</code>供外界使用，而对于里面的实现我们完全可以闭门造车。    </p>
<p>具体<code>baseUrl()</code>、<code>addConverterFactory()</code>方法里面的具体实现就不去看了，比较简单。当然这里也用到了<strong><em>工厂设计模式</em></strong>。</p>
<h2 id="2-创建对应的服务类"><a href="#2-创建对应的服务类" class="headerlink" title="2. 创建对应的服务类"></a>2. 创建对应的服务类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GitHubService gitHubService = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure>
<p>这一部分是如何实现的呢？我们看一下<code>retrofit.create()</code>方法的实现:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">    Utils.validateServiceInterface(service);</div><div class="line">    <span class="keyword">if</span> (validateEagerly) &#123;</div><div class="line">      eagerlyValidateMethods(service);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">          <span class="comment">// 这里的Platform主要是为了检测当前的运行平台，是java还是android，会根据当前的平台来返回默认的CallAdapter</span></div><div class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span></span></div><div class="line">              <span class="keyword">throws</span> Throwable &#123;</div><div class="line">            <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></div><div class="line">            <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">              <span class="comment">// 代理调用</span></div><div class="line">              <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</div><div class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 1，根据动态代理的方法去生成ServiceMethod这里动态代理的方法就是listRepos方法</span></div><div class="line">            ServiceMethod serviceMethod = loadServiceMethod(method);</div><div class="line">            <span class="comment">// 2，根绝ServiceMethod和参数去生成OkHttpCall，这里args是CharonChui</span></div><div class="line">            OkHttpCall okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">            <span class="comment">// 3, serviceMethod去进行处理并返回Call对象，拿到这个Call对象才能去执行网络请求。</span></div><div class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>看到<code>Proxy.newProxyInstance()</code>就明白了，这里使用了<strong><em>动态代理</em></strong>。简单的说动态代理是在你要调用某个<code>Class</code>的方法前或后，插入你想要执行的代码。那这里要代理的是什么方法？ <code>Call&lt;List&lt;Repo&gt;&gt; call = gitHubService.listRepos(&quot;CharonChui&quot;);</code>，这里就是<code>listRepos()</code>方法。   就是说在调用<code>listRepos()</code>方法时会被动态代理所拦截，然后执行<code>Proxy.newProxyInstance()</code>里面的<code>InvocationHandler.invoke()</code>中的部分。   而<code>invoke()</code>方法的三个参数分别是啥？ 分别是<code>Object proxy</code>: 代理对象，<code>Method method</code>：调用的方法，就是<code>listRepos()</code>方法，<code>Object... args</code>：方法的参数，这里是<code>CharonChui</code>。   </p>
<p>有关动态代理介绍可以看<a href="">张孝祥老师的java1.5高新技术系列中的动态代理</a></p>
<p>这里就不仔细介绍动态代理了，上面的代码中又分为三部分:    </p>
<ul>
<li><code>loadServiceMethod()</code></li>
<li><code>new OkHttpCall()</code></li>
<li><code>serviceMethod.callAdapter.adapt()</code></li>
</ul>
<p>我们这里分别来进行分析。    </p>
<ul>
<li><p><code>loadServiceMethod()</code><br>  实现如下:   </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function">ServiceMethod <span class="title">loadServiceMethod</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">    ServiceMethod result;</div><div class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</div><div class="line">      <span class="comment">// ServiceMethod包含了请求的所有相关数据，以及获取请求的request和把请求结果转换成java对象，所以相比较而言较重，用缓存来提高效率。</span></div><div class="line">      result = serviceMethodCache.get(method);</div><div class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// build</span></div><div class="line">        result = <span class="keyword">new</span> ServiceMethod.Builder(<span class="keyword">this</span>, method).build();</div><div class="line">        serviceMethodCache.put(method, result);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>会通过缓存的方式来获取一个`ServiceMethod`类。通过缓存来保证同一个`API`的同一个方法只会创建一次。 
有关`ServiceMethod`类的文档介绍是:     
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Adapts an invocation of an <span class="class"><span class="keyword">interface</span> <span class="title">method</span> <span class="title">into</span> <span class="title">an</span> <span class="title">HTTP</span> <span class="title">call</span>.</span></div></pre></td></tr></table></figure>

大体翻译一下就是将一个请求接口的方法转换到`Http Call`中调用。    

而上面第一次使用的时候会通过`new ServiceMethod.Builder(this, method).build()`创建，那我们看一下它的实现:    

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// 创建CallAdapter用来代理Call</span></div><div class="line">      callAdapter = createCallAdapter();</div><div class="line">      responseType = callAdapter.responseType();</div><div class="line">      <span class="keyword">if</span> (responseType == Response.class || responseType == okhttp3.Response.class) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"'"</span></div><div class="line">            + Utils.getRawType(responseType).getName()</div><div class="line">            + <span class="string">"' is not a valid response body type. Did you mean ResponseBody?"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// responseConverter用来解析结果将json等返回结果解析成java对象</span></div><div class="line">      responseConverter = createResponseConverter();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">        parseMethodAnnotation(annotation);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (httpMethod == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"HTTP method annotation is required (e.g., @GET, @POST, etc.)."</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!hasBody) &#123;</div><div class="line">        <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">          <span class="keyword">throw</span> methodError(</div><div class="line">              <span class="string">"Multipart can only be specified on HTTP methods with request body (e.g., @POST)."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">          <span class="keyword">throw</span> methodError(<span class="string">"FormUrlEncoded can only be specified on HTTP methods with "</span></div><div class="line">              + <span class="string">"request body (e.g., @POST)."</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">      parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">        Type parameterType = parameterTypes[p];</div><div class="line">        <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</div><div class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"Parameter type must not include a type variable or wildcard: %s"</span>,</div><div class="line">              parameterType);</div><div class="line">        &#125;</div><div class="line">		<span class="comment">//  解析对应method的注解，这里是listRepos方法的注解。</span></div><div class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">        <span class="keyword">if</span> (parameterAnnotations == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 通过注解和参数类型，解析并赋值到parameterHandlers中</span></div><div class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (relativeUrl == <span class="keyword">null</span> &amp;&amp; !gotUrl) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Missing either @%s URL or @Url parameter."</span>, httpMethod);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Non-body HTTP method cannot contain @Body."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (isFormEncoded &amp;&amp; !gotField) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Form-encoded method must contain at least one @Field."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (isMultipart &amp;&amp; !gotPart) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Multipart method must contain at least one @Part."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 创建`ServiceMethod()`对象</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

总起来说，就是创建`CallAdapter`、`responseConverter`、解析注解、设置参数，然后创建`ServiceMethod`对象。   

而`ServiceMethod`的构造函数如下:    
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ServiceMethod(Builder&lt;T&gt; builder) &#123;</div><div class="line">    <span class="keyword">this</span>.callFactory = builder.retrofit.callFactory();</div><div class="line">    <span class="keyword">this</span>.callAdapter = builder.callAdapter;</div><div class="line">    <span class="keyword">this</span>.baseUrl = builder.retrofit.baseUrl();</div><div class="line">    <span class="keyword">this</span>.responseConverter = builder.responseConverter;</div><div class="line">    <span class="keyword">this</span>.httpMethod = builder.httpMethod;</div><div class="line">    <span class="keyword">this</span>.relativeUrl = builder.relativeUrl;</div><div class="line">    <span class="keyword">this</span>.headers = builder.headers;</div><div class="line">    <span class="keyword">this</span>.contentType = builder.contentType;</div><div class="line">    <span class="keyword">this</span>.hasBody = builder.hasBody;</div><div class="line">    <span class="keyword">this</span>.isFormEncoded = builder.isFormEncoded;</div><div class="line">    <span class="keyword">this</span>.isMultipart = builder.isMultipart;</div><div class="line">    <span class="keyword">this</span>.parameterHandlers = builder.parameterHandlers;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>


看到吗？ 这一部分我们应该都稍微有点印象，因为在上一篇文章介绍使用方法的时候，基本会用到这里。 
</code></pre><p>至于这里的<code>CallAdapter</code>、<code>ResponseConverter</code>、<code>Headers</code>、<code>ParamterHandlers</code>等这里就不分析了，最后我们再简单介绍下。</p>
<ul>
<li><p>创建<code>OkHttpCall</code></p>
<p>  接下来会创建<code>OkHttpCall</code>，而<code>OkHttpCall</code>是<code>Call</code>的子类，那<code>Call</code>是什么鬼？ 它是具体的网络请求类。</p>
<p>  文档中对<code>Call</code>类的介绍如下:    </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * An invocation of a Retrofit method that sends a request to a webserver and returns a response.</div><div class="line"> * Each call yields its own HTTP request and response pair. Use &#123;<span class="doctag">@link</span> #clone&#125; to make multiple</div><div class="line"> * calls with the same parameters to the same webserver; this may be used to implement polling or</div><div class="line"> * to retry a failed call.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Calls may be executed synchronously with &#123;<span class="doctag">@link</span> #execute&#125;, or asynchronously with &#123;<span class="doctag">@link</span></div><div class="line"> * #enqueue&#125;. In either case the call can be canceled at any time with &#123;<span class="doctag">@link</span> #cancel&#125;. A call that</div><div class="line"> * is busy writing its request or reading its response may receive a &#123;<span class="doctag">@link</span> IOException&#125;; this is</div><div class="line"> * working as designed.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> &lt;T&gt; Successful response body type.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Cloneable</span> </span>&#123;</div><div class="line">	<span class="comment">// 这里我特地把这句话放上，Call集成了Cloneable接口。</span></div><div class="line">	<span class="comment">// 每一个 call 对象实例只能被用一次，所以说 request 和 response 都是一一对应的。你其实可以通过 Clone 方法来创建一个一模一样的实例，这个开销是很小的。比如说：你可以在每次决定发请求前 clone 一个之前的实例。</span></div><div class="line">	....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>`Retrofit`底层默认使用`OkHttp`，所以当然要创建`OkHttpCall`了。    

- `serviceMethod.callAdapter.adapt(okHttpCall)`

这个`CallApdater`是什么鬼？   

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adapts a &#123;<span class="doctag">@link</span> Call&#125; into the type of &#123;<span class="doctag">@code</span> T&#125;. Instances are created by &#123;<span class="doctag">@linkplain</span> Factory a</div><div class="line"> * factory&#125; which is &#123;<span class="doctag">@linkplain</span> Retrofit.Builder#addCallAdapterFactory(Factory) installed&#125; into</div><div class="line"> * the &#123;<span class="doctag">@link</span> Retrofit&#125; instance.</div><div class="line"> */</div></pre></td></tr></table></figure>


可以很简单的看出来这是一个结果类型转换的类。就是`Call`的适配器，作用就是创建/转换`Call`对象，把`Call`转换成预期的格式。`CallAdatper`创建是通过`CallAdapter.factory`工厂类进行的。`DefaultCallAdapter`为`Retrofit2`自带默认`Call`转换器，用来生成`OKHTTP`的`call`请求调用。


而它里面的`adapt()`方法的作用呢？ 

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Returns an instance of &#123;<span class="doctag">@code</span> T&#125; which delegates to &#123;<span class="doctag">@code</span> call&#125;.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * For example, given an instance for a hypothetical utility, &#123;<span class="doctag">@code</span> Async&#125;, this instance would</div><div class="line">   * return a new &#123;<span class="doctag">@code</span> Async&lt;R&gt;&#125; which invoked &#123;<span class="doctag">@code</span> call&#125; when run.</div><div class="line">   * &lt;pre&gt;&lt;code&gt;</div><div class="line">   * &amp;#64;Override</div><div class="line">   * public &amp;lt;R&amp;gt; Async&amp;lt;R&amp;gt; adapt(final Call&amp;lt;R&amp;gt; call) &#123;</div><div class="line">   *   return Async.create(new Callable&amp;lt;Response&amp;lt;R&amp;gt;&amp;gt;() &#123;</div><div class="line">   *     &amp;#64;Override</div><div class="line">   *     public Response&amp;lt;R&amp;gt; call() throws Exception &#123;</div><div class="line">   *       return call.execute();</div><div class="line">   *     &#125;</div><div class="line">   *   &#125;);</div><div class="line">   * &#125;</div><div class="line">   * &lt;/code&gt;&lt;/pre&gt;</div><div class="line">   */</div><div class="line">  &lt;R&gt; <span class="function">T <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span></span>;</div></pre></td></tr></table></figure>


所以分析到这里我们基本明白了`retrofit.create()`方法的作用，就是将请求接口的服务类转换成`Call`，然后将`Call`的结果转换成实体类。
</code></pre><h2 id="3-调用方法，得到Call对象"><a href="#3-调用方法，得到Call对象" class="headerlink" title="3. 调用方法，得到Call对象"></a>3. 调用方法，得到<code>Call</code>对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Call&lt;List&lt;Repo&gt;&gt; call = gitHubService.listRepos(<span class="string">"CharonChui"</span>);</div></pre></td></tr></table></figure>
<p>这个就不分析了，就是在<code>ServiceMethod</code>中返回的<code>Call</code>。</p>
<h2 id="4-调用Call-enqueue"><a href="#4-调用Call-enqueue" class="headerlink" title="4. 调用Call.enqueue()"></a>4. 调用<code>Call.enqueue()</code></h2><p>在上面分析了，这个<code>Call</code>其实是<code>OkHttpCall</code>，那我们来看一下<code>OkHttpCall.enqueue()</code>方法的实现:     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line"></div><div class="line">    okhttp3.Call call;</div><div class="line">    Throwable failure;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already executed."</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">      call = rawCall;</div><div class="line">      failure = creationFailure;</div><div class="line">      <span class="keyword">if</span> (call == <span class="keyword">null</span> &amp;&amp; failure == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// 调用createRawCall()方法创建Call</span></div><div class="line">          call = rawCall = createRawCall();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          failure = creationFailure = t;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (failure != <span class="keyword">null</span>) &#123;</div><div class="line">      callback.onFailure(<span class="keyword">this</span>, failure);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (canceled) &#123;</div><div class="line">      call.cancel();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 把请求任务加入到okhttp的请求队列中，执行网络请求，注意这里的Call是okhttp3.Call</span></div><div class="line">    call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span></span></div><div class="line">          <span class="keyword">throws</span> IOException &#123;</div><div class="line">        Response&lt;T&gt; response;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// 解析结果，该方法内部会将OkHttp中Request的执行结果转换成对应的Java对象。</span></div><div class="line">          response = parseResponse(rawResponse);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">          callFailure(e);</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        callSuccess(response);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          t.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callFailure</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          t.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callSuccess</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          callback.onResponse(OkHttpCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          t.printStackTrace();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>上面的部分也主要分为三部分:    </p>
<ul>
<li>创建Call</li>
<li>执行网络请求</li>
<li>解析结果 </li>
</ul>
<h4 id="第一部分：创建Call"><a href="#第一部分：创建Call" class="headerlink" title="第一部分：创建Call"></a>第一部分：创建<code>Call</code></h4><p>我们分别进行分析，首先是<code>createRawCall()</code>方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="comment">// ServiceMethod.toRequest()方法的作用是将ServiceMethod中的网络请求相关的数据转换成一个OkHttp的网络请求所需要的Request对象。因为之前分析过所有Retrofit解析的网络请求相关的数据都是在ServiceMethod中</span></div><div class="line">  Request request = serviceMethod.toRequest(args);</div><div class="line">  <span class="comment">// 调用Factory.newCall方法</span></div><div class="line">  okhttp3.Call call = serviceMethod.callFactory.newCall(request);</div><div class="line">  <span class="keyword">if</span> (call == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> call;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后看一下<code>Factory.newCall()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">    <span class="function">Call <span class="title">newCall</span><span class="params">(Request request)</span></span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>它的实现类是<code>OkHttpClient</code>类中的<code>newCall()</code>方法，并且创建<code>RealCall</code>对象:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RealCall(<span class="keyword">this</span>, request);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h4 id="第二部分：执行网络请求"><a href="#第二部分：执行网络请求" class="headerlink" title="第二部分：执行网络请求"></a>第二部分：执行网络请求</h4><p>这一部分是在<code>call.enqueue()</code>方法中执行的，上面我们分析了创建的<code>Call</code>最终是<code>RealCall</code>类，所以这里直接到看<code>RealCall.enqueue()</code>方法:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</div><div class="line">    enqueue(responseCallback, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 调用OkHttpClient中的Dispatcher中的enqueue方法</span></div><div class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback, forWebSocket));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们接着看<code>client.dispatcher().enqueue()</code>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(AsyncCall call)</span> </span>&#123;</div><div class="line">    <span class="comment">// maxRequests的个数是64;</span></div><div class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</div><div class="line">      runningAsyncCalls.add(call);</div><div class="line">      <span class="comment">// 线程池执行</span></div><div class="line">      executorService().execute(call);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      readyAsyncCalls.add(call);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">```   </div><div class="line"></div><div class="line">而这个参数`AsyncCall`是什么鬼？ 它是`RealCall`的内部类，它里面的`execute()`方法是如何实现的？ 只要找到该方法的实现就算是完成了。     </div><div class="line"></div><div class="line">首先看一下`AsyncCall`的声明和构造:    </div><div class="line">```java</div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span> <span class="keyword">extends</span> <span class="title">NamedRunnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Callback responseCallback;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AsyncCall</span><span class="params">(Callback responseCallback, <span class="keyword">boolean</span> forWebSocket)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(<span class="string">"OkHttp %s"</span>, redactedUrl().toString());</div><div class="line">      <span class="keyword">this</span>.responseCallback = responseCallback;</div><div class="line">      <span class="keyword">this</span>.forWebSocket = forWebSocket;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><code>NamedRunnable</code>是<code>Runnable</code>的实现类。我们看一下它的<code>execute()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 获取请求结果</span></div><div class="line">        Response response = getResponseWithInterceptorChain(forWebSocket);</div><div class="line">        <span class="keyword">if</span> (canceled) &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          <span class="comment">// 将响应结果设置给之前构造函数传递回来的回调</span></div><div class="line">          responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">          <span class="comment">// Do not signal the callback twice!</span></div><div class="line">          Platform.get().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>接着看一下<code>RealCall.getResponseWithInterceptorChain()</code>:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Response <span class="title">getResponseWithInterceptorChain</span><span class="params">(<span class="keyword">boolean</span> forWebSocket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Interceptor.Chain chain = <span class="keyword">new</span> ApplicationInterceptorChain(<span class="number">0</span>, originalRequest, forWebSocket);</div><div class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInterceptorChain</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Chain</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Request request;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line"></div><div class="line">    ApplicationInterceptorChain(<span class="keyword">int</span> index, Request request, <span class="keyword">boolean</span> forWebSocket) &#123;</div><div class="line">      <span class="keyword">this</span>.index = index;</div><div class="line">      <span class="keyword">this</span>.request = request;</div><div class="line">      <span class="keyword">this</span>.forWebSocket = forWebSocket;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Connection <span class="title">connection</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      <span class="comment">// If there's another interceptor in the chain, call that.</span></div><div class="line">      <span class="keyword">if</span> (index &lt; client.interceptors().size()) &#123;</div><div class="line">        Interceptor.Chain chain = <span class="keyword">new</span> ApplicationInterceptorChain(index + <span class="number">1</span>, request, forWebSocket);</div><div class="line">        Interceptor interceptor = client.interceptors().get(index);</div><div class="line">        Response interceptedResponse = interceptor.intercept(chain);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (interceptedResponse == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"application interceptor "</span> + interceptor</div><div class="line">              + <span class="string">" returned null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> interceptedResponse;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// No more interceptors. Do HTTP.</span></div><div class="line">      <span class="keyword">return</span> getResponse(request, forWebSocket);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>又会调用<code>getResponse()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Performs the request and returns the response. May return null if this call was canceled.</div><div class="line">   */</div><div class="line">  <span class="function">Response <span class="title">getResponse</span><span class="params">(Request request, <span class="keyword">boolean</span> forWebSocket)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// Copy body metadata to the appropriate request headers.</span></div><div class="line">    RequestBody body = request.body();</div><div class="line">    <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</div><div class="line">      Request.Builder requestBuilder = request.newBuilder();</div><div class="line"></div><div class="line">      MediaType contentType = body.contentType();</div><div class="line">      <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Content-Type"</span>, contentType.toString());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">long</span> contentLength = body.contentLength();</div><div class="line">      <span class="keyword">if</span> (contentLength != -<span class="number">1</span>) &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Content-Length"</span>, Long.toString(contentLength));</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>);</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      request = requestBuilder.build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Create the initial HTTP engine. Retries and redirects need new engine for each attempt.</span></div><div class="line">    engine = <span class="keyword">new</span> HttpEngine(client, request, <span class="keyword">false</span>, <span class="keyword">false</span>, forWebSocket, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> followUpCount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (canceled) &#123;</div><div class="line">        engine.releaseStreamAllocation();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">boolean</span> releaseConnection = <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        engine.sendRequest();</div><div class="line">        engine.readResponse();</div><div class="line">        releaseConnection = <span class="keyword">false</span>;</div><div class="line">      &#125; <span class="keyword">catch</span> (RequestException e) &#123;</div><div class="line">        <span class="comment">// The attempt to interpret the request failed. Give up.</span></div><div class="line">        <span class="keyword">throw</span> e.getCause();</div><div class="line">      &#125; <span class="keyword">catch</span> (RouteException e) &#123;</div><div class="line">        <span class="comment">// The attempt to connect via a route failed. The request will not have been sent.</span></div><div class="line">        HttpEngine retryEngine = engine.recover(e.getLastConnectException(), <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (retryEngine != <span class="keyword">null</span>) &#123;</div><div class="line">          releaseConnection = <span class="keyword">false</span>;</div><div class="line">          engine = retryEngine;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Give up; recovery is not possible.</span></div><div class="line">        <span class="keyword">throw</span> e.getLastConnectException();</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="comment">// An attempt to communicate with a server failed. The request may have been sent.</span></div><div class="line">        HttpEngine retryEngine = engine.recover(e, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (retryEngine != <span class="keyword">null</span>) &#123;</div><div class="line">          releaseConnection = <span class="keyword">false</span>;</div><div class="line">          engine = retryEngine;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Give up; recovery is not possible.</span></div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">// We're throwing an unchecked exception. Release any resources.</span></div><div class="line">        <span class="keyword">if</span> (releaseConnection) &#123;</div><div class="line">          StreamAllocation streamAllocation = engine.close();</div><div class="line">          streamAllocation.release();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Response response = engine.getResponse();</div><div class="line">      Request followUp = engine.followUpRequest();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (followUp == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!forWebSocket) &#123;</div><div class="line">          engine.releaseStreamAllocation();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      StreamAllocation streamAllocation = engine.close();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (++followUpCount &gt; MAX_FOLLOW_UPS) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"Too many follow-up requests: "</span> + followUpCount);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!engine.sameConnection(followUp.url())) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        streamAllocation = <span class="keyword">null</span>;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (streamAllocation.stream() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Closing the body of "</span> + response</div><div class="line">            + <span class="string">" didn't close its backing stream. Bad interceptor?"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      request = followUp;</div><div class="line">      engine = <span class="keyword">new</span> HttpEngine(client, request, <span class="keyword">false</span>, <span class="keyword">false</span>, forWebSocket, streamAllocation, <span class="keyword">null</span>,</div><div class="line">          response);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>完了没有？ 完了….</p>
<p>上面只是简单的分析了下大体的调用流程和主要的类，但是好像并没有什么乱用，因为没有具体的去分析里面各部分的实现，如果都分析下来内容太多了。这里就不仔细看了，大体总结一下。    </p>
<p>通过上面的分析，最终的网络请求是在<code>OkHttp</code>的<code>Call</code>中去执行，也就是说<code>Retrofit</code>其实是将一个<code>Java</code>接口通过注解等方式来解析参数等然后转换成一个请求交给<code>OkHttp</code>去执行，然后将执行结果进行解析转换暴露给上层调用者。<br>而这一切是如何实现的呢？<br><code>Retrofit</code>非常巧妙的用注解来描述一个<code>HTTP</code>请求，将一个<code>HTTP</code>请求抽象成一个<code>Java</code>接口，然后用了<code>动态代理</code>的方式，动态的将这个接口的注解转换成一个<code>HTTP</code>请求，然后再将这个<code>Http</code>请求交给<code>OkHttp</code>执行。</p>
<p>动态代理用的太妙，而它的过程中也使用了大量的工厂模式，这里就不分析了。</p>
<p>参考:   </p>
<ul>
<li><a href="https://realm.io/news/droidcon-jake-wharton-simple-http-retrofit-2" target="_blank" rel="external">simple-http-retrofit-2</a></li>
<li><a href="http://square.github.io/retrofit/2.x/retrofit/" target="_blank" rel="external">Retrofit API</a></li>
</ul>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2014/11/02/Retrofit详解(下)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Retrofit详解(上)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/01/Retrofit详解(上)/">Retrofit详解(上)</a>
    </h1>
  

        
        <a href="/2014/11/01/Retrofit详解(上)/" class="archive-article-date">
  	<time datetime="2014-10-31T17:11:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2014-11-01</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Retrofit详解-上"><a href="#Retrofit详解-上" class="headerlink" title="Retrofit详解(上)"></a>Retrofit详解(上)</h1><p>之前写过一篇文章<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/volley-retrofit-okhttp%E4%B9%8B%E6%88%91%E4%BB%AC%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%BD%91%E8%B7%AF%E6%A1%86%E6%9E%B6.md">volley-retrofit-okhttp之我们该如何选择网路框架</a>来分析<code>Volley</code>与<code>Retrofit</code>之间的区别。之前一直用<code>Volley</code>比较多。但是随着<code>Rx</code>系列的走红，目前越来越多的项目使用<code>RxJava+Retrofit</code>这一黄金组合。而且<code>Retrofit</code>使用注解的方式比较方便以及<code>2.x</code>版本的提示让<code>Retrofit</code>更加完善，今天简单的来学习记录下。</p>
<ul>
<li>有关更多<code>Volley</code>的知识请查看<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/Volley%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md">Volley源码分析</a>      </li>
<li>有关注解更多的知识请查看<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8.md">注解使用</a></li>
<li>有关更多[RxJava]的介绍请查看<a href="https://github.com/CharonChui/AndroidNote/blob/master/Android%E5%8A%A0%E5%BC%BA/RxJava%E8%AF%A6%E8%A7%A3(%E4%B8%8A">Rx详解系列</a>.md)</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit</a></p>
<blockquote>
<p>A type-safe HTTP client for Android and Java</p>
</blockquote>
<p><code>type-safe</code>是什么鬼？<br>类型安全代码指访问被授权可以访问的内存位置。例如，类型安全代码不能从其他对象的私有字段读取值。它只从定义完善的允许方式访问类型才能读取。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p><code>Gradle</code>中集成:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.1.0'</span></div><div class="line">```  </div><div class="line">`Retrofit <span class="number">2</span>`底层默认使用自家兄弟`OKHttp`作为网络层,并且在它上面进行构建。所以不需要在想`<span class="number">1</span>.x`版本那样在</div><div class="line">项目中显式的定义`OkHttp`依赖。所以`Retrofit`与`OkHttp`的关系是后者专注与网络请求的高效优化，而前者专注于接口的封装和调用管理等。    </div><div class="line"></div><div class="line">![image](https:<span class="comment">//github.com/CharonChui/Pictures/blob/master/retrofit_okhttp_relation.jpg?raw=true)</span></div><div class="line"></div><div class="line">当然你还需要在清单文件中添加网络请求的权限:</div></pre></td></tr></table></figure>
<p><uses-permission android:name="android.permission.INTERNET"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">我们就以`Github`获取个人仓库的`api`来进行举例测试:   </div><div class="line">```java</div><div class="line">https://api.github.com/users/&#123;user&#125;/repos</div></pre></td></tr></table></figure></uses-permission></p>
<ul>
<li><p><code>Retrofit</code>会将你的<code>api</code>封装成<code>Java</code>接口   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>Retrofit</code>类会生成一个<code>GitHubService</code>接口的实现类:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">    .build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure>
</li>
<li><p>从创建的<code>GithubService</code>类返回的每个<code>Call</code>对象调用后都可以创建一个同步或异步的网络请求:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">"CharonChui"</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>上面返回的<code>Call</code>其实并不是真正的数据结果，它更像一条指令，你需要执行它:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 同步调用</span></div><div class="line">List&lt;Repo&gt; data = repos.execute(); </div><div class="line"> </div><div class="line"><span class="comment">// 异步调用</span></div><div class="line">repos.enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Repo&gt;&gt;() &#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Response&lt;List&lt;Repo&gt;&gt; response)</span> </span>&#123;</div><div class="line">      List&lt;Repo&gt; data = response.body();</div><div class="line">      Log.i(<span class="string">"@@@"</span>, <span class="string">"data size : "</span> + (data == <span class="keyword">null</span> ? <span class="string">"null"</span> : data.size() + <span class="string">""</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Throwable t)</span> </span>&#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>那如何取消请求呢？ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">repos.cancel();</div></pre></td></tr></table></figure>
</li>
</ul>
<p>上面这一部分代码，你要是拷贝运行后是运行不了的。<br>当然了，因为木有<code>Repo</code>对象。但是添加<code>Repo</code>对象也是运行不了的。会报错。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Process: com.charon.retrofitdemo, PID: <span class="number">7229</span></div><div class="line">java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;com.charon.retrofitdemo/com.charon.retrofitdemo.MainActivity&#125;: java.lang.IllegalArgumentException: Unable to create converter <span class="keyword">for</span> java.util.List&lt;com.charon.retrofitdemo.Repo&gt;</div><div class="line">   <span class="keyword">for</span> method GitHubService.listRepos</div><div class="line">   at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:<span class="number">2281</span>)</div><div class="line">   at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:<span class="number">2331</span>)</div><div class="line">   at android.app.ActivityThread.handleRelaunchActivity(ActivityThread.java:<span class="number">3974</span>)</div><div class="line">   at android.app.ActivityThread.access$<span class="number">1100</span>(ActivityThread.java:<span class="number">143</span>)</div><div class="line">   at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">1250</span>)</div><div class="line">   at android.os.Handler.dispatchMessage(Handler.java:<span class="number">102</span>)</div><div class="line">   at android.os.Looper.loop(Looper.java:<span class="number">136</span>)</div><div class="line">   at android.app.ActivityThread.main(ActivityThread.java:<span class="number">5291</span>)</div><div class="line">   at java.lang.reflect.Method.invokeNative(Native Method)</div><div class="line">   at java.lang.reflect.Method.invoke(Method.java:<span class="number">515</span>)</div><div class="line">   at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">849</span>)</div><div class="line">   at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">665</span>)</div><div class="line">   at dalvik.system.NativeStart.main(Native Method)</div><div class="line">Caused by: java.lang.IllegalArgumentException: Unable to create converter <span class="keyword">for</span> java.util.List&lt;com.charon.retrofitdemo.Repo&gt;</div><div class="line">   <span class="keyword">for</span> method GitHubService.listRepos</div><div class="line">   at retrofit2.ServiceMethod$Builder.methodError(ServiceMethod.java:<span class="number">720</span>)</div><div class="line">   at retrofit2.ServiceMethod$Builder.createResponseConverter(ServiceMethod.java:<span class="number">706</span>)</div><div class="line">   at retrofit2.ServiceMethod$Builder.build(ServiceMethod.java:<span class="number">167</span>)</div><div class="line">   at retrofit2.Retrofit.loadServiceMethod(Retrofit.java:<span class="number">166</span>)</div><div class="line">   at retrofit2.Retrofit$<span class="number">1</span>.invoke(Retrofit.java:<span class="number">145</span>)</div><div class="line">   at $Proxy0.listRepos(Native Method)</div><div class="line">   at com.charon.retrofitdemo.MainActivity$override.onCreate(MainActivity.java:<span class="number">29</span>)</div><div class="line">   at com.charon.retrofitdemo.MainActivity$override.access$dispatch(MainActivity.java)</div><div class="line">   at com.charon.retrofitdemo.MainActivity.onCreate(MainActivity.java:<span class="number">0</span>)</div><div class="line">   at android.app.Activity.performCreate(Activity.java:<span class="number">5304</span>)</div><div class="line">   at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:<span class="number">1090</span>)</div><div class="line">   at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:<span class="number">2245</span>)</div><div class="line">    ... <span class="number">12</span> more</div><div class="line">Caused by: java.lang.IllegalArgumentException: Could not locate ResponseBody converter <span class="keyword">for</span> java.util.List&lt;com.charon.retrofitdemo.Repo&gt;.</div><div class="line"> Tried:</div></pre></td></tr></table></figure>
<p>这是什么鬼?难道官方给的示例代码有问题？ 从<code>log</code>上面我们能看出来是返回的数据结构不匹配导致的，返回的是<code>ResponseBody</code>的转换器无法转换为<code>List&lt;Repo&gt;</code>。    </p>
<p><code>Retrofit</code>是一个将<code>API</code>接口转换成回调对象的类，默认情况下<code>Retrofit</code>会根绝平台提供一些默认的配置，但是它是支持配置的。   </p>
<h2 id="Converters-解析数据"><a href="#Converters-解析数据" class="headerlink" title="Converters(解析数据)"></a>Converters(解析数据)</h2><p>默认情况下，<code>Retrofit</code>只能将<code>HTTP</code>响应体反序列化为<code>OkHttp</code>的<code>ResponseBody</code>类型。并且通过<code>@Body</code>也只能接受<code>RequestBody</code>类型。    </p>
<p>可以通过添加转换器来支持其他类型。它提供了6中类似的序列化类库来方便进行使用:    </p>
<ul>
<li>Gson: com.squareup.retrofit2:converter-gson</li>
<li>Jackson: com.squareup.retrofit2:converter-jackson</li>
<li>Moshi: com.squareup.retrofit2:converter-moshi</li>
<li>Protobuf: com.squareup.retrofit2:converter-protobuf</li>
<li>Wire: com.squareup.retrofit2:converter-wire</li>
<li>Simple XML: com.squareup.retrofit2:converter-simplexml</li>
<li>Scalars (primitives, boxed, and String): com.squareup.retrofit2:converter-scalars</li>
</ul>
<p>我们这里通过<code>Gson</code>为例，讲解一下如何使用，首先需要在<code>gradle</code>文件中配置对应的支持模块。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.1.0'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:converter-gson:2.1.0'</span></div></pre></td></tr></table></figure>
<p>下面是一个通过使用<code>GsonConverterFactory</code>类来指定<code>GitHubService</code>接口使用<code>Gson</code>来解析结果的配置。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .baseUrl(<span class="string">"https://api.github.com"</span>)</div><div class="line">    .addConverterFactory(GsonConverterFactory.create())</div><div class="line">    .build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure>
<p>经过这些改造，就可以了，贴一下完整的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">    Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        </div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .build();</div><div class="line"></div><div class="line">        GitHubService service = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line">        Call&lt;List&lt;Repo&gt;&gt; call= service.listRepos(<span class="string">"CharonChui"</span>);</div><div class="line"></div><div class="line">        call.enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Repo&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Response&lt;List&lt;Repo&gt;&gt; response)</span> </span>&#123;</div><div class="line">                List&lt;Repo&gt; body = response.body();</div><div class="line">                Log.i(<span class="string">"@@@"</span>, <span class="string">"call "</span> + body.size());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Throwable t)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行上面的代码,<code>log</code>会打印出<code>12-14 14:43:38.900 21509-21509/com.charon.retrofitdemo I/@@@: call 26</code></p>
<p>到这里，我们入门的<code>Hello World</code>就完成了。 </p>
<p><code>Retrofit</code>支持的协议包括<code>GET/POST/PUT/DELETE/HEAD/PATCH</code>，当然你也可以直接用<code>HTTP</code> 来自定义请求。这些协议均以注解的形式进行配置，比如我们已经见过<code>GET</code>的用法.</p>
<p>我们发现在<code>Retrofit</code>创建的时候需要传入一个<code>baseUrl(https://api.github.com/)</code>，在<code>GitHubService</code>中会通过注解设置<code>@GET(&quot;users/{user}/repos&quot;)</code>，请求的完整<code>Url</code>就是通过<code>baseUrl</code>与注解的<code>value</code>也就是<code>path</code>路径结合起来组成。虽然提供了多种规则，但是统一使用下面这一种是最好的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">通过注解的value指定的是相对路径，baseUrl是目录形式：</div><div class="line">path = <span class="string">"users/CharonChui/repos"</span>，baseUrl = <span class="string">"https://api.github.com/"</span></div><div class="line">Url = <span class="string">"https://api.github.com/users/CharonChui/repos"</span></div></pre></td></tr></table></figure></p>
<p>上面介绍的例子中使用的是<code>@Path</code>。 </p>
<h2 id="Query及-QueryMap"><a href="#Query及-QueryMap" class="headerlink" title="@Query及@QueryMap"></a><code>@Query</code>及<code>@QueryMap</code></h2><p>假设我们有一个分页查询的功能:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GET(<span class="string">"/list"</span>)</div><div class="line"><span class="function">Call&lt;ResponseBody&gt; <span class="title">list</span><span class="params">(@Query(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>;</div></pre></td></tr></table></figure></p>
<p>这就相当于<code>https://api.github.com/list?page=1</code>这种。<code>Query</code>其实就是<code>Url</code>中<code>?</code>后面的<code>k-v</code>。而<code>QueryMap</code>就是多个查询条件。     </p>
<h2 id="Field及-FieldMap"><a href="#Field及-FieldMap" class="headerlink" title="@Field及@FieldMap"></a><code>@Field</code>及<code>@FieldMap</code></h2><p>用<code>Post</code>的场景相对比较多，绝大多数的服务端接口要做加密、校验等。所以使用<code>Post</code>提交表单的场景就会很多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FormUrlEncoded</span></div><div class="line"><span class="meta">@POST</span>(<span class="string">"user/edit"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">updateUser</span><span class="params">(@Field(<span class="string">"first_name"</span>)</span> String first, @<span class="title">Field</span><span class="params">(<span class="string">"last_name"</span>)</span> String last)</span>;</div></pre></td></tr></table></figure>
<p>当然<code>FieldMap</code>就是多个的版本了。  </p>
<h2 id="Part及-PartMap"><a href="#Part及-PartMap" class="headerlink" title="@Part及@PartMap"></a><code>@Part</code>及<code>@PartMap</code></h2><p>上传文件时使用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FileUploadService</span> </span>&#123;  </div><div class="line"><span class="meta">@Multipart</span></div><div class="line"><span class="meta">@PUT</span>(<span class="string">"user/photo"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">updateUser</span><span class="params">(@Part(<span class="string">"photo"</span>)</span> RequestBody photo, @<span class="title">Part</span><span class="params">(<span class="string">"description"</span>)</span> RequestBody description)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Headers"><a href="#Headers" class="headerlink" title="@Headers"></a><code>@Headers</code></h2><p>可以通过<code>@Headers</code>来设置静态的请求头</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Headers</span>(&#123;</div><div class="line">    <span class="string">"Accept: application/vnd.github.v3.full+json"</span>,</div><div class="line">    <span class="string">"User-Agent: Retrofit-Sample-App"</span></div><div class="line">&#125;)</div><div class="line"><span class="meta">@GET</span>(<span class="string">"users/&#123;username&#125;"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">getUser</span><span class="params">(@Path(<span class="string">"username"</span>)</span> String username)</span>;</div></pre></td></tr></table></figure>
<p>请求头信息可以通过<code>@Header</code>注解来动态更新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@GET</span>(<span class="string">"user"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">getUser</span><span class="params">(@Header(<span class="string">"Authorization"</span>)</span> String authorization)</span></div></pre></td></tr></table></figure>
<p>如果传的值是<code>null</code>，该请求头将会被忽略，否则将会使用该值得<code>toString</code>。 </p>
<h2 id="RxJava-Retrofit"><a href="#RxJava-Retrofit" class="headerlink" title="RxJava+Retrofit"></a><code>RxJava</code>+<code>Retrofit</code></h2><p><code>Retrofit</code>如何与<code>RxJava</code>结合使用呢？ </p>
<ul>
<li><p>添加依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.1.0'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:converter-gson:2.1.0'</span><span class="comment">// 支持gson</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.1.0'</span><span class="comment">// 支持rxjava</span></div><div class="line"></div><div class="line"><span class="comment">// rxjava part</span></div><div class="line">compile <span class="string">'io.reactivex:rxandroid:1.2.1'</span></div><div class="line">compile <span class="string">'io.reactivex:rxjava:1.2.3'</span></div></pre></td></tr></table></figure>
</li>
<li><p>修改<code>Retrofit</code>的配置，让其支持<code>RxJava</code>   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">    .addConverterFactory(GsonConverterFactory.create())</div><div class="line">    .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) <span class="comment">// 支持RxJava</span></div><div class="line">    .build();</div></pre></td></tr></table></figure>
</li>
<li><p>修改<code>GitHubService</code>，将返回值改为<code>Observable</code>，而不是<code>Call</code>。     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">    Observable&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>执行部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line">service.listRepos(<span class="string">"CharonChui"</span>)</div><div class="line">    .subscribeOn(Schedulers.newThread())</div><div class="line">    .observeOn(AndroidSchedulers.mainThread())</div><div class="line">    .subscribe(<span class="keyword">new</span> Subscriber&lt;List&lt;Repo&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">            Log.i(<span class="string">"@@@"</span>, <span class="string">"onCompleted"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            Log.i(<span class="string">"@@@"</span>, <span class="string">"onError : "</span> + e.toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;Repo&gt; repos)</span> </span>&#123;</div><div class="line">            Log.i(<span class="string">"@@@"</span>, <span class="string">"onNext : "</span> + repos.size());</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"size : "</span> + repos.size(), Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>  <code>RxJava</code>+<code>Retrofit</code>形式的时候，<code>Retrofit</code>把请求封装进<code>Observable</code>在请求结束后调用 <code>onNext()</code>或在请求失败后调用<code>onError()</code>。</p>
<h2 id="Proguard配置"><a href="#Proguard配置" class="headerlink" title="Proguard配置"></a><code>Proguard</code>配置</h2><p>如果项目中使用了<code>Proguard</code>，你需要添加如下配置:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># Platform calls Class.forName on types which do not exist on Android to determine platform.</div><div class="line">-dontnote retrofit2.Platform</div><div class="line"># Platform used when running on RoboVM on iOS. Will not be used at runtime.</div><div class="line">-dontnote retrofit2.Platform$IOS$MainThreadExecutor</div><div class="line"># Platform used when running on Java 8 VMs. Will not be used at runtime.</div><div class="line">-dontwarn retrofit2.Platform$Java8</div><div class="line"># Retain generic type information for use by reflection by converters and adapters.</div><div class="line">-keepattributes Signature</div><div class="line"># Retain declared checked exceptions for use by a Proxy instance.</div><div class="line">-keepattributes Exceptions</div></pre></td></tr></table></figure></p>
<hr>
<ul>
<li>邮箱 ：itgoyo@gmail.com  </li>
<li>Good Luck! </li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">Android</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2014/11/01/Retrofit详解(上)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 itgoyo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>
!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="/",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}]);
</script>
<script src="/main.d221b8.js"></script>
<script>
(function() {
	var loadScript = function(path) {
	    var $script = document.createElement('script')
	    document.getElementsByTagName('body')[0].appendChild($script)
	    $script.setAttribute('src', path)
	}
	loadScript("/slider.59dfdc.js")
})();
</script>




    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">itgoyo&lt;br&gt;&lt;br&gt;毕业于桂电&lt;br&gt;就业于中兴&lt;br&gt;&lt;br&gt;&lt;br&gt;穷困潦倒&lt;br&gt;卖码为生</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>